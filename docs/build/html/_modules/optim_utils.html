
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>optim_utils &#8212; LambdaRCA 0.0 documentation</title>
    <link rel="stylesheet" href="../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
   
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for optim_utils</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">gc</span>
<span class="kn">import</span> <span class="nn">numpy.linalg</span> <span class="k">as</span> <span class="nn">LA</span>
<span class="kn">from</span> <span class="nn">numpy</span> <span class="k">import</span> <span class="o">*</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">scipy.sparse.linalg</span> <span class="k">as</span> <span class="nn">SLA</span>
<span class="kn">from</span> <span class="nn">multiprocessing</span> <span class="k">import</span> <span class="n">Process</span><span class="p">,</span> <span class="n">Queue</span><span class="p">,</span> <span class="n">Pool</span>
<span class="kn">import</span> <span class="nn">numpy.random</span> <span class="k">as</span> <span class="nn">random</span>
<span class="kn">import</span> <span class="nn">scipy.signal</span> <span class="k">as</span> <span class="nn">scisig</span>
<span class="kn">import</span> <span class="nn">isap</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;../utilities&#39;</span><span class="p">)</span>
<span class="kn">import</span> <span class="nn">utils</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">scipy.stats</span> <span class="k">as</span> <span class="nn">scistats</span>
<span class="kn">import</span> <span class="nn">copy</span> <span class="k">as</span> <span class="nn">cp</span>
<span class="kn">from</span> <span class="nn">pyflann</span> <span class="k">import</span> <span class="o">*</span>
<span class="kn">import</span> <span class="nn">psf_learning_utils</span>
<span class="kn">import</span> <span class="nn">scipy</span>
<span class="kn">from</span> <span class="nn">scipy.optimize</span> <span class="k">import</span> <span class="n">minimize</span><span class="c1">#,linear_sum_assignment</span>
<span class="kn">from</span> <span class="nn">modopt.opt.cost</span> <span class="k">import</span> <span class="n">costObj</span>
<span class="kn">import</span> <span class="nn">grads</span> <span class="k">as</span> <span class="nn">grad</span>
<span class="kn">import</span> <span class="nn">operators</span> <span class="k">as</span> <span class="nn">lambdaops</span>
<span class="kn">import</span> <span class="nn">modopt.opt.proximity</span> <span class="k">as</span> <span class="nn">prox</span>
<span class="kn">import</span> <span class="nn">proxs</span> <span class="k">as</span> <span class="nn">lambdaprox</span>
<span class="kn">import</span> <span class="nn">modopt.opt.algorithms</span> <span class="k">as</span> <span class="nn">optimalg</span>
<span class="kn">from</span> <span class="nn">modopt.opt.linear</span> <span class="k">import</span> <span class="n">Identity</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">pyct</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
    <span class="k">pass</span> <span class="c1"># module doesn&#39;t exist, deal with it.</span>



<span class="k">def</span> <span class="nf">ineq_proj</span><span class="p">(</span><span class="n">u</span><span class="p">,</span><span class="n">v</span><span class="p">):</span> <span class="c1"># Projects u onto the constraint u&gt;=v</span>
    <span class="n">u_out</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">u</span><span class="p">)</span>
    <span class="n">ind</span> <span class="o">=</span> <span class="n">where</span><span class="p">(</span><span class="n">u</span><span class="o">&lt;</span><span class="n">v</span><span class="p">)</span>
    <span class="n">u_out</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">u_out</span>

<span class="k">def</span> <span class="nf">prox_coeff_sum</span><span class="p">(</span><span class="n">u</span><span class="p">,</span><span class="n">a</span><span class="p">):</span> <span class="c1"># Projects the vector u onto the contraint sum_i vi=a; we assume that u is a column vector</span>
    <span class="n">dev</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">-</span><span class="n">a</span>
    <span class="n">siz</span> <span class="o">=</span> <span class="n">size</span><span class="p">(</span><span class="n">u</span><span class="p">)</span>
    <span class="n">ones_vect</span> <span class="o">=</span> <span class="n">ones</span><span class="p">((</span><span class="n">siz</span><span class="p">,))</span>
    <span class="n">b</span> <span class="o">=</span> <span class="n">dev</span><span class="o">/</span><span class="n">siz</span>
    <span class="n">z</span> <span class="o">=</span> <span class="n">u</span> <span class="o">-</span> <span class="n">b</span><span class="o">*</span><span class="n">ones_vect</span>
    <span class="k">return</span> <span class="n">z</span>

<span class="k">def</span> <span class="nf">prox_coeff_sum_mat</span><span class="p">(</span><span class="n">U</span><span class="p">,</span><span class="n">a</span><span class="p">):</span> <span class="c1"># Projects each column of u onto the contraint sum_i vi=a; we assume that u is a column vector</span>
    <span class="n">Z</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">U</span><span class="p">)</span>
    <span class="n">shap</span> <span class="o">=</span> <span class="n">U</span><span class="o">.</span><span class="n">shape</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
        <span class="n">Z</span><span class="p">[:,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">prox_coeff_sum</span><span class="p">(</span><span class="n">U</span><span class="p">[:,</span><span class="n">i</span><span class="p">],</span><span class="n">a</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">Z</span>

<span class="k">def</span> <span class="nf">pos_proj</span><span class="p">(</span><span class="n">z</span><span class="p">,</span><span class="n">tol</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span> <span class="c1"># Puts negative entries of z to zero</span>
    <span class="n">u</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">z</span><span class="p">)</span>
    <span class="n">u</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">size</span><span class="p">(</span><span class="n">z</span><span class="p">))</span>
    <span class="n">i</span> <span class="o">=</span> <span class="n">where</span><span class="p">(</span><span class="n">u</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">u</span><span class="p">[</span><span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">shap</span> <span class="o">=</span> <span class="n">z</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">u</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">shap</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">u</span>

<span class="k">def</span> <span class="nf">pos_proj_mat</span><span class="p">(</span><span class="n">m</span><span class="p">,</span><span class="n">tol</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    <span class="n">u</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>
    <span class="n">shap</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">j</span><span class="o">=</span><span class="mi">0</span>
    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
        <span class="n">u</span><span class="p">[:,</span><span class="n">j</span><span class="p">]</span><span class="o">=</span><span class="n">pos_proj</span><span class="p">(</span><span class="n">squeeze</span><span class="p">(</span><span class="n">m</span><span class="p">[:,</span><span class="n">j</span><span class="p">]),</span><span class="n">tol</span><span class="o">=</span><span class="n">tol</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">u</span>

<span class="k">def</span> <span class="nf">pos_proj_mat_2</span><span class="p">(</span><span class="n">m1</span><span class="p">,</span><span class="n">m2</span><span class="p">):</span>
    <span class="n">m</span> <span class="o">=</span> <span class="n">m1</span><span class="o">+</span><span class="n">m2</span>
    <span class="n">I1</span> <span class="o">=</span> <span class="p">(</span><span class="n">m</span><span class="o">&gt;=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">I2</span> <span class="o">=</span> <span class="p">(</span><span class="n">m</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">m1_proj</span> <span class="o">=</span> <span class="n">m1</span><span class="o">*</span><span class="n">I1</span> <span class="o">+</span> <span class="n">I2</span><span class="o">*</span><span class="p">(</span><span class="n">m1</span><span class="o">-</span><span class="n">m2</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span>
    <span class="n">m2_proj</span> <span class="o">=</span> <span class="n">m2</span><span class="o">*</span><span class="n">I1</span> <span class="o">+</span> <span class="n">I2</span><span class="o">*</span><span class="p">(</span><span class="n">m2</span><span class="o">-</span><span class="n">m1</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span>
    <span class="k">return</span> <span class="n">m1_proj</span><span class="p">,</span><span class="n">m2_proj</span>

<span class="k">def</span> <span class="nf">pos_proj_cube</span><span class="p">(</span><span class="n">m</span><span class="p">,</span><span class="n">tol</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    <span class="n">u</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>
    <span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span> <span class="o">=</span> <span class="n">where</span><span class="p">(</span><span class="n">u</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">u</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">return</span> <span class="n">u</span>

<span class="k">def</span> <span class="nf">prox_dot_prod</span><span class="p">(</span><span class="n">M</span><span class="p">,</span><span class="nb">map</span><span class="p">):</span> <span class="c1"># Proximity operator of m -&gt; &lt;m,map&gt; at M</span>
    <span class="n">Mp</span> <span class="o">=</span> <span class="n">M</span><span class="o">-</span><span class="nb">map</span>
    <span class="k">return</span> <span class="n">Mp</span>

<span class="k">def</span> <span class="nf">positive_centering</span><span class="p">(</span><span class="n">stack</span><span class="p">):</span>
    <span class="n">inf</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">stack</span><span class="p">[:,:,</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">shap</span> <span class="o">=</span> <span class="n">stack</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">stack_cent</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">stack</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
            <span class="n">inf</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">stack</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,:]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">stack</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
        <span class="n">stack_cent</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">]</span> <span class="o">-=</span><span class="n">inf</span>

    <span class="k">return</span> <span class="n">stack_cent</span><span class="p">,</span><span class="n">inf</span>

<span class="k">def</span> <span class="nf">level_images</span><span class="p">(</span><span class="n">stack</span><span class="p">):</span>
    <span class="n">stack_cp</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">stack</span><span class="p">)</span>
    <span class="n">stack_out</span> <span class="o">=</span> <span class="n">stack</span><span class="o">*</span><span class="mi">0</span>
    <span class="n">ind_stack</span> <span class="o">=</span> <span class="n">stack</span><span class="o">*</span><span class="mi">0</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">stack</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">stack</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
            <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">stack</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
                <span class="n">z</span> <span class="o">=</span> <span class="n">where</span><span class="p">(</span><span class="n">stack_cp</span><span class="p">[</span><span class="n">k</span><span class="p">,</span><span class="n">l</span><span class="p">,:]</span><span class="o">==</span><span class="n">stack_cp</span><span class="p">[</span><span class="n">k</span><span class="p">,</span><span class="n">l</span><span class="p">,:]</span><span class="o">.</span><span class="n">max</span><span class="p">())</span>
                <span class="n">ind_stack</span><span class="p">[</span><span class="n">k</span><span class="p">,</span><span class="n">l</span><span class="p">,</span><span class="n">z</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="n">i</span>
                <span class="n">stack_out</span><span class="p">[</span><span class="n">k</span><span class="p">,</span><span class="n">l</span><span class="p">,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">stack_cp</span><span class="p">[</span><span class="n">k</span><span class="p">,</span><span class="n">l</span><span class="p">,:]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
                <span class="n">stack_cp</span><span class="p">[</span><span class="n">k</span><span class="p">,</span><span class="n">l</span><span class="p">,</span><span class="n">z</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">return</span> <span class="n">stack_out</span><span class="p">,</span><span class="n">ind_stack</span>


<span class="k">def</span> <span class="nf">prox_mat_marg</span><span class="p">(</span><span class="n">M</span><span class="p">,</span><span class="n">b</span><span class="p">):</span> <span class="c1"># Projects a matrix onto the constraints transpose(M)*ones_vect = b (the sum of each row is constraint</span>

    <span class="n">shap</span> <span class="o">=</span> <span class="n">M</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">ones_vect</span> <span class="o">=</span> <span class="n">ones</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="mi">1</span><span class="p">))</span>
    <span class="n">dev</span> <span class="o">=</span> <span class="p">(</span><span class="n">transpose</span><span class="p">(</span><span class="n">M</span><span class="p">)</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">ones_vect</span><span class="p">)</span><span class="o">-</span><span class="n">b</span><span class="p">)</span><span class="o">/</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">Mp</span> <span class="o">=</span> <span class="n">M</span> <span class="o">-</span> <span class="n">ones_vect</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">transpose</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">Mp</span>

<span class="k">def</span> <span class="nf">prox_mat_marg_l</span><span class="p">(</span><span class="n">M</span><span class="p">,</span><span class="n">b</span><span class="p">):</span> <span class="c1"># Projects a matrix onto the constraints M*ones_vect = b (the sum of each row is constraint</span>

    <span class="n">Mt</span>  <span class="o">=</span><span class="n">transpose</span><span class="p">(</span><span class="n">M</span><span class="p">)</span>
    <span class="n">Mpt</span> <span class="o">=</span> <span class="n">prox_mat_marg</span><span class="p">(</span><span class="n">Mt</span><span class="p">,</span><span class="n">b</span><span class="p">)</span>
    <span class="n">Mp</span> <span class="o">=</span> <span class="n">transpose</span><span class="p">(</span><span class="n">Mpt</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">Mp</span>

<span class="k">def</span> <span class="nf">prox_cube_marg</span><span class="p">(</span><span class="n">M</span><span class="p">,</span><span class="n">B</span><span class="p">):</span>
    <span class="n">shap</span> <span class="o">=</span> <span class="n">M</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">Mp</span>  <span class="o">=</span><span class="n">copy</span><span class="p">(</span><span class="n">M</span><span class="p">)</span>
    <span class="n">k</span><span class="o">=</span><span class="mi">0</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
        <span class="n">bk</span> <span class="o">=</span> <span class="n">B</span><span class="p">[:,</span><span class="n">k</span><span class="p">]</span>
        <span class="n">bk</span> <span class="o">=</span> <span class="n">bk</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="mi">1</span><span class="p">))</span>
        <span class="n">Mp</span><span class="p">[:,:,</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">prox_mat_marg</span><span class="p">(</span><span class="n">squeeze</span><span class="p">(</span><span class="n">M</span><span class="p">[:,:,</span><span class="n">k</span><span class="p">]),</span><span class="n">bk</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">Mp</span>

<span class="k">def</span> <span class="nf">prox_cube_marg_homog</span><span class="p">(</span><span class="n">M</span><span class="p">):</span>
    <span class="n">shap</span> <span class="o">=</span> <span class="n">M</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">k</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">ones_vect</span> <span class="o">=</span> <span class="n">ones</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="mi">1</span><span class="p">))</span>
    <span class="n">mean_marg</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="mi">1</span><span class="p">))</span>
    <span class="n">Mp</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">M</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
        <span class="n">mk</span> <span class="o">=</span> <span class="n">M</span><span class="p">[:,:,</span><span class="n">k</span><span class="p">]</span>
        <span class="n">mean_marg</span> <span class="o">=</span> <span class="n">mean_marg</span> <span class="o">+</span> <span class="n">mk</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">ones_vect</span><span class="p">)</span><span class="o">/</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
    <span class="nb">print</span> <span class="n">mean_marg</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
        <span class="n">mk</span> <span class="o">=</span> <span class="n">transpose</span><span class="p">(</span><span class="n">M</span><span class="p">[:,:,</span><span class="n">k</span><span class="p">])</span>
        <span class="n">mkp</span> <span class="o">=</span> <span class="n">prox_mat_marg</span><span class="p">(</span><span class="n">mk</span><span class="p">,</span><span class="n">mean_marg</span><span class="p">)</span>

        <span class="n">Mp</span><span class="p">[:,:,</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">transpose</span><span class="p">(</span><span class="n">mkp</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">Mp</span>

<span class="k">def</span> <span class="nf">prox_hub</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">delta</span><span class="p">,</span><span class="n">lambd</span><span class="p">):</span>
    <span class="n">shap</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">ones_mat</span> <span class="o">=</span> <span class="n">ones</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
    <span class="n">i</span><span class="p">,</span><span class="n">j</span> <span class="o">=</span> <span class="n">where</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">&lt;</span><span class="n">delta</span><span class="p">)</span>

    <span class="n">mask</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
    <span class="n">mask</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="n">projx</span> <span class="o">=</span> <span class="p">((</span><span class="mi">1</span><span class="o">+</span><span class="n">lambd</span><span class="p">)</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span><span class="o">*</span><span class="n">mask</span><span class="o">*</span><span class="n">x</span> <span class="o">+</span> <span class="p">(</span><span class="n">ones_mat</span><span class="o">-</span><span class="n">mask</span><span class="p">)</span><span class="o">*</span><span class="n">utils</span><span class="o">.</span><span class="n">thresholding</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">ones_mat</span><span class="o">*</span><span class="n">lambd</span><span class="o">*</span><span class="n">delta</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">projx</span>

<span class="k">def</span> <span class="nf">prox_hub_stack</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">delta</span><span class="p">,</span><span class="n">lambd</span><span class="p">):</span>
    <span class="n">shap</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">prox_out</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
        <span class="n">prox_out</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">prox_hub</span><span class="p">(</span><span class="n">x</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">],</span><span class="n">delta</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">lambd</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">prox_out</span>

<span class="k">def</span> <span class="nf">bar_coord_proj</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span><span class="n">target_pos</span><span class="p">,</span><span class="n">est_coeff_bar_coeff</span><span class="p">):</span> <span class="c1"># Locations arte stored in pos lines</span>
    <span class="n">vect_pos</span> <span class="o">=</span> <span class="n">ones</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>
    <span class="n">vect_pos</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">target_pos</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>
    <span class="n">shap</span> <span class="o">=</span> <span class="n">pos</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">A</span> <span class="o">=</span> <span class="n">ones</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
    <span class="n">A</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">transpose</span><span class="p">(</span><span class="n">pos</span><span class="p">)</span>
    <span class="n">AAT_inv</span> <span class="o">=</span> <span class="n">LA</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">A</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">transpose</span><span class="p">(</span><span class="n">A</span><span class="p">)))</span>
    <span class="n">B</span> <span class="o">=</span> <span class="n">transpose</span><span class="p">(</span><span class="n">A</span><span class="p">)</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">AAT_inv</span><span class="p">)</span>

    <span class="n">out</span> <span class="o">=</span> <span class="n">est_coeff_bar_coeff</span> <span class="o">-</span> <span class="n">B</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">A</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">est_coeff_bar_coeff</span><span class="p">)</span><span class="o">-</span><span class="n">vect_pos</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">out</span>

<span class="k">def</span> <span class="nf">bar_coord_pb_dijkstra</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span><span class="n">target_pos</span><span class="p">,</span><span class="n">nb_iter</span><span class="o">=</span><span class="mi">10</span><span class="p">):</span>
    <span class="n">shap</span> <span class="o">=</span> <span class="n">pos</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">init_pos</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="mi">1</span><span class="p">))</span>
    <span class="n">id_flag</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">ind_id</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
        <span class="n">init_pos</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">sqrt</span><span class="p">((</span><span class="n">target_pos</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">pos</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="p">(</span><span class="n">target_pos</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">pos</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">1</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">init_pos</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
            <span class="n">id_flag</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">ind_id</span> <span class="o">=</span> <span class="n">i</span>
    <span class="k">if</span> <span class="n">id_flag</span><span class="p">:</span>
        <span class="n">a</span> <span class="o">=</span> <span class="n">init_pos</span><span class="p">[</span><span class="n">ind_id</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">init_pos</span><span class="o">*=</span><span class="mi">0</span>
        <span class="n">init_pos</span><span class="p">[</span><span class="n">ind_id</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
            <span class="n">init_pos</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">init_pos</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">t</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">init_pos</span><span class="p">)</span>
        <span class="n">init_pos</span><span class="o">/=</span><span class="n">t</span>

    <span class="n">x</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">init_pos</span><span class="p">)</span>
    <span class="n">p</span> <span class="o">=</span> <span class="n">x</span><span class="o">*</span><span class="mi">0</span>
    <span class="n">q</span> <span class="o">=</span> <span class="n">x</span><span class="o">*</span><span class="mi">0</span>
    <span class="k">if</span> <span class="n">id_flag</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">True</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_iter</span><span class="p">):</span>
            <span class="n">y</span> <span class="o">=</span> <span class="n">bar_coord_proj</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span><span class="n">target_pos</span><span class="p">,</span><span class="n">x</span><span class="o">+</span><span class="n">p</span><span class="p">)</span>
            <span class="n">p</span> <span class="o">=</span> <span class="n">x</span><span class="o">+</span><span class="n">p</span><span class="o">-</span><span class="n">y</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">pos_proj</span><span class="p">(</span><span class="n">y</span><span class="o">+</span><span class="n">q</span><span class="p">)</span>
            <span class="n">q</span> <span class="o">=</span> <span class="n">y</span><span class="o">+</span><span class="n">q</span><span class="o">-</span><span class="n">x</span>
            <span class="n">temp</span> <span class="o">=</span> <span class="n">transpose</span><span class="p">(</span><span class="n">pos</span><span class="p">)</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
            <span class="nb">print</span> <span class="s2">&quot;Check: min val,&quot;</span><span class="p">,</span><span class="n">x</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span><span class="s2">&quot; sum: &quot;</span><span class="p">,</span><span class="n">x</span><span class="o">.</span><span class="n">sum</span><span class="p">(),</span><span class="s2">&quot; coordinates error: &quot;</span><span class="p">,(</span><span class="n">temp</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">target_pos</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="p">(</span><span class="n">temp</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">target_pos</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span>

    <span class="k">return</span> <span class="n">x</span>

<span class="k">def</span> <span class="nf">bar_coord_pb</span><span class="p">(</span><span class="n">A</span><span class="p">,</span><span class="n">B</span><span class="p">,</span><span class="n">nb_iter</span><span class="p">):</span> <span class="c1"># Solve the problem min ||At-B||^2, s.t. sum_i ti=1, ti&gt;=0; calculates the best &quot;barycentric&quot; coordinates of B with respect to A columns</span>
    <span class="kn">from</span> <span class="nn">numpy.linalg</span> <span class="k">import</span> <span class="n">norm</span>
    <span class="n">w1</span> <span class="o">=</span> <span class="mf">0.5</span>
    <span class="n">w2</span> <span class="o">=</span> <span class="mi">1</span><span class="o">-</span><span class="n">w1</span>
    <span class="n">M</span> <span class="o">=</span> <span class="n">transpose</span><span class="p">(</span><span class="n">A</span><span class="p">)</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">A</span><span class="p">)</span>
    <span class="n">w</span><span class="p">,</span><span class="n">v</span> <span class="o">=</span> <span class="n">LA</span><span class="o">.</span><span class="n">eigh</span><span class="p">(</span><span class="n">M</span><span class="p">)</span>
    <span class="n">tol</span> <span class="o">=</span> <span class="mf">0.1</span>
    <span class="n">lip</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">w</span><span class="p">)</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
    <span class="nb">print</span> <span class="s2">&quot;lip coeff: &quot;</span><span class="p">,</span><span class="n">lip</span>
    <span class="n">mu</span> <span class="o">=</span> <span class="mi">1</span><span class="o">/</span><span class="p">((</span><span class="mi">1</span><span class="o">+</span><span class="n">tol</span><span class="p">)</span><span class="o">*</span><span class="n">lip</span><span class="p">)</span>
    <span class="n">shap</span> <span class="o">=</span> <span class="n">A</span><span class="o">.</span><span class="n">shape</span>

    <span class="c1"># Initialization</span>
    <span class="n">i</span><span class="o">=</span><span class="mi">0</span>
    <span class="n">minim</span> <span class="o">=</span> <span class="mf">1e16</span>
    <span class="n">ind</span><span class="o">=</span><span class="mi">0</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
        <span class="n">ai</span> <span class="o">=</span> <span class="n">A</span><span class="p">[:,</span><span class="n">i</span><span class="p">]</span>
        <span class="n">dist</span> <span class="o">=</span> <span class="p">((</span><span class="n">ai</span><span class="o">-</span><span class="n">B</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span>
        <span class="k">if</span> <span class="n">dist</span> <span class="o">&lt;</span> <span class="n">minim</span><span class="p">:</span>
            <span class="n">ind</span> <span class="o">=</span> <span class="n">i</span>
            <span class="n">minim</span> <span class="o">=</span> <span class="n">dist</span>
    <span class="n">t</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="mi">1</span><span class="p">))</span>
    <span class="n">t</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">z1</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="mi">1</span><span class="p">))</span>
    <span class="n">z2</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="mi">1</span><span class="p">))</span>
    <span class="n">mse</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">nb_iter</span><span class="p">,))</span>
    <span class="n">lambd</span> <span class="o">=</span> <span class="mf">1.5</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_iter</span><span class="p">):</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">A</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">t</span><span class="p">)</span><span class="o">-</span><span class="n">B</span>
        <span class="n">grad</span> <span class="o">=</span> <span class="n">transpose</span><span class="p">(</span><span class="n">A</span><span class="p">)</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>
        <span class="n">mse</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">res</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="c1">#print 100*sqrt(mse[i])/norm(B)</span>
        <span class="n">temp1</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">t</span> <span class="o">-</span> <span class="n">z1</span> <span class="o">-</span> <span class="n">mu</span><span class="o">*</span><span class="n">grad</span>
        <span class="n">z1</span> <span class="o">=</span> <span class="n">z1</span> <span class="o">+</span> <span class="n">lambd</span><span class="o">*</span><span class="p">((</span><span class="n">prox_coeff_sum</span><span class="p">(</span><span class="n">temp1</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">],)),</span><span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="mi">1</span><span class="p">))</span><span class="o">-</span><span class="n">t</span><span class="p">)</span>
        <span class="n">temp2</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">t</span> <span class="o">-</span> <span class="n">z2</span> <span class="o">-</span> <span class="n">mu</span><span class="o">*</span><span class="n">grad</span>
        <span class="n">z2</span> <span class="o">=</span> <span class="n">z2</span> <span class="o">+</span> <span class="n">lambd</span><span class="o">*</span><span class="p">(</span><span class="n">pos_proj</span><span class="p">(</span><span class="n">temp2</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">],)))</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="mi">1</span><span class="p">))</span><span class="o">-</span><span class="n">t</span><span class="p">)</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">w1</span><span class="o">*</span><span class="n">z1</span><span class="o">+</span><span class="n">w2</span><span class="o">*</span><span class="n">z2</span>
    <span class="n">t</span> <span class="o">=</span> <span class="n">pos_proj</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">],)))</span><span class="o">/</span><span class="n">t</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">t</span><span class="p">,</span><span class="mi">100</span><span class="o">*</span><span class="n">sqrt</span><span class="p">(</span><span class="n">mse</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span><span class="o">/</span><span class="n">norm</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">bar_coord_pb_field</span><span class="p">(</span><span class="n">A</span><span class="p">,</span><span class="n">B</span><span class="p">,</span><span class="n">tinit</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">nb_iter</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span><span class="n">tol</span><span class="o">=</span><span class="mf">1e-15</span><span class="p">):</span> <span class="c1"># Solve the problem min ||At-B||^2, s.t. sum_i ti=1, ti&gt;=0; calculates the best &quot;barycentric&quot; coordinates of B with respect to A columns; B and t are now matrices</span>
    <span class="n">w1</span> <span class="o">=</span> <span class="mf">0.5</span>
    <span class="n">w2</span> <span class="o">=</span> <span class="mi">1</span><span class="o">-</span><span class="n">w1</span>
    <span class="n">M</span> <span class="o">=</span> <span class="n">transpose</span><span class="p">(</span><span class="n">A</span><span class="p">)</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">A</span><span class="p">)</span>
    <span class="n">w</span><span class="p">,</span><span class="n">v</span> <span class="o">=</span> <span class="n">LA</span><span class="o">.</span><span class="n">eigh</span><span class="p">(</span><span class="n">M</span><span class="p">)</span>
    <span class="n">tol0</span> <span class="o">=</span> <span class="mf">0.1</span>
    <span class="n">lip</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">w</span><span class="p">)</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
    <span class="n">mu</span> <span class="o">=</span> <span class="mi">1</span><span class="o">/</span><span class="p">((</span><span class="mi">1</span><span class="o">+</span><span class="n">tol0</span><span class="p">)</span><span class="o">*</span><span class="n">lip</span><span class="p">)</span>
    <span class="n">shap</span> <span class="o">=</span> <span class="n">A</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">shap1</span> <span class="o">=</span> <span class="n">B</span><span class="o">.</span><span class="n">shape</span>

    <span class="c1"># Initialization</span>
    <span class="n">t</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">shap1</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
    <span class="k">if</span> <span class="n">tinit</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap1</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
            <span class="n">minim</span> <span class="o">=</span> <span class="mf">1e16</span>
            <span class="n">ind</span><span class="o">=</span><span class="mi">0</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
                <span class="n">dist</span> <span class="o">=</span> <span class="p">((</span><span class="n">A</span><span class="p">[:,</span><span class="n">i</span><span class="p">]</span><span class="o">-</span><span class="n">B</span><span class="p">[:,</span><span class="n">j</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span>
                <span class="k">if</span> <span class="n">dist</span> <span class="o">&lt;</span> <span class="n">minim</span><span class="p">:</span>
                    <span class="n">ind</span> <span class="o">=</span> <span class="n">i</span>
                    <span class="n">minim</span> <span class="o">=</span> <span class="n">dist</span>
            <span class="n">t</span><span class="p">[</span><span class="n">ind</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">tinit</span><span class="p">)</span>
    <span class="n">z1</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
    <span class="n">z2</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
    <span class="n">mse</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">nb_iter</span><span class="p">,))</span>
    <span class="n">lambd</span> <span class="o">=</span> <span class="mf">1.5</span>
    <span class="n">var</span> <span class="o">=</span> <span class="mi">100</span>
    <span class="n">i</span><span class="o">=</span><span class="mi">0</span>
    <span class="k">while</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">nb_iter</span> <span class="ow">and</span> <span class="n">var</span><span class="o">&gt;</span><span class="n">tol</span><span class="p">:</span>

        <span class="n">res</span> <span class="o">=</span> <span class="n">A</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">t</span><span class="p">)</span><span class="o">-</span><span class="n">B</span>
        <span class="n">grad</span> <span class="o">=</span> <span class="n">transpose</span><span class="p">(</span><span class="n">A</span><span class="p">)</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>
        <span class="n">mse</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">res</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="nb">print</span> <span class="n">mse</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">temp1</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">t</span> <span class="o">-</span> <span class="n">z1</span> <span class="o">-</span> <span class="n">mu</span><span class="o">*</span><span class="n">grad</span>
        <span class="n">z1</span> <span class="o">=</span> <span class="n">z1</span> <span class="o">+</span> <span class="n">lambd</span><span class="o">*</span><span class="p">(</span><span class="n">prox_coeff_sum_mat</span><span class="p">(</span><span class="n">temp1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">-</span><span class="n">t</span><span class="p">)</span>
        <span class="n">temp2</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">t</span> <span class="o">-</span> <span class="n">z2</span> <span class="o">-</span> <span class="n">mu</span><span class="o">*</span><span class="n">grad</span>
        <span class="n">z2</span> <span class="o">=</span> <span class="n">z2</span> <span class="o">+</span> <span class="n">lambd</span><span class="o">*</span><span class="p">(</span><span class="n">pos_proj</span><span class="p">(</span><span class="n">temp2</span><span class="p">)</span><span class="o">-</span><span class="n">t</span><span class="p">)</span>
        <span class="n">told</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">w1</span><span class="o">*</span><span class="n">z1</span><span class="o">+</span><span class="n">w2</span><span class="o">*</span><span class="n">z2</span>
        <span class="n">var</span>  <span class="o">=</span> <span class="mi">100</span><span class="o">*</span><span class="p">((</span><span class="n">t</span><span class="o">-</span><span class="n">told</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">/</span><span class="p">(</span><span class="n">told</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="n">i</span><span class="o">+=</span><span class="mi">1</span>
    <span class="nb">print</span> <span class="s2">&quot;coeff res: &quot;</span><span class="p">,</span><span class="n">mse</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="sd">&quot;&quot;&quot;t = pos_proj(t)</span>
<span class="sd">    one_vect = ones((shap[1],1))</span>
<span class="sd">    t = t/(one_vect.dot((t.sum(axis=0)).reshape(1,shap1[1])))&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">t</span>

<span class="k">def</span> <span class="nf">lsq_mat_inv</span><span class="p">(</span><span class="n">A</span><span class="p">,</span><span class="n">B</span><span class="p">,</span><span class="n">neg_tol</span><span class="o">=-</span><span class="mf">1e-5</span><span class="p">):</span>
    <span class="n">col_basis</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">Vt</span> <span class="o">=</span> <span class="n">linalg</span><span class="o">.</span><span class="n">svd</span><span class="p">(</span><span class="n">A</span><span class="p">,</span><span class="n">full_matrices</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">M</span> <span class="o">=</span> <span class="n">A</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">transpose</span><span class="p">(</span><span class="n">Vt</span><span class="p">))</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">diag</span><span class="p">(</span><span class="n">s</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)))</span>
    <span class="n">coeff</span> <span class="o">=</span> <span class="n">transpose</span><span class="p">(</span><span class="n">Vt</span><span class="p">)</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">diag</span><span class="p">(</span><span class="n">s</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)))</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">transpose</span><span class="p">(</span><span class="n">M</span><span class="p">))</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">B</span><span class="p">)</span>
    <span class="n">B_approx</span> <span class="o">=</span> <span class="n">A</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">coeff</span><span class="p">)</span>
    <span class="c1">#err = ((B-B_approx)**2).sum()</span>
    <span class="c1">#print &quot;lsq err: &quot;,err</span>
    <span class="n">nb_samp</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">siz</span> <span class="o">=</span> <span class="n">B</span><span class="o">.</span><span class="n">shape</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">siz</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">:</span>
        <span class="n">nb_samp</span> <span class="o">=</span> <span class="n">siz</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">flags</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">nb_samp</span><span class="p">,))</span>
    <span class="n">nb_flags</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_samp</span><span class="p">):</span>
        <span class="n">ind</span> <span class="o">=</span> <span class="n">where</span><span class="p">(</span><span class="n">coeff</span><span class="p">[:,</span><span class="n">i</span><span class="p">]</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">sum</span><span class="p">(</span><span class="n">coeff</span><span class="p">[</span><span class="n">ind</span><span class="p">,</span><span class="n">i</span><span class="p">])</span><span class="o">&lt;</span><span class="n">neg_tol</span><span class="p">:</span>
            <span class="nb">print</span> <span class="nb">sum</span><span class="p">(</span><span class="n">coeff</span><span class="p">[</span><span class="n">ind</span><span class="p">,</span><span class="n">i</span><span class="p">])</span>
            <span class="n">flags</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">=</span><span class="mi">1</span>
            <span class="n">nb_flags</span><span class="o">+=</span><span class="mi">1</span>
    <span class="nb">print</span> <span class="n">nb_flags</span>
    <span class="k">return</span> <span class="n">coeff</span><span class="p">,</span><span class="n">flags</span>


<span class="k">def</span> <span class="nf">lsq_mat_inv_lin</span><span class="p">(</span><span class="n">A</span><span class="p">,</span><span class="n">B</span><span class="p">):</span>
    <span class="n">dim_data</span> <span class="o">=</span> <span class="n">A</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">nb_data</span> <span class="o">=</span> <span class="n">B</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">nb_src</span> <span class="o">=</span> <span class="n">A</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">output</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">nb_src</span><span class="p">,</span><span class="n">nb_data</span><span class="p">))</span>
    <span class="n">ones_vect</span> <span class="o">=</span> <span class="n">ones</span><span class="p">((</span><span class="n">nb_src</span><span class="p">,))</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_data</span><span class="p">):</span>
        <span class="n">optim_res</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">optimize</span><span class="o">.</span><span class="n">linprog</span><span class="p">(</span><span class="n">ones_vect</span><span class="p">,</span> <span class="n">A_ub</span><span class="o">=-</span><span class="n">eye</span><span class="p">(</span><span class="n">nb_src</span><span class="p">),</span> <span class="n">b_ub</span><span class="o">=</span><span class="n">ones_vect</span><span class="o">*</span><span class="mi">0</span><span class="p">,</span><span class="n">A_eq</span><span class="o">=</span><span class="n">transpose</span><span class="p">(</span><span class="n">A</span><span class="p">)</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">A</span><span class="p">),</span><span class="n">b_eq</span> <span class="o">=</span> <span class="n">transpose</span><span class="p">(</span><span class="n">A</span><span class="p">)</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">B</span><span class="p">[:,</span><span class="n">i</span><span class="p">]))</span>
        <span class="n">output</span><span class="p">[:,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">optim_res</span><span class="o">.</span><span class="n">x</span>
    <span class="k">return</span> <span class="n">output</span>

<span class="k">def</span> <span class="nf">lsq_mat</span><span class="p">(</span><span class="n">S</span><span class="p">,</span><span class="n">Y</span><span class="p">):</span> <span class="c1"># Solves min_A ||Y-SA||_2^2</span>
    <span class="n">Y2</span> <span class="o">=</span> <span class="n">transpose</span><span class="p">(</span><span class="n">S</span><span class="p">)</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">Y</span><span class="p">)</span>
    <span class="n">S2</span> <span class="o">=</span> <span class="n">transpose</span><span class="p">(</span><span class="n">S</span><span class="p">)</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">S</span><span class="p">)</span>
    <span class="n">A</span> <span class="o">=</span> <span class="n">LA</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">S2</span><span class="p">)</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">Y2</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">A</span>


<span class="k">def</span> <span class="nf">coeff_adjust</span><span class="p">(</span><span class="n">coeff</span><span class="p">,</span><span class="n">A</span><span class="p">,</span><span class="n">nb_iter</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span><span class="n">tol_neg</span><span class="o">=-</span><span class="mf">1e-5</span><span class="p">):</span> <span class="c1"># computes a zero mean vector u with the same length as coeff, in A null space so that coeff+u&gt;=0, with dijkstra algorithm</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">coeff</span><span class="p">)</span>
    <span class="n">p</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">*</span><span class="mi">0</span>
    <span class="n">q</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">*</span><span class="mi">0</span>
    <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">cons_mat</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">A</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">A</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
    <span class="n">cons_mat</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">A</span>
    <span class="n">cons_mat</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,:]</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">cons_mat</span> <span class="o">=</span> <span class="n">transpose</span><span class="p">(</span><span class="n">cons_mat</span><span class="p">)</span>
    <span class="n">cons_mat</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">Vt</span> <span class="o">=</span> <span class="n">linalg</span><span class="o">.</span><span class="n">svd</span><span class="p">(</span><span class="n">cons_mat</span><span class="p">,</span><span class="n">full_matrices</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">ind</span> <span class="o">=</span> <span class="n">where</span><span class="p">(</span><span class="n">x</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">neg_w</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">ind</span><span class="p">])</span>
    <span class="k">while</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">nb_iter</span> <span class="ow">and</span> <span class="n">neg_w</span><span class="o">&lt;</span><span class="n">tol_neg</span><span class="p">:</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">ineq_proj</span><span class="p">(</span><span class="n">x</span><span class="o">+</span><span class="n">p</span><span class="p">,</span><span class="o">-</span><span class="n">coeff</span><span class="p">)</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">x</span><span class="o">+</span><span class="n">p</span><span class="o">-</span><span class="n">y</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">y</span><span class="o">+</span><span class="n">q</span><span class="o">-</span><span class="n">utils</span><span class="o">.</span><span class="n">proj_vect</span><span class="p">(</span><span class="n">y</span><span class="o">+</span><span class="n">q</span><span class="p">,</span><span class="n">cons_mat</span><span class="p">,</span><span class="n">ortho_en</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">q</span> <span class="o">=</span> <span class="n">y</span><span class="o">+</span><span class="n">q</span><span class="o">-</span><span class="n">x</span>
        <span class="n">ind</span> <span class="o">=</span> <span class="n">where</span><span class="p">(</span><span class="n">x</span><span class="o">+</span><span class="n">coeff</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">neg_w</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span><span class="o">+</span><span class="n">coeff</span><span class="p">[</span><span class="n">ind</span><span class="p">])</span>
        <span class="nb">print</span> <span class="n">neg_w</span>
        <span class="n">i</span><span class="o">+=</span><span class="mi">1</span>
    <span class="k">return</span> <span class="n">x</span><span class="p">,</span><span class="n">cons_mat</span>


<span class="k">def</span> <span class="nf">cv_feasibility_pb</span><span class="p">(</span><span class="n">coeff</span><span class="p">,</span><span class="n">A</span><span class="p">,</span><span class="n">w1</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span><span class="n">nb_iter</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span><span class="n">tol_neg</span><span class="o">=-</span><span class="mf">1e-5</span><span class="p">):</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">coeff</span><span class="p">)</span>
    <span class="n">w2</span> <span class="o">=</span> <span class="mi">1</span><span class="o">-</span><span class="n">w1</span>
    <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">cons_mat</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">A</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">A</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
    <span class="n">cons_mat</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">A</span>
    <span class="n">cons_mat</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,:]</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">cons_mat</span> <span class="o">=</span> <span class="n">transpose</span><span class="p">(</span><span class="n">cons_mat</span><span class="p">)</span>
    <span class="n">cons_mat</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">Vt</span> <span class="o">=</span> <span class="n">linalg</span><span class="o">.</span><span class="n">svd</span><span class="p">(</span><span class="n">cons_mat</span><span class="p">,</span><span class="n">full_matrices</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">ind</span> <span class="o">=</span> <span class="n">where</span><span class="p">(</span><span class="n">x</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">neg_w</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">ind</span><span class="p">])</span>

    <span class="k">while</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">nb_iter</span> <span class="ow">and</span> <span class="n">neg_w</span><span class="o">&lt;</span><span class="n">tol_neg</span><span class="p">:</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">ineq_proj</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="o">-</span><span class="n">coeff</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">y</span><span class="o">-</span><span class="n">utils</span><span class="o">.</span><span class="n">proj_vect</span><span class="p">(</span><span class="n">y</span><span class="p">,</span><span class="n">cons_mat</span><span class="p">,</span><span class="n">ortho_en</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="c1">#x = w1*ineq_proj(x,-coeff)+w2*(x-utils.proj_vect(x,cons_mat,ortho_en=False))</span>
        <span class="n">ind</span> <span class="o">=</span> <span class="n">where</span><span class="p">(</span><span class="n">x</span><span class="o">+</span><span class="n">coeff</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">neg_w</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span><span class="o">+</span><span class="n">coeff</span><span class="p">[</span><span class="n">ind</span><span class="p">])</span>
        <span class="nb">print</span> <span class="n">neg_w</span>
        <span class="n">i</span><span class="o">+=</span><span class="mi">1</span>
    <span class="k">return</span> <span class="n">x</span><span class="p">,</span><span class="n">cons_mat</span>

<span class="k">def</span> <span class="nf">coeff_adjust_dr</span><span class="p">(</span><span class="n">coeff</span><span class="p">,</span><span class="n">A</span><span class="p">,</span><span class="n">nb_iter</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span><span class="n">tol_neg</span><span class="o">=-</span><span class="mf">1e-5</span><span class="p">,</span><span class="n">gamma</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">coeff</span><span class="p">)</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">*</span><span class="mi">0</span>
    <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">cons_mat</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">A</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">A</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
    <span class="n">cons_mat</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">A</span>
    <span class="n">cons_mat</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,:]</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">cons_mat</span> <span class="o">=</span> <span class="n">transpose</span><span class="p">(</span><span class="n">cons_mat</span><span class="p">)</span>
    <span class="n">cons_mat</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">Vt</span> <span class="o">=</span> <span class="n">linalg</span><span class="o">.</span><span class="n">svd</span><span class="p">(</span><span class="n">cons_mat</span><span class="p">,</span><span class="n">full_matrices</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">ind</span> <span class="o">=</span> <span class="n">where</span><span class="p">(</span><span class="n">x</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">neg_w</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">ind</span><span class="p">])</span>
    <span class="n">lambd</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">thresh</span> <span class="o">=</span> <span class="n">gamma</span><span class="o">*</span><span class="n">ones</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">coeff</span><span class="p">),))</span>
    <span class="k">while</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">nb_iter</span><span class="p">:</span> <span class="c1">#and neg_w&lt;tol_neg:</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">y</span><span class="o">-</span><span class="p">((</span><span class="n">double</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">nb_iter</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span><span class="o">**</span><span class="p">(</span><span class="mi">10</span><span class="p">))</span><span class="o">*</span><span class="n">utils</span><span class="o">.</span><span class="n">proj_vect</span><span class="p">(</span><span class="n">y</span><span class="p">,</span><span class="n">cons_mat</span><span class="p">,</span><span class="n">ortho_en</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">y</span> <span class="o">+</span> <span class="n">lambd</span><span class="o">*</span><span class="p">(</span><span class="n">utils</span><span class="o">.</span><span class="n">thresholding</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">x</span><span class="o">-</span><span class="n">y</span><span class="o">+</span><span class="n">coeff</span><span class="p">,</span><span class="n">thresh</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">-</span><span class="n">x</span><span class="o">-</span><span class="n">coeff</span><span class="p">)</span>
        <span class="n">ind</span> <span class="o">=</span> <span class="n">where</span><span class="p">(</span><span class="n">x</span><span class="o">+</span><span class="n">coeff</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">neg_w</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span><span class="o">+</span><span class="n">coeff</span><span class="p">[</span><span class="n">ind</span><span class="p">])</span>
        <span class="n">i</span><span class="o">+=</span><span class="mi">1</span>
    <span class="nb">print</span> <span class="s1">&#39;neg weight: &#39;</span><span class="p">,</span><span class="n">neg_w</span><span class="p">,</span><span class="s1">&#39;l1 norm&#39;</span><span class="p">,</span><span class="nb">abs</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">x</span><span class="p">,</span><span class="n">cons_mat</span>



<span class="k">def</span> <span class="nf">pos_lsq_mat_inv</span><span class="p">(</span><span class="n">A</span><span class="p">,</span><span class="n">B</span><span class="p">):</span>
    <span class="n">coeff</span> <span class="o">=</span> <span class="n">lsq_mat_inv</span><span class="p">(</span><span class="n">A</span><span class="p">,</span><span class="n">B</span><span class="p">)</span>
    <span class="n">nb_vect</span> <span class="o">=</span> <span class="n">A</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">nb_samp</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">siz</span> <span class="o">=</span> <span class="n">B</span><span class="o">.</span><span class="n">shape</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">siz</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">:</span>
        <span class="n">nb_samp</span> <span class="o">=</span> <span class="n">siz</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">coeff_out</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">coeff</span><span class="p">)</span><span class="o">*</span><span class="mi">0</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_samp</span><span class="p">):</span>
        <span class="n">ind</span> <span class="o">=</span> <span class="n">where</span><span class="p">(</span><span class="n">coeff</span><span class="p">[:,</span><span class="n">i</span><span class="p">]</span><span class="o">&gt;</span><span class="nb">min</span><span class="p">(</span><span class="n">coeff</span><span class="p">[:,</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span><span class="mi">0</span><span class="p">))</span>
        <span class="n">coeff_out</span><span class="p">[</span><span class="n">ind</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">lsq_mat_inv</span><span class="p">(</span><span class="n">A</span><span class="p">[:,</span><span class="n">ind</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span><span class="n">B</span><span class="p">[:,</span><span class="n">i</span><span class="p">])</span>

    <span class="n">B_approx_1</span> <span class="o">=</span> <span class="n">A</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">coeff</span><span class="p">)</span>
    <span class="n">B_approx_2</span> <span class="o">=</span> <span class="n">A</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">coeff_out</span><span class="p">)</span>
    <span class="n">err_1</span> <span class="o">=</span> <span class="p">((</span><span class="n">B</span><span class="o">-</span><span class="n">B_approx_1</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    <span class="n">err_2</span> <span class="o">=</span> <span class="p">((</span><span class="n">B</span><span class="o">-</span><span class="n">B_approx_2</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    <span class="nb">print</span> <span class="s2">&quot;lsq err: &quot;</span><span class="p">,</span><span class="n">err_1</span><span class="p">,</span><span class="s2">&quot; &quot;</span><span class="p">,</span><span class="n">err_2</span>
    <span class="nb">print</span> <span class="s2">&quot;min val:&quot;</span><span class="p">,</span><span class="n">coeff</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span><span class="s2">&quot; &quot;</span><span class="p">,</span><span class="n">coeff_out</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">coeff</span><span class="p">,</span><span class="n">coeff_out</span>


<span class="k">def</span> <span class="nf">iter_lsq</span><span class="p">(</span><span class="n">A</span><span class="p">,</span><span class="n">B</span><span class="p">,</span><span class="n">nb_iter</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span><span class="n">tinit</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">pos_en</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">tol</span><span class="o">=</span><span class="mf">1e-15</span><span class="p">):</span> <span class="c1"># Solves ||AX-B||^2</span>
    <span class="n">M</span> <span class="o">=</span> <span class="n">transpose</span><span class="p">(</span><span class="n">A</span><span class="p">)</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">A</span><span class="p">)</span>
    <span class="n">w</span><span class="p">,</span><span class="n">v</span> <span class="o">=</span> <span class="n">LA</span><span class="o">.</span><span class="n">eigh</span><span class="p">(</span><span class="n">M</span><span class="p">)</span>
    <span class="n">tol0</span> <span class="o">=</span> <span class="mf">0.1</span>
    <span class="n">lip</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">w</span><span class="p">)</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
    <span class="n">mu</span> <span class="o">=</span> <span class="mi">1</span><span class="o">/</span><span class="p">((</span><span class="mi">1</span><span class="o">+</span><span class="n">tol0</span><span class="p">)</span><span class="o">*</span><span class="n">lip</span><span class="p">)</span>
    <span class="n">shap</span> <span class="o">=</span> <span class="n">A</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">shap1</span> <span class="o">=</span> <span class="n">B</span><span class="o">.</span><span class="n">shape</span>

    <span class="c1"># Initialization</span>
    <span class="n">t</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">shap1</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
    <span class="k">if</span> <span class="n">tinit</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap1</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
            <span class="n">minim</span> <span class="o">=</span> <span class="mf">1e16</span>
            <span class="n">ind</span><span class="o">=</span><span class="mi">0</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
                <span class="n">dist</span> <span class="o">=</span> <span class="p">((</span><span class="n">A</span><span class="p">[:,</span><span class="n">i</span><span class="p">]</span><span class="o">-</span><span class="n">B</span><span class="p">[:,</span><span class="n">j</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span>
                <span class="k">if</span> <span class="n">dist</span> <span class="o">&lt;</span> <span class="n">minim</span><span class="p">:</span>
                    <span class="n">ind</span> <span class="o">=</span> <span class="n">i</span>
                    <span class="n">minim</span> <span class="o">=</span> <span class="n">dist</span>
            <span class="n">t</span><span class="p">[</span><span class="n">ind</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">tinit</span><span class="p">)</span>
    <span class="n">mse</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">nb_iter</span><span class="p">,))</span>
    <span class="n">lambd</span> <span class="o">=</span> <span class="mf">1.5</span>
    <span class="n">var</span> <span class="o">=</span> <span class="mi">100</span>
    <span class="n">i</span><span class="o">=</span><span class="mi">0</span>
    <span class="nb">print</span> <span class="s2">&quot; ----- &quot;</span><span class="p">,</span><span class="n">nb_iter</span><span class="p">,</span><span class="s2">&quot; ------ &quot;</span>
    <span class="k">while</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">nb_iter</span><span class="p">:</span><span class="c1"># and var&gt;tol:</span>

        <span class="n">res</span> <span class="o">=</span> <span class="n">A</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">t</span><span class="p">)</span><span class="o">-</span><span class="n">B</span>
        <span class="n">grad</span> <span class="o">=</span> <span class="n">transpose</span><span class="p">(</span><span class="n">A</span><span class="p">)</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>
        <span class="n">fw_grad</span> <span class="o">=</span> <span class="n">A</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">grad</span><span class="p">)</span>
        <span class="n">mse</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">res</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="c1"># Optimal steps computation</span>
        <span class="n">fw_grad_norm</span> <span class="o">=</span> <span class="n">diag</span><span class="p">(</span><span class="n">transpose</span><span class="p">(</span><span class="n">fw_grad</span><span class="p">)</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">fw_grad</span><span class="p">))</span>
        <span class="c1">#print fw_grad_norm.min()</span>

        <span class="n">steps</span> <span class="o">=</span> <span class="p">(</span><span class="n">res</span><span class="o">*</span><span class="n">fw_grad</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">ind</span> <span class="o">=</span> <span class="n">where</span><span class="p">(</span><span class="n">fw_grad_norm</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">steps</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span> <span class="o">/=</span><span class="n">fw_grad_norm</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span>
        <span class="c1">#print mse[i]</span>
        <span class="n">told</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">t</span> <span class="o">-</span> <span class="n">grad</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">diag</span><span class="p">(</span><span class="n">steps</span><span class="p">))</span>
        <span class="c1">#t = t - mu*grad</span>
        <span class="k">if</span> <span class="n">pos_en</span><span class="p">:</span>
            <span class="n">t</span> <span class="o">=</span> <span class="n">pos_proj</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
        <span class="n">var</span>  <span class="o">=</span> <span class="mi">100</span><span class="o">*</span><span class="p">((</span><span class="n">t</span><span class="o">-</span><span class="n">told</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">/</span><span class="p">(</span><span class="n">told</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="n">i</span><span class="o">+=</span><span class="mi">1</span>
    <span class="nb">print</span> <span class="s2">&quot;coeff res: &quot;</span><span class="p">,</span><span class="n">mse</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="sd">&quot;&quot;&quot;t = pos_proj(t)</span>
<span class="sd">        one_vect = ones((shap[1],1))</span>
<span class="sd">        t = t/(one_vect.dot((t.sum(axis=0)).reshape(1,shap1[1])))&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">t</span>

<span class="k">def</span> <span class="nf">iter_lsq_accel</span><span class="p">(</span><span class="n">A</span><span class="p">,</span><span class="n">B</span><span class="p">,</span><span class="n">nb_iter</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span><span class="n">zinit</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">pos_en</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">tol</span><span class="o">=</span><span class="mf">1e-15</span><span class="p">):</span> <span class="c1"># Solves ||AX-B||^2</span>


    <span class="n">M</span> <span class="o">=</span> <span class="n">transpose</span><span class="p">(</span><span class="n">A</span><span class="p">)</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">A</span><span class="p">)</span>
    <span class="n">w</span><span class="p">,</span><span class="n">v</span> <span class="o">=</span> <span class="n">LA</span><span class="o">.</span><span class="n">eigh</span><span class="p">(</span><span class="n">M</span><span class="p">)</span>
    <span class="n">tol0</span> <span class="o">=</span> <span class="mf">0.1</span>
    <span class="n">lip</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">w</span><span class="p">)</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
    <span class="n">mu</span> <span class="o">=</span> <span class="mi">1</span><span class="o">/</span><span class="p">((</span><span class="mi">1</span><span class="o">+</span><span class="n">tol0</span><span class="p">)</span><span class="o">*</span><span class="n">lip</span><span class="p">)</span>
    <span class="n">shap</span> <span class="o">=</span> <span class="n">A</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">shap1</span> <span class="o">=</span> <span class="n">B</span><span class="o">.</span><span class="n">shape</span>

    <span class="n">X2</span> <span class="o">=</span> <span class="n">B</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">transpose</span><span class="p">(</span><span class="n">B</span><span class="p">))</span>
    <span class="n">U</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">Vt</span> <span class="o">=</span> <span class="n">linalg</span><span class="o">.</span><span class="n">svd</span><span class="p">(</span><span class="n">X2</span><span class="p">,</span><span class="n">full_matrices</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">ref_res</span> <span class="o">=</span> <span class="n">s</span><span class="p">[</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">]:]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    <span class="nb">print</span> <span class="s1">&#39;ref res: &#39;</span><span class="p">,</span><span class="n">ref_res</span>
    <span class="c1"># Initialization</span>
    <span class="n">z</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">shap1</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
    <span class="k">if</span> <span class="n">zinit</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap1</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
            <span class="n">minim</span> <span class="o">=</span> <span class="mf">1e16</span>
            <span class="n">ind</span><span class="o">=</span><span class="mi">0</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
                <span class="n">dist</span> <span class="o">=</span> <span class="p">((</span><span class="n">A</span><span class="p">[:,</span><span class="n">i</span><span class="p">]</span><span class="o">-</span><span class="n">B</span><span class="p">[:,</span><span class="n">j</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span>
                <span class="k">if</span> <span class="n">dist</span> <span class="o">&lt;</span> <span class="n">minim</span><span class="p">:</span>
                    <span class="n">ind</span> <span class="o">=</span> <span class="n">i</span>
                    <span class="n">minim</span> <span class="o">=</span> <span class="n">dist</span>
            <span class="n">z</span><span class="p">[</span><span class="n">ind</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">z</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">zinit</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">z</span><span class="p">)</span>
    <span class="n">mse</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">nb_iter</span><span class="p">,))</span>
    <span class="n">var</span> <span class="o">=</span> <span class="mi">100</span>
    <span class="n">i</span><span class="o">=</span><span class="mi">0</span>
    <span class="n">t</span><span class="o">=</span><span class="mi">1</span>
    <span class="nb">print</span> <span class="s2">&quot; ----- &quot;</span><span class="p">,</span><span class="n">nb_iter</span><span class="p">,</span><span class="s2">&quot; ------ &quot;</span>
    <span class="k">while</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">nb_iter</span><span class="p">:</span><span class="c1"># and var&gt;tol:</span>

        <span class="n">res</span> <span class="o">=</span> <span class="n">A</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">z</span><span class="p">)</span><span class="o">-</span><span class="n">B</span>
        <span class="n">grad</span> <span class="o">=</span> <span class="n">transpose</span><span class="p">(</span><span class="n">A</span><span class="p">)</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>
        <span class="n">mse</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">res</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="nb">print</span> <span class="n">mse</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">z</span> <span class="o">-</span> <span class="n">mu</span><span class="o">*</span><span class="n">grad</span>
        <span class="n">xold</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">pos_en</span><span class="p">:</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">pos_proj</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
        <span class="n">told</span> <span class="o">=</span> <span class="n">t</span>
        <span class="n">t</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">4</span><span class="o">*</span><span class="n">t</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span><span class="mi">1</span><span class="p">))</span><span class="o">/</span><span class="mi">2</span>
        <span class="n">lambd</span> <span class="o">=</span> <span class="mi">1</span><span class="o">+</span><span class="p">(</span><span class="n">told</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="n">t</span>
        <span class="n">zold</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">z</span><span class="p">)</span>
        <span class="n">z</span> <span class="o">=</span> <span class="n">xold</span><span class="o">+</span><span class="n">lambd</span><span class="o">*</span><span class="p">(</span><span class="n">x</span><span class="o">-</span><span class="n">xold</span><span class="p">)</span>
        <span class="n">var</span>  <span class="o">=</span> <span class="mi">100</span><span class="o">*</span><span class="p">((</span><span class="n">z</span><span class="o">-</span><span class="n">zold</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">/</span><span class="p">(</span><span class="n">zold</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="n">i</span><span class="o">+=</span><span class="mi">1</span>
    <span class="nb">print</span> <span class="s2">&quot;coeff res: &quot;</span><span class="p">,</span><span class="n">mse</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="sd">&quot;&quot;&quot;t = pos_proj(t)</span>
<span class="sd">        one_vect = ones((shap[1],1))</span>
<span class="sd">        t = t/(one_vect.dot((t.sum(axis=0)).reshape(1,shap1[1])))&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">z</span>


<span class="c1">#def iter_hard_thresh_lsq():</span>

<span class="k">def</span> <span class="nf">sparse_bar_coord_pb_field</span><span class="p">(</span><span class="n">A</span><span class="p">,</span><span class="n">B</span><span class="p">,</span><span class="n">tinit</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">thresh_map</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">thresh_type</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">nb_iter</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span><span class="n">tol</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span> <span class="c1"># Solve the problem min ||At-B||^2, s.t. sum_i ti=1, ti&gt;=0; calculates the best &quot;barycentric&quot; coordinates of B with respect to A columns; B and t are now matrices</span>
    <span class="n">w1</span> <span class="o">=</span> <span class="mf">0.5</span>
    <span class="n">w2</span> <span class="o">=</span> <span class="mi">1</span><span class="o">-</span><span class="n">w1</span>
    <span class="n">M</span> <span class="o">=</span> <span class="n">transpose</span><span class="p">(</span><span class="n">A</span><span class="p">)</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">A</span><span class="p">)</span>
    <span class="n">w</span><span class="p">,</span><span class="n">v</span> <span class="o">=</span> <span class="n">LA</span><span class="o">.</span><span class="n">eigh</span><span class="p">(</span><span class="n">M</span><span class="p">)</span>
    <span class="n">tol0</span> <span class="o">=</span> <span class="mf">0.1</span>
    <span class="n">lip</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">w</span><span class="p">)</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
    <span class="n">mu</span> <span class="o">=</span> <span class="mi">1</span><span class="o">/</span><span class="p">((</span><span class="mi">1</span><span class="o">+</span><span class="n">tol0</span><span class="p">)</span><span class="o">*</span><span class="n">lip</span><span class="p">)</span>
    <span class="n">shap</span> <span class="o">=</span> <span class="n">A</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">shap1</span> <span class="o">=</span> <span class="n">B</span><span class="o">.</span><span class="n">shape</span>

    <span class="c1"># Initialization</span>
    <span class="n">t</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">shap1</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
    <span class="k">if</span> <span class="n">tinit</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap1</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
            <span class="n">minim</span> <span class="o">=</span> <span class="mf">1e16</span>
            <span class="n">ind</span><span class="o">=</span><span class="mi">0</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
                <span class="n">dist</span> <span class="o">=</span> <span class="p">((</span><span class="n">A</span><span class="p">[:,</span><span class="n">i</span><span class="p">]</span><span class="o">-</span><span class="n">B</span><span class="p">[:,</span><span class="n">j</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span>
                <span class="k">if</span> <span class="n">dist</span> <span class="o">&lt;</span> <span class="n">minim</span><span class="p">:</span>
                    <span class="n">ind</span> <span class="o">=</span> <span class="n">i</span>
                    <span class="n">minim</span> <span class="o">=</span> <span class="n">dist</span>
            <span class="n">t</span><span class="p">[</span><span class="n">ind</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">tinit</span><span class="p">)</span>
    <span class="n">z1</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
    <span class="n">z2</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
    <span class="n">mse</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">nb_iter</span><span class="p">,))</span>
    <span class="n">lambd</span> <span class="o">=</span> <span class="mf">1.5</span>
    <span class="n">var</span> <span class="o">=</span> <span class="mi">100</span>
    <span class="n">i</span><span class="o">=</span><span class="mi">0</span>
    <span class="k">while</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">nb_iter</span> <span class="ow">and</span> <span class="n">var</span><span class="o">&gt;</span><span class="n">tol</span><span class="p">:</span>

        <span class="n">res</span> <span class="o">=</span> <span class="n">A</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">t</span><span class="p">)</span><span class="o">-</span><span class="n">B</span>
        <span class="n">grad</span> <span class="o">=</span> <span class="n">transpose</span><span class="p">(</span><span class="n">A</span><span class="p">)</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>
        <span class="n">mse</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">res</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="nb">print</span> <span class="n">mse</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">temp1</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">t</span> <span class="o">-</span> <span class="n">z1</span> <span class="o">-</span> <span class="n">mu</span><span class="o">*</span><span class="n">grad</span>
        <span class="n">z1</span> <span class="o">=</span> <span class="n">z1</span> <span class="o">+</span> <span class="n">lambd</span><span class="o">*</span><span class="p">(</span><span class="n">prox_coeff_sum_mat</span><span class="p">(</span><span class="n">temp1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">-</span><span class="n">t</span><span class="p">)</span>
        <span class="n">temp2</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">t</span> <span class="o">-</span> <span class="n">z2</span> <span class="o">-</span> <span class="n">mu</span><span class="o">*</span><span class="n">grad</span>
        <span class="k">if</span> <span class="n">thresh_map</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">z2</span> <span class="o">=</span> <span class="n">z2</span> <span class="o">+</span> <span class="n">lambd</span><span class="o">*</span><span class="p">(</span><span class="n">pos_proj</span><span class="p">(</span><span class="n">utils</span><span class="o">.</span><span class="n">thresholding</span><span class="p">(</span><span class="n">temp2</span><span class="p">,</span><span class="n">thresh_map</span><span class="p">,</span><span class="n">thresh_type</span><span class="p">))</span><span class="o">-</span><span class="n">t</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">z2</span> <span class="o">=</span> <span class="n">z2</span> <span class="o">+</span> <span class="n">lambd</span><span class="o">*</span><span class="p">(</span><span class="n">pos_proj</span><span class="p">(</span><span class="n">temp2</span><span class="p">)</span><span class="o">-</span><span class="n">t</span><span class="p">)</span>
        <span class="n">told</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">w1</span><span class="o">*</span><span class="n">z1</span><span class="o">+</span><span class="n">w2</span><span class="o">*</span><span class="n">z2</span>
        <span class="n">var</span>  <span class="o">=</span> <span class="mi">100</span><span class="o">*</span><span class="p">((</span><span class="n">t</span><span class="o">-</span><span class="n">told</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">/</span><span class="p">(</span><span class="n">told</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="n">i</span><span class="o">+=</span><span class="mi">1</span>

    <span class="nb">print</span> <span class="s2">&quot;coeff res: &quot;</span><span class="p">,</span><span class="n">mse</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">t</span> <span class="o">=</span> <span class="n">pos_proj</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
    <span class="n">one_vect</span> <span class="o">=</span> <span class="n">ones</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="mi">1</span><span class="p">))</span>
    <span class="n">t</span> <span class="o">=</span> <span class="n">t</span><span class="o">/</span><span class="p">(</span><span class="n">one_vect</span><span class="o">.</span><span class="n">dot</span><span class="p">((</span><span class="n">t</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">shap1</span><span class="p">[</span><span class="mi">1</span><span class="p">])))</span>
    <span class="k">return</span> <span class="n">t</span>

<span class="k">def</span> <span class="nf">displacement_interp</span><span class="p">(</span><span class="n">distrib_mat</span><span class="p">,</span><span class="n">cross_maps</span><span class="p">,</span><span class="n">bar_coordinates</span><span class="p">,</span><span class="n">thresh</span><span class="p">,</span><span class="n">nb_iter</span><span class="p">):</span> <span class="c1"># Calculate optimal mass displacement at a specified location between given some given distributions, in the sense of wassertein L2 distance. The masses of the given distribuiton are in the columns of distrib_mat. The total mass of each distribution must be the same.</span>
    <span class="n">w</span> <span class="o">=</span> <span class="mf">1.0</span><span class="o">/</span><span class="mi">3</span>
    <span class="n">lambd</span> <span class="o">=</span> <span class="mi">1</span> <span class="c1">#1.5</span>
    <span class="n">shap</span> <span class="o">=</span> <span class="n">distrib_mat</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">P</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
    <span class="n">k</span><span class="o">=</span><span class="mi">0</span>
    <span class="n">mean_distrib</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="mi">1</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
        <span class="n">mean_distrib</span> <span class="o">=</span> <span class="n">mean_distrib</span> <span class="o">+</span> <span class="n">distrib_mat</span><span class="p">[:,</span><span class="n">k</span><span class="p">]</span><span class="o">/</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">i</span><span class="o">=</span><span class="mi">0</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
            <span class="n">P</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">mean_distrib</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">z1</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">P</span><span class="p">)</span>
    <span class="n">z2</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">P</span><span class="p">)</span>
    <span class="n">z3</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">P</span><span class="p">)</span>
    <span class="n">z4</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">P</span><span class="p">)</span>
    <span class="n">cost</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">nb_iter</span><span class="p">,))</span>
    <span class="n">l</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">grad</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">cross_maps</span><span class="p">)</span>
    <span class="n">thresh_map</span> <span class="o">=</span> <span class="mi">0</span><span class="o">*</span><span class="n">P</span>
    <span class="n">ones_vect</span> <span class="o">=</span> <span class="n">ones</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="mi">1</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
        <span class="n">distrib_k</span> <span class="o">=</span> <span class="n">distrib_mat</span><span class="p">[:,</span><span class="n">k</span><span class="p">]</span>
        <span class="n">distrib_k</span> <span class="o">=</span> <span class="n">distrib_k</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
        <span class="n">thresh_map</span><span class="p">[:,:,</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">ones_vect</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">distrib_k</span><span class="p">)</span><span class="o">*</span><span class="n">thresh</span>
    <span class="n">thresh_type</span> <span class="o">=</span> <span class="mi">1</span> <span class="c1"># Soft thresh</span>
    <span class="n">mu</span> <span class="o">=</span> <span class="mf">1.0</span><span class="o">/</span><span class="p">((</span><span class="n">grad</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
        <span class="n">grad</span><span class="p">[:,:,</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">bar_coordinates</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">*</span><span class="n">grad</span><span class="p">[:,:,</span><span class="n">k</span><span class="p">]</span>
    <span class="n">a1</span> <span class="o">=</span> <span class="mf">0.2</span>
    <span class="n">a2</span> <span class="o">=</span> <span class="mi">9</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">a1</span><span class="p">)</span><span class="o">/</span><span class="mi">10</span>
    <span class="n">a3</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">a1</span><span class="o">-</span><span class="n">a2</span><span class="p">)</span><span class="o">/</span><span class="mi">3</span>
    <span class="n">a4</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span><span class="n">a1</span><span class="o">-</span><span class="n">a2</span><span class="o">-</span><span class="n">a3</span>
    <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_iter</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
            <span class="n">cost</span><span class="p">[</span><span class="n">l</span><span class="p">]</span> <span class="o">=</span> <span class="n">cost</span><span class="p">[</span><span class="n">l</span><span class="p">]</span><span class="o">+</span><span class="n">bar_coordinates</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="n">P</span><span class="p">[:,:,</span><span class="n">k</span><span class="p">]</span><span class="o">*</span><span class="n">cross_maps</span><span class="p">[:,:,</span><span class="n">k</span><span class="p">])</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="nb">print</span> <span class="n">cost</span><span class="p">[</span><span class="n">l</span><span class="p">]</span>
        <span class="n">temp1</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">P</span> <span class="o">-</span> <span class="n">z1</span> <span class="o">-</span> <span class="n">mu</span><span class="o">*</span><span class="n">grad</span>
        <span class="n">z1</span> <span class="o">=</span> <span class="n">z1</span> <span class="o">+</span> <span class="n">lambd</span><span class="o">*</span><span class="p">(</span><span class="n">prox_cube_marg</span><span class="p">(</span><span class="n">temp1</span><span class="p">,</span><span class="n">distrib_mat</span><span class="p">)</span><span class="o">-</span><span class="n">P</span><span class="p">)</span>
        <span class="n">temp2</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">P</span> <span class="o">-</span> <span class="n">z2</span> <span class="o">-</span> <span class="n">mu</span><span class="o">*</span><span class="n">grad</span>
        <span class="n">z2</span> <span class="o">=</span> <span class="n">z2</span> <span class="o">+</span> <span class="n">lambd</span><span class="o">*</span><span class="p">(</span><span class="n">prox_cube_marg_homog</span><span class="p">(</span><span class="n">temp2</span><span class="p">)</span><span class="o">-</span><span class="n">P</span><span class="p">)</span>
        <span class="n">temp3</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">P</span> <span class="o">-</span> <span class="n">z3</span> <span class="o">-</span> <span class="n">mu</span><span class="o">*</span><span class="n">grad</span>
        <span class="n">z3</span> <span class="o">=</span> <span class="n">z3</span> <span class="o">+</span> <span class="n">lambd</span><span class="o">*</span><span class="p">(</span><span class="n">pos_proj_cube</span><span class="p">(</span><span class="n">temp3</span><span class="p">)</span><span class="o">-</span><span class="n">P</span><span class="p">)</span>
        <span class="n">temp4</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">P</span> <span class="o">-</span> <span class="n">z4</span> <span class="o">-</span> <span class="n">mu</span><span class="o">*</span><span class="n">grad</span>
        <span class="n">z4</span> <span class="o">=</span> <span class="n">z4</span> <span class="o">+</span> <span class="n">lambd</span><span class="o">*</span><span class="p">(</span><span class="n">utils</span><span class="o">.</span><span class="n">thresholding_3D</span><span class="p">(</span><span class="n">temp4</span><span class="p">,</span><span class="n">thresh_map</span><span class="p">,</span><span class="n">thresh_type</span><span class="p">)</span><span class="o">-</span><span class="n">P</span><span class="p">)</span>
        <span class="c1">#P = (z1+z2+z3+z4)/4</span>
        <span class="n">P</span> <span class="o">=</span> <span class="n">a1</span><span class="o">*</span><span class="n">z1</span><span class="o">+</span><span class="n">a2</span><span class="o">*</span><span class="n">z2</span><span class="o">+</span><span class="n">a3</span><span class="o">*</span><span class="n">z3</span><span class="o">+</span><span class="n">a4</span><span class="o">*</span><span class="n">z4</span>
    <span class="k">return</span> <span class="n">P</span><span class="p">,</span><span class="n">cost</span>


<span class="k">def</span> <span class="nf">opt_coupling</span><span class="p">(</span><span class="n">distrib1</span><span class="p">,</span><span class="n">distrib2</span><span class="p">,</span><span class="n">cross_map</span><span class="p">,</span><span class="n">thresh</span><span class="p">,</span><span class="n">nb_iter</span><span class="p">):</span>

    <span class="n">w</span> <span class="o">=</span> <span class="mf">1.0</span><span class="o">/</span><span class="mi">3</span>
    <span class="n">lambd</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">shap</span> <span class="o">=</span> <span class="n">cross_map</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">P</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span> <span class="c1"># We assume cross_map is a square matrix</span>
    <span class="n">k</span><span class="o">=</span><span class="mi">0</span>
    <span class="n">mean_distrib</span> <span class="o">=</span> <span class="p">(</span><span class="n">distrib1</span><span class="o">+</span><span class="n">distrib2</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span>
    <span class="n">i</span><span class="o">=</span><span class="mi">0</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
        <span class="n">P</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">mean_distrib</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">z1</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">P</span><span class="p">)</span>
    <span class="n">z2</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">P</span><span class="p">)</span>
    <span class="n">z3</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">P</span><span class="p">)</span>
    <span class="n">z4</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">P</span><span class="p">)</span>
    <span class="n">cost</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">nb_iter</span><span class="p">,))</span>
    <span class="n">l</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">grad</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">cross_map</span><span class="p">)</span>
    <span class="n">mu_max</span> <span class="o">=</span> <span class="mf">1.0</span><span class="o">/</span><span class="p">(</span><span class="n">grad</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span>
    <span class="n">mu_min</span><span class="o">=</span><span class="mi">0</span>

    <span class="n">ones_vect</span> <span class="o">=</span> <span class="n">ones</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
    <span class="n">thresh_map_1</span> <span class="o">=</span> <span class="n">distrib1</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">ones_vect</span><span class="p">)</span><span class="o">*</span><span class="n">thresh</span>
    <span class="n">thresh_map_2</span> <span class="o">=</span> <span class="n">transpose</span><span class="p">(</span><span class="n">distrib2</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">ones_vect</span><span class="p">))</span><span class="o">*</span><span class="n">thresh</span>
    <span class="n">thresh_map</span> <span class="o">=</span> <span class="n">thresh_map_1</span>
    <span class="n">thresh_type</span><span class="o">=</span><span class="mi">1</span> <span class="c1"># Soft thresholding</span>
    <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_iter</span><span class="p">):</span>
        <span class="c1">#mu = (mu_max-mu_min)*(nb_iter-1-l)/(nb_iter-1) + mu_min</span>
        <span class="n">mu</span> <span class="o">=</span> <span class="n">mu_max</span>
        <span class="n">cost</span><span class="p">[</span><span class="n">l</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">P</span><span class="p">[:,:]</span><span class="o">*</span><span class="n">cross_map</span><span class="p">[:,:])</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="nb">print</span> <span class="n">cost</span><span class="p">[</span><span class="n">l</span><span class="p">]</span>
        <span class="n">temp1</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">P</span> <span class="o">-</span> <span class="n">z1</span> <span class="o">-</span> <span class="n">mu</span><span class="o">*</span><span class="n">grad</span>

        <span class="n">z1</span> <span class="o">=</span> <span class="n">z1</span> <span class="o">+</span> <span class="n">lambd</span><span class="o">*</span><span class="p">(</span><span class="n">prox_mat_marg_l</span><span class="p">(</span><span class="n">temp1</span><span class="p">,</span><span class="n">distrib1</span><span class="p">)</span><span class="o">-</span><span class="n">P</span><span class="p">)</span>
        <span class="n">temp2</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">P</span> <span class="o">-</span> <span class="n">z2</span> <span class="o">-</span> <span class="n">mu</span><span class="o">*</span><span class="n">grad</span>
        <span class="n">z2</span> <span class="o">=</span> <span class="n">z2</span> <span class="o">+</span> <span class="n">lambd</span><span class="o">*</span><span class="p">(</span><span class="n">prox_mat_marg</span><span class="p">(</span><span class="n">temp2</span><span class="p">,</span><span class="n">distrib2</span><span class="p">)</span><span class="o">-</span><span class="n">P</span><span class="p">)</span>
        <span class="n">temp3</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">P</span> <span class="o">-</span> <span class="n">z3</span> <span class="o">-</span> <span class="n">mu</span><span class="o">*</span><span class="n">grad</span>
        <span class="n">z3</span> <span class="o">=</span> <span class="n">z3</span> <span class="o">+</span> <span class="n">lambd</span><span class="o">*</span><span class="p">(</span><span class="n">pos_proj_mat</span><span class="p">(</span><span class="n">temp3</span><span class="p">)</span><span class="o">-</span><span class="n">P</span><span class="p">)</span>
        <span class="n">temp4</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">P</span> <span class="o">-</span> <span class="n">z4</span> <span class="o">-</span> <span class="n">mu</span><span class="o">*</span><span class="n">grad</span>
        <span class="n">z4</span> <span class="o">=</span> <span class="n">z4</span> <span class="o">+</span> <span class="n">lambd</span><span class="o">*</span><span class="p">(</span><span class="n">utils</span><span class="o">.</span><span class="n">thresholding</span><span class="p">(</span><span class="n">temp4</span><span class="p">,</span><span class="n">thresh_map</span><span class="p">,</span><span class="n">thresh_type</span><span class="p">)</span><span class="o">-</span><span class="n">P</span><span class="p">)</span>
        <span class="n">P</span> <span class="o">=</span> <span class="p">(</span><span class="n">z1</span><span class="o">+</span><span class="n">z2</span><span class="o">+</span><span class="n">z3</span><span class="o">+</span><span class="n">z4</span><span class="p">)</span><span class="o">/</span><span class="mi">4</span>
    <span class="c1">#P = (z1+z2+z3)/3</span>

    <span class="k">return</span> <span class="n">P</span><span class="p">,</span><span class="n">cost</span><span class="p">,</span><span class="n">grad</span>

<span class="k">def</span> <span class="nf">opt_rotation</span><span class="p">(</span><span class="n">map_1</span><span class="p">,</span><span class="n">map_2</span><span class="p">,</span><span class="n">coupling_weights</span><span class="p">,</span><span class="n">nb_iter</span><span class="o">=</span><span class="mi">100</span><span class="p">):</span>
    <span class="n">M</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span>
    <span class="n">B</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>
    <span class="n">Y</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>
    <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">shap</span> <span class="o">=</span> <span class="n">map_1</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">O</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>
    <span class="n">O</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="n">map_1</span><span class="p">[(</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">,(</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">O</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="n">map_1</span><span class="p">[(</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">,(</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
        <span class="n">tempi</span><span class="o">=</span><span class="mi">0</span>
        <span class="n">i1</span> <span class="o">=</span> <span class="n">floor</span><span class="p">(</span><span class="n">i</span><span class="o">/</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="c1"># Line index in map_1</span>
        <span class="n">j1</span> <span class="o">=</span> <span class="n">mod</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">Mi</span>  <span class="o">=</span> <span class="n">array</span><span class="p">([[</span><span class="n">map_1</span><span class="p">[</span><span class="n">i1</span><span class="p">,</span><span class="n">j1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">O</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span><span class="o">-</span><span class="p">(</span><span class="n">map_1</span><span class="p">[</span><span class="n">i1</span><span class="p">,</span><span class="n">j1</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">O</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">])],[(</span><span class="n">map_1</span><span class="p">[</span><span class="n">i1</span><span class="p">,</span><span class="n">j1</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">O</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]),</span><span class="n">map_1</span><span class="p">[</span><span class="n">i1</span><span class="p">,</span><span class="n">j1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">O</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]]])</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
            <span class="n">tempi</span> <span class="o">=</span> <span class="n">tempi</span> <span class="o">+</span> <span class="n">coupling_weights</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span>
            <span class="n">i2</span> <span class="o">=</span> <span class="n">floor</span><span class="p">(</span><span class="n">j</span><span class="o">/</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="c1"># Line index in map_2</span>
            <span class="n">j2</span> <span class="o">=</span> <span class="n">mod</span><span class="p">(</span><span class="n">j</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">Y</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">map_2</span><span class="p">[</span><span class="n">i2</span><span class="p">,</span><span class="n">j2</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">Y</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">map_2</span><span class="p">[</span><span class="n">i2</span><span class="p">,</span><span class="n">j2</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">B</span> <span class="o">=</span> <span class="n">B</span> <span class="o">+</span> <span class="n">coupling_weights</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span><span class="o">*</span><span class="n">transpose</span><span class="p">(</span><span class="n">Mi</span><span class="p">)</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">Y</span><span class="o">-</span><span class="n">O</span><span class="p">)</span>
        <span class="n">M</span> <span class="o">=</span> <span class="n">M</span> <span class="o">+</span> <span class="n">tempi</span><span class="o">*</span><span class="n">transpose</span><span class="p">(</span><span class="n">Mi</span><span class="p">)</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">Mi</span><span class="p">)</span>

    <span class="n">w</span><span class="p">,</span><span class="n">v</span> <span class="o">=</span> <span class="n">LA</span><span class="o">.</span><span class="n">eigh</span><span class="p">(</span><span class="n">M</span><span class="p">)</span>
    <span class="n">tol</span> <span class="o">=</span> <span class="mf">0.1</span>
    <span class="n">lip</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">w</span><span class="p">)</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
    <span class="n">mu</span> <span class="o">=</span> <span class="mi">1</span><span class="o">/</span><span class="p">((</span><span class="mi">1</span><span class="o">+</span><span class="n">tol</span><span class="p">)</span><span class="o">*</span><span class="n">lip</span><span class="p">)</span>
    <span class="nb">print</span> <span class="n">mu</span>
    <span class="n">l</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">mse</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">nb_iter</span><span class="p">,))</span>

    <span class="n">U</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>
    <span class="n">U</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="mi">1</span>
    <span class="n">V</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">U</span><span class="p">)</span>
    <span class="n">V_old</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">V</span><span class="p">)</span>

    <span class="n">t</span><span class="o">=</span><span class="mi">1</span>
    <span class="n">told</span><span class="o">=</span><span class="n">t</span>

    <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_iter</span><span class="p">):</span>
        <span class="n">grad</span> <span class="o">=</span> <span class="n">M</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">U</span><span class="p">)</span><span class="o">-</span><span class="n">B</span>
        <span class="n">mse</span><span class="p">[</span><span class="n">l</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">grad</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="nb">print</span> <span class="n">mse</span><span class="p">[</span><span class="n">l</span><span class="p">]</span>
        <span class="n">V</span> <span class="o">=</span> <span class="n">U</span> <span class="o">-</span> <span class="n">mu</span><span class="o">*</span><span class="n">grad</span>
        <span class="n">V</span> <span class="o">=</span> <span class="n">V</span><span class="o">/</span><span class="n">sqrt</span><span class="p">((</span><span class="n">V</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span>
        <span class="n">t</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">4</span><span class="o">*</span><span class="n">told</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span><span class="o">/</span><span class="mi">2</span>
        <span class="n">lamb</span> <span class="o">=</span> <span class="mi">1</span><span class="o">+</span><span class="p">(</span><span class="n">told</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="n">t</span>
        <span class="n">told</span> <span class="o">=</span> <span class="n">t</span>
        <span class="n">U</span> <span class="o">=</span> <span class="n">V_old</span> <span class="o">+</span> <span class="n">lamb</span><span class="o">*</span><span class="p">(</span><span class="n">V</span><span class="o">-</span><span class="n">V_old</span><span class="p">)</span>
        <span class="n">V_old</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">V</span><span class="p">)</span>
        <span class="n">theta</span> <span class="o">=</span> <span class="n">arccos</span><span class="p">(</span><span class="n">U</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">U</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">):</span>
            <span class="n">theta</span><span class="o">=-</span><span class="n">theta</span>
        <span class="nb">print</span> <span class="s1">&#39;theta = &#39;</span><span class="p">,</span><span class="n">theta</span><span class="o">*</span><span class="mi">180</span><span class="o">/</span><span class="n">pi</span>
        <span class="nb">print</span> <span class="s1">&#39;B = &#39;</span><span class="p">,</span><span class="n">B</span>

    <span class="n">theta</span> <span class="o">=</span> <span class="n">arccos</span><span class="p">(</span><span class="n">U</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">U</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">):</span>
        <span class="n">theta</span><span class="o">=-</span><span class="n">theta</span>

    <span class="n">rot_mat</span> <span class="o">=</span> <span class="n">array</span><span class="p">([[</span><span class="n">cos</span><span class="p">(</span><span class="n">theta</span><span class="p">),</span><span class="o">-</span><span class="n">sin</span><span class="p">(</span><span class="n">theta</span><span class="p">)],[</span><span class="n">sin</span><span class="p">(</span><span class="n">theta</span><span class="p">),</span><span class="n">cos</span><span class="p">(</span><span class="n">theta</span><span class="p">)]])</span>
    <span class="n">rot_map</span> <span class="o">=</span> <span class="mi">0</span><span class="o">*</span><span class="n">map_1</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
            <span class="n">Y</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">map_1</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">Y</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">map_1</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">Yrot</span> <span class="o">=</span> <span class="n">rot_mat</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">Y</span><span class="o">-</span><span class="n">O</span><span class="p">)</span><span class="o">+</span><span class="n">O</span>
            <span class="n">rot_map</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">Yrot</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">rot_map</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">Yrot</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">theta</span><span class="p">,</span><span class="n">rot_map</span>



<span class="c1">#def rotation_registration(im1,im2) # The images are supposed to be centered</span>

<span class="k">def</span> <span class="nf">nuc_norm_thresh</span><span class="p">(</span><span class="n">M</span><span class="p">,</span><span class="n">thresh</span><span class="p">,</span><span class="n">thresh_type</span><span class="p">):</span>

    <span class="n">U</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">Vt</span> <span class="o">=</span> <span class="n">linalg</span><span class="o">.</span><span class="n">svd</span><span class="p">(</span><span class="n">M</span><span class="p">,</span><span class="n">full_matrices</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">sthresh</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">thresholding</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">thresh</span><span class="p">,</span><span class="n">thresh_type</span><span class="p">)</span>
    <span class="n">S</span> <span class="o">=</span> <span class="n">diag</span><span class="p">(</span><span class="n">sthresh</span><span class="p">)</span>
    <span class="n">Mthresh</span> <span class="o">=</span> <span class="n">U</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">S</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">Vt</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">Mthresh</span><span class="p">,</span><span class="n">s</span><span class="p">,</span><span class="n">U</span><span class="p">,</span><span class="n">Vt</span>

<span class="k">def</span> <span class="nf">trunc_svd</span><span class="p">(</span><span class="n">M</span><span class="p">,</span><span class="n">nb_comp</span><span class="p">):</span>
    <span class="n">U</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">Vt</span> <span class="o">=</span> <span class="n">linalg</span><span class="o">.</span><span class="n">svd</span><span class="p">(</span><span class="n">M</span><span class="p">,</span><span class="n">full_matrices</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">s</span><span class="p">[</span><span class="n">nb_comp</span><span class="p">:]</span><span class="o">=</span><span class="mi">0</span>
    <span class="n">S</span> <span class="o">=</span> <span class="n">diag</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
    <span class="n">Mtrunc</span> <span class="o">=</span> <span class="n">U</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">S</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">Vt</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">Mtrunc</span>

<span class="k">def</span> <span class="nf">trunc_svd_cube</span><span class="p">(</span><span class="n">cube</span><span class="p">,</span><span class="n">nb_comp</span><span class="p">):</span>
    <span class="n">shap</span> <span class="o">=</span> <span class="n">cube</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">mat</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
        <span class="n">mat</span><span class="p">[</span><span class="n">k</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">cube</span><span class="p">[:,:,</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">],))</span>
    <span class="n">mat_trunc</span> <span class="o">=</span> <span class="n">trunc_svd</span><span class="p">(</span><span class="n">mat</span><span class="p">,</span><span class="n">nb_comp</span><span class="p">)</span>
    <span class="n">cube_out</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">cube</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
        <span class="n">cube_out</span><span class="p">[:,:,</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">mat_trunc</span><span class="p">[</span><span class="n">k</span><span class="p">,:]</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
    <span class="k">return</span> <span class="n">cube_out</span>

<span class="k">def</span> <span class="nf">svd_cube_compression</span><span class="p">(</span><span class="n">data_cube</span><span class="p">,</span><span class="n">var_percent</span><span class="o">=</span><span class="mf">0.9</span><span class="p">):</span>
    <span class="n">shap</span> <span class="o">=</span> <span class="n">data_cube</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">mat</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">cube_to_mat</span><span class="p">(</span><span class="n">data_cube</span><span class="p">)</span>
    <span class="n">U</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">Vt</span> <span class="o">=</span> <span class="n">linalg</span><span class="o">.</span><span class="n">svd</span><span class="p">(</span><span class="n">mat</span><span class="p">,</span><span class="n">full_matrices</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">e</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    <span class="n">ec</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">rank</span><span class="o">=</span><span class="mi">0</span>
    <span class="k">while</span> <span class="n">ec</span><span class="o">&lt;</span><span class="n">e</span><span class="o">*</span><span class="mf">0.99</span><span class="p">:</span>
        <span class="n">ec</span> <span class="o">+=</span><span class="n">s</span><span class="p">[</span><span class="n">rank</span><span class="p">]</span>
        <span class="n">rank</span><span class="o">+=</span><span class="mi">1</span>
    <span class="n">basis</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">mat_to_cube</span><span class="p">(</span><span class="n">Vt</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">rank</span><span class="p">,:],</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">basis</span><span class="p">,</span><span class="n">rank</span>

<span class="k">def</span> <span class="nf">spca</span><span class="p">(</span><span class="n">M</span><span class="p">,</span><span class="n">shap</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">k</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span><span class="n">nb_iter</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span><span class="n">nb_rw</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">nb_process</span><span class="o">=</span><span class="mi">5</span><span class="p">):</span>

    <span class="n">shap0</span> <span class="o">=</span> <span class="n">M</span><span class="o">.</span><span class="n">shape</span>
    <span class="c1">#U,s,Vt = SLA.svds(M,2*nb_comp_max)</span>
    <span class="n">U</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">Vt</span> <span class="o">=</span> <span class="n">linalg</span><span class="o">.</span><span class="n">svd</span><span class="p">(</span><span class="n">M</span><span class="p">,</span><span class="n">full_matrices</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">sigma</span> <span class="o">=</span> <span class="n">s</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">shap0</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">shap0</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">/</span><span class="mi">2</span><span class="p">)]</span>
    <span class="n">n</span><span class="o">=</span><span class="nb">max</span><span class="p">(</span><span class="n">shap0</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">shap0</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">nu</span> <span class="o">=</span> <span class="n">k</span><span class="o">*</span><span class="n">sigma</span><span class="o">*</span><span class="n">ones</span><span class="p">((</span><span class="nb">min</span><span class="p">(</span><span class="n">shap0</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">shap0</span><span class="p">[</span><span class="mi">1</span><span class="p">]),))</span> <span class="c1">#sqrt(2*n)*sigma*ones((nb_comp_max,))</span>
    <span class="n">to</span> <span class="o">=</span> <span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">sigma</span><span class="o">*</span><span class="n">ones</span><span class="p">((</span><span class="n">shap0</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">shap0</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
    <span class="n">Md</span> <span class="o">=</span> <span class="mi">0</span><span class="o">*</span><span class="n">M</span>
    <span class="n">O</span> <span class="o">=</span> <span class="mi">0</span><span class="o">*</span><span class="n">M</span>
    <span class="n">gradk</span> <span class="o">=</span> <span class="mi">0</span><span class="o">*</span><span class="n">O</span>
    <span class="n">lambd</span> <span class="o">=</span> <span class="mf">1.5</span>
    <span class="n">mu</span><span class="o">=</span><span class="mi">1</span>
    <span class="n">i</span><span class="o">=</span><span class="mi">0</span>
    <span class="n">thresh_type</span><span class="o">=</span><span class="mi">1</span>
    <span class="n">mse</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">nb_iter</span><span class="p">,))</span>
    <span class="n">l</span><span class="o">=</span><span class="mi">0</span>

    <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_rw</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_iter</span><span class="p">):</span>
            <span class="n">gradk</span> <span class="o">=</span> <span class="n">Md</span><span class="o">+</span><span class="n">O</span> <span class="o">-</span> <span class="n">M</span>
            <span class="n">mse</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">gradk</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
            <span class="nb">print</span> <span class="s1">&#39;mse[i]: &#39;</span><span class="p">,</span><span class="n">mse</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">temp</span> <span class="o">=</span> <span class="n">Md</span><span class="o">-</span><span class="n">mu</span><span class="o">*</span><span class="n">gradk</span>
            <span class="n">temp1m</span> <span class="o">=</span> <span class="n">Md</span><span class="o">-</span><span class="n">mu</span><span class="o">*</span><span class="n">gradk</span>
            <span class="n">temp1o</span> <span class="o">=</span> <span class="n">O</span><span class="o">-</span><span class="n">mu</span><span class="o">*</span><span class="n">gradk</span>
            <span class="n">Md</span><span class="p">,</span><span class="n">si</span><span class="p">,</span><span class="n">U</span><span class="p">,</span><span class="n">Vt</span> <span class="o">=</span> <span class="n">nuc_norm_thresh</span><span class="p">(</span><span class="n">temp1m</span><span class="p">,</span><span class="n">nu</span><span class="p">,</span><span class="n">thresh_type</span><span class="p">)</span>
            <span class="n">O</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">thresholding</span><span class="p">(</span><span class="n">temp1o</span><span class="p">,</span><span class="n">to</span><span class="p">,</span><span class="n">thresh_type</span><span class="p">)</span>
        <span class="n">U</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">Vt</span> <span class="o">=</span> <span class="n">linalg</span><span class="o">.</span><span class="n">svd</span><span class="p">(</span><span class="n">Md</span><span class="p">,</span><span class="n">full_matrices</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">nu</span> <span class="o">=</span> <span class="n">nu</span><span class="o">/</span><span class="p">((</span><span class="n">s</span><span class="o">/</span><span class="p">(</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">sigma</span><span class="p">))</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">Md</span><span class="p">,</span><span class="n">O</span><span class="p">,</span><span class="n">gradk</span><span class="p">,</span><span class="n">sigma</span>

<span class="k">def</span> <span class="nf">positive_spca</span><span class="p">(</span><span class="n">M</span><span class="p">,</span><span class="n">shap</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">k</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span><span class="n">nb_iter</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span><span class="n">nb_rw</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">nb_process</span><span class="o">=</span><span class="mi">5</span><span class="p">):</span>
    <span class="n">shap0</span> <span class="o">=</span> <span class="n">M</span><span class="o">.</span><span class="n">shape</span>
    <span class="c1">#U,s,Vt = SLA.svds(M,2*nb_comp_max)</span>
    <span class="n">U</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">Vt</span> <span class="o">=</span> <span class="n">linalg</span><span class="o">.</span><span class="n">svd</span><span class="p">(</span><span class="n">M</span><span class="p">,</span><span class="n">full_matrices</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">sigma</span> <span class="o">=</span> <span class="n">s</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">shap0</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">shap0</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">/</span><span class="mi">2</span><span class="p">)]</span>
    <span class="n">n</span><span class="o">=</span><span class="nb">max</span><span class="p">(</span><span class="n">shap0</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">shap0</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">nu</span> <span class="o">=</span> <span class="n">k</span><span class="o">*</span><span class="n">sigma</span><span class="o">*</span><span class="n">ones</span><span class="p">((</span><span class="nb">min</span><span class="p">(</span><span class="n">shap0</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">shap0</span><span class="p">[</span><span class="mi">1</span><span class="p">]),))</span> <span class="c1">#sqrt(2*n)*sigma*ones((nb_comp_max,))</span>
    <span class="n">to</span> <span class="o">=</span> <span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">sigma</span><span class="o">*</span><span class="n">ones</span><span class="p">((</span><span class="n">shap0</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">shap0</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
    <span class="n">Md</span> <span class="o">=</span> <span class="mi">0</span><span class="o">*</span><span class="n">M</span>
    <span class="n">z1m</span> <span class="o">=</span> <span class="mi">0</span><span class="o">*</span><span class="n">M</span>
    <span class="n">z2m</span> <span class="o">=</span> <span class="mi">0</span><span class="o">*</span><span class="n">M</span>
    <span class="n">O</span> <span class="o">=</span> <span class="mi">0</span><span class="o">*</span><span class="n">M</span>
    <span class="n">z1o</span> <span class="o">=</span> <span class="mi">0</span><span class="o">*</span><span class="n">M</span>
    <span class="n">z2o</span> <span class="o">=</span> <span class="mi">0</span><span class="o">*</span><span class="n">M</span>
    <span class="n">gradk</span> <span class="o">=</span> <span class="mi">0</span><span class="o">*</span><span class="n">O</span>
    <span class="n">lambd</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">mu</span><span class="o">=</span><span class="mf">0.9</span>
    <span class="n">i</span><span class="o">=</span><span class="mi">0</span>
    <span class="n">w1</span><span class="o">=</span><span class="mf">0.7</span>
    <span class="n">w2</span> <span class="o">=</span> <span class="mi">1</span><span class="o">-</span><span class="n">w1</span>
    <span class="n">thresh_type</span><span class="o">=</span><span class="mi">1</span>
    <span class="n">mse</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">nb_iter</span><span class="p">,))</span>
    <span class="n">l</span><span class="o">=</span><span class="mi">0</span>
    <span class="n">pool</span> <span class="o">=</span> <span class="n">Pool</span><span class="p">(</span><span class="n">processes</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_rw</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_iter</span><span class="p">):</span>
            <span class="n">gradk</span> <span class="o">=</span> <span class="n">Md</span><span class="o">+</span><span class="n">O</span> <span class="o">-</span> <span class="n">M</span>
            <span class="n">mse</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">gradk</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
            <span class="nb">print</span> <span class="n">mse</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">args1</span> <span class="o">=</span> <span class="p">[</span><span class="n">Md</span><span class="p">,</span><span class="n">z1m</span><span class="p">,</span><span class="n">gradk</span><span class="p">,</span><span class="n">mu</span><span class="p">,</span><span class="n">nu</span><span class="p">,</span><span class="n">thresh_type</span><span class="p">,</span><span class="n">lambd</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">args2</span> <span class="o">=</span> <span class="p">[</span><span class="n">O</span><span class="p">,</span><span class="n">z1o</span><span class="p">,</span><span class="n">gradk</span><span class="p">,</span><span class="n">mu</span><span class="p">,</span><span class="n">to</span><span class="p">,</span><span class="n">thresh_type</span><span class="p">,</span><span class="n">lambd</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span>
            <span class="n">args3</span> <span class="o">=</span> <span class="p">[</span><span class="n">Md</span><span class="p">,</span><span class="n">z2m</span><span class="p">,</span><span class="n">gradk</span><span class="p">,</span><span class="n">mu</span><span class="p">,</span><span class="n">lambd</span><span class="p">,</span><span class="mi">3</span><span class="p">]</span>
            <span class="n">args4</span> <span class="o">=</span> <span class="p">[</span><span class="n">O</span><span class="p">,</span><span class="n">z2o</span><span class="p">,</span><span class="n">gradk</span><span class="p">,</span><span class="n">mu</span><span class="p">,</span><span class="n">lambd</span><span class="p">,</span><span class="mi">4</span><span class="p">]</span>
            <span class="n">res</span> <span class="o">=</span> <span class="n">pool</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">mp_positive_spca_aux</span><span class="p">,</span> <span class="p">[</span><span class="n">args2</span><span class="p">,</span><span class="n">args3</span><span class="p">,</span><span class="n">args4</span><span class="p">])</span>

            <span class="c1">#z1m  = res[0]</span>
            <span class="n">z1m</span> <span class="o">=</span> <span class="n">mp_positive_spca_aux</span><span class="p">(</span><span class="n">args1</span><span class="p">)</span>
            <span class="n">z1o</span> <span class="o">=</span> <span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">z2m</span> <span class="o">=</span> <span class="n">res</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">z2o</span> <span class="o">=</span> <span class="n">res</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
            <span class="c1">#print (z1m**2).sum()</span>
            <span class="c1">#    q = Queue()</span>
            <span class="c1">#    jobs = []</span>
            <span class="c1">#    for i in range(0,nb_proc):</span>
            <span class="c1">#        ib = i*slice</span>
            <span class="c1">#        ie = ib+slice-1</span>
            <span class="c1">#        p = Process(target=utils.mp_rot_registration_cube, args=(gal_test,ib,ie,q))</span>
            <span class="c1">#        p.start()</span>
            <span class="c1">#        jobs.append(p)</span>
            <span class="c1">#    for i in range(0,nb_proc):</span>
            <span class="c1">#        a = q.get()</span>


            <span class="sd">&quot;&quot;&quot;temp1m = 2*Md-z1m-mu*gradk</span>
<span class="sd">                temp1m,si,U,Vt = nuc_norm_thresh(temp1m,nu,thresh_type)</span>
<span class="sd">                z1m = z1m + lambd*(temp1m-Md)</span>

<span class="sd">                temp1o = 2*O-z1o-mu*gradk</span>
<span class="sd">                temp1o = utils.thresholding(temp1o,to,thresh_type)</span>
<span class="sd">                z1o = z1o + lambd*(temp1o-O)</span>

<span class="sd">                temp2m = 2*Md-z2m-mu*gradk</span>
<span class="sd">                temp2m = pos_proj_mat(temp2m)</span>
<span class="sd">                z2m = z2m + lambd*(temp2m-Md)</span>

<span class="sd">                z2o = z2o + lambd*(O-z2o-mu*gradk)&quot;&quot;&quot;</span>
            <span class="n">Md</span> <span class="o">=</span> <span class="n">w1</span><span class="o">*</span><span class="n">z1m</span><span class="o">+</span><span class="n">w2</span><span class="o">*</span><span class="n">z2m</span>
            <span class="n">O</span> <span class="o">=</span> <span class="n">w1</span><span class="o">*</span><span class="n">z1o</span><span class="o">+</span><span class="n">w2</span><span class="o">*</span><span class="n">z2o</span>
        <span class="n">U</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">Vt</span> <span class="o">=</span> <span class="n">linalg</span><span class="o">.</span><span class="n">svd</span><span class="p">(</span><span class="n">Md</span><span class="p">,</span><span class="n">full_matrices</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">nu</span> <span class="o">=</span> <span class="n">nu</span><span class="o">/</span><span class="p">((</span><span class="n">s</span><span class="o">/</span><span class="p">(</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">sigma</span><span class="p">))</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">Md</span><span class="p">,</span><span class="n">O</span><span class="p">,</span><span class="n">gradk</span><span class="p">,</span><span class="n">sigma</span>

<span class="k">def</span> <span class="nf">mp_positive_spca_aux</span><span class="p">(</span><span class="n">args</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">args</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">mp_nuc_norm_aux</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">args</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">==</span><span class="mi">2</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">mp_thresh_aux</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">args</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">==</span><span class="mi">3</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">mp_pos_aux</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">args</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">==</span><span class="mi">4</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">mp_id_aux</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">mp_nuc_norm_aux</span><span class="p">(</span><span class="n">args</span><span class="p">):</span>

    <span class="n">x</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">z</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">grad</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">mu</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
    <span class="n">nu</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>
    <span class="n">thresh_type</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span>
    <span class="n">lambd</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span>
    <span class="n">tempx</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">x</span><span class="o">-</span><span class="n">z</span><span class="o">-</span><span class="n">mu</span><span class="o">*</span><span class="n">grad</span>
    <span class="n">tempx</span><span class="p">,</span><span class="n">s</span><span class="p">,</span><span class="n">U</span><span class="p">,</span><span class="n">Vt</span> <span class="o">=</span> <span class="n">nuc_norm_thresh</span><span class="p">(</span><span class="n">tempx</span><span class="p">,</span><span class="n">nu</span><span class="p">,</span><span class="n">thresh_type</span><span class="p">)</span>
    <span class="n">z</span> <span class="o">=</span> <span class="n">z</span> <span class="o">+</span> <span class="n">lambd</span><span class="o">*</span><span class="p">(</span><span class="n">tempx</span><span class="o">-</span><span class="n">x</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">z</span>



<span class="k">def</span> <span class="nf">mp_thresh_aux</span><span class="p">(</span><span class="n">args</span><span class="p">):</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">z</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">grad</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">mu</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
    <span class="n">to</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>
    <span class="n">thresh_type</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span>
    <span class="n">lambd</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span>
    <span class="n">tempx</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">x</span><span class="o">-</span><span class="n">z</span><span class="o">-</span><span class="n">mu</span><span class="o">*</span><span class="n">grad</span>
    <span class="n">tempx</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">thresholding</span><span class="p">(</span><span class="n">tempx</span><span class="p">,</span><span class="n">to</span><span class="p">,</span><span class="n">thresh_type</span><span class="p">)</span>
    <span class="n">z</span> <span class="o">=</span> <span class="n">z</span> <span class="o">+</span> <span class="n">lambd</span><span class="o">*</span><span class="p">(</span><span class="n">tempx</span><span class="o">-</span><span class="n">x</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">z</span>

<span class="k">def</span> <span class="nf">mp_pos_aux</span><span class="p">(</span><span class="n">args</span><span class="p">):</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">z</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">grad</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">mu</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
    <span class="n">lambd</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>
    <span class="n">tempx</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">x</span><span class="o">-</span><span class="n">z</span><span class="o">-</span><span class="n">mu</span><span class="o">*</span><span class="n">grad</span>
    <span class="n">tempx</span> <span class="o">=</span> <span class="n">pos_proj_mat</span><span class="p">(</span><span class="n">tempx</span><span class="p">)</span>
    <span class="n">z</span> <span class="o">=</span> <span class="n">z</span> <span class="o">+</span> <span class="n">lambd</span><span class="o">*</span><span class="p">(</span><span class="n">tempx</span><span class="o">-</span><span class="n">x</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">z</span>

<span class="k">def</span> <span class="nf">mp_id_aux</span><span class="p">(</span><span class="n">args</span><span class="p">):</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">z</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">grad</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">mu</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
    <span class="n">lambd</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>
    <span class="n">z</span> <span class="o">=</span> <span class="n">z</span> <span class="o">+</span> <span class="n">lambd</span><span class="o">*</span><span class="p">(</span><span class="n">x</span><span class="o">-</span><span class="n">z</span><span class="o">-</span><span class="n">mu</span><span class="o">*</span><span class="n">grad</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">z</span>

<span class="k">def</span> <span class="nf">positive_spca_2</span><span class="p">(</span><span class="n">M</span><span class="p">,</span><span class="n">nb_comp_max</span><span class="p">,</span><span class="n">shap</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">k</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span><span class="n">nb_iter</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span><span class="n">nb_iter_2</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span><span class="n">nb_rw</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span><span class="n">nb_process</span><span class="o">=</span><span class="mi">5</span><span class="p">):</span>

    <span class="n">shap0</span> <span class="o">=</span> <span class="n">M</span><span class="o">.</span><span class="n">shape</span>
    <span class="c1">#U,s,Vt = SLA.svds(M,2*nb_comp_max)</span>
    <span class="n">U</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">Vt</span> <span class="o">=</span> <span class="n">linalg</span><span class="o">.</span><span class="n">svd</span><span class="p">(</span><span class="n">M</span><span class="p">,</span><span class="n">full_matrices</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">sigma</span> <span class="o">=</span> <span class="n">s</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">shap0</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">shap0</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">/</span><span class="mi">2</span><span class="p">)]</span>
    <span class="n">n</span><span class="o">=</span><span class="nb">max</span><span class="p">(</span><span class="n">shap0</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">shap0</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">nu</span> <span class="o">=</span> <span class="n">k</span><span class="o">*</span><span class="n">sigma</span><span class="o">*</span><span class="n">ones</span><span class="p">((</span><span class="nb">min</span><span class="p">(</span><span class="n">shap0</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">shap0</span><span class="p">[</span><span class="mi">1</span><span class="p">]),))</span> <span class="c1">#sqrt(2*n)*sigma*ones((nb_comp_max,))</span>
    <span class="n">to</span> <span class="o">=</span> <span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">sigma</span><span class="o">*</span><span class="n">ones</span><span class="p">((</span><span class="n">shap0</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">shap0</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
    <span class="n">w1</span><span class="o">=</span><span class="mf">0.66666666666666666</span>
    <span class="n">w2</span> <span class="o">=</span> <span class="mi">1</span><span class="o">-</span><span class="n">w1</span>

    <span class="n">Md</span> <span class="o">=</span> <span class="mi">0</span><span class="o">*</span><span class="n">M</span>
    <span class="n">O</span> <span class="o">=</span> <span class="mi">0</span><span class="o">*</span><span class="n">M</span>
    <span class="n">z1m</span> <span class="o">=</span> <span class="mi">0</span><span class="o">*</span><span class="n">Md</span>
    <span class="n">z1O</span> <span class="o">=</span> <span class="mi">0</span><span class="o">*</span><span class="n">Md</span>
    <span class="n">z1fs</span> <span class="o">=</span> <span class="mi">0</span><span class="o">*</span><span class="n">Md</span>
    <span class="n">z2m</span> <span class="o">=</span> <span class="mi">0</span><span class="o">*</span><span class="n">Md</span>
    <span class="n">z2O</span> <span class="o">=</span> <span class="mi">0</span><span class="o">*</span><span class="n">Md</span>
    <span class="n">z2fs</span> <span class="o">=</span> <span class="mi">0</span><span class="o">*</span><span class="n">Md</span>
    <span class="n">xm</span> <span class="o">=</span> <span class="mi">0</span><span class="o">*</span><span class="n">Md</span>
    <span class="n">xO</span> <span class="o">=</span> <span class="mi">0</span><span class="o">*</span><span class="n">Md</span>
    <span class="n">xfs</span> <span class="o">=</span> <span class="mi">0</span><span class="o">*</span><span class="n">Md</span>
    <span class="n">gradk</span> <span class="o">=</span> <span class="mi">0</span><span class="o">*</span><span class="n">O</span>
    <span class="n">lambd</span> <span class="o">=</span> <span class="mf">1.5</span>
    <span class="n">mu</span><span class="o">=</span><span class="mf">0.5</span>
    <span class="n">i</span><span class="o">=</span><span class="mi">0</span>
    <span class="n">thresh_type</span><span class="o">=</span><span class="mi">1</span>
    <span class="n">mse</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">nb_iter_2</span><span class="p">,))</span>
    <span class="c1">#mse = zeros((100,))</span>
    <span class="n">l</span><span class="o">=</span><span class="mi">0</span>
    <span class="n">faint_struct_supp</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">faint_struct</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">shap</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">faint_struct_supp</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>
        <span class="n">faint_struct</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>

    <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_rw</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_iter</span><span class="p">):</span>
            <span class="n">gradk</span> <span class="o">=</span> <span class="n">Md</span><span class="o">+</span><span class="n">O</span> <span class="o">-</span> <span class="n">M</span>
            <span class="n">mse</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">gradk</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
            <span class="nb">print</span> <span class="n">mse</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">temp1m</span> <span class="o">=</span> <span class="n">Md</span><span class="o">-</span><span class="n">mu</span><span class="o">*</span><span class="n">gradk</span>
            <span class="n">temp1o</span> <span class="o">=</span> <span class="n">O</span><span class="o">-</span><span class="n">mu</span><span class="o">*</span><span class="n">gradk</span>
            <span class="n">Md</span><span class="p">,</span><span class="n">si</span><span class="p">,</span><span class="n">U</span><span class="p">,</span><span class="n">Vt</span> <span class="o">=</span> <span class="n">nuc_norm_thresh</span><span class="p">(</span><span class="n">temp1m</span><span class="p">,</span><span class="n">nu</span><span class="p">,</span><span class="n">thresh_type</span><span class="p">)</span>
            <span class="n">O</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">thresholding</span><span class="p">(</span><span class="n">temp1o</span><span class="p">,</span><span class="n">to</span><span class="p">,</span><span class="n">thresh_type</span><span class="p">)</span>
        <span class="n">U</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">Vt</span> <span class="o">=</span> <span class="n">linalg</span><span class="o">.</span><span class="n">svd</span><span class="p">(</span><span class="n">Md</span><span class="p">,</span><span class="n">full_matrices</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">nu</span> <span class="o">=</span> <span class="n">nu</span><span class="o">/</span><span class="p">((</span><span class="n">s</span><span class="o">/</span><span class="p">(</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">sigma</span><span class="p">))</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">xm</span><span class="p">,</span><span class="n">xO</span> <span class="o">=</span> <span class="n">Md</span><span class="p">,</span><span class="n">O</span>

    <span class="n">res</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">mat_to_cube</span><span class="p">(</span><span class="n">gradk</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">faint_struct_supp</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">mp_struct_res_support</span><span class="p">(</span><span class="n">res</span><span class="p">,</span><span class="n">nb_process</span><span class="p">,</span><span class="n">thresh</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span><span class="n">wind</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
    <span class="n">supp</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">cube_to_mat</span><span class="p">(</span><span class="n">faint_struct_supp</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_iter_2</span><span class="p">):</span>
        <span class="c1">#for i in range(0,100):</span>
        <span class="n">temp1m</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">xm</span> <span class="o">-</span> <span class="n">z1m</span> <span class="o">-</span> <span class="n">mu</span><span class="o">*</span><span class="p">(</span><span class="n">xm</span><span class="o">+</span><span class="n">xO</span><span class="o">+</span><span class="n">supp</span><span class="o">*</span><span class="n">xfs</span><span class="o">-</span><span class="n">M</span><span class="p">)</span>
        <span class="n">proj_temp1m</span><span class="p">,</span><span class="n">si</span><span class="p">,</span><span class="n">U</span><span class="p">,</span><span class="n">Vt</span> <span class="o">=</span> <span class="n">nuc_norm_thresh</span><span class="p">(</span><span class="n">temp1m</span><span class="p">,</span><span class="n">nu</span><span class="p">,</span><span class="n">thresh_type</span><span class="p">)</span>
        <span class="n">z1m</span> <span class="o">=</span> <span class="n">z1m</span> <span class="o">+</span> <span class="n">lambd</span><span class="o">*</span><span class="p">(</span><span class="n">proj_temp1m</span><span class="o">-</span><span class="n">xm</span><span class="p">)</span>

        <span class="n">temp1O</span>  <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">xO</span> <span class="o">-</span> <span class="n">z1O</span> <span class="o">-</span> <span class="n">mu</span><span class="o">*</span><span class="p">(</span><span class="n">xm</span><span class="o">+</span><span class="n">xO</span><span class="o">+</span><span class="n">supp</span><span class="o">*</span><span class="n">xfs</span><span class="o">-</span><span class="n">M</span><span class="p">)</span>
        <span class="n">proj_temp1O</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">thresholding</span><span class="p">(</span><span class="n">temp1O</span><span class="p">,</span><span class="n">to</span><span class="p">,</span><span class="n">thresh_type</span><span class="p">)</span>
        <span class="n">z1O</span> <span class="o">=</span> <span class="n">z1O</span> <span class="o">+</span> <span class="n">lambd</span><span class="o">*</span><span class="p">(</span><span class="n">proj_temp1O</span><span class="o">-</span><span class="n">xO</span><span class="p">)</span>

        <span class="n">temp1fs</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">xfs</span> <span class="o">-</span> <span class="n">z1fs</span> <span class="o">-</span> <span class="n">mu</span><span class="o">*</span><span class="n">supp</span><span class="o">*</span><span class="p">(</span><span class="n">xm</span><span class="o">+</span><span class="n">xO</span><span class="o">+</span><span class="n">supp</span><span class="o">*</span><span class="n">xfs</span><span class="o">-</span><span class="n">M</span><span class="p">)</span>
        <span class="n">z1fs</span> <span class="o">=</span> <span class="n">z1fs</span> <span class="o">+</span> <span class="n">lambd</span><span class="o">*</span><span class="p">(</span><span class="n">temp1fs</span><span class="o">-</span><span class="n">xfs</span><span class="p">)</span>
        <span class="n">temp2m</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">xm</span> <span class="o">-</span> <span class="n">z2m</span> <span class="o">-</span> <span class="n">mu</span><span class="o">*</span><span class="p">(</span><span class="n">xm</span><span class="o">+</span><span class="n">xO</span><span class="o">+</span><span class="n">supp</span><span class="o">*</span><span class="n">xfs</span><span class="o">-</span><span class="n">M</span><span class="p">)</span>

        <span class="n">temp2fs</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">xfs</span> <span class="o">-</span> <span class="n">z2fs</span> <span class="o">-</span> <span class="n">mu</span><span class="o">*</span><span class="n">supp</span><span class="o">*</span><span class="p">(</span><span class="n">xm</span><span class="o">+</span><span class="n">xO</span><span class="o">+</span><span class="n">supp</span><span class="o">*</span><span class="n">xfs</span><span class="o">-</span><span class="n">M</span><span class="p">)</span>
        <span class="n">proj_temp2m</span><span class="p">,</span><span class="n">proj_temp2fs</span> <span class="o">=</span> <span class="n">pos_proj_mat_2</span><span class="p">(</span><span class="n">temp2m</span><span class="p">,</span><span class="n">temp2fs</span><span class="p">)</span>
        <span class="n">temp2O</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">xO</span> <span class="o">-</span> <span class="n">z2O</span> <span class="o">-</span> <span class="n">mu</span><span class="o">*</span><span class="p">(</span><span class="n">xm</span><span class="o">+</span><span class="n">xO</span><span class="o">+</span><span class="n">supp</span><span class="o">*</span><span class="n">xfs</span><span class="o">-</span><span class="n">M</span><span class="p">)</span>

        <span class="n">z2O</span> <span class="o">=</span> <span class="n">z2O</span> <span class="o">+</span> <span class="n">lambd</span><span class="o">*</span><span class="p">(</span><span class="n">temp2O</span><span class="o">-</span><span class="n">xO</span><span class="p">)</span>
        <span class="n">xm</span> <span class="o">=</span> <span class="n">w1</span><span class="o">*</span><span class="n">z1m</span><span class="o">+</span><span class="n">w2</span><span class="o">*</span><span class="n">z2m</span>
        <span class="n">xO</span> <span class="o">=</span> <span class="n">w1</span><span class="o">*</span><span class="n">z1O</span><span class="o">+</span><span class="n">w2</span><span class="o">*</span><span class="n">z2O</span>
        <span class="n">xfs</span> <span class="o">=</span> <span class="n">w1</span><span class="o">*</span><span class="n">z1fs</span><span class="o">+</span><span class="n">w2</span><span class="o">*</span><span class="n">z2fs</span>
        <span class="n">gradk</span> <span class="o">=</span> <span class="n">xm</span><span class="o">+</span><span class="n">xO</span><span class="o">+</span><span class="n">supp</span><span class="o">*</span><span class="n">xfs</span><span class="o">-</span><span class="n">M</span>
        <span class="n">mse</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">gradk</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="nb">print</span> <span class="n">mse</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
    <span class="n">Md</span> <span class="o">=</span> <span class="n">xm</span>
    <span class="n">O</span> <span class="o">=</span><span class="n">xO</span>
    <span class="n">faint_struct</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">mat_to_cube</span><span class="p">(</span><span class="n">xfs</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

    <span class="k">return</span> <span class="n">Md</span><span class="p">,</span><span class="n">O</span><span class="p">,</span><span class="n">gradk</span><span class="p">,</span><span class="n">sigma</span><span class="p">,</span><span class="n">faint_struct</span><span class="p">,</span><span class="n">faint_struct_supp</span>


<span class="k">def</span> <span class="nf">spca_interf</span><span class="p">(</span><span class="n">cube</span><span class="p">,</span><span class="n">k</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span><span class="n">nb_iter</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span><span class="n">nb_iter_2</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span><span class="n">nb_rw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span><span class="n">nb_process</span><span class="o">=</span><span class="mi">5</span><span class="p">):</span>
    <span class="n">siz</span> <span class="o">=</span> <span class="n">cube</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">M</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">cube_to_mat</span><span class="p">(</span><span class="n">cube</span><span class="p">)</span>
    <span class="n">Md</span><span class="p">,</span><span class="n">O</span><span class="p">,</span><span class="n">gradk</span><span class="p">,</span><span class="n">sigma</span> <span class="o">=</span> <span class="n">positive_spca</span><span class="p">(</span><span class="n">M</span><span class="p">,</span><span class="n">shap</span><span class="o">=</span><span class="n">siz</span><span class="p">,</span><span class="n">k</span><span class="o">=</span><span class="n">k</span><span class="p">,</span><span class="n">nb_iter</span><span class="o">=</span><span class="n">nb_iter</span><span class="p">,</span><span class="n">nb_rw</span><span class="o">=</span><span class="n">nb_rw</span><span class="p">,</span><span class="n">nb_process</span><span class="o">=</span><span class="n">nb_process</span><span class="p">)</span> <span class="c1">#positive_spca_2(M,nb_comp_max,shap=siz,k=k,nb_iter=nb_iter,nb_iter_2=100,nb_rw=nb_rw,nb_process=nb_process)</span>
    <span class="n">cube_den</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">mat_to_cube</span><span class="p">(</span><span class="n">Md</span><span class="p">,</span><span class="n">siz</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">siz</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">Om</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">mat_to_cube</span><span class="p">(</span><span class="n">O</span><span class="p">,</span><span class="n">siz</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">siz</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">mat_to_cube</span><span class="p">(</span><span class="n">gradk</span><span class="p">,</span><span class="n">siz</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">siz</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">cube_den</span><span class="p">,</span><span class="n">Om</span><span class="p">,</span><span class="n">res</span>

<span class="k">def</span> <span class="nf">lanczos_gridding</span><span class="p">(</span><span class="n">samples_coord</span><span class="p">,</span><span class="n">samples_val</span><span class="p">,</span><span class="n">target_siz</span><span class="p">,</span><span class="n">lanczos_rad</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span><span class="n">nb_iter</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span><span class="n">step_size</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">im_init</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>

    <span class="n">mat</span><span class="p">,</span><span class="n">supp_cols</span><span class="p">,</span><span class="n">supp_lines</span><span class="p">,</span><span class="n">lip</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">space_var_conv_mat_feat</span><span class="p">(</span><span class="n">target_siz</span><span class="p">,</span><span class="n">samples_coord</span><span class="p">,</span><span class="n">lanczos_rad</span><span class="o">=</span><span class="n">lanczos_rad</span><span class="p">)</span>
    <span class="n">U</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">(</span><span class="n">target_siz</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">target_siz</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="k">if</span> <span class="n">im_init</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">U</span> <span class="o">=</span> <span class="n">im_init</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">target_siz</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">target_siz</span><span class="p">[</span><span class="mi">1</span><span class="p">],))</span>
    <span class="n">V</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">U</span><span class="p">)</span>
    <span class="n">V_old</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">V</span><span class="p">)</span>

    <span class="n">t</span><span class="o">=</span><span class="mi">1</span>
    <span class="n">told</span><span class="o">=</span><span class="n">t</span>
    <span class="n">l</span><span class="o">=</span><span class="mi">0</span>
    <span class="n">mse</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">nb_iter</span><span class="p">,))</span>
    <span class="c1">#print &#39;lip cons = &#39;,lip**2</span>
    <span class="n">U0</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">Vt</span> <span class="o">=</span> <span class="n">linalg</span><span class="o">.</span><span class="n">svd</span><span class="p">(</span><span class="n">transpose</span><span class="p">(</span><span class="n">mat</span><span class="p">)</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">mat</span><span class="p">),</span><span class="n">full_matrices</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">lip</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
    <span class="nb">print</span> <span class="s1">&#39;Conditioning number: &#39;</span><span class="p">,</span><span class="nb">abs</span><span class="p">(</span><span class="n">s</span><span class="p">)</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">/</span><span class="nb">abs</span><span class="p">(</span><span class="n">s</span><span class="p">)</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_iter</span><span class="p">):</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">samples_val</span><span class="o">-</span><span class="n">utils</span><span class="o">.</span><span class="n">space_var_conv_mat</span><span class="p">(</span><span class="n">mat</span><span class="p">,</span><span class="n">U</span><span class="p">,</span><span class="n">supp_lines</span><span class="p">)</span>
        <span class="n">mse</span><span class="p">[</span><span class="n">l</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">res</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="nb">print</span> <span class="s1">&#39;iter &#39;</span><span class="p">,</span><span class="n">l</span><span class="p">,</span><span class="s1">&#39;/&#39;</span><span class="p">,</span><span class="n">nb_iter</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="s1">&#39; mse = &#39;</span><span class="p">,</span><span class="n">mse</span><span class="p">[</span><span class="n">l</span><span class="p">]</span>
        <span class="n">grad</span> <span class="o">=</span> <span class="o">-</span><span class="n">utils</span><span class="o">.</span><span class="n">space_var_conv_transpose_mat</span><span class="p">(</span><span class="n">mat</span><span class="p">,</span><span class="n">res</span><span class="p">,</span><span class="n">supp_cols</span><span class="p">)</span>
        <span class="n">V</span> <span class="o">=</span> <span class="n">U</span> <span class="o">-</span> <span class="p">(</span><span class="n">step_size</span><span class="o">/</span><span class="n">lip</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">grad</span>
        <span class="n">t</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">4</span><span class="o">*</span><span class="n">told</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span><span class="o">/</span><span class="mi">2</span>
        <span class="n">lamb</span> <span class="o">=</span> <span class="mi">1</span><span class="o">+</span><span class="p">(</span><span class="n">told</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="n">t</span>
        <span class="n">told</span> <span class="o">=</span> <span class="n">t</span>
        <span class="n">U</span> <span class="o">=</span> <span class="n">V_old</span> <span class="o">+</span> <span class="n">lamb</span><span class="o">*</span><span class="p">(</span><span class="n">V</span><span class="o">-</span><span class="n">V_old</span><span class="p">)</span>
        <span class="n">V_old</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">V</span><span class="p">)</span>
    <span class="n">output</span> <span class="o">=</span> <span class="n">U</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">target_siz</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">target_siz</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
    <span class="k">return</span> <span class="n">output</span><span class="p">,</span><span class="n">mse</span><span class="p">,</span><span class="n">supp_cols</span><span class="p">,</span><span class="n">supp_lines</span><span class="p">,</span><span class="n">mat</span>


<span class="k">def</span> <span class="nf">certify_adjoint</span><span class="p">(</span><span class="n">func</span><span class="p">,</span><span class="n">func_adj</span><span class="p">,</span><span class="n">siz_input</span><span class="p">,</span><span class="n">siz_output</span><span class="p">):</span>
    <span class="n">rand1</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="n">siz_input</span><span class="p">)</span>
    <span class="n">rand2</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="n">siz_output</span><span class="p">)</span>
    <span class="n">out1</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="n">funct</span><span class="p">,[</span><span class="n">rand1</span><span class="p">])</span>
    <span class="n">out2</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="n">funct_adj</span><span class="p">,[</span><span class="n">rand2</span><span class="p">])</span>
    <span class="n">scl1</span> <span class="o">=</span> <span class="p">(</span><span class="n">rand1</span><span class="o">*</span><span class="n">out2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    <span class="n">scl2</span> <span class="o">=</span> <span class="p">(</span><span class="n">rand2</span><span class="o">*</span><span class="n">out1</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    <span class="n">scl3</span> <span class="o">=</span> <span class="n">sqrt</span><span class="p">(((</span><span class="n">rand1</span><span class="o">*</span><span class="n">out2</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span>
    <span class="n">err</span> <span class="o">=</span> <span class="p">(</span><span class="n">scl1</span><span class="o">-</span><span class="n">scl2</span><span class="p">)</span><span class="o">/</span><span class="n">scl3</span>
    <span class="nb">print</span> <span class="s1">&#39;Adjoint accuracy: &#39;</span><span class="p">,</span><span class="n">err</span>


<span class="k">def</span> <span class="nf">deconvol</span><span class="p">(</span><span class="n">y</span><span class="p">,</span><span class="n">h</span><span class="p">,</span><span class="n">mu</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">nb_iter</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span><span class="n">tol</span><span class="o">=</span><span class="mf">0.001</span><span class="p">):</span>
    <span class="n">i</span><span class="o">=</span><span class="mi">0</span>
    <span class="n">lip</span> <span class="o">=</span> <span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">h</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span><span class="o">**</span><span class="mi">2</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
    <span class="n">v</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
    <span class="n">mse</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">nb_iter</span><span class="p">,))</span>
    <span class="n">h_adj</span> <span class="o">=</span> <span class="n">rot90</span><span class="p">(</span><span class="n">h</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">t</span><span class="o">=</span><span class="mi">1</span>
    <span class="n">told</span><span class="o">=</span><span class="n">t</span>
    <span class="n">i</span><span class="o">=</span><span class="mi">0</span>
    <span class="n">err</span> <span class="o">=</span> <span class="mf">1.0</span>
    <span class="n">ell</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="mi">2</span><span class="p">,))</span>
    <span class="n">shap</span> <span class="o">=</span> <span class="n">y</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">Wc</span> <span class="o">=</span> <span class="n">ones</span><span class="p">(</span><span class="n">shap</span><span class="p">)</span>
    <span class="k">while</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">nb_iter</span><span class="p">:</span><span class="c1"># and err&gt;tol:</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">y</span><span class="o">-</span><span class="n">scisig</span><span class="o">.</span><span class="n">fftconvolve</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">h</span><span class="p">,</span><span class="n">mode</span><span class="o">=</span><span class="s1">&#39;same&#39;</span><span class="p">)</span>
        <span class="n">mse</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">res</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="nb">print</span> <span class="n">mse</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">grad</span> <span class="o">=</span> <span class="o">-</span><span class="n">scisig</span><span class="o">.</span><span class="n">fftconvolve</span><span class="p">(</span><span class="n">res</span><span class="p">,</span><span class="n">h_adj</span><span class="p">,</span><span class="n">mode</span><span class="o">=</span><span class="s1">&#39;same&#39;</span><span class="p">)</span>

        <span class="n">vold</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
        <span class="n">v</span> <span class="o">=</span> <span class="n">pos_proj</span><span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="p">(</span><span class="n">mu</span><span class="o">/</span><span class="n">lip</span><span class="p">)</span><span class="o">*</span><span class="n">grad</span><span class="p">)</span>
        <span class="n">t</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">4</span><span class="o">*</span><span class="n">told</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span><span class="o">/</span><span class="mi">2</span>
        <span class="n">lamb</span> <span class="o">=</span> <span class="mi">1</span><span class="o">+</span><span class="p">(</span><span class="n">told</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="n">t</span>
        <span class="n">told</span> <span class="o">=</span> <span class="n">t</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">vold</span> <span class="o">+</span><span class="n">lamb</span><span class="o">*</span><span class="p">(</span><span class="n">v</span><span class="o">-</span><span class="n">vold</span><span class="p">)</span>
        <span class="n">ell_old</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">ell</span><span class="p">)</span>
        <span class="n">ell</span><span class="p">,</span><span class="n">centroid</span><span class="p">,</span><span class="n">fwhm</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">mk_ellipticity_2</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">Wc</span><span class="p">)</span>
        <span class="n">err</span> <span class="o">=</span> <span class="n">sqrt</span><span class="p">(</span><span class="nb">sum</span><span class="p">((</span><span class="n">ell</span><span class="o">-</span><span class="n">ell_old</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span>
        <span class="n">i</span><span class="o">+=</span><span class="mi">1</span>
    <span class="k">return</span> <span class="n">x</span><span class="c1">#,res,mse</span>


<span class="k">def</span> <span class="nf">deconvol_sparse</span><span class="p">(</span><span class="n">y</span><span class="p">,</span><span class="n">h</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="n">mu</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">nb_iter</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span><span class="n">tol</span><span class="o">=</span><span class="mf">0.001</span><span class="p">,</span><span class="n">thresh_type</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
    <span class="n">i</span><span class="o">=</span><span class="mi">0</span>
    <span class="n">lip</span> <span class="o">=</span> <span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">h</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span><span class="o">**</span><span class="mi">2</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
    <span class="n">v</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
    <span class="n">mse</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">nb_iter</span><span class="p">,))</span>
    <span class="n">h_adj</span> <span class="o">=</span> <span class="n">rot90</span><span class="p">(</span><span class="n">h</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">t</span><span class="o">=</span><span class="mi">1</span>
    <span class="n">told</span><span class="o">=</span><span class="n">t</span>
    <span class="n">i</span><span class="o">=</span><span class="mi">0</span>
    <span class="n">err</span> <span class="o">=</span> <span class="mf">1.0</span>
    <span class="n">ell</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="mi">2</span><span class="p">,))</span>
    <span class="n">shap</span> <span class="o">=</span> <span class="n">y</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">Wc</span> <span class="o">=</span> <span class="n">ones</span><span class="p">(</span><span class="n">shap</span><span class="p">)</span>
    <span class="n">suppi</span><span class="o">=</span><span class="mi">0</span>
    <span class="n">suppj</span><span class="o">=</span><span class="mi">0</span>
    <span class="k">while</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">nb_iter</span><span class="p">:</span><span class="c1"># and err&gt;tol:</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">y</span><span class="o">-</span><span class="n">scisig</span><span class="o">.</span><span class="n">fftconvolve</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">h</span><span class="p">,</span><span class="n">mode</span><span class="o">=</span><span class="s1">&#39;same&#39;</span><span class="p">)</span>
        <span class="n">mse</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">res</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="nb">print</span> <span class="n">mse</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">grad</span> <span class="o">=</span> <span class="o">-</span><span class="n">scisig</span><span class="o">.</span><span class="n">fftconvolve</span><span class="p">(</span><span class="n">res</span><span class="p">,</span><span class="n">h_adj</span><span class="p">,</span><span class="n">mode</span><span class="o">=</span><span class="s1">&#39;same&#39;</span><span class="p">)</span>

        <span class="n">vold</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">nb_iter</span><span class="p">:</span>
            <span class="n">v</span> <span class="o">=</span> <span class="n">pos_proj</span><span class="p">(</span><span class="n">utils</span><span class="o">.</span><span class="n">kthresholding_im</span><span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="p">(</span><span class="n">mu</span><span class="o">/</span><span class="n">lip</span><span class="p">)</span><span class="o">*</span><span class="n">grad</span><span class="p">,</span><span class="n">sqrt</span><span class="p">(</span><span class="n">nb_iter</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span><span class="n">thresh_type</span><span class="p">))</span>
            <span class="n">suppi</span><span class="p">,</span><span class="n">suppj</span> <span class="o">=</span> <span class="n">where</span><span class="p">(</span><span class="n">v</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">t1</span> <span class="o">=</span> <span class="n">x</span> <span class="o">-</span> <span class="p">(</span><span class="n">mu</span><span class="o">/</span><span class="n">lip</span><span class="p">)</span><span class="o">*</span><span class="n">grad</span>
            <span class="n">t2</span> <span class="o">=</span> <span class="n">t1</span><span class="o">*</span><span class="mi">0</span>
            <span class="n">t2</span><span class="p">[</span><span class="n">suppi</span><span class="p">,</span><span class="n">suppj</span><span class="p">]</span> <span class="o">=</span> <span class="n">t1</span><span class="p">[</span><span class="n">suppi</span><span class="p">,</span><span class="n">suppj</span><span class="p">]</span>
            <span class="n">v</span> <span class="o">=</span> <span class="n">pos_proj</span><span class="p">(</span><span class="n">t2</span><span class="p">)</span>
        <span class="n">t</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">4</span><span class="o">*</span><span class="n">told</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span><span class="o">/</span><span class="mi">2</span>
        <span class="n">lamb</span> <span class="o">=</span> <span class="mi">1</span><span class="o">+</span><span class="p">(</span><span class="n">told</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="n">t</span>
        <span class="n">told</span> <span class="o">=</span> <span class="n">t</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">vold</span> <span class="o">+</span><span class="n">lamb</span><span class="o">*</span><span class="p">(</span><span class="n">v</span><span class="o">-</span><span class="n">vold</span><span class="p">)</span>
        <span class="n">ell_old</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">ell</span><span class="p">)</span>
        <span class="n">ell</span><span class="p">,</span><span class="n">centroid</span><span class="p">,</span><span class="n">fwhm</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">mk_ellipticity_2</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">Wc</span><span class="p">)</span>
        <span class="n">err</span> <span class="o">=</span> <span class="n">sqrt</span><span class="p">(</span><span class="nb">sum</span><span class="p">((</span><span class="n">ell</span><span class="o">-</span><span class="n">ell_old</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span>
        <span class="n">i</span><span class="o">+=</span><span class="mi">1</span>
    <span class="n">est</span> <span class="o">=</span> <span class="n">scisig</span><span class="o">.</span><span class="n">fftconvolve</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">h</span><span class="p">,</span><span class="n">mode</span><span class="o">=</span><span class="s1">&#39;same&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">x</span><span class="p">,</span><span class="n">est</span><span class="c1">#,res,mse</span>




<span class="k">def</span> <span class="nf">wvl_analysis_op</span><span class="p">(</span><span class="n">im</span><span class="p">,</span><span class="n">weights</span><span class="p">,</span><span class="n">mu</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">opt</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">coeff_init</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">mr_file</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">nb_iter</span><span class="o">=</span><span class="mi">100</span><span class="p">):</span>
    <span class="n">x</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">coeff_init</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">coeff_init</span><span class="p">,</span><span class="n">mr_file</span> <span class="o">=</span> <span class="n">isap</span><span class="o">.</span><span class="n">mr_trans</span><span class="p">(</span><span class="n">im</span><span class="p">,</span><span class="n">opt</span><span class="o">=</span><span class="n">opt</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="mi">0</span><span class="o">*</span><span class="n">coeff_init</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">coeff_init</span><span class="p">)</span>
    <span class="n">xold</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">z</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">i</span><span class="o">=</span><span class="mi">0</span>
    <span class="n">mse</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">nb_iter</span><span class="p">,))</span>
    <span class="n">thresh_type</span><span class="o">=</span><span class="mi">1</span>
    <span class="n">t</span><span class="o">=</span><span class="mi">1</span>
    <span class="n">told</span> <span class="o">=</span> <span class="n">t</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_iter</span><span class="p">):</span>
        <span class="n">rec</span> <span class="o">=</span> <span class="n">isap</span><span class="o">.</span><span class="n">mr_recons_coeff</span><span class="p">(</span><span class="n">z</span><span class="p">,</span><span class="n">mr_file</span><span class="p">)</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">im</span> <span class="o">-</span> <span class="n">rec</span>
        <span class="n">mse</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">res</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>

        <span class="n">grad</span><span class="p">,</span><span class="n">mr_file_temp</span> <span class="o">=</span> <span class="n">isap</span><span class="o">.</span><span class="n">mr_trans</span><span class="p">(</span><span class="o">-</span><span class="n">res</span><span class="p">,</span><span class="n">opt</span><span class="o">=</span><span class="n">opt</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">mr_file_temp</span><span class="p">)</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">z</span> <span class="o">-</span> <span class="n">mu</span><span class="o">*</span><span class="n">grad</span>
        <span class="n">xold</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">xtemp</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">l_inf_ball_proj_3D</span><span class="p">(</span><span class="n">y</span><span class="p">,</span><span class="n">weights</span><span class="p">,</span><span class="n">thresh_type</span><span class="p">)</span> <span class="c1"># The coarse scale is not thresholded</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">xtemp</span><span class="p">)</span>
        <span class="n">told</span> <span class="o">=</span> <span class="n">t</span>
        <span class="n">t</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">4</span><span class="o">*</span><span class="p">(</span><span class="n">t</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span><span class="o">/</span><span class="mi">2</span>
        <span class="n">lambd</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">+</span> <span class="p">(</span><span class="n">told</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="n">t</span>
        <span class="n">z</span> <span class="o">=</span> <span class="n">xold</span><span class="o">+</span><span class="n">lambd</span><span class="o">*</span><span class="p">(</span><span class="n">x</span><span class="o">-</span><span class="n">xold</span><span class="p">)</span>

    <span class="n">coeff_init</span> <span class="o">=</span> <span class="n">z</span>
    <span class="n">n</span> <span class="o">=</span> <span class="n">isap</span><span class="o">.</span><span class="n">mr_recons_coeff</span><span class="p">(</span><span class="n">z</span><span class="p">,</span><span class="n">mr_file</span><span class="p">)</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">im</span> <span class="o">-</span> <span class="n">n</span>
    <span class="k">return</span> <span class="n">result</span><span class="p">,</span><span class="n">mr_file</span><span class="p">,</span><span class="n">n</span><span class="p">,</span><span class="n">coeff_init</span>

<span class="k">def</span> <span class="nf">wvl_analysis_op_src</span><span class="p">(</span><span class="n">im</span><span class="p">,</span><span class="n">u</span><span class="p">,</span><span class="n">weights</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">mu</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">opt</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">coeff_init</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">mr_file</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">nb_iter</span><span class="o">=</span><span class="mi">100</span><span class="p">):</span>
    <span class="n">x</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">nb_im</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">coeff_init</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">temp</span><span class="p">,</span><span class="n">mr_file</span> <span class="o">=</span> <span class="n">isap</span><span class="o">.</span><span class="n">mr_trans</span><span class="p">(</span><span class="n">im</span><span class="p">,</span><span class="n">opt</span><span class="o">=</span><span class="n">opt</span><span class="p">)</span>
        <span class="n">shap</span> <span class="o">=</span> <span class="n">temp</span><span class="o">.</span><span class="n">shape</span>
        <span class="n">coeff_init</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">nb_im</span><span class="p">))</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">coeff_init</span><span class="p">)</span>
    <span class="n">grad</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">coeff_init</span><span class="p">)</span>
    <span class="n">xold</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">z</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">i</span><span class="o">=</span><span class="mi">0</span>
    <span class="n">mse</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">nb_iter</span><span class="p">,))</span>
    <span class="n">thresh_type</span><span class="o">=</span><span class="mi">1</span>
    <span class="n">t</span><span class="o">=</span><span class="mi">1</span>
    <span class="n">told</span> <span class="o">=</span> <span class="n">t</span>

    <span class="n">w</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">coeff_init</span><span class="p">[:,:,:,</span><span class="mi">0</span><span class="p">])</span><span class="o">*</span><span class="mi">0</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_im</span><span class="p">):</span>
        <span class="n">w</span> <span class="o">+=</span> <span class="p">(</span><span class="n">a</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">weights</span><span class="p">[:,:,:,</span><span class="n">k</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span>
    <span class="n">spec_rad</span> <span class="o">=</span> <span class="n">w</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
    <span class="n">shap</span> <span class="o">=</span> <span class="n">coeff_init</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">ones_w</span> <span class="o">=</span> <span class="n">ones</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_iter</span><span class="p">):</span>
        <span class="n">rec</span> <span class="o">=</span> <span class="n">im</span><span class="o">*</span><span class="mi">0</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_im</span><span class="p">):</span>
            <span class="n">rec</span> <span class="o">+=</span> <span class="n">isap</span><span class="o">.</span><span class="n">mr_recons_coeff</span><span class="p">(</span><span class="n">z</span><span class="p">[:,:,:,</span><span class="n">k</span><span class="p">]</span><span class="o">*</span><span class="n">weights</span><span class="p">[:,:,:,</span><span class="n">k</span><span class="p">]</span><span class="o">*</span><span class="n">a</span><span class="p">[</span><span class="n">k</span><span class="p">],</span><span class="n">mr_file</span><span class="p">)</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">rec</span> <span class="o">-</span> <span class="n">im</span>
        <span class="n">mse</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">res</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">-</span><span class="p">(</span><span class="n">z</span><span class="o">*</span><span class="n">u</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="n">nb_iter</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="nb">print</span> <span class="s2">&quot;mse prox analysis: &quot;</span><span class="p">,</span><span class="n">mse</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">gradtemp</span><span class="p">,</span><span class="n">mr_file_temp</span> <span class="o">=</span> <span class="n">isap</span><span class="o">.</span><span class="n">mr_trans</span><span class="p">(</span><span class="n">res</span><span class="p">,</span><span class="n">opt</span><span class="o">=</span><span class="n">opt</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_im</span><span class="p">):</span>
            <span class="n">grad</span><span class="p">[:,:,:,</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">gradtemp</span><span class="o">*</span><span class="n">weights</span><span class="p">[:,:,:,</span><span class="n">k</span><span class="p">]</span><span class="o">*</span><span class="n">a</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
        <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">mr_file_temp</span><span class="p">)</span>
        <span class="n">grad</span> <span class="o">-=</span> <span class="n">u</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">z</span> <span class="o">-</span> <span class="n">mu</span><span class="o">*</span><span class="n">grad</span><span class="o">/</span><span class="n">spec_rad</span>
        <span class="n">xold</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_im</span><span class="p">):</span>
            <span class="n">x</span><span class="p">[:,:,:,</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">l_inf_ball_proj_3D</span><span class="p">(</span><span class="n">y</span><span class="p">[:,:,:,</span><span class="n">k</span><span class="p">],</span><span class="n">ones_w</span><span class="p">,</span><span class="n">thresh_type</span><span class="p">)</span> <span class="c1"># The coarse scale is not thresholded</span>
        <span class="n">told</span> <span class="o">=</span> <span class="n">t</span>
        <span class="n">t</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">4</span><span class="o">*</span><span class="p">(</span><span class="n">t</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span><span class="o">/</span><span class="mi">2</span>
        <span class="n">lambd</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">+</span> <span class="p">(</span><span class="n">told</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="n">t</span>
        <span class="n">z</span> <span class="o">=</span> <span class="n">xold</span><span class="o">+</span><span class="n">lambd</span><span class="o">*</span><span class="p">(</span><span class="n">x</span><span class="o">-</span><span class="n">xold</span><span class="p">)</span>

    <span class="n">coeff_init</span> <span class="o">=</span> <span class="n">z</span>
    <span class="n">rec</span> <span class="o">=</span> <span class="n">im</span><span class="o">*</span><span class="mi">0</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_im</span><span class="p">):</span>
        <span class="n">rec</span> <span class="o">+=</span> <span class="n">isap</span><span class="o">.</span><span class="n">mr_recons_coeff</span><span class="p">(</span><span class="n">z</span><span class="p">[:,:,:,</span><span class="n">k</span><span class="p">]</span><span class="o">*</span><span class="n">weights</span><span class="p">[:,:,:,</span><span class="n">k</span><span class="p">]</span><span class="o">*</span><span class="n">a</span><span class="p">[</span><span class="n">k</span><span class="p">],</span><span class="n">mr_file</span><span class="p">)</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">im</span> <span class="o">-</span> <span class="n">rec</span>
    <span class="k">return</span> <span class="n">result</span><span class="p">,</span><span class="n">mr_file</span><span class="p">,</span><span class="n">rec</span><span class="p">,</span><span class="n">coeff_init</span>


<span class="k">def</span> <span class="nf">wvl_analysis_op_ell_cons</span><span class="p">(</span><span class="n">im</span><span class="p">,</span><span class="n">cur_point</span><span class="p">,</span><span class="n">weights</span><span class="p">,</span><span class="n">mu</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">opt</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">coeff_init</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">mr_file</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">nb_iter</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span><span class="n">nb_comp</span><span class="o">=</span><span class="mi">2000</span><span class="p">):</span>
    <span class="n">x</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">coeff_init</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">coeff_init</span><span class="p">,</span><span class="n">mr_file</span> <span class="o">=</span> <span class="n">isap</span><span class="o">.</span><span class="n">mr_trans</span><span class="p">(</span><span class="n">im</span><span class="p">,</span><span class="n">opt</span><span class="o">=</span><span class="n">opt</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="mi">0</span><span class="o">*</span><span class="n">coeff_init</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">coeff_init</span><span class="p">)</span>
    <span class="n">xold</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">z</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">i</span><span class="o">=</span><span class="mi">0</span>
    <span class="n">mse</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">nb_iter</span><span class="p">,))</span>
    <span class="n">thresh_type</span><span class="o">=</span><span class="mi">1</span>
    <span class="n">t</span><span class="o">=</span><span class="mi">1</span>
    <span class="n">told</span> <span class="o">=</span> <span class="n">t</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_iter</span><span class="p">):</span>
        <span class="n">rec</span> <span class="o">=</span> <span class="n">isap</span><span class="o">.</span><span class="n">mr_recons_coeff</span><span class="p">(</span><span class="n">z</span><span class="p">,</span><span class="n">mr_file</span><span class="p">)</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">im</span> <span class="o">-</span> <span class="n">rec</span>
        <span class="n">mse</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">res</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="n">grad</span><span class="p">,</span><span class="n">mr_file_temp</span> <span class="o">=</span> <span class="n">isap</span><span class="o">.</span><span class="n">mr_trans</span><span class="p">(</span><span class="o">-</span><span class="n">res</span><span class="p">,</span><span class="n">opt</span><span class="o">=</span><span class="n">opt</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">mr_file_temp</span><span class="p">)</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">z</span> <span class="o">-</span> <span class="n">mu</span><span class="o">*</span><span class="n">grad</span>
        <span class="n">xold</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">xtemp</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">l_inf_ball_proj_3D</span><span class="p">(</span><span class="n">y</span><span class="p">[:,:,:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span><span class="n">weights</span><span class="p">,</span><span class="n">thresh_type</span><span class="p">)</span> <span class="c1"># The coarse scale is not thresholded</span>
        <span class="n">x</span><span class="p">[:,:,:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">xtemp</span>
        <span class="n">told</span> <span class="o">=</span> <span class="n">t</span>
        <span class="n">t</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">4</span><span class="o">*</span><span class="p">(</span><span class="n">t</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span><span class="o">/</span><span class="mi">2</span>
        <span class="n">lambd</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">+</span> <span class="p">(</span><span class="n">told</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="n">t</span>
        <span class="n">z</span> <span class="o">=</span> <span class="n">xold</span><span class="o">+</span><span class="n">lambd</span><span class="o">*</span><span class="p">(</span><span class="n">x</span><span class="o">-</span><span class="n">xold</span><span class="p">)</span>

    <span class="c1">#coeff_init = z</span>
    <span class="n">n</span> <span class="o">=</span> <span class="n">isap</span><span class="o">.</span><span class="n">mr_recons_coeff</span><span class="p">(</span><span class="n">z</span><span class="p">,</span><span class="n">mr_file</span><span class="p">)</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">im</span> <span class="o">-</span> <span class="n">n</span>
    <span class="n">result</span><span class="p">,</span><span class="n">ref_ell</span><span class="p">,</span><span class="n">test_ell</span><span class="p">,</span><span class="n">fit_ell</span> <span class="o">=</span> <span class="n">ell_controled_fit</span><span class="p">(</span><span class="n">result</span><span class="p">,</span><span class="n">cur_point</span><span class="p">,</span><span class="n">nb_iter</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span><span class="n">nb_comp</span><span class="o">=</span><span class="n">nb_comp</span><span class="p">)</span>
    <span class="n">coeff_init</span><span class="p">,</span><span class="n">mr_file_temp</span> <span class="o">=</span> <span class="n">isap</span><span class="o">.</span><span class="n">mr_trans</span><span class="p">(</span><span class="n">im</span><span class="o">-</span><span class="n">result</span><span class="p">,</span><span class="n">opt</span><span class="o">=</span><span class="n">opt</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">mr_file_temp</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">result</span><span class="p">,</span><span class="n">mr_file</span><span class="p">,</span><span class="n">n</span><span class="p">,</span><span class="n">coeff_init</span>

<span class="k">def</span> <span class="nf">pos_spars_deconvol</span><span class="p">(</span><span class="n">y</span><span class="p">,</span><span class="n">h</span><span class="p">,</span><span class="n">opt</span><span class="p">,</span><span class="n">nsig</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span><span class="n">nb_rw</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">nb_iter</span><span class="o">=</span><span class="mi">20</span><span class="p">):</span>
    <span class="n">w1</span> <span class="o">=</span> <span class="mf">0.8</span>
    <span class="n">w2</span> <span class="o">=</span> <span class="mf">0.2</span>
    <span class="n">z1</span> <span class="o">=</span> <span class="n">y</span><span class="o">*</span><span class="mi">0</span>
    <span class="n">z2</span> <span class="o">=</span> <span class="n">y</span><span class="o">*</span><span class="mi">0</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">y</span><span class="o">*</span><span class="mi">0</span>
    <span class="n">coeff_init</span><span class="o">=</span><span class="kc">None</span>
    <span class="n">mr_file</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">l</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">lip</span> <span class="o">=</span> <span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">h</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span><span class="o">**</span><span class="mi">2</span>
    <span class="n">h_adj</span> <span class="o">=</span> <span class="n">rot90</span><span class="p">(</span><span class="n">h</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">lambd</span> <span class="o">=</span> <span class="mf">1.5</span>
    <span class="n">weights</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_rw</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
        <span class="n">i</span><span class="o">=</span><span class="mi">0</span>
        <span class="k">if</span> <span class="n">l</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
            <span class="n">nb_iter</span> <span class="o">=</span> <span class="mi">10</span>
        <span class="n">nb_subiter</span> <span class="o">=</span> <span class="mi">50</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_iter</span><span class="p">):</span>
            <span class="nb">print</span> <span class="n">i</span>
            <span class="k">if</span> <span class="n">i</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
                <span class="n">nb_subiter</span> <span class="o">=</span> <span class="mi">5</span>
            <span class="n">res</span> <span class="o">=</span> <span class="n">y</span><span class="o">-</span><span class="n">scisig</span><span class="o">.</span><span class="n">fftconvolve</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">h</span><span class="p">,</span><span class="n">mode</span><span class="o">=</span><span class="s1">&#39;same&#39;</span><span class="p">)</span>
            <span class="n">gradi</span> <span class="o">=</span> <span class="o">-</span><span class="n">scisig</span><span class="o">.</span><span class="n">convolve</span><span class="p">(</span><span class="n">res</span><span class="p">,</span><span class="n">h_adj</span><span class="p">,</span><span class="n">mode</span><span class="o">=</span><span class="s1">&#39;same&#39;</span><span class="p">)</span>

            <span class="c1"># ---- Analysis constraint ---- #</span>
            <span class="c1"># Wavelet noise estimation</span>
            <span class="n">sig_map</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">res_sig_map</span><span class="p">(</span><span class="n">gradi</span><span class="o">/</span><span class="n">lip</span><span class="p">,</span><span class="n">opt</span><span class="o">=</span><span class="n">opt</span><span class="p">)</span>
            <span class="n">temp1</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">x</span> <span class="o">-</span> <span class="n">z1</span> <span class="o">-</span> <span class="n">gradi</span><span class="o">/</span><span class="n">lip</span>
            <span class="n">thresh_map</span> <span class="o">=</span> <span class="n">nsig</span><span class="o">*</span><span class="n">sig_map</span>
            <span class="k">if</span> <span class="n">weights</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">thresh_map</span> <span class="o">=</span> <span class="n">thresh_map</span><span class="o">*</span><span class="n">weights</span>
            <span class="n">result</span><span class="p">,</span><span class="n">mr_file</span><span class="p">,</span><span class="n">n</span><span class="p">,</span><span class="n">coeff_init</span> <span class="o">=</span> <span class="n">wvl_analysis_op</span><span class="p">(</span><span class="n">temp1</span><span class="p">,</span><span class="n">thresh_map</span><span class="p">,</span><span class="n">opt</span><span class="o">=</span><span class="n">opt</span><span class="p">,</span><span class="n">coeff_init</span><span class="o">=</span><span class="n">coeff_init</span><span class="p">,</span><span class="n">mr_file</span><span class="o">=</span><span class="n">mr_file</span><span class="p">,</span><span class="n">nb_iter</span><span class="o">=</span><span class="n">nb_subiter</span><span class="p">)</span>
            <span class="n">z1</span> <span class="o">=</span> <span class="n">z1</span><span class="o">+</span><span class="n">lambd</span><span class="o">*</span><span class="p">(</span><span class="n">result</span><span class="o">-</span><span class="n">x</span><span class="p">)</span>

            <span class="c1"># ---- Positivity constraint ---- #</span>
            <span class="n">z2</span> <span class="o">=</span> <span class="n">z2</span><span class="o">+</span><span class="n">lambd</span><span class="o">*</span><span class="p">(</span><span class="n">pos_proj_mat</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">x</span> <span class="o">-</span> <span class="n">z2</span> <span class="o">-</span> <span class="n">gradi</span><span class="o">/</span><span class="n">lip</span><span class="p">)</span><span class="o">-</span><span class="n">x</span><span class="p">)</span>

            <span class="c1"># ---- Main variable update ---- #</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">w1</span><span class="o">*</span><span class="n">z1</span> <span class="o">+</span> <span class="n">w2</span><span class="o">*</span><span class="n">z2</span>

        <span class="c1"># ---- Weights update ---- #</span>
        <span class="n">coeffx</span><span class="p">,</span><span class="n">mr_file</span> <span class="o">=</span> <span class="n">isap</span><span class="o">.</span><span class="n">mr_trans</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">opt</span><span class="o">=</span><span class="n">opt</span><span class="p">)</span>
        <span class="n">weights</span>  <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="nb">abs</span><span class="p">(</span><span class="n">coeffx</span><span class="p">[:,:,:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span><span class="o">/</span><span class="p">(</span><span class="n">nsig</span><span class="o">*</span><span class="n">sig_map</span><span class="p">))</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>

    <span class="n">res</span> <span class="o">=</span> <span class="n">y</span><span class="o">-</span><span class="n">scisig</span><span class="o">.</span><span class="n">fftconvolve</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">h</span><span class="p">,</span><span class="n">mode</span><span class="o">=</span><span class="s1">&#39;same&#39;</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">mr_file</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">x</span><span class="p">,</span><span class="n">res</span>


<span class="k">def</span> <span class="nf">pos_spars_deconvol_shap_cons</span><span class="p">(</span><span class="n">y</span><span class="p">,</span><span class="n">h</span><span class="p">,</span><span class="n">opt</span><span class="p">,</span><span class="n">nell1</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">nell2</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">nsig</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span><span class="n">nb_rw</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">nb_iter</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span><span class="n">r</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
    <span class="n">w1</span> <span class="o">=</span> <span class="mf">0.8</span>
    <span class="n">w2</span> <span class="o">=</span> <span class="mf">0.2</span>
    <span class="n">z1</span> <span class="o">=</span> <span class="n">y</span><span class="o">*</span><span class="mi">0</span>
    <span class="n">z2</span> <span class="o">=</span> <span class="n">y</span><span class="o">*</span><span class="mi">0</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">y</span><span class="o">*</span><span class="mi">0</span>
    <span class="n">coeff_init</span><span class="o">=</span><span class="kc">None</span>
    <span class="n">mr_file</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">l</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">lip</span> <span class="o">=</span> <span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">h</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span><span class="o">**</span><span class="mi">2</span>
    <span class="n">h_adj</span> <span class="o">=</span> <span class="n">rot90</span><span class="p">(</span><span class="n">h</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">lambd</span> <span class="o">=</span> <span class="mf">1.5</span>
    <span class="n">weights</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">nb_subiter</span> <span class="o">=</span> <span class="mi">50</span>
    <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_rw</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
        <span class="n">i</span><span class="o">=</span><span class="mi">0</span>
        <span class="k">if</span> <span class="n">l</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
            <span class="n">nb_iter</span> <span class="o">=</span> <span class="mi">10</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_iter</span><span class="p">):</span>
            <span class="nb">print</span> <span class="n">i</span>
            <span class="k">if</span> <span class="n">i</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
                <span class="n">nb_subiter</span> <span class="o">=</span> <span class="mi">5</span>
            <span class="n">res</span> <span class="o">=</span> <span class="n">y</span><span class="o">-</span><span class="n">scisig</span><span class="o">.</span><span class="n">fftconvolve</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">h</span><span class="p">,</span><span class="n">mode</span><span class="o">=</span><span class="s1">&#39;same&#39;</span><span class="p">)</span>
            <span class="n">gradi</span> <span class="o">=</span> <span class="o">-</span><span class="n">scisig</span><span class="o">.</span><span class="n">convolve</span><span class="p">(</span><span class="n">res</span><span class="p">,</span><span class="n">h_adj</span><span class="p">,</span><span class="n">mode</span><span class="o">=</span><span class="s1">&#39;same&#39;</span><span class="p">)</span>
            <span class="nb">print</span> <span class="s1">&#39;res: &#39;</span><span class="p">,</span> <span class="p">(</span><span class="n">res</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
            <span class="n">centroid</span><span class="p">,</span><span class="n">U</span><span class="p">,</span><span class="n">ell</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">mk_ellipticity_atoms</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
            <span class="nb">print</span> <span class="s1">&#39;ell: &#39;</span><span class="p">,</span> <span class="n">ell</span>
            <span class="c1"># ---- Analysis constraint ---- #</span>
            <span class="c1"># Wavelet noise estimation</span>
            <span class="n">sig_map</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">res_sig_map</span><span class="p">(</span><span class="n">gradi</span><span class="o">/</span><span class="n">lip</span><span class="p">,</span><span class="n">opt</span><span class="o">=</span><span class="n">opt</span><span class="p">)</span>
            <span class="n">temp1</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">x</span> <span class="o">-</span> <span class="n">z1</span> <span class="o">-</span> <span class="n">gradi</span><span class="o">/</span><span class="n">lip</span>
            <span class="n">thresh_map</span> <span class="o">=</span> <span class="n">nsig</span><span class="o">*</span><span class="n">sig_map</span>
            <span class="k">if</span> <span class="n">weights</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">thresh_map</span> <span class="o">=</span> <span class="n">thresh_map</span><span class="o">*</span><span class="n">weights</span>
            <span class="n">result</span><span class="p">,</span><span class="n">mr_file</span><span class="p">,</span><span class="n">n</span><span class="p">,</span><span class="n">coeff_init</span> <span class="o">=</span> <span class="n">wvl_analysis_op</span><span class="p">(</span><span class="n">temp1</span><span class="p">,</span><span class="n">thresh_map</span><span class="p">,</span><span class="n">opt</span><span class="o">=</span><span class="n">opt</span><span class="p">,</span><span class="n">coeff_init</span><span class="o">=</span><span class="n">coeff_init</span><span class="p">,</span><span class="n">mr_file</span><span class="o">=</span><span class="n">mr_file</span><span class="p">,</span><span class="n">nb_iter</span><span class="o">=</span><span class="n">nb_subiter</span><span class="p">)</span>
            <span class="n">z1</span> <span class="o">=</span> <span class="n">z1</span><span class="o">+</span><span class="n">lambd</span><span class="o">*</span><span class="p">(</span><span class="n">result</span><span class="o">-</span><span class="n">x</span><span class="p">)</span>

            <span class="c1"># ---- Positivity constraint ---- #</span>
            <span class="n">z2</span> <span class="o">=</span> <span class="n">z2</span><span class="o">+</span><span class="n">lambd</span><span class="o">*</span><span class="p">(</span><span class="n">pos_proj_mat</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">x</span> <span class="o">-</span> <span class="n">z2</span> <span class="o">-</span> <span class="n">gradi</span><span class="o">/</span><span class="n">lip</span><span class="p">)</span><span class="o">-</span><span class="n">x</span><span class="p">)</span>

            <span class="c1"># ---- Main variable update ---- #</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">w1</span><span class="o">*</span><span class="n">z1</span> <span class="o">+</span> <span class="n">w2</span><span class="o">*</span><span class="n">z2</span>

        <span class="c1"># ---- Weights update ---- #</span>
        <span class="n">coeffx</span><span class="p">,</span><span class="n">mr_file</span> <span class="o">=</span> <span class="n">isap</span><span class="o">.</span><span class="n">mr_trans</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">opt</span><span class="o">=</span><span class="n">opt</span><span class="p">)</span>
        <span class="n">weights</span>  <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="nb">abs</span><span class="p">(</span><span class="n">coeffx</span><span class="p">[:,:,:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span><span class="o">/</span><span class="p">(</span><span class="n">nsig</span><span class="o">*</span><span class="n">sig_map</span><span class="p">))</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">res1</span> <span class="o">=</span> <span class="n">y</span><span class="o">-</span><span class="n">scisig</span><span class="o">.</span><span class="n">fftconvolve</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">h</span><span class="p">,</span><span class="n">mode</span><span class="o">=</span><span class="s1">&#39;same&#39;</span><span class="p">)</span>
    <span class="n">sol1</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">w1</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="n">w2</span> <span class="o">=</span> <span class="mf">0.5</span>
    <span class="n">w3</span> <span class="o">=</span> <span class="mf">0.5</span>
    <span class="n">centroid</span><span class="p">,</span><span class="n">U</span><span class="p">,</span><span class="n">ell_ref</span><span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">mk_ellipticity_atoms</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="c1">#proj1,proj2,proj3,ell1,ell2,ell3 = utils.nul_ell_proj(x)</span>
    <span class="n">proj3</span><span class="p">,</span><span class="n">ell3</span><span class="o">=</span><span class="n">nul_ell_proj_pos</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">grad1</span><span class="p">,</span><span class="n">grad2</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">ellipticity_grad</span><span class="p">(</span><span class="n">proj3</span><span class="p">)</span>
    <span class="n">shap_weights_1</span> <span class="o">=</span> <span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">grad1</span><span class="p">)</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span><span class="o">*</span><span class="nb">abs</span><span class="p">(</span><span class="n">ell_ref</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span><span class="o">/</span><span class="p">(</span><span class="n">size</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">*</span><span class="n">nell1</span><span class="p">)</span>
    <span class="n">shap_weights_2</span> <span class="o">=</span> <span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">grad2</span><span class="p">)</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span><span class="o">*</span><span class="nb">abs</span><span class="p">(</span><span class="n">ell_ref</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">])</span><span class="o">/</span><span class="p">(</span><span class="n">size</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">*</span><span class="n">nell2</span><span class="p">)</span>
    <span class="n">shap_weights</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">min_pt</span><span class="p">(</span><span class="n">shap_weights_1</span><span class="p">,</span><span class="n">shap_weights_2</span><span class="p">)</span>
    <span class="n">z3</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="nb">print</span> <span class="s1">&#39;ell_ref: &#39;</span><span class="p">,</span><span class="n">ell_ref</span>
    <span class="n">nb_subiter</span> <span class="o">=</span> <span class="mi">5</span>
    <span class="n">nb_iter</span> <span class="o">=</span> <span class="mi">100</span>
    <span class="n">rcons</span> <span class="o">=</span> <span class="n">r</span><span class="o">*</span><span class="n">sqrt</span><span class="p">((</span><span class="n">proj3</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_iter</span><span class="p">):</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">y</span><span class="o">-</span><span class="n">scisig</span><span class="o">.</span><span class="n">fftconvolve</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">h</span><span class="p">,</span><span class="n">mode</span><span class="o">=</span><span class="s1">&#39;same&#39;</span><span class="p">)</span>
        <span class="n">gradi</span> <span class="o">=</span> <span class="o">-</span><span class="n">scisig</span><span class="o">.</span><span class="n">convolve</span><span class="p">(</span><span class="n">res</span><span class="p">,</span><span class="n">h_adj</span><span class="p">,</span><span class="n">mode</span><span class="o">=</span><span class="s1">&#39;same&#39;</span><span class="p">)</span>
        <span class="nb">print</span> <span class="s1">&#39;res: &#39;</span><span class="p">,</span> <span class="p">(</span><span class="n">res</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="n">centroid</span><span class="p">,</span><span class="n">U</span><span class="p">,</span><span class="n">ell</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">mk_ellipticity_atoms</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="nb">print</span> <span class="s1">&#39;ell: &#39;</span><span class="p">,</span><span class="n">ell</span>
        <span class="c1"># ---- Analysis constraint ---- #</span>
        <span class="c1"># Wavelet noise estimation</span>
        <span class="n">sig_map</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">res_sig_map</span><span class="p">(</span><span class="n">gradi</span><span class="o">/</span><span class="n">lip</span><span class="p">,</span><span class="n">opt</span><span class="o">=</span><span class="n">opt</span><span class="p">)</span>
        <span class="n">temp1</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">x</span> <span class="o">-</span> <span class="n">z1</span> <span class="o">-</span> <span class="n">gradi</span><span class="o">/</span><span class="n">lip</span>
        <span class="n">thresh_map</span> <span class="o">=</span> <span class="n">nsig</span><span class="o">*</span><span class="n">sig_map</span>
        <span class="c1">#if weights is not None:</span>
        <span class="c1">#    thresh_map = thresh_map*weights</span>
        <span class="c1">#result,mr_file,n,coeff_init = wvl_analysis_op(temp1,thresh_map,opt=opt,coeff_init=coeff_init,mr_file=mr_file,nb_iter=nb_subiter)</span>
        <span class="c1">#z1 = z1+lambd*(result-x)</span>

        <span class="c1"># ---- Positivity constraint ---- #</span>
        <span class="c1">#z2 = z2+lambd*(pos_proj_mat(2*x - z2 - gradi/lip)-x)</span>


        <span class="c1"># ---- Shape constraint ---- #</span>
        <span class="c1">#z2 = z2+lambd*(pos_proj_mat(proj_ellip_cons(2*x - z3 - gradi/lip,proj3,abs(ell_ref[0,0])/(size(x)*nell1),abs(ell_ref[0,1])/(size(x)*nell2)))-x)</span>

        <span class="c1"># ---- Main variable update ---- #</span>
        <span class="c1">#x = w1*z1 + w2*z2 + w3*z3</span>
        <span class="c1">#x = pos_proj_mat(proj_ellip_cons(x - gradi/(lip),proj3,abs(ell_ref[0,0])/(size(x)*nell1),abs(ell_ref[0,1])/(size(x)*nell2)))</span>
        <span class="c1">#x = utils.l_inf_ball_proj(x - gradi/lip,shap_weights,1,cent=proj3)</span>
        <span class="c1">#x = proj_ellip_cons_2(x - gradi/(lip),proj3,abs(ell_ref[0,0]),abs(ell_ref[0,1]),grad1,grad2)</span>

        <span class="n">x</span> <span class="o">=</span> <span class="n">dyks_alg_shap_cons</span><span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="n">gradi</span><span class="o">/</span><span class="p">(</span><span class="n">lip</span><span class="p">),</span><span class="n">proj3</span><span class="p">,</span><span class="nb">abs</span><span class="p">(</span><span class="n">ell_ref</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]),</span><span class="nb">abs</span><span class="p">(</span><span class="n">ell_ref</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]),</span><span class="n">grad1</span><span class="p">,</span><span class="n">grad2</span><span class="p">,</span><span class="n">rcons</span><span class="p">,</span><span class="n">nb_iter</span><span class="o">=</span><span class="mi">50</span><span class="p">)</span>
        <span class="nb">print</span> <span class="s1">&#39;proj ell1 &#39;</span><span class="p">,</span><span class="nb">abs</span><span class="p">((</span><span class="n">grad1</span><span class="o">*</span><span class="p">(</span><span class="n">x</span><span class="o">-</span><span class="n">proj3</span><span class="p">))</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span>
        <span class="nb">print</span> <span class="s1">&#39;proj ell2 &#39;</span><span class="p">,</span><span class="nb">abs</span><span class="p">((</span><span class="n">grad2</span><span class="o">*</span><span class="p">(</span><span class="n">x</span><span class="o">-</span><span class="n">proj3</span><span class="p">))</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span>

    <span class="n">res2</span> <span class="o">=</span> <span class="n">y</span><span class="o">-</span><span class="n">scisig</span><span class="o">.</span><span class="n">fftconvolve</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">h</span><span class="p">,</span><span class="n">mode</span><span class="o">=</span><span class="s1">&#39;same&#39;</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">mr_file</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">sol1</span><span class="p">,</span><span class="n">x</span><span class="p">,</span><span class="n">res1</span><span class="p">,</span><span class="n">res2</span><span class="p">,</span><span class="n">proj3</span><span class="p">,</span><span class="n">grad1</span><span class="p">,</span><span class="n">grad2</span>

<span class="k">def</span> <span class="nf">pos_spars_deconvol_shap_cons_2</span><span class="p">(</span><span class="n">y</span><span class="p">,</span><span class="n">h</span><span class="p">,</span><span class="n">opt</span><span class="p">,</span><span class="n">nell1</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">nell2</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">nsig</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span><span class="n">nb_rw</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">nb_iter</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span><span class="n">r</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
    <span class="n">w1</span> <span class="o">=</span> <span class="mf">0.8</span>
    <span class="n">w2</span> <span class="o">=</span> <span class="mf">0.2</span>
    <span class="n">z1</span> <span class="o">=</span> <span class="n">y</span><span class="o">*</span><span class="mi">0</span>
    <span class="n">z2</span> <span class="o">=</span> <span class="n">y</span><span class="o">*</span><span class="mi">0</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">y</span><span class="o">*</span><span class="mi">0</span>
    <span class="n">coeff_init</span><span class="o">=</span><span class="kc">None</span>
    <span class="n">mr_file</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">l</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">lip</span> <span class="o">=</span> <span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">h</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span><span class="o">**</span><span class="mi">2</span>
    <span class="n">h_adj</span> <span class="o">=</span> <span class="n">rot90</span><span class="p">(</span><span class="n">h</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">lambd</span> <span class="o">=</span> <span class="mf">1.5</span>
    <span class="n">weights</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">nb_subiter</span> <span class="o">=</span> <span class="mi">50</span>
    <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_rw</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
        <span class="n">i</span><span class="o">=</span><span class="mi">0</span>
        <span class="k">if</span> <span class="n">l</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
            <span class="n">nb_iter</span> <span class="o">=</span> <span class="mi">10</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_iter</span><span class="p">):</span>
            <span class="nb">print</span> <span class="n">i</span>
            <span class="k">if</span> <span class="n">i</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
                <span class="n">nb_subiter</span> <span class="o">=</span> <span class="mi">5</span>
            <span class="n">res</span> <span class="o">=</span> <span class="n">y</span><span class="o">-</span><span class="n">scisig</span><span class="o">.</span><span class="n">fftconvolve</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">h</span><span class="p">,</span><span class="n">mode</span><span class="o">=</span><span class="s1">&#39;same&#39;</span><span class="p">)</span>
            <span class="n">gradi</span> <span class="o">=</span> <span class="o">-</span><span class="n">scisig</span><span class="o">.</span><span class="n">convolve</span><span class="p">(</span><span class="n">res</span><span class="p">,</span><span class="n">h_adj</span><span class="p">,</span><span class="n">mode</span><span class="o">=</span><span class="s1">&#39;same&#39;</span><span class="p">)</span>
            <span class="nb">print</span> <span class="s1">&#39;res: &#39;</span><span class="p">,</span> <span class="p">(</span><span class="n">res</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
            <span class="n">centroid</span><span class="p">,</span><span class="n">U</span><span class="p">,</span><span class="n">ell</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">mk_ellipticity_atoms</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
            <span class="nb">print</span> <span class="s1">&#39;ell: &#39;</span><span class="p">,</span> <span class="n">ell</span>
            <span class="c1"># ---- Analysis constraint ---- #</span>
            <span class="c1"># Wavelet noise estimation</span>
            <span class="n">sig_map</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">res_sig_map</span><span class="p">(</span><span class="n">gradi</span><span class="o">/</span><span class="n">lip</span><span class="p">,</span><span class="n">opt</span><span class="o">=</span><span class="n">opt</span><span class="p">)</span>
            <span class="n">temp1</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">x</span> <span class="o">-</span> <span class="n">z1</span> <span class="o">-</span> <span class="n">gradi</span><span class="o">/</span><span class="n">lip</span>
            <span class="n">thresh_map</span> <span class="o">=</span> <span class="n">nsig</span><span class="o">*</span><span class="n">sig_map</span>
            <span class="k">if</span> <span class="n">weights</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">thresh_map</span> <span class="o">=</span> <span class="n">thresh_map</span><span class="o">*</span><span class="n">weights</span>
            <span class="n">result</span><span class="p">,</span><span class="n">mr_file</span><span class="p">,</span><span class="n">n</span><span class="p">,</span><span class="n">coeff_init</span> <span class="o">=</span> <span class="n">wvl_analysis_op</span><span class="p">(</span><span class="n">temp1</span><span class="p">,</span><span class="n">thresh_map</span><span class="p">,</span><span class="n">opt</span><span class="o">=</span><span class="n">opt</span><span class="p">,</span><span class="n">coeff_init</span><span class="o">=</span><span class="n">coeff_init</span><span class="p">,</span><span class="n">mr_file</span><span class="o">=</span><span class="n">mr_file</span><span class="p">,</span><span class="n">nb_iter</span><span class="o">=</span><span class="n">nb_subiter</span><span class="p">)</span>
            <span class="n">z1</span> <span class="o">=</span> <span class="n">z1</span><span class="o">+</span><span class="n">lambd</span><span class="o">*</span><span class="p">(</span><span class="n">result</span><span class="o">-</span><span class="n">x</span><span class="p">)</span>

            <span class="c1"># ---- Positivity constraint ---- #</span>
            <span class="n">z2</span> <span class="o">=</span> <span class="n">z2</span><span class="o">+</span><span class="n">lambd</span><span class="o">*</span><span class="p">(</span><span class="n">pos_proj_mat</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">x</span> <span class="o">-</span> <span class="n">z2</span> <span class="o">-</span> <span class="n">gradi</span><span class="o">/</span><span class="n">lip</span><span class="p">)</span><span class="o">-</span><span class="n">x</span><span class="p">)</span>

            <span class="c1"># ---- Main variable update ---- #</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">w1</span><span class="o">*</span><span class="n">z1</span> <span class="o">+</span> <span class="n">w2</span><span class="o">*</span><span class="n">z2</span>

            <span class="c1"># ---- Weights update ---- #</span>
            <span class="n">coeffx</span><span class="p">,</span><span class="n">mr_file</span> <span class="o">=</span> <span class="n">isap</span><span class="o">.</span><span class="n">mr_trans</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">opt</span><span class="o">=</span><span class="n">opt</span><span class="p">)</span>
            <span class="n">weights</span>  <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="nb">abs</span><span class="p">(</span><span class="n">coeffx</span><span class="p">[:,:,:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span><span class="o">/</span><span class="p">(</span><span class="n">nsig</span><span class="o">*</span><span class="n">sig_map</span><span class="p">))</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">res1</span> <span class="o">=</span> <span class="n">y</span><span class="o">-</span><span class="n">scisig</span><span class="o">.</span><span class="n">fftconvolve</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">h</span><span class="p">,</span><span class="n">mode</span><span class="o">=</span><span class="s1">&#39;same&#39;</span><span class="p">)</span>
    <span class="n">sol1</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">centroid</span><span class="p">,</span><span class="n">U</span><span class="p">,</span><span class="n">ell_ref</span><span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">mk_ellipticity_atoms</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="c1">#proj1,proj2,proj3,ell1,ell2,ell3 = utils.nul_ell_proj(x)</span>
    <span class="n">proj3</span><span class="p">,</span><span class="n">ell3</span><span class="o">=</span><span class="n">nul_ell_proj_pos</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">grad1</span><span class="p">,</span><span class="n">grad2</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">ellipticity_grad</span><span class="p">(</span><span class="n">proj3</span><span class="p">)</span>
    <span class="n">shap_weights_1</span> <span class="o">=</span> <span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">grad1</span><span class="p">)</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span><span class="o">*</span><span class="nb">abs</span><span class="p">(</span><span class="n">ell_ref</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span><span class="o">/</span><span class="p">(</span><span class="n">size</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">*</span><span class="n">nell1</span><span class="p">)</span>
    <span class="n">shap_weights_2</span> <span class="o">=</span> <span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">grad2</span><span class="p">)</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span><span class="o">*</span><span class="nb">abs</span><span class="p">(</span><span class="n">ell_ref</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">])</span><span class="o">/</span><span class="p">(</span><span class="n">size</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">*</span><span class="n">nell2</span><span class="p">)</span>
    <span class="n">shap_weights</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">min_pt</span><span class="p">(</span><span class="n">shap_weights_1</span><span class="p">,</span><span class="n">shap_weights_2</span><span class="p">)</span>
    <span class="n">z3</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="nb">print</span> <span class="s1">&#39;ell_ref: &#39;</span><span class="p">,</span><span class="n">ell_ref</span>
    <span class="n">nb_subiter</span> <span class="o">=</span> <span class="mi">5</span>
    <span class="n">nb_iter</span> <span class="o">=</span> <span class="mi">20</span>
    <span class="n">rcons</span> <span class="o">=</span> <span class="n">r</span><span class="o">*</span><span class="n">sqrt</span><span class="p">((</span><span class="n">proj3</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span>
    <span class="n">t</span><span class="o">=</span><span class="mi">1</span>
    <span class="n">told</span><span class="o">=</span><span class="n">t</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_iter</span><span class="p">):</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">y</span><span class="o">-</span><span class="n">scisig</span><span class="o">.</span><span class="n">fftconvolve</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">h</span><span class="p">,</span><span class="n">mode</span><span class="o">=</span><span class="s1">&#39;same&#39;</span><span class="p">)</span>
        <span class="n">gradi</span> <span class="o">=</span> <span class="o">-</span><span class="n">scisig</span><span class="o">.</span><span class="n">convolve</span><span class="p">(</span><span class="n">res</span><span class="p">,</span><span class="n">h_adj</span><span class="p">,</span><span class="n">mode</span><span class="o">=</span><span class="s1">&#39;same&#39;</span><span class="p">)</span>
        <span class="nb">print</span> <span class="s1">&#39;res: &#39;</span><span class="p">,</span> <span class="p">(</span><span class="n">res</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="n">centroid</span><span class="p">,</span><span class="n">U</span><span class="p">,</span><span class="n">ell</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">mk_ellipticity_atoms</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="nb">print</span> <span class="s1">&#39;ell: &#39;</span><span class="p">,</span><span class="n">ell</span>
        <span class="c1"># ---- Analysis constraint ---- #</span>
        <span class="c1"># Wavelet noise estimation</span>
        <span class="n">sig_map</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">res_sig_map</span><span class="p">(</span><span class="n">gradi</span><span class="o">/</span><span class="n">lip</span><span class="p">,</span><span class="n">opt</span><span class="o">=</span><span class="n">opt</span><span class="p">)</span>
        <span class="n">thresh_map</span> <span class="o">=</span> <span class="n">nsig</span><span class="o">*</span><span class="n">sig_map</span>
        <span class="n">x</span><span class="p">,</span><span class="n">mr_file</span><span class="p">,</span><span class="n">n</span><span class="p">,</span><span class="n">coeff_init</span> <span class="o">=</span> <span class="n">wvl_analysis_op_ell_cons</span><span class="p">(</span><span class="n">x</span><span class="o">-</span><span class="n">gradi</span><span class="o">/</span><span class="n">lip</span><span class="p">,</span><span class="n">x</span><span class="p">,</span><span class="n">thresh_map</span><span class="p">,</span><span class="n">opt</span><span class="o">=</span><span class="n">opt</span><span class="p">,</span><span class="n">coeff_init</span><span class="o">=</span><span class="n">coeff_init</span><span class="p">,</span><span class="n">mr_file</span><span class="o">=</span><span class="n">mr_file</span><span class="p">,</span><span class="n">nb_iter</span><span class="o">=</span><span class="n">nb_subiter</span><span class="p">)</span>

    <span class="n">res2</span> <span class="o">=</span> <span class="n">y</span><span class="o">-</span><span class="n">scisig</span><span class="o">.</span><span class="n">fftconvolve</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">h</span><span class="p">,</span><span class="n">mode</span><span class="o">=</span><span class="s1">&#39;same&#39;</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">mr_file</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">sol1</span><span class="p">,</span><span class="n">x</span><span class="p">,</span><span class="n">res1</span><span class="p">,</span><span class="n">res2</span><span class="p">,</span><span class="n">proj3</span><span class="p">,</span><span class="n">grad1</span><span class="p">,</span><span class="n">grad2</span>


<span class="k">def</span> <span class="nf">proj_ellip_cons</span><span class="p">(</span><span class="n">im</span><span class="p">,</span><span class="n">ref</span><span class="p">,</span><span class="n">mu1</span><span class="p">,</span><span class="n">mu2</span><span class="p">):</span>
    <span class="n">grad1</span><span class="p">,</span><span class="n">grad2</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">ellipticity_grad</span><span class="p">(</span><span class="n">ref</span><span class="p">)</span>
    <span class="c1">#weights = utils.min_pt(mu1*(abs(grad1)**(-1)),mu2*(abs(grad2)**(-1)))</span>
    <span class="n">weights</span> <span class="o">=</span> <span class="n">mu1</span><span class="o">*</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">grad1</span><span class="p">)</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>
    <span class="n">thresh_type</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">im_proj</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">l_inf_ball_proj</span><span class="p">(</span><span class="n">im</span><span class="p">,</span><span class="n">weights</span><span class="p">,</span><span class="n">thresh_type</span><span class="p">,</span><span class="n">cent</span><span class="o">=</span><span class="n">ref</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">im_proj</span>

<span class="sd">&quot;&quot;&quot;def proj_ellip_param(ref,tol1,tol2,ell_ref):</span>
<span class="sd">    eps = 1e-13</span>
<span class="sd">    siz = ref.shape</span>
<span class="sd">    cent = zeros((siz[0],siz[1]))</span>
<span class="sd">    weights = zeros((siz[0],siz[1]))</span>
<span class="sd">    i,j = 0,0</span>
<span class="sd">    grad1,grad2 = utils.ellipticity_grad(ref)</span>
<span class="sd">    ind1,ind2 = where(grad1==0)</span>
<span class="sd">    grad1[ind1,ind2]=eps</span>
<span class="sd">    ind1,ind2 = where(grad2==0)</span>
<span class="sd">    grad2[ind1,ind2]=eps</span>
<span class="sd">    for i in range(0,siz[0]):</span>
<span class="sd">        for j in range(0,siz[1]):</span>
<span class="sd">            r1 = abs(ell_ref[0,0])*tol1/(abs(grad1[i,j])*siz[0]*siz[1])</span>
<span class="sd">            r2 = abs(ell_ref[0,1])*tol2/(abs(grad2[i,j])*siz[0]*siz[1])</span>
<span class="sd">            cent1 = ref[i,j]/abs(grad1[i,j])</span>
<span class="sd">            cent2 =&quot;&quot;&quot;</span>

<span class="c1">#def wvl_analysis_shap_cons(im,weights,mu=1,opt=None,coeff_init=None,mr_file=None,nb_iter=10):</span>



<span class="k">def</span> <span class="nf">sparse_deconvol_err</span><span class="p">(</span><span class="n">y</span><span class="p">,</span><span class="n">h</span><span class="p">,</span><span class="n">opt</span><span class="p">,</span><span class="n">xref</span><span class="p">,</span><span class="n">nell1</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">nell2</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">nsig</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span><span class="n">nb_rw</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">nb_iter</span><span class="o">=</span><span class="mi">20</span><span class="p">):</span>
    <span class="n">sol1</span><span class="p">,</span><span class="n">sol2</span><span class="p">,</span><span class="n">res1</span><span class="p">,</span><span class="n">res2</span><span class="p">,</span><span class="n">proj3</span> <span class="o">=</span> <span class="n">pos_spars_deconvol_shap_cons</span><span class="p">(</span><span class="n">y</span><span class="p">,</span><span class="n">h</span><span class="p">,</span><span class="n">opt</span><span class="p">,</span><span class="n">nell1</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">nell2</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">nsig</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span><span class="n">nb_rw</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">nb_iter</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
    <span class="n">centroid</span><span class="p">,</span><span class="n">U</span><span class="p">,</span><span class="n">ell_ref</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">mk_ellipticity_atoms</span><span class="p">(</span><span class="n">xref</span><span class="p">)</span>
    <span class="n">centroid</span><span class="p">,</span><span class="n">U</span><span class="p">,</span><span class="n">ell_conv</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">mk_ellipticity_atoms</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
    <span class="n">centroid</span><span class="p">,</span><span class="n">U</span><span class="p">,</span><span class="n">ell_deconv1</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">mk_ellipticity_atoms</span><span class="p">(</span><span class="n">sol1</span><span class="p">)</span>
    <span class="n">centroid</span><span class="p">,</span><span class="n">U</span><span class="p">,</span><span class="n">ell_deconv2</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">mk_ellipticity_atoms</span><span class="p">(</span><span class="n">sol2</span><span class="p">)</span>

    <span class="n">rell_err_obs</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">((</span><span class="n">ell_ref</span><span class="o">-</span><span class="n">ell_conv</span><span class="p">)</span><span class="o">/</span><span class="n">ell_conv</span><span class="p">)</span><span class="o">*</span><span class="mi">100</span>
    <span class="n">rell_err_bias1</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">((</span><span class="n">ell_ref</span><span class="o">-</span><span class="n">ell_deconv1</span><span class="p">)</span><span class="o">/</span><span class="n">ell_conv</span><span class="p">)</span><span class="o">*</span><span class="mi">100</span>
    <span class="n">rell_err_bias2</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">((</span><span class="n">ell_ref</span><span class="o">-</span><span class="n">ell_deconv2</span><span class="p">)</span><span class="o">/</span><span class="n">ell_conv</span><span class="p">)</span><span class="o">*</span><span class="mi">100</span>
    <span class="n">mse1</span> <span class="o">=</span> <span class="p">((</span><span class="n">sol1</span><span class="o">-</span><span class="n">xref</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    <span class="n">mse2</span> <span class="o">=</span> <span class="p">((</span><span class="n">sol2</span><span class="o">-</span><span class="n">xref</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">rell_err_obs</span><span class="p">,</span><span class="n">rell_err_bias1</span><span class="p">,</span><span class="n">rell_err_bias2</span><span class="p">,</span><span class="n">mse1</span><span class="p">,</span><span class="n">mse2</span><span class="p">,</span><span class="n">sol1</span><span class="p">,</span><span class="n">sol2</span><span class="p">,</span><span class="n">res1</span><span class="p">,</span><span class="n">res2</span>

<span class="k">def</span> <span class="nf">sparse_convol_err_arr</span><span class="p">(</span><span class="n">y</span><span class="p">,</span><span class="n">h</span><span class="p">,</span><span class="n">opt</span><span class="p">,</span><span class="n">xref</span><span class="p">,</span><span class="n">nell1</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">nell2</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">nsig</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span><span class="n">nb_rw</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">nb_iter</span><span class="o">=</span><span class="mi">20</span><span class="p">):</span>
    <span class="n">shap</span> <span class="o">=</span> <span class="n">y</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">nb_im</span> <span class="o">=</span> <span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>




<span class="k">def</span> <span class="nf">nul_ell_proj_pos</span><span class="p">(</span><span class="n">im</span><span class="p">,</span><span class="n">mu</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span><span class="n">nb_iter</span><span class="o">=</span><span class="mi">10</span><span class="p">):</span>
    <span class="n">u</span> <span class="o">=</span> <span class="n">im</span><span class="o">*</span><span class="mi">0</span>
    <span class="n">k</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">mat_proj</span><span class="p">,</span><span class="n">normv</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">proj_mat</span><span class="p">(</span><span class="n">im</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">shap</span> <span class="o">=</span> <span class="n">im</span><span class="o">.</span><span class="n">shape</span>

    <span class="sd">&quot;&quot;&quot;mat_proj1 = zeros((shap[0],shap[1],2))</span>
<span class="sd">    mat_proj1[:,:,0] = mat_proj[:,:,4]</span>
<span class="sd">    mat_proj1[:,:,1] = mat_proj[:,:,0]-mat_proj[:,:,1]</span>
<span class="sd">    mat_proj2 = zeros((shap[0],shap[1],3))</span>
<span class="sd">    mat_proj2[:,:,0] = mat_proj[:,:,5]</span>
<span class="sd">    mat_proj2[:,:,1] = mat_proj[:,:,0]</span>
<span class="sd">    mat_proj2[:,:,2] = mat_proj[:,:,1]&quot;&quot;&quot;</span>

    <span class="n">mat_proj3</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="mi">4</span><span class="p">))</span>
    <span class="n">mat_proj3</span><span class="p">[:,:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">mat_proj</span><span class="p">[:,:,</span><span class="mi">5</span><span class="p">]</span>
    <span class="n">mat_proj3</span><span class="p">[:,:,</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">mat_proj</span><span class="p">[:,:,</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">mat_proj3</span><span class="p">[:,:,</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">mat_proj</span><span class="p">[:,:,</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">mat_proj3</span><span class="p">[:,:,</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">mat_proj</span><span class="p">[:,:,</span><span class="mi">4</span><span class="p">]</span>
    <span class="n">ell</span><span class="o">=</span><span class="kc">None</span>
    <span class="n">proj</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_iter</span><span class="p">):</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">im</span><span class="o">-</span><span class="n">u</span>
        <span class="n">grad</span> <span class="o">=</span> <span class="o">-</span><span class="n">res</span><span class="o">+</span><span class="n">utils</span><span class="o">.</span><span class="n">proj_cube</span><span class="p">(</span><span class="n">res</span><span class="p">,</span><span class="n">mat_proj3</span><span class="p">,</span><span class="n">ortho</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">u</span> <span class="o">=</span> <span class="o">-</span><span class="n">pos_proj_mat</span><span class="p">(</span><span class="o">-</span><span class="n">u</span><span class="o">+</span><span class="n">mu</span><span class="o">*</span><span class="n">grad</span><span class="p">)</span>

    <span class="n">proj1</span> <span class="o">=</span> <span class="n">im</span><span class="o">-</span><span class="n">u</span><span class="o">-</span><span class="n">utils</span><span class="o">.</span><span class="n">proj_cube</span><span class="p">(</span><span class="n">im</span><span class="o">-</span><span class="n">u</span><span class="p">,</span><span class="n">mat_proj3</span><span class="p">,</span><span class="n">ortho</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="c1">#proj1 = pos_proj_mat(proj1)</span>
    <span class="n">centroid</span><span class="p">,</span><span class="n">v</span><span class="p">,</span><span class="n">ell1</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">mk_ellipticity_atoms</span><span class="p">(</span><span class="n">proj1</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">proj1</span><span class="p">,</span><span class="n">ell1</span>


<span class="k">def</span> <span class="nf">abs_val_proj</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">u</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">eps</span><span class="p">):</span> <span class="c1"># calculate the projection onto |&lt;u,x&gt;-b|&lt;eps</span>
    <span class="n">proj</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">abs</span><span class="p">((</span><span class="n">x</span><span class="o">*</span><span class="n">u</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">-</span><span class="n">b</span><span class="p">)</span><span class="o">&gt;</span><span class="n">eps</span><span class="p">:</span>
        <span class="n">z1</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">proj_hyp</span><span class="p">(</span><span class="n">u</span><span class="p">,</span><span class="n">eps</span><span class="o">+</span><span class="n">b</span><span class="p">,</span><span class="n">x</span><span class="p">)</span>
        <span class="n">z2</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">proj_hyp</span><span class="p">(</span><span class="o">-</span><span class="n">u</span><span class="p">,</span><span class="n">eps</span><span class="o">-</span><span class="n">b</span><span class="p">,</span><span class="n">x</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(((</span><span class="n">x</span><span class="o">-</span><span class="n">z1</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">&lt;</span><span class="p">((</span><span class="n">x</span><span class="o">-</span><span class="n">z2</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()):</span>
            <span class="n">proj</span> <span class="o">=</span> <span class="n">z1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">proj</span> <span class="o">=</span> <span class="n">z2</span>
    <span class="k">return</span> <span class="n">proj</span>

<span class="k">def</span> <span class="nf">abs_val_proj_2</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">u1</span><span class="p">,</span><span class="n">u2</span><span class="p">,</span><span class="n">c1</span><span class="p">,</span><span class="n">c2</span><span class="p">,</span><span class="n">eps1</span><span class="p">,</span><span class="n">eps2</span><span class="p">):</span> <span class="c1"># calculate the projection onto |&lt;u1,x&gt;-c1|&lt;eps1 and |&lt;u2,x&gt;-c2|&lt;eps2</span>
    <span class="n">proj</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="nb">abs</span><span class="p">((</span><span class="n">x</span><span class="o">*</span><span class="n">u1</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">-</span><span class="n">c1</span><span class="p">)</span><span class="o">&gt;</span><span class="n">eps1</span> <span class="ow">or</span> <span class="nb">abs</span><span class="p">((</span><span class="n">x</span><span class="o">*</span><span class="n">u2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">-</span><span class="n">c2</span><span class="p">)</span><span class="o">&gt;</span><span class="n">eps2</span><span class="p">):</span>
        <span class="n">shap</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span>
        <span class="n">proj_cand</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="mi">4</span><span class="p">))</span>
        <span class="n">proj_cand</span><span class="p">[:,:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">proj_2_hyp</span><span class="p">(</span><span class="n">u1</span><span class="p">,</span><span class="n">eps1</span><span class="o">+</span><span class="n">c1</span><span class="p">,</span><span class="n">u2</span><span class="p">,</span><span class="n">eps2</span><span class="o">+</span><span class="n">c2</span><span class="p">,</span><span class="n">x</span><span class="p">)</span>
        <span class="n">proj_cand</span><span class="p">[:,:,</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">proj_2_hyp</span><span class="p">(</span><span class="n">u1</span><span class="p">,</span><span class="n">eps1</span><span class="o">+</span><span class="n">c1</span><span class="p">,</span><span class="o">-</span><span class="n">u2</span><span class="p">,</span><span class="n">eps2</span><span class="o">-</span><span class="n">c2</span><span class="p">,</span><span class="n">x</span><span class="p">)</span>
        <span class="n">proj_cand</span><span class="p">[:,:,</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">proj_2_hyp</span><span class="p">(</span><span class="o">-</span><span class="n">u1</span><span class="p">,</span><span class="n">eps1</span><span class="o">-</span><span class="n">c1</span><span class="p">,</span><span class="n">u2</span><span class="p">,</span><span class="n">eps2</span><span class="o">+</span><span class="n">c2</span><span class="p">,</span><span class="n">x</span><span class="p">)</span>
        <span class="n">proj_cand</span><span class="p">[:,:,</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">proj_2_hyp</span><span class="p">(</span><span class="o">-</span><span class="n">u1</span><span class="p">,</span><span class="n">eps1</span><span class="o">-</span><span class="n">c1</span><span class="p">,</span><span class="o">-</span><span class="n">u2</span><span class="p">,</span><span class="n">eps2</span><span class="o">-</span><span class="n">c2</span><span class="p">,</span><span class="n">x</span><span class="p">)</span>

        <span class="n">i</span><span class="o">=</span><span class="mi">0</span>
        <span class="n">d</span> <span class="o">=</span> <span class="mf">1e16</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">):</span>
            <span class="n">di</span> <span class="o">=</span> <span class="p">((</span><span class="n">x</span><span class="o">-</span><span class="n">proj_cand</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">di</span> <span class="o">&lt;</span> <span class="n">d</span> <span class="p">:</span>
                <span class="n">proj</span> <span class="o">=</span> <span class="n">proj_cand</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">]</span>
                <span class="n">d</span> <span class="o">=</span><span class="n">di</span>
    <span class="k">return</span> <span class="n">proj</span>

<span class="k">def</span> <span class="nf">proj_ellip_cons_2</span><span class="p">(</span><span class="n">im</span><span class="p">,</span><span class="n">ref</span><span class="p">,</span><span class="n">mu1</span><span class="p">,</span><span class="n">mu2</span><span class="p">,</span><span class="n">grad1</span><span class="p">,</span><span class="n">grad2</span><span class="p">):</span>
    <span class="n">c1</span> <span class="o">=</span> <span class="p">(</span><span class="n">grad1</span><span class="o">*</span><span class="n">ref</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    <span class="n">c2</span> <span class="o">=</span> <span class="p">(</span><span class="n">grad2</span><span class="o">*</span><span class="n">ref</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    <span class="n">proj</span> <span class="o">=</span> <span class="n">abs_val_proj_2</span><span class="p">(</span><span class="n">im</span><span class="p">,</span><span class="n">grad1</span><span class="p">,</span><span class="n">grad2</span><span class="p">,</span><span class="n">c1</span><span class="p">,</span><span class="n">c2</span><span class="p">,</span><span class="n">mu1</span><span class="p">,</span><span class="n">mu2</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">proj</span>

<span class="k">def</span> <span class="nf">proj_dir</span><span class="p">(</span><span class="n">V</span><span class="p">,</span><span class="n">u</span><span class="p">):</span> <span class="c1"># Vectors are stored in columns, u is assumed to be a column vector</span>
    <span class="n">u1</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">u</span><span class="p">)</span>
    <span class="n">u1</span> <span class="o">=</span> <span class="n">u1</span><span class="o">/</span><span class="n">utils</span><span class="o">.</span><span class="n">norm2</span><span class="p">(</span><span class="n">u1</span><span class="p">)</span>
    <span class="n">proju_mat</span> <span class="o">=</span> <span class="n">u1</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">transpose</span><span class="p">(</span><span class="n">u1</span><span class="p">))</span>
    <span class="n">projV</span> <span class="o">=</span> <span class="n">V</span> <span class="o">-</span> <span class="n">proju_mat</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">V</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">V</span>


<span class="k">def</span> <span class="nf">proj_sphere</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">o</span><span class="p">,</span><span class="n">r</span><span class="p">):</span>
    <span class="n">proj</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">l</span> <span class="o">=</span> <span class="n">sqrt</span><span class="p">(((</span><span class="n">x</span><span class="o">-</span><span class="n">o</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span>
    <span class="k">if</span> <span class="n">l</span><span class="o">&gt;</span><span class="n">r</span><span class="p">:</span>
        <span class="n">proj</span> <span class="o">=</span> <span class="n">r</span><span class="o">*</span><span class="p">(</span><span class="n">x</span><span class="o">-</span><span class="n">o</span><span class="p">)</span><span class="o">/</span><span class="n">l</span> <span class="o">+</span> <span class="n">o</span>
    <span class="k">return</span> <span class="n">proj</span>

<span class="k">def</span> <span class="nf">proj_sphere_mat</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">o</span><span class="p">,</span><span class="n">r</span><span class="p">):</span>
    <span class="n">shap</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">i</span><span class="o">=</span><span class="mi">0</span>
    <span class="n">proj</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
        <span class="n">proj</span><span class="p">[</span><span class="n">i</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">proj_sphere</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">,:],</span><span class="n">o</span><span class="p">[</span><span class="n">i</span><span class="p">,:],</span><span class="n">r</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">proj</span>

<span class="k">def</span> <span class="nf">proj_sphere_cube</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">o</span><span class="p">,</span><span class="n">r</span><span class="p">):</span>
    <span class="n">shap</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">i</span><span class="o">=</span><span class="mi">0</span>
    <span class="n">proj</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
        <span class="n">proj</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">proj_sphere</span><span class="p">(</span><span class="n">x</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">],</span><span class="n">o</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">],</span><span class="n">r</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">proj</span>

<span class="k">def</span> <span class="nf">proj_sphere_decim</span><span class="p">(</span><span class="n">z</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">r</span><span class="p">,</span><span class="n">D</span><span class="p">):</span> <span class="c1"># z is the HR image to be projected, y is the center of the LR projection l2 sphere of radius r, D is the downsampling factor</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">z</span><span class="p">)</span>
    <span class="n">x_lr_proj</span> <span class="o">=</span> <span class="n">proj_sphere</span><span class="p">(</span><span class="n">utils</span><span class="o">.</span><span class="n">decim</span><span class="p">(</span><span class="n">z</span><span class="p">,</span><span class="n">D</span><span class="p">,</span><span class="n">av_en</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">fft</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span><span class="n">y</span><span class="p">,</span><span class="n">r</span><span class="p">)</span>
    <span class="n">shap</span> <span class="o">=</span> <span class="n">x_lr_proj</span><span class="o">.</span><span class="n">shape</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
            <span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="o">*</span><span class="n">D</span><span class="p">,</span><span class="n">j</span><span class="o">*</span><span class="n">D</span><span class="p">]</span> <span class="o">=</span> <span class="n">x_lr_proj</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">x</span>

<span class="k">def</span> <span class="nf">proj_sphere_decim_conv</span><span class="p">(</span><span class="n">z</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">r</span><span class="p">,</span><span class="n">D</span><span class="p">,</span><span class="n">ker</span><span class="p">,</span><span class="n">ker_adj</span><span class="p">):</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">proj_sphere_decim</span><span class="p">(</span><span class="n">z</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">r</span><span class="p">,</span><span class="n">D</span><span class="p">)</span>
    <span class="n">out</span> <span class="o">=</span> <span class="n">conv_pseudo_inv</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">ker</span><span class="p">,</span><span class="n">ker_adj</span><span class="p">)</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">y</span><span class="o">-</span><span class="n">utils</span><span class="o">.</span><span class="n">decim</span><span class="p">(</span><span class="n">scisig</span><span class="o">.</span><span class="n">fftconvolve</span><span class="p">(</span><span class="n">out</span><span class="p">,</span><span class="n">ker</span><span class="p">,</span><span class="n">mode</span><span class="o">=</span><span class="s1">&#39;same&#39;</span><span class="p">),</span><span class="n">D</span><span class="p">,</span><span class="n">av_en</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="nb">print</span> <span class="s2">&quot;res after inversion : &quot;</span><span class="p">,(</span><span class="n">res</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(),</span><span class="s2">&quot; reference: &quot;</span><span class="p">,</span><span class="n">r</span><span class="o">**</span><span class="mi">2</span>
    <span class="k">return</span> <span class="n">out</span>

<span class="k">def</span> <span class="nf">proj_sphere_decim_conv_pd</span><span class="p">(</span><span class="n">cur_point</span><span class="p">,</span><span class="n">o</span><span class="p">,</span><span class="n">r</span><span class="p">,</span><span class="n">D</span><span class="p">,</span><span class="n">ker</span><span class="p">,</span><span class="n">ker_adj</span><span class="p">,</span><span class="n">xinit</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">nb_iter</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span><span class="n">tol</span><span class="o">=</span><span class="mf">0.1</span><span class="p">):</span>
    <span class="n">t</span><span class="o">=</span><span class="mi">1</span>
    <span class="n">x</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">xinit</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">cur_point</span><span class="p">)</span><span class="o">*</span><span class="mi">0</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">xinit</span><span class="p">)</span>
    <span class="n">z</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">lip</span> <span class="o">=</span> <span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">ker</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span><span class="o">**</span><span class="mi">2</span>
    <span class="n">i</span><span class="o">=</span><span class="mi">0</span>
    <span class="n">cost</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">cost_old</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">out</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">z</span><span class="p">)</span>
    <span class="k">while</span><span class="p">(</span><span class="n">i</span><span class="o">&lt;</span><span class="n">nb_iter</span> <span class="ow">and</span> <span class="nb">abs</span><span class="p">(</span><span class="n">cost</span><span class="o">-</span><span class="n">cost_old</span><span class="p">)</span><span class="o">*</span><span class="mi">100</span><span class="o">/</span><span class="nb">abs</span><span class="p">(</span><span class="n">cost</span><span class="p">)</span><span class="o">&gt;</span><span class="n">tol</span><span class="p">):</span>
        <span class="n">i</span><span class="o">+=</span><span class="mi">1</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">cur_point</span> <span class="o">-</span> <span class="n">scisig</span><span class="o">.</span><span class="n">fftconvolve</span><span class="p">(</span><span class="n">z</span><span class="p">,</span><span class="n">ker_adj</span><span class="p">,</span><span class="n">mode</span><span class="o">=</span><span class="s1">&#39;same&#39;</span><span class="p">)</span>
        <span class="n">grad</span> <span class="o">=</span> <span class="o">-</span> <span class="n">scisig</span><span class="o">.</span><span class="n">fftconvolve</span><span class="p">(</span><span class="n">out</span><span class="p">,</span><span class="n">ker</span><span class="p">,</span><span class="n">mode</span><span class="o">=</span><span class="s1">&#39;same&#39;</span><span class="p">)</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">z</span> <span class="o">-</span> <span class="n">grad</span><span class="o">/</span><span class="n">lip</span>
        <span class="n">xold</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">y</span> <span class="o">-</span> <span class="n">proj_sphere_decim</span><span class="p">(</span><span class="n">y</span><span class="o">*</span><span class="n">lip</span><span class="p">,</span><span class="n">o</span><span class="p">,</span><span class="n">r</span><span class="p">,</span><span class="n">D</span><span class="p">)</span><span class="o">/</span><span class="n">lip</span> <span class="c1"># Moreau</span>
        <span class="n">told</span> <span class="o">=</span> <span class="n">t</span>
        <span class="n">t</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="mi">4</span><span class="o">*</span><span class="n">t</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span><span class="o">/</span><span class="mi">2</span>
        <span class="n">lamb</span> <span class="o">=</span> <span class="mi">1</span><span class="o">+</span><span class="p">(</span><span class="n">told</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="n">t</span>
        <span class="n">z</span> <span class="o">=</span> <span class="n">xold</span> <span class="o">+</span><span class="n">lamb</span><span class="o">*</span><span class="p">(</span><span class="n">x</span><span class="o">-</span><span class="n">xold</span><span class="p">)</span>
        <span class="n">cost_old</span> <span class="o">=</span> <span class="n">cost</span>
        <span class="n">cost</span> <span class="o">=</span> <span class="p">((</span><span class="n">cur_point</span><span class="o">-</span><span class="n">out</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="nb">print</span> <span class="s2">&quot;proj sphere cost: &quot;</span><span class="p">,(</span><span class="n">out</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    <span class="n">out</span> <span class="o">=</span> <span class="n">cur_point</span> <span class="o">-</span> <span class="n">scisig</span><span class="o">.</span><span class="n">fftconvolve</span><span class="p">(</span><span class="n">z</span><span class="p">,</span><span class="n">ker_adj</span><span class="p">,</span><span class="n">mode</span><span class="o">=</span><span class="s1">&#39;same&#39;</span><span class="p">)</span>
    <span class="nb">print</span> <span class="s2">&quot;res after inversion : &quot;</span><span class="p">,</span><span class="n">cost</span><span class="p">,</span><span class="s2">&quot; reference: &quot;</span><span class="p">,</span><span class="n">r</span><span class="o">**</span><span class="mi">2</span>
    <span class="k">return</span> <span class="n">out</span>

<span class="k">def</span> <span class="nf">proj_sphere_decim_conv_stack</span><span class="p">(</span><span class="n">z</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">r</span><span class="p">,</span><span class="n">D</span><span class="p">,</span><span class="n">ker</span><span class="p">,</span><span class="n">ker_adj</span><span class="p">):</span>
    <span class="n">zout</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">z</span><span class="p">)</span>
    <span class="n">shap</span> <span class="o">=</span> <span class="n">z</span><span class="o">.</span><span class="n">shape</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
        <span class="n">zout</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">proj_sphere_decim_conv_pd</span><span class="p">(</span><span class="n">z</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">],</span><span class="n">y</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">],</span><span class="n">r</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">D</span><span class="p">,</span><span class="n">ker</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">],</span><span class="n">ker_adj</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">zout</span>

<span class="k">def</span> <span class="nf">dyks_alg_shap_cons</span><span class="p">(</span><span class="n">im</span><span class="p">,</span><span class="n">ref</span><span class="p">,</span><span class="n">mu1</span><span class="p">,</span><span class="n">mu2</span><span class="p">,</span><span class="n">grad1</span><span class="p">,</span><span class="n">grad2</span><span class="p">,</span><span class="n">r</span><span class="p">,</span><span class="n">nb_iter</span><span class="o">=</span><span class="mi">20</span><span class="p">):</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">im</span><span class="p">)</span>
    <span class="n">p</span> <span class="o">=</span> <span class="n">x</span><span class="o">*</span><span class="mi">0</span>
    <span class="n">q</span> <span class="o">=</span> <span class="n">x</span><span class="o">*</span><span class="mi">0</span>
    <span class="n">i</span><span class="o">=</span><span class="mi">0</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_iter</span><span class="p">):</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">proj_sphere</span><span class="p">(</span><span class="n">x</span><span class="o">+</span><span class="n">p</span><span class="p">,</span><span class="n">ref</span><span class="p">,</span><span class="n">r</span><span class="p">)</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">x</span><span class="o">+</span><span class="n">p</span><span class="o">-</span><span class="n">y</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">proj_ellip_cons_2</span><span class="p">(</span><span class="n">y</span><span class="o">+</span><span class="n">q</span><span class="p">,</span><span class="n">ref</span><span class="p">,</span><span class="n">mu1</span><span class="p">,</span><span class="n">mu2</span><span class="p">,</span><span class="n">grad1</span><span class="p">,</span><span class="n">grad2</span><span class="p">)</span>
        <span class="n">q</span> <span class="o">=</span> <span class="n">y</span><span class="o">+</span><span class="n">q</span><span class="o">-</span><span class="n">x</span>

    <span class="n">rest</span> <span class="o">=</span> <span class="n">sqrt</span><span class="p">(((</span><span class="n">x</span><span class="o">-</span><span class="n">ref</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span>
    <span class="nb">print</span> <span class="s1">&#39;target radius: &#39;</span><span class="p">,</span><span class="n">r</span><span class="p">,</span><span class="s1">&#39; radius achieved: &#39;</span><span class="p">,</span><span class="n">rest</span>
    <span class="k">return</span> <span class="n">x</span>

<span class="k">def</span> <span class="nf">poc_shap_cons</span><span class="p">(</span><span class="n">im</span><span class="p">,</span><span class="n">ref</span><span class="p">,</span><span class="n">mu1</span><span class="p">,</span><span class="n">mu2</span><span class="p">,</span><span class="n">grad1</span><span class="p">,</span><span class="n">grad2</span><span class="p">,</span><span class="n">r</span><span class="p">,</span><span class="n">nb_iter</span><span class="o">=</span><span class="mi">20</span><span class="p">):</span>
    <span class="n">proj</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">im</span><span class="p">)</span>
    <span class="n">i</span><span class="o">=</span><span class="mi">0</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_iter</span><span class="p">):</span>
        <span class="n">proj</span> <span class="o">=</span> <span class="n">proj_sphere</span><span class="p">(</span><span class="n">proj_ellip_cons_2</span><span class="p">(</span><span class="n">proj</span><span class="p">,</span><span class="n">ref</span><span class="p">,</span><span class="n">mu1</span><span class="p">,</span><span class="n">mu2</span><span class="p">,</span><span class="n">grad1</span><span class="p">,</span><span class="n">grad2</span><span class="p">),</span><span class="n">ref</span><span class="p">,</span><span class="n">r</span><span class="p">)</span>
    <span class="n">rest</span> <span class="o">=</span> <span class="n">sqrt</span><span class="p">(((</span><span class="n">proj</span><span class="o">-</span><span class="n">ref</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span>
    <span class="nb">print</span> <span class="s1">&#39;target radius: &#39;</span><span class="p">,</span><span class="n">r</span><span class="p">,</span><span class="s1">&#39; radius achieved: &#39;</span><span class="p">,</span><span class="n">rest</span>

    <span class="k">return</span> <span class="n">proj</span>


<span class="k">def</span> <span class="nf">least_square_desc_steep</span><span class="p">(</span><span class="n">y</span><span class="p">,</span><span class="n">x</span><span class="p">,</span><span class="n">u</span><span class="p">,</span><span class="n">t</span><span class="p">):</span>
    <span class="n">topt</span> <span class="o">=</span> <span class="p">((</span><span class="n">y</span><span class="o">-</span><span class="n">x</span><span class="p">)</span><span class="o">*</span><span class="n">u</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">/</span><span class="p">((</span><span class="n">u</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span>
    <span class="n">steepness</span> <span class="o">=</span> <span class="n">t</span><span class="o">*</span><span class="p">((</span><span class="n">u</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span><span class="o">-</span><span class="p">((</span><span class="n">y</span><span class="o">-</span><span class="n">x</span><span class="p">)</span><span class="o">*</span><span class="n">u</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">topt</span><span class="p">,</span><span class="n">steepness</span>


<span class="k">def</span> <span class="nf">lsq_ell_desc_check</span><span class="p">(</span><span class="n">dir_stack</span><span class="p">,</span><span class="n">ref_ell</span><span class="p">,</span><span class="n">cur_point</span><span class="p">,</span><span class="n">y</span><span class="p">):</span>
    <span class="n">siz</span> <span class="o">=</span> <span class="n">dir_stack</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">opt_step_lsq</span><span class="o">=</span><span class="mi">0</span>
    <span class="n">opt_step</span><span class="o">=</span><span class="mi">0</span>
    <span class="n">lsq_steepness</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">siz</span><span class="p">[</span><span class="mi">2</span><span class="p">],))</span>
    <span class="n">dir_cand</span><span class="p">,</span><span class="n">ell_steepness</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">dir_check</span><span class="p">(</span><span class="n">dir_stack</span><span class="p">,</span><span class="n">ref_ell</span><span class="p">,</span><span class="n">cur_point</span><span class="p">)</span>
    <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">rmax</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">lsq_max_steep</span><span class="o">=</span><span class="mi">0</span>
    <span class="n">dir_id</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
    <span class="n">pinf</span><span class="o">=</span><span class="kc">False</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">siz</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
        <span class="n">topti</span><span class="p">,</span><span class="n">steepnessi</span> <span class="o">=</span> <span class="n">least_square_desc_steep</span><span class="p">(</span><span class="n">y</span><span class="p">,</span><span class="n">cur_point</span><span class="p">,</span><span class="n">dir_stack</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">],</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">steepnessi</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">dir_cand</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">==</span><span class="mi">1</span><span class="p">):</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">ell_steepness</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">==</span><span class="mi">0</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">ell_steepness</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">==</span><span class="mi">0</span><span class="p">):</span>
                <span class="n">pinf</span><span class="o">=</span><span class="kc">True</span>
                <span class="k">if</span> <span class="p">(</span><span class="o">-</span><span class="n">steepnessi</span><span class="o">&gt;</span><span class="n">lsq_max_steep</span><span class="p">):</span>
                    <span class="n">dir_id</span> <span class="o">=</span> <span class="n">i</span>
                    <span class="n">lsq_max_steep</span> <span class="o">=</span> <span class="o">-</span><span class="n">steepnessi</span>
                    <span class="n">opt_step_lsq</span> <span class="o">=</span> <span class="n">topti</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">pinf</span><span class="o">==</span><span class="kc">False</span><span class="p">:</span>
                    <span class="n">ri</span> <span class="o">=</span> <span class="o">-</span><span class="n">steepnessi</span><span class="o">*</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">ell_steepness</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">+</span><span class="nb">abs</span><span class="p">(</span><span class="n">ell_steepness</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">1</span><span class="p">])</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>
                    <span class="k">if</span> <span class="n">ri</span><span class="o">&gt;</span><span class="n">rmax</span><span class="p">:</span>
                        <span class="n">dir_id</span> <span class="o">=</span> <span class="n">i</span>
                        <span class="n">rmax</span> <span class="o">=</span> <span class="n">ri</span>
                        <span class="n">opt_step_lsq</span> <span class="o">=</span> <span class="n">topti</span>

    <span class="k">if</span> <span class="n">opt_step_lsq</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
        <span class="n">root_ell1</span><span class="p">,</span><span class="n">root_ell2</span><span class="p">,</span><span class="n">root_ell3</span><span class="p">,</span><span class="n">root_ell4</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">ellt_zeros</span><span class="p">(</span><span class="n">cur_point</span><span class="p">,</span><span class="n">dir_stack</span><span class="p">[:,:,</span><span class="n">dir_id</span><span class="p">])</span>
        <span class="n">roots</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="mi">8</span><span class="p">,))</span>
        <span class="n">roots</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">root_ell1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">roots</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">root_ell1</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">roots</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">root_ell2</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">roots</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">root_ell2</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">roots</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">root_ell3</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">roots</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="n">root_ell3</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">roots</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="n">root_ell4</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">roots</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="n">root_ell4</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">ind</span> <span class="o">=</span> <span class="n">where</span><span class="p">((</span><span class="n">imag</span><span class="p">(</span><span class="n">roots</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">size</span><span class="p">(</span><span class="n">ind</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
            <span class="n">opt_step</span> <span class="o">=</span> <span class="n">opt_step_lsq</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">roots_real</span> <span class="o">=</span> <span class="n">roots</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span>
            <span class="n">ind2</span> <span class="o">=</span> <span class="n">where</span><span class="p">(</span><span class="n">roots_real</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">size</span><span class="p">(</span><span class="n">ind2</span><span class="p">)</span> <span class="o">==</span><span class="mi">0</span><span class="p">:</span>
                <span class="n">opt_step</span> <span class="o">=</span> <span class="n">opt_step_lsq</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">roots_real_pos</span> <span class="o">=</span> <span class="n">roots_real</span><span class="p">[</span><span class="n">ind2</span><span class="p">]</span>
                <span class="n">opt_step</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">opt_step_lsq</span><span class="p">,</span><span class="n">roots_real_pos</span><span class="o">.</span><span class="n">min</span><span class="p">())</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span> <span class="s2">&quot;Failed to find a descend direction&quot;</span>
        <span class="n">ell_steepness_l1</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">ell_steepness</span><span class="p">[:,</span><span class="mi">0</span><span class="p">])</span><span class="o">+</span><span class="nb">abs</span><span class="p">(</span><span class="n">ell_steepness</span><span class="p">[:,</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">dir_id_temp</span> <span class="o">=</span> <span class="n">where</span><span class="p">(</span><span class="n">ell_steepness_l1</span><span class="o">==</span><span class="n">ell_steepness_l1</span><span class="o">.</span><span class="n">min</span><span class="p">())</span>
        <span class="k">if</span> <span class="nb">sum</span><span class="p">(</span><span class="n">shape</span><span class="p">(</span><span class="n">dir_id_temp</span><span class="p">))</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">dir_id</span> <span class="o">=</span> <span class="n">dir_id_temp</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">dir_id</span> <span class="o">=</span> <span class="n">dir_id_temp</span>
        <span class="n">toptid</span><span class="p">,</span><span class="n">steepnessid</span> <span class="o">=</span> <span class="n">least_square_desc_steep</span><span class="p">(</span><span class="n">y</span><span class="p">,</span><span class="n">cur_point</span><span class="p">,</span><span class="n">dir_stack</span><span class="p">[:,:,</span><span class="n">dir_id</span><span class="p">],</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">root_ell1</span><span class="p">,</span><span class="n">root_ell2</span><span class="p">,</span><span class="n">root_ell3</span><span class="p">,</span><span class="n">root_ell4</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">ellt_zeros</span><span class="p">(</span><span class="n">cur_point</span><span class="p">,</span><span class="n">dir_stack</span><span class="p">[:,:,</span><span class="n">dir_id</span><span class="p">])</span>
        <span class="n">roots</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="mi">8</span><span class="p">,))</span>
        <span class="n">roots</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">root_ell1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">roots</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">root_ell1</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">roots</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">root_ell2</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">roots</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">root_ell2</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">roots</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">root_ell3</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">roots</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="n">root_ell3</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">roots</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="n">root_ell4</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">roots</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="n">root_ell4</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">ind</span> <span class="o">=</span> <span class="n">where</span><span class="p">((</span><span class="n">imag</span><span class="p">(</span><span class="n">roots</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">size</span><span class="p">(</span><span class="n">ind</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
            <span class="n">opt_step</span> <span class="o">=</span> <span class="n">toptid</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">toptid</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
                <span class="n">roots_real</span> <span class="o">=</span> <span class="n">roots</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span>
                <span class="n">ind2</span> <span class="o">=</span> <span class="n">where</span><span class="p">(</span><span class="n">roots_real</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">size</span><span class="p">(</span><span class="n">ind2</span><span class="p">)</span> <span class="o">==</span><span class="mi">0</span><span class="p">:</span>
                    <span class="n">opt_step</span> <span class="o">=</span> <span class="n">toptid</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">roots_real_pos</span> <span class="o">=</span> <span class="n">roots_real</span><span class="p">[</span><span class="n">ind2</span><span class="p">]</span>
                    <span class="n">opt_step</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">toptid</span><span class="p">,</span><span class="n">roots_real_pos</span><span class="o">.</span><span class="n">min</span><span class="p">())</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">roots_real</span> <span class="o">=</span> <span class="n">roots</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span>
                <span class="n">ind2</span> <span class="o">=</span> <span class="n">where</span><span class="p">(</span><span class="n">roots_real</span><span class="o">&lt;=</span><span class="mi">0</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">size</span><span class="p">(</span><span class="n">ind2</span><span class="p">)</span> <span class="o">==</span><span class="mi">0</span><span class="p">:</span>
                    <span class="n">opt_step</span> <span class="o">=</span> <span class="n">toptid</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">roots_real_neg</span> <span class="o">=</span> <span class="n">roots_real</span><span class="p">[</span><span class="n">ind2</span><span class="p">]</span>
                    <span class="n">opt_step</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">toptid</span><span class="p">,</span><span class="n">roots_real_neg</span><span class="o">.</span><span class="n">max</span><span class="p">())</span>

    <span class="k">return</span> <span class="n">opt_step</span><span class="p">,</span><span class="n">dir_id</span>

<span class="k">def</span> <span class="nf">ell_controled_fit</span><span class="p">(</span><span class="n">y</span><span class="p">,</span><span class="n">init_pt</span><span class="p">,</span><span class="n">nb_iter</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span><span class="n">nb_comp</span><span class="o">=</span><span class="mi">2000</span><span class="p">):</span>
    <span class="n">output</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">init_pt</span><span class="p">)</span>
    <span class="n">centroid</span><span class="p">,</span><span class="n">U</span><span class="p">,</span><span class="n">ref_ell</span><span class="o">=</span><span class="n">utils</span><span class="o">.</span><span class="n">mk_ellipticity_atoms</span><span class="p">(</span><span class="n">output</span><span class="p">)</span>
    <span class="n">centroid</span><span class="p">,</span><span class="n">U</span><span class="p">,</span><span class="n">fit_ell</span><span class="o">=</span><span class="n">utils</span><span class="o">.</span><span class="n">mk_ellipticity_atoms</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
    <span class="n">i</span><span class="o">=</span><span class="mi">0</span>
    <span class="n">test_ell</span><span class="o">=</span><span class="kc">None</span>

    <span class="nb">print</span> <span class="s1">&#39;Ref Ell: &#39;</span><span class="p">,</span><span class="n">ref_ell</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_iter</span><span class="p">):</span>
        <span class="nb">print</span> <span class="s1">&#39;mse: &#39;</span><span class="p">,((</span><span class="n">y</span><span class="o">-</span><span class="n">output</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="n">grad_lsq</span> <span class="o">=</span> <span class="o">-</span><span class="n">y</span><span class="o">+</span><span class="n">output</span>
        <span class="n">grad1_ell</span><span class="p">,</span><span class="n">grad2_ell</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">ellipticity_grad</span><span class="p">(</span><span class="n">output</span><span class="p">)</span>

        <span class="n">com_stack</span><span class="p">,</span><span class="n">comb_coeff</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">rand_lin_comb</span><span class="p">(</span><span class="n">grad_lsq</span><span class="p">,</span><span class="n">grad1_ell</span><span class="p">,</span><span class="n">grad2_ell</span><span class="p">,</span><span class="n">nb_comp</span><span class="p">)</span>
        <span class="n">centroid</span><span class="p">,</span><span class="n">U</span><span class="p">,</span><span class="n">ref_ell</span><span class="o">=</span><span class="n">utils</span><span class="o">.</span><span class="n">mk_ellipticity_atoms</span><span class="p">(</span><span class="n">output</span><span class="p">)</span>
        <span class="n">opt_step</span><span class="p">,</span><span class="n">dir_id</span> <span class="o">=</span> <span class="n">lsq_ell_desc_check</span><span class="p">(</span><span class="n">com_stack</span><span class="p">,</span><span class="n">ref_ell</span><span class="p">,</span><span class="n">output</span><span class="p">,</span><span class="n">y</span><span class="p">)</span>

        <span class="n">output</span> <span class="o">=</span> <span class="n">output</span><span class="o">+</span><span class="n">opt_step</span><span class="o">*</span><span class="n">com_stack</span><span class="p">[:,:,</span><span class="n">dir_id</span><span class="p">]</span>

        <span class="n">centroid</span><span class="p">,</span><span class="n">U</span><span class="p">,</span><span class="n">test_ell</span><span class="o">=</span><span class="n">utils</span><span class="o">.</span><span class="n">mk_ellipticity_atoms</span><span class="p">(</span><span class="n">output</span><span class="p">)</span>

        <span class="nb">print</span> <span class="s1">&#39;Test Ell: &#39;</span><span class="p">,</span><span class="n">test_ell</span>

        <span class="nb">print</span> <span class="s1">&#39;Dir: &#39;</span><span class="p">,</span><span class="n">comb_coeff</span><span class="p">[</span><span class="n">dir_id</span><span class="p">,:],</span><span class="s1">&#39;; step: &#39;</span><span class="p">,</span><span class="n">opt_step</span>

    <span class="k">return</span> <span class="n">output</span><span class="p">,</span><span class="n">ref_ell</span><span class="p">,</span><span class="n">test_ell</span><span class="p">,</span><span class="n">fit_ell</span>




<span class="k">def</span> <span class="nf">prox_ellipsoid</span><span class="p">(</span><span class="n">alpha</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">M</span><span class="p">,</span><span class="n">mu</span><span class="p">,</span><span class="n">r</span><span class="p">,</span><span class="n">nb_iter</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span><span class="n">u_init</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span> <span class="c1"># projection of alpha on {x/||y-Mx||^2&lt;r^2}</span>


    <span class="n">shap</span> <span class="o">=</span> <span class="n">M</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">if</span> <span class="n">u_init</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">u_init</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="mi">1</span><span class="p">))</span>
    <span class="n">o</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="mi">1</span><span class="p">))</span>
    <span class="n">u</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">u_init</span><span class="p">)</span>
    <span class="n">p</span> <span class="o">=</span> <span class="n">alpha</span> <span class="o">-</span> <span class="n">transpose</span><span class="p">(</span><span class="n">M</span><span class="p">)</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">u_init</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_iter</span><span class="p">):</span>
        <span class="n">z</span> <span class="o">=</span> <span class="n">u</span><span class="o">/</span><span class="n">mu</span> <span class="o">+</span> <span class="n">M</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">p</span><span class="p">)</span><span class="o">-</span><span class="n">y</span>
        <span class="n">u</span> <span class="o">=</span> <span class="n">mu</span><span class="o">*</span><span class="p">(</span><span class="n">z</span><span class="o">-</span><span class="n">proj_sphere</span><span class="p">(</span><span class="n">z</span><span class="p">,</span><span class="n">o</span><span class="p">,</span><span class="n">r</span><span class="p">))</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">alpha</span> <span class="o">-</span> <span class="n">transpose</span><span class="p">(</span><span class="n">M</span><span class="p">)</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">u</span><span class="p">)</span>
    <span class="nb">print</span> <span class="s1">&#39;radius :&#39;</span><span class="p">,</span><span class="n">r</span><span class="p">,</span><span class="s1">&#39; Current dist: &#39;</span><span class="p">,</span><span class="n">sqrt</span><span class="p">(((</span><span class="n">y</span><span class="o">-</span><span class="n">M</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">p</span><span class="p">))</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span>
    <span class="n">u_init</span> <span class="o">=</span> <span class="n">u</span>
    <span class="k">return</span> <span class="n">p</span><span class="p">,</span><span class="n">u_init</span>

<span class="k">def</span> <span class="nf">shap_cons_denoising</span><span class="p">(</span><span class="n">obs</span><span class="p">,</span><span class="n">opt</span><span class="p">,</span><span class="n">nsig</span><span class="p">,</span><span class="n">nb_iter</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span><span class="n">nb_rw</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
    <span class="n">siz</span> <span class="o">=</span> <span class="n">obs</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">obs_vect</span> <span class="o">=</span> <span class="n">obs</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">obs</span><span class="o">.</span><span class="n">size</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>
    <span class="n">Mshap</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">proj_mat_2</span><span class="p">(</span><span class="n">siz</span><span class="p">)</span>
    <span class="n">inv_cor</span> <span class="o">=</span> <span class="n">LA</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">Mshap</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">transpose</span><span class="p">(</span><span class="n">Mshap</span><span class="p">)))</span>
    <span class="n">U</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">Vt</span> <span class="o">=</span> <span class="n">linalg</span><span class="o">.</span><span class="n">svd</span><span class="p">(</span><span class="n">inv_cor</span><span class="p">,</span><span class="n">full_matrices</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">S</span> <span class="o">=</span> <span class="n">sqrt</span><span class="p">(</span><span class="n">diag</span><span class="p">(</span><span class="n">s</span><span class="p">))</span>
    <span class="n">inv_cor_sqrt</span> <span class="o">=</span> <span class="n">U</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">S</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">Vt</span><span class="p">))</span>
    <span class="n">Mshap_white</span> <span class="o">=</span> <span class="n">inv_cor_sqrt</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">Mshap</span><span class="p">)</span>
    <span class="n">U</span><span class="p">,</span> <span class="n">s0</span><span class="p">,</span> <span class="n">Vt</span> <span class="o">=</span> <span class="n">linalg</span><span class="o">.</span><span class="n">svd</span><span class="p">(</span><span class="n">Mshap_white</span><span class="p">,</span><span class="n">full_matrices</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">obs_proj</span> <span class="o">=</span> <span class="n">Mshap_white</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">obs_vect</span><span class="p">)</span>

    <span class="n">i</span><span class="o">=</span><span class="mi">0</span>
    <span class="n">z1</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">obs</span><span class="p">)</span><span class="o">*</span><span class="mi">0</span>
    <span class="n">z2</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">obs</span><span class="p">)</span><span class="o">*</span><span class="mi">0</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">obs</span><span class="p">)</span><span class="o">*</span><span class="mi">0</span>
    <span class="c1">#z3 = copy(obs)*0</span>
    <span class="n">w1</span> <span class="o">=</span> <span class="mf">0.5</span>
    <span class="n">w2</span> <span class="o">=</span> <span class="mf">0.5</span>
    <span class="n">mu</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">lambd</span> <span class="o">=</span> <span class="mf">1.5</span>

    <span class="n">coeff_init</span><span class="o">=</span><span class="kc">None</span>
    <span class="n">mr_file</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">weights</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">u_init</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">nb_subiter1</span> <span class="o">=</span> <span class="mi">50</span>
    <span class="n">nb_subiter2</span> <span class="o">=</span> <span class="mi">50</span>
    <span class="n">l</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_rw</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_iter</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
                <span class="n">nb_subiter1</span> <span class="o">=</span> <span class="mi">5</span>
                <span class="n">nb_subiter2</span> <span class="o">=</span> <span class="mi">50</span>
            <span class="n">grad</span> <span class="o">=</span> <span class="n">x</span><span class="o">-</span><span class="n">obs</span>
            <span class="c1"># ---- Analysis constraint ---- #</span>
            <span class="c1"># Wavelet noise estimation</span>
            <span class="n">sig_map</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">res_sig_map</span><span class="p">(</span><span class="n">grad</span><span class="o">*</span><span class="n">mu</span><span class="p">,</span><span class="n">opt</span><span class="o">=</span><span class="n">opt</span><span class="p">)</span>
            <span class="n">thresh_map</span> <span class="o">=</span> <span class="n">nsig</span><span class="o">*</span><span class="n">sig_map</span>
            <span class="k">if</span> <span class="n">weights</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">thresh_map</span> <span class="o">=</span> <span class="n">thresh_map</span><span class="o">*</span><span class="n">weights</span>
            <span class="c1"># Prox step</span>
            <span class="n">temp1</span><span class="p">,</span><span class="n">mr_file</span><span class="p">,</span><span class="n">n</span><span class="p">,</span><span class="n">coeff_init</span> <span class="o">=</span> <span class="n">wvl_analysis_op</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">x</span><span class="o">-</span><span class="n">z1</span><span class="o">-</span><span class="n">mu</span><span class="o">*</span><span class="n">grad</span><span class="p">,</span><span class="n">thresh_map</span><span class="p">,</span><span class="n">opt</span><span class="o">=</span><span class="n">opt</span><span class="p">,</span><span class="n">coeff_init</span><span class="o">=</span><span class="n">coeff_init</span><span class="p">,</span><span class="n">mr_file</span><span class="o">=</span><span class="n">mr_file</span><span class="p">,</span><span class="n">nb_iter</span><span class="o">=</span><span class="n">nb_subiter1</span><span class="p">)</span>
            <span class="n">z1</span> <span class="o">=</span> <span class="n">z1</span><span class="o">+</span><span class="n">lambd</span><span class="o">*</span><span class="p">(</span><span class="n">temp1</span><span class="o">-</span><span class="n">x</span><span class="p">)</span>

            <span class="c1"># ---- Shape constraint ---- #</span>
            <span class="c1"># Image noise est</span>
            <span class="n">sig</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">im_gauss_nois_est</span><span class="p">(</span><span class="n">grad</span><span class="p">)</span>
            <span class="nb">print</span> <span class="s1">&#39;sig :&#39;</span><span class="p">,</span><span class="n">sig</span>
            <span class="n">temp2</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">x</span><span class="o">-</span><span class="n">z2</span><span class="o">-</span><span class="n">mu</span><span class="o">*</span><span class="n">grad</span>
            <span class="n">temp2_vect</span> <span class="o">=</span> <span class="n">temp2</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">temp2</span><span class="o">.</span><span class="n">size</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>
            <span class="n">mat_in</span> <span class="o">=</span> <span class="n">Mshap_white</span>
            <span class="n">temp3</span><span class="p">,</span><span class="n">u_init</span> <span class="o">=</span> <span class="n">prox_ellipsoid</span><span class="p">(</span><span class="n">temp2_vect</span><span class="p">,</span><span class="n">obs_proj</span><span class="p">,</span><span class="n">mat_in</span><span class="p">,</span><span class="mf">0.5</span><span class="o">/</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">s0</span><span class="p">)</span><span class="o">.</span><span class="n">max</span><span class="p">()),</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span><span class="o">*</span><span class="n">sig</span><span class="o">*</span><span class="mf">0.5</span><span class="p">,</span><span class="n">nb_iter</span><span class="o">=</span><span class="n">nb_subiter2</span><span class="p">)</span>
            <span class="n">temp3</span> <span class="o">=</span> <span class="n">temp3</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">siz</span><span class="p">)</span>
            <span class="n">z2</span> <span class="o">=</span> <span class="n">z2</span><span class="o">+</span><span class="n">lambd</span><span class="o">*</span><span class="p">(</span><span class="n">temp3</span><span class="o">-</span><span class="n">x</span><span class="p">)</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">w1</span><span class="o">*</span><span class="n">z1</span><span class="o">+</span><span class="n">w2</span><span class="o">*</span><span class="n">z2</span>
            <span class="n">centroid</span><span class="p">,</span><span class="n">U</span><span class="p">,</span><span class="n">test_ell</span><span class="o">=</span><span class="n">utils</span><span class="o">.</span><span class="n">mk_ellipticity_atoms</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
            <span class="nb">print</span> <span class="s1">&#39;Current ellipticity: &#39;</span><span class="p">,</span><span class="n">test_ell</span>

        <span class="c1"># ---- Weights update ---- #</span>
        <span class="n">coeffx</span><span class="p">,</span><span class="n">mr_file</span> <span class="o">=</span> <span class="n">isap</span><span class="o">.</span><span class="n">mr_trans</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">opt</span><span class="o">=</span><span class="n">opt</span><span class="p">)</span>
        <span class="n">weights</span>  <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="nb">abs</span><span class="p">(</span><span class="n">coeffx</span><span class="p">[:,:,:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span><span class="o">/</span><span class="p">(</span><span class="n">nsig</span><span class="o">*</span><span class="n">sig_map</span><span class="p">))</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">x</span>

<span class="k">def</span> <span class="nf">analysis_rw_denoising</span><span class="p">(</span><span class="n">obs</span><span class="p">,</span><span class="n">opt</span><span class="p">,</span><span class="n">nsig</span><span class="p">,</span><span class="n">nb_iter</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span><span class="n">nb_rw</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
    <span class="n">siz</span> <span class="o">=</span> <span class="n">obs</span><span class="o">.</span><span class="n">shape</span>

    <span class="n">i</span><span class="o">=</span><span class="mi">0</span>
    <span class="n">z1</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">obs</span><span class="p">)</span><span class="o">*</span><span class="mi">0</span>
    <span class="n">z2</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">obs</span><span class="p">)</span><span class="o">*</span><span class="mi">0</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">obs</span><span class="p">)</span><span class="o">*</span><span class="mi">0</span>
    <span class="n">mu</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="n">coeff_init</span><span class="o">=</span><span class="kc">None</span>
    <span class="n">mr_file</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">weights</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">nb_subiter</span> <span class="o">=</span> <span class="mi">50</span>
    <span class="n">l</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_rw</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">l</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
            <span class="n">nb_iter</span><span class="o">=</span><span class="mi">1</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_iter</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
                <span class="n">nb_subiter</span> <span class="o">=</span> <span class="mi">5</span>

            <span class="n">grad</span> <span class="o">=</span> <span class="n">x</span><span class="o">-</span><span class="n">obs</span>
            <span class="c1"># ---- Analysis constraint ---- #</span>
            <span class="c1"># Wavelet noise estimation</span>
            <span class="n">sig_map</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">res_sig_map</span><span class="p">(</span><span class="n">grad</span><span class="o">*</span><span class="n">mu</span><span class="p">,</span><span class="n">opt</span><span class="o">=</span><span class="n">opt</span><span class="p">)</span>
            <span class="n">thresh_map</span> <span class="o">=</span> <span class="n">nsig</span><span class="o">*</span><span class="n">sig_map</span>
            <span class="k">if</span> <span class="n">weights</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">thresh_map</span> <span class="o">=</span> <span class="n">thresh_map</span><span class="o">*</span><span class="n">weights</span>
            <span class="c1"># Prox step</span>
            <span class="n">x</span><span class="p">,</span><span class="n">mr_file</span><span class="p">,</span><span class="n">n</span><span class="p">,</span><span class="n">coeff_init</span> <span class="o">=</span> <span class="n">wvl_analysis_op</span><span class="p">(</span><span class="n">x</span><span class="o">-</span><span class="n">mu</span><span class="o">*</span><span class="n">grad</span><span class="p">,</span><span class="n">thresh_map</span><span class="p">,</span><span class="n">opt</span><span class="o">=</span><span class="n">opt</span><span class="p">,</span><span class="n">coeff_init</span><span class="o">=</span><span class="n">coeff_init</span><span class="p">,</span><span class="n">mr_file</span><span class="o">=</span><span class="n">mr_file</span><span class="p">,</span><span class="n">nb_iter</span><span class="o">=</span><span class="n">nb_subiter</span><span class="p">)</span>
            <span class="n">centroid</span><span class="p">,</span><span class="n">U</span><span class="p">,</span><span class="n">test_ell</span><span class="o">=</span><span class="n">utils</span><span class="o">.</span><span class="n">mk_ellipticity_atoms</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
            <span class="nb">print</span> <span class="s1">&#39;Current ellipticity: &#39;</span><span class="p">,</span><span class="n">test_ell</span>

        <span class="c1"># ------- Weights update ------- #</span>
        <span class="n">coeffx</span><span class="p">,</span><span class="n">mr_file</span> <span class="o">=</span> <span class="n">isap</span><span class="o">.</span><span class="n">mr_trans</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">opt</span><span class="o">=</span><span class="n">opt</span><span class="p">)</span>
        <span class="n">weights</span>  <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="nb">abs</span><span class="p">(</span><span class="n">coeffx</span><span class="p">[:,:,:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span><span class="o">/</span><span class="p">(</span><span class="n">nsig</span><span class="o">*</span><span class="n">sig_map</span><span class="p">))</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">x</span>


<span class="k">def</span> <span class="nf">lin_prog_transp</span><span class="p">(</span><span class="n">distrib1</span><span class="p">,</span><span class="n">distrib2</span><span class="p">,</span><span class="n">dist_map</span><span class="p">):</span>

    <span class="n">siz</span> <span class="o">=</span> <span class="n">dist_map</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">dist_vect</span> <span class="o">=</span> <span class="n">dist_map</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">siz</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">siz</span><span class="p">[</span><span class="mi">1</span><span class="p">],))</span>
    <span class="n">eq_vect</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="mi">2</span><span class="o">*</span><span class="n">siz</span><span class="p">[</span><span class="mi">0</span><span class="p">],))</span>
    <span class="n">eq_vect</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">siz</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="n">distrib1</span>
    <span class="n">eq_vect</span><span class="p">[</span><span class="n">siz</span><span class="p">[</span><span class="mi">0</span><span class="p">]:]</span> <span class="o">=</span> <span class="n">distrib2</span>
    <span class="n">mat_eq</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="mi">2</span><span class="o">*</span><span class="n">siz</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">siz</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">siz</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">siz</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
        <span class="n">mat_eq</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">i</span><span class="o">*</span><span class="n">siz</span><span class="p">[</span><span class="mi">0</span><span class="p">]:(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">siz</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="n">ones</span><span class="p">((</span><span class="n">siz</span><span class="p">[</span><span class="mi">0</span><span class="p">],))</span>
        <span class="n">mat_eq</span><span class="p">[</span><span class="n">siz</span><span class="p">[</span><span class="mi">0</span><span class="p">]:,</span><span class="n">i</span><span class="o">*</span><span class="n">siz</span><span class="p">[</span><span class="mi">0</span><span class="p">]:(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">siz</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="n">eye</span><span class="p">(</span><span class="n">siz</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">mat_uq</span> <span class="o">=</span> <span class="o">-</span><span class="n">eye</span><span class="p">(</span><span class="n">siz</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">siz</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">uq_vect</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">siz</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">siz</span><span class="p">[</span><span class="mi">1</span><span class="p">],))</span>
    <span class="n">optim_res</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">optimize</span><span class="o">.</span><span class="n">linprog</span><span class="p">(</span><span class="n">dist_vect</span><span class="p">,</span><span class="n">A_ub</span><span class="o">=</span><span class="n">mat_uq</span><span class="p">,</span><span class="n">b_ub</span><span class="o">=</span><span class="n">uq_vect</span><span class="p">,</span><span class="n">A_eq</span><span class="o">=</span><span class="n">mat_eq</span><span class="p">,</span><span class="n">b_eq</span> <span class="o">=</span> <span class="n">eq_vect</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">optim_res</span><span class="o">.</span><span class="n">x</span>
    <span class="n">mapping</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">siz</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">siz</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>


    <span class="k">return</span> <span class="n">mapping</span><span class="p">,</span><span class="n">optim_res</span>


<span class="sd">&quot;&quot;&quot;def lin_prog_transp_bar(distrib_mat,dist_map,weights): # The distributions are in distrib_mat columns</span>
<span class="sd">    siz = distrib_mat.shape</span>
<span class="sd">    dist_vect = dist_map.reshape((siz[0]**2,))</span>
<span class="sd">    dist_vect_n = zeros((siz[1]*siz[0]**2,))</span>
<span class="sd">    for i in range(0,siz[1]):</span>
<span class="sd">        dist_vect_n[i*siz[0]**2:(i+1)*siz[0]**2] = weights[i]*dist_vect</span>
<span class="sd">    distrib_vect = reshape(distrib_mat,(siz[1]*siz[0],),&#39;F&#39;) # reshaping in columns order</span>
<span class="sd">    mat_eq = zeros(((2*siz[1]-1)*siz[0],siz[1]*siz[0]**2))</span>
<span class="sd">    for i in range(0,siz[0]):</span>
<span class="sd">        for j in range(0,siz[1]):</span>
<span class="sd">            mat_eq[j*siz[0]+i,j*siz[0]**2+i*siz[0]:j*siz[0]**2+(i+1)*siz[0]] = ones((siz[0],))</span>
<span class="sd">            if j&lt;siz[1]-1:</span>
<span class="sd">                mat_eq[siz[0]*siz[1]+:,i*siz[0]:(i+1)*siz[0]]&quot;&quot;&quot;</span>

<span class="k">def</span> <span class="nf">sinkh_transp</span><span class="p">(</span><span class="n">M</span><span class="p">,</span><span class="n">r</span><span class="p">,</span><span class="n">c</span><span class="p">,</span><span class="n">beta</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span><span class="n">nb_iter</span><span class="o">=</span><span class="mi">1000</span><span class="p">):</span>
    <span class="n">lambd</span> <span class="o">=</span> <span class="n">beta</span><span class="o">/</span><span class="n">M</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
    <span class="n">K</span> <span class="o">=</span> <span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">lambd</span><span class="o">*</span><span class="n">M</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">ones</span><span class="p">((</span><span class="n">size</span><span class="p">(</span><span class="n">r</span><span class="p">),</span><span class="mi">1</span><span class="p">))</span><span class="o">/</span><span class="n">size</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
    <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_iter</span><span class="p">):</span>
        <span class="n">temp</span> <span class="o">=</span> <span class="n">K</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">c</span><span class="o">*</span><span class="p">(</span><span class="n">transpose</span><span class="p">(</span><span class="n">K</span><span class="p">)</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">x</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)))</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>

        <span class="n">x</span><span class="o">=</span><span class="n">diag</span><span class="p">((</span><span class="n">r</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">size</span><span class="p">(</span><span class="n">r</span><span class="p">),))</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">temp</span><span class="p">)</span>
        <span class="n">u</span> <span class="o">=</span> <span class="n">x</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">v</span> <span class="o">=</span> <span class="n">c</span><span class="o">*</span><span class="p">((</span><span class="n">transpose</span><span class="p">(</span><span class="n">K</span><span class="p">)</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">u</span><span class="p">))</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>
        <span class="n">a</span> <span class="o">=</span> <span class="n">diag</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">size</span><span class="p">(</span><span class="n">u</span><span class="p">),)))</span>
        <span class="n">b</span> <span class="o">=</span> <span class="n">diag</span><span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">size</span><span class="p">(</span><span class="n">v</span><span class="p">),)))</span>
        <span class="n">P</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">K</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">b</span><span class="p">))</span>
        <span class="n">ri</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">P</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">ri</span> <span class="o">=</span> <span class="n">ri</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">size</span><span class="p">(</span><span class="n">ri</span><span class="p">),</span><span class="mi">1</span><span class="p">))</span>
        <span class="n">ci</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">P</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">ci</span> <span class="o">=</span> <span class="n">ci</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">size</span><span class="p">(</span><span class="n">ci</span><span class="p">),</span><span class="mi">1</span><span class="p">))</span>
        <span class="nb">print</span> <span class="s1">&#39;Bias :&#39;</span><span class="p">,((</span><span class="n">c</span><span class="o">-</span><span class="n">ri</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">/</span><span class="p">(</span><span class="n">c</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(),</span><span class="s1">&#39; &#39;</span><span class="p">,((</span><span class="n">r</span><span class="o">-</span><span class="n">ci</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">/</span><span class="p">(</span><span class="n">r</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="nb">print</span> <span class="s1">&#39;Check sum :&#39;</span><span class="p">,</span><span class="n">ri</span><span class="o">.</span><span class="n">sum</span><span class="p">(),</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">ci</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    <span class="n">dist</span><span class="o">=</span><span class="nb">sum</span><span class="p">(</span><span class="n">u</span><span class="o">*</span><span class="p">((</span><span class="n">K</span><span class="o">*</span><span class="n">M</span><span class="p">)</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">v</span><span class="p">)))</span>

    <span class="k">return</span> <span class="n">P</span><span class="p">,</span><span class="n">dist</span>


<span class="k">def</span> <span class="nf">kl_marg_proj</span><span class="p">(</span><span class="n">P</span><span class="p">,</span><span class="n">u</span><span class="p">):</span> <span class="c1"># P is a matrix and u u is a column; this function perfoms the projection of P on the set of matrices of columns marginal equal to u, with respect to the KL divergence</span>

    <span class="n">v</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">size</span><span class="p">(</span><span class="n">u</span><span class="p">),))</span>
    <span class="n">marg</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">P</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="nb">id</span> <span class="o">=</span> <span class="n">where</span><span class="p">(</span><span class="n">marg</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">temp</span> <span class="o">=</span> <span class="n">v</span><span class="o">*</span><span class="mi">0</span>
    <span class="n">temp</span><span class="p">[</span><span class="nb">id</span><span class="p">]</span> <span class="o">=</span> <span class="n">double</span><span class="p">(</span><span class="n">v</span><span class="p">[</span><span class="nb">id</span><span class="p">])</span><span class="o">/</span><span class="n">marg</span><span class="p">[</span><span class="nb">id</span><span class="p">]</span>
    <span class="n">a</span> <span class="o">=</span> <span class="n">diag</span><span class="p">(</span><span class="n">temp</span><span class="p">)</span>

    <span class="sd">&quot;&quot;&quot;if (sum(P,axis=1)).min()==0:</span>
<span class="sd">        print &quot;warning zero div in kl_marg_proj&quot;&quot;&quot;</span>
    <span class="n">out</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">P</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">out</span>



<span class="k">def</span> <span class="nf">kl_clust_proj</span><span class="p">(</span><span class="n">P</span><span class="p">,</span><span class="n">cart_prods</span><span class="p">,</span><span class="n">w</span><span class="p">):</span>
    <span class="n">nb_clust</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">cart_prods</span><span class="p">)</span>
    <span class="n">P_out</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">P</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_clust</span><span class="p">):</span>
        <span class="n">P_out</span><span class="p">[</span><span class="n">cart_prods</span><span class="p">[</span><span class="n">i</span><span class="p">][:,</span><span class="mi">0</span><span class="p">],</span><span class="n">cart_prods</span><span class="p">[</span><span class="n">i</span><span class="p">][:,</span><span class="mi">1</span><span class="p">]]</span> <span class="o">*=</span> <span class="n">w</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">/</span><span class="nb">sum</span><span class="p">(</span><span class="n">P_out</span><span class="p">[</span><span class="n">cart_prods</span><span class="p">[</span><span class="n">i</span><span class="p">][:,</span><span class="mi">0</span><span class="p">],</span><span class="n">cart_prods</span><span class="p">[</span><span class="n">i</span><span class="p">][:,</span><span class="mi">1</span><span class="p">]])</span>

    <span class="k">return</span> <span class="n">P_out</span>


<span class="k">def</span> <span class="nf">beg_proj_transp</span><span class="p">(</span><span class="n">M</span><span class="p">,</span><span class="n">r</span><span class="p">,</span><span class="n">c</span><span class="p">,</span><span class="n">supp</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">supp_comp_en</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">beta</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span><span class="n">nb_iter</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span><span class="n">step</span><span class="o">=</span><span class="mi">50</span><span class="p">):</span>
    <span class="n">lambd</span> <span class="o">=</span> <span class="n">beta</span><span class="o">/</span><span class="n">M</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
    <span class="n">K</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">nb_min</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="n">i</span> <span class="o">=</span> <span class="n">where</span><span class="p">(</span><span class="n">r</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">j</span> <span class="o">=</span> <span class="n">where</span><span class="p">(</span><span class="n">c</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">supp_size_min</span> <span class="o">=</span> <span class="n">size</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">+</span><span class="n">size</span><span class="p">(</span><span class="n">j</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span>
    <span class="c1">#supp_size_min = max(size(i),size(j))</span>
    <span class="nb">print</span> <span class="s2">&quot;Support minimal size: &quot;</span><span class="p">,</span><span class="n">supp_size_min</span>
    <span class="n">supp_size_init</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_min</span><span class="p">):</span>
        <span class="n">K</span> <span class="o">=</span> <span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">lambd</span><span class="o">*</span><span class="n">M</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">supp</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">K</span> <span class="o">*=</span> <span class="n">supp</span>
        <span class="n">P</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">K</span><span class="p">)</span>
        <span class="c1">#suppi = P*0</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_iter</span><span class="p">):</span>
            <span class="n">P</span> <span class="o">=</span> <span class="n">kl_marg_proj</span><span class="p">(</span><span class="n">P</span><span class="p">,</span><span class="n">c</span><span class="p">)</span>
            <span class="n">P</span> <span class="o">=</span> <span class="n">transpose</span><span class="p">(</span><span class="n">kl_marg_proj</span><span class="p">(</span><span class="n">transpose</span><span class="p">(</span><span class="n">P</span><span class="p">),</span><span class="n">r</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">i</span><span class="o">%</span><span class="n">step</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
                <span class="n">ci</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">P</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">ci</span> <span class="o">=</span> <span class="n">ci</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">size</span><span class="p">(</span><span class="n">ci</span><span class="p">),</span><span class="mi">1</span><span class="p">))</span>
                <span class="n">ri</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">P</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                <span class="n">ri</span> <span class="o">=</span> <span class="n">ri</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">size</span><span class="p">(</span><span class="n">ri</span><span class="p">),</span><span class="mi">1</span><span class="p">))</span>
                <span class="nb">print</span> <span class="s1">&#39;Bias 1:&#39;</span><span class="p">,((</span><span class="n">c</span><span class="o">-</span><span class="n">ci</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">/</span><span class="p">(</span><span class="n">c</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
                <span class="nb">print</span> <span class="s1">&#39;Bias 2:&#39;</span><span class="p">,((</span><span class="n">r</span><span class="o">-</span><span class="n">ri</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">/</span><span class="p">(</span><span class="n">r</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
                <span class="nb">print</span> <span class="s1">&#39;Check sum :&#39;</span><span class="p">,</span><span class="n">ri</span><span class="o">.</span><span class="n">sum</span><span class="p">(),</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">ci</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>

                <span class="c1">#supp_old = copy(suppi)</span>
                <span class="c1">#suppi = P*0</span>
                <span class="sd">&quot;&quot;&quot;if l==0:</span>
<span class="sd">                    if supp_size_init is None:</span>
<span class="sd">                        n,m = where(P&gt;0)</span>
<span class="sd">                        supp_size_init = size(n)</span>
<span class="sd">                        print &quot;initial support size: &quot;,supp_size_init</span>
<span class="sd">                    next_size = int(-(supp_size_init-supp_size_min)*(double(i)/(nb_iter-1-(nb_iter-1)%step))**0.5 +supp_size_init)</span>
<span class="sd">                    print &quot;Next size: &quot;,next_size</span>
<span class="sd">                    supp = utils.khighest(P,next_size)</span>
<span class="sd">                    #supp = support_checking(P,supp,r,c)</span>
<span class="sd">                    print &quot;Actual size: &quot;,supp.sum()</span>
<span class="sd">                    K = exp(-lambd*M)</span>
<span class="sd">                    if supp is not None:</span>
<span class="sd">                        K *= supp</span>
<span class="sd">                    P = copy(K)&quot;&quot;&quot;</span>
                <span class="c1">#suppi[n,m] = 1</span>
                <span class="c1">#print &quot;Support error: &quot;,sum(abs(suppi-supp_old)),&quot; Support size: &quot;,suppi.sum()</span>
        <span class="n">ci</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">P</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">ci</span> <span class="o">=</span> <span class="n">ci</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">size</span><span class="p">(</span><span class="n">ci</span><span class="p">),</span><span class="mi">1</span><span class="p">))</span>
        <span class="n">ri</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">P</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">ri</span> <span class="o">=</span> <span class="n">ri</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">size</span><span class="p">(</span><span class="n">ri</span><span class="p">),</span><span class="mi">1</span><span class="p">))</span>
        <span class="nb">print</span> <span class="s1">&#39;Bias 1:&#39;</span><span class="p">,((</span><span class="n">c</span><span class="o">-</span><span class="n">ci</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">/</span><span class="p">(</span><span class="n">c</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="nb">print</span> <span class="s1">&#39;Bias 2:&#39;</span><span class="p">,((</span><span class="n">r</span><span class="o">-</span><span class="n">ri</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">/</span><span class="p">(</span><span class="n">r</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="nb">print</span> <span class="s1">&#39;Check sum :&#39;</span><span class="p">,</span><span class="n">ri</span><span class="o">.</span><span class="n">sum</span><span class="p">(),</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">r</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>

    <span class="n">P</span> <span class="o">=</span> <span class="n">transpose</span><span class="p">(</span><span class="n">map_sparse</span><span class="p">(</span><span class="n">transpose</span><span class="p">(</span><span class="n">P</span><span class="p">),</span><span class="n">c</span><span class="p">,</span><span class="n">r</span><span class="p">))</span>
    <span class="n">dist</span><span class="o">=</span><span class="nb">sum</span><span class="p">(</span><span class="n">M</span><span class="o">*</span><span class="n">P</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">P</span><span class="p">,</span><span class="n">dist</span>

<span class="k">def</span> <span class="nf">sliced_transport_time_assessing</span><span class="p">(</span><span class="n">f</span><span class="p">,</span><span class="n">g</span><span class="p">,</span><span class="n">nb_real</span><span class="p">,</span><span class="n">nb_iter</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span><span class="n">tol</span><span class="o">=</span><span class="mf">0.001</span><span class="p">,</span><span class="n">alph</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span><span class="n">basis</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">rand</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">disc_err</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span><span class="n">indf</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">indg</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">smart_init_en</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span><span class="n">monte_carlo</span><span class="o">=</span><span class="mi">100</span><span class="p">):</span>
    <span class="kn">from</span> <span class="nn">numpy</span> <span class="k">import</span> <span class="n">zeros</span>
    <span class="kn">import</span> <span class="nn">time</span>
    <span class="n">time_val</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">nb_real</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],))</span>
    <span class="n">nb_disc</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">nb_real</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],))</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_real</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
        <span class="nb">print</span> <span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="s2">&quot;th real/&quot;</span><span class="p">,</span><span class="n">nb_real</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">monte_carlo</span><span class="p">):</span>
            <span class="n">t</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
            <span class="n">projf</span><span class="p">,</span><span class="n">dist</span><span class="p">,</span><span class="n">sig</span><span class="p">,</span><span class="n">disc_pts</span> <span class="o">=</span> <span class="n">sliced_transport</span><span class="p">(</span><span class="n">f</span><span class="p">,</span><span class="n">g</span><span class="p">,</span><span class="n">nb_iter</span><span class="o">=</span><span class="n">nb_iter</span><span class="p">,</span><span class="n">tol</span><span class="o">=</span><span class="n">tol</span><span class="p">,</span><span class="n">alph</span> <span class="o">=</span> <span class="n">alph</span><span class="p">,</span><span class="n">basis</span><span class="o">=</span><span class="n">basis</span><span class="p">,</span><span class="n">nb_real</span><span class="o">=</span><span class="n">nb_real</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">rand</span><span class="o">=</span><span class="n">rand</span><span class="p">,</span><span class="n">disc_err</span><span class="o">=</span><span class="n">disc_err</span><span class="p">,</span><span class="n">indf</span><span class="o">=</span><span class="n">indf</span><span class="p">,</span><span class="n">indg</span><span class="o">=</span><span class="n">indg</span><span class="p">,</span><span class="n">smart_init_en</span> <span class="o">=</span> <span class="n">smart_init_en</span><span class="p">)</span>
            <span class="n">time_val</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="o">-</span><span class="n">t</span>
            <span class="n">nb_disc</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+=</span> <span class="nb">float</span><span class="p">(</span><span class="n">disc_pts</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

    <span class="k">return</span> <span class="n">time_val</span><span class="o">/</span><span class="n">monte_carlo</span><span class="p">,</span><span class="n">nb_disc</span><span class="o">/</span><span class="n">monte_carlo</span>

<span class="k">def</span> <span class="nf">sliced_transport_time_assessing_2</span><span class="p">(</span><span class="n">f</span><span class="p">,</span><span class="n">g</span><span class="p">,</span><span class="n">nb_iter</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span><span class="n">tol</span><span class="o">=</span><span class="mf">0.001</span><span class="p">,</span><span class="n">alph</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span><span class="n">basis</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">nb_real</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span><span class="n">rand</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">disc_err</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span><span class="n">indf</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">indg</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">smart_init_en</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span><span class="n">monte_carlo</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span><span class="n">gap</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">shap</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">rad</span><span class="o">=</span><span class="mi">15</span><span class="p">):</span>
    <span class="kn">from</span> <span class="nn">numpy</span> <span class="k">import</span> <span class="n">zeros</span>
    <span class="kn">import</span> <span class="nn">time</span>
    <span class="n">time_val</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">monte_carlo</span><span class="p">,))</span>
    <span class="n">nb_disc</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">monte_carlo</span><span class="p">,))</span>


    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">monte_carlo</span><span class="p">):</span>
        <span class="nb">print</span> <span class="s2">&quot;Realization &quot;</span><span class="p">,</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="s2">&quot;/&quot;</span><span class="p">,</span><span class="n">monte_carlo</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">projf</span><span class="p">,</span><span class="n">dist</span><span class="p">,</span><span class="n">sig</span><span class="p">,</span><span class="n">disc_pts</span> <span class="o">=</span> <span class="n">sliced_transport</span><span class="p">(</span><span class="n">f</span><span class="p">,</span><span class="n">g</span><span class="p">,</span><span class="n">nb_iter</span><span class="o">=</span><span class="n">nb_iter</span><span class="p">,</span><span class="n">tol</span><span class="o">=</span><span class="n">tol</span><span class="p">,</span><span class="n">alph</span> <span class="o">=</span> <span class="n">alph</span><span class="p">,</span><span class="n">basis</span><span class="o">=</span><span class="n">basis</span><span class="p">,</span><span class="n">nb_real</span><span class="o">=</span><span class="n">nb_real</span><span class="p">,</span><span class="n">rand</span><span class="o">=</span><span class="n">rand</span><span class="p">,</span><span class="n">disc_err</span><span class="o">=</span><span class="n">disc_err</span><span class="p">,</span><span class="n">smart_init_en</span> <span class="o">=</span> <span class="n">smart_init_en</span><span class="p">,</span><span class="n">gap</span><span class="o">=</span><span class="n">gap</span><span class="p">,</span><span class="n">shap</span><span class="o">=</span><span class="n">shap</span><span class="p">,</span><span class="n">rad</span><span class="o">=</span><span class="n">rad</span><span class="p">)</span>
        <span class="n">time_val</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="o">-</span><span class="n">t</span>
        <span class="n">nb_disc</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">disc_pts</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

    <span class="k">return</span> <span class="n">time_val</span><span class="p">,</span><span class="n">nb_disc</span>


<span class="k">def</span> <span class="nf">sliced_transport_time_assessing_m</span><span class="p">(</span><span class="n">f</span><span class="p">,</span><span class="n">g</span><span class="p">,</span><span class="n">nb_real</span><span class="p">,</span><span class="n">nb_iter</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span><span class="n">tol</span><span class="o">=</span><span class="mf">0.001</span><span class="p">,</span><span class="n">alph</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span><span class="n">basis</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">rand</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">disc_err</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span><span class="n">indf</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">indg</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">smart_init_en</span> <span class="o">=</span> <span class="kc">True</span><span class="p">):</span>
    <span class="kn">from</span> <span class="nn">numpy</span> <span class="k">import</span> <span class="n">zeros</span>
    <span class="n">time_val</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">f</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">nb_real</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
    <span class="n">nb_disc</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">f</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">nb_real</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
    <span class="n">indfin</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">indgin</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">f</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
        <span class="nb">print</span> <span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="s2">&quot;th test/&quot;</span><span class="p">,</span><span class="n">f</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">indf</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">indg</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">indfin</span> <span class="o">=</span> <span class="n">indf</span><span class="p">[</span><span class="n">i</span><span class="p">,:]</span>
            <span class="n">indgin</span> <span class="o">=</span> <span class="n">indg</span><span class="p">[</span><span class="n">i</span><span class="p">,:]</span>
        <span class="n">time_val</span><span class="p">[</span><span class="n">i</span><span class="p">,:],</span><span class="n">nb_disc</span><span class="p">[</span><span class="n">i</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">sliced_transport_time_assessing</span><span class="p">(</span><span class="n">f</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">],</span><span class="n">g</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">],</span><span class="n">nb_real</span><span class="p">,</span><span class="n">nb_iter</span><span class="o">=</span><span class="n">nb_iter</span><span class="p">,</span><span class="n">tol</span><span class="o">=</span><span class="n">tol</span><span class="p">,</span><span class="n">alph</span> <span class="o">=</span> <span class="n">alph</span><span class="p">,</span><span class="n">basis</span><span class="o">=</span><span class="n">basis</span><span class="p">,</span><span class="n">rand</span><span class="o">=</span><span class="n">rand</span><span class="p">,</span><span class="n">disc_err</span><span class="o">=</span><span class="n">disc_err</span><span class="p">,</span><span class="n">indf</span><span class="o">=</span><span class="n">indfin</span><span class="p">,</span><span class="n">indg</span><span class="o">=</span><span class="n">indgin</span><span class="p">,</span><span class="n">smart_init_en</span> <span class="o">=</span> <span class="n">smart_init_en</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">time_val</span><span class="p">,</span><span class="n">nb_disc</span>



<span class="k">def</span> <span class="nf">sliced_transport</span><span class="p">(</span><span class="n">f</span><span class="p">,</span><span class="n">g</span><span class="p">,</span><span class="n">nb_iter</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span><span class="n">tol</span><span class="o">=</span><span class="mf">0.001</span><span class="p">,</span><span class="n">alph</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span><span class="n">basis</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">nb_real</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span><span class="n">rand</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">disc_err</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span><span class="n">indf</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">indg</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">smart_init_en</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span><span class="n">output_control</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">iter_control</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">rad</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span><span class="n">shap</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">gap</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="kn">import</span> <span class="nn">time</span>
    <span class="kn">from</span> <span class="nn">numpy.linalg</span> <span class="k">import</span> <span class="n">norm</span>
    <span class="kn">from</span> <span class="nn">numpy</span> <span class="k">import</span> <span class="n">copy</span><span class="p">,</span><span class="n">zeros</span><span class="p">,</span><span class="n">ones</span><span class="p">,</span><span class="n">argsort</span>
    <span class="kn">from</span> <span class="nn">scipy.optimize</span> <span class="k">import</span> <span class="n">linear_sum_assignment</span>
    <span class="kn">from</span> <span class="nn">utils</span> <span class="k">import</span> <span class="n">window_ind</span>
    <span class="nb">iter</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">t</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">iter_control</span><span class="p">:</span>
        <span class="nb">iter</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">f</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">f</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">nb_iter</span><span class="o">+</span><span class="mi">2</span><span class="p">))</span>
        <span class="nb">iter</span><span class="p">[:,:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">g</span><span class="p">)</span>

    <span class="n">pf</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">smart_init_en</span><span class="p">:</span>


        <span class="k">if</span> <span class="n">indg</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">indf</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>

            <span class="n">i</span> <span class="o">=</span> <span class="n">where</span><span class="p">(</span><span class="n">f</span><span class="p">[</span><span class="mi">2</span><span class="p">,:]</span><span class="o">==</span><span class="n">f</span><span class="p">[</span><span class="mi">2</span><span class="p">,:]</span><span class="o">.</span><span class="n">max</span><span class="p">())</span>
            <span class="nb">print</span> <span class="n">i</span><span class="p">,</span><span class="n">gap</span><span class="p">,</span><span class="n">f</span><span class="o">.</span><span class="n">shape</span>
            <span class="n">cent1</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">,</span><span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]]</span><span class="o">/</span><span class="n">gap</span>
            <span class="n">j</span> <span class="o">=</span> <span class="n">where</span><span class="p">(</span><span class="n">g</span><span class="p">[</span><span class="mi">2</span><span class="p">,:]</span><span class="o">==</span><span class="n">g</span><span class="p">[</span><span class="mi">2</span><span class="p">,:]</span><span class="o">.</span><span class="n">max</span><span class="p">())</span>
            <span class="n">cent2</span> <span class="o">=</span> <span class="n">g</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">,</span><span class="n">j</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]]</span><span class="o">/</span><span class="n">gap</span>
            <span class="n">indf</span> <span class="o">=</span> <span class="n">window_ind</span><span class="p">(</span><span class="n">cent1</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">),</span><span class="n">shap</span><span class="p">,</span><span class="n">rad</span><span class="p">)</span>
            <span class="n">indg</span> <span class="o">=</span> <span class="n">window_ind</span><span class="p">(</span><span class="n">cent2</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">),</span><span class="n">shap</span><span class="p">,</span><span class="n">rad</span><span class="p">)</span>


        <span class="nb">print</span> <span class="s2">&quot;On going smart initialization...&quot;</span>
        <span class="c1">#indg = arange(0,f.shape[1])</span>
        <span class="c1">#indf = indg</span>
        <span class="n">dist_init</span><span class="p">,</span><span class="n">pf</span><span class="p">[:,</span><span class="n">indf</span><span class="p">],</span><span class="n">sig_init</span> <span class="o">=</span> <span class="n">opt_assignment</span><span class="p">(</span><span class="n">f</span><span class="p">[:,</span><span class="n">indf</span><span class="p">],</span><span class="n">g</span><span class="p">[:,</span><span class="n">indg</span><span class="p">])</span>
        <span class="nb">print</span> <span class="s2">&quot;Done.&quot;</span>

    <span class="k">if</span> <span class="n">iter_control</span><span class="p">:</span>
        <span class="nb">iter</span><span class="p">[:,:,</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">pf</span><span class="p">)</span>

    <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">err</span> <span class="o">=</span> <span class="mi">100</span>
    <span class="n">dim</span>  <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="n">sig_global</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">dim</span><span class="p">,</span><span class="n">f</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">nb_real</span><span class="p">))</span>

    <span class="n">bias</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">max_disc_cv</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">basis</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">rand</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
        <span class="n">rand</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">while</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">nb_iter</span> <span class="ow">and</span> <span class="n">err</span><span class="o">&gt;</span><span class="n">tol</span><span class="p">:</span>
        <span class="n">i</span><span class="o">+=</span><span class="mi">1</span>
        <span class="n">pf_old</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">pf</span><span class="p">)</span>
        <span class="n">step</span> <span class="o">=</span> <span class="mf">1.0</span><span class="o">/</span><span class="n">i</span><span class="o">**</span><span class="n">alph</span>
        <span class="n">tempf</span> <span class="o">=</span> <span class="n">pf_old</span><span class="o">*</span><span class="mi">0</span>
        <span class="k">if</span> <span class="n">rand</span><span class="p">:</span>
            <span class="c1">#tempf = None</span>
            <span class="n">bias</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">max_disc_cv</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">discr_max</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_real</span><span class="p">):</span>
                <span class="n">basis</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">random_orth_basis</span><span class="p">(</span><span class="n">dim</span><span class="p">)</span>
                <span class="n">tempfi</span><span class="p">,</span><span class="n">err_proj</span><span class="p">,</span><span class="n">sig_global</span><span class="p">[:,:,</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">coord_wise_proj</span><span class="p">(</span><span class="n">pf</span><span class="p">,</span><span class="n">g</span><span class="p">,</span><span class="n">basis</span><span class="p">)</span>
                <span class="c1">#max_disc,disc_id = discrepancies_analysis(sig_global[:,:,,k])</span>
                <span class="c1">#bias += max_disc-disc_id</span>
                <span class="c1">#max_disc_cv += max_disc</span>
                <span class="n">tempf</span><span class="o">+=</span><span class="n">tempfi</span>
                <span class="sd">&quot;&quot;&quot;if max_disc&lt;discr_max:</span>
<span class="sd">                    discr_max = max_disc</span>
<span class="sd">                    tempf=copy(tempfi)&quot;&quot;&quot;</span>
                <span class="c1">#print &quot;Inter-discrepancy: &quot;,max_disc,&quot; Id discrepancy: &quot;,disc_id</span>

            <span class="n">tempf</span><span class="o">/=</span><span class="n">nb_real</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">tempf</span><span class="p">,</span><span class="n">err_proj</span><span class="p">,</span><span class="n">sig</span> <span class="o">=</span> <span class="n">coord_wise_proj</span><span class="p">(</span><span class="n">pf</span><span class="p">,</span><span class="n">g</span><span class="p">,</span><span class="n">basis</span><span class="p">)</span>
        <span class="c1"># sprint &quot;Projection error: &quot;,err_proj</span>
        <span class="n">pf</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">step</span><span class="p">)</span><span class="o">*</span><span class="n">pf_old</span><span class="o">+</span><span class="n">step</span><span class="o">*</span><span class="n">tempf</span>
        <span class="k">if</span> <span class="n">iter_control</span><span class="p">:</span>
            <span class="nb">iter</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">pf</span><span class="p">)</span>
        <span class="n">err</span> <span class="o">=</span> <span class="mi">100</span><span class="o">*</span><span class="nb">sum</span><span class="p">((</span><span class="n">pf</span><span class="o">-</span><span class="n">pf_old</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="nb">sum</span><span class="p">(</span><span class="n">pf</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
        <span class="nb">print</span> <span class="s2">&quot;Relative change of the iterate: &quot;</span><span class="p">,</span><span class="n">err</span><span class="p">,</span><span class="s2">&quot;%&quot;</span>

    <span class="n">sig_global</span> <span class="o">=</span> <span class="n">sig_global</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

    <span class="nb">print</span> <span class="s2">&quot;Elapsed time: &quot;</span><span class="p">,</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="o">-</span><span class="n">t</span>



    <span class="c1"># Assignements diagnostic</span>
    <span class="sd">&quot;&quot;&quot;for i in range(0,shap[0]):</span>
<span class="sd">        print &quot;Departure: &quot;,size(where(abs(sig[i_opt,:]-sig[i,:])&gt;0))&quot;&quot;&quot;</span>

    <span class="n">bias</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">max_disc_cv</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">discr_max</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_real</span><span class="p">):</span>
        <span class="n">max_disc</span><span class="p">,</span><span class="n">disc_id</span> <span class="o">=</span> <span class="n">discrepancies_analysis</span><span class="p">(</span><span class="n">sig_global</span><span class="p">[:,:,</span><span class="n">k</span><span class="p">])</span>
        <span class="n">bias</span> <span class="o">+=</span> <span class="n">max_disc</span><span class="o">-</span><span class="n">disc_id</span>
        <span class="n">max_disc_cv</span> <span class="o">+=</span> <span class="n">max_disc</span>

    <span class="nb">print</span> <span class="s2">&quot;Mean departure: &quot;</span><span class="p">,</span><span class="nb">float</span><span class="p">(</span><span class="n">max_disc_cv</span><span class="p">)</span><span class="o">/</span><span class="n">nb_real</span>

    <span class="n">disc_supp</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">cost</span> <span class="o">=</span> <span class="n">norm</span><span class="p">(</span><span class="n">f</span><span class="p">)</span><span class="o">+</span><span class="n">norm</span><span class="p">(</span><span class="n">g</span><span class="p">)</span>
    <span class="n">iopt</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_real</span><span class="p">):</span>
        <span class="n">disc_supp_k</span><span class="p">,</span><span class="n">agreem_supp_k</span> <span class="o">=</span> <span class="n">discrepancies_global_analysis</span><span class="p">(</span><span class="n">sig_global</span><span class="p">[:,:,</span><span class="n">k</span><span class="p">])</span>
        <span class="n">cost_k</span> <span class="o">=</span> <span class="n">norm</span><span class="p">(</span><span class="n">f</span><span class="p">[:,</span><span class="n">agreem_supp_k</span><span class="p">]</span><span class="o">-</span><span class="n">g</span><span class="p">[:,</span><span class="n">sig_global</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">agreem_supp_k</span><span class="p">,</span><span class="n">k</span><span class="p">]])</span>
        <span class="k">if</span> <span class="n">cost_k</span><span class="o">&lt;</span><span class="n">cost</span><span class="p">:</span>
            <span class="n">cost</span> <span class="o">=</span> <span class="n">cost_k</span>
            <span class="n">iopt</span> <span class="o">=</span> <span class="n">k</span>
            <span class="n">disc_supp</span> <span class="o">=</span> <span class="n">disc_supp_k</span>

    <span class="n">sig_approx</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">sig_global</span><span class="p">[</span><span class="mi">0</span><span class="p">,:,</span><span class="n">iopt</span><span class="p">])</span>

    <span class="nb">print</span> <span class="s2">&quot;Global disagrement: &quot;</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">disc_supp</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">output_control</span><span class="o">==</span><span class="kc">False</span><span class="p">:</span>
        <span class="n">dist</span> <span class="o">=</span> <span class="n">norm</span><span class="p">(</span><span class="n">f</span><span class="o">-</span><span class="n">pf</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">iter_control</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">pf</span><span class="p">,</span><span class="n">dist</span><span class="p">,</span><span class="n">sig_approx</span><span class="p">,</span><span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">,</span><span class="n">disc_supp</span><span class="p">],</span><span class="nb">iter</span><span class="p">[:,:,</span><span class="mi">0</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">pf</span><span class="p">,</span><span class="n">dist</span><span class="p">,</span><span class="n">sig_approx</span><span class="p">,</span><span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">,</span><span class="n">disc_supp</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">disc_supp</span><span class="p">)</span><span class="o">&lt;</span><span class="n">disc_err</span><span class="o">*</span><span class="n">f</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">disc_supp</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>

                <span class="n">dist</span> <span class="o">=</span> <span class="n">norm</span><span class="p">(</span><span class="n">f</span><span class="o">-</span><span class="n">pf</span><span class="p">)</span>
                <span class="nb">print</span> <span class="s2">&quot;Transport correction: &quot;</span><span class="p">,</span><span class="n">dist</span><span class="o">/</span><span class="n">norm</span><span class="p">(</span><span class="n">f</span><span class="o">-</span><span class="n">g</span><span class="p">)</span>
                <span class="nb">print</span> <span class="s2">&quot;Success&quot;</span>
                <span class="k">if</span> <span class="n">iter_control</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">g</span><span class="p">[:,</span><span class="n">sig_approx</span><span class="p">],</span><span class="n">dist</span><span class="p">,</span><span class="n">sig_approx</span><span class="p">,</span><span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">,</span><span class="n">disc_supp</span><span class="p">],</span><span class="nb">iter</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">g</span><span class="p">[:,</span><span class="n">sig_approx</span><span class="p">],</span><span class="n">dist</span><span class="p">,</span><span class="n">sig_approx</span><span class="p">,</span><span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">,</span><span class="n">disc_supp</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">dist_disc</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">disc_supp</span><span class="p">),</span><span class="nb">len</span><span class="p">(</span><span class="n">disc_supp</span><span class="p">)))</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">disc_supp</span><span class="p">)):</span>
                    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">disc_supp</span><span class="p">)):</span>
                        <span class="n">dist_disc</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">norm</span><span class="p">(</span><span class="n">f</span><span class="p">[:,</span><span class="n">disc_supp</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span><span class="o">-</span><span class="n">g</span><span class="p">[:,</span><span class="n">sig_global</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">disc_supp</span><span class="p">[</span><span class="n">j</span><span class="p">],</span><span class="n">iopt</span><span class="p">]])</span><span class="o">**</span><span class="mi">2</span>
                <span class="c1"># Linear programming</span>
                <span class="nb">print</span> <span class="s2">&quot;Linear programming solving...&quot;</span>
                <span class="n">row_ind</span><span class="p">,</span><span class="n">col_ind</span> <span class="o">=</span> <span class="n">linear_sum_assignment</span><span class="p">(</span><span class="n">dist_disc</span><span class="p">)</span>

                <span class="nb">print</span> <span class="s2">&quot;Done.&quot;</span>
                <span class="n">sig_approx</span><span class="p">[</span><span class="n">disc_supp</span><span class="p">]</span> <span class="o">=</span> <span class="n">sig_approx</span><span class="p">[</span><span class="n">disc_supp</span><span class="p">[</span><span class="n">col_ind</span><span class="p">[</span><span class="n">argsort</span><span class="p">(</span><span class="n">row_ind</span><span class="p">)]]]</span>
                <span class="n">dist</span> <span class="o">=</span> <span class="n">norm</span><span class="p">(</span><span class="n">f</span><span class="o">-</span><span class="n">g</span><span class="p">[:,</span><span class="n">sig_approx</span><span class="p">])</span>
                <span class="n">rho</span> <span class="o">=</span> <span class="n">dist</span><span class="o">/</span><span class="n">norm</span><span class="p">(</span><span class="n">f</span><span class="o">-</span><span class="n">g</span><span class="p">)</span>
                <span class="nb">print</span> <span class="s2">&quot;Transport corrections: &quot;</span><span class="p">,</span><span class="n">dist</span><span class="o">/</span><span class="n">norm</span><span class="p">(</span><span class="n">f</span><span class="o">-</span><span class="n">g</span><span class="p">),</span> <span class="n">norm</span><span class="p">(</span><span class="n">f</span><span class="p">[:,</span><span class="n">disc_supp</span><span class="p">]</span><span class="o">-</span><span class="n">g</span><span class="p">[:,</span><span class="n">sig_approx</span><span class="p">[</span><span class="n">disc_supp</span><span class="p">]])</span><span class="o">/</span><span class="n">norm</span><span class="p">(</span><span class="n">f</span><span class="p">[:,</span><span class="n">disc_supp</span><span class="p">]</span><span class="o">-</span><span class="n">g</span><span class="p">[:,</span><span class="n">sig_global</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">disc_supp</span><span class="p">,</span><span class="n">iopt</span><span class="p">]])</span>
                <span class="k">if</span> <span class="n">rho</span> <span class="o">&lt;</span><span class="mi">1</span><span class="p">:</span>
                    <span class="nb">print</span> <span class="s2">&quot;Success&quot;</span>
                    <span class="k">if</span> <span class="n">iter_control</span><span class="p">:</span>
                        <span class="k">return</span> <span class="n">g</span><span class="p">[:,</span><span class="n">sig_approx</span><span class="p">],</span><span class="n">dist</span><span class="p">,</span><span class="n">sig_approx</span><span class="p">,</span><span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">,</span><span class="n">disc_supp</span><span class="p">],</span><span class="n">iter_control</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">return</span> <span class="n">g</span><span class="p">[:,</span><span class="n">sig_approx</span><span class="p">],</span><span class="n">dist</span><span class="p">,</span><span class="n">sig_approx</span><span class="p">,</span><span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">,</span><span class="n">disc_supp</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="nb">print</span> <span class="s2">&quot;Fail&quot;</span>
                    <span class="k">if</span> <span class="n">iter_control</span><span class="p">:</span>
                        <span class="k">return</span> <span class="n">g</span><span class="p">,</span><span class="n">norm</span><span class="p">(</span><span class="n">f</span><span class="o">-</span><span class="n">g</span><span class="p">),</span><span class="n">sig_approx</span><span class="p">,</span><span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">,</span><span class="n">disc_supp</span><span class="p">],</span><span class="n">iter_control</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">return</span> <span class="n">g</span><span class="p">,</span><span class="n">norm</span><span class="p">(</span><span class="n">f</span><span class="o">-</span><span class="n">g</span><span class="p">),</span><span class="n">sig_approx</span><span class="p">,</span><span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">,</span><span class="n">disc_supp</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span> <span class="s2">&quot;Fail&quot;</span>
            <span class="k">if</span> <span class="n">iter_control</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">g</span><span class="p">,</span><span class="n">norm</span><span class="p">(</span><span class="n">f</span><span class="o">-</span><span class="n">g</span><span class="p">),</span><span class="n">sig_approx</span><span class="p">,</span><span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">,</span><span class="n">disc_supp</span><span class="p">],</span><span class="nb">iter</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">g</span><span class="p">,</span><span class="n">norm</span><span class="p">(</span><span class="n">f</span><span class="o">-</span><span class="n">g</span><span class="p">),</span><span class="n">sig_approx</span><span class="p">,</span><span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">,</span><span class="n">disc_supp</span><span class="p">]</span>

<span class="k">def</span> <span class="nf">sliced_transport_proj</span><span class="p">(</span><span class="n">ref</span><span class="p">,</span><span class="n">pt_clouds</span><span class="p">,</span><span class="n">gap</span><span class="p">,</span><span class="n">nb_iter</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span><span class="n">tol</span><span class="o">=</span><span class="mf">0.001</span><span class="p">,</span><span class="n">alph</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span><span class="n">basis</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">nb_real</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span><span class="n">rand</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">disc_err</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span><span class="n">indf</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">indg</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">smart_init_en</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span><span class="n">output_control</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">iter_control</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">rad</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span><span class="n">shap</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="kn">from</span> <span class="nn">numpy</span> <span class="k">import</span> <span class="n">copy</span>
    <span class="n">proj_clouds</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">pt_clouds</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">pt_clouds</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
        <span class="n">pt_i</span><span class="p">,</span><span class="n">dist_i</span><span class="p">,</span><span class="n">sig_i</span><span class="p">,</span><span class="n">ref_disc</span> <span class="o">=</span> <span class="n">sliced_transport</span><span class="p">(</span><span class="n">ref</span><span class="p">,</span><span class="n">pt_clouds</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">],</span><span class="n">nb_iter</span><span class="o">=</span><span class="n">nb_iter</span><span class="p">,</span><span class="n">tol</span><span class="o">=</span><span class="n">tol</span><span class="p">,</span><span class="n">alph</span> <span class="o">=</span> <span class="n">alph</span><span class="p">,</span><span class="n">basis</span><span class="o">=</span><span class="n">basis</span><span class="p">,</span><span class="n">nb_real</span><span class="o">=</span><span class="n">nb_real</span><span class="p">,</span><span class="n">rand</span><span class="o">=</span><span class="n">rand</span><span class="p">,</span><span class="n">disc_err</span><span class="o">=</span><span class="n">disc_err</span><span class="p">,</span><span class="n">indf</span><span class="o">=</span><span class="n">indf</span><span class="p">,</span><span class="n">indg</span><span class="o">=</span><span class="n">indg</span><span class="p">,</span><span class="n">smart_init_en</span> <span class="o">=</span> <span class="n">smart_init_en</span><span class="p">,</span><span class="n">output_control</span><span class="o">=</span><span class="n">output_control</span><span class="p">,</span><span class="n">iter_control</span><span class="o">=</span><span class="n">iter_control</span><span class="p">,</span><span class="n">rad</span><span class="o">=</span><span class="n">rad</span><span class="p">,</span><span class="n">shap</span><span class="o">=</span><span class="n">shap</span><span class="p">,</span><span class="n">gap</span><span class="o">=</span><span class="n">gap</span><span class="p">)</span>
        <span class="n">proj_clouds</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">pt_i</span><span class="o">-</span><span class="n">ref</span>

    <span class="k">return</span> <span class="n">proj_clouds</span>

<span class="k">def</span> <span class="nf">cloud_size_constraint_simp</span><span class="p">(</span><span class="n">clouds_in</span><span class="p">,</span><span class="n">cent</span><span class="p">,</span><span class="n">siz</span><span class="p">):</span>
    <span class="kn">from</span> <span class="nn">numpy</span> <span class="k">import</span> <span class="n">ones</span><span class="p">,</span><span class="n">sqrt</span><span class="p">,</span><span class="n">sign</span>
    <span class="kn">from</span> <span class="nn">numpy.linalg</span> <span class="k">import</span> <span class="n">norm</span>
    <span class="n">shap</span> <span class="o">=</span> <span class="n">clouds_in</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">norm_vect</span> <span class="o">=</span> <span class="n">ones</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">clouds_in</span><span class="p">[</span><span class="mi">2</span><span class="p">,:]</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">])))</span><span class="o">/</span><span class="nb">sum</span><span class="p">(</span><span class="n">clouds_in</span><span class="p">[</span><span class="mi">2</span><span class="p">,:])</span>
    <span class="n">cent_mat</span> <span class="o">=</span> <span class="n">cent</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">ones</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">])))</span>
    <span class="n">cent_dist</span> <span class="o">=</span> <span class="p">(</span><span class="n">cent_mat</span><span class="o">-</span><span class="n">clouds_in</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">,:])</span><span class="o">**</span><span class="mi">2</span>
    <span class="n">ajust_pos</span> <span class="o">=</span> <span class="n">sqrt</span><span class="p">(</span><span class="n">pos_proj_mat</span><span class="p">(</span><span class="n">cent_dist</span><span class="o">-</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="n">norm_vect</span><span class="o">*</span><span class="n">cent_dist</span><span class="p">)</span><span class="o">-</span><span class="n">siz</span><span class="p">)</span><span class="o">*</span><span class="n">norm_vect</span><span class="o">/</span><span class="n">norm</span><span class="p">(</span><span class="n">norm_vect</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span><span class="o">*</span><span class="n">sign</span><span class="p">(</span><span class="n">clouds_in</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">,:]</span><span class="o">-</span><span class="n">cent_mat</span><span class="p">)</span><span class="o">+</span><span class="n">cent_mat</span>
    <span class="k">return</span> <span class="n">ajust_pos</span>

<span class="k">def</span> <span class="nf">cloud_size_constraint</span><span class="p">(</span><span class="n">clouds_in</span><span class="p">,</span><span class="n">cent</span><span class="p">,</span><span class="n">siz</span><span class="p">,</span><span class="n">inertia</span><span class="p">,</span><span class="n">nb_iter</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span><span class="n">tol</span><span class="o">=</span><span class="mf">1e-5</span><span class="p">,</span><span class="n">acc</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="kn">from</span> <span class="nn">numpy</span> <span class="k">import</span> <span class="n">ones</span><span class="p">,</span><span class="n">zeros</span><span class="p">,</span><span class="n">transpose</span><span class="p">,</span><span class="n">sqrt</span>
    <span class="kn">from</span> <span class="nn">numpy.linalg</span> <span class="k">import</span> <span class="n">norm</span><span class="p">,</span><span class="n">inv</span>

    <span class="n">cloud_out</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">clouds_in</span><span class="p">)</span>
    <span class="n">ind</span> <span class="o">=</span> <span class="n">where</span><span class="p">(</span><span class="n">cloud_out</span><span class="p">[</span><span class="mi">2</span><span class="p">,:]</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">size</span><span class="p">(</span><span class="n">ind</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
        <span class="n">cloud_out</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="n">ind</span><span class="p">]</span><span class="o">=</span><span class="mi">0</span>
    <span class="n">nb_points</span> <span class="o">=</span> <span class="n">cloud_out</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">cent_mat</span> <span class="o">=</span> <span class="n">cent</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">ones</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span><span class="n">nb_points</span><span class="p">)))</span>
    <span class="sd">&quot;&quot;&quot;# Elliptical projection</span>
<span class="sd">    nb_points = clouds.shape[1]</span>

<span class="sd">    weights = sqrt(ones((2,1)).dot(clouds[2,:].reshape((1,nb_points)))/siz)</span>
<span class="sd">    #weights = ones((2,nb_points))</span>

<span class="sd">    cloud_out[0:2,:] = proj_ellip(cent_mat,weights,cloud_out[0:2,:],nb_iter=nb_iter,tol=tol)</span>
<span class="sd">    print norm(cloud_out[0:2,:]-clouds[0:2,:])</span>
<span class="sd">    # Intensities adjustement</span>
<span class="sd">    cloud_out[0:2,:] = inertia*(cloud_out[0:2,:]-cent_mat)/norm(cloud_out[0:2,:]-cent_mat)+cent_mat&quot;&quot;&quot;</span>
    <span class="n">norms</span> <span class="o">=</span> <span class="n">norm</span><span class="p">(</span><span class="n">cloud_out</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">,:]</span><span class="o">-</span><span class="n">cent_mat</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span>
    <span class="nb">print</span> <span class="s2">&quot;Max siz: &quot;</span><span class="p">,</span><span class="n">siz</span><span class="p">,</span><span class="s2">&quot;; effective size: &quot;</span><span class="p">,</span><span class="nb">sum</span><span class="p">(</span><span class="n">norms</span><span class="o">*</span><span class="n">cloud_out</span><span class="p">[</span><span class="mi">2</span><span class="p">,:])</span>
    <span class="n">const_mat</span> <span class="o">=</span> <span class="n">ones</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span><span class="n">nb_points</span><span class="p">))</span>
    <span class="n">const_mat</span><span class="p">[</span><span class="mi">0</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">norms</span>
    <span class="n">const_vect</span> <span class="o">=</span> <span class="n">ones</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>
    <span class="n">const_vect</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">siz</span>
    <span class="k">if</span> <span class="n">acc</span><span class="p">:</span>
        <span class="n">cloud_out</span><span class="p">[</span><span class="mi">2</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">cloud_size_constraint_acc</span><span class="p">(</span><span class="n">cloud_out</span><span class="p">[</span><span class="mi">2</span><span class="p">,:],</span><span class="n">const_mat</span><span class="p">,</span><span class="n">const_vect</span><span class="p">,</span><span class="n">nb_iter</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span><span class="n">tol</span><span class="o">=</span><span class="mf">1.e-12</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">temp_m</span> <span class="o">=</span> <span class="n">transpose</span><span class="p">(</span><span class="n">const_mat</span><span class="p">)</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">inv</span><span class="p">(</span><span class="n">const_mat</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">transpose</span><span class="p">(</span><span class="n">const_mat</span><span class="p">))))</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">const_mat</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">cloud_out</span><span class="p">[</span><span class="mi">2</span><span class="p">,:]</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">nb_points</span><span class="p">,</span><span class="mi">1</span><span class="p">)))</span><span class="o">-</span><span class="n">const_vect</span><span class="p">)</span>
        <span class="n">cloud_out</span><span class="p">[</span><span class="mi">2</span><span class="p">,:]</span>  <span class="o">=</span> <span class="n">cloud_out</span><span class="p">[</span><span class="mi">2</span><span class="p">,:]</span> <span class="o">-</span> <span class="n">temp_m</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">nb_points</span><span class="p">,))</span>
    <span class="nb">print</span> <span class="s2">&quot;Size after correction: &quot;</span><span class="p">,</span><span class="nb">sum</span><span class="p">(</span><span class="n">norms</span><span class="o">*</span><span class="n">cloud_out</span><span class="p">[</span><span class="mi">2</span><span class="p">,:])</span>
    <span class="n">pos_ind</span> <span class="o">=</span> <span class="n">where</span><span class="p">(</span><span class="n">cloud_out</span><span class="p">[</span><span class="mi">2</span><span class="p">,:]</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">cloud_out</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="n">pos_ind</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">return</span> <span class="n">cloud_out</span>

<span class="k">def</span> <span class="nf">cloud_size_constraint_acc</span><span class="p">(</span><span class="n">gray_lev</span><span class="p">,</span><span class="n">const_mat</span><span class="p">,</span><span class="n">const_vect</span><span class="p">,</span><span class="n">nb_iter</span><span class="o">=</span><span class="mi">2000</span><span class="p">,</span><span class="n">tol</span><span class="o">=</span><span class="mf">1.e-15</span><span class="p">):</span>
    <span class="kn">from</span> <span class="nn">numpy</span> <span class="k">import</span> <span class="n">copy</span><span class="p">,</span><span class="n">zeros</span>
    <span class="kn">from</span> <span class="nn">numpy.linalg</span> <span class="k">import</span> <span class="n">norm</span><span class="p">,</span><span class="n">inv</span>

    <span class="n">nb_points</span> <span class="o">=</span> <span class="n">size</span><span class="p">(</span><span class="n">gray_lev</span><span class="p">)</span>

    <span class="n">w1</span> <span class="o">=</span> <span class="mf">0.5</span>
    <span class="n">w2</span> <span class="o">=</span> <span class="mi">1</span><span class="o">-</span><span class="n">w1</span>
    <span class="n">z1</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">gray_lev</span><span class="p">)</span>
    <span class="n">z2</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">gray_lev</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">gray_lev</span><span class="p">)</span>
    <span class="n">gamma</span> <span class="o">=</span> <span class="mf">1.0</span>
    <span class="n">lambd</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="n">i</span><span class="o">=</span><span class="mi">0</span>
    <span class="n">var</span> <span class="o">=</span> <span class="mi">100</span>

    <span class="k">while</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">nb_iter</span> <span class="ow">and</span> <span class="n">var</span> <span class="o">&gt;</span> <span class="n">tol</span><span class="p">:</span>

        <span class="c1"># Moment constraint</span>
        <span class="n">temp1</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">x</span><span class="o">-</span><span class="n">z1</span><span class="o">-</span><span class="n">gamma</span><span class="o">*</span><span class="p">(</span><span class="n">x</span><span class="o">-</span><span class="n">gray_lev</span><span class="p">)</span>
        <span class="n">temp_m</span> <span class="o">=</span> <span class="n">transpose</span><span class="p">(</span><span class="n">const_mat</span><span class="p">)</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">inv</span><span class="p">(</span><span class="n">const_mat</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">transpose</span><span class="p">(</span><span class="n">const_mat</span><span class="p">))))</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">const_mat</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">temp1</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">nb_points</span><span class="p">,</span><span class="mi">1</span><span class="p">)))</span><span class="o">-</span><span class="n">const_vect</span><span class="p">)</span>
        <span class="n">prox_step</span> <span class="o">=</span> <span class="n">temp1</span> <span class="o">-</span> <span class="n">temp_m</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">nb_points</span><span class="p">,))</span>
        <span class="n">z1</span> <span class="o">+=</span> <span class="n">lambd</span><span class="o">*</span><span class="p">(</span><span class="n">prox_step</span><span class="o">-</span><span class="n">x</span><span class="p">)</span>

        <span class="c1"># Positivity constraint</span>
        <span class="n">temp1</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">x</span><span class="o">-</span><span class="n">z2</span><span class="o">-</span><span class="n">gamma</span><span class="o">*</span><span class="p">(</span><span class="n">x</span><span class="o">-</span><span class="n">gray_lev</span><span class="p">)</span>
        <span class="n">z2</span> <span class="o">+=</span> <span class="n">lambd</span><span class="o">*</span><span class="p">(</span><span class="n">pos_proj</span><span class="p">(</span><span class="n">temp1</span><span class="p">)</span><span class="o">-</span><span class="n">x</span><span class="p">)</span>

        <span class="c1"># Average</span>
        <span class="n">xold</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">w1</span><span class="o">*</span><span class="n">z1</span><span class="o">+</span><span class="n">w2</span><span class="o">*</span><span class="n">z2</span>
        <span class="n">var</span> <span class="o">=</span> <span class="mi">100</span><span class="o">*</span><span class="n">norm</span><span class="p">(</span><span class="n">x</span><span class="o">-</span><span class="n">xold</span><span class="p">)</span><span class="o">/</span><span class="n">norm</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">i</span><span class="o">+=</span><span class="mi">1</span>

    <span class="k">return</span> <span class="n">x</span>

<span class="k">def</span> <span class="nf">cloud_segmentation</span><span class="p">(</span><span class="n">arr</span><span class="p">,</span><span class="n">frac_size</span><span class="p">,</span><span class="n">rand_en</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span> <span class="c1"># The number of points is supposed to be a multiple of frac_size; the sample are in the rows.</span>
    <span class="kn">from</span> <span class="nn">pyflann</span> <span class="k">import</span> <span class="n">FLANN</span>
    <span class="kn">from</span> <span class="nn">numpy</span> <span class="k">import</span> <span class="n">arange</span><span class="p">,</span><span class="n">zeros</span>
    <span class="kn">from</span> <span class="nn">numpy.random</span> <span class="k">import</span> <span class="n">permutation</span>

    <span class="n">knn</span> <span class="o">=</span> <span class="n">FLANN</span><span class="p">()</span>
    <span class="n">params</span> <span class="o">=</span> <span class="n">knn</span><span class="o">.</span><span class="n">build_index</span><span class="p">(</span><span class="n">array</span><span class="p">(</span><span class="n">arr</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">float64</span><span class="p">))</span>
    <span class="n">nb_samp</span>  <span class="o">=</span> <span class="n">arr</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">result</span><span class="p">,</span> <span class="n">dists</span> <span class="o">=</span> <span class="n">knn</span><span class="o">.</span><span class="n">nn_index</span><span class="p">(</span><span class="n">arr</span><span class="p">,</span><span class="n">nb_samp</span><span class="p">)</span>

    <span class="n">ind</span> <span class="o">=</span> <span class="n">arange</span><span class="p">(</span><span class="n">nb_samp</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">rand_en</span><span class="p">:</span>
        <span class="n">ind</span> <span class="o">=</span> <span class="n">permutation</span><span class="p">(</span><span class="n">ind</span><span class="p">)</span>

    <span class="n">nb_parts</span> <span class="o">=</span> <span class="n">nb_samp</span><span class="o">/</span><span class="n">frac_size</span>
    <span class="n">parts</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">nb_parts</span><span class="p">,</span><span class="n">frac_size</span><span class="p">))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
    <span class="n">ref</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">arr</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">nb_parts</span><span class="p">))</span>
    <span class="n">diff_vect</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">arr</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">frac_size</span><span class="p">,</span><span class="n">nb_parts</span><span class="p">))</span>

    <span class="n">check</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">nb_samp</span><span class="p">,))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">bool</span><span class="p">)</span>
    <span class="n">i</span><span class="o">=</span><span class="mi">0</span>
    <span class="n">uncheck</span> <span class="o">=</span> <span class="n">nb_samp</span>

    <span class="k">while</span> <span class="n">uncheck</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">check</span><span class="p">[</span><span class="n">ind</span><span class="p">[</span><span class="n">i</span><span class="p">]]:</span>
            <span class="n">ref</span><span class="p">[:,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">arr</span><span class="p">[</span><span class="n">ind</span><span class="p">[</span><span class="n">i</span><span class="p">],:]</span>
            <span class="n">n_check</span> <span class="o">=</span> <span class="n">where</span><span class="p">(</span><span class="n">check</span><span class="p">[</span><span class="n">result</span><span class="p">[</span><span class="n">ind</span><span class="p">[</span><span class="n">i</span><span class="p">],:]]</span> <span class="o">==</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">check</span><span class="p">[</span><span class="n">n_check</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">:</span><span class="n">frac_size</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">frac_size</span><span class="p">):</span>
                <span class="n">parts</span><span class="p">[</span><span class="n">ind</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="n">ind</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">n_check</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">j</span><span class="p">]]</span>
                <span class="n">diff_vect</span><span class="p">[:,</span><span class="n">count</span><span class="p">,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">arr</span><span class="p">[</span><span class="n">result</span><span class="p">[</span><span class="n">ind</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">n_check</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">j</span><span class="p">]],:]</span><span class="o">+</span><span class="n">arr</span><span class="p">[</span><span class="n">result</span><span class="p">[</span><span class="n">ind</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">n_check</span><span class="p">[</span><span class="mi">0</span><span class="p">][(</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">%</span><span class="n">frac_size</span><span class="p">]],:]</span>
        <span class="n">i</span><span class="o">+=</span><span class="mi">1</span>
        <span class="n">uncheck</span><span class="o">-=</span><span class="n">frac_size</span>

    <span class="k">return</span> <span class="n">parts</span><span class="p">,</span><span class="n">diff_vect</span><span class="p">,</span><span class="n">ref</span>

<span class="k">def</span> <span class="nf">cloud_reconstruction</span><span class="p">(</span><span class="n">parts</span><span class="p">,</span><span class="n">diff_vect</span><span class="p">,</span><span class="n">ref</span><span class="p">,</span><span class="n">eps</span><span class="o">=</span><span class="mf">1.e-15</span><span class="p">):</span> <span class="c1"># The output samples are in the rows</span>
    <span class="kn">from</span> <span class="nn">numpy</span> <span class="k">import</span> <span class="n">zeros</span><span class="p">,</span><span class="n">size</span>
    <span class="kn">from</span> <span class="nn">numpy.linalg</span> <span class="k">import</span> <span class="n">norm</span>
    <span class="n">nb_parts</span> <span class="o">=</span> <span class="n">ref</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">nb_samp</span> <span class="o">=</span> <span class="n">size</span><span class="p">(</span><span class="n">parts</span><span class="p">)</span>
    <span class="n">frac_size</span> <span class="o">=</span> <span class="n">parts</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">samp_dim</span> <span class="o">=</span> <span class="n">ref</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">arr</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">nb_samp</span><span class="p">,</span><span class="n">samp_dim</span><span class="p">))</span>
    <span class="n">disc_perc</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">nb_parts</span><span class="p">,))</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_parts</span><span class="p">):</span>
        <span class="n">arr</span><span class="p">[</span><span class="n">parts</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">0</span><span class="p">],:]</span> <span class="o">=</span> <span class="n">ref</span><span class="p">[:,</span><span class="n">i</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">parts</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
            <span class="n">arr</span><span class="p">[</span><span class="n">parts</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">],:]</span><span class="o">=</span><span class="n">arr</span><span class="p">[</span><span class="n">parts</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">],:]</span><span class="o">+</span><span class="n">diff_vect</span><span class="p">[:,</span><span class="n">j</span><span class="p">,</span><span class="n">i</span><span class="p">]</span>
        <span class="n">disc_perc</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">100</span><span class="o">*</span><span class="n">norm</span><span class="p">(</span><span class="n">ref</span><span class="p">[:,</span><span class="n">i</span><span class="p">]</span><span class="o">-</span><span class="n">arr</span><span class="p">[</span><span class="n">parts</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">],:]</span><span class="o">-</span><span class="n">diff_vect</span><span class="p">[:,</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">i</span><span class="p">])</span><span class="o">/</span><span class="p">(</span><span class="n">norm</span><span class="p">(</span><span class="n">ref</span><span class="p">[:,</span><span class="n">i</span><span class="p">])</span><span class="o">+</span><span class="n">eps</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">arr</span><span class="p">,</span><span class="n">disc_perc</span>


<span class="sd">&quot;&quot;&quot;def cloud_segments_constraint(diff_vect,rad,nb_iter=10):</span>
<span class="sd">    from numpy import copy</span>
<span class="sd">    from numpy.linalg import norm</span>

<span class="sd">    diff_vect_out = copy(diff_vect)</span>
<span class="sd">    norms = norm(diff_vect_out,axis=0)</span>
<span class="sd">    i=0&quot;&quot;&quot;</span>


<span class="k">def</span> <span class="nf">lasso_cumul</span><span class="p">(</span><span class="n">arr_in</span><span class="p">,</span><span class="n">lines</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="kn">from</span> <span class="nn">numpy</span> <span class="k">import</span> <span class="n">zeros</span><span class="p">,</span><span class="n">cumsum</span><span class="p">,</span><span class="n">transpose</span>
    <span class="n">shap</span> <span class="o">=</span> <span class="n">arr_in</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">arr</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">arr_in</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">lines</span><span class="p">:</span>
        <span class="n">arr</span> <span class="o">=</span> <span class="n">transpose</span><span class="p">(</span><span class="n">arr</span><span class="p">)</span>
    <span class="n">out</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">arr</span><span class="p">)</span>
    <span class="n">total</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>

        <span class="n">l</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">arr</span><span class="p">[</span><span class="n">i</span><span class="p">,:])</span>
        <span class="k">if</span> <span class="n">i</span><span class="o">%</span><span class="mi">2</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
            <span class="n">l</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+=</span><span class="n">total</span>
            <span class="n">out</span><span class="p">[</span><span class="n">i</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">cumsum</span><span class="p">(</span><span class="n">l</span><span class="p">)</span>
            <span class="n">total</span> <span class="o">=</span> <span class="n">out</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">l</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+=</span><span class="n">total</span>
            <span class="n">out</span><span class="p">[</span><span class="n">i</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">cumsum</span><span class="p">(</span><span class="n">l</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">])[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">total</span> <span class="o">=</span> <span class="n">out</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">lines</span><span class="p">:</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">transpose</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">out</span>

<span class="k">def</span> <span class="nf">lasso_cumul_transp</span><span class="p">(</span><span class="n">arr</span><span class="p">,</span><span class="n">lines</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="kn">from</span> <span class="nn">numpy</span> <span class="k">import</span> <span class="n">flipud</span><span class="p">,</span><span class="n">rot90</span>

    <span class="k">if</span> <span class="n">arr</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">%</span><span class="mi">2</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">flipud</span><span class="p">(</span><span class="n">lasso_cumul</span><span class="p">(</span><span class="n">flipud</span><span class="p">(</span><span class="n">arr</span><span class="p">),</span><span class="n">lines</span><span class="o">=</span><span class="n">lines</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">rot90</span><span class="p">(</span><span class="n">lasso_cumul</span><span class="p">(</span><span class="n">rot90</span><span class="p">(</span><span class="n">arr</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span><span class="n">lines</span><span class="o">=</span><span class="n">lines</span><span class="p">),</span><span class="mi">2</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">angle_proj</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">angle_min</span><span class="p">,</span><span class="n">nb_samp</span><span class="o">=</span><span class="mi">10</span><span class="p">):</span>
    <span class="kn">from</span> <span class="nn">numpy.linalg</span> <span class="k">import</span> <span class="n">norm</span>
    <span class="kn">from</span> <span class="nn">numpy</span> <span class="k">import</span> <span class="n">arccos</span><span class="p">,</span><span class="n">pi</span>
    <span class="n">a_out</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
    <span class="n">b_out</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
    <span class="n">na</span> <span class="o">=</span> <span class="n">norm</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
    <span class="n">nb</span> <span class="o">=</span> <span class="n">norm</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
    <span class="n">theta</span> <span class="o">=</span> <span class="n">angle_min</span>
    <span class="k">if</span> <span class="n">na</span> <span class="o">&gt;</span><span class="mi">0</span> <span class="ow">and</span> <span class="n">nb</span> <span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
        <span class="n">cos_theta</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">a</span><span class="o">*</span><span class="n">b</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">na</span><span class="o">*</span><span class="n">nb</span><span class="p">)</span>
        <span class="n">theta</span> <span class="o">=</span> <span class="n">arccos</span><span class="p">(</span><span class="n">cos_theta</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">theta</span><span class="o">&gt;=</span><span class="n">angle_min</span> <span class="ow">or</span> <span class="n">theta</span><span class="o">==</span><span class="mf">0.0</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">a_out</span><span class="p">,</span><span class="n">b_out</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">v1</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
        <span class="n">v2</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
        <span class="n">det</span> <span class="o">=</span> <span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">b</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">a</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">b</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">det</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">:</span>
            <span class="n">v1</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
            <span class="n">v2</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
        <span class="n">v1</span><span class="p">,</span><span class="n">v2</span> <span class="o">=</span> <span class="n">direction_optim_brute_force</span><span class="p">(</span><span class="n">v1</span><span class="p">,</span><span class="n">v2</span><span class="p">,</span><span class="n">angle_min</span><span class="o">-</span><span class="n">theta</span><span class="p">,</span><span class="n">nb_samp</span><span class="o">=</span><span class="n">nb_samp</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">det</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">v1</span><span class="p">,</span><span class="n">v2</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">v2</span><span class="p">,</span><span class="n">v1</span>

<span class="k">def</span> <span class="nf">angle_proj_array</span><span class="p">(</span><span class="n">vect_x_l</span><span class="p">,</span><span class="n">vect_y_l</span><span class="p">,</span><span class="n">vect_x_c</span><span class="p">,</span><span class="n">vect_y_c</span><span class="p">,</span><span class="n">angle_min</span><span class="p">,</span><span class="n">nb_samp</span><span class="o">=</span><span class="mi">10</span><span class="p">):</span>
    <span class="kn">from</span> <span class="nn">numpy.linalg</span> <span class="k">import</span> <span class="n">norm</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">vect_x_l</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">vect_x_l</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
            <span class="n">a</span> <span class="o">=</span> <span class="n">array</span><span class="p">([</span><span class="n">vect_x_l</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">],</span><span class="n">vect_y_l</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]])</span>
            <span class="n">b</span> <span class="o">=</span> <span class="n">array</span><span class="p">([</span><span class="n">vect_x_c</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">],</span><span class="n">vect_y_c</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]])</span>
            <span class="n">a</span><span class="p">,</span><span class="n">b</span> <span class="o">=</span> <span class="n">angle_proj</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">angle_min</span><span class="p">,</span><span class="n">nb_samp</span><span class="o">=</span><span class="n">nb_samp</span><span class="p">)</span>
            <span class="n">vect_x_l</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">],</span><span class="n">vect_y_l</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">a</span>
            <span class="n">vect_x_c</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">],</span><span class="n">vect_y_c</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">b</span>

    <span class="k">return</span> <span class="n">vect_x_l</span><span class="p">,</span><span class="n">vect_y_l</span><span class="p">,</span><span class="n">vect_x_c</span><span class="p">,</span><span class="n">vect_y_c</span>

<span class="k">def</span> <span class="nf">rot_2D</span><span class="p">(</span><span class="n">u</span><span class="p">,</span><span class="n">theta</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">array</span><span class="p">([</span><span class="n">cos</span><span class="p">(</span><span class="n">theta</span><span class="p">)</span><span class="o">*</span><span class="n">u</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">sin</span><span class="p">(</span><span class="n">theta</span><span class="p">)</span><span class="o">*</span><span class="n">u</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">sin</span><span class="p">(</span><span class="n">theta</span><span class="p">)</span><span class="o">*</span><span class="n">u</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">cos</span><span class="p">(</span><span class="n">theta</span><span class="p">)</span><span class="o">*</span><span class="n">u</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span>


<span class="k">def</span> <span class="nf">direction_optim_brute_force</span><span class="p">(</span><span class="n">v1</span><span class="p">,</span><span class="n">v2</span><span class="p">,</span><span class="n">theta_max</span><span class="p">,</span><span class="n">nb_samp</span><span class="o">=</span><span class="mi">10</span><span class="p">):</span>
    <span class="kn">from</span> <span class="nn">numpy.linalg</span> <span class="k">import</span> <span class="n">norm</span>
    <span class="kn">from</span> <span class="nn">numpy</span> <span class="k">import</span> <span class="n">zeros</span><span class="p">,</span><span class="n">copy</span>

    <span class="n">cos_fact_max</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">v1_out</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">v1</span><span class="p">)</span>
    <span class="n">v2_out</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">v2</span><span class="p">)</span>
    <span class="n">nv1</span> <span class="o">=</span> <span class="n">norm</span><span class="p">(</span><span class="n">v1</span><span class="p">)</span>
    <span class="n">nv2</span> <span class="o">=</span> <span class="n">norm</span><span class="p">(</span><span class="n">v2</span><span class="p">)</span>
    <span class="n">count</span> <span class="o">=</span> <span class="mf">0.0</span>

    <span class="k">while</span><span class="p">(</span><span class="n">count</span><span class="o">&lt;</span><span class="n">nb_samp</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
        <span class="n">cos_fact</span> <span class="o">=</span> <span class="n">nv1</span><span class="o">*</span><span class="n">cos</span><span class="p">(</span><span class="n">count</span><span class="o">*</span><span class="n">theta_max</span><span class="o">/</span><span class="n">nb_samp</span><span class="p">)</span><span class="o">+</span><span class="n">nv2</span><span class="o">*</span><span class="n">cos</span><span class="p">((</span><span class="n">nb_samp</span><span class="o">-</span><span class="n">count</span><span class="p">)</span><span class="o">*</span><span class="n">theta_max</span><span class="o">/</span><span class="n">nb_samp</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">cos_fact</span><span class="o">&gt;</span><span class="n">cos_fact_max</span><span class="p">:</span>
            <span class="n">v1_out</span> <span class="o">=</span> <span class="n">rot_2D</span><span class="p">(</span><span class="n">v1</span><span class="p">,</span><span class="o">-</span><span class="n">count</span><span class="o">*</span><span class="n">theta_max</span><span class="o">/</span><span class="n">nb_samp</span><span class="p">)</span>
            <span class="n">v2_out</span> <span class="o">=</span> <span class="n">rot_2D</span><span class="p">(</span><span class="n">v2</span><span class="p">,(</span><span class="n">nb_samp</span><span class="o">-</span><span class="n">count</span><span class="p">)</span><span class="o">*</span><span class="n">theta_max</span><span class="o">/</span><span class="n">nb_samp</span><span class="p">)</span>
        <span class="n">count</span><span class="o">+=</span><span class="mf">1.0</span>

    <span class="k">return</span> <span class="n">v1_out</span><span class="p">,</span><span class="n">v2_out</span>

<span class="k">def</span> <span class="nf">diff_coord_mat</span><span class="p">(</span><span class="n">arr_in</span><span class="p">,</span><span class="n">lines</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="kn">from</span> <span class="nn">numpy</span> <span class="k">import</span> <span class="n">diff</span><span class="p">,</span><span class="n">transpose</span>

    <span class="n">arr</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">arr_in</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">lines</span><span class="p">:</span>
        <span class="n">arr</span> <span class="o">=</span> <span class="n">transpose</span><span class="p">(</span><span class="n">arr</span><span class="p">)</span>
    <span class="n">out</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">arr</span><span class="p">)</span>
    <span class="n">shap</span> <span class="o">=</span> <span class="n">arr</span><span class="o">.</span><span class="n">shape</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
        <span class="k">if</span> <span class="n">i</span><span class="o">%</span><span class="mi">2</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
            <span class="n">out</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">1</span><span class="p">:]</span> <span class="o">=</span> <span class="n">diff</span><span class="p">(</span><span class="n">arr</span><span class="p">[</span><span class="n">i</span><span class="p">,:])</span>
            <span class="k">if</span> <span class="n">i</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
                <span class="n">out</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">arr</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">arr</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">out</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="o">-</span><span class="mi">2</span><span class="p">::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">diff</span><span class="p">(</span><span class="n">arr</span><span class="p">[</span><span class="n">i</span><span class="p">,:][::</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">out</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">arr</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">arr</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">lines</span><span class="p">:</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">transpose</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">out</span>

<span class="k">def</span> <span class="nf">lasso_constraint</span><span class="p">(</span><span class="n">pos_mat</span><span class="p">,</span><span class="n">shap</span><span class="p">,</span><span class="n">r_min</span><span class="p">,</span><span class="n">angle_min</span><span class="p">,</span><span class="n">nb_iter</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span><span class="n">mu</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">tol</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">var_tol</span><span class="o">=</span><span class="mf">1.e-25</span><span class="p">):</span>
    <span class="kn">from</span> <span class="nn">numpy</span> <span class="k">import</span> <span class="n">sqrt</span><span class="p">,</span><span class="n">copy</span>
    <span class="kn">from</span> <span class="nn">numpy.linalg</span> <span class="k">import</span> <span class="n">norm</span>

    <span class="n">xcoord</span> <span class="o">=</span> <span class="n">pos_mat</span><span class="p">[</span><span class="mi">0</span><span class="p">,:]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">shap</span><span class="p">)</span>
    <span class="n">ycoord</span> <span class="o">=</span> <span class="n">pos_mat</span><span class="p">[</span><span class="mi">1</span><span class="p">,:]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">shap</span><span class="p">)</span>

    <span class="n">vect_x_l</span> <span class="o">=</span> <span class="n">diff_coord_mat</span><span class="p">(</span><span class="n">xcoord</span><span class="p">,</span><span class="n">lines</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">vect_x_c</span> <span class="o">=</span> <span class="n">diff_coord_mat</span><span class="p">(</span><span class="n">xcoord</span><span class="p">,</span><span class="n">lines</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="n">vect_y_l</span> <span class="o">=</span> <span class="n">diff_coord_mat</span><span class="p">(</span><span class="n">ycoord</span><span class="p">,</span><span class="n">lines</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">vect_y_c</span> <span class="o">=</span> <span class="n">diff_coord_mat</span><span class="p">(</span><span class="n">ycoord</span><span class="p">,</span><span class="n">lines</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>


    <span class="n">vect_x_l</span><span class="p">,</span><span class="n">vect_x_c</span><span class="p">,</span><span class="n">vect_y_l</span><span class="p">,</span><span class="n">vect_y_c</span> <span class="o">=</span> <span class="n">retraction_lasso</span><span class="p">(</span><span class="n">vect_x_l</span><span class="p">,</span><span class="n">vect_x_c</span><span class="p">,</span><span class="n">vect_y_l</span><span class="p">,</span><span class="n">vect_y_c</span><span class="p">,</span><span class="n">r_min</span><span class="p">,</span><span class="n">angle_min</span><span class="p">)</span>

    <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">r_data</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">max_disc</span> <span class="o">=</span> <span class="mi">100</span>
    <span class="n">rel_var</span> <span class="o">=</span> <span class="mi">100</span>

    <span class="k">while</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">nb_iter</span> <span class="ow">and</span> <span class="n">max_disc</span><span class="o">&gt;</span><span class="n">tol</span> <span class="ow">and</span> <span class="n">rel_var</span><span class="o">&gt;</span><span class="n">var_tol</span><span class="p">:</span>

        <span class="c1"># Riemanian gradient</span>
        <span class="n">tg_grad_x_l</span><span class="p">,</span><span class="n">tg_grad_x_c</span><span class="p">,</span><span class="n">tg_grad_y_l</span><span class="p">,</span><span class="n">tg_grad_y_c</span> <span class="o">=</span> <span class="n">tg_gradient</span><span class="p">(</span><span class="n">vect_x_l</span><span class="p">,</span><span class="n">vect_x_c</span><span class="p">,</span><span class="n">vect_y_l</span><span class="p">,</span><span class="n">vect_y_c</span><span class="p">,</span><span class="n">r_min</span><span class="p">)</span>

        <span class="c1"># Update using Armijo rule</span>
        <span class="n">vect_x_l_old</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">vect_x_l</span><span class="p">)</span>
        <span class="n">vect_y_l_old</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">vect_y_l</span><span class="p">)</span>
        <span class="n">vect_x_c_old</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">vect_x_c</span><span class="p">)</span>
        <span class="n">vect_y_c_old</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">vect_y_c</span><span class="p">)</span>
        <span class="n">vect_x_l</span><span class="p">,</span><span class="n">vect_x_c</span><span class="p">,</span><span class="n">vect_y_l</span><span class="p">,</span><span class="n">vect_y_c</span> <span class="o">=</span> <span class="n">armijo_lasso</span><span class="p">(</span><span class="n">vect_x_l</span><span class="p">,</span><span class="n">vect_x_c</span><span class="p">,</span><span class="n">vect_y_l</span><span class="p">,</span><span class="n">vect_y_c</span><span class="p">,</span><span class="n">tg_grad_x_l</span><span class="p">,</span><span class="n">tg_grad_x_c</span><span class="p">,</span><span class="n">tg_grad_y_l</span><span class="p">,</span><span class="n">tg_grad_y_c</span><span class="p">,</span><span class="n">r_min</span><span class="p">,</span><span class="n">angle_min</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span><span class="n">beta</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span><span class="n">sigma</span><span class="o">=</span><span class="mf">1.e-5</span><span class="p">)</span>
        <span class="n">i</span><span class="o">+=</span><span class="mi">1</span>


        <span class="c1"># Lassos discrepancies check</span>
        <span class="n">disc1</span> <span class="o">=</span> <span class="mi">100</span><span class="o">*</span><span class="n">norm</span><span class="p">(</span><span class="n">lasso_cumul</span><span class="p">(</span><span class="n">vect_x_l</span><span class="p">,</span><span class="n">lines</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">-</span><span class="n">lasso_cumul</span><span class="p">(</span><span class="n">vect_x_c</span><span class="p">,</span><span class="n">lines</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span><span class="o">/</span><span class="n">norm</span><span class="p">(</span><span class="n">lasso_cumul</span><span class="p">(</span><span class="n">vect_x_l</span><span class="p">,</span><span class="n">lines</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
        <span class="n">disc2</span> <span class="o">=</span> <span class="mi">100</span><span class="o">*</span><span class="n">norm</span><span class="p">(</span><span class="n">lasso_cumul</span><span class="p">(</span><span class="n">vect_y_l</span><span class="p">,</span><span class="n">lines</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">-</span><span class="n">lasso_cumul</span><span class="p">(</span><span class="n">vect_y_c</span><span class="p">,</span><span class="n">lines</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span><span class="o">/</span><span class="n">norm</span><span class="p">(</span><span class="n">lasso_cumul</span><span class="p">(</span><span class="n">vect_y_l</span><span class="p">,</span><span class="n">lines</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
        <span class="n">max_disc</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">disc1</span><span class="p">,</span><span class="n">disc2</span><span class="p">)</span><span class="o">/</span><span class="n">xcoord</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="nb">print</span> <span class="s2">&quot;Position average discrepancy: &quot;</span><span class="p">,</span><span class="n">max_disc</span><span class="p">,</span><span class="s2">&quot;%&quot;</span><span class="p">,</span><span class="s2">&quot; Tolerance &quot;</span><span class="p">,</span><span class="n">tol</span><span class="p">,</span><span class="s2">&quot; relative iterates variation: &quot;</span><span class="p">,</span><span class="n">rel_var</span><span class="p">,</span><span class="s2">&quot;%&quot;</span><span class="p">,</span><span class="s2">&quot; Variation tolerance: &quot;</span><span class="p">,</span><span class="n">var_tol</span><span class="p">,</span><span class="s2">&quot; Nb iter max: &quot;</span><span class="p">,</span><span class="n">nb_iter</span>

        <span class="c1"># Relative variation</span>
        <span class="n">rel_var</span> <span class="o">=</span> <span class="mi">100</span><span class="o">*</span><span class="p">(</span><span class="n">norm</span><span class="p">(</span><span class="n">vect_x_l_old</span><span class="o">-</span><span class="n">vect_x_l</span><span class="p">)</span><span class="o">/</span><span class="n">norm</span><span class="p">(</span><span class="n">vect_x_l_old</span><span class="p">)</span> <span class="o">+</span> <span class="n">norm</span><span class="p">(</span><span class="n">vect_y_l_old</span><span class="o">-</span><span class="n">vect_y_l</span><span class="p">)</span><span class="o">/</span><span class="n">norm</span><span class="p">(</span><span class="n">vect_y_l_old</span><span class="p">)</span> <span class="o">+</span> <span class="n">norm</span><span class="p">(</span><span class="n">vect_x_c_old</span><span class="o">-</span><span class="n">vect_x_c</span><span class="p">)</span><span class="o">/</span><span class="n">norm</span><span class="p">(</span><span class="n">vect_x_c_old</span><span class="p">)</span> <span class="o">+</span> <span class="n">norm</span><span class="p">(</span><span class="n">vect_y_c_old</span><span class="o">-</span><span class="n">vect_y_c</span><span class="p">)</span><span class="o">/</span><span class="n">norm</span><span class="p">(</span><span class="n">vect_y_c_old</span><span class="p">))</span><span class="o">/</span><span class="mi">4</span>

    <span class="nb">print</span> <span class="s2">&quot;Position average discrepancy: &quot;</span><span class="p">,</span><span class="n">max_disc</span><span class="p">,</span><span class="s2">&quot;%&quot;</span><span class="p">,</span><span class="s2">&quot; Tolerance &quot;</span><span class="p">,</span><span class="n">tol</span><span class="p">,</span><span class="s2">&quot; relative iterates variation: &quot;</span><span class="p">,</span><span class="n">rel_var</span><span class="p">,</span><span class="s2">&quot;%&quot;</span><span class="p">,</span><span class="s2">&quot; Variation tolerance: &quot;</span><span class="p">,</span><span class="n">var_tol</span><span class="p">,</span><span class="s2">&quot; Nb iter max: &quot;</span><span class="p">,</span><span class="n">nb_iter</span>

    <span class="n">vect_x_l</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">xcoord</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">vect_y_l</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">ycoord</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>

    <span class="n">pos_out</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">pos_mat</span><span class="p">)</span>
    <span class="n">pos_out</span><span class="p">[</span><span class="mi">0</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">lasso_cumul</span><span class="p">(</span><span class="n">vect_x_l</span><span class="p">,</span><span class="n">lines</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">],))</span>
    <span class="n">pos_out</span><span class="p">[</span><span class="mi">1</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">lasso_cumul</span><span class="p">(</span><span class="n">vect_y_l</span><span class="p">,</span><span class="n">lines</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">],))</span>

    <span class="n">d</span> <span class="o">=</span> <span class="n">dist_map_2</span><span class="p">(</span><span class="n">pos_out</span><span class="p">)</span>
    <span class="n">i</span><span class="p">,</span><span class="n">j</span> <span class="o">=</span> <span class="n">where</span><span class="p">(</span><span class="n">d</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">)</span>
    <span class="nb">print</span> <span class="s2">&quot;Mean dist after correction: &quot;</span><span class="p">,</span><span class="n">d</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>


    <span class="k">return</span> <span class="n">pos_out</span>

<span class="k">def</span> <span class="nf">tg_gradient</span><span class="p">(</span><span class="n">vect_x_l</span><span class="p">,</span><span class="n">vect_x_c</span><span class="p">,</span><span class="n">vect_y_l</span><span class="p">,</span><span class="n">vect_y_c</span><span class="p">,</span><span class="n">r_min</span><span class="p">):</span>

    <span class="kn">from</span> <span class="nn">numpy</span> <span class="k">import</span> <span class="n">sqrt</span><span class="p">,</span><span class="n">copy</span><span class="p">,</span><span class="n">array</span>
    <span class="kn">from</span> <span class="nn">numpy.linalg</span> <span class="k">import</span> <span class="n">norm</span>

    <span class="n">tg_grad_x_l</span> <span class="o">=</span> <span class="n">lasso_cumul_transp</span><span class="p">(</span><span class="n">lasso_cumul</span><span class="p">(</span><span class="n">vect_x_l</span><span class="p">,</span><span class="n">lines</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">-</span><span class="n">lasso_cumul</span><span class="p">(</span><span class="n">vect_x_c</span><span class="p">,</span><span class="n">lines</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span><span class="n">lines</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">tg_grad_x_c</span> <span class="o">=</span> <span class="n">lasso_cumul_transp</span><span class="p">(</span><span class="o">-</span><span class="n">lasso_cumul</span><span class="p">(</span><span class="n">vect_x_l</span><span class="p">,</span><span class="n">lines</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">+</span><span class="n">lasso_cumul</span><span class="p">(</span><span class="n">vect_x_c</span><span class="p">,</span><span class="n">lines</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span><span class="n">lines</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="n">tg_grad_y_l</span> <span class="o">=</span> <span class="n">lasso_cumul_transp</span><span class="p">(</span><span class="n">lasso_cumul</span><span class="p">(</span><span class="n">vect_y_l</span><span class="p">,</span><span class="n">lines</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">-</span><span class="n">lasso_cumul</span><span class="p">(</span><span class="n">vect_y_c</span><span class="p">,</span><span class="n">lines</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span><span class="n">lines</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">tg_grad_y_c</span> <span class="o">=</span> <span class="n">lasso_cumul_transp</span><span class="p">(</span><span class="o">-</span><span class="n">lasso_cumul</span><span class="p">(</span><span class="n">vect_y_l</span><span class="p">,</span><span class="n">lines</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">+</span><span class="n">lasso_cumul</span><span class="p">(</span><span class="n">vect_y_c</span><span class="p">,</span><span class="n">lines</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span><span class="n">lines</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="n">tg_grad_x_l</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">tg_grad_x_c</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">tg_grad_y_l</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">tg_grad_y_c</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="n">d_l</span> <span class="o">=</span> <span class="n">sqrt</span><span class="p">(</span><span class="n">vect_x_l</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="n">vect_y_l</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">indx1</span><span class="p">,</span><span class="n">indy1</span> <span class="o">=</span> <span class="n">where</span><span class="p">(</span><span class="n">d_l</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">id_bound</span> <span class="o">=</span> <span class="n">where</span><span class="p">(</span><span class="n">d_l</span><span class="p">[</span><span class="n">indx1</span><span class="p">,</span><span class="n">indy1</span><span class="p">]</span><span class="o">==</span><span class="n">r_min</span><span class="p">)</span>
    <span class="n">id_bound</span> <span class="o">=</span> <span class="n">id_bound</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">size</span><span class="p">(</span><span class="n">id_bound</span><span class="p">)):</span>
        <span class="c1"># Projection of the euclidian gradients at points at the boundary on the corresponding tangent planes</span>
        <span class="n">tg_grad_x_l</span><span class="p">[</span><span class="n">indx1</span><span class="p">[</span><span class="n">id_bound</span><span class="p">[</span><span class="n">i</span><span class="p">]],</span><span class="n">indy1</span><span class="p">[</span><span class="n">id_bound</span><span class="p">[</span><span class="n">i</span><span class="p">]]],</span><span class="n">tg_grad_y_l</span><span class="p">[</span><span class="n">indx1</span><span class="p">[</span><span class="n">id_bound</span><span class="p">[</span><span class="n">i</span><span class="p">]],</span><span class="n">indy1</span><span class="p">[</span><span class="n">id_bound</span><span class="p">[</span><span class="n">i</span><span class="p">]]]</span> <span class="o">=</span> <span class="n">array</span><span class="p">([</span><span class="n">tg_grad_x_l</span><span class="p">[</span><span class="n">indx1</span><span class="p">[</span><span class="n">id_bound</span><span class="p">[</span><span class="n">i</span><span class="p">]],</span><span class="n">indy1</span><span class="p">[</span><span class="n">id_bound</span><span class="p">[</span><span class="n">i</span><span class="p">]]],</span><span class="n">tg_grad_y_l</span><span class="p">[</span><span class="n">indx1</span><span class="p">[</span><span class="n">id_bound</span><span class="p">[</span><span class="n">i</span><span class="p">]],</span><span class="n">indy1</span><span class="p">[</span><span class="n">id_bound</span><span class="p">[</span><span class="n">i</span><span class="p">]]]])</span> <span class="o">-</span> <span class="p">(</span><span class="n">tg_grad_x_l</span><span class="p">[</span><span class="n">indx1</span><span class="p">[</span><span class="n">id_bound</span><span class="p">[</span><span class="n">i</span><span class="p">]],</span><span class="n">indy1</span><span class="p">[</span><span class="n">id_bound</span><span class="p">[</span><span class="n">i</span><span class="p">]]]</span><span class="o">*</span><span class="n">vect_x_l</span><span class="p">[</span><span class="n">indx1</span><span class="p">[</span><span class="n">id_bound</span><span class="p">[</span><span class="n">i</span><span class="p">]],</span><span class="n">indy1</span><span class="p">[</span><span class="n">id_bound</span><span class="p">[</span><span class="n">i</span><span class="p">]]]</span> <span class="o">+</span> <span class="n">tg_grad_y_l</span><span class="p">[</span><span class="n">indx1</span><span class="p">[</span><span class="n">id_bound</span><span class="p">[</span><span class="n">i</span><span class="p">]],</span><span class="n">indy1</span><span class="p">[</span><span class="n">id_bound</span><span class="p">[</span><span class="n">i</span><span class="p">]]]</span><span class="o">*</span><span class="n">vect_y_l</span><span class="p">[</span><span class="n">indx1</span><span class="p">[</span><span class="n">id_bound</span><span class="p">[</span><span class="n">i</span><span class="p">]],</span><span class="n">indy1</span><span class="p">[</span><span class="n">id_bound</span><span class="p">[</span><span class="n">i</span><span class="p">]]])</span><span class="o">*</span><span class="n">array</span><span class="p">([</span><span class="n">vect_x_l</span><span class="p">[</span><span class="n">indx1</span><span class="p">[</span><span class="n">id_bound</span><span class="p">[</span><span class="n">i</span><span class="p">]],</span><span class="n">indy1</span><span class="p">[</span><span class="n">id_bound</span><span class="p">[</span><span class="n">i</span><span class="p">]]],</span><span class="n">vect_y_l</span><span class="p">[</span><span class="n">indx1</span><span class="p">[</span><span class="n">id_bound</span><span class="p">[</span><span class="n">i</span><span class="p">]],</span><span class="n">indy1</span><span class="p">[</span><span class="n">id_bound</span><span class="p">[</span><span class="n">i</span><span class="p">]]]])</span><span class="o">/</span><span class="n">d_l</span><span class="p">[</span><span class="n">indx1</span><span class="p">[</span><span class="n">id_bound</span><span class="p">[</span><span class="n">i</span><span class="p">]],</span><span class="n">indy1</span><span class="p">[</span><span class="n">id_bound</span><span class="p">[</span><span class="n">i</span><span class="p">]]]</span><span class="o">**</span><span class="mi">2</span>

    <span class="n">d_c</span> <span class="o">=</span> <span class="n">sqrt</span><span class="p">(</span><span class="n">vect_x_c</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="n">vect_y_c</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">indx1</span><span class="p">,</span><span class="n">indy1</span> <span class="o">=</span> <span class="n">where</span><span class="p">(</span><span class="n">d_c</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">id_bound</span> <span class="o">=</span> <span class="n">where</span><span class="p">(</span><span class="n">d_c</span><span class="p">[</span><span class="n">indx1</span><span class="p">,</span><span class="n">indy1</span><span class="p">]</span><span class="o">==</span><span class="n">r_min</span><span class="p">)</span>
    <span class="n">id_bound</span> <span class="o">=</span> <span class="n">id_bound</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">size</span><span class="p">(</span><span class="n">id_bound</span><span class="p">)):</span>
        <span class="c1"># Projection of the euclidian gradients at points at the boundary on the corresponding tangent planes</span>
        <span class="n">tg_grad_x_c</span><span class="p">[</span><span class="n">indx1</span><span class="p">[</span><span class="n">id_bound</span><span class="p">[</span><span class="n">i</span><span class="p">]],</span><span class="n">indy1</span><span class="p">[</span><span class="n">id_bound</span><span class="p">[</span><span class="n">i</span><span class="p">]]],</span><span class="n">tg_grad_y_c</span><span class="p">[</span><span class="n">indx1</span><span class="p">[</span><span class="n">id_bound</span><span class="p">[</span><span class="n">i</span><span class="p">]],</span><span class="n">indy1</span><span class="p">[</span><span class="n">id_bound</span><span class="p">[</span><span class="n">i</span><span class="p">]]]</span> <span class="o">=</span> <span class="n">array</span><span class="p">([</span><span class="n">tg_grad_x_c</span><span class="p">[</span><span class="n">indx1</span><span class="p">[</span><span class="n">id_bound</span><span class="p">[</span><span class="n">i</span><span class="p">]],</span><span class="n">indy1</span><span class="p">[</span><span class="n">id_bound</span><span class="p">[</span><span class="n">i</span><span class="p">]]],</span><span class="n">tg_grad_y_c</span><span class="p">[</span><span class="n">indx1</span><span class="p">[</span><span class="n">id_bound</span><span class="p">[</span><span class="n">i</span><span class="p">]],</span><span class="n">indy1</span><span class="p">[</span><span class="n">id_bound</span><span class="p">[</span><span class="n">i</span><span class="p">]]]])</span> <span class="o">-</span> <span class="p">(</span><span class="n">tg_grad_x_c</span><span class="p">[</span><span class="n">indx1</span><span class="p">[</span><span class="n">id_bound</span><span class="p">[</span><span class="n">i</span><span class="p">]],</span><span class="n">indy1</span><span class="p">[</span><span class="n">id_bound</span><span class="p">[</span><span class="n">i</span><span class="p">]]]</span><span class="o">*</span><span class="n">vect_x_c</span><span class="p">[</span><span class="n">indx1</span><span class="p">[</span><span class="n">id_bound</span><span class="p">[</span><span class="n">i</span><span class="p">]],</span><span class="n">indy1</span><span class="p">[</span><span class="n">id_bound</span><span class="p">[</span><span class="n">i</span><span class="p">]]]</span> <span class="o">+</span> <span class="n">tg_grad_y_c</span><span class="p">[</span><span class="n">indx1</span><span class="p">[</span><span class="n">id_bound</span><span class="p">[</span><span class="n">i</span><span class="p">]],</span><span class="n">indy1</span><span class="p">[</span><span class="n">id_bound</span><span class="p">[</span><span class="n">i</span><span class="p">]]]</span><span class="o">*</span><span class="n">vect_y_c</span><span class="p">[</span><span class="n">indx1</span><span class="p">[</span><span class="n">id_bound</span><span class="p">[</span><span class="n">i</span><span class="p">]],</span><span class="n">indy1</span><span class="p">[</span><span class="n">id_bound</span><span class="p">[</span><span class="n">i</span><span class="p">]]])</span><span class="o">*</span><span class="n">array</span><span class="p">([</span><span class="n">vect_x_c</span><span class="p">[</span><span class="n">indx1</span><span class="p">[</span><span class="n">id_bound</span><span class="p">[</span><span class="n">i</span><span class="p">]],</span><span class="n">indy1</span><span class="p">[</span><span class="n">id_bound</span><span class="p">[</span><span class="n">i</span><span class="p">]]],</span><span class="n">vect_y_c</span><span class="p">[</span><span class="n">indx1</span><span class="p">[</span><span class="n">id_bound</span><span class="p">[</span><span class="n">i</span><span class="p">]],</span><span class="n">indy1</span><span class="p">[</span><span class="n">id_bound</span><span class="p">[</span><span class="n">i</span><span class="p">]]]])</span><span class="o">/</span><span class="n">d_c</span><span class="p">[</span><span class="n">indx1</span><span class="p">[</span><span class="n">id_bound</span><span class="p">[</span><span class="n">i</span><span class="p">]],</span><span class="n">indy1</span><span class="p">[</span><span class="n">id_bound</span><span class="p">[</span><span class="n">i</span><span class="p">]]]</span><span class="o">**</span><span class="mi">2</span>

    <span class="k">return</span> <span class="n">tg_grad_x_l</span><span class="p">,</span><span class="n">tg_grad_x_c</span><span class="p">,</span><span class="n">tg_grad_y_l</span><span class="p">,</span><span class="n">tg_grad_y_c</span>


<span class="k">def</span> <span class="nf">cost_funct_lasso</span><span class="p">(</span><span class="n">vect_x_l</span><span class="p">,</span><span class="n">vect_x_c</span><span class="p">,</span><span class="n">vect_y_l</span><span class="p">,</span><span class="n">vect_y_c</span><span class="p">):</span>
    <span class="kn">from</span> <span class="nn">numpy.linalg</span> <span class="k">import</span> <span class="n">norm</span>
    <span class="k">return</span> <span class="n">norm</span><span class="p">(</span><span class="n">lasso_cumul</span><span class="p">(</span><span class="n">vect_x_l</span><span class="p">,</span><span class="n">lines</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">-</span><span class="n">lasso_cumul</span><span class="p">(</span><span class="n">vect_x_c</span><span class="p">,</span><span class="n">lines</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span><span class="o">+</span><span class="n">norm</span><span class="p">(</span><span class="n">lasso_cumul</span><span class="p">(</span><span class="n">vect_y_l</span><span class="p">,</span><span class="n">lines</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">-</span><span class="n">lasso_cumul</span><span class="p">(</span><span class="n">vect_y_c</span><span class="p">,</span><span class="n">lines</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>

<span class="k">def</span> <span class="nf">retraction_lasso</span><span class="p">(</span><span class="n">vect_x_l</span><span class="p">,</span><span class="n">vect_x_c</span><span class="p">,</span><span class="n">vect_y_l</span><span class="p">,</span><span class="n">vect_y_c</span><span class="p">,</span><span class="n">r_min</span><span class="p">,</span><span class="n">angle_min</span><span class="p">,</span><span class="n">nb_samp</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span><span class="n">angle_cons</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="kn">from</span> <span class="nn">numpy</span> <span class="k">import</span> <span class="n">sqrt</span>
    <span class="kn">from</span> <span class="nn">numpy.linalg</span> <span class="k">import</span> <span class="n">norm</span>
    <span class="c1"># Fixing the origin</span>
    <span class="sd">&quot;&quot;&quot;vect_x_l[0,0] = 0</span>
<span class="sd">    vect_x_c[0,0] = 0</span>
<span class="sd">    vect_y_l[0,0] = 0</span>
<span class="sd">    vect_y_c[0,0] = 0&quot;&quot;&quot;</span>

    <span class="n">d_l</span> <span class="o">=</span> <span class="n">sqrt</span><span class="p">(</span><span class="n">vect_x_l</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="n">vect_y_l</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">indx1</span><span class="p">,</span><span class="n">indy1</span> <span class="o">=</span> <span class="n">where</span><span class="p">(</span><span class="n">d_l</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">ind2</span> <span class="o">=</span> <span class="n">where</span><span class="p">(</span><span class="n">d_l</span><span class="p">[</span><span class="n">indx1</span><span class="p">,</span><span class="n">indy1</span><span class="p">]</span><span class="o">&lt;</span><span class="n">r_min</span><span class="p">)</span>
    <span class="n">vect_x_l</span><span class="p">[</span><span class="n">indx1</span><span class="p">[</span><span class="n">ind2</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span><span class="n">indy1</span><span class="p">[</span><span class="n">ind2</span><span class="p">[</span><span class="mi">0</span><span class="p">]]]</span> <span class="o">*=</span> <span class="n">r_min</span><span class="o">/</span><span class="p">(</span><span class="n">d_l</span><span class="p">[</span><span class="n">indx1</span><span class="p">[</span><span class="n">ind2</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span><span class="n">indy1</span><span class="p">[</span><span class="n">ind2</span><span class="p">[</span><span class="mi">0</span><span class="p">]]])</span>
    <span class="n">vect_y_l</span><span class="p">[</span><span class="n">indx1</span><span class="p">[</span><span class="n">ind2</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span><span class="n">indy1</span><span class="p">[</span><span class="n">ind2</span><span class="p">[</span><span class="mi">0</span><span class="p">]]]</span> <span class="o">*=</span> <span class="n">r_min</span><span class="o">/</span><span class="p">(</span><span class="n">d_l</span><span class="p">[</span><span class="n">indx1</span><span class="p">[</span><span class="n">ind2</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span><span class="n">indy1</span><span class="p">[</span><span class="n">ind2</span><span class="p">[</span><span class="mi">0</span><span class="p">]]])</span>

    <span class="n">d_c</span> <span class="o">=</span> <span class="n">sqrt</span><span class="p">(</span><span class="n">vect_x_c</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="n">vect_y_c</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">indx1</span><span class="p">,</span><span class="n">indy1</span> <span class="o">=</span> <span class="n">where</span><span class="p">(</span><span class="n">d_c</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">ind2</span> <span class="o">=</span> <span class="n">where</span><span class="p">(</span><span class="n">d_c</span><span class="p">[</span><span class="n">indx1</span><span class="p">,</span><span class="n">indy1</span><span class="p">]</span><span class="o">&lt;</span><span class="n">r_min</span><span class="p">)</span>
    <span class="n">vect_x_c</span><span class="p">[</span><span class="n">indx1</span><span class="p">[</span><span class="n">ind2</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span><span class="n">indy1</span><span class="p">[</span><span class="n">ind2</span><span class="p">[</span><span class="mi">0</span><span class="p">]]]</span> <span class="o">*=</span> <span class="n">r_min</span><span class="o">/</span><span class="p">(</span><span class="n">d_c</span><span class="p">[</span><span class="n">indx1</span><span class="p">[</span><span class="n">ind2</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span><span class="n">indy1</span><span class="p">[</span><span class="n">ind2</span><span class="p">[</span><span class="mi">0</span><span class="p">]]])</span>
    <span class="n">vect_y_c</span><span class="p">[</span><span class="n">indx1</span><span class="p">[</span><span class="n">ind2</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span><span class="n">indy1</span><span class="p">[</span><span class="n">ind2</span><span class="p">[</span><span class="mi">0</span><span class="p">]]]</span> <span class="o">*=</span> <span class="n">r_min</span><span class="o">/</span><span class="p">(</span><span class="n">d_c</span><span class="p">[</span><span class="n">indx1</span><span class="p">[</span><span class="n">ind2</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span><span class="n">indy1</span><span class="p">[</span><span class="n">ind2</span><span class="p">[</span><span class="mi">0</span><span class="p">]]])</span>

    <span class="k">if</span> <span class="n">angle_cons</span><span class="p">:</span>
        <span class="n">vect_x_l</span><span class="p">,</span><span class="n">vect_y_l</span><span class="p">,</span><span class="n">vect_x_c</span><span class="p">,</span><span class="n">vect_y_c</span> <span class="o">=</span> <span class="n">angle_proj_array</span><span class="p">(</span><span class="n">vect_x_l</span><span class="p">,</span><span class="n">vect_y_l</span><span class="p">,</span><span class="n">vect_x_c</span><span class="p">,</span><span class="n">vect_y_c</span><span class="p">,</span><span class="n">angle_min</span><span class="p">,</span><span class="n">nb_samp</span><span class="o">=</span><span class="n">nb_samp</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">vect_x_l</span><span class="p">,</span><span class="n">vect_x_c</span><span class="p">,</span><span class="n">vect_y_l</span><span class="p">,</span><span class="n">vect_y_c</span>

<span class="k">def</span> <span class="nf">armijo_lasso</span><span class="p">(</span><span class="n">vect_x_l</span><span class="p">,</span><span class="n">vect_x_c</span><span class="p">,</span><span class="n">vect_y_l</span><span class="p">,</span><span class="n">vect_y_c</span><span class="p">,</span><span class="n">tg_grad_x_l</span><span class="p">,</span><span class="n">tg_grad_x_c</span><span class="p">,</span><span class="n">tg_grad_y_l</span><span class="p">,</span><span class="n">tg_grad_y_c</span><span class="p">,</span><span class="n">r_min</span><span class="p">,</span><span class="n">angle_min</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span><span class="n">beta</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span><span class="n">sigma</span><span class="o">=</span><span class="mf">1.e-10</span><span class="p">,</span><span class="n">nb_iter</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span><span class="n">eps</span> <span class="o">=</span> <span class="mf">1.e-13</span><span class="p">):</span>
    <span class="kn">from</span> <span class="nn">numpy</span> <span class="k">import</span> <span class="n">sqrt</span>
    <span class="kn">from</span> <span class="nn">numpy.linalg</span> <span class="k">import</span> <span class="n">norm</span>
    <span class="n">m</span><span class="o">=</span><span class="mi">0</span>
    <span class="n">cur_cost</span> <span class="o">=</span> <span class="n">cost_funct_lasso</span><span class="p">(</span><span class="n">vect_x_l</span><span class="p">,</span><span class="n">vect_x_c</span><span class="p">,</span><span class="n">vect_y_l</span><span class="p">,</span><span class="n">vect_y_c</span><span class="p">)</span>
    <span class="n">grad_norm</span> <span class="o">=</span> <span class="n">norm</span><span class="p">(</span><span class="n">tg_grad_x_l</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="n">norm</span><span class="p">(</span><span class="n">tg_grad_y_l</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="n">norm</span><span class="p">(</span><span class="n">tg_grad_x_c</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="n">norm</span><span class="p">(</span><span class="n">tg_grad_y_c</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span>
    <span class="n">descent</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="n">mu</span> <span class="o">=</span> <span class="n">alpha</span><span class="o">*</span><span class="n">beta</span><span class="o">**</span><span class="n">m</span>
    <span class="n">vect_x_l_0</span><span class="p">,</span><span class="n">vect_x_c_0</span><span class="p">,</span><span class="n">vect_y_l_0</span><span class="p">,</span><span class="n">vect_y_c_0</span> <span class="o">=</span> <span class="n">retraction_lasso</span><span class="p">(</span><span class="n">vect_x_l</span><span class="o">-</span><span class="n">mu</span><span class="o">*</span><span class="n">tg_grad_x_l</span><span class="p">,</span><span class="n">vect_x_c</span><span class="o">-</span><span class="n">mu</span><span class="o">*</span><span class="n">tg_grad_x_c</span><span class="p">,</span><span class="n">vect_y_l</span><span class="o">-</span><span class="n">mu</span><span class="o">*</span><span class="n">tg_grad_y_l</span><span class="p">,</span><span class="n">vect_y_c</span><span class="o">-</span><span class="n">mu</span><span class="o">*</span><span class="n">tg_grad_y_c</span><span class="p">,</span><span class="n">r_min</span><span class="p">,</span><span class="n">angle_min</span><span class="p">)</span>
    <span class="n">descent</span> <span class="o">=</span> <span class="n">cur_cost</span> <span class="o">-</span> <span class="n">cost_funct_lasso</span><span class="p">(</span><span class="n">vect_x_l_0</span><span class="p">,</span><span class="n">vect_x_c_0</span><span class="p">,</span><span class="n">vect_y_l_0</span><span class="p">,</span><span class="n">vect_y_c_0</span><span class="p">)</span>
    <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">while</span> <span class="n">descent</span><span class="o">&lt;=</span><span class="n">grad_norm</span><span class="o">*</span><span class="n">sigma</span><span class="o">*</span><span class="n">mu</span> <span class="ow">and</span> <span class="n">grad_norm</span><span class="o">&gt;</span><span class="n">eps</span> <span class="ow">and</span> <span class="n">count</span><span class="o">&lt;</span><span class="n">nb_iter</span><span class="p">:</span>
        <span class="n">m</span><span class="o">+=</span><span class="mi">1</span>
        <span class="n">mu</span> <span class="o">=</span> <span class="n">alpha</span><span class="o">*</span><span class="n">beta</span><span class="o">**</span><span class="n">m</span>
        <span class="n">vect_x_l_0</span><span class="p">,</span><span class="n">vect_x_c_0</span><span class="p">,</span><span class="n">vect_y_l_0</span><span class="p">,</span><span class="n">vect_y_c_0</span> <span class="o">=</span> <span class="n">retraction_lasso</span><span class="p">(</span><span class="n">vect_x_l</span><span class="o">-</span><span class="n">mu</span><span class="o">*</span><span class="n">tg_grad_x_l</span><span class="p">,</span><span class="n">vect_x_c</span><span class="o">-</span><span class="n">mu</span><span class="o">*</span><span class="n">tg_grad_x_c</span><span class="p">,</span><span class="n">vect_y_l</span><span class="o">-</span><span class="n">mu</span><span class="o">*</span><span class="n">tg_grad_y_l</span><span class="p">,</span><span class="n">vect_y_c</span><span class="o">-</span><span class="n">mu</span><span class="o">*</span><span class="n">tg_grad_y_c</span><span class="p">,</span><span class="n">r_min</span><span class="p">,</span><span class="n">angle_min</span><span class="p">)</span>
        <span class="n">descent</span> <span class="o">=</span> <span class="n">cur_cost</span> <span class="o">-</span> <span class="n">cost_funct_lasso</span><span class="p">(</span><span class="n">vect_x_l_0</span><span class="p">,</span><span class="n">vect_x_c_0</span><span class="p">,</span><span class="n">vect_y_l_0</span><span class="p">,</span><span class="n">vect_y_c_0</span><span class="p">)</span>
        <span class="n">count</span><span class="o">+=</span><span class="mi">1</span>
    <span class="nb">print</span> <span class="s2">&quot;Armijo descent: &quot;</span><span class="p">,</span><span class="n">descent</span><span class="p">,</span><span class="s2">&quot; Step: &quot;</span><span class="p">,</span><span class="n">mu</span><span class="p">,</span><span class="s2">&quot; upper bound: &quot;</span><span class="p">,</span><span class="n">grad_norm</span><span class="o">*</span><span class="n">sigma</span><span class="o">*</span><span class="n">mu</span>
    <span class="k">return</span> <span class="n">vect_x_l_0</span><span class="p">,</span><span class="n">vect_x_c_0</span><span class="p">,</span><span class="n">vect_y_l_0</span><span class="p">,</span><span class="n">vect_y_c_0</span>



<span class="k">def</span> <span class="nf">proj_ellip</span><span class="p">(</span><span class="n">cent</span><span class="p">,</span><span class="n">weights</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">nb_iter</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span><span class="n">tol</span><span class="o">=</span><span class="mf">0.01</span><span class="p">):</span> <span class="c1"># Calculates the nearest point on the ellipsoid defined by \|weights*(X-cent)\|_2^2 = 1 to the point y; this routine assumes that the entriers are matrices</span>
    <span class="kn">from</span> <span class="nn">numpy.linalg</span> <span class="k">import</span> <span class="n">norm</span>

    <span class="n">i</span><span class="p">,</span><span class="n">j</span> <span class="o">=</span> <span class="n">where</span><span class="p">(</span><span class="n">weights</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">z</span> <span class="o">=</span> <span class="n">cent</span><span class="o">*</span><span class="mi">0</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">cent</span><span class="o">*</span><span class="mi">0</span>
    <span class="n">t</span><span class="o">=</span><span class="mi">1</span>
    <span class="n">mu</span> <span class="o">=</span> <span class="n">weights</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span><span class="o">**</span><span class="mi">2</span>

    <span class="n">var</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">i</span><span class="o">=</span><span class="mi">0</span>
    <span class="k">while</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">nb_iter</span> <span class="ow">and</span> <span class="n">var</span><span class="o">&gt;</span><span class="n">tol</span><span class="p">:</span>
        <span class="n">v</span> <span class="o">=</span> <span class="n">z</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">-</span> <span class="n">mu</span><span class="o">*</span><span class="p">((</span><span class="n">weights</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">))</span><span class="o">*</span><span class="n">z</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="n">weights</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span><span class="o">*</span><span class="p">(</span><span class="n">cent</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span><span class="o">-</span><span class="n">y</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]))</span>
        <span class="n">x_old</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">])</span>
        <span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>
        <span class="k">if</span> <span class="n">norm</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">])</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">/=</span> <span class="n">norm</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">])</span>
        <span class="n">told</span> <span class="o">=</span> <span class="n">t</span>
        <span class="n">t</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">4</span><span class="o">*</span><span class="n">t</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span><span class="o">/</span><span class="mi">2</span>
        <span class="n">lambd</span> <span class="o">=</span> <span class="mi">1</span><span class="o">+</span><span class="p">(</span><span class="n">told</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="n">t</span>
        <span class="n">z</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">x_old</span> <span class="o">+</span> <span class="n">lambd</span><span class="o">*</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span><span class="o">-</span><span class="n">x_old</span><span class="p">)</span>
        <span class="n">var</span> <span class="o">=</span> <span class="mi">100</span><span class="o">*</span><span class="n">norm</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span><span class="o">-</span><span class="n">x_old</span><span class="p">)</span><span class="o">/</span><span class="n">norm</span><span class="p">(</span><span class="n">x_old</span><span class="p">)</span>
    <span class="nb">print</span> <span class="s2">&quot;Relative change of iterates: &quot;</span><span class="p">,</span><span class="n">var</span>

    <span class="n">proj</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
    <span class="n">proj</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">cent</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span><span class="o">+</span><span class="n">z</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span><span class="o">/</span><span class="n">weights</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">proj</span>



<span class="k">def</span> <span class="nf">opt_assignment</span><span class="p">(</span><span class="n">f</span><span class="p">,</span><span class="n">g</span><span class="p">):</span>
    <span class="kn">from</span> <span class="nn">numpy</span> <span class="k">import</span> <span class="n">zeros</span>
    <span class="kn">from</span> <span class="nn">numpy.linalg</span> <span class="k">import</span> <span class="n">norm</span>
    <span class="kn">from</span> <span class="nn">scipy.optimize</span> <span class="k">import</span> <span class="n">linear_sum_assignment</span>

    <span class="n">shap</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">shape</span>

    <span class="n">dist</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
    <span class="n">sig</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">],))</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
            <span class="n">dist</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">norm</span><span class="p">(</span><span class="n">f</span><span class="p">[:,</span><span class="n">i</span><span class="p">]</span><span class="o">-</span><span class="n">g</span><span class="p">[:,</span><span class="n">j</span><span class="p">])</span>

    <span class="n">row_ind</span><span class="p">,</span><span class="n">col_ind</span> <span class="o">=</span> <span class="n">linear_sum_assignment</span><span class="p">(</span><span class="n">dist</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
        <span class="n">sig</span><span class="p">[</span><span class="n">row_ind</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">=</span> <span class="n">col_ind</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

    <span class="n">dist</span> <span class="o">=</span> <span class="n">norm</span><span class="p">(</span><span class="n">f</span><span class="o">-</span><span class="n">g</span><span class="p">[:,</span><span class="n">sig</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)])</span>


    <span class="k">return</span> <span class="n">dist</span><span class="p">,</span><span class="n">g</span><span class="p">[:,</span><span class="n">sig</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)],</span><span class="n">sig</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">discrepancies_analysis</span><span class="p">(</span><span class="n">sig</span><span class="p">):</span>
    <span class="n">max_disc</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">nb_perm</span> <span class="o">=</span> <span class="n">sig</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_perm</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">nb_perm</span><span class="p">):</span>
            <span class="n">supp</span> <span class="o">=</span> <span class="n">where</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">sig</span><span class="p">[</span><span class="n">i</span><span class="p">,:]</span><span class="o">-</span><span class="n">sig</span><span class="p">[</span><span class="n">j</span><span class="p">,:])</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">max_discij</span> <span class="o">=</span> <span class="n">size</span><span class="p">(</span><span class="n">supp</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">max_discij</span><span class="o">&gt;</span><span class="n">max_disc</span><span class="p">:</span>
                <span class="n">max_disc</span> <span class="o">=</span> <span class="n">max_discij</span>
    <span class="n">disc_id</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="nb">id</span> <span class="o">=</span> <span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">sig</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_perm</span><span class="p">):</span>
        <span class="n">supp</span> <span class="o">=</span> <span class="n">where</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">sig</span><span class="p">[</span><span class="n">i</span><span class="p">,:]</span><span class="o">-</span><span class="nb">id</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">disc_idij</span> <span class="o">=</span> <span class="n">size</span><span class="p">(</span><span class="n">supp</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">disc_idij</span> <span class="o">&gt;</span> <span class="n">disc_id</span><span class="p">:</span>
            <span class="n">disc_id</span> <span class="o">=</span> <span class="n">disc_idij</span>

    <span class="k">return</span> <span class="n">max_disc</span><span class="p">,</span><span class="n">disc_id</span>

<span class="k">def</span> <span class="nf">discrepancies_global_analysis</span><span class="p">(</span><span class="n">sig</span><span class="p">):</span>
    <span class="kn">from</span> <span class="nn">numpy</span> <span class="k">import</span> <span class="n">ones</span><span class="p">,</span><span class="n">array</span>
    <span class="kn">from</span> <span class="nn">numpy.linalg</span> <span class="k">import</span> <span class="n">norm</span>
    <span class="n">shap</span> <span class="o">=</span> <span class="n">sig</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">disc_support</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
    <span class="n">agreem_support</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
    <span class="n">ones_mat</span> <span class="o">=</span> <span class="n">ones</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">],))</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
        <span class="k">if</span> <span class="n">norm</span><span class="p">(</span><span class="n">sig</span><span class="p">[:,</span><span class="n">i</span><span class="p">]</span><span class="o">-</span><span class="n">ones_mat</span><span class="o">*</span><span class="n">sig</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">i</span><span class="p">])</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
            <span class="n">disc_support</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">agreem_support</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">array</span><span class="p">(</span><span class="n">disc_support</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">),</span><span class="n">array</span><span class="p">(</span><span class="n">agreem_support</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">bar_discrepancies_analysis</span><span class="p">(</span><span class="n">sig</span><span class="p">):</span>
    <span class="kn">from</span> <span class="nn">numpy</span> <span class="k">import</span> <span class="n">zeros</span>
    <span class="n">shap</span> <span class="o">=</span> <span class="n">sig</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">disc</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">],))</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
        <span class="n">maxi</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
            <span class="n">a</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">sig</span><span class="p">[</span><span class="mi">0</span><span class="p">,:,</span><span class="n">i</span><span class="p">]</span><span class="o">-</span><span class="n">sig</span><span class="p">[</span><span class="n">j</span><span class="p">,:,</span><span class="n">i</span><span class="p">])</span>
            <span class="n">ind</span> <span class="o">=</span> <span class="n">where</span><span class="p">(</span><span class="n">a</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">maxi</span> <span class="o">&lt;</span> <span class="n">ind</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                <span class="n">maxi</span> <span class="o">=</span> <span class="n">ind</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">disc</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">maxi</span>

    <span class="k">return</span> <span class="n">disc</span>
<span class="k">def</span> <span class="nf">sliced_transport_ptbar</span><span class="p">(</span><span class="n">F</span><span class="p">,</span><span class="n">weights</span><span class="p">,</span><span class="n">nb_iter</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span><span class="n">tol</span><span class="o">=</span><span class="mf">0.000000000000000001</span><span class="p">,</span><span class="n">alph</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span><span class="n">bar_init</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">samp</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span><span class="n">rand_en</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">basis</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">adapted_basis</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">pos_en</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">min_basis</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">support</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">assign_out</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">single_dir</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">nb_real</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span><span class="n">gap</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">shap</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">rad</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span><span class="n">smart_init_en</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>

    <span class="kn">from</span> <span class="nn">numpy</span> <span class="k">import</span> <span class="n">argsort</span><span class="p">,</span><span class="n">copy</span>
    <span class="n">indw</span> <span class="o">=</span> <span class="n">argsort</span><span class="p">(</span><span class="n">weights</span><span class="p">)</span>

    <span class="n">bar</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">F</span><span class="p">[:,:,</span><span class="n">indw</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]])</span>
    <span class="n">w</span> <span class="o">=</span> <span class="n">weights</span><span class="p">[</span><span class="n">indw</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="n">size</span><span class="p">(</span><span class="n">weights</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
        <span class="n">proj</span><span class="p">,</span><span class="n">dist</span><span class="p">,</span><span class="n">sig</span><span class="p">,</span><span class="n">i_opt</span> <span class="o">=</span> <span class="n">sliced_transport</span><span class="p">(</span><span class="n">F</span><span class="p">[:,:,</span><span class="n">indw</span><span class="p">[</span><span class="o">-</span><span class="n">i</span><span class="p">]],</span><span class="n">bar</span><span class="p">,</span><span class="n">nb_iter</span><span class="o">=</span><span class="n">nb_iter</span><span class="p">,</span><span class="n">tol</span><span class="o">=</span><span class="n">tol</span><span class="p">,</span><span class="n">alph</span> <span class="o">=</span> <span class="n">alph</span><span class="p">,</span><span class="n">basis</span><span class="o">=</span><span class="n">basis</span><span class="p">,</span><span class="n">rand</span><span class="o">=</span><span class="n">rand_en</span><span class="p">,</span><span class="n">nb_real</span><span class="o">=</span><span class="n">nb_real</span><span class="p">,</span><span class="n">gap</span><span class="o">=</span><span class="n">gap</span><span class="p">,</span><span class="n">shap</span><span class="o">=</span><span class="n">shap</span><span class="p">,</span><span class="n">rad</span><span class="o">=</span><span class="n">rad</span><span class="p">,</span><span class="n">iter_control</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">smart_init_en</span><span class="o">=</span><span class="n">smart_init_en</span><span class="p">)</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">w</span><span class="o">/</span><span class="p">(</span><span class="n">w</span><span class="o">+</span><span class="n">weights</span><span class="p">[</span><span class="n">indw</span><span class="p">[</span><span class="o">-</span><span class="n">i</span><span class="p">]])</span>
        <span class="nb">print</span> <span class="s2">&quot;current weight:&quot;</span><span class="p">,</span> <span class="n">t</span>
        <span class="n">bar</span> <span class="o">=</span> <span class="n">t</span><span class="o">*</span><span class="n">proj</span><span class="o">+</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">t</span><span class="p">)</span><span class="o">*</span><span class="n">F</span><span class="p">[:,:,</span><span class="n">indw</span><span class="p">[</span><span class="o">-</span><span class="n">i</span><span class="p">]]</span>
        <span class="n">w</span><span class="o">+=</span> <span class="n">weights</span><span class="p">[</span><span class="n">indw</span><span class="p">[</span><span class="o">-</span><span class="n">i</span><span class="p">]]</span>

    <span class="k">return</span> <span class="n">bar</span>

<span class="k">def</span> <span class="nf">sym_sliced_transport</span><span class="p">(</span><span class="n">f</span><span class="p">,</span><span class="n">g</span><span class="p">,</span><span class="n">nb_iter</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span><span class="n">tol</span><span class="o">=</span><span class="mf">0.001</span><span class="p">,</span><span class="n">alph</span> <span class="o">=</span> <span class="mf">0.1</span><span class="p">,</span><span class="n">basis</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">rand</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">approx_en</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="kn">from</span> <span class="nn">numpy</span> <span class="k">import</span> <span class="n">argsort</span><span class="p">,</span><span class="n">copy</span>
    <span class="n">fin</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
    <span class="n">gin</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">g</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">approx_en</span><span class="p">:</span>
        <span class="n">indf</span> <span class="o">=</span> <span class="n">where</span><span class="p">(</span><span class="n">f</span><span class="p">[</span><span class="mi">2</span><span class="p">,:]</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">indg</span> <span class="o">=</span> <span class="n">where</span><span class="p">(</span><span class="n">g</span><span class="p">[</span><span class="mi">2</span><span class="p">,:]</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">indf</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">indg</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
            <span class="n">fin</span> <span class="o">=</span> <span class="n">f</span><span class="p">[:,</span><span class="n">indf</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
            <span class="n">ind</span> <span class="o">=</span> <span class="n">argsort</span><span class="p">(</span><span class="n">g</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="n">indg</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span>
            <span class="n">gin</span> <span class="o">=</span> <span class="n">g</span><span class="p">[:,</span><span class="n">indg</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">ind</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="nb">len</span><span class="p">(</span><span class="n">indf</span><span class="p">[</span><span class="mi">0</span><span class="p">])]]]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">gin</span> <span class="o">=</span> <span class="n">g</span><span class="p">[:,</span><span class="n">indg</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
            <span class="n">ind</span> <span class="o">=</span> <span class="n">argsort</span><span class="p">(</span><span class="n">f</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="n">indf</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span>
            <span class="n">fin</span> <span class="o">=</span> <span class="n">f</span><span class="p">[:,</span><span class="n">indf</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">ind</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="nb">len</span><span class="p">(</span><span class="n">indg</span><span class="p">[</span><span class="mi">0</span><span class="p">])]]]</span>


    <span class="n">pf</span><span class="p">,</span><span class="n">dist1</span><span class="p">,</span><span class="n">sig1</span><span class="p">,</span><span class="n">i_opt</span> <span class="o">=</span> <span class="n">sliced_transport</span><span class="p">(</span><span class="n">fin</span><span class="p">,</span><span class="n">gin</span><span class="p">,</span><span class="n">nb_iter</span><span class="o">=</span><span class="n">nb_iter</span><span class="p">,</span><span class="n">tol</span><span class="o">=</span><span class="n">tol</span><span class="p">,</span><span class="n">alph</span> <span class="o">=</span> <span class="n">alph</span><span class="p">,</span><span class="n">basis</span><span class="o">=</span><span class="n">basis</span><span class="p">,</span><span class="n">rand</span><span class="o">=</span><span class="n">rand</span><span class="p">)</span>
    <span class="n">pg</span><span class="p">,</span><span class="n">dist2</span><span class="p">,</span><span class="n">sig2</span><span class="p">,</span><span class="n">i_opt</span> <span class="o">=</span> <span class="n">sliced_transport</span><span class="p">(</span><span class="n">gin</span><span class="p">,</span><span class="n">fin</span><span class="p">,</span><span class="n">nb_iter</span><span class="o">=</span><span class="n">nb_iter</span><span class="p">,</span><span class="n">tol</span><span class="o">=</span><span class="n">tol</span><span class="p">,</span><span class="n">alph</span> <span class="o">=</span> <span class="n">alph</span><span class="p">,</span><span class="n">basis</span><span class="o">=</span><span class="n">basis</span><span class="p">,</span><span class="n">rand</span><span class="o">=</span><span class="n">rand</span><span class="p">)</span>

    <span class="k">return</span> <span class="p">(</span><span class="n">dist1</span><span class="o">+</span><span class="n">dist2</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span><span class="n">sig1</span><span class="p">,</span><span class="n">sig2</span>



<span class="k">def</span> <span class="nf">sym_sliced_transport_supp</span><span class="p">(</span><span class="n">f</span><span class="p">,</span><span class="n">g</span><span class="p">,</span><span class="n">nb_iter</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span><span class="n">tol</span><span class="o">=</span><span class="mf">0.001</span><span class="p">,</span><span class="n">alph</span> <span class="o">=</span> <span class="mf">0.1</span><span class="p">,</span><span class="n">basis</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">rand</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span> <span class="c1"># Compute the approximated sliced distance between the non-overlapping parts (with respect to the 2 first dimensions) of the input 3D points clouds</span>

    <span class="kn">from</span> <span class="nn">numpy</span> <span class="k">import</span> <span class="n">copy</span>

    <span class="c1"># computing the intersection of the supports</span>
    <span class="n">supp1</span> <span class="o">=</span> <span class="n">where</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">f</span><span class="p">[</span><span class="mi">2</span><span class="p">,:])</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">supp12</span> <span class="o">=</span> <span class="n">where</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">g</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="n">supp1</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">)</span>

    <span class="n">fc</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
    <span class="n">gc</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">g</span><span class="p">)</span>

    <span class="n">fc</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="n">supp1</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">supp12</span><span class="p">[</span><span class="mi">0</span><span class="p">]]]</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">gc</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="n">supp1</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">supp12</span><span class="p">[</span><span class="mi">0</span><span class="p">]]]</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">if</span> <span class="nb">sum</span><span class="p">(</span><span class="n">fc</span><span class="p">[</span><span class="mi">2</span><span class="p">,:]</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span> <span class="ow">or</span> <span class="nb">sum</span><span class="p">(</span><span class="n">gc</span><span class="p">[</span><span class="mi">2</span><span class="p">,:]</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="mi">0</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">sym_sliced_transport</span><span class="p">(</span><span class="n">fc</span><span class="p">,</span><span class="n">gc</span><span class="p">,</span><span class="n">nb_iter</span><span class="o">=</span><span class="n">nb_iter</span><span class="p">,</span><span class="n">tol</span><span class="o">=</span><span class="n">tol</span><span class="p">,</span><span class="n">alph</span> <span class="o">=</span> <span class="n">alph</span><span class="p">,</span><span class="n">basis</span><span class="o">=</span><span class="n">basis</span><span class="p">,</span><span class="n">rand</span><span class="o">=</span><span class="n">rand</span><span class="p">,</span><span class="n">approx_en</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">stack_im_coherence</span><span class="p">(</span><span class="n">cube</span><span class="p">):</span>
    <span class="kn">from</span> <span class="nn">numpy</span> <span class="k">import</span> <span class="n">zeros</span>
    <span class="kn">from</span> <span class="nn">numpy.linalg</span> <span class="k">import</span> <span class="n">norm</span>

    <span class="n">shap</span> <span class="o">=</span> <span class="n">cube</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">corr_coeff</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
            <span class="n">corr_coeff</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">cube</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">]</span><span class="o">*</span><span class="n">cube</span><span class="p">[:,:,</span><span class="n">j</span><span class="p">]))</span><span class="o">/</span><span class="p">(</span><span class="n">norm</span><span class="p">(</span><span class="n">cube</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">])</span><span class="o">*</span><span class="n">norm</span><span class="p">(</span><span class="n">cube</span><span class="p">[:,:,</span><span class="n">j</span><span class="p">]))</span>
            <span class="n">corr_coeff</span><span class="p">[</span><span class="n">j</span><span class="p">,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">corr_coeff</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">corr_coeff</span>


<span class="k">def</span> <span class="nf">local_sliced_dist_mat</span><span class="p">(</span><span class="n">stack</span><span class="p">,</span><span class="n">pos_field</span><span class="p">,</span><span class="n">nb_iter</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span><span class="n">tol</span><span class="o">=</span><span class="mf">0.001</span><span class="p">,</span><span class="n">alph</span> <span class="o">=</span> <span class="mf">0.1</span><span class="p">,</span><span class="n">basis</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">rand</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">nb_neigh</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span><span class="n">max_val</span> <span class="o">=</span><span class="mi">2</span><span class="o">**</span><span class="mi">63</span><span class="p">):</span>
    <span class="kn">from</span> <span class="nn">numpy</span> <span class="k">import</span> <span class="n">zeros</span><span class="p">,</span><span class="n">transpose</span><span class="p">,</span><span class="n">ones</span>
    <span class="kn">from</span> <span class="nn">pyflann</span> <span class="k">import</span> <span class="n">FLANN</span>
    <span class="n">knn</span> <span class="o">=</span> <span class="n">FLANN</span><span class="p">()</span>
    <span class="n">params</span> <span class="o">=</span> <span class="n">knn</span><span class="o">.</span><span class="n">build_index</span><span class="p">(</span><span class="n">array</span><span class="p">(</span><span class="n">pos_field</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">float64</span><span class="p">))</span>


    <span class="n">nb_points</span> <span class="o">=</span> <span class="n">stack</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">dist_mat</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">nb_points</span><span class="p">,</span><span class="n">nb_points</span><span class="p">))</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_points</span><span class="p">):</span>
        <span class="n">result</span><span class="p">,</span> <span class="n">dists</span> <span class="o">=</span> <span class="n">knn</span><span class="o">.</span><span class="n">nn_index</span><span class="p">(</span><span class="n">pos_field</span><span class="p">,</span> <span class="n">nb_neigh</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
        <span class="nb">print</span> <span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="s2">&quot;th PSF&quot;</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">nb_neigh</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">dist_mat</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">j</span><span class="p">]]</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
                <span class="n">dist_mat</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">j</span><span class="p">]],</span><span class="n">sig_1</span><span class="p">,</span><span class="n">sig_2</span> <span class="o">=</span> <span class="n">sym_sliced_transport</span><span class="p">(</span><span class="n">stack</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">],</span><span class="n">stack</span><span class="p">[:,:,</span><span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">j</span><span class="p">]],</span><span class="n">nb_iter</span><span class="o">=</span><span class="n">nb_iter</span><span class="p">,</span><span class="n">tol</span><span class="o">=</span><span class="n">tol</span><span class="p">,</span><span class="n">alph</span> <span class="o">=</span> <span class="n">alph</span><span class="p">,</span><span class="n">basis</span><span class="o">=</span><span class="n">basis</span><span class="p">,</span><span class="n">rand</span><span class="o">=</span><span class="n">rand</span><span class="p">)</span>
                <span class="n">dist_mat</span><span class="p">[</span><span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">j</span><span class="p">],</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">dist_mat</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">j</span><span class="p">]]</span>


    <span class="n">i</span><span class="p">,</span><span class="n">j</span> <span class="o">=</span> <span class="n">where</span><span class="p">(</span><span class="n">dist_mat</span><span class="o">==</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">dist_mat</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">max_val</span>

    <span class="n">i</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_points</span><span class="p">)</span>
    <span class="n">dist_mat</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="n">i</span><span class="p">,</span><span class="n">j</span> <span class="o">=</span> <span class="n">where</span><span class="p">(</span><span class="n">dist_mat</span><span class="o">&lt;</span><span class="n">max_val</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">dist_mat</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
        <span class="n">dist_mat</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span><span class="o">/=</span><span class="n">dist_mat</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">dist_mat</span>

<span class="k">def</span> <span class="nf">local_sliced_dist_mat_target</span><span class="p">(</span><span class="n">stack</span><span class="p">,</span><span class="n">pos_field</span><span class="p">,</span><span class="n">target_pos</span><span class="p">,</span><span class="n">nb_neigh</span><span class="p">,</span><span class="n">nb_iter</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span><span class="n">tol</span><span class="o">=</span><span class="mf">0.001</span><span class="p">,</span><span class="n">alph</span> <span class="o">=</span> <span class="mf">0.1</span><span class="p">,</span><span class="n">basis</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">rand</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">max_val</span> <span class="o">=</span><span class="mi">2</span><span class="o">**</span><span class="mi">63</span><span class="p">):</span>

    <span class="kn">from</span> <span class="nn">numpy</span> <span class="k">import</span> <span class="n">zeros</span><span class="p">,</span><span class="n">transpose</span><span class="p">,</span><span class="n">ones</span>
    <span class="kn">from</span> <span class="nn">pyflann</span> <span class="k">import</span> <span class="n">FLANN</span>
    <span class="n">knn</span> <span class="o">=</span> <span class="n">FLANN</span><span class="p">()</span>
    <span class="n">params</span> <span class="o">=</span> <span class="n">knn</span><span class="o">.</span><span class="n">build_index</span><span class="p">(</span><span class="n">array</span><span class="p">(</span><span class="n">pos_field</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">float64</span><span class="p">))</span>
    <span class="n">result</span><span class="p">,</span> <span class="n">dists</span> <span class="o">=</span> <span class="n">knn</span><span class="o">.</span><span class="n">nn_index</span><span class="p">(</span><span class="n">target_pos</span><span class="p">,</span> <span class="n">nb_neigh</span><span class="p">)</span>

    <span class="n">dist_mat</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">nb_neigh</span><span class="p">,</span><span class="n">nb_neigh</span><span class="p">))</span>
    <span class="n">dict_assignments</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_neigh</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
        <span class="nb">print</span> <span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="s2">&quot;th PSF/&quot;</span><span class="p">,</span><span class="n">nb_neigh</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">nb_neigh</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">dist_mat</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
                <span class="n">dist_mat</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">],</span><span class="n">sig_1</span><span class="p">,</span><span class="n">sig_2</span> <span class="o">=</span> <span class="n">sym_sliced_transport</span><span class="p">(</span><span class="n">stack</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">],</span><span class="n">stack</span><span class="p">[:,:,</span><span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">j</span><span class="p">]],</span><span class="n">nb_iter</span><span class="o">=</span><span class="n">nb_iter</span><span class="p">,</span><span class="n">tol</span><span class="o">=</span><span class="n">tol</span><span class="p">,</span><span class="n">alph</span> <span class="o">=</span> <span class="n">alph</span><span class="p">,</span><span class="n">basis</span><span class="o">=</span><span class="n">basis</span><span class="p">,</span><span class="n">rand</span><span class="o">=</span><span class="n">rand</span><span class="p">)</span>
                <span class="n">dict_assignments</span><span class="p">[</span><span class="n">j</span><span class="o">+</span><span class="n">i</span><span class="o">*</span><span class="n">nb_neigh</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">sig_1</span><span class="p">,</span><span class="n">sig_2</span><span class="p">]</span>
                <span class="n">dist_mat</span><span class="p">[</span><span class="n">j</span><span class="p">,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">dist_mat</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">dist_mat</span><span class="p">,</span><span class="n">result</span><span class="p">,</span><span class="n">dict_assignments</span>







<span class="k">def</span> <span class="nf">local_sliced_dist_mat_supp</span><span class="p">(</span><span class="n">stack</span><span class="p">,</span><span class="n">pos_field</span><span class="p">,</span><span class="n">knn</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">nb_iter</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span><span class="n">tol</span><span class="o">=</span><span class="mf">0.001</span><span class="p">,</span><span class="n">alph</span> <span class="o">=</span> <span class="mf">0.1</span><span class="p">,</span><span class="n">basis</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">rand</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">nb_neigh</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span><span class="n">max_val</span> <span class="o">=</span><span class="mi">2</span><span class="o">**</span><span class="mi">63</span><span class="p">):</span>
    <span class="kn">from</span> <span class="nn">numpy</span> <span class="k">import</span> <span class="n">zeros</span><span class="p">,</span><span class="n">transpose</span><span class="p">,</span><span class="n">ones</span>
    <span class="kn">from</span> <span class="nn">pyflann</span> <span class="k">import</span> <span class="n">FLANN</span>
    <span class="k">if</span> <span class="n">knn</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">knn</span> <span class="o">=</span> <span class="n">FLANN</span><span class="p">()</span>
        <span class="n">params</span> <span class="o">=</span> <span class="n">knn</span><span class="o">.</span><span class="n">build_index</span><span class="p">(</span><span class="n">array</span><span class="p">(</span><span class="n">pos_field</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">float64</span><span class="p">))</span>




    <span class="n">nb_points</span> <span class="o">=</span> <span class="n">stack</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">dist_mat</span> <span class="o">=</span> <span class="n">ones</span><span class="p">((</span><span class="n">nb_points</span><span class="p">,</span><span class="n">nb_points</span><span class="p">))</span><span class="o">*</span><span class="n">max_val</span>
    <span class="n">i</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_points</span><span class="p">)</span>
    <span class="n">dist_mat</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">result</span><span class="p">,</span> <span class="n">dists</span> <span class="o">=</span> <span class="n">knn</span><span class="o">.</span><span class="n">nn_index</span><span class="p">(</span><span class="n">pos_field</span><span class="p">,</span> <span class="n">nb_neigh</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_points</span><span class="p">):</span>

        <span class="nb">print</span> <span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="s2">&quot;th PSF/&quot;</span><span class="p">,</span><span class="n">nb_points</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">nb_neigh</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">dist_mat</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">result</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]]</span><span class="o">==</span> <span class="n">max_val</span><span class="p">:</span>
                <span class="n">dist_mat</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">result</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]]</span> <span class="o">=</span> <span class="n">sym_sliced_transport_supp</span><span class="p">(</span><span class="n">stack</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">],</span><span class="n">stack</span><span class="p">[:,:,</span><span class="n">result</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]],</span><span class="n">nb_iter</span><span class="o">=</span><span class="n">nb_iter</span><span class="p">,</span><span class="n">tol</span><span class="o">=</span><span class="n">tol</span><span class="p">,</span><span class="n">alph</span> <span class="o">=</span> <span class="n">alph</span><span class="p">,</span><span class="n">basis</span><span class="o">=</span><span class="n">basis</span><span class="p">,</span><span class="n">rand</span><span class="o">=</span><span class="n">rand</span><span class="p">)</span>
                <span class="n">dist_mat</span><span class="p">[</span><span class="n">result</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">],</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">dist_mat</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">result</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]]</span>

    <span class="k">return</span> <span class="n">dist_mat</span>



<span class="k">def</span> <span class="nf">local_euc_dist_mat</span><span class="p">(</span><span class="n">stack</span><span class="p">,</span><span class="n">pos_field</span><span class="p">,</span><span class="n">tol</span><span class="o">=</span><span class="mf">0.001</span><span class="p">,</span><span class="n">nb_neigh</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span><span class="n">max_val</span> <span class="o">=</span><span class="mi">2</span><span class="o">**</span><span class="mi">63</span><span class="p">):</span>
    <span class="kn">from</span> <span class="nn">numpy</span> <span class="k">import</span> <span class="n">zeros</span><span class="p">,</span><span class="n">transpose</span><span class="p">,</span><span class="n">ones</span><span class="p">,</span><span class="n">sqrt</span>
    <span class="kn">from</span> <span class="nn">pyflann</span> <span class="k">import</span> <span class="n">FLANN</span>
    <span class="n">knn</span> <span class="o">=</span> <span class="n">FLANN</span><span class="p">()</span>
    <span class="n">params</span> <span class="o">=</span> <span class="n">knn</span><span class="o">.</span><span class="n">build_index</span><span class="p">(</span><span class="n">array</span><span class="p">(</span><span class="n">pos_field</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">float64</span><span class="p">))</span>


    <span class="n">nb_points</span> <span class="o">=</span> <span class="n">stack</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">dist_mat</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">nb_points</span><span class="p">,</span><span class="n">nb_points</span><span class="p">))</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_points</span><span class="p">):</span>
        <span class="n">result</span><span class="p">,</span> <span class="n">dists</span> <span class="o">=</span> <span class="n">knn</span><span class="o">.</span><span class="n">nn_index</span><span class="p">(</span><span class="n">pos_field</span><span class="p">,</span> <span class="n">nb_neigh</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
        <span class="nb">print</span> <span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="s2">&quot;th PSF&quot;</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">nb_neigh</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">dist_mat</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">j</span><span class="p">]]</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
                <span class="n">dist_mat</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">j</span><span class="p">]]</span> <span class="o">=</span> <span class="n">sqrt</span><span class="p">(</span><span class="nb">sum</span><span class="p">((</span><span class="n">stack</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">]</span><span class="o">-</span><span class="n">stack</span><span class="p">[:,:,</span><span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">j</span><span class="p">]])</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span>
                <span class="n">dist_mat</span><span class="p">[</span><span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">j</span><span class="p">],</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">dist_mat</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">j</span><span class="p">]]</span>


    <span class="sd">&quot;&quot;&quot;i,j = where(dist_mat==0)</span>
<span class="sd">    dist_mat[i,j] = max_val</span>

<span class="sd">    i = range(0,nb_points)</span>
<span class="sd">    dist_mat[i,i] = 0&quot;&quot;&quot;</span>

    <span class="n">i</span><span class="p">,</span><span class="n">j</span> <span class="o">=</span> <span class="n">where</span><span class="p">(</span><span class="n">dist_mat</span><span class="o">&lt;</span><span class="n">max_val</span><span class="p">)</span>
    <span class="n">dist_mat</span><span class="o">/=</span><span class="n">dist_mat</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">dist_mat</span>

<span class="k">def</span> <span class="nf">dist_map</span><span class="p">(</span><span class="n">stack</span><span class="p">):</span>
    <span class="kn">from</span> <span class="nn">numpy</span> <span class="k">import</span> <span class="n">zeros</span>
    <span class="kn">from</span> <span class="nn">numpy.linalg</span> <span class="k">import</span> <span class="n">norm</span>
    <span class="n">shap</span> <span class="o">=</span> <span class="n">stack</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">dist_mat</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
            <span class="n">dist_mat</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">norm</span><span class="p">(</span><span class="n">stack</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">]</span><span class="o">-</span><span class="n">stack</span><span class="p">[:,:,</span><span class="n">j</span><span class="p">])</span>
            <span class="n">dist_mat</span><span class="p">[</span><span class="n">j</span><span class="p">,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">dist_mat</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">dist_mat</span>

<div class="viewcode-block" id="dist_map_2"><a class="viewcode-back" href="../optim_utils.html#optim_utils.dist_map_2">[docs]</a><span class="k">def</span> <span class="nf">dist_map_2</span><span class="p">(</span><span class="n">arr</span><span class="p">):</span> <span class="c1"># The samples are in the columns</span>
    <span class="sd">&quot;&quot;&quot;Pairwise distances...?&quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">numpy.linalg</span> <span class="k">import</span> <span class="n">norm</span>
    <span class="kn">from</span> <span class="nn">numpy</span> <span class="k">import</span> <span class="n">ones</span><span class="p">,</span><span class="n">transpose</span><span class="p">,</span><span class="n">fill_diagonal</span>

    <span class="n">nb_samp</span> <span class="o">=</span> <span class="n">arr</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">norm_mat</span> <span class="o">=</span> <span class="p">((</span><span class="n">norm</span><span class="p">(</span><span class="n">arr</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">nb_samp</span><span class="p">,</span><span class="mi">1</span><span class="p">)))</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">ones</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span><span class="n">nb_samp</span><span class="p">)))</span>
    <span class="n">scalar_prod</span> <span class="o">=</span> <span class="n">transpose</span><span class="p">(</span><span class="n">arr</span><span class="p">)</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">arr</span><span class="p">)</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">norm_mat</span><span class="o">+</span><span class="n">transpose</span><span class="p">(</span><span class="n">norm_mat</span><span class="p">)</span><span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">scalar_prod</span>
    <span class="n">i</span><span class="p">,</span><span class="n">j</span> <span class="o">=</span> <span class="n">where</span><span class="p">(</span><span class="n">res</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">res</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">return</span> <span class="n">res</span></div>


<span class="k">def</span> <span class="nf">dist_map2</span><span class="p">(</span><span class="n">mat</span><span class="p">,</span><span class="n">rel</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span> <span class="c1"># The data are stored in the rows</span>
    <span class="kn">from</span> <span class="nn">numpy</span> <span class="k">import</span> <span class="n">ones</span><span class="p">,</span><span class="n">transpose</span>
    <span class="kn">from</span> <span class="nn">numpy.linalg</span> <span class="k">import</span> <span class="n">norm</span>
    <span class="n">ones_vect</span> <span class="o">=</span> <span class="n">ones</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span><span class="n">mat</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>

    <span class="n">norm_vect</span> <span class="o">=</span> <span class="p">(</span><span class="n">norm</span><span class="p">(</span><span class="n">mat</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">mat</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="mi">1</span><span class="p">)))</span><span class="o">**</span><span class="mi">2</span>

    <span class="n">co_dist_mat</span> <span class="o">=</span> <span class="n">norm_vect</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">ones_vect</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">rel</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">co_dist_mat</span><span class="o">+</span><span class="n">transpose</span><span class="p">(</span><span class="n">co_dist_mat</span><span class="p">)</span><span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">transpose</span><span class="p">(</span><span class="n">mat</span><span class="p">)</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">mat</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="mf">0.01</span><span class="o">*</span><span class="p">(</span><span class="n">co_dist_mat</span><span class="o">+</span><span class="n">transpose</span><span class="p">(</span><span class="n">co_dist_mat</span><span class="p">)))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">co_dist_mat</span><span class="o">+</span><span class="n">transpose</span><span class="p">(</span><span class="n">co_dist_mat</span><span class="p">)</span><span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">transpose</span><span class="p">(</span><span class="n">mat</span><span class="p">)</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">mat</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">max_gap</span><span class="p">(</span><span class="n">stack</span><span class="p">,</span><span class="n">pos_field</span><span class="p">,</span><span class="n">tol</span><span class="o">=</span><span class="mf">0.001</span><span class="p">,</span><span class="n">nb_neigh</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span><span class="n">max_val</span> <span class="o">=</span><span class="mi">2</span><span class="o">**</span><span class="mi">63</span><span class="p">,</span><span class="n">dist_mat</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">pol_en</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">cent</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="kn">from</span> <span class="nn">utils</span> <span class="k">import</span> <span class="n">compute_centroid</span>
    <span class="kn">from</span> <span class="nn">numpy</span> <span class="k">import</span> <span class="n">arange</span><span class="p">,</span><span class="n">ones</span><span class="p">,</span><span class="n">median</span><span class="p">,</span><span class="n">pi</span>
    <span class="k">if</span> <span class="n">dist_mat</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">dist_mat</span> <span class="o">=</span> <span class="n">dist_map</span><span class="p">(</span><span class="n">stack</span><span class="p">)</span>

    <span class="n">i</span><span class="p">,</span><span class="n">j</span> <span class="o">=</span> <span class="n">where</span><span class="p">(</span><span class="n">dist_mat</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">k</span> <span class="o">=</span> <span class="n">where</span><span class="p">(</span><span class="n">dist_mat</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span><span class="o">==</span><span class="n">dist_mat</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">())</span>

    <span class="n">inear</span> <span class="o">=</span> <span class="n">i</span><span class="p">[</span><span class="n">k</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]]</span>
    <span class="n">jnear</span> <span class="o">=</span> <span class="n">j</span><span class="p">[</span><span class="n">k</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]]</span>

    <span class="n">gap</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">stack</span><span class="p">[:,:,</span><span class="n">inear</span><span class="p">]</span><span class="o">-</span><span class="n">stack</span><span class="p">[:,:,</span><span class="n">jnear</span><span class="p">])</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
    <span class="sd">&quot;&quot;&quot;if pol_en:</span>
<span class="sd">        if cent is None:</span>
<span class="sd">            im_mean = stack.mean(axis=2)</span>
<span class="sd">            cent,w = compute_centroid(im_mean,sigw=100000000)</span>
<span class="sd">            cent = squeeze(cent)</span>
<span class="sd">        shap = stack.shape</span>

<span class="sd">        point_cloud = zeros((2,shap[0]*shap[1]))</span>
<span class="sd">        point_cloud[0,:] = (arange(0,shap[0]).reshape((shap[0],1)).dot(ones((1,shap[1])))).reshape((shap[0]*shap[1],))</span>
<span class="sd">        point_cloud[1,:] = ones((shap[0],1)).dot(arange(0,shap[1]).reshape((1,shap[1]))).reshape((shap[0]*shap[1],))</span>
<span class="sd">        point_cloud = setting_polar_2(point_cloud,1,cent)</span>
<span class="sd">        space_dist = dist_map_2(point_cloud)</span>
<span class="sd">        i,j = where(space_dist&gt;0)</span>
<span class="sd">        gap/=median(space_dist[i,j])&quot;&quot;&quot;</span>


    <span class="nb">print</span> <span class="s2">&quot;Unit mass single pixel move cost: &quot;</span><span class="p">,</span><span class="n">gap</span>

    <span class="k">return</span> <span class="n">gap</span><span class="p">,</span><span class="n">inear</span><span class="p">,</span><span class="n">jnear</span><span class="p">,</span><span class="n">dist_mat</span>

<span class="k">def</span> <span class="nf">setting_polar</span><span class="p">(</span><span class="n">coord_cart</span><span class="p">,</span><span class="n">gap</span><span class="p">,</span><span class="n">cent</span><span class="p">,</span><span class="n">max_dist</span><span class="p">):</span>

    <span class="kn">from</span> <span class="nn">numpy</span> <span class="k">import</span> <span class="n">zeros</span><span class="p">,</span><span class="n">pi</span><span class="p">,</span><span class="n">sqrt</span>
    <span class="kn">from</span> <span class="nn">utils</span> <span class="k">import</span> <span class="n">polar_coord_cloud</span>
    <span class="sd">&quot;&quot;&quot;from pyflann import FLANN</span>
<span class="sd">    knn = FLANN()</span>
<span class="sd">    params = knn.build_index(array(coord_cart, dtype=float64))</span>
<span class="sd">    result, dists = knn.nn_index(coord_cart, 2)&quot;&quot;&quot;</span>

    <span class="n">pol_coord</span> <span class="o">=</span> <span class="n">polar_coord_cloud</span><span class="p">(</span><span class="n">coord_cart</span><span class="p">,</span><span class="n">cent</span><span class="p">)</span>
    <span class="n">pol_coord</span><span class="p">[</span><span class="mi">1</span><span class="p">,:]</span><span class="o">*=</span><span class="p">(</span><span class="n">gap</span><span class="o">/</span><span class="n">pi</span><span class="p">)</span><span class="c1">#(max_dist/(pi*sqrt(coord_cart.shape[1])))</span>
    <span class="n">pol_coord</span><span class="p">[</span><span class="mi">0</span><span class="p">,:]</span><span class="o">*=</span><span class="n">gap</span>

    <span class="k">return</span> <span class="n">pol_coord</span>

<span class="k">def</span> <span class="nf">setting_polar_2</span><span class="p">(</span><span class="n">coord_cart</span><span class="p">,</span><span class="n">gap</span><span class="p">,</span><span class="n">cent</span><span class="p">):</span>

    <span class="kn">from</span> <span class="nn">numpy</span> <span class="k">import</span> <span class="n">zeros</span><span class="p">,</span><span class="n">pi</span><span class="p">,</span><span class="n">sqrt</span>
    <span class="kn">from</span> <span class="nn">utils</span> <span class="k">import</span> <span class="n">polar_coord_cloud</span>
    <span class="sd">&quot;&quot;&quot;from pyflann import FLANN</span>
<span class="sd">        knn = FLANN()</span>
<span class="sd">        params = knn.build_index(array(coord_cart, dtype=float64))</span>
<span class="sd">        result, dists = knn.nn_index(coord_cart, 2)&quot;&quot;&quot;</span>

    <span class="n">pol_coord</span> <span class="o">=</span> <span class="n">polar_coord_cloud</span><span class="p">(</span><span class="n">coord_cart</span><span class="p">,</span><span class="n">cent</span><span class="p">)</span>
    <span class="n">pol_coord</span><span class="p">[</span><span class="mi">1</span><span class="p">,:]</span><span class="o">*=</span><span class="p">(</span><span class="n">gap</span><span class="o">/</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">pi</span><span class="p">))</span><span class="o">*</span><span class="n">pol_coord</span><span class="p">[</span><span class="mi">0</span><span class="p">,:]</span><span class="c1">#(max_dist/(pi*sqrt(coord_cart.shape[1])))</span>
    <span class="n">pol_coord</span><span class="p">[</span><span class="mi">0</span><span class="p">,:]</span><span class="o">*=</span><span class="n">gap</span>

    <span class="k">return</span> <span class="n">pol_coord</span>


<span class="k">def</span> <span class="nf">setting_cart_from_polar</span><span class="p">(</span><span class="n">coord_pol</span><span class="p">,</span><span class="n">gap</span><span class="p">,</span><span class="n">cent</span><span class="p">,</span><span class="n">max_dist</span><span class="p">):</span>

    <span class="kn">from</span> <span class="nn">numpy</span> <span class="k">import</span> <span class="n">zeros</span><span class="p">,</span><span class="n">pi</span><span class="p">,</span><span class="n">sqrt</span><span class="p">,</span><span class="n">copy</span>
    <span class="kn">from</span> <span class="nn">utils</span> <span class="k">import</span> <span class="n">polar_to_cart_cloud</span>
    <span class="sd">&quot;&quot;&quot;from pyflann import FLANN</span>
<span class="sd">        knn = FLANN()</span>
<span class="sd">        params = knn.build_index(array(coord_cart, dtype=float64))</span>
<span class="sd">        result, dists = knn.nn_index(coord_cart, 2)&quot;&quot;&quot;</span>

    <span class="n">cart_coord</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">coord_pol</span><span class="p">)</span>
    <span class="n">cart_coord</span><span class="p">[</span><span class="mi">1</span><span class="p">,:]</span><span class="o">/=</span><span class="p">(</span><span class="n">gap</span><span class="o">/</span><span class="n">pi</span><span class="p">)</span><span class="c1">#(max_dist/(pi*sqrt(coord_pol.shape[1])))</span>
    <span class="n">cart_coord</span><span class="p">[</span><span class="mi">0</span><span class="p">,:]</span><span class="o">/=</span><span class="n">gap</span>

    <span class="n">cart_coord</span> <span class="o">=</span> <span class="n">polar_to_cart_cloud</span><span class="p">(</span><span class="n">cart_coord</span><span class="p">,</span><span class="n">cent</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">cart_coord</span>

<span class="k">def</span> <span class="nf">setting_cart_from_polar_2</span><span class="p">(</span><span class="n">coord_pol</span><span class="p">,</span><span class="n">gap</span><span class="p">,</span><span class="n">cent</span><span class="p">,</span><span class="n">max_dist</span><span class="p">):</span>

    <span class="kn">from</span> <span class="nn">numpy</span> <span class="k">import</span> <span class="n">zeros</span><span class="p">,</span><span class="n">pi</span><span class="p">,</span><span class="n">sqrt</span><span class="p">,</span><span class="n">copy</span>
    <span class="kn">from</span> <span class="nn">utils</span> <span class="k">import</span> <span class="n">polar_to_cart_cloud</span>
    <span class="sd">&quot;&quot;&quot;from pyflann import FLANN</span>
<span class="sd">        knn = FLANN()</span>
<span class="sd">        params = knn.build_index(array(coord_cart, dtype=float64))</span>
<span class="sd">        result, dists = knn.nn_index(coord_cart, 2)&quot;&quot;&quot;</span>

    <span class="n">cart_coord</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">coord_pol</span><span class="p">)</span>
    <span class="n">cart_coord</span><span class="p">[</span><span class="mi">0</span><span class="p">,:]</span><span class="o">/=</span><span class="n">gap</span>

    <span class="n">ind</span> <span class="o">=</span> <span class="n">where</span><span class="p">(</span><span class="n">cart_coord</span><span class="p">[</span><span class="mi">0</span><span class="p">,:]</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">cart_coord</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="n">ind</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">/=</span><span class="p">(</span><span class="n">cart_coord</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">ind</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">*</span><span class="n">gap</span><span class="o">/</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">pi</span><span class="p">))</span><span class="c1">#(max_dist/(pi*sqrt(coord_pol.shape[1])))</span>


    <span class="n">cart_coord</span> <span class="o">=</span> <span class="n">polar_to_cart_cloud</span><span class="p">(</span><span class="n">cart_coord</span><span class="p">,</span><span class="n">cent</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">cart_coord</span>


<span class="k">def</span> <span class="nf">max_gap_abs</span><span class="p">(</span><span class="n">stack</span><span class="p">):</span>
    <span class="kn">from</span> <span class="nn">numpy</span> <span class="k">import</span> <span class="n">gradient</span><span class="p">,</span><span class="n">median</span><span class="p">,</span><span class="n">zeros</span><span class="p">,</span><span class="n">mean</span>

    <span class="n">diff_val</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">stack</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="mi">2</span><span class="p">,))</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">stack</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
        <span class="n">dx</span><span class="p">,</span><span class="n">dy</span> <span class="o">=</span> <span class="n">gradient</span><span class="p">(</span><span class="n">stack</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">])</span>
        <span class="n">diff_val</span><span class="p">[</span><span class="mi">2</span><span class="o">*</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">median</span><span class="p">(</span><span class="n">dx</span><span class="p">)</span>
        <span class="n">diff_val</span><span class="p">[</span><span class="mi">2</span><span class="o">*</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">median</span><span class="p">(</span><span class="n">dy</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">mean</span><span class="p">(</span><span class="n">diff_val</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">corr_map</span><span class="p">(</span><span class="n">stack</span><span class="p">):</span>
    <span class="kn">from</span> <span class="nn">numpy</span> <span class="k">import</span> <span class="n">ones</span>
    <span class="kn">from</span> <span class="nn">numpy.linalg</span> <span class="k">import</span> <span class="n">norm</span>
    <span class="n">shap</span> <span class="o">=</span> <span class="n">stack</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">corr_mat</span> <span class="o">=</span> <span class="n">ones</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
            <span class="n">corr_mat</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="n">stack</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">]</span><span class="o">*</span><span class="n">stack</span><span class="p">[:,:,</span><span class="n">j</span><span class="p">]))</span><span class="o">/</span><span class="p">(</span><span class="n">norm</span><span class="p">(</span><span class="n">stack</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">])</span><span class="o">*</span><span class="n">norm</span><span class="p">(</span><span class="n">stack</span><span class="p">[:,:,</span><span class="n">j</span><span class="p">]))</span>

    <span class="k">return</span> <span class="n">corr_mat</span>

<span class="k">def</span> <span class="nf">distance_mat</span><span class="p">(</span><span class="n">embed</span><span class="p">):</span>
    <span class="kn">from</span> <span class="nn">numpy</span> <span class="k">import</span> <span class="n">zeros</span>
    <span class="n">shap</span> <span class="o">=</span> <span class="n">embed</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">dist</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
            <span class="n">dist</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">sqrt</span><span class="p">(</span><span class="nb">sum</span><span class="p">((</span><span class="n">embed</span><span class="p">[:,</span><span class="n">i</span><span class="p">]</span><span class="o">-</span><span class="n">embed</span><span class="p">[:,</span><span class="n">j</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span>
            <span class="n">dist</span><span class="p">[</span><span class="n">j</span><span class="p">,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">dist</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">dist</span>

<span class="k">def</span> <span class="nf">local_euc_dist_mat_support</span><span class="p">(</span><span class="n">stack</span><span class="p">,</span><span class="n">pos_field</span><span class="p">,</span><span class="n">knn</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">nb_neigh</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span><span class="n">max_val</span> <span class="o">=</span><span class="mi">2</span><span class="o">**</span><span class="mi">63</span><span class="p">):</span> <span class="c1"># Compute the euclidian distance over the intersection of the support of each considered pair of images</span>
    <span class="kn">from</span> <span class="nn">numpy</span> <span class="k">import</span> <span class="n">zeros</span><span class="p">,</span><span class="n">transpose</span><span class="p">,</span><span class="n">ones</span><span class="p">,</span><span class="n">sqrt</span>
    <span class="kn">from</span> <span class="nn">pyflann</span> <span class="k">import</span> <span class="n">FLANN</span>
    <span class="k">if</span> <span class="n">knn</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">knn</span> <span class="o">=</span> <span class="n">FLANN</span><span class="p">()</span>
        <span class="n">params</span> <span class="o">=</span> <span class="n">knn</span><span class="o">.</span><span class="n">build_index</span><span class="p">(</span><span class="n">array</span><span class="p">(</span><span class="n">pos_field</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">float64</span><span class="p">))</span>

    <span class="n">nb_points</span> <span class="o">=</span> <span class="n">stack</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">dist_mat</span> <span class="o">=</span> <span class="n">ones</span><span class="p">((</span><span class="n">nb_points</span><span class="p">,</span><span class="n">nb_points</span><span class="p">))</span><span class="o">*</span><span class="n">max_val</span>
    <span class="n">i</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_points</span><span class="p">)</span>
    <span class="n">dist_mat</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">result</span><span class="p">,</span> <span class="n">dists</span> <span class="o">=</span> <span class="n">knn</span><span class="o">.</span><span class="n">nn_index</span><span class="p">(</span><span class="n">pos_field</span><span class="p">,</span> <span class="n">nb_neigh</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_points</span><span class="p">):</span>

        <span class="nb">print</span> <span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="s2">&quot;th PSF&quot;</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">nb_neigh</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">dist_mat</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">result</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]]</span><span class="o">==</span><span class="n">max_val</span><span class="p">:</span>
                <span class="n">supp1i</span><span class="p">,</span><span class="n">supp1j</span> <span class="o">=</span>  <span class="n">where</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">stack</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">])</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">)</span>
                <span class="n">supp12</span> <span class="o">=</span> <span class="n">where</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">stack</span><span class="p">[</span><span class="n">supp1i</span><span class="p">,</span><span class="n">supp1j</span><span class="p">,</span><span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">j</span><span class="p">]])</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">)</span>
                <span class="n">dist_mat</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">result</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]]</span> <span class="o">=</span> <span class="n">sqrt</span><span class="p">(</span><span class="nb">sum</span><span class="p">((</span><span class="n">stack</span><span class="p">[</span><span class="n">supp1i</span><span class="p">[</span><span class="n">supp12</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span><span class="n">supp1j</span><span class="p">[</span><span class="n">supp12</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span><span class="n">i</span><span class="p">]</span><span class="o">-</span><span class="n">stack</span><span class="p">[</span><span class="n">supp1i</span><span class="p">[</span><span class="n">supp12</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span><span class="n">supp1j</span><span class="p">[</span><span class="n">supp12</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span><span class="n">result</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]])</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span>
                <span class="n">dist_mat</span><span class="p">[</span><span class="n">result</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">],</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">dist_mat</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">result</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]]</span>


    <span class="k">return</span> <span class="n">dist_mat</span>



<span class="k">def</span> <span class="nf">local_dist_euc_interface_m</span><span class="p">(</span><span class="n">stack_list</span><span class="p">,</span><span class="n">pos_field</span><span class="p">,</span><span class="n">nb_neigh</span><span class="o">=</span><span class="mi">30</span><span class="p">):</span>

    <span class="n">dist_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">stack_list</span><span class="p">)):</span>
        <span class="nb">print</span> <span class="s2">&quot;Feature &quot;</span><span class="p">,</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span>
        <span class="n">dist_i</span> <span class="o">=</span> <span class="n">local_euc_dist_mat</span><span class="p">(</span><span class="n">stack_list</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">pos_field</span><span class="p">,</span><span class="n">nb_neigh</span><span class="o">=</span><span class="n">nb_neigh</span><span class="p">)</span>
        <span class="n">dist_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dist_i</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">dist_list</span>

<span class="k">def</span> <span class="nf">local_dist_euc_interface_supp_m</span><span class="p">(</span><span class="n">stack_list</span><span class="p">,</span><span class="n">pos_field</span><span class="p">,</span><span class="n">nb_neigh</span><span class="o">=</span><span class="mi">30</span><span class="p">):</span>

    <span class="n">dist_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">stack_list</span><span class="p">)):</span>
        <span class="nb">print</span> <span class="s2">&quot;Feature &quot;</span><span class="p">,</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span>
        <span class="n">dist_i</span> <span class="o">=</span> <span class="n">local_euc_dist_mat_support</span><span class="p">(</span><span class="n">stack_list</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">pos_field</span><span class="p">,</span><span class="n">nb_neigh</span><span class="o">=</span><span class="n">nb_neigh</span><span class="p">)</span>
        <span class="n">dist_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dist_i</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">dist_list</span>


<span class="k">def</span> <span class="nf">euc_support_barycenter</span><span class="p">(</span><span class="n">stack</span><span class="p">,</span><span class="n">weights</span><span class="p">):</span>
    <span class="kn">from</span> <span class="nn">numpy</span> <span class="k">import</span> <span class="n">zeros</span>
    <span class="n">shap</span> <span class="o">=</span> <span class="n">stack</span><span class="o">.</span><span class="n">shape</span>

    <span class="n">bar</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">(</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">])</span>
    <span class="n">i</span><span class="p">,</span><span class="n">j</span> <span class="o">=</span> <span class="n">where</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">stack</span><span class="o">.</span><span class="n">prod</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">))</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
        <span class="n">bar</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span><span class="o">+=</span><span class="n">stack</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">]</span><span class="o">*</span><span class="n">weights</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">bar</span>


<span class="k">def</span> <span class="nf">local_tang_coord</span><span class="p">(</span><span class="n">dist_mat</span><span class="p">,</span><span class="n">nb_neigh</span><span class="p">,</span><span class="n">nb_components</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">test</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">tol</span><span class="o">=</span><span class="mf">0.999</span><span class="p">):</span>
    <span class="kn">from</span> <span class="nn">numpy</span> <span class="k">import</span> <span class="n">zeros</span><span class="p">,</span><span class="n">argsort</span><span class="p">,</span><span class="n">transpose</span>
    <span class="kn">from</span> <span class="nn">utils</span> <span class="k">import</span> <span class="n">mds</span>
    <span class="n">nb_components_0</span> <span class="o">=</span> <span class="n">nb_components</span>
    <span class="k">if</span> <span class="n">nb_components</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">nb_components_0</span> <span class="o">=</span> <span class="n">nb_components</span>
    <span class="n">nb_points</span> <span class="o">=</span> <span class="n">dist_mat</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">coord_out</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">nb_components_0</span><span class="p">,</span><span class="n">nb_neigh</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">nb_points</span><span class="p">))</span>
    <span class="n">indices</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">nb_points</span><span class="p">,</span><span class="n">nb_neigh</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>
    <span class="n">weights</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">nb_points</span><span class="p">,</span><span class="n">nb_components_0</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_points</span><span class="p">):</span>
        <span class="n">ind</span>  <span class="o">=</span> <span class="n">argsort</span><span class="p">(</span><span class="n">dist_mat</span><span class="p">[</span><span class="n">i</span><span class="p">,:])</span>

        <span class="n">indices</span><span class="p">[</span><span class="n">i</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">ind</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">nb_neigh</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">loc_dist</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">nb_neigh</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">nb_neigh</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_neigh</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">nb_neigh</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
                <span class="n">loc_dist</span><span class="p">[</span><span class="n">k</span><span class="p">,</span><span class="n">l</span><span class="p">]</span> <span class="o">=</span> <span class="n">dist_mat</span><span class="p">[</span><span class="n">ind</span><span class="p">[</span><span class="n">k</span><span class="p">],</span><span class="n">ind</span><span class="p">[</span><span class="n">l</span><span class="p">]]</span>
        <span class="n">loc_dist</span><span class="o">+=</span><span class="n">transpose</span><span class="p">(</span><span class="n">loc_dist</span><span class="p">)</span>

        <span class="n">loc_coord</span><span class="p">,</span><span class="n">w</span> <span class="o">=</span> <span class="n">mds</span><span class="p">(</span><span class="n">loc_dist</span><span class="p">,</span><span class="n">nb_components</span> <span class="o">=</span> <span class="n">nb_components_0</span><span class="p">)</span>
        <span class="n">weights</span><span class="p">[</span><span class="n">i</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">w</span>
        <span class="n">coord_out</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">transpose</span><span class="p">(</span><span class="n">loc_coord</span><span class="p">)</span>

    <span class="c1"># Intrinsic dimension esttimation</span>
    <span class="n">dim</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">if</span> <span class="n">nb_components</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">E</span> <span class="o">=</span> <span class="p">(</span><span class="n">weights</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="n">Etrunc</span> <span class="o">=</span> <span class="p">(</span><span class="n">weights</span><span class="p">[:,</span><span class="mi">0</span><span class="p">:</span><span class="n">dim</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="k">while</span> <span class="n">Etrunc</span><span class="o">&lt;</span><span class="n">tol</span><span class="o">*</span><span class="n">E</span><span class="p">:</span>
            <span class="n">dim</span><span class="o">+=</span><span class="mi">1</span>
            <span class="n">Etrunc</span> <span class="o">=</span> <span class="p">(</span><span class="n">weights</span><span class="p">[:,</span><span class="mi">0</span><span class="p">:</span><span class="n">dim</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>

        <span class="nb">print</span> <span class="s2">&quot;Estimated intrinsic dimension: &quot;</span><span class="p">,</span><span class="n">dim</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">dim</span> <span class="o">=</span> <span class="n">nb_components</span>

    <span class="k">if</span> <span class="n">test</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">coord_out</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">dim</span><span class="p">,:,:],</span><span class="n">indices</span><span class="p">,</span><span class="n">weights</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">coord_out</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">dim</span><span class="p">,:,:],</span><span class="n">indices</span>

<span class="k">def</span> <span class="nf">local_reduction</span><span class="p">(</span><span class="n">data_mat</span><span class="p">,</span><span class="n">nb_neigh</span><span class="p">,</span><span class="n">nb_comp</span><span class="p">,</span><span class="n">dist_mat</span><span class="p">):</span>

    <span class="kn">from</span> <span class="nn">numpy.linalg</span> <span class="k">import</span> <span class="n">svd</span>
    <span class="kn">from</span> <span class="nn">numpy</span> <span class="k">import</span> <span class="n">argsort</span><span class="p">,</span><span class="n">copy</span><span class="p">,</span><span class="n">diag</span>

    <span class="n">data_approx</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">data_mat</span><span class="p">)</span>

    <span class="n">shap</span> <span class="o">=</span> <span class="n">data_mat</span><span class="o">.</span><span class="n">shape</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
        <span class="n">ind</span> <span class="o">=</span> <span class="n">argsort</span><span class="p">(</span><span class="n">dist_mat</span><span class="p">[</span><span class="n">i</span><span class="p">,:])</span>
        <span class="n">U</span><span class="p">,</span><span class="n">s</span><span class="p">,</span><span class="n">V</span> <span class="o">=</span> <span class="n">svd</span><span class="p">(</span><span class="n">data_mat</span><span class="p">[:,</span><span class="n">ind</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">nb_neigh</span><span class="p">]])</span>
        <span class="n">data_approx</span><span class="p">[:,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">U</span><span class="p">[:,</span><span class="n">ind</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">nb_neigh</span><span class="p">]]</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">diag</span><span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">nb_neigh</span><span class="p">])))</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">V</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">nb_neigh</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">nb_neigh</span><span class="p">,</span><span class="mi">1</span><span class="p">)))</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">],))</span>

    <span class="k">return</span> <span class="n">data_approx</span>


<span class="k">def</span> <span class="nf">hessian_estimator</span><span class="p">(</span><span class="n">coord_out</span><span class="p">,</span><span class="n">indices</span><span class="p">):</span>
    <span class="kn">from</span> <span class="nn">numpy</span> <span class="k">import</span> <span class="n">zeros</span><span class="p">,</span><span class="n">ones</span><span class="p">,</span><span class="n">transpose</span>
    <span class="kn">from</span> <span class="nn">utils</span> <span class="k">import</span> <span class="n">gram_schmidt</span>

    <span class="n">nb_points</span> <span class="o">=</span> <span class="n">coord_out</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">d</span> <span class="o">=</span> <span class="n">coord_out</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">nb_neigh</span> <span class="o">=</span> <span class="n">coord_out</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">q</span> <span class="o">=</span> <span class="p">(</span><span class="n">d</span><span class="o">*</span><span class="p">(</span><span class="n">d</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span><span class="o">/</span><span class="mi">2</span>
    <span class="n">X</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">nb_neigh</span><span class="p">,</span><span class="mi">1</span><span class="o">+</span><span class="n">d</span><span class="o">+</span><span class="n">q</span><span class="p">,</span><span class="n">nb_points</span><span class="p">))</span>
    <span class="n">Q</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">nb_neigh</span><span class="p">,</span><span class="n">q</span><span class="p">,</span><span class="n">nb_points</span><span class="p">))</span>
    <span class="n">H</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">nb_points</span><span class="p">,</span><span class="n">nb_points</span><span class="p">))</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_points</span><span class="p">):</span>
        <span class="nb">print</span> <span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="s2">&quot; th point/&quot;</span><span class="p">,</span><span class="n">nb_points</span>
        <span class="n">X</span><span class="p">[:,</span><span class="mi">0</span><span class="p">,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">ones</span><span class="p">((</span><span class="n">nb_neigh</span><span class="p">,))</span>
        <span class="n">X</span><span class="p">[:,</span><span class="mi">1</span><span class="p">:</span><span class="mi">1</span><span class="o">+</span><span class="n">d</span><span class="p">,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">transpose</span><span class="p">(</span><span class="n">coord_out</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">])</span>
        <span class="n">Ei</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">nb_points</span><span class="p">,</span><span class="n">nb_neigh</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_neigh</span><span class="p">):</span>
            <span class="n">Ei</span><span class="p">[</span><span class="n">indices</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">],</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">count</span><span class="o">=</span><span class="mi">0</span>
            <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">d</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">l</span><span class="p">,</span><span class="n">d</span><span class="p">):</span>
                    <span class="n">X</span><span class="p">[</span><span class="n">j</span><span class="p">,</span><span class="n">d</span><span class="o">+</span><span class="mi">1</span><span class="o">+</span><span class="n">count</span><span class="p">,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">coord_out</span><span class="p">[</span><span class="n">l</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">i</span><span class="p">]</span><span class="o">*</span><span class="n">coord_out</span><span class="p">[</span><span class="n">k</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">i</span><span class="p">]</span>
                    <span class="n">count</span><span class="o">+=</span><span class="mi">1</span>
        <span class="n">Q</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">gram_schmidt</span><span class="p">(</span><span class="n">X</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">])[:,</span><span class="o">-</span><span class="n">q</span><span class="p">:]</span>
        <span class="n">temp_m</span> <span class="o">=</span> <span class="n">Ei</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">Q</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">])</span>
        <span class="n">H</span><span class="o">+=</span> <span class="n">temp_m</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">transpose</span><span class="p">(</span><span class="n">temp_m</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">H</span><span class="p">,</span><span class="n">Q</span><span class="p">,</span><span class="n">X</span>

<span class="k">def</span> <span class="nf">HLLE</span><span class="p">(</span><span class="n">dist_mat</span><span class="p">,</span><span class="n">nb_neigh</span><span class="p">,</span><span class="n">nb_comp</span><span class="p">,</span><span class="n">test</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">tol</span><span class="o">=</span><span class="mf">0.999</span><span class="p">):</span>
    <span class="kn">from</span> <span class="nn">numpy.linalg</span> <span class="k">import</span> <span class="n">svd</span>
    <span class="kn">from</span> <span class="nn">numpy</span> <span class="k">import</span> <span class="n">transpose</span>
    <span class="kn">from</span> <span class="nn">pyflann</span> <span class="k">import</span> <span class="n">FLANN</span>

    <span class="n">coord_out</span><span class="p">,</span><span class="n">indices</span><span class="p">,</span><span class="n">s</span> <span class="o">=</span> <span class="n">local_tang_coord</span><span class="p">(</span><span class="n">dist_mat</span><span class="p">,</span><span class="n">nb_neigh</span><span class="p">,</span><span class="n">nb_components</span><span class="o">=</span><span class="n">nb_comp</span><span class="p">,</span><span class="n">tol</span><span class="o">=</span><span class="n">tol</span><span class="p">,</span><span class="n">test</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">H</span><span class="p">,</span><span class="n">Q</span><span class="p">,</span><span class="n">X</span> <span class="o">=</span> <span class="n">hessian_estimator</span><span class="p">(</span><span class="n">coord_out</span><span class="p">,</span><span class="n">indices</span><span class="p">)</span>

    <span class="n">U</span><span class="p">,</span><span class="n">s0</span><span class="p">,</span><span class="n">V</span> <span class="o">=</span><span class="n">svd</span><span class="p">(</span><span class="n">H</span><span class="p">)</span>

    <span class="n">embedding</span> <span class="o">=</span> <span class="n">transpose</span><span class="p">(</span><span class="n">U</span><span class="p">[:,</span><span class="o">-</span><span class="p">(</span><span class="n">coord_out</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>

    <span class="n">knn</span> <span class="o">=</span> <span class="n">FLANN</span><span class="p">()</span>
    <span class="n">params</span> <span class="o">=</span> <span class="n">knn</span><span class="o">.</span><span class="n">build_index</span><span class="p">(</span><span class="n">array</span><span class="p">(</span><span class="n">U</span><span class="p">[:,</span><span class="o">-</span><span class="p">(</span><span class="n">coord_out</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">float64</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">test</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">embedding</span><span class="p">,</span><span class="n">s</span><span class="p">,</span><span class="n">knn</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">embedding</span><span class="p">,</span><span class="n">knn</span>


<span class="k">def</span> <span class="nf">approx_HLLE</span><span class="p">(</span><span class="n">data_mat</span><span class="p">,</span><span class="n">dist_mat</span><span class="p">,</span><span class="n">nb_neigh</span><span class="p">,</span><span class="n">nb_comp</span><span class="p">):</span> <span class="c1"># The observations are in the columns</span>
    <span class="kn">from</span> <span class="nn">numpy</span> <span class="k">import</span> <span class="n">zeros</span><span class="p">,</span><span class="n">argsort</span><span class="p">,</span><span class="n">transpose</span>
    <span class="kn">from</span> <span class="nn">numpy.linalg</span> <span class="k">import</span> <span class="n">pinv</span>
    <span class="n">shap</span> <span class="o">=</span> <span class="n">data_mat</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">loc_comp</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">nb_comp</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
    <span class="n">data_approx</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">data_mat</span><span class="p">)</span>

    <span class="n">embedding</span><span class="p">,</span><span class="n">knn</span> <span class="o">=</span> <span class="n">HLLE</span><span class="p">(</span><span class="n">dist_mat</span><span class="p">,</span><span class="n">nb_neigh</span><span class="p">,</span><span class="n">nb_comp</span><span class="p">,</span><span class="n">test</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">tol</span><span class="o">=</span><span class="mf">0.999</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
        <span class="n">ind</span> <span class="o">=</span> <span class="n">argsort</span><span class="p">(</span><span class="n">dist_mat</span><span class="p">[</span><span class="n">i</span><span class="p">,:])</span>
        <span class="n">loc_comp</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">data_mat</span><span class="p">[:,</span><span class="n">ind</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">nb_neigh</span><span class="p">]]</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">transpose</span><span class="p">(</span><span class="n">pinv</span><span class="p">(</span><span class="n">transpose</span><span class="p">(</span><span class="n">embedding</span><span class="p">[:,</span><span class="n">ind</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">nb_neigh</span><span class="p">]]))))</span>
        <span class="n">data_approx</span><span class="p">[:,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">loc_comp</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">embedding</span><span class="p">[:,</span><span class="n">ind</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">nb_comp</span><span class="p">,</span><span class="mi">1</span><span class="p">))))</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">],))</span>

    <span class="k">return</span> <span class="n">embedding</span><span class="p">,</span><span class="n">loc_comp</span><span class="p">,</span><span class="n">data_approx</span>

<span class="k">def</span> <span class="nf">pair_wise_distances_constraint</span><span class="p">(</span><span class="n">Y</span><span class="p">,</span><span class="n">dist_mat</span><span class="p">,</span><span class="n">details_mat</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">nb_iter</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span><span class="n">tol</span><span class="o">=</span><span class="mf">0.0001</span><span class="p">,</span><span class="n">spec_rad</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">nb_eig</span><span class="o">=</span><span class="mi">200</span><span class="p">):</span> <span class="c1"># The observations are in the rows</span>
    <span class="kn">from</span> <span class="nn">scipy.sparse.linalg</span> <span class="k">import</span> <span class="n">spsolve</span>
    <span class="kn">from</span> <span class="nn">numpy.linalg</span> <span class="k">import</span> <span class="n">solve</span><span class="p">,</span><span class="n">norm</span>
    <span class="kn">from</span> <span class="nn">numpy</span> <span class="k">import</span> <span class="n">zeros</span><span class="p">,</span><span class="n">transpose</span><span class="p">,</span><span class="n">array</span><span class="p">,</span><span class="n">copy</span><span class="p">,</span><span class="n">diag</span>
    <span class="kn">from</span> <span class="nn">scipy.sparse.linalg</span> <span class="k">import</span> <span class="n">svds</span><span class="p">,</span><span class="n">eigsh</span>
    <span class="n">shap</span> <span class="o">=</span> <span class="n">Y</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">diff_mat</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">],(</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span><span class="o">/</span><span class="mi">2</span><span class="p">))</span>
    <span class="n">ordered_dist</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">(((</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span><span class="o">/</span><span class="mi">2</span><span class="p">,))</span>
    <span class="n">spec_rad</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">if</span> <span class="n">details_mat</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">details_mat</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="n">full_details_mat</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">(((</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span><span class="o">/</span><span class="mi">2</span><span class="p">,(</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span><span class="o">/</span><span class="mi">2</span><span class="p">))</span>
        <span class="nb">print</span> <span class="s2">&quot;Building implicit details matrix...&quot;</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>

                <span class="n">ind</span> <span class="o">=</span> <span class="n">i</span><span class="o">*</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="p">(</span><span class="n">i</span><span class="o">*</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span><span class="o">/</span><span class="mi">2</span> <span class="o">+</span> <span class="n">j</span><span class="o">-</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span>
                <span class="n">diff_mat</span><span class="p">[:,</span><span class="n">ind</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">Y</span><span class="p">[:,</span><span class="n">i</span><span class="p">]</span><span class="o">-</span><span class="n">Y</span><span class="p">[:,</span><span class="n">j</span><span class="p">])</span>
                <span class="n">ordered_dist</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span> <span class="o">=</span> <span class="n">dist_mat</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span>
                <span class="n">full_details_mat</span><span class="p">[</span><span class="n">ind</span><span class="p">,</span><span class="n">ind</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span>
                <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
                    <span class="k">if</span> <span class="n">k</span><span class="o">!=</span><span class="n">j</span><span class="p">:</span>
                        <span class="n">full_details_mat</span><span class="p">[</span><span class="n">i</span><span class="o">*</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="p">(</span><span class="n">i</span><span class="o">*</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span><span class="o">/</span><span class="mi">2</span> <span class="o">+</span> <span class="n">k</span><span class="o">-</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">ind</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">j</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">l</span><span class="o">!=</span><span class="n">i</span><span class="p">:</span>
                        <span class="n">full_details_mat</span><span class="p">[</span><span class="n">l</span><span class="o">*</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="p">(</span><span class="n">l</span><span class="o">*</span><span class="p">(</span><span class="n">l</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span><span class="o">/</span><span class="mi">2</span> <span class="o">+</span> <span class="n">j</span><span class="o">-</span><span class="n">l</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">ind</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
                    <span class="n">full_details_mat</span><span class="p">[</span><span class="n">j</span><span class="o">*</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="p">(</span><span class="n">j</span><span class="o">*</span><span class="p">(</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span><span class="o">/</span><span class="mi">2</span> <span class="o">+</span> <span class="n">k</span><span class="o">-</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">ind</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.0</span>
                <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">i</span><span class="p">):</span>
                    <span class="n">full_details_mat</span><span class="p">[</span><span class="n">l</span><span class="o">*</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="p">(</span><span class="n">l</span><span class="o">*</span><span class="p">(</span><span class="n">l</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span><span class="o">/</span><span class="mi">2</span> <span class="o">+</span> <span class="n">i</span><span class="o">-</span><span class="n">l</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">ind</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.0</span>

        <span class="nb">print</span> <span class="s2">&quot;Eigen analysis...&quot;</span>
        <span class="c1">#U,s,V = svds(full_details_mat,k=nb_eig)</span>
        <span class="n">s</span><span class="p">,</span><span class="n">U</span> <span class="o">=</span> <span class="n">eigsh</span><span class="p">(</span><span class="n">full_details_mat</span><span class="p">,</span><span class="n">k</span><span class="o">=</span><span class="n">nb_eig</span><span class="p">)</span>
        <span class="n">V</span> <span class="o">=</span> <span class="n">transpose</span><span class="p">(</span><span class="n">U</span><span class="p">)</span>
        <span class="n">ind</span> <span class="o">=</span> <span class="n">where</span><span class="p">(</span><span class="n">s</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">U</span> <span class="o">=</span> <span class="n">U</span><span class="p">[:,</span><span class="n">ind</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">s</span><span class="p">[</span><span class="n">ind</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
        <span class="n">V</span> <span class="o">=</span> <span class="n">V</span><span class="p">[</span><span class="n">ind</span><span class="p">[</span><span class="mi">0</span><span class="p">],:]</span>

        <span class="nb">print</span> <span class="s2">&quot;Details matrix approximation error: &quot;</span><span class="p">,</span><span class="mi">100</span><span class="o">*</span><span class="nb">abs</span><span class="p">(</span><span class="n">norm</span><span class="p">(</span><span class="n">s</span><span class="p">)</span><span class="o">-</span><span class="n">norm</span><span class="p">(</span><span class="n">full_details_mat</span><span class="p">))</span><span class="o">/</span><span class="n">norm</span><span class="p">(</span><span class="n">full_details_mat</span><span class="p">),</span><span class="n">norm</span><span class="p">(</span><span class="n">full_details_mat</span><span class="o">-</span><span class="n">U</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">diag</span><span class="p">(</span><span class="n">s</span><span class="p">))</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">V</span><span class="p">))</span>

        <span class="n">details_mat</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">U</span><span class="p">)</span>
        <span class="n">details_mat</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
        <span class="n">details_mat</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">V</span><span class="p">)</span>
    <span class="n">spec_rad</span> <span class="o">=</span> <span class="n">details_mat</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
    <span class="n">Z</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">],(</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span><span class="o">/</span><span class="mi">2</span><span class="p">))</span>
    <span class="n">X</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">],(</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span><span class="o">/</span><span class="mi">2</span><span class="p">))</span>

    <span class="n">i</span><span class="o">=</span><span class="mi">0</span>
    <span class="n">err</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">t</span><span class="o">=</span><span class="mi">1</span>
    <span class="n">told</span><span class="o">=</span><span class="n">t</span>
    <span class="n">nb_samp_prox</span> <span class="o">=</span> <span class="p">(</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span><span class="o">/</span><span class="mi">2</span>
    <span class="k">while</span><span class="p">(</span><span class="n">i</span><span class="o">&lt;</span><span class="n">nb_iter</span> <span class="ow">and</span> <span class="n">err</span><span class="o">&gt;</span><span class="n">tol</span><span class="p">):</span>
        <span class="n">grad</span> <span class="o">=</span> <span class="n">Z</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">details_mat</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">diag</span><span class="p">(</span><span class="n">details_mat</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">details_mat</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">-</span><span class="n">diff_mat</span>
        <span class="n">Ytemp</span> <span class="o">=</span> <span class="n">Z</span><span class="o">-</span><span class="n">grad</span><span class="o">/</span><span class="n">spec_rad</span>
        <span class="n">Xold</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
        <span class="n">X</span> <span class="o">=</span> <span class="n">pair_wise_dist_dual_proximity_op</span><span class="p">(</span><span class="n">Ytemp</span><span class="p">,</span><span class="n">spec_rad</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span><span class="n">ordered_dist</span><span class="p">,</span><span class="n">nb_samp</span><span class="o">=</span><span class="n">nb_samp_prox</span><span class="p">)</span>
        <span class="n">t</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">4</span><span class="o">*</span><span class="n">told</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span><span class="o">/</span><span class="mi">2</span>
        <span class="n">lamb</span> <span class="o">=</span> <span class="mi">1</span><span class="o">+</span><span class="p">(</span><span class="n">told</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="n">t</span>
        <span class="n">told</span> <span class="o">=</span> <span class="n">t</span>
        <span class="n">Z</span> <span class="o">=</span> <span class="n">Xold</span> <span class="o">+</span> <span class="n">lamb</span><span class="o">*</span><span class="p">(</span><span class="n">X</span><span class="o">-</span><span class="n">Xold</span><span class="p">)</span>
        <span class="n">err</span> <span class="o">=</span> <span class="mi">100</span><span class="o">*</span><span class="n">norm</span><span class="p">(</span><span class="n">X</span><span class="o">-</span><span class="n">Xold</span><span class="p">)</span><span class="o">/</span><span class="n">norm</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>

        <span class="nb">print</span> <span class="s2">&quot;Gradient&#39;s norm: &quot;</span><span class="p">,</span><span class="n">norm</span><span class="p">(</span><span class="n">grad</span><span class="p">),</span><span class="s2">&quot; Ieration variation rate: &quot;</span><span class="p">,</span><span class="n">err</span><span class="p">,</span><span class="s2">&quot;%&quot;</span>
        <span class="n">i</span><span class="o">+=</span><span class="mi">1</span>


    <span class="nb">print</span> <span class="s2">&quot;Computing details manifold...&quot;</span>
    <span class="n">details</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">Y</span><span class="p">)</span><span class="o">*</span><span class="mi">0</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
            <span class="n">ind</span> <span class="o">=</span> <span class="n">k</span><span class="o">*</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="p">(</span><span class="n">k</span><span class="o">*</span><span class="p">(</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span><span class="o">/</span><span class="mi">2</span> <span class="o">+</span> <span class="n">l</span><span class="o">-</span><span class="n">k</span><span class="o">-</span><span class="mi">1</span>
            <span class="n">details</span><span class="p">[:,</span><span class="n">k</span><span class="p">]</span><span class="o">+=</span><span class="n">Z</span><span class="p">[:,</span><span class="n">ind</span><span class="p">]</span>
            <span class="n">details</span><span class="p">[:,</span><span class="n">l</span><span class="p">]</span><span class="o">-=</span><span class="n">Z</span><span class="p">[:,</span><span class="n">ind</span><span class="p">]</span>
    <span class="nb">print</span> <span class="s2">&quot;Done.&quot;</span>
    <span class="k">return</span> <span class="n">details</span><span class="p">,</span><span class="n">Z</span><span class="p">,</span><span class="n">details_mat</span>

<span class="k">def</span> <span class="nf">pair_wis_dist_grad_mat</span><span class="p">(</span><span class="nb">input</span><span class="p">,</span><span class="n">nb_samp</span><span class="o">=</span><span class="mi">100</span><span class="p">):</span>
    <span class="kn">from</span> <span class="nn">utils</span> <span class="k">import</span> <span class="n">rand_diff_integ</span>
    <span class="kn">from</span> <span class="nn">numpy</span> <span class="k">import</span> <span class="n">diag</span>
    <span class="n">cur_iter</span> <span class="o">=</span> <span class="nb">input</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">coeff</span> <span class="o">=</span> <span class="nb">input</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">supports</span> <span class="o">=</span> <span class="nb">input</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">nb_vect</span> <span class="o">=</span> <span class="n">cur_iter</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">nb_vect</span><span class="o">&gt;</span><span class="n">nb_samp</span><span class="p">:</span>
        <span class="n">ind</span> <span class="o">=</span> <span class="n">rand_diff_integ</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_vect</span><span class="p">,</span><span class="n">nb_samp</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">ind</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_vect</span><span class="p">)</span>
    <span class="n">dim</span> <span class="o">=</span> <span class="n">cur_iter</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">output</span> <span class="o">=</span> <span class="n">cur_iter</span><span class="o">*</span><span class="mi">0</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">ind</span><span class="p">)):</span>

        <span class="n">output</span><span class="p">[:,</span><span class="n">ind</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">=</span> <span class="p">(</span><span class="n">cur_iter</span><span class="p">[:,</span><span class="n">supports</span><span class="p">[</span><span class="n">ind</span><span class="p">[</span><span class="n">i</span><span class="p">]]]</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">coeff</span><span class="p">[</span><span class="n">ind</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">supports</span><span class="p">[</span><span class="n">ind</span><span class="p">[</span><span class="n">i</span><span class="p">]]),</span><span class="mi">1</span><span class="p">))))</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">dim</span><span class="p">,))</span>

    <span class="k">return</span> <span class="n">output</span>

<span class="k">def</span> <span class="nf">pair_wise_dist_dual_proximity_op</span><span class="p">(</span><span class="n">U</span><span class="p">,</span><span class="n">mu</span><span class="p">,</span><span class="n">ordered_dist</span><span class="p">,</span><span class="n">nb_samp</span><span class="o">=</span><span class="mi">100</span><span class="p">):</span>
    <span class="kn">from</span> <span class="nn">utils</span> <span class="k">import</span> <span class="n">rand_diff_integ</span>
    <span class="kn">from</span> <span class="nn">numpy</span> <span class="k">import</span> <span class="n">diag</span>
    <span class="kn">from</span> <span class="nn">numpy.linalg</span> <span class="k">import</span> <span class="n">norm</span>

    <span class="n">nb_vect</span> <span class="o">=</span> <span class="n">U</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">nb_vect</span><span class="o">&gt;</span><span class="n">nb_samp</span><span class="p">:</span>
        <span class="n">ind</span> <span class="o">=</span> <span class="n">rand_diff_integ</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_vect</span><span class="p">,</span><span class="n">nb_samp</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">ind</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_vect</span><span class="p">)</span>

    <span class="n">U</span><span class="p">[:,</span><span class="n">ind</span><span class="p">]</span> <span class="o">=</span> <span class="n">U</span><span class="p">[:,</span><span class="n">ind</span><span class="p">]</span> <span class="o">-</span> <span class="n">mu</span><span class="o">*</span><span class="n">U</span><span class="p">[:,</span><span class="n">ind</span><span class="p">]</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">diag</span><span class="p">(</span><span class="n">ordered_dist</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="n">norm</span><span class="p">(</span><span class="n">U</span><span class="p">[:,</span><span class="n">ind</span><span class="p">],</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)))</span>

    <span class="k">return</span> <span class="n">U</span>

<span class="k">def</span> <span class="nf">pair_wise_distances_constraint_lagrangian</span><span class="p">(</span><span class="n">Y</span><span class="p">,</span><span class="n">dist_ref</span><span class="p">,</span><span class="n">dist_target</span><span class="p">,</span><span class="n">beta</span><span class="o">=</span><span class="mi">3</span><span class="p">):</span>
    <span class="kn">from</span> <span class="nn">numpy</span> <span class="k">import</span> <span class="n">zeros</span><span class="p">,</span><span class="n">eye</span><span class="p">,</span><span class="n">diag</span><span class="p">,</span><span class="n">transpose</span>
    <span class="kn">from</span> <span class="nn">numpy.linalg</span> <span class="k">import</span> <span class="n">norm</span><span class="p">,</span><span class="n">pinv</span><span class="p">,</span><span class="n">eigh</span>


    <span class="n">shap</span> <span class="o">=</span> <span class="n">Y</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">M</span> <span class="o">=</span> <span class="n">eye</span><span class="p">(</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
            <span class="n">lambd</span> <span class="o">=</span> <span class="n">beta</span><span class="o">*</span><span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,(</span><span class="n">dist_ref</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span><span class="o">-</span><span class="n">dist_target</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">])</span><span class="o">/</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">dist_target</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]))</span>
            <span class="n">M</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">i</span><span class="p">]</span> <span class="o">+=</span> <span class="n">lambd</span><span class="o">/</span><span class="p">(</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">M</span><span class="p">[</span><span class="n">j</span><span class="p">,</span><span class="n">i</span><span class="p">]</span> <span class="o">-=</span> <span class="n">lambd</span><span class="o">/</span><span class="p">(</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">M</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">-=</span> <span class="n">lambd</span><span class="o">/</span><span class="p">(</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">M</span><span class="p">[</span><span class="n">j</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">+=</span> <span class="n">lambd</span><span class="o">/</span><span class="p">(</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>

    <span class="n">s</span><span class="p">,</span><span class="n">U</span> <span class="o">=</span> <span class="n">eigh</span><span class="p">(</span><span class="n">M</span><span class="p">)</span>
    <span class="n">ind</span> <span class="o">=</span> <span class="n">where</span><span class="p">(</span><span class="n">s</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">Yout</span> <span class="o">=</span> <span class="n">Y</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">U</span><span class="p">[:,</span><span class="n">ind</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">diag</span><span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="n">ind</span><span class="p">[</span><span class="mi">0</span><span class="p">]]))</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">transpose</span><span class="p">(</span><span class="n">U</span><span class="p">[:,</span><span class="n">ind</span><span class="p">[</span><span class="mi">0</span><span class="p">]])))</span>
    <span class="k">return</span> <span class="n">Yout</span><span class="p">,[</span><span class="n">s</span><span class="p">,</span><span class="n">U</span><span class="p">]</span>



<span class="k">def</span> <span class="nf">HLLEm</span><span class="p">(</span><span class="n">dist_mat_list</span><span class="p">,</span><span class="n">nb_neigh</span><span class="p">,</span><span class="n">nb_comp</span><span class="p">,</span><span class="n">tol</span><span class="o">=</span><span class="mf">0.999</span><span class="p">):</span>
    <span class="n">knn_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
    <span class="n">embedding_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">dist_mat_list</span><span class="p">)):</span>
        <span class="nb">print</span> <span class="s2">&quot;feature &quot;</span><span class="p">,</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="s2">&quot;/&quot;</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">dist_mat_list</span><span class="p">)</span>
        <span class="n">embed_i</span><span class="p">,</span><span class="n">knn_i</span> <span class="o">=</span> <span class="n">HLLE</span><span class="p">(</span><span class="n">dist_mat_list</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">nb_neigh</span><span class="p">,</span><span class="n">nb_comp</span><span class="p">,</span><span class="n">tol</span> <span class="o">=</span> <span class="n">tol</span><span class="p">)</span>
        <span class="n">embedding_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">embed_i</span><span class="p">)</span>
        <span class="n">knn_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">knn_i</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">embedding_list</span><span class="p">,</span><span class="n">knn_list</span>

<span class="k">def</span> <span class="nf">sliced_bar_gradient</span><span class="p">(</span><span class="n">basis</span><span class="p">,</span><span class="n">obs</span><span class="p">,</span><span class="n">iterate</span><span class="p">,</span><span class="n">weights</span><span class="p">,</span><span class="n">assign_out</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">single_dir</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="kn">from</span> <span class="nn">numpy</span> <span class="k">import</span> <span class="n">zeros</span><span class="p">,</span><span class="n">copy</span>
    <span class="n">shap</span> <span class="o">=</span> <span class="n">obs</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">shapb</span> <span class="o">=</span> <span class="n">basis</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">H</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">shapb</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">shapb</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shapb</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
        <span class="n">ui</span> <span class="o">=</span> <span class="n">basis</span><span class="p">[:,</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">shapb</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="mi">1</span><span class="p">))</span>
        <span class="n">H</span><span class="o">+=</span> <span class="n">ui</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">transpose</span><span class="p">(</span><span class="n">ui</span><span class="p">))</span>
    <span class="n">U</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">Vt</span> <span class="o">=</span> <span class="n">linalg</span><span class="o">.</span><span class="n">svd</span><span class="p">(</span><span class="n">H</span><span class="p">,</span><span class="n">full_matrices</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="n">coord_proj</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">(</span><span class="n">shap</span><span class="p">)</span>
    <span class="n">nb_obs</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">grad</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">sig_out</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">shap</span><span class="p">)</span><span class="o">==</span><span class="mi">2</span><span class="p">:</span>
        <span class="n">nb_obs</span> <span class="o">=</span> <span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
            <span class="n">temp_proj</span><span class="p">,</span><span class="n">err_proj</span><span class="p">,</span><span class="n">sig</span> <span class="o">=</span> <span class="n">coord_wise_proj</span><span class="p">(</span><span class="n">transpose</span><span class="p">(</span><span class="n">iterate</span><span class="p">),</span><span class="n">obs</span><span class="p">[:,</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">])),</span><span class="n">basis</span><span class="p">)</span>
            <span class="n">coord_proj</span><span class="p">[:,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">temp_proj</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">size</span><span class="p">(</span><span class="n">temp_proj</span><span class="p">),))</span>
        <span class="n">grad</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">vect</span><span class="p">(</span><span class="n">iterate</span><span class="p">)</span> <span class="o">-</span> <span class="n">coord_proj</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">utils</span><span class="o">.</span><span class="n">vect</span><span class="p">(</span><span class="n">weights</span><span class="p">))</span>
    <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">shap</span><span class="p">)</span><span class="o">==</span><span class="mi">3</span><span class="p">:</span>
        <span class="n">nb_obs</span> <span class="o">=</span> <span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
        <span class="n">sig_out</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">shapb</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
            <span class="n">temp_proj</span><span class="p">,</span><span class="n">err_proj</span><span class="p">,</span><span class="n">sig</span> <span class="o">=</span> <span class="n">coord_wise_proj</span><span class="p">(</span><span class="n">iterate</span><span class="p">,</span><span class="n">obs</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">],</span><span class="n">basis</span><span class="p">,</span><span class="n">single_dir</span><span class="o">=</span><span class="n">single_dir</span><span class="p">)</span>
            <span class="n">sig_out</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">sig</span><span class="p">)</span>
            <span class="n">coord_proj</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">temp_proj</span>
        <span class="c1">#grad = LA.inv(H).dot(iterate)</span>
        <span class="n">grad</span> <span class="o">=</span> <span class="n">H</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">copy</span><span class="p">(</span><span class="n">iterate</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_obs</span><span class="p">):</span>
            <span class="n">grad</span> <span class="o">-=</span> <span class="n">weights</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">*</span><span class="n">coord_proj</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Bad input data shape&quot;</span><span class="p">)</span>
    <span class="n">grad</span><span class="o">*=</span> <span class="n">s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">assign_out</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">grad</span><span class="p">,</span><span class="n">sig_out</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">grad</span>

<span class="k">def</span> <span class="nf">sliced_bar_gradient_compos</span><span class="p">(</span><span class="n">basis</span><span class="p">,</span><span class="n">obs</span><span class="p">,</span><span class="n">iterate</span><span class="p">,</span><span class="n">weights</span><span class="p">):</span>
    <span class="kn">from</span> <span class="nn">numpy</span> <span class="k">import</span> <span class="n">zeros</span>

    <span class="n">list_supp_trans</span><span class="p">,</span><span class="n">list_supp_euc</span> <span class="o">=</span> <span class="n">supports_setting</span><span class="p">(</span><span class="n">iterate</span><span class="p">,</span><span class="n">obs</span><span class="p">)</span>
    <span class="n">shap</span> <span class="o">=</span> <span class="n">obs</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">shapb</span> <span class="o">=</span> <span class="n">basis</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">H</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">shapb</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">shapb</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shapb</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
        <span class="n">ui</span> <span class="o">=</span> <span class="n">basis</span><span class="p">[:,</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">shapb</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="mi">1</span><span class="p">))</span>
        <span class="n">H</span><span class="o">+=</span> <span class="n">ui</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">transpose</span><span class="p">(</span><span class="n">ui</span><span class="p">))</span>
    <span class="n">U</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">Vt</span> <span class="o">=</span> <span class="n">linalg</span><span class="o">.</span><span class="n">svd</span><span class="p">(</span><span class="n">H</span><span class="p">,</span><span class="n">full_matrices</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="n">coord_proj</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">(</span><span class="n">shap</span><span class="p">)</span>
    <span class="n">nb_obs</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">grad</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">(</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">])</span>


    <span class="n">nb_obs</span> <span class="o">=</span> <span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
        <span class="n">temp_proj</span><span class="p">,</span><span class="n">err_proj</span><span class="p">,</span><span class="n">sig</span> <span class="o">=</span> <span class="n">coord_wise_proj</span><span class="p">(</span><span class="n">iterate</span><span class="p">[:,</span><span class="n">list_supp_trans</span><span class="p">[</span><span class="n">i</span><span class="p">]],</span><span class="n">obs</span><span class="p">[:,</span><span class="n">list_supp_trans</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">i</span><span class="p">],</span><span class="n">basis</span><span class="p">)</span>
        <span class="n">grad</span><span class="p">[:,</span><span class="n">list_supp_trans</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">+=</span> <span class="n">weights</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="n">H</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">iterate</span><span class="p">[:,</span><span class="n">list_supp_trans</span><span class="p">[</span><span class="n">i</span><span class="p">]])</span><span class="o">-</span><span class="n">temp_proj</span><span class="p">)</span>
        <span class="n">grad</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="n">list_supp_euc</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">+=</span> <span class="n">weights</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="n">iterate</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="n">list_supp_euc</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span><span class="o">-</span><span class="n">obs</span><span class="p">[:,</span><span class="n">list_supp_euc</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">i</span><span class="p">])</span>

    <span class="n">grad</span><span class="o">*=</span> <span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">grad</span>




<span class="k">def</span> <span class="nf">init_sliced</span><span class="p">(</span><span class="n">basis</span><span class="p">,</span><span class="n">obs</span><span class="p">,</span><span class="n">weights</span><span class="p">):</span>
    <span class="n">shap</span> <span class="o">=</span> <span class="n">obs</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">shapb</span> <span class="o">=</span> <span class="n">basis</span><span class="o">.</span><span class="n">shape</span>

    <span class="n">coord_sort</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">(</span><span class="n">shap</span><span class="p">)</span>
    <span class="n">nb_obs</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">init</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">shap</span><span class="p">)</span><span class="o">==</span><span class="mi">2</span><span class="p">:</span>
        <span class="n">nb_obs</span> <span class="o">=</span> <span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
            <span class="n">temp_sort</span> <span class="o">=</span> <span class="n">coord_wise_sort</span><span class="p">(</span><span class="n">obs</span><span class="p">[:,</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">])),</span><span class="n">basis</span><span class="p">)</span>
            <span class="n">coord_sort</span><span class="p">[:,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">temp_sort</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">size</span><span class="p">(</span><span class="n">temp_proj</span><span class="p">),))</span>
        <span class="n">init</span> <span class="o">=</span> <span class="n">coord_sort</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">utils</span><span class="o">.</span><span class="n">vect</span><span class="p">(</span><span class="n">weights</span><span class="p">))</span>
    <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">shap</span><span class="p">)</span><span class="o">==</span><span class="mi">3</span><span class="p">:</span>
        <span class="n">nb_obs</span> <span class="o">=</span> <span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
            <span class="n">temp_sort</span> <span class="o">=</span> <span class="n">coord_wise_sort</span><span class="p">(</span><span class="n">obs</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">],</span><span class="n">basis</span><span class="p">)</span>
            <span class="n">coord_sort</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">temp_sort</span>
        <span class="n">init</span> <span class="o">=</span> <span class="n">weights</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">coord_sort</span><span class="p">[:,:,</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">nb_obs</span><span class="p">):</span>
            <span class="n">init</span> <span class="o">+=</span> <span class="n">weights</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">*</span><span class="n">coord_sort</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Bad input data shape&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">init</span>



<span class="k">def</span> <span class="nf">sliced_transport_bar</span><span class="p">(</span><span class="n">F</span><span class="p">,</span><span class="n">weights</span><span class="p">,</span><span class="n">nb_iter</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span><span class="n">tol</span><span class="o">=</span><span class="mf">0.000000000000000001</span><span class="p">,</span><span class="n">alph</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span><span class="n">bar_init</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">samp</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span><span class="n">rand_en</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">basis</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">adapted_basis</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">pos_en</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">min_basis</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">support</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">assign_out</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">single_dir</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">nb_real</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
    <span class="n">shap</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">shape</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">shap</span><span class="p">)</span><span class="o">==</span><span class="mi">2</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">bar_init</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">bar_init</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">utils</span><span class="o">.</span><span class="n">vect</span><span class="p">(</span><span class="n">weights</span><span class="p">))</span>
        <span class="n">dim</span><span class="o">=</span><span class="mi">1</span>

    <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">shap</span><span class="p">)</span><span class="o">==</span><span class="mi">3</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">bar_init</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">bar_init</span> <span class="o">=</span> <span class="n">weights</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">F</span><span class="p">[:,:,</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">F</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
                <span class="n">bar_init</span><span class="o">+=</span><span class="n">weights</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">*</span><span class="n">F</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">]</span>
        <span class="n">dim</span> <span class="o">=</span> <span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Bad input data shape&quot;</span><span class="p">)</span>

    <span class="n">bar</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">bar_init</span><span class="p">)</span>
    <span class="n">err</span> <span class="o">=</span> <span class="mi">100</span>
    <span class="n">i</span> <span class="o">=</span> <span class="mf">1.0</span>
    <span class="c1">#basis = None</span>
    <span class="n">grad</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">sig_out</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">while</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">nb_iter</span> <span class="ow">and</span> <span class="n">err</span><span class="o">&gt;</span><span class="n">tol</span><span class="p">:</span>

        <span class="n">step</span> <span class="o">=</span> <span class="mf">1.0</span><span class="o">/</span><span class="n">i</span><span class="o">**</span><span class="n">alph</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        if dim==3:</span>
<span class="sd">            basis = zeros((3,3))</span>
<span class="sd">            basis[0,0] = sign(random.randn(1))</span>
<span class="sd">            basis[1:,1:] = utils.random_orth_basis(dim-1)&quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">rand_en</span><span class="p">:</span>

            <span class="n">basis</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">random_orth_basis_cat</span><span class="p">(</span><span class="n">dim</span><span class="p">,</span><span class="n">nb_real</span><span class="o">=</span><span class="n">nb_real</span><span class="p">)</span>



        <span class="sd">&quot;&quot;&quot;elif adapted_basis and len(shap)==3 and i==0:</span>
<span class="sd">            if basis is None:</span>
<span class="sd">                basis = utils.adapted_positive_basis(F)</span>
<span class="sd">            if min_basis:</span>
<span class="sd">                basis = basis[:,0:2]</span>
<span class="sd">            #mat = utils.gram_schmidt(eye(3)+ np.random.randn(3,3)/(i+1)**2)</span>
<span class="sd">            #basis = mat.dot(basis)</span>

<span class="sd">        elif len(shap)==3 and i==0:</span>
<span class="sd">            basis = utils.sphere_vect(samp)</span>
<span class="sd">        elif i==0:</span>
<span class="sd">            basis = ones((1,1))&quot;&quot;&quot;</span>

        <span class="n">bar_old</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">bar</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">support</span><span class="p">:</span>
            <span class="n">grad</span> <span class="o">=</span> <span class="n">sliced_bar_gradient_compos</span><span class="p">(</span><span class="n">basis</span><span class="p">,</span><span class="n">F</span><span class="p">,</span><span class="n">bar</span><span class="p">,</span><span class="n">weights</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">grad</span><span class="p">,</span><span class="n">sig_out</span> <span class="o">=</span> <span class="n">sliced_bar_gradient</span><span class="p">(</span><span class="n">basis</span><span class="p">,</span><span class="n">F</span><span class="p">,</span><span class="n">bar</span><span class="p">,</span><span class="n">weights</span><span class="p">,</span><span class="n">assign_out</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">single_dir</span><span class="o">=</span><span class="n">single_dir</span><span class="p">)</span>

        <span class="n">bar</span> <span class="o">=</span> <span class="n">bar</span> <span class="o">-</span> <span class="n">step</span><span class="o">*</span><span class="n">grad</span>
        <span class="k">if</span> <span class="n">pos_en</span><span class="p">:</span>
            <span class="n">bar</span> <span class="o">=</span> <span class="n">pos_proj_mat</span><span class="p">(</span><span class="n">bar</span><span class="p">)</span>
        <span class="n">i</span><span class="o">+=</span><span class="mi">1</span>
        <span class="n">err</span> <span class="o">=</span> <span class="mi">100</span><span class="o">*</span><span class="nb">sum</span><span class="p">((</span><span class="n">bar</span><span class="o">-</span><span class="n">bar_old</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="nb">sum</span><span class="p">(</span><span class="n">bar</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
        <span class="nb">print</span> <span class="s2">&quot;Relative change of the iterate: &quot;</span><span class="p">,</span><span class="n">err</span><span class="p">,</span><span class="s2">&quot;%.&quot;</span><span class="p">,</span><span class="s2">&quot; Gradient&#39;s norm: &quot;</span><span class="p">,</span><span class="n">sqrt</span><span class="p">(</span><span class="nb">sum</span><span class="p">((</span><span class="n">step</span><span class="o">*</span><span class="n">grad</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span>

    <span class="c1">#print &quot;Adapted basis: &quot;,basis</span>
    <span class="n">disc_vect</span> <span class="o">=</span> <span class="n">bar_discrepancies_analysis</span><span class="p">(</span><span class="n">sig_out</span><span class="p">)</span>
    <span class="nb">print</span> <span class="s2">&quot;Discrepancy vector: &quot;</span><span class="p">,</span><span class="n">disc_vect</span>
    <span class="k">if</span> <span class="n">assign_out</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">bar</span><span class="p">,</span><span class="n">basis</span><span class="p">,</span><span class="n">sig_out</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">bar</span><span class="p">,</span><span class="n">basis</span>



<span class="k">def</span> <span class="nf">sliced_transport_bar_support_2d</span><span class="p">(</span><span class="n">F</span><span class="p">,</span><span class="n">weights</span><span class="p">,</span><span class="n">approx_en</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">nb_iter</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span><span class="n">tol</span><span class="o">=</span><span class="mf">0.000000000000000001</span><span class="p">,</span><span class="n">alph</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span><span class="n">bar_init</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">samp</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span><span class="n">rand_en</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">basis</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">adapted_basis</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">pos_en</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">min_basis</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="kn">from</span> <span class="nn">numpy</span> <span class="k">import</span> <span class="n">copy</span><span class="p">,</span><span class="n">zeros</span><span class="p">,</span><span class="n">argsort</span>


    <span class="n">shap</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">shape</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">shap</span><span class="p">)</span><span class="o">==</span><span class="mi">2</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">bar_init</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">bar_init</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">utils</span><span class="o">.</span><span class="n">vect</span><span class="p">(</span><span class="n">weights</span><span class="p">))</span>
        <span class="n">dim</span><span class="o">=</span><span class="mi">1</span>

    <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">shap</span><span class="p">)</span><span class="o">==</span><span class="mi">3</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">bar_init</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">bar_init</span> <span class="o">=</span> <span class="n">weights</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">F</span><span class="p">[:,:,</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">F</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
                <span class="n">bar_init</span><span class="o">+=</span><span class="n">weights</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">*</span><span class="n">F</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">]</span>
        <span class="n">dim</span> <span class="o">=</span> <span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Bad input data shape&quot;</span><span class="p">)</span>

    <span class="c1"># ------ Support size ------ #</span>
    <span class="n">Fc</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">F</span><span class="p">)</span>
    <span class="n">I</span> <span class="o">=</span> <span class="p">(</span><span class="n">F</span><span class="p">[</span><span class="mi">2</span><span class="p">,:,:])</span><span class="o">.</span><span class="n">prod</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">ind_supp</span> <span class="o">=</span> <span class="n">where</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">I</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">Fc</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="n">ind_supp</span><span class="p">[</span><span class="mi">0</span><span class="p">],:]</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">bar_init</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="n">ind_supp</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">Fapprox</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">approx_en</span><span class="p">:</span>
        <span class="n">min_supp</span> <span class="o">=</span> <span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
            <span class="n">ind</span> <span class="o">=</span> <span class="n">where</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">Fc</span><span class="p">[</span><span class="mi">2</span><span class="p">,:,</span><span class="n">i</span><span class="p">])</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">)</span>

            <span class="n">supp_size_i</span> <span class="o">=</span> <span class="n">size</span><span class="p">(</span><span class="n">ind</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">supp_size_i</span> <span class="o">&lt;</span><span class="n">min_supp</span><span class="p">:</span>
                <span class="n">min_supp</span> <span class="o">=</span> <span class="n">supp_size_i</span>
        <span class="n">Fapprox</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">min_supp</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
            <span class="n">ind_sort</span> <span class="o">=</span> <span class="n">argsort</span><span class="p">(</span><span class="n">Fc</span><span class="p">[</span><span class="mi">2</span><span class="p">,:,</span><span class="n">i</span><span class="p">])</span>
            <span class="n">Fapprox</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">Fc</span><span class="p">[:,</span><span class="n">ind_sort</span><span class="p">[</span><span class="o">-</span><span class="n">min_supp</span><span class="p">:],</span><span class="n">i</span><span class="p">]</span>
        <span class="n">ind_sort</span> <span class="o">=</span> <span class="n">argsort</span><span class="p">(</span><span class="n">bar_init</span><span class="p">[</span><span class="mi">2</span><span class="p">,:])</span>
        <span class="n">bar_init</span> <span class="o">=</span> <span class="n">bar_init</span><span class="p">[:,</span><span class="n">ind_sort</span><span class="p">[</span><span class="o">-</span><span class="n">min_supp</span><span class="p">:]]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">Fapprox</span> <span class="o">=</span> <span class="n">Fc</span>

    <span class="n">bar</span><span class="p">,</span><span class="n">basis</span> <span class="o">=</span> <span class="n">sliced_transport_bar</span><span class="p">(</span><span class="n">Fapprox</span><span class="p">,</span><span class="n">weights</span><span class="p">,</span><span class="n">nb_iter</span><span class="o">=</span><span class="n">nb_iter</span><span class="p">,</span><span class="n">tol</span><span class="o">=</span><span class="n">tol</span><span class="p">,</span><span class="n">alph</span><span class="o">=</span><span class="n">alph</span><span class="p">,</span><span class="n">bar_init</span><span class="o">=</span><span class="n">bar_init</span><span class="p">,</span><span class="n">dim</span><span class="o">=</span><span class="n">dim</span><span class="p">,</span><span class="n">samp</span><span class="o">=</span><span class="n">samp</span><span class="p">,</span><span class="n">rand_en</span><span class="o">=</span><span class="n">rand_en</span><span class="p">,</span><span class="n">basis</span><span class="o">=</span><span class="n">basis</span><span class="p">,</span><span class="n">adapted_basis</span><span class="o">=</span><span class="n">adapted_basis</span><span class="p">,</span><span class="n">pos_en</span><span class="o">=</span><span class="n">pos_en</span><span class="p">,</span><span class="n">min_basis</span><span class="o">=</span><span class="n">min_basis</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">bar</span><span class="p">,</span><span class="n">basis</span><span class="p">,</span><span class="n">Fapprox</span>


<span class="k">def</span> <span class="nf">supports_setting</span><span class="p">(</span><span class="n">iterate</span><span class="p">,</span><span class="n">F</span><span class="p">,</span><span class="n">acc</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>

    <span class="n">shap</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">I</span> <span class="o">=</span> <span class="p">(</span><span class="n">F</span><span class="p">[</span><span class="mi">2</span><span class="p">,:,:])</span><span class="o">.</span><span class="n">prod</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">ind_supp</span> <span class="o">=</span> <span class="n">where</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">I</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">list_trans_supp</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
    <span class="n">list_eucl_supp</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
        <span class="n">I</span> <span class="o">=</span> <span class="n">F</span><span class="p">[</span><span class="mi">2</span><span class="p">,:,</span><span class="n">i</span><span class="p">]</span><span class="o">*</span><span class="n">iterate</span><span class="p">[</span><span class="mi">2</span><span class="p">,:]</span>
        <span class="k">if</span> <span class="n">acc</span><span class="p">:</span>
            <span class="n">list_trans_supp</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">where</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">I</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span><span class="p">))[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ind1</span> <span class="o">=</span> <span class="p">(</span><span class="n">where</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">I</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">ind2</span> <span class="o">=</span> <span class="p">(</span><span class="n">where</span><span class="p">(</span><span class="n">F</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="n">ind1</span><span class="p">,</span><span class="n">i</span><span class="p">]))[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">list_trans_supp</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ind1</span><span class="p">[</span><span class="n">ind2</span><span class="p">])</span>
        <span class="n">list_eucl_supp</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">where</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">I</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">))[</span><span class="mi">0</span><span class="p">])</span>


    <span class="k">return</span> <span class="n">list_supp_trans</span><span class="p">,</span><span class="n">list_supp_euc</span>
<span class="sd">&quot;&quot;&quot;def sliced_transport_bar_support_2d_acc(F,weights,approx_en=True,nb_iter=1000,tol=0.000000000000000001,alph=0.01,bar_init=None,dim=1,samp=3,rand_en=False,basis=None,adapted_basis=True,pos_en=False,min_basis=False):</span>


<span class="sd">    &quot;&quot;&quot;</span>




<span class="k">def</span> <span class="nf">robust_sliced_transport_bar</span><span class="p">(</span><span class="n">F</span><span class="p">,</span><span class="n">weights</span><span class="p">,</span><span class="n">template</span><span class="p">,</span><span class="n">ref</span><span class="p">,</span><span class="n">nb_iter</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span><span class="n">tol</span><span class="o">=</span><span class="mf">0.0000001</span><span class="p">,</span><span class="n">alph</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span><span class="n">bar_init</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">samp</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span><span class="n">rand_en</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">adapted_basis</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="n">shap</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">shape</span>
    <span class="k">if</span> <span class="n">bar_init</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">shap</span><span class="p">)</span><span class="o">==</span><span class="mi">2</span><span class="p">:</span>
            <span class="n">bar_init</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">utils</span><span class="o">.</span><span class="n">vect</span><span class="p">(</span><span class="n">weights</span><span class="p">))</span>
            <span class="n">dim</span><span class="o">=</span><span class="mi">1</span>

        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">shap</span><span class="p">)</span><span class="o">==</span><span class="mi">3</span><span class="p">:</span>
            <span class="n">bar_init</span> <span class="o">=</span> <span class="n">weights</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">F</span><span class="p">[:,:,</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">dim</span> <span class="o">=</span> <span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">F</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
                <span class="n">bar_init</span><span class="o">+=</span><span class="n">weights</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">*</span><span class="n">F</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Bad input data shape&quot;</span><span class="p">)</span>

    <span class="n">bar</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">bar_init</span><span class="p">)</span>
    <span class="n">err</span> <span class="o">=</span> <span class="mi">100</span>
    <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">basis</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">while</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">nb_iter</span> <span class="ow">and</span> <span class="n">err</span><span class="o">&gt;</span><span class="n">tol</span><span class="p">:</span>

        <span class="n">step</span> <span class="o">=</span> <span class="mf">1.0</span><span class="c1">#/i**alph</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            if dim==3:</span>
<span class="sd">            basis = zeros((3,3))</span>
<span class="sd">            basis[0,0] = sign(random.randn(1))</span>
<span class="sd">            basis[1:,1:] = utils.random_orth_basis(dim-1)&quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">rand_en</span><span class="p">:</span>
            <span class="n">basis</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">random_orth_basis</span><span class="p">(</span><span class="n">dim</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">adapted_basis</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">shap</span><span class="p">)</span><span class="o">==</span><span class="mi">3</span> <span class="ow">and</span> <span class="n">i</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
            <span class="n">basis</span><span class="p">,</span><span class="n">s</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">adapted_positive_basis</span><span class="p">(</span><span class="n">F</span><span class="p">)</span>
        <span class="c1">#mat = utils.gram_schmidt(eye(3)+ np.random.randn(3,3)/(i+1)**2)</span>
        <span class="c1">#basis = mat.dot(basis)</span>

        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">shap</span><span class="p">)</span><span class="o">==</span><span class="mi">3</span> <span class="ow">and</span> <span class="n">i</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
            <span class="n">basis</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">sphere_vect</span><span class="p">(</span><span class="n">samp</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">i</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
            <span class="n">basis</span> <span class="o">=</span> <span class="n">ones</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>

        <span class="n">bar_old</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">bar</span><span class="p">)</span>
        <span class="n">grad</span> <span class="o">=</span> <span class="n">sliced_bar_gradient</span><span class="p">(</span><span class="n">basis</span><span class="p">,</span><span class="n">F</span><span class="p">,</span><span class="n">bar</span><span class="p">,</span><span class="n">weights</span><span class="p">)</span>
        <span class="n">bar</span> <span class="o">=</span> <span class="n">bar</span> <span class="o">-</span> <span class="n">step</span><span class="o">*</span><span class="n">grad</span>
        <span class="n">opt_ind</span><span class="p">,</span><span class="n">bar</span><span class="p">[</span><span class="mi">0</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">optimal_assignement_1d</span><span class="p">(</span><span class="n">bar</span><span class="p">[</span><span class="mi">0</span><span class="p">,:]</span><span class="o">+</span><span class="n">ref</span><span class="p">,</span><span class="n">template</span><span class="p">)</span><span class="o">-</span><span class="n">ref</span>
        <span class="n">err</span> <span class="o">=</span> <span class="mi">100</span><span class="o">*</span><span class="nb">sum</span><span class="p">((</span><span class="n">bar</span><span class="o">-</span><span class="n">bar_old</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="nb">sum</span><span class="p">(</span><span class="n">bar</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
        <span class="nb">print</span> <span class="s2">&quot;Relative change of the iterate: &quot;</span><span class="p">,</span><span class="n">err</span><span class="p">,</span><span class="s2">&quot;%.&quot;</span><span class="p">,</span><span class="s2">&quot; Gradient&#39;s norm: &quot;</span><span class="p">,</span><span class="n">sqrt</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="n">grad</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span>
        <span class="n">i</span><span class="o">+=</span><span class="mi">1</span>
    <span class="nb">print</span> <span class="s2">&quot;Max val: &quot;</span><span class="p">,</span><span class="n">bar</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">bar</span><span class="p">,</span><span class="n">basis</span>


<span class="k">def</span> <span class="nf">l1_mean</span><span class="p">(</span><span class="n">distribs</span><span class="p">,</span><span class="n">weights</span><span class="p">,</span><span class="n">nb_iter</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span><span class="n">tol</span><span class="o">=</span><span class="mf">0.001</span><span class="p">):</span>
    <span class="n">optim_var1</span> <span class="o">=</span> <span class="n">distribs</span><span class="o">*</span><span class="mi">0</span>
    <span class="n">optim_var2</span> <span class="o">=</span> <span class="n">optim_var1</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">thresh</span> <span class="o">=</span> <span class="n">ones</span><span class="p">(</span><span class="n">distribs</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
    <span class="n">thresh</span> <span class="o">=</span> <span class="n">thresh</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">diag</span><span class="p">(</span><span class="n">weights</span><span class="p">))</span>
    <span class="n">ones_vect</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span><span class="n">distribs</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
    <span class="n">lambd</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">cost_old</span><span class="o">=</span><span class="mf">0.001</span>
    <span class="n">cost</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">distribs</span> <span class="o">-</span> <span class="n">utils</span><span class="o">.</span><span class="n">vect</span><span class="p">(</span><span class="n">optim_var2</span><span class="p">)</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">transpose</span><span class="p">(</span><span class="n">utils</span><span class="o">.</span><span class="n">vect</span><span class="p">(</span><span class="n">weights</span><span class="p">)))))</span>
    <span class="n">gamma</span> <span class="o">=</span> <span class="n">mean</span><span class="p">(</span><span class="n">distribs</span><span class="p">)</span>
    <span class="n">i</span><span class="o">=</span><span class="mi">0</span>
    <span class="k">while</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">nb_iter</span><span class="p">:</span><span class="c1"># and 100*abs(cost_old-cost)/cost_old&gt;tol:</span>
        <span class="n">optim_var2</span> <span class="o">=</span> <span class="n">optim_var1</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">temp1</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">vect</span><span class="p">(</span><span class="n">optim_var2</span><span class="p">)</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">ones_vect</span><span class="p">)</span>
        <span class="n">temp2</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">temp1</span> <span class="o">-</span> <span class="n">optim_var1</span>
        <span class="n">optim_var1</span> <span class="o">+=</span> <span class="n">lambd</span><span class="o">*</span><span class="p">(</span><span class="n">distribs</span> <span class="o">-</span> <span class="n">temp1</span> <span class="o">+</span> <span class="n">utils</span><span class="o">.</span><span class="n">thresholding</span><span class="p">(</span><span class="n">temp2</span> <span class="o">-</span> <span class="n">distribs</span><span class="p">,</span><span class="n">gamma</span><span class="o">*</span><span class="n">thresh</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>
        <span class="n">cost_old</span> <span class="o">=</span> <span class="n">cost</span>
        <span class="n">cost</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">distribs</span> <span class="o">-</span> <span class="n">utils</span><span class="o">.</span><span class="n">vect</span><span class="p">(</span><span class="n">optim_var2</span><span class="p">)</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">transpose</span><span class="p">(</span><span class="n">utils</span><span class="o">.</span><span class="n">vect</span><span class="p">(</span><span class="n">weights</span><span class="p">)))))</span>
        <span class="nb">print</span> <span class="n">cost</span>
        <span class="n">i</span><span class="o">+=</span><span class="mi">1</span>
    <span class="n">optim_var2</span> <span class="o">=</span> <span class="n">optim_var1</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">optim_var2</span>

<span class="k">def</span> <span class="nf">optimal_assignement_1d</span><span class="p">(</span><span class="n">f</span><span class="p">,</span><span class="n">g</span><span class="p">,</span><span class="n">indg</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="kn">from</span> <span class="nn">numpy</span> <span class="k">import</span> <span class="n">argsort</span>
    <span class="n">indf</span> <span class="o">=</span> <span class="n">argsort</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">indg</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">indg</span> <span class="o">=</span> <span class="n">argsort</span><span class="p">(</span><span class="n">g</span><span class="p">)</span>
    <span class="n">indf_inv</span> <span class="o">=</span> <span class="n">argsort</span><span class="p">(</span><span class="n">indf</span><span class="p">)</span>
    <span class="n">opt_ind</span> <span class="o">=</span> <span class="n">indg</span><span class="p">[</span><span class="n">indf_inv</span><span class="p">]</span>
    <span class="n">projf</span> <span class="o">=</span> <span class="n">g</span><span class="p">[</span><span class="n">opt_ind</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">opt_ind</span><span class="p">,</span><span class="n">projf</span>

<span class="k">def</span> <span class="nf">optimal_assignement_im</span><span class="p">(</span><span class="n">im1</span><span class="p">,</span><span class="n">im2</span><span class="p">):</span>
    <span class="n">f</span> <span class="o">=</span> <span class="n">im1</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">size</span><span class="p">(</span><span class="n">im1</span><span class="p">),))</span>
    <span class="n">g</span> <span class="o">=</span> <span class="n">im2</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">size</span><span class="p">(</span><span class="n">im1</span><span class="p">),))</span>
    <span class="n">opt_ind</span><span class="p">,</span><span class="n">projf</span> <span class="o">=</span> <span class="n">optimal_assignement_1d</span><span class="p">(</span><span class="n">f</span><span class="p">,</span><span class="n">g</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">projf</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">im1</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">coord_wise_proj</span><span class="p">(</span><span class="n">f</span><span class="p">,</span><span class="n">g</span><span class="p">,</span><span class="n">basis</span><span class="p">,</span><span class="n">single_dir</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="kn">from</span> <span class="nn">numpy</span> <span class="k">import</span> <span class="n">zeros</span><span class="p">,</span><span class="n">argsort</span><span class="p">,</span><span class="n">copy</span>
    <span class="kn">from</span> <span class="nn">numpy.linalg</span> <span class="k">import</span> <span class="n">norm</span>
    <span class="n">pf</span> <span class="o">=</span> <span class="n">transpose</span><span class="p">(</span><span class="n">basis</span><span class="p">)</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
    <span class="n">pg</span> <span class="o">=</span> <span class="n">transpose</span><span class="p">(</span><span class="n">basis</span><span class="p">)</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">g</span><span class="p">)</span>
    <span class="n">indg</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">ind</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">single_dir</span><span class="p">:</span>
        <span class="n">norm_proj</span> <span class="o">=</span> <span class="n">norm</span><span class="p">(</span><span class="n">pg</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">ind</span> <span class="o">=</span> <span class="n">where</span><span class="p">(</span><span class="n">norm_proj</span><span class="o">==</span><span class="n">norm_proj</span><span class="o">.</span><span class="n">max</span><span class="p">())</span>
        <span class="n">ind</span> <span class="o">=</span> <span class="n">ind</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">indg</span> <span class="o">=</span> <span class="n">argsort</span><span class="p">(</span><span class="n">pg</span><span class="p">[</span><span class="n">ind</span><span class="p">,:])</span>
    <span class="n">eqf</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">pf</span><span class="p">)</span>
    <span class="n">sig_out</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">basis</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">f</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>

    <span class="k">if</span> <span class="n">single_dir</span><span class="p">:</span>
        <span class="n">sig_out</span><span class="p">[</span><span class="n">ind</span><span class="p">,:],</span><span class="n">eqf</span><span class="p">[</span><span class="n">ind</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">optimal_assignement_1d</span><span class="p">(</span><span class="n">pf</span><span class="p">[</span><span class="n">ind</span><span class="p">,:],</span><span class="n">pg</span><span class="p">[</span><span class="n">ind</span><span class="p">,:],</span><span class="n">indg</span><span class="o">=</span><span class="n">indg</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">basis</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
            <span class="n">sig_out</span><span class="p">[</span><span class="n">i</span><span class="p">,:],</span><span class="n">eqf</span><span class="p">[</span><span class="n">i</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">optimal_assignement_1d</span><span class="p">(</span><span class="n">pf</span><span class="p">[</span><span class="n">i</span><span class="p">,:],</span><span class="n">pg</span><span class="p">[</span><span class="n">i</span><span class="p">,:],</span><span class="n">indg</span><span class="o">=</span><span class="n">indg</span><span class="p">)</span>
            <span class="c1">#print &quot;assignement &quot;,i,&quot; &quot;,sig</span>

    <span class="n">projf</span> <span class="o">=</span> <span class="n">basis</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">eqf</span><span class="p">)</span>
    <span class="n">err</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">((</span><span class="n">projf</span><span class="o">-</span><span class="n">f</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">projf</span><span class="p">,</span><span class="n">err</span><span class="p">,</span><span class="n">sig_out</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">coord_wise_proj_bas</span><span class="p">(</span><span class="n">f</span><span class="p">,</span><span class="n">g</span><span class="p">,</span><span class="n">basis</span><span class="p">):</span>
    <span class="kn">from</span> <span class="nn">numpy</span> <span class="k">import</span> <span class="n">zeros</span><span class="p">,</span><span class="n">copy</span><span class="p">,</span><span class="n">transpose</span>
    <span class="kn">from</span> <span class="nn">numpy.linalg</span> <span class="k">import</span> <span class="n">norm</span>

    <span class="n">pf</span> <span class="o">=</span> <span class="n">transpose</span><span class="p">(</span><span class="n">basis</span><span class="p">)</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
    <span class="n">pg</span> <span class="o">=</span> <span class="n">transpose</span><span class="p">(</span><span class="n">basis</span><span class="p">)</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">g</span><span class="p">)</span>

    <span class="n">eqf</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">pf</span><span class="p">)</span>
    <span class="n">sig_out</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">basis</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">f</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">basis</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
        <span class="n">sig_out</span><span class="p">[</span><span class="n">i</span><span class="p">,:],</span><span class="n">eqf</span><span class="p">[</span><span class="n">i</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">optimal_assignement_1d</span><span class="p">(</span><span class="n">pf</span><span class="p">[</span><span class="n">i</span><span class="p">,:],</span><span class="n">pg</span><span class="p">[</span><span class="n">i</span><span class="p">,:],</span><span class="n">indg</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">pf</span><span class="p">,</span><span class="n">eqf</span><span class="p">,</span><span class="n">sig_out</span>



<span class="k">def</span> <span class="nf">sliced_transport_gradient</span><span class="p">(</span><span class="n">f</span><span class="p">,</span><span class="n">g</span><span class="p">,</span><span class="n">nb_real</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">basis</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="kn">from</span> <span class="nn">numpy</span> <span class="k">import</span> <span class="n">copy</span>
    <span class="n">dim</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">basis</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">basis</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">random_orth_basis_cat</span><span class="p">(</span><span class="n">dim</span><span class="p">,</span><span class="n">nb_real</span><span class="o">=</span><span class="n">nb_real</span><span class="p">)</span>
    <span class="n">projf</span><span class="p">,</span><span class="n">err</span><span class="p">,</span><span class="n">sig_out</span> <span class="o">=</span> <span class="n">coord_wise_proj</span><span class="p">(</span><span class="n">f</span><span class="p">,</span><span class="n">g</span><span class="p">,</span><span class="n">basis</span><span class="p">,</span><span class="n">single_dir</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="n">grad_out</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">f</span><span class="p">)</span> <span class="o">-</span> <span class="n">projf</span><span class="o">/</span><span class="n">nb_real</span>

    <span class="k">return</span> <span class="n">grad_out</span><span class="p">,</span><span class="n">basis</span>


<span class="k">def</span> <span class="nf">size_tangent_proj</span><span class="p">(</span><span class="n">f</span><span class="p">,</span><span class="n">grad</span><span class="p">,</span><span class="n">cent</span><span class="p">,</span><span class="n">gap</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">cloud_siz</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="kn">from</span> <span class="nn">numpy.linalg</span> <span class="k">import</span> <span class="n">norm</span>
    <span class="kn">from</span> <span class="nn">numpy</span> <span class="k">import</span> <span class="n">copy</span>

    <span class="n">nb_points</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">cent_mat</span> <span class="o">=</span> <span class="n">cent</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">ones</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span><span class="n">nb_points</span><span class="p">)))</span>
    <span class="n">cent_sq_dist</span> <span class="o">=</span> <span class="n">norm</span><span class="p">(</span><span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">]</span><span class="o">/</span><span class="n">gap</span> <span class="o">-</span> <span class="n">cent_mat</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span>

    <span class="k">if</span> <span class="n">cloud_siz</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">cloud_siz</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_points</span><span class="p">):</span>
            <span class="n">cloud_siz</span><span class="o">+=</span><span class="n">f</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="n">i</span><span class="p">]</span><span class="o">*</span><span class="n">cent_sq_dist</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

    <span class="n">grad_proj</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">grad</span><span class="p">)</span>
    <span class="n">grad_proj</span><span class="p">[</span><span class="mi">2</span><span class="p">,:]</span> <span class="o">-=</span> <span class="p">((</span><span class="nb">sum</span><span class="p">(</span><span class="n">cent_sq_dist</span><span class="o">*</span><span class="n">grad</span><span class="p">[</span><span class="mi">2</span><span class="p">,:])</span><span class="o">-</span><span class="n">cloud_siz</span><span class="p">)</span><span class="o">/</span><span class="n">norm</span><span class="p">(</span><span class="n">cent_sq_dist</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">cent_sq_dist</span>

    <span class="n">pos_normal_vect</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">]</span><span class="o">/</span><span class="n">gap</span> <span class="o">-</span> <span class="n">cent_mat</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_points</span><span class="p">):</span>
        <span class="n">pos_normal_vect</span><span class="p">[:,</span><span class="n">i</span><span class="p">]</span><span class="o">*=</span><span class="n">f</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="n">i</span><span class="p">]</span>

    <span class="n">grad_proj</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">,:]</span> <span class="o">-=</span> <span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="n">grad</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">,:]</span><span class="o">*</span><span class="n">pos_normal_vect</span><span class="p">)</span><span class="o">/</span><span class="n">norm</span><span class="p">(</span><span class="n">pos_normal_vect</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">pos_normal_vect</span>

    <span class="k">return</span> <span class="n">grad_proj</span>

<span class="k">def</span> <span class="nf">exact_transport_line_search</span><span class="p">(</span><span class="n">f</span><span class="p">,</span><span class="n">g</span><span class="p">,</span><span class="n">basis</span><span class="p">,</span><span class="n">ascent_vect</span><span class="p">):</span>

    <span class="kn">from</span> <span class="nn">numpy</span> <span class="k">import</span> <span class="n">transpose</span>
    <span class="kn">from</span> <span class="nn">numpy.linalg</span> <span class="k">import</span> <span class="n">norm</span>
    <span class="n">nb_points</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">pf</span><span class="p">,</span><span class="n">eqf</span><span class="p">,</span><span class="n">sig_out</span> <span class="o">=</span> <span class="n">coord_wise_proj_bas</span><span class="p">(</span><span class="n">f</span><span class="p">,</span><span class="n">g</span><span class="p">,</span><span class="n">basis</span><span class="p">)</span>
    <span class="n">proj_ascent</span> <span class="o">=</span> <span class="n">transpose</span><span class="p">(</span><span class="n">basis</span><span class="p">)</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">ascent_vect</span><span class="p">)</span>
    <span class="n">step</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">((</span><span class="n">pf</span><span class="o">-</span><span class="n">eqf</span><span class="p">)</span><span class="o">*</span><span class="n">proj_ascent</span><span class="p">)</span><span class="o">/</span><span class="n">norm</span><span class="p">(</span><span class="n">proj_ascent</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span>

    <span class="k">return</span> <span class="n">step</span>

<span class="k">def</span> <span class="nf">sliced_transport_siz</span><span class="p">(</span><span class="n">f</span><span class="p">,</span><span class="n">g</span><span class="p">,</span><span class="n">cent</span><span class="p">,</span><span class="n">cloud_siz</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">nb_iter</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span><span class="n">tol</span><span class="o">=</span><span class="mf">1.e-10</span><span class="p">,</span><span class="n">nb_real</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span><span class="n">gap</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">rand_en</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>

    <span class="kn">from</span> <span class="nn">numpy</span> <span class="k">import</span> <span class="n">copy</span>
    <span class="kn">from</span> <span class="nn">numpy.linalg</span> <span class="k">import</span> <span class="n">norm</span>
    <span class="n">shapf</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">var</span> <span class="o">=</span> <span class="mi">100</span>
    <span class="n">pf</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
    <span class="n">basis</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">sliced_grad</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">displacement</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">shapf</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">shapf</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">nb_iter</span><span class="o">+</span><span class="mi">2</span><span class="p">))</span>
    <span class="n">displacement</span><span class="p">[:,:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>

    <span class="k">while</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">nb_iter</span> <span class="ow">and</span> <span class="n">var</span><span class="o">&gt;</span><span class="n">tol</span> <span class="p">:</span>
        <span class="k">if</span> <span class="n">rand_en</span><span class="p">:</span>
            <span class="n">sliced_grad</span><span class="p">,</span><span class="n">basis</span> <span class="o">=</span> <span class="n">sliced_transport_gradient</span><span class="p">(</span><span class="n">pf</span><span class="p">,</span><span class="n">g</span><span class="p">,</span><span class="n">nb_real</span><span class="o">=</span><span class="n">nb_real</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">sliced_grad</span><span class="p">,</span><span class="n">basis</span> <span class="o">=</span> <span class="n">sliced_transport_gradient</span><span class="p">(</span><span class="n">pf</span><span class="p">,</span><span class="n">g</span><span class="p">,</span><span class="n">nb_real</span><span class="o">=</span><span class="n">nb_real</span><span class="p">,</span><span class="n">basis</span><span class="o">=</span><span class="n">basis</span><span class="p">)</span>
        <span class="n">tg_grad</span> <span class="o">=</span> <span class="n">size_tangent_proj</span><span class="p">(</span><span class="n">pf</span><span class="p">,</span><span class="n">sliced_grad</span><span class="p">,</span><span class="n">cent</span><span class="p">,</span><span class="n">gap</span><span class="o">=</span><span class="n">gap</span><span class="p">,</span><span class="n">cloud_siz</span><span class="o">=</span><span class="n">cloud_siz</span><span class="p">)</span>
        <span class="c1">#tg_grad = copy(sliced_grad)</span>
        <span class="n">step</span> <span class="o">=</span> <span class="n">exact_transport_line_search</span><span class="p">(</span><span class="n">pf</span><span class="p">,</span><span class="n">g</span><span class="p">,</span><span class="n">basis</span><span class="p">,</span><span class="n">tg_grad</span><span class="p">)</span>
        <span class="n">pf</span> <span class="o">-=</span> <span class="n">step</span><span class="o">*</span><span class="n">tg_grad</span>
        <span class="n">var</span> <span class="o">=</span> <span class="mi">100</span><span class="o">*</span><span class="n">norm</span><span class="p">(</span><span class="n">pf</span><span class="o">-</span><span class="n">displacement</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">])</span><span class="o">/</span><span class="n">norm</span><span class="p">(</span><span class="n">displacement</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">])</span>
        <span class="nb">print</span> <span class="s2">&quot;Relative variation: &quot;</span><span class="p">,</span><span class="n">var</span><span class="p">,</span><span class="s2">&quot; Total mass: &quot;</span><span class="p">,</span><span class="n">pf</span><span class="p">[</span><span class="mi">2</span><span class="p">,:]</span><span class="o">.</span><span class="n">sum</span><span class="p">(),</span><span class="s2">&quot; Cost: &quot;</span><span class="p">,</span><span class="n">sliced_transport_cost</span><span class="p">(</span><span class="n">pf</span><span class="p">,</span><span class="n">g</span><span class="p">,</span><span class="n">basis</span><span class="p">)</span>
        <span class="n">displacement</span><span class="p">[:,:,</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">pf</span><span class="p">)</span>
        <span class="n">i</span><span class="o">+=</span><span class="mi">1</span>
    <span class="n">displacement</span><span class="p">[:,:,</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">g</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">displacement</span><span class="p">[:,:,</span><span class="mi">0</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="mi">2</span><span class="p">]</span>

<span class="k">def</span> <span class="nf">sliced_transport_single_dir</span><span class="p">(</span><span class="n">f</span><span class="p">,</span><span class="n">g</span><span class="p">,</span><span class="n">nb_iter</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span><span class="n">tol</span><span class="o">=</span><span class="mf">1.e-10</span><span class="p">,</span><span class="n">nb_real</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span><span class="n">rand_en</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>

    <span class="kn">from</span> <span class="nn">numpy</span> <span class="k">import</span> <span class="n">copy</span>
    <span class="kn">from</span> <span class="nn">numpy.linalg</span> <span class="k">import</span> <span class="n">norm</span><span class="p">,</span><span class="n">svd</span>
    <span class="n">shapf</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">var</span> <span class="o">=</span> <span class="mi">100</span>
    <span class="n">pf</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
    <span class="n">basis</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">sliced_grad</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">displacement</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
    <span class="n">displacement</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">copy</span><span class="p">(</span><span class="n">f</span><span class="p">))</span>

    <span class="k">while</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">nb_iter</span> <span class="ow">and</span> <span class="n">var</span><span class="o">&gt;</span><span class="n">tol</span> <span class="p">:</span>
        <span class="k">if</span> <span class="n">rand_en</span><span class="p">:</span>
            <span class="n">sliced_grad</span><span class="p">,</span><span class="n">basis</span> <span class="o">=</span> <span class="n">sliced_transport_gradient</span><span class="p">(</span><span class="n">pf</span><span class="p">,</span><span class="n">g</span><span class="p">,</span><span class="n">nb_real</span><span class="o">=</span><span class="n">nb_real</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">sliced_grad</span><span class="p">,</span><span class="n">basis</span> <span class="o">=</span> <span class="n">sliced_transport_gradient</span><span class="p">(</span><span class="n">pf</span><span class="p">,</span><span class="n">g</span><span class="p">,</span><span class="n">nb_real</span><span class="o">=</span><span class="n">nb_real</span><span class="p">,</span><span class="n">basis</span><span class="o">=</span><span class="n">basis</span><span class="p">)</span>
        <span class="n">U</span><span class="p">,</span><span class="n">s</span><span class="p">,</span><span class="n">V</span> <span class="o">=</span> <span class="n">svd</span><span class="p">(</span><span class="n">sliced_grad</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">transpose</span><span class="p">(</span><span class="n">sliced_grad</span><span class="p">)))</span>
        <span class="c1">#print &quot;Advection dispersion: &quot;,s</span>
        <span class="n">tg_grad</span> <span class="o">=</span> <span class="n">U</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">shapf</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">U</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span><span class="n">shapf</span><span class="p">[</span><span class="mi">0</span><span class="p">])))</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">sliced_grad</span><span class="p">)</span>
        <span class="c1">#tg_grad = copy(sliced_grad)</span>
        <span class="n">step</span> <span class="o">=</span> <span class="n">exact_transport_line_search</span><span class="p">(</span><span class="n">pf</span><span class="p">,</span><span class="n">g</span><span class="p">,</span><span class="n">basis</span><span class="p">,</span><span class="n">tg_grad</span><span class="p">)</span>
        <span class="n">pf</span> <span class="o">-=</span> <span class="n">step</span><span class="o">*</span><span class="n">tg_grad</span>
        <span class="n">var</span> <span class="o">=</span> <span class="mi">100</span><span class="o">*</span><span class="n">norm</span><span class="p">(</span><span class="n">pf</span><span class="o">-</span><span class="n">displacement</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="o">/</span><span class="n">norm</span><span class="p">(</span><span class="n">displacement</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        <span class="nb">print</span> <span class="s2">&quot;Relative variation: &quot;</span><span class="p">,</span><span class="n">var</span><span class="p">,</span><span class="s2">&quot; Total mass: &quot;</span><span class="p">,</span><span class="n">pf</span><span class="p">[</span><span class="mi">2</span><span class="p">,:]</span><span class="o">.</span><span class="n">sum</span><span class="p">(),</span><span class="s2">&quot; Cost: &quot;</span><span class="p">,</span><span class="n">sliced_transport_cost</span><span class="p">(</span><span class="n">pf</span><span class="p">,</span><span class="n">g</span><span class="p">,</span><span class="n">basis</span><span class="p">)</span>
        <span class="n">displacement</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">copy</span><span class="p">(</span><span class="n">pf</span><span class="p">))</span>
        <span class="n">i</span><span class="o">+=</span><span class="mi">1</span>
    <span class="n">displacement</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">copy</span><span class="p">(</span><span class="n">g</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">displacement</span>



<span class="k">def</span> <span class="nf">lasso_transport_gradient</span><span class="p">(</span><span class="n">vect_x_l</span><span class="p">,</span><span class="n">vect_y_l</span><span class="p">,</span><span class="n">vect_x_c</span><span class="p">,</span><span class="n">vect_y_c</span><span class="p">,</span><span class="n">pix_val</span><span class="p">,</span><span class="n">g</span><span class="p">,</span><span class="n">shap</span><span class="p">,</span><span class="n">nb_real</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
    <span class="kn">from</span> <span class="nn">numpy</span> <span class="k">import</span> <span class="n">copy</span>
    <span class="n">f</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">g</span><span class="p">)</span>
    <span class="n">f</span><span class="p">[</span><span class="mi">2</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">pix_val</span><span class="p">)</span>
    <span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">lasso_cumul</span><span class="p">(</span><span class="n">vect_x_l</span><span class="p">,</span><span class="n">lines</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">],))</span><span class="o">+</span><span class="n">lasso_cumul</span><span class="p">(</span><span class="n">vect_x_c</span><span class="p">,</span><span class="n">lines</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">],))</span>
    <span class="n">f</span><span class="p">[</span><span class="mi">1</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">lasso_cumul</span><span class="p">(</span><span class="n">vect_y_l</span><span class="p">,</span><span class="n">lines</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">],))</span><span class="o">+</span><span class="n">lasso_cumul</span><span class="p">(</span><span class="n">vect_y_c</span><span class="p">,</span><span class="n">lines</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">],))</span>


    <span class="n">sliced_grad</span><span class="p">,</span><span class="n">basis</span> <span class="o">=</span> <span class="n">sliced_transport_gradient</span><span class="p">(</span><span class="n">f</span><span class="p">,</span><span class="n">g</span><span class="p">,</span><span class="n">nb_real</span><span class="o">=</span><span class="n">nb_real</span><span class="p">)</span>
    <span class="n">grad_x_l</span> <span class="o">=</span> <span class="n">lasso_cumul_transp</span><span class="p">(</span><span class="n">sliced_grad</span><span class="p">[</span><span class="mi">0</span><span class="p">,:]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">shap</span><span class="p">),</span><span class="n">lines</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">grad_x_c</span> <span class="o">=</span> <span class="n">lasso_cumul_transp</span><span class="p">(</span><span class="n">sliced_grad</span><span class="p">[</span><span class="mi">0</span><span class="p">,:]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">shap</span><span class="p">),</span><span class="n">lines</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">grad_y_l</span> <span class="o">=</span> <span class="n">lasso_cumul_transp</span><span class="p">(</span><span class="n">sliced_grad</span><span class="p">[</span><span class="mi">1</span><span class="p">,:]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">shap</span><span class="p">),</span><span class="n">lines</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">grad_y_c</span> <span class="o">=</span> <span class="n">lasso_cumul_transp</span><span class="p">(</span><span class="n">sliced_grad</span><span class="p">[</span><span class="mi">1</span><span class="p">,:]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">shap</span><span class="p">),</span><span class="n">lines</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">grad_x_l</span><span class="p">,</span><span class="n">grad_x_c</span><span class="p">,</span><span class="n">grad_y_l</span><span class="p">,</span><span class="n">grad_y_c</span><span class="p">,</span><span class="n">sliced_grad</span><span class="p">[</span><span class="mi">2</span><span class="p">,:],</span><span class="n">basis</span>

<span class="sd">&quot;&quot;&quot;def tg_lasso_proj(vect_x_l,vect_y_l,vect_x_c,vect_y_c,pix_val,g,rmin,shap,nb_real=10):</span>


<span class="sd">    tg_grad_x_l,tg_grad_x_c,tg_grad_y_l,tg_grad_y_c,pix_grad,basis = lasso_transport_gradient(vect_x_l,vect_y_l,vect_x_c,vect_y_c,pix_val,g,shap,nb_real=nb_real)</span>

<span class="sd">    d_l = sqrt(vect_x_l**2+vect_y_l**2)</span>
<span class="sd">    indx1,indy1 = where(d_l==r_min)</span>
<span class="sd">    for i in range(0,size(indx1)):</span>
<span class="sd">        # Projection of the euclidian gradients at points at the boundary on the corresponding tangent planes</span>
<span class="sd">        tg_grad_x_l[indx1[id_bound[i]],indy1[id_bound[i]]],tg_grad_y_l[indx1[id_bound[i]],indy1[id_bound[i]]] = array([tg_grad_x_l[indx1[id_bound[i]],indy1[id_bound[i]]],tg_grad_y_l[indx1[id_bound[i]],indy1[id_bound[i]]]]) - (tg_grad_x_l[indx1[id_bound[i]],indy1[id_bound[i]]]*vect_x_l[indx1[id_bound[i]],indy1[id_bound[i]]] + tg_grad_y_l[indx1[id_bound[i]],indy1[id_bound[i]]]*vect_y_l[indx1[id_bound[i]],indy1[id_bound[i]]])*array([vect_x_l[indx1[id_bound[i]],indy1[id_bound[i]]],vect_y_l[indx1[id_bound[i]],indy1[id_bound[i]]]])/d_l[indx1[id_bound[i]],indy1[id_bound[i]]]**2</span>

<span class="sd">    d_c = sqrt(vect_x_c**2+vect_y_c**2)</span>
<span class="sd">    indx1,indy1 = where(d_c&gt;0)</span>
<span class="sd">    id_bound = where(d_c[indx1,indy1]==r_min)</span>
<span class="sd">    id_bound = id_bound[0]</span>
<span class="sd">    for i in range(0,size(id_bound)):</span>
<span class="sd">    # Projection of the euclidian gradients at points at the boundary on the corresponding tangent planes</span>
<span class="sd">    tg_grad_x_c[indx1[id_bound[i]],indy1[id_bound[i]]],tg_grad_y_c[indx1[id_bound[i]],indy1[id_bound[i]]] = array([tg_grad_x_c[indx1[id_bound[i]],indy1[id_bound[i]]],tg_grad_y_c[indx1[id_bound[i]],indy1[id_bound[i]]]]) - (tg_grad_x_c[indx1[id_bound[i]],indy1[id_bound[i]]]*vect_x_c[indx1[id_bound[i]],indy1[id_bound[i]]] + tg_grad_y_c[indx1[id_bound[i]],indy1[id_bound[i]]]*vect_y_c[indx1[id_bound[i]],indy1[id_bound[i]]])*array([vect_x_c[indx1[id_bound[i]],indy1[id_bound[i]]],vect_y_c[indx1[id_bound[i]],indy1[id_bound[i]]]])/d_c[indx1[id_bound[i]],indy1[id_bound[i]]]**2</span>

<span class="sd">&quot;&quot;&quot;</span>

<span class="k">def</span> <span class="nf">sliced_transport_cost</span><span class="p">(</span><span class="n">f</span><span class="p">,</span><span class="n">g</span><span class="p">,</span><span class="n">basis</span><span class="p">):</span>
    <span class="kn">from</span> <span class="nn">numpy</span> <span class="k">import</span> <span class="n">transpose</span><span class="p">,</span><span class="n">sort</span>
    <span class="kn">from</span> <span class="nn">numpy.linalg</span> <span class="k">import</span> <span class="n">norm</span>
    <span class="n">slices_f</span> <span class="o">=</span> <span class="n">transpose</span><span class="p">(</span><span class="n">basis</span><span class="p">)</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
    <span class="n">slices_g</span> <span class="o">=</span> <span class="n">transpose</span><span class="p">(</span><span class="n">basis</span><span class="p">)</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">g</span><span class="p">)</span>
    <span class="n">cost</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">basis</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
        <span class="n">cost</span> <span class="o">+=</span> <span class="n">norm</span><span class="p">(</span><span class="n">sort</span><span class="p">(</span><span class="n">slices_f</span><span class="p">[</span><span class="n">i</span><span class="p">,:])</span><span class="o">-</span><span class="n">sort</span><span class="p">(</span><span class="n">slices_g</span><span class="p">[</span><span class="n">i</span><span class="p">,:]))</span><span class="o">**</span><span class="mi">2</span>

    <span class="k">return</span> <span class="n">cost</span>

<span class="k">def</span> <span class="nf">lasso_transport_cost</span><span class="p">(</span><span class="n">vect_x_l</span><span class="p">,</span><span class="n">vect_y_l</span><span class="p">,</span><span class="n">vect_x_c</span><span class="p">,</span><span class="n">vect_y_c</span><span class="p">,</span><span class="n">pix_val</span><span class="p">,</span><span class="n">g</span><span class="p">,</span><span class="n">basis</span><span class="p">):</span>
    <span class="kn">from</span> <span class="nn">numpy</span> <span class="k">import</span> <span class="n">copy</span>
    <span class="n">f</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">g</span><span class="p">)</span>
    <span class="n">f</span><span class="p">[</span><span class="mi">2</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">pix_val</span><span class="p">)</span>
    <span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">lasso_cumul</span><span class="p">(</span><span class="n">vect_x_l</span><span class="p">,</span><span class="n">lines</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">],))</span><span class="o">+</span><span class="n">lasso_cumul</span><span class="p">(</span><span class="n">vect_x_c</span><span class="p">,</span><span class="n">lines</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">],))</span>
    <span class="n">f</span><span class="p">[</span><span class="mi">1</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">lasso_cumul</span><span class="p">(</span><span class="n">vect_y_l</span><span class="p">,</span><span class="n">lines</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">],))</span><span class="o">+</span><span class="n">lasso_cumul</span><span class="p">(</span><span class="n">vect_y_c</span><span class="p">,</span><span class="n">lines</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">],))</span>
    <span class="k">return</span> <span class="n">sliced_transport_cost</span><span class="p">(</span><span class="n">f</span><span class="p">,</span><span class="n">g</span><span class="p">,</span><span class="n">basis</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">armijo_lasso_transport</span><span class="p">(</span><span class="n">vect_x_l</span><span class="p">,</span><span class="n">vect_x_c</span><span class="p">,</span><span class="n">vect_y_l</span><span class="p">,</span><span class="n">vect_y_c</span><span class="p">,</span><span class="n">pix_val</span><span class="p">,</span><span class="n">tg_grad_x_l</span><span class="p">,</span><span class="n">tg_grad_x_c</span><span class="p">,</span><span class="n">tg_grad_y_l</span><span class="p">,</span><span class="n">tg_grad_y_c</span><span class="p">,</span><span class="n">pix_grad</span><span class="p">,</span><span class="n">g</span><span class="p">,</span><span class="n">basis</span><span class="p">,</span><span class="n">r_min</span><span class="p">,</span><span class="n">angle_min</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span><span class="n">beta</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span><span class="n">sigma</span><span class="o">=</span><span class="mf">1.e-10</span><span class="p">,</span><span class="n">nb_iter</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span><span class="n">eps</span> <span class="o">=</span> <span class="mf">1.e-13</span><span class="p">):</span>
    <span class="kn">from</span> <span class="nn">numpy</span> <span class="k">import</span> <span class="n">sqrt</span>
    <span class="kn">from</span> <span class="nn">numpy.linalg</span> <span class="k">import</span> <span class="n">norm</span>
    <span class="n">m</span><span class="o">=</span><span class="mi">0</span>
    <span class="n">cur_cost</span> <span class="o">=</span> <span class="n">lasso_transport_cost</span><span class="p">(</span><span class="n">vect_x_l</span><span class="p">,</span><span class="n">vect_y_l</span><span class="p">,</span><span class="n">vect_x_c</span><span class="p">,</span><span class="n">vect_y_c</span><span class="p">,</span><span class="n">pix_val</span><span class="p">,</span><span class="n">g</span><span class="p">,</span><span class="n">basis</span><span class="p">)</span>
    <span class="n">grad_norm</span> <span class="o">=</span> <span class="n">norm</span><span class="p">(</span><span class="n">tg_grad_x_l</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="n">norm</span><span class="p">(</span><span class="n">tg_grad_y_l</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="n">norm</span><span class="p">(</span><span class="n">tg_grad_x_c</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="n">norm</span><span class="p">(</span><span class="n">tg_grad_y_c</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="n">norm</span><span class="p">(</span><span class="n">pix_grad</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span>
    <span class="n">descent</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="n">mu</span> <span class="o">=</span> <span class="n">alpha</span><span class="o">*</span><span class="n">beta</span><span class="o">**</span><span class="n">m</span>
    <span class="n">vect_x_l_0</span><span class="p">,</span><span class="n">vect_x_c_0</span><span class="p">,</span><span class="n">vect_y_l_0</span><span class="p">,</span><span class="n">vect_y_c_0</span> <span class="o">=</span> <span class="n">retraction_lasso</span><span class="p">(</span><span class="n">vect_x_l</span><span class="o">-</span><span class="n">mu</span><span class="o">*</span><span class="n">tg_grad_x_l</span><span class="p">,</span><span class="n">vect_x_c</span><span class="o">-</span><span class="n">mu</span><span class="o">*</span><span class="n">tg_grad_x_c</span><span class="p">,</span><span class="n">vect_y_l</span><span class="o">-</span><span class="n">mu</span><span class="o">*</span><span class="n">tg_grad_y_l</span><span class="p">,</span><span class="n">vect_y_c</span><span class="o">-</span><span class="n">mu</span><span class="o">*</span><span class="n">tg_grad_y_c</span><span class="p">,</span><span class="n">r_min</span><span class="p">,</span><span class="n">angle_min</span><span class="p">)</span>
    <span class="n">pix_val_0</span> <span class="o">=</span> <span class="n">pix_val</span><span class="o">-</span><span class="n">mu</span><span class="o">*</span><span class="n">pix_grad</span>
    <span class="n">new_cost</span> <span class="o">=</span> <span class="n">lasso_transport_cost</span><span class="p">(</span><span class="n">vect_x_l_0</span><span class="p">,</span><span class="n">vect_y_l_0</span><span class="p">,</span><span class="n">vect_x_c_0</span><span class="p">,</span><span class="n">vect_y_c_0</span><span class="p">,</span><span class="n">pix_val_0</span><span class="p">,</span><span class="n">g</span><span class="p">,</span><span class="n">basis</span><span class="p">)</span>
    <span class="n">descent</span> <span class="o">=</span> <span class="n">cur_cost</span> <span class="o">-</span> <span class="n">new_cost</span>

    <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">while</span> <span class="n">descent</span><span class="o">&lt;=</span><span class="n">grad_norm</span><span class="o">*</span><span class="n">sigma</span><span class="o">*</span><span class="n">mu</span> <span class="ow">and</span> <span class="n">grad_norm</span><span class="o">&gt;</span><span class="n">eps</span> <span class="ow">and</span> <span class="n">count</span><span class="o">&lt;</span><span class="n">nb_iter</span><span class="p">:</span>
        <span class="n">m</span><span class="o">+=</span><span class="mi">1</span>
        <span class="n">mu</span> <span class="o">=</span> <span class="n">alpha</span><span class="o">*</span><span class="n">beta</span><span class="o">**</span><span class="n">m</span>
        <span class="n">vect_x_l_0</span><span class="p">,</span><span class="n">vect_x_c_0</span><span class="p">,</span><span class="n">vect_y_l_0</span><span class="p">,</span><span class="n">vect_y_c_0</span> <span class="o">=</span> <span class="n">retraction_lasso</span><span class="p">(</span><span class="n">vect_x_l</span><span class="o">-</span><span class="n">mu</span><span class="o">*</span><span class="n">tg_grad_x_l</span><span class="p">,</span><span class="n">vect_x_c</span><span class="o">-</span><span class="n">mu</span><span class="o">*</span><span class="n">tg_grad_x_c</span><span class="p">,</span><span class="n">vect_y_l</span><span class="o">-</span><span class="n">mu</span><span class="o">*</span><span class="n">tg_grad_y_l</span><span class="p">,</span><span class="n">vect_y_c</span><span class="o">-</span><span class="n">mu</span><span class="o">*</span><span class="n">tg_grad_y_c</span><span class="p">,</span><span class="n">r_min</span><span class="p">,</span><span class="n">angle_min</span><span class="p">)</span>
        <span class="n">pix_val_0</span> <span class="o">=</span> <span class="n">pix_val</span><span class="o">-</span><span class="n">mu</span><span class="o">*</span><span class="n">pix_grad</span>
        <span class="n">new_cost</span> <span class="o">=</span> <span class="n">lasso_transport_cost</span><span class="p">(</span><span class="n">vect_x_l_0</span><span class="p">,</span><span class="n">vect_y_l_0</span><span class="p">,</span><span class="n">vect_x_c_0</span><span class="p">,</span><span class="n">vect_y_c_0</span><span class="p">,</span><span class="n">pix_val_0</span><span class="p">,</span><span class="n">g</span><span class="p">,</span><span class="n">basis</span><span class="p">)</span>
        <span class="n">descent</span> <span class="o">=</span> <span class="n">cur_cost</span> <span class="o">-</span> <span class="n">new_cost</span>
        <span class="n">count</span><span class="o">+=</span><span class="mi">1</span>
    <span class="nb">print</span> <span class="s2">&quot;Armijo descent: &quot;</span><span class="p">,</span><span class="n">descent</span><span class="p">,</span><span class="s2">&quot; Step: &quot;</span><span class="p">,</span><span class="n">mu</span><span class="p">,</span><span class="s2">&quot; new cost: &quot;</span><span class="p">,</span><span class="n">new_cost</span>
    <span class="k">return</span> <span class="n">vect_x_l_0</span><span class="p">,</span><span class="n">vect_x_c_0</span><span class="p">,</span><span class="n">vect_y_l_0</span><span class="p">,</span><span class="n">vect_y_c_0</span><span class="p">,</span><span class="n">pix_val_0</span><span class="p">,</span><span class="n">new_cost</span>

<span class="sd">&quot;&quot;&quot;def sliced_transport_lasso(f,g,rmin,nb_iter=1000,tol=1.e-15,nb_real=30,shap=None,gap=None):</span>
<span class="sd">    from numpy import copy</span>

<span class="sd">    fout = copy(f)</span>
<span class="sd">    var = 100</span>
<span class="sd">    i = 0</span>

<span class="sd">    vect_x_l = diff_coord_mat(f[0,:].reshape(shap),lines=True)</span>
<span class="sd">    vect_x_c = diff_coord_mat(f[0,:].reshape(shap),lines=False)</span>

<span class="sd">    vect_y_l = diff_coord_mat(f[1,:].reshape(shap),lines=True)</span>
<span class="sd">    vect_y_c = diff_coord_mat(f[1,:].reshape(shap),lines=False)</span>

<span class="sd">    pix_val = copy(f[2,:])</span>

<span class="sd">    while i&lt;nb_iter or var&gt;tol:</span>
<span class="sd">        grad_x_l,grad_x_c,grad_y_l,grad_y_c,pix_grad,basis = lasso_transport_gradient(vect_x_l,vect_y_l,vect_x_c,vect_y_c,pix_val,g,nb_real=nb_real,shap)</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="k">def</span> <span class="nf">shape_tg_proj</span><span class="p">(</span><span class="n">f</span><span class="p">,</span><span class="n">ascent_dir</span><span class="p">,</span><span class="n">cent</span><span class="p">,</span><span class="n">gap</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">cloud_siz</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="kn">from</span> <span class="nn">numpy</span> <span class="k">import</span> <span class="n">ones</span><span class="p">,</span><span class="n">copy</span>
    <span class="kn">from</span> <span class="nn">numpy.linalg</span> <span class="k">import</span> <span class="n">norm</span>
    <span class="n">nb_points</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">cent_mat</span> <span class="o">=</span> <span class="n">cent</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">ones</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span><span class="n">nb_points</span><span class="p">)))</span>
    <span class="n">cent_dir</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">,:]</span><span class="o">/</span><span class="n">gap</span> <span class="o">-</span> <span class="n">cent_mat</span>
    <span class="n">dist_w</span> <span class="o">=</span> <span class="n">norm</span><span class="p">(</span><span class="n">cent_dir</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span>
    <span class="k">if</span> <span class="n">cloud_siz</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">cloud_siz</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">dist_w</span><span class="o">*</span><span class="n">f</span><span class="p">[</span><span class="mi">2</span><span class="p">,:])</span>

    <span class="n">ascent_dir_proj</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">ascent_dir</span><span class="p">)</span>
    <span class="n">ascent_dir_proj</span><span class="p">[</span><span class="mi">2</span><span class="p">,:]</span> <span class="o">-=</span> <span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="n">dist_w</span><span class="o">*</span><span class="n">ascent_dir</span><span class="p">[</span><span class="mi">2</span><span class="p">,:])</span><span class="o">-</span><span class="n">cloud_siz</span><span class="p">)</span><span class="o">*</span><span class="n">dist_w</span><span class="o">/</span><span class="n">norm</span><span class="p">(</span><span class="n">dist_w</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span>
    <span class="n">normal_pos</span> <span class="o">=</span> <span class="n">ones</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">f</span><span class="p">[</span><span class="mi">2</span><span class="p">,:]</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span><span class="n">nb_points</span><span class="p">)))</span>
    <span class="n">ascent_dir_proj</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">,:]</span> <span class="o">-=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">normal_pos</span><span class="o">*</span><span class="n">ascent_dir_proj</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">,:])</span><span class="o">*</span><span class="n">normal_pos</span><span class="o">/</span><span class="n">norm</span><span class="p">(</span><span class="n">normal_pos</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span>

    <span class="k">return</span> <span class="n">ascent_dir_proj</span>


<span class="k">def</span> <span class="nf">energy_warping_metric</span><span class="p">(</span><span class="n">f</span><span class="p">,</span><span class="n">nb_neigh</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span><span class="n">eps</span><span class="o">=</span><span class="mf">1.e-15</span><span class="p">):</span>

    <span class="kn">from</span> <span class="nn">pyflann</span> <span class="k">import</span> <span class="n">FLANN</span>
    <span class="kn">from</span> <span class="nn">numpy</span> <span class="k">import</span> <span class="n">transpose</span><span class="p">,</span><span class="n">zeros</span><span class="p">,</span><span class="n">float64</span>
    <span class="n">nb_samp</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">knn</span> <span class="o">=</span> <span class="n">FLANN</span><span class="p">()</span>
    <span class="n">params</span> <span class="o">=</span> <span class="n">knn</span><span class="o">.</span><span class="n">build_index</span><span class="p">(</span><span class="n">array</span><span class="p">(</span><span class="n">transpose</span><span class="p">(</span><span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">,:]),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">float64</span><span class="p">))</span>
    <span class="n">result</span><span class="p">,</span> <span class="n">dists</span> <span class="o">=</span> <span class="n">knn</span><span class="o">.</span><span class="n">nn_index</span><span class="p">(</span><span class="n">transpose</span><span class="p">(</span><span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">,:]),</span><span class="n">nb_neigh</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">dists</span><span class="o">+=</span><span class="n">eps</span>
    <span class="n">intensities</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">nb_samp</span><span class="p">,))</span>
    <span class="n">inv_dist_weights</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">nb_samp</span><span class="p">,))</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_samp</span><span class="p">):</span>
        <span class="n">intensities</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">f</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="n">result</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">1</span><span class="p">:</span><span class="n">nb_neigh</span><span class="o">+</span><span class="mi">1</span><span class="p">]]</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">inv_dist_weights</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">dists</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">1</span><span class="p">:</span><span class="n">nb_neigh</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">intensities</span><span class="p">,</span><span class="n">inv_dist_weights</span><span class="p">,</span><span class="nb">sum</span><span class="p">(</span><span class="n">intensities</span><span class="o">*</span><span class="n">inv_dist_weights</span><span class="p">),</span><span class="n">knn</span>

<span class="k">def</span> <span class="nf">energy_warping_tg_proj</span><span class="p">(</span><span class="n">f</span><span class="p">,</span><span class="n">ascent_dir</span><span class="p">,</span><span class="n">nb_neigh</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span><span class="n">eps</span><span class="o">=</span><span class="mf">1.e-15</span><span class="p">):</span>
    <span class="kn">from</span> <span class="nn">pyflann</span> <span class="k">import</span> <span class="n">FLANN</span>
    <span class="kn">from</span> <span class="nn">numpy</span> <span class="k">import</span> <span class="n">transpose</span><span class="p">,</span><span class="n">zeros</span><span class="p">,</span><span class="n">float64</span>
    <span class="kn">from</span> <span class="nn">numpy.linalg</span> <span class="k">import</span> <span class="n">norm</span>

    <span class="n">shap</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">normal_pos</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
    <span class="n">nb_samp</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">inv_dist_weights</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">nb_samp</span><span class="p">,))</span>
    <span class="n">intensities</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">nb_samp</span><span class="p">,))</span>
    <span class="n">knn</span> <span class="o">=</span> <span class="n">FLANN</span><span class="p">()</span>
    <span class="n">params</span> <span class="o">=</span> <span class="n">knn</span><span class="o">.</span><span class="n">build_index</span><span class="p">(</span><span class="n">array</span><span class="p">(</span><span class="n">transpose</span><span class="p">(</span><span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">,:]),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">float64</span><span class="p">))</span>
    <span class="n">result</span><span class="p">,</span> <span class="n">dists</span> <span class="o">=</span> <span class="n">knn</span><span class="o">.</span><span class="n">nn_index</span><span class="p">(</span><span class="n">transpose</span><span class="p">(</span><span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">,:]),</span><span class="n">nb_neigh</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">dists</span> <span class="o">+=</span> <span class="n">eps</span>
    <span class="n">dist_w</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">],))</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_samp</span><span class="p">):</span>
        <span class="n">inv_dist_weights</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">dists</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">1</span><span class="p">:</span><span class="n">nb_neigh</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">))</span>
        <span class="n">intensities</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">f</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="n">result</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">0</span><span class="p">:</span><span class="n">nb_neigh</span><span class="o">+</span><span class="mi">1</span><span class="p">]])</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_neigh</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">j</span><span class="o">&lt;</span><span class="n">nb_neigh</span><span class="p">:</span>
                <span class="n">normal_pos</span><span class="p">[:,</span><span class="n">i</span><span class="p">]</span> <span class="o">+=</span> <span class="p">(</span><span class="n">intensities</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">,</span><span class="n">i</span><span class="p">]</span><span class="o">-</span><span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">,</span><span class="n">result</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">]])</span><span class="o">/</span><span class="n">dists</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">**</span><span class="mi">4</span>
                <span class="n">normal_pos</span><span class="p">[:,</span><span class="n">result</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">]]</span> <span class="o">-=</span> <span class="p">(</span><span class="n">intensities</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">,</span><span class="n">i</span><span class="p">]</span><span class="o">-</span><span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">,</span><span class="n">result</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">]])</span><span class="o">/</span><span class="n">dists</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">**</span><span class="mi">4</span>
            <span class="n">dist_w</span><span class="p">[</span><span class="n">result</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]]</span> <span class="o">=</span> <span class="n">inv_dist_weights</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">*</span><span class="n">intensities</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

    <span class="n">ascent_dir_proj</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">ascent_dir</span><span class="p">)</span>
    <span class="n">ascent_dir_proj</span><span class="p">[</span><span class="mi">2</span><span class="p">,:]</span> <span class="o">-=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">dist_w</span><span class="o">*</span><span class="n">ascent_dir</span><span class="p">[</span><span class="mi">2</span><span class="p">,:])</span><span class="o">*</span><span class="n">dist_w</span><span class="o">/</span><span class="n">norm</span><span class="p">(</span><span class="n">dist_w</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span>
    <span class="n">normal_pos</span> <span class="o">=</span> <span class="n">ones</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">f</span><span class="p">[</span><span class="mi">2</span><span class="p">,:]</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span><span class="n">nb_samp</span><span class="p">)))</span>
    <span class="n">ascent_dir_proj</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">,:]</span> <span class="o">-=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">normal_pos</span><span class="o">*</span><span class="n">ascent_dir_proj</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">,:])</span><span class="o">*</span><span class="n">normal_pos</span><span class="o">/</span><span class="n">norm</span><span class="p">(</span><span class="n">normal_pos</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span>

    <span class="k">return</span> <span class="n">ascent_dir_proj</span>

<span class="k">def</span> <span class="nf">coord_wise_sort</span><span class="p">(</span><span class="n">g</span><span class="p">,</span><span class="n">basis</span><span class="p">,</span><span class="n">first</span> <span class="o">=</span> <span class="kc">True</span><span class="p">):</span>
    <span class="n">pg</span> <span class="o">=</span> <span class="n">transpose</span><span class="p">(</span><span class="n">basis</span><span class="p">)</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">g</span><span class="p">)</span>
    <span class="n">eqg</span> <span class="o">=</span> <span class="n">pg</span><span class="o">*</span><span class="mi">0</span>
    <span class="n">ind</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">sortg</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">first</span><span class="p">:</span>
        <span class="n">ind</span> <span class="o">=</span> <span class="n">argsort</span><span class="p">(</span><span class="n">pg</span><span class="p">[</span><span class="mi">0</span><span class="p">,:])</span>
        <span class="n">sortg</span> <span class="o">=</span> <span class="n">g</span><span class="p">[:,</span><span class="n">ind</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">basis</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
            <span class="n">eqg</span><span class="p">[</span><span class="n">i</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">sort</span><span class="p">(</span><span class="n">pg</span><span class="p">[</span><span class="n">i</span><span class="p">,:])</span>
        <span class="n">sortg</span> <span class="o">=</span> <span class="n">basis</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">eqg</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">sortg</span>


<span class="k">def</span> <span class="nf">support_computing</span><span class="p">(</span><span class="n">P</span><span class="p">,</span><span class="n">r</span><span class="p">,</span><span class="n">c</span><span class="p">):</span>
    <span class="n">i</span> <span class="o">=</span> <span class="n">where</span><span class="p">(</span><span class="n">r</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">j</span> <span class="o">=</span> <span class="n">where</span><span class="p">(</span><span class="n">c</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">supp_size_init</span> <span class="o">=</span> <span class="n">size</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">+</span><span class="n">size</span><span class="p">(</span><span class="n">j</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span>
    <span class="n">P_thresh</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">kthresholding_im</span><span class="p">(</span><span class="n">P</span><span class="p">,</span><span class="n">supp_size_init</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">thresh_ind</span> <span class="o">=</span> <span class="n">where</span><span class="p">(</span><span class="n">P_thresh</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">supp</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">(</span><span class="n">P</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
    <span class="n">supp</span><span class="p">[</span><span class="n">thresh_ind</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">thresh_ind</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="n">margc</span> <span class="o">=</span> <span class="n">P_thresh</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">margl</span> <span class="o">=</span> <span class="n">P_thresh</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">zc</span> <span class="o">=</span> <span class="n">where</span><span class="p">(</span><span class="n">margc</span><span class="o">==</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">zl</span> <span class="o">=</span> <span class="n">where</span><span class="p">(</span><span class="n">margl</span><span class="o">==</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">Ptemp</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">P</span><span class="p">)</span>
    <span class="n">supp</span><span class="p">[</span><span class="n">thresh_ind</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">thresh_ind</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">size</span><span class="p">(</span><span class="n">zc</span><span class="p">)):</span>
        <span class="k">if</span> <span class="n">c</span><span class="p">[</span><span class="n">zc</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">i</span><span class="p">]]</span> <span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
            <span class="n">j</span> <span class="o">=</span> <span class="n">where</span><span class="p">(</span><span class="n">Ptemp</span><span class="p">[</span><span class="n">i</span><span class="p">,:]</span><span class="o">==</span><span class="n">Ptemp</span><span class="p">[</span><span class="n">i</span><span class="p">,:]</span><span class="o">.</span><span class="n">max</span><span class="p">())</span>
            <span class="n">supp</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="mi">1</span> <span class="c1"># Extending the support</span>

    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">size</span><span class="p">(</span><span class="n">zl</span><span class="p">)):</span>
        <span class="k">if</span> <span class="n">c</span><span class="p">[</span><span class="n">zl</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">j</span><span class="p">]]</span> <span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
            <span class="n">i</span> <span class="o">=</span> <span class="n">where</span><span class="p">(</span><span class="n">Ptemp</span><span class="p">[:,</span><span class="n">j</span><span class="p">]</span><span class="o">==</span><span class="n">Ptemp</span><span class="p">[:,</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">())</span>
            <span class="n">supp</span><span class="p">[</span><span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span> <span class="c1"># Extending the support</span>


    <span class="k">return</span> <span class="n">supp</span>

<span class="k">def</span> <span class="nf">map_sparse</span><span class="p">(</span><span class="n">P</span><span class="p">,</span><span class="n">r</span><span class="p">,</span><span class="n">c</span><span class="p">):</span>
    <span class="n">ri</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">P</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">ri</span> <span class="o">=</span> <span class="n">ri</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">size</span><span class="p">(</span><span class="n">ri</span><span class="p">),</span><span class="mi">1</span><span class="p">))</span>
    <span class="nb">print</span> <span class="s1">&#39;Bias :&#39;</span><span class="p">,((</span><span class="n">r</span><span class="o">-</span><span class="n">ri</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">/</span><span class="p">(</span><span class="n">r</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>

    <span class="n">Psp</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">P</span><span class="p">)</span>
    <span class="n">shap</span> <span class="o">=</span> <span class="n">P</span><span class="o">.</span><span class="n">shape</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
        <span class="n">Psp</span><span class="p">[</span><span class="n">i</span><span class="p">,:]</span><span class="o">*=</span><span class="mi">0</span>
        <span class="n">j</span> <span class="o">=</span> <span class="n">where</span><span class="p">(</span><span class="n">P</span><span class="p">[</span><span class="n">i</span><span class="p">,:]</span><span class="o">==</span><span class="n">P</span><span class="p">[</span><span class="n">i</span><span class="p">,:]</span><span class="o">.</span><span class="n">max</span><span class="p">())</span>
        <span class="n">l</span> <span class="o">=</span> <span class="mi">100000000</span>
        <span class="n">opt</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">size</span><span class="p">(</span><span class="n">j</span><span class="p">[</span><span class="mi">0</span><span class="p">])):</span>
            <span class="n">err</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">c</span><span class="p">[</span><span class="n">j</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">k</span><span class="p">]]</span><span class="o">-</span><span class="n">r</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">err</span><span class="o">&lt;</span><span class="n">l</span><span class="p">:</span>
                <span class="n">l</span> <span class="o">=</span> <span class="n">err</span>
                <span class="n">opt</span> <span class="o">=</span> <span class="n">k</span>
        <span class="n">Psp</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">opt</span><span class="p">]]</span> <span class="o">=</span> <span class="n">r</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">Psp</span>





<span class="k">def</span> <span class="nf">support_checking</span><span class="p">(</span><span class="n">P</span><span class="p">,</span><span class="n">supp</span><span class="p">,</span><span class="n">r</span><span class="p">,</span><span class="n">c</span><span class="p">):</span>
    <span class="n">margc</span> <span class="o">=</span> <span class="n">supp</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">margl</span> <span class="o">=</span> <span class="n">supp</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">zc</span> <span class="o">=</span> <span class="n">where</span><span class="p">(</span><span class="n">margc</span><span class="o">==</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">zl</span> <span class="o">=</span> <span class="n">where</span><span class="p">(</span><span class="n">margl</span><span class="o">==</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">size</span><span class="p">(</span><span class="n">zc</span><span class="p">)):</span>
        <span class="k">if</span> <span class="n">c</span><span class="p">[</span><span class="n">zc</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">i</span><span class="p">]]</span> <span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
            <span class="n">indj</span> <span class="o">=</span> <span class="n">argsort</span><span class="p">(</span><span class="n">P</span><span class="p">[</span><span class="n">i</span><span class="p">,:])</span>
            <span class="n">search</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">count</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
            <span class="k">while</span> <span class="n">search</span> <span class="ow">and</span> <span class="n">count</span> <span class="o">&gt;-</span><span class="n">size</span><span class="p">(</span><span class="n">r</span><span class="p">):</span>
                <span class="n">j</span> <span class="o">=</span> <span class="n">indj</span><span class="p">[</span><span class="n">count</span><span class="p">]</span>
                <span class="n">count</span><span class="o">-=</span><span class="mi">1</span>
                <span class="k">if</span> <span class="n">r</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
                    <span class="n">search</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="c1">#print &quot;columns count: &quot;,count</span>
            <span class="n">supp</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span> <span class="c1"># Extending the support</span>

    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">size</span><span class="p">(</span><span class="n">zl</span><span class="p">)):</span>
        <span class="k">if</span> <span class="n">c</span><span class="p">[</span><span class="n">zl</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">j</span><span class="p">]]</span> <span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
            <span class="n">indi</span> <span class="o">=</span> <span class="n">argsort</span><span class="p">(</span><span class="n">P</span><span class="p">[:,</span><span class="n">j</span><span class="p">])</span>
            <span class="n">search</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">count</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
            <span class="k">while</span> <span class="n">search</span> <span class="ow">and</span> <span class="n">count</span> <span class="o">&gt;</span> <span class="o">-</span><span class="n">size</span><span class="p">(</span><span class="n">c</span><span class="p">):</span>
                <span class="n">i</span> <span class="o">=</span> <span class="n">indi</span><span class="p">[</span><span class="n">count</span><span class="p">]</span>
                <span class="n">count</span><span class="o">-=</span><span class="mi">1</span>
                <span class="k">if</span> <span class="n">c</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
                    <span class="n">search</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="c1">#print &quot;lines count: &quot;,count</span>
            <span class="n">supp</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span> <span class="c1"># Extending the support</span>

    <span class="k">return</span> <span class="n">supp</span>

<span class="k">def</span> <span class="nf">beg_proj_transp_clust</span><span class="p">(</span><span class="n">M</span><span class="p">,</span><span class="n">r</span><span class="p">,</span><span class="n">c</span><span class="p">,</span><span class="n">cart_prods</span><span class="p">,</span><span class="n">w</span><span class="p">,</span><span class="n">inf_val</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">beta</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span><span class="n">nb_iter</span><span class="o">=</span><span class="mi">1000</span><span class="p">):</span>
    <span class="n">lambd</span> <span class="o">=</span> <span class="n">beta</span><span class="o">/</span><span class="n">M</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
    <span class="n">K</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="kc">None</span>
    <span class="k">if</span> <span class="n">inf_val</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">i</span><span class="p">,</span><span class="n">j</span> <span class="o">=</span> <span class="n">where</span><span class="p">(</span><span class="n">M</span><span class="o">==</span><span class="n">inf_val</span><span class="p">)</span>
        <span class="n">i0</span><span class="p">,</span><span class="n">j0</span> <span class="o">=</span> <span class="n">where</span><span class="p">(</span><span class="n">M</span><span class="o">&lt;</span><span class="n">inf_val</span><span class="p">)</span>
        <span class="n">Mtemp</span> <span class="o">=</span> <span class="n">M</span><span class="p">[</span><span class="n">i0</span><span class="p">,</span><span class="n">j0</span><span class="p">]</span>
        <span class="n">lambd</span> <span class="o">=</span> <span class="n">beta</span><span class="o">/</span><span class="n">Mtemp</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>

    <span class="n">K</span> <span class="o">=</span> <span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">lambd</span><span class="o">*</span><span class="n">M</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">inf_val</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">K</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="n">P</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">K</span><span class="p">)</span>
    <span class="n">P1</span> <span class="o">=</span> <span class="n">copy</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_iter</span><span class="p">):</span>


        <span class="n">P</span> <span class="o">=</span> <span class="n">kl_marg_proj</span><span class="p">(</span><span class="n">P</span><span class="p">,</span><span class="n">c</span><span class="p">)</span>
        <span class="n">P</span> <span class="o">=</span> <span class="n">transpose</span><span class="p">(</span><span class="n">kl_marg_proj</span><span class="p">(</span><span class="n">transpose</span><span class="p">(</span><span class="n">P</span><span class="p">),</span><span class="n">r</span><span class="p">))</span>
        <span class="n">ci</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">P</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">ci</span> <span class="o">=</span> <span class="n">ci</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">size</span><span class="p">(</span><span class="n">ci</span><span class="p">),</span><span class="mi">1</span><span class="p">))</span>
        <span class="n">ri</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">P</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">ri</span> <span class="o">=</span> <span class="n">ri</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">size</span><span class="p">(</span><span class="n">ri</span><span class="p">),</span><span class="mi">1</span><span class="p">))</span>
    <span class="nb">print</span> <span class="s1">&#39;Bias 1:&#39;</span><span class="p">,((</span><span class="n">c</span><span class="o">-</span><span class="n">ci</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">/</span><span class="p">(</span><span class="n">c</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    <span class="nb">print</span> <span class="s1">&#39;Bias 2:&#39;</span><span class="p">,((</span><span class="n">r</span><span class="o">-</span><span class="n">ri</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">/</span><span class="p">(</span><span class="n">r</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    <span class="n">P</span> <span class="o">=</span> <span class="n">kl_clust_proj</span><span class="p">(</span><span class="n">P</span><span class="p">,</span><span class="n">cart_prods</span><span class="p">,</span><span class="n">w</span><span class="p">)</span>
    <span class="n">nb_clust</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">w</span><span class="p">)</span>
    <span class="n">bias_3</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_clust</span><span class="p">):</span>
        <span class="n">bias_3</span><span class="o">+=</span> <span class="nb">abs</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="n">P</span><span class="p">[</span><span class="n">cart_prods</span><span class="p">[</span><span class="n">i</span><span class="p">][:,</span><span class="mi">0</span><span class="p">],</span><span class="n">cart_prods</span><span class="p">[</span><span class="n">i</span><span class="p">][:,</span><span class="mi">1</span><span class="p">]])</span> <span class="o">-</span> <span class="n">w</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="o">/</span><span class="n">w</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
    <span class="nb">print</span> <span class="s1">&#39;Bias 3:&#39;</span><span class="p">,</span><span class="n">bias_3</span>
    <span class="nb">print</span> <span class="s1">&#39;Check sum :&#39;</span><span class="p">,</span><span class="n">ri</span><span class="o">.</span><span class="n">sum</span><span class="p">(),</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">ci</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>

    <span class="n">dist</span><span class="o">=</span><span class="nb">sum</span><span class="p">(</span><span class="n">M</span><span class="o">*</span><span class="n">P</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">P</span><span class="p">,</span><span class="n">dist</span>


<span class="k">def</span> <span class="nf">beg_normalize</span><span class="p">(</span><span class="n">M</span><span class="p">,</span><span class="n">c</span><span class="p">,</span><span class="n">inf_val</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">beta</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span><span class="n">nb_iter</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span><span class="n">w1</span><span class="o">=</span><span class="mf">0.5</span><span class="p">):</span>
    <span class="n">w2</span> <span class="o">=</span> <span class="mi">1</span><span class="o">-</span><span class="n">w1</span>
    <span class="n">cin</span> <span class="o">=</span> <span class="n">c</span><span class="o">*</span><span class="p">(</span><span class="n">c</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">lambd</span> <span class="o">=</span> <span class="n">beta</span><span class="o">/</span><span class="n">M</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
    <span class="n">K</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="kc">None</span>
    <span class="k">if</span> <span class="n">inf_val</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">i</span><span class="p">,</span><span class="n">j</span> <span class="o">=</span> <span class="n">where</span><span class="p">(</span><span class="n">M</span><span class="o">==</span><span class="n">inf_val</span><span class="p">)</span>
        <span class="n">i0</span><span class="p">,</span><span class="n">j0</span> <span class="o">=</span> <span class="n">where</span><span class="p">(</span><span class="n">M</span><span class="o">&lt;</span><span class="n">inf_val</span><span class="p">)</span>
        <span class="n">Mtemp</span> <span class="o">=</span> <span class="n">M</span><span class="p">[</span><span class="n">i0</span><span class="p">,</span><span class="n">j0</span><span class="p">]</span>
        <span class="n">lambd</span> <span class="o">=</span> <span class="n">beta</span><span class="o">/</span><span class="n">Mtemp</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>

    <span class="n">K</span> <span class="o">=</span> <span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">lambd</span><span class="o">*</span><span class="n">M</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">inf_val</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">K</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="n">P</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">K</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_iter</span><span class="p">):</span>
        <span class="n">P1</span> <span class="o">=</span> <span class="n">P</span><span class="o">/</span><span class="n">P</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="n">P2</span> <span class="o">=</span> <span class="n">kl_marg_proj</span><span class="p">(</span><span class="n">P</span><span class="p">,</span><span class="n">cin</span><span class="p">)</span>
        <span class="n">P</span> <span class="o">=</span> <span class="p">(</span><span class="n">P1</span><span class="o">**</span><span class="n">w1</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">P2</span><span class="o">**</span><span class="n">w2</span><span class="p">)</span>
        <span class="n">ci</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">P</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">ci</span> <span class="o">=</span> <span class="n">ci</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">size</span><span class="p">(</span><span class="n">ci</span><span class="p">),</span><span class="mi">1</span><span class="p">))</span>
        <span class="nb">print</span> <span class="s1">&#39;Bias normalization:&#39;</span><span class="p">,((</span><span class="n">cin</span><span class="o">-</span><span class="n">ci</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">/</span><span class="p">(</span><span class="n">c</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>

    <span class="n">dist</span><span class="o">=</span><span class="nb">sum</span><span class="p">(</span><span class="n">M</span><span class="o">*</span><span class="n">P</span><span class="p">)</span>
    <span class="n">proj</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">P1</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">proj</span><span class="p">,</span><span class="n">P</span><span class="p">,</span><span class="n">dist</span>


<span class="k">def</span> <span class="nf">beg_proj_transp_rw</span><span class="p">(</span><span class="n">M</span><span class="p">,</span><span class="n">r</span><span class="p">,</span><span class="n">c</span><span class="p">,</span><span class="n">inf_val</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">beta</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span><span class="n">nb_iter</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span><span class="n">nb_rw</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">nw</span><span class="o">=</span><span class="mi">3</span><span class="p">):</span>
    <span class="n">max_num_exp</span> <span class="o">=</span> <span class="mi">2000</span>
    <span class="n">lambd</span> <span class="o">=</span> <span class="n">beta</span><span class="o">/</span><span class="n">M</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
    <span class="n">K</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="kc">None</span>
    <span class="n">Mtemp</span><span class="o">=</span><span class="kc">None</span>
    <span class="k">if</span> <span class="n">inf_val</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">i</span><span class="p">,</span><span class="n">j</span> <span class="o">=</span> <span class="n">where</span><span class="p">(</span><span class="n">M</span><span class="o">==</span><span class="n">inf_val</span><span class="p">)</span>
        <span class="n">i0</span><span class="p">,</span><span class="n">j0</span> <span class="o">=</span> <span class="n">where</span><span class="p">(</span><span class="n">M</span><span class="o">&lt;</span><span class="n">inf_val</span><span class="p">)</span>
        <span class="n">Mtemp</span> <span class="o">=</span> <span class="n">M</span><span class="p">[</span><span class="n">i0</span><span class="p">,</span><span class="n">j0</span><span class="p">]</span>
        <span class="n">lambd</span> <span class="o">=</span> <span class="n">beta</span><span class="o">/</span><span class="n">Mtemp</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>

    <span class="n">K</span> <span class="o">=</span> <span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">lambd</span><span class="o">*</span><span class="n">M</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">inf_val</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">K</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="n">P</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">K</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_iter</span><span class="p">):</span>
        <span class="n">P</span> <span class="o">=</span> <span class="n">kl_marg_proj</span><span class="p">(</span><span class="n">P</span><span class="p">,</span><span class="n">c</span><span class="p">)</span>
        <span class="n">ci</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">P</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">ci</span> <span class="o">=</span> <span class="n">ci</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">size</span><span class="p">(</span><span class="n">ci</span><span class="p">),</span><span class="mi">1</span><span class="p">))</span>
        <span class="n">P</span> <span class="o">=</span> <span class="n">transpose</span><span class="p">(</span><span class="n">kl_marg_proj</span><span class="p">(</span><span class="n">transpose</span><span class="p">(</span><span class="n">P</span><span class="p">),</span><span class="n">r</span><span class="p">))</span>
        <span class="n">ri</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">P</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">ri</span> <span class="o">=</span> <span class="n">ri</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">size</span><span class="p">(</span><span class="n">ri</span><span class="p">),</span><span class="mi">1</span><span class="p">))</span>
        <span class="nb">print</span> <span class="s1">&#39;Bias 1:&#39;</span><span class="p">,((</span><span class="n">c</span><span class="o">-</span><span class="n">ci</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">/</span><span class="p">(</span><span class="n">c</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="nb">print</span> <span class="s1">&#39;Bias 2:&#39;</span><span class="p">,((</span><span class="n">r</span><span class="o">-</span><span class="n">ri</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">/</span><span class="p">(</span><span class="n">r</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="nb">print</span> <span class="s1">&#39;Check sum :&#39;</span><span class="p">,</span><span class="n">ri</span><span class="o">.</span><span class="n">sum</span><span class="p">(),</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">ci</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>

    <span class="n">dist</span><span class="o">=</span><span class="nb">sum</span><span class="p">(</span><span class="n">M</span><span class="o">*</span><span class="n">P</span><span class="p">)</span>
    <span class="n">Pw</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">P</span><span class="p">)</span>
    <span class="n">shap</span> <span class="o">=</span> <span class="n">Pw</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">maxw</span> <span class="o">=</span> <span class="n">max_num_exp</span><span class="o">/</span><span class="p">(</span><span class="n">Mtemp</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">*</span><span class="n">lambd</span><span class="p">)</span>
    <span class="nb">print</span> <span class="s2">&quot;maxw = &quot;</span><span class="p">,</span><span class="n">maxw</span><span class="p">,</span><span class="s2">&quot; M.max() = &quot;</span><span class="p">,</span><span class="n">Mtemp</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
    <span class="n">w</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_rw</span><span class="p">):</span>
        <span class="n">w</span> <span class="o">=</span> <span class="n">ones</span><span class="p">(</span><span class="n">shap</span><span class="p">)</span>
        <span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">)</span> <span class="o">=</span> <span class="n">where</span><span class="p">(</span><span class="n">Pw</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">n</span> <span class="o">=</span> <span class="n">size</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">n</span><span class="p">):</span>
            <span class="n">w1</span> <span class="o">=</span> <span class="n">Pw</span><span class="p">[</span><span class="n">i</span><span class="p">[</span><span class="n">m</span><span class="p">],:]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
            <span class="n">w2</span> <span class="o">=</span> <span class="n">Pw</span><span class="p">[:,</span><span class="n">j</span><span class="p">[</span><span class="n">m</span><span class="p">]]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
            <span class="n">w</span><span class="p">[</span><span class="n">i</span><span class="p">[</span><span class="n">m</span><span class="p">],</span><span class="n">j</span><span class="p">[</span><span class="n">m</span><span class="p">]]</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">scaling</span><span class="p">((</span><span class="n">w1</span><span class="o">-</span><span class="n">Pw</span><span class="p">[</span><span class="n">i</span><span class="p">[</span><span class="n">m</span><span class="p">],</span><span class="n">j</span><span class="p">[</span><span class="n">m</span><span class="p">]])</span><span class="o">/</span><span class="n">w1</span><span class="p">,</span><span class="n">nw</span><span class="p">,</span><span class="n">ainit</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">afinal</span><span class="o">=</span><span class="n">maxw</span><span class="p">)</span>
            <span class="c1">#print &quot;w1-Pw[i[m],j[m]])/w1,w[i[m],j[m]]&quot;,(w1-Pw[i[m],j[m]])/w1,w[i[m],j[m]]</span>
        <span class="n">Mw</span> <span class="o">=</span> <span class="n">M</span><span class="o">*</span><span class="n">w</span>
        <span class="n">num_pb</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">Kw</span> <span class="o">=</span> <span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">lambd</span><span class="o">*</span><span class="n">Mw</span><span class="p">)</span>
        <span class="n">Kwsym</span> <span class="o">=</span> <span class="p">(</span><span class="n">Kw</span><span class="o">+</span><span class="n">transpose</span><span class="p">(</span><span class="n">Kw</span><span class="p">))</span><span class="o">/</span><span class="mi">2</span>
        <span class="k">if</span> <span class="n">inf_val</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">i</span><span class="p">,</span><span class="n">j</span> <span class="o">=</span> <span class="n">where</span><span class="p">(</span><span class="n">M</span><span class="o">==</span><span class="n">inf_val</span><span class="p">)</span>
            <span class="n">Kw</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span><span class="o">=</span><span class="mi">0</span>
        <span class="n">count_max</span> <span class="o">=</span> <span class="n">floor</span><span class="p">(</span><span class="o">-</span><span class="n">log</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span><span class="o">/</span><span class="n">log</span><span class="p">(</span><span class="n">alpha</span><span class="p">))</span><span class="o">+</span><span class="mi">1</span>
        <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="sd">&quot;&quot;&quot;while (num_pb==True and count&lt;count_max):</span>
<span class="sd">            k1 = sum(Kw,axis=0)</span>
<span class="sd">            k2 = sum(Kw,axis=1)</span>
<span class="sd">            if prod(k1)==0 or prod(k2)==0:</span>
<span class="sd">                print &quot;Warning: static or isolated point(s); increasing entropy weight&quot;</span>
<span class="sd">                lambd=lambd*alpha</span>
<span class="sd">                Kw = exp(-lambd*Mw)</span>
<span class="sd">                if inf_val is not None:</span>
<span class="sd">                    Kw[i,j]=0</span>
<span class="sd">            else:</span>
<span class="sd">                num_pb = False</span>
<span class="sd">            count+=1</span>
<span class="sd">        print &quot;num_pb:&quot;, num_pb</span>
<span class="sd">        if count==count_max and num_pb==True:</span>
<span class="sd">            i,j = where(Kw==0)</span>
<span class="sd">            Kw[i,j] = K[i,j]&quot;&quot;&quot;</span>

        <span class="n">Pw</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">Kw</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">4</span><span class="o">*</span><span class="n">nb_iter</span><span class="p">):</span>
            <span class="n">Pw</span> <span class="o">=</span> <span class="n">kl_marg_proj</span><span class="p">(</span><span class="n">Pw</span><span class="p">,</span><span class="n">c</span><span class="p">)</span>
            <span class="n">ci</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">Pw</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">ci</span> <span class="o">=</span> <span class="n">ci</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">size</span><span class="p">(</span><span class="n">ci</span><span class="p">),</span><span class="mi">1</span><span class="p">))</span>
            <span class="n">Pw</span> <span class="o">=</span> <span class="n">transpose</span><span class="p">(</span><span class="n">kl_marg_proj</span><span class="p">(</span><span class="n">transpose</span><span class="p">(</span><span class="n">Pw</span><span class="p">),</span><span class="n">r</span><span class="p">))</span>
            <span class="n">ri</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">Pw</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">ri</span> <span class="o">=</span> <span class="n">ri</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">size</span><span class="p">(</span><span class="n">ri</span><span class="p">),</span><span class="mi">1</span><span class="p">))</span>
            <span class="nb">print</span> <span class="s1">&#39;Bias 1:&#39;</span><span class="p">,((</span><span class="n">c</span><span class="o">-</span><span class="n">ci</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">/</span><span class="p">(</span><span class="n">c</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
            <span class="nb">print</span> <span class="s1">&#39;Bias 2:&#39;</span><span class="p">,((</span><span class="n">r</span><span class="o">-</span><span class="n">ri</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">/</span><span class="p">(</span><span class="n">r</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
            <span class="nb">print</span> <span class="s1">&#39;Check sum :&#39;</span><span class="p">,</span><span class="n">ri</span><span class="o">.</span><span class="n">sum</span><span class="p">(),</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">ci</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>


    <span class="n">distw</span><span class="o">=</span><span class="nb">sum</span><span class="p">(</span><span class="n">Mw</span><span class="o">*</span><span class="n">Pw</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">P</span><span class="p">,</span><span class="n">Pw</span><span class="p">,</span><span class="n">dist</span><span class="p">,</span><span class="n">distw</span><span class="p">,</span><span class="n">w</span>


<span class="k">def</span> <span class="nf">wkl_cons_lag_comp</span><span class="p">(</span><span class="n">list_arg</span><span class="p">):</span>
    <span class="n">a</span> <span class="o">=</span> <span class="n">list_arg</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
    <span class="n">p</span> <span class="o">=</span> <span class="n">list_arg</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">lambd</span> <span class="o">=</span> <span class="n">list_arg</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">evl_pt</span> <span class="o">=</span> <span class="n">list_arg</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">i</span> <span class="o">=</span> <span class="n">where</span><span class="p">(</span><span class="n">lambd</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">output</span> <span class="o">=</span> <span class="p">((</span><span class="n">p</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">*</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="p">(</span><span class="n">lambd</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span><span class="o">*</span><span class="n">evl_pt</span><span class="p">))</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">-</span><span class="n">a</span><span class="p">)</span><span class="o">*</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">evl_pt</span><span class="o">/</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()))</span>
    <span class="k">return</span> <span class="n">output</span>

<span class="k">def</span> <span class="nf">der_wkl_cons_lag_comp</span><span class="p">(</span><span class="n">list_arg</span><span class="p">):</span>
    <span class="c1">#a = list_arg[3]</span>
    <span class="n">p</span> <span class="o">=</span> <span class="n">list_arg</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">lambd</span> <span class="o">=</span> <span class="n">list_arg</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">evl_pt</span> <span class="o">=</span> <span class="n">list_arg</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">i</span> <span class="o">=</span> <span class="n">where</span><span class="p">(</span><span class="n">lambd</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">output</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="p">(</span><span class="n">lambd</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span><span class="o">*</span><span class="n">p</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">*</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="p">(</span><span class="n">lambd</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span><span class="o">*</span><span class="n">evl_pt</span><span class="p">))</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">*</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">evl_pt</span><span class="o">/</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()))</span> <span class="o">-</span> <span class="p">((</span><span class="n">p</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span><span class="o">*</span><span class="n">wkl_cons_lag_comp</span><span class="p">(</span><span class="n">list_arg</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">output</span>

<span class="k">def</span> <span class="nf">newton_1d</span><span class="p">(</span><span class="n">fun</span><span class="p">,</span><span class="n">der_fun</span><span class="p">,</span><span class="nb">input</span><span class="p">,</span><span class="n">init</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_iter</span><span class="o">=</span><span class="mi">80</span><span class="p">,</span><span class="n">tol</span><span class="o">=</span><span class="mi">10</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mi">20</span><span class="p">)):</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">init</span>
    <span class="k">if</span> <span class="nb">input</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">&lt;</span><span class="n">tol</span><span class="p">:</span>
        <span class="k">return</span> <span class="mi">0</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_iter</span><span class="p">):</span>
            <span class="nb">input</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">x</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">x</span> <span class="o">-</span> <span class="n">fun</span><span class="p">(</span><span class="nb">input</span><span class="p">)</span><span class="o">/</span><span class="n">der_fun</span><span class="p">(</span><span class="nb">input</span><span class="p">)</span>
            <span class="sd">&quot;&quot;&quot;print &quot;weights sum &quot;,input[1].sum()</span>
<span class="sd">            print &quot;target val &quot;,input[3]</span>
<span class="sd">            print &quot;eval pt &quot;,input[0]&quot;&quot;&quot;</span>

    <span class="nb">print</span> <span class="s2">&quot;fun(input) &quot;</span><span class="p">,</span><span class="n">fun</span><span class="p">(</span><span class="nb">input</span><span class="p">)</span><span class="o">/</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">x</span><span class="o">/</span><span class="p">(</span><span class="nb">input</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()))</span>
<span class="c1">#print &quot;der_fun(input) &quot;,der_fun(input)</span>
    <span class="k">return</span> <span class="n">x</span>


<span class="k">def</span> <span class="nf">wkl_cons_lag_lines</span><span class="p">(</span><span class="n">P</span><span class="p">,</span><span class="n">Lambd</span><span class="p">,</span><span class="n">a</span><span class="p">):</span>
    <span class="n">shap</span> <span class="o">=</span> <span class="n">P</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">mu</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="mi">1</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
        <span class="n">list_arg</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="n">list_arg</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">list_arg</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">copy</span><span class="p">(</span><span class="n">P</span><span class="p">[</span><span class="n">i</span><span class="p">,:]))</span>
        <span class="n">list_arg</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">copy</span><span class="p">(</span><span class="n">Lambd</span><span class="p">[</span><span class="n">i</span><span class="p">,:]))</span>
        <span class="n">list_arg</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">a</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        <span class="n">mu</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">newton_1d</span><span class="p">(</span><span class="n">wkl_cons_lag_comp</span><span class="p">,</span><span class="n">der_wkl_cons_lag_comp</span><span class="p">,</span><span class="n">list_arg</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">mu</span>

<span class="k">def</span> <span class="nf">wkl_proj_lines</span><span class="p">(</span><span class="n">P</span><span class="p">,</span><span class="n">Lambd</span><span class="p">,</span><span class="n">a</span><span class="p">):</span>
    <span class="n">mu</span> <span class="o">=</span> <span class="n">wkl_cons_lag_lines</span><span class="p">(</span><span class="n">P</span><span class="p">,</span><span class="n">Lambd</span><span class="p">,</span><span class="n">a</span><span class="p">)</span>
    <span class="c1">#print &quot;sum(mu) &quot;,sum(mu)</span>
    <span class="n">shap</span> <span class="o">=</span> <span class="n">P</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">one_vect</span> <span class="o">=</span> <span class="n">ones</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
    <span class="n">Mu</span> <span class="o">=</span> <span class="n">mu</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">one_vect</span><span class="p">)</span>
    <span class="n">P_proj</span> <span class="o">=</span> <span class="mi">0</span><span class="o">*</span><span class="n">P</span>
    <span class="n">i</span><span class="p">,</span><span class="n">j</span> <span class="o">=</span> <span class="n">where</span><span class="p">(</span><span class="n">Lambd</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">P_proj</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">P</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span><span class="o">*</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">Mu</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span><span class="o">/</span><span class="n">Lambd</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">P_proj</span>


<span class="k">def</span> <span class="nf">beg_proj_transp_rw_2</span><span class="p">(</span><span class="n">M</span><span class="p">,</span><span class="n">r</span><span class="p">,</span><span class="n">c</span><span class="p">,</span><span class="n">inf_val</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">beta</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span><span class="n">nb_iter</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span><span class="n">nb_rw</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">nw</span><span class="o">=</span><span class="mi">9</span><span class="p">):</span>
    <span class="n">max_num_exp</span> <span class="o">=</span> <span class="mi">2000</span>
    <span class="n">lambd</span> <span class="o">=</span> <span class="n">beta</span><span class="o">/</span><span class="n">M</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
    <span class="n">K</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="kc">None</span>
    <span class="n">Mtemp</span><span class="o">=</span><span class="kc">None</span>
    <span class="k">if</span> <span class="n">inf_val</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">i</span><span class="p">,</span><span class="n">j</span> <span class="o">=</span> <span class="n">where</span><span class="p">(</span><span class="n">M</span><span class="o">==</span><span class="n">inf_val</span><span class="p">)</span>
        <span class="n">i0</span><span class="p">,</span><span class="n">j0</span> <span class="o">=</span> <span class="n">where</span><span class="p">(</span><span class="n">M</span><span class="o">&lt;</span><span class="n">inf_val</span><span class="p">)</span>
        <span class="n">Mtemp</span> <span class="o">=</span> <span class="n">M</span><span class="p">[</span><span class="n">i0</span><span class="p">,</span><span class="n">j0</span><span class="p">]</span>
        <span class="n">lambd</span> <span class="o">=</span> <span class="n">beta</span><span class="o">/</span><span class="n">Mtemp</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>

    <span class="n">K</span> <span class="o">=</span> <span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">lambd</span><span class="o">*</span><span class="n">M</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">inf_val</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">K</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="n">P</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">K</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_iter</span><span class="p">):</span>
        <span class="n">P</span> <span class="o">=</span> <span class="n">kl_marg_proj</span><span class="p">(</span><span class="n">P</span><span class="p">,</span><span class="n">c</span><span class="p">)</span>
        <span class="n">ci</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">P</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">ci</span> <span class="o">=</span> <span class="n">ci</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">size</span><span class="p">(</span><span class="n">ci</span><span class="p">),</span><span class="mi">1</span><span class="p">))</span>
        <span class="n">P</span> <span class="o">=</span> <span class="n">transpose</span><span class="p">(</span><span class="n">kl_marg_proj</span><span class="p">(</span><span class="n">transpose</span><span class="p">(</span><span class="n">P</span><span class="p">),</span><span class="n">r</span><span class="p">))</span>
        <span class="n">ri</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">P</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">ri</span> <span class="o">=</span> <span class="n">ri</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">size</span><span class="p">(</span><span class="n">ri</span><span class="p">),</span><span class="mi">1</span><span class="p">))</span>
        <span class="nb">print</span> <span class="s1">&#39;Bias 1:&#39;</span><span class="p">,((</span><span class="n">c</span><span class="o">-</span><span class="n">ci</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">/</span><span class="p">(</span><span class="n">c</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="nb">print</span> <span class="s1">&#39;Bias 2:&#39;</span><span class="p">,((</span><span class="n">r</span><span class="o">-</span><span class="n">ri</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">/</span><span class="p">(</span><span class="n">r</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="nb">print</span> <span class="s1">&#39;Check sum :&#39;</span><span class="p">,</span><span class="n">ri</span><span class="o">.</span><span class="n">sum</span><span class="p">(),</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">ci</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>

    <span class="n">dist</span><span class="o">=</span><span class="nb">sum</span><span class="p">(</span><span class="n">M</span><span class="o">*</span><span class="n">P</span><span class="p">)</span>
    <span class="n">Pw</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">P</span><span class="p">)</span>
    <span class="n">shap</span> <span class="o">=</span> <span class="n">Pw</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">minw</span> <span class="o">=</span> <span class="p">(</span><span class="n">Mtemp</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">*</span><span class="n">lambd</span><span class="p">)</span><span class="o">/</span><span class="n">max_num_exp</span>
    <span class="nb">print</span> <span class="s2">&quot;minw = &quot;</span><span class="p">,</span><span class="n">minw</span><span class="p">,</span><span class="s2">&quot; M.max() = &quot;</span><span class="p">,</span><span class="n">Mtemp</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
    <span class="n">w</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_rw</span><span class="p">):</span>
        <span class="n">w</span> <span class="o">=</span> <span class="n">ones</span><span class="p">(</span><span class="n">shap</span><span class="p">)</span>
        <span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">)</span> <span class="o">=</span> <span class="n">where</span><span class="p">(</span><span class="n">Pw</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">n</span> <span class="o">=</span> <span class="n">size</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">n</span><span class="p">):</span>
            <span class="n">w1</span> <span class="o">=</span> <span class="n">Pw</span><span class="p">[</span><span class="n">i</span><span class="p">[</span><span class="n">m</span><span class="p">],:]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
            <span class="n">w2</span> <span class="o">=</span> <span class="n">Pw</span><span class="p">[</span><span class="n">i</span><span class="p">[</span><span class="n">m</span><span class="p">],:]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
            <span class="n">w</span><span class="p">[</span><span class="n">i</span><span class="p">[</span><span class="n">m</span><span class="p">],</span><span class="n">j</span><span class="p">[</span><span class="n">m</span><span class="p">]]</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">scaling</span><span class="p">(((</span><span class="n">Pw</span><span class="p">[</span><span class="n">i</span><span class="p">[</span><span class="n">m</span><span class="p">],</span><span class="n">j</span><span class="p">[</span><span class="n">m</span><span class="p">]])</span><span class="o">-</span><span class="n">w1</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">w2</span><span class="o">-</span><span class="n">w1</span><span class="p">),</span><span class="n">nw</span><span class="p">,</span><span class="n">ainit</span><span class="o">=</span><span class="mf">0.999</span><span class="p">,</span><span class="n">afinal</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="c1">#print &quot;w1-Pw[i[m],j[m]])/w1,w[i[m],j[m]]&quot;,(w1-Pw[i[m],j[m]])/w1,w[i[m],j[m]]</span>

        <span class="n">num_pb</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">Kw</span> <span class="o">=</span> <span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">lambd</span><span class="o">*</span><span class="n">M</span><span class="o">/</span><span class="n">w</span><span class="p">)</span>
        <span class="nb">print</span> <span class="s2">&quot;min(w) &quot;</span><span class="p">,</span><span class="n">w</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span><span class="s2">&quot; max(w) &quot;</span><span class="p">,</span><span class="n">w</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
        <span class="c1">#Kwsym = (Kw+transpose(Kw))/2</span>
        <span class="k">if</span> <span class="n">inf_val</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">i</span><span class="p">,</span><span class="n">j</span> <span class="o">=</span> <span class="n">where</span><span class="p">(</span><span class="n">M</span><span class="o">==</span><span class="n">inf_val</span><span class="p">)</span>
            <span class="n">Kw</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span><span class="o">=</span><span class="mi">0</span>
        <span class="n">count_max</span> <span class="o">=</span> <span class="n">floor</span><span class="p">(</span><span class="o">-</span><span class="n">log</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span><span class="o">/</span><span class="n">log</span><span class="p">(</span><span class="n">alpha</span><span class="p">))</span><span class="o">+</span><span class="mi">1</span>
        <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="sd">&quot;&quot;&quot;while (num_pb==True and count&lt;count_max):</span>
<span class="sd">            k1 = sum(Kw,axis=0)</span>
<span class="sd">            k2 = sum(Kw,axis=1)</span>
<span class="sd">            if prod(k1)==0 or prod(k2)==0:</span>
<span class="sd">            print &quot;Warning: static or isolated point(s); increasing entropy weight&quot;</span>
<span class="sd">            lambd=lambd*alpha</span>
<span class="sd">            Kw = exp(-lambd*Mw)</span>
<span class="sd">            if inf_val is not None:</span>
<span class="sd">            Kw[i,j]=0</span>
<span class="sd">            else:</span>
<span class="sd">            num_pb = False</span>
<span class="sd">            count+=1</span>
<span class="sd">            print &quot;num_pb:&quot;, num_pb</span>
<span class="sd">            if count==count_max and num_pb==True:</span>
<span class="sd">            i,j = where(Kw==0)</span>
<span class="sd">            Kw[i,j] = K[i,j]&quot;&quot;&quot;</span>

        <span class="n">Pw</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">Kw</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">4</span><span class="o">*</span><span class="n">nb_iter</span><span class="p">):</span>
            <span class="n">Pw</span> <span class="o">=</span> <span class="n">wkl_proj_lines</span><span class="p">(</span><span class="n">Pw</span><span class="p">,</span><span class="n">w</span><span class="p">,</span><span class="n">c</span><span class="p">)</span>
            <span class="n">ci</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">Pw</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">ci</span> <span class="o">=</span> <span class="n">ci</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">size</span><span class="p">(</span><span class="n">ci</span><span class="p">),</span><span class="mi">1</span><span class="p">))</span>
            <span class="n">Pw</span> <span class="o">=</span> <span class="n">transpose</span><span class="p">(</span><span class="n">wkl_proj_lines</span><span class="p">(</span><span class="n">transpose</span><span class="p">(</span><span class="n">Pw</span><span class="p">),</span><span class="n">transpose</span><span class="p">(</span><span class="n">w</span><span class="p">),</span><span class="n">r</span><span class="p">))</span>
            <span class="n">ri</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">Pw</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">ri</span> <span class="o">=</span> <span class="n">ri</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">size</span><span class="p">(</span><span class="n">ri</span><span class="p">),</span><span class="mi">1</span><span class="p">))</span>
            <span class="nb">print</span> <span class="s1">&#39;Bias 1:&#39;</span><span class="p">,((</span><span class="n">c</span><span class="o">-</span><span class="n">ci</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">/</span><span class="p">(</span><span class="n">c</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
            <span class="nb">print</span> <span class="s1">&#39;Bias 2:&#39;</span><span class="p">,((</span><span class="n">r</span><span class="o">-</span><span class="n">ri</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">/</span><span class="p">(</span><span class="n">r</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
            <span class="nb">print</span> <span class="s1">&#39;Check sum :&#39;</span><span class="p">,</span><span class="n">ri</span><span class="o">.</span><span class="n">sum</span><span class="p">(),</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">ci</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>

    <span class="n">distw</span><span class="o">=</span><span class="nb">sum</span><span class="p">(</span><span class="n">M</span><span class="o">*</span><span class="n">Pw</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">P</span><span class="p">,</span><span class="n">Pw</span><span class="p">,</span><span class="n">dist</span><span class="p">,</span><span class="n">distw</span><span class="p">,</span><span class="n">w</span>

<span class="k">def</span> <span class="nf">kl_capacity_proj</span><span class="p">(</span><span class="n">M</span><span class="p">,</span><span class="n">Mc</span><span class="p">):</span>
    <span class="n">proj</span> <span class="o">=</span> <span class="n">M</span>
    <span class="n">i</span><span class="p">,</span><span class="n">j</span> <span class="o">=</span> <span class="n">where</span><span class="p">(</span><span class="n">Mc</span><span class="o">&lt;</span><span class="n">M</span><span class="p">)</span>
    <span class="n">proj</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">Mc</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">proj</span>


<span class="k">def</span> <span class="nf">beg_proj_transp_rw_3</span><span class="p">(</span><span class="n">M</span><span class="p">,</span><span class="n">r</span><span class="p">,</span><span class="n">c</span><span class="p">,</span><span class="n">inf_val</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">beta</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span><span class="n">nb_iter</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span><span class="n">nb_rw</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">nw</span><span class="o">=</span><span class="mi">4</span><span class="p">):</span>
    <span class="n">max_num_exp</span> <span class="o">=</span> <span class="mi">2000</span>
    <span class="n">lambd</span> <span class="o">=</span> <span class="n">beta</span><span class="o">/</span><span class="n">M</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
    <span class="n">K</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="kc">None</span>
    <span class="n">Mtemp</span><span class="o">=</span><span class="kc">None</span>
    <span class="k">if</span> <span class="n">inf_val</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">i</span><span class="p">,</span><span class="n">j</span> <span class="o">=</span> <span class="n">where</span><span class="p">(</span><span class="n">M</span><span class="o">==</span><span class="n">inf_val</span><span class="p">)</span>
        <span class="n">i0</span><span class="p">,</span><span class="n">j0</span> <span class="o">=</span> <span class="n">where</span><span class="p">(</span><span class="n">M</span><span class="o">&lt;</span><span class="n">inf_val</span><span class="p">)</span>
        <span class="n">Mtemp</span> <span class="o">=</span> <span class="n">M</span><span class="p">[</span><span class="n">i0</span><span class="p">,</span><span class="n">j0</span><span class="p">]</span>
        <span class="n">lambd</span> <span class="o">=</span> <span class="n">beta</span><span class="o">/</span><span class="n">Mtemp</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>

    <span class="n">K</span> <span class="o">=</span> <span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">lambd</span><span class="o">*</span><span class="n">M</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">inf_val</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">K</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="n">P</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">K</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_iter</span><span class="p">):</span>
        <span class="n">P</span> <span class="o">=</span> <span class="n">kl_marg_proj</span><span class="p">(</span><span class="n">P</span><span class="p">,</span><span class="n">c</span><span class="p">)</span>
        <span class="n">P</span> <span class="o">=</span> <span class="n">transpose</span><span class="p">(</span><span class="n">kl_marg_proj</span><span class="p">(</span><span class="n">transpose</span><span class="p">(</span><span class="n">P</span><span class="p">),</span><span class="n">r</span><span class="p">))</span>
        <span class="n">ci</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">P</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">ci</span> <span class="o">=</span> <span class="n">ci</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">size</span><span class="p">(</span><span class="n">ci</span><span class="p">),</span><span class="mi">1</span><span class="p">))</span>
        <span class="n">ri</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">P</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">ri</span> <span class="o">=</span> <span class="n">ri</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">size</span><span class="p">(</span><span class="n">ri</span><span class="p">),</span><span class="mi">1</span><span class="p">))</span>
        <span class="nb">print</span> <span class="s1">&#39;Bias 1:&#39;</span><span class="p">,((</span><span class="n">c</span><span class="o">-</span><span class="n">ci</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">/</span><span class="p">(</span><span class="n">c</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="nb">print</span> <span class="s1">&#39;Bias 2:&#39;</span><span class="p">,((</span><span class="n">r</span><span class="o">-</span><span class="n">ri</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">/</span><span class="p">(</span><span class="n">r</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="nb">print</span> <span class="s1">&#39;Check sum :&#39;</span><span class="p">,</span><span class="n">ri</span><span class="o">.</span><span class="n">sum</span><span class="p">(),</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">ci</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>

    <span class="n">dist</span><span class="o">=</span><span class="nb">sum</span><span class="p">(</span><span class="n">M</span><span class="o">*</span><span class="n">P</span><span class="p">)</span>

    <span class="n">lamdb</span> <span class="o">=</span> <span class="n">lambd</span><span class="o">*</span><span class="mi">5</span>
    <span class="k">if</span> <span class="n">inf_val</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">i</span><span class="p">,</span><span class="n">j</span> <span class="o">=</span> <span class="n">where</span><span class="p">(</span><span class="n">M</span><span class="o">==</span><span class="n">inf_val</span><span class="p">)</span>
        <span class="n">i0</span><span class="p">,</span><span class="n">j0</span> <span class="o">=</span> <span class="n">where</span><span class="p">(</span><span class="n">M</span><span class="o">&lt;</span><span class="n">inf_val</span><span class="p">)</span>
        <span class="n">Mtemp</span> <span class="o">=</span> <span class="n">M</span><span class="p">[</span><span class="n">i0</span><span class="p">,</span><span class="n">j0</span><span class="p">]</span>
        <span class="n">lambd</span> <span class="o">=</span> <span class="n">beta</span><span class="o">/</span><span class="n">Mtemp</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>

    <span class="n">K</span> <span class="o">=</span> <span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">lambd</span><span class="o">*</span><span class="n">M</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">inf_val</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">K</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">Pn</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">K</span><span class="p">)</span>
    <span class="n">shap</span> <span class="o">=</span> <span class="n">Pn</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">w</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="nb">print</span> <span class="s1">&#39; ------------- Reweighting ------------ &#39;</span>
    <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_rw</span><span class="p">):</span>
        <span class="n">w</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">(</span><span class="n">shap</span><span class="p">)</span>
        <span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">)</span> <span class="o">=</span> <span class="n">where</span><span class="p">(</span><span class="n">K</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">n</span> <span class="o">=</span> <span class="n">size</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">n</span><span class="p">):</span>
            <span class="n">w1</span> <span class="o">=</span> <span class="n">P</span><span class="p">[</span><span class="n">i</span><span class="p">[</span><span class="n">m</span><span class="p">],:]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
            <span class="n">w</span><span class="p">[</span><span class="n">i</span><span class="p">[</span><span class="n">m</span><span class="p">],</span><span class="n">j</span><span class="p">[</span><span class="n">m</span><span class="p">]]</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">scaling_2</span><span class="p">((</span><span class="n">P</span><span class="p">[</span><span class="n">i</span><span class="p">[</span><span class="n">m</span><span class="p">],</span><span class="n">j</span><span class="p">[</span><span class="n">m</span><span class="p">]])</span><span class="o">/</span><span class="n">w1</span><span class="p">,</span><span class="n">nw</span><span class="p">,</span><span class="n">ainit</span><span class="o">=</span><span class="n">P</span><span class="p">[</span><span class="n">i</span><span class="p">[</span><span class="n">m</span><span class="p">],:]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">/</span><span class="mi">20</span><span class="p">,</span><span class="n">afinal</span><span class="o">=</span><span class="n">P</span><span class="p">[</span><span class="n">i</span><span class="p">[</span><span class="n">m</span><span class="p">],:]</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span>
        <span class="n">qn</span> <span class="o">=</span> <span class="n">ones</span><span class="p">(</span><span class="n">shap</span><span class="p">)</span>
        <span class="n">qn_1</span> <span class="o">=</span> <span class="n">ones</span><span class="p">(</span><span class="n">shap</span><span class="p">)</span>
        <span class="n">qn_2</span> <span class="o">=</span> <span class="n">ones</span><span class="p">(</span><span class="n">shap</span><span class="p">)</span>
        <span class="c1">#nb_iter=1</span>
        <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_iter</span><span class="p">):</span>
            <span class="n">Pn_1</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">Pn</span><span class="p">)</span>
            <span class="n">Pn</span> <span class="o">=</span> <span class="n">kl_marg_proj</span><span class="p">(</span><span class="n">Pn_1</span><span class="o">*</span><span class="n">qn_2</span><span class="p">,</span><span class="n">c</span><span class="p">)</span>
            <span class="n">l</span><span class="p">,</span><span class="n">m</span> <span class="o">=</span> <span class="n">where</span><span class="p">(</span><span class="n">Pn</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">qn_2</span><span class="p">[</span><span class="n">l</span><span class="p">,</span><span class="n">m</span><span class="p">]</span> <span class="o">=</span> <span class="n">qn_2</span><span class="p">[</span><span class="n">l</span><span class="p">,</span><span class="n">m</span><span class="p">]</span><span class="o">*</span><span class="n">Pn_1</span><span class="p">[</span><span class="n">l</span><span class="p">,</span><span class="n">m</span><span class="p">]</span><span class="o">/</span><span class="n">Pn</span><span class="p">[</span><span class="n">l</span><span class="p">,</span><span class="n">m</span><span class="p">]</span>

            <span class="n">Pn_1</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">Pn</span><span class="p">)</span>
            <span class="n">Pn</span> <span class="o">=</span> <span class="n">transpose</span><span class="p">(</span><span class="n">kl_marg_proj</span><span class="p">(</span><span class="n">transpose</span><span class="p">(</span><span class="n">Pn_1</span><span class="o">*</span><span class="n">qn_1</span><span class="p">),</span><span class="n">r</span><span class="p">))</span>
            <span class="n">l</span><span class="p">,</span><span class="n">m</span> <span class="o">=</span> <span class="n">where</span><span class="p">(</span><span class="n">Pn</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">qn_1</span><span class="p">[</span><span class="n">l</span><span class="p">,</span><span class="n">m</span><span class="p">]</span> <span class="o">=</span> <span class="n">qn_1</span><span class="p">[</span><span class="n">l</span><span class="p">,</span><span class="n">m</span><span class="p">]</span><span class="o">*</span><span class="n">Pn_1</span><span class="p">[</span><span class="n">l</span><span class="p">,</span><span class="n">m</span><span class="p">]</span><span class="o">/</span><span class="n">Pn</span><span class="p">[</span><span class="n">l</span><span class="p">,</span><span class="n">m</span><span class="p">]</span>
            <span class="c1">#qn_1 = copy(q1_n)</span>
            <span class="c1">#qn = copy(q2_n)</span>


            <span class="n">Pn_1</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">Pn</span><span class="p">)</span>
            <span class="n">Pn</span> <span class="o">=</span> <span class="n">kl_capacity_proj</span><span class="p">(</span><span class="n">Pn_1</span><span class="o">*</span><span class="n">qn</span><span class="p">,</span><span class="n">w</span><span class="p">)</span>
            <span class="n">l</span><span class="p">,</span><span class="n">m</span> <span class="o">=</span> <span class="n">where</span><span class="p">(</span><span class="n">Pn</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">qn</span><span class="p">[</span><span class="n">l</span><span class="p">,</span><span class="n">m</span><span class="p">]</span> <span class="o">=</span> <span class="n">qn</span><span class="p">[</span><span class="n">l</span><span class="p">,</span><span class="n">m</span><span class="p">]</span><span class="o">*</span><span class="n">Pn_1</span><span class="p">[</span><span class="n">l</span><span class="p">,</span><span class="n">m</span><span class="p">]</span><span class="o">/</span><span class="n">Pn</span><span class="p">[</span><span class="n">l</span><span class="p">,</span><span class="n">m</span><span class="p">]</span>

            <span class="n">ci</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">Pn</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">ci</span> <span class="o">=</span> <span class="n">ci</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">size</span><span class="p">(</span><span class="n">ci</span><span class="p">),</span><span class="mi">1</span><span class="p">))</span>

            <span class="n">ri</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">Pn</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">ri</span> <span class="o">=</span> <span class="n">ri</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">size</span><span class="p">(</span><span class="n">ri</span><span class="p">),</span><span class="mi">1</span><span class="p">))</span>

            <span class="nb">print</span> <span class="s1">&#39;Bias 1:&#39;</span><span class="p">,((</span><span class="n">c</span><span class="o">-</span><span class="n">ci</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">/</span><span class="p">(</span><span class="n">c</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
            <span class="nb">print</span> <span class="s1">&#39;Bias 2:&#39;</span><span class="p">,((</span><span class="n">r</span><span class="o">-</span><span class="n">ri</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">/</span><span class="p">(</span><span class="n">r</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
            <span class="nb">print</span> <span class="s1">&#39;Check sum :&#39;</span><span class="p">,</span><span class="n">ri</span><span class="o">.</span><span class="n">sum</span><span class="p">(),</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">ci</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>

    <span class="n">distw</span><span class="o">=</span><span class="nb">sum</span><span class="p">(</span><span class="n">M</span><span class="o">*</span><span class="n">Pn</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">P</span><span class="p">,</span><span class="n">Pn</span><span class="p">,</span><span class="n">dist</span><span class="p">,</span><span class="n">distw</span><span class="p">,</span><span class="n">w</span>


<span class="k">def</span> <span class="nf">beg_proj_transp_capacity</span><span class="p">(</span><span class="n">M</span><span class="p">,</span><span class="n">Pmax</span><span class="p">,</span><span class="n">c</span><span class="p">,</span><span class="n">inf_val</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">beta</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span><span class="n">nb_iter</span><span class="o">=</span><span class="mi">100</span><span class="p">):</span>
    <span class="n">max_num_exp</span> <span class="o">=</span> <span class="mi">2000</span>
    <span class="n">lambd</span> <span class="o">=</span> <span class="n">beta</span><span class="o">/</span><span class="n">M</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
    <span class="n">K</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="kc">None</span>
    <span class="n">Mtemp</span><span class="o">=</span><span class="kc">None</span>
    <span class="k">if</span> <span class="n">inf_val</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">i</span><span class="p">,</span><span class="n">j</span> <span class="o">=</span> <span class="n">where</span><span class="p">(</span><span class="n">M</span><span class="o">==</span><span class="n">inf_val</span><span class="p">)</span>
        <span class="n">i0</span><span class="p">,</span><span class="n">j0</span> <span class="o">=</span> <span class="n">where</span><span class="p">(</span><span class="n">M</span><span class="o">&lt;</span><span class="n">inf_val</span><span class="p">)</span>
        <span class="n">Mtemp</span> <span class="o">=</span> <span class="n">M</span><span class="p">[</span><span class="n">i0</span><span class="p">,</span><span class="n">j0</span><span class="p">]</span>
        <span class="n">lambd</span> <span class="o">=</span> <span class="n">beta</span><span class="o">/</span><span class="n">Mtemp</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>

    <span class="n">K</span> <span class="o">=</span> <span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">lambd</span><span class="o">*</span><span class="n">M</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">inf_val</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">K</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>


    <span class="n">K</span> <span class="o">=</span> <span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">lambd</span><span class="o">*</span><span class="n">M</span><span class="p">)</span>

    <span class="n">Pn</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">K</span><span class="p">)</span>
    <span class="n">shap</span> <span class="o">=</span> <span class="n">Pn</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">qn</span> <span class="o">=</span> <span class="n">ones</span><span class="p">(</span><span class="n">shap</span><span class="p">)</span>
    <span class="n">qn_1</span> <span class="o">=</span> <span class="n">ones</span><span class="p">(</span><span class="n">shap</span><span class="p">)</span>
    <span class="n">qn_2</span> <span class="o">=</span> <span class="n">ones</span><span class="p">(</span><span class="n">shap</span><span class="p">)</span>
    <span class="c1">#nb_iter=1</span>
    <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_iter</span><span class="p">):</span>
        <span class="n">Pn_1</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">Pn</span><span class="p">)</span>
        <span class="n">Pn</span> <span class="o">=</span> <span class="n">kl_marg_proj</span><span class="p">(</span><span class="n">Pn_1</span><span class="o">*</span><span class="n">qn_2</span><span class="p">,</span><span class="n">c</span><span class="p">)</span>
        <span class="n">l</span><span class="p">,</span><span class="n">m</span> <span class="o">=</span> <span class="n">where</span><span class="p">(</span><span class="n">Pn</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">qn_2</span><span class="p">[</span><span class="n">l</span><span class="p">,</span><span class="n">m</span><span class="p">]</span> <span class="o">=</span> <span class="n">qn_2</span><span class="p">[</span><span class="n">l</span><span class="p">,</span><span class="n">m</span><span class="p">]</span><span class="o">*</span><span class="n">Pn_1</span><span class="p">[</span><span class="n">l</span><span class="p">,</span><span class="n">m</span><span class="p">]</span><span class="o">/</span><span class="n">Pn</span><span class="p">[</span><span class="n">l</span><span class="p">,</span><span class="n">m</span><span class="p">]</span>

        <span class="c1">#Pn_1 = copy(Pn)</span>
        <span class="c1">#Pn = transpose(kl_marg_proj(transpose(Pn_1*qn_1),r))</span>
        <span class="c1">#l,m = where(Pn&gt;0)</span>
        <span class="c1">#qn_1[l,m] = qn_1[l,m]*Pn_1[l,m]/Pn[l,m]</span>
        <span class="c1">#qn_1 = copy(q1_n)</span>
        <span class="c1">#qn = copy(q2_n)</span>


        <span class="n">Pn_1</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">Pn</span><span class="p">)</span>
        <span class="n">Pn</span> <span class="o">=</span> <span class="n">kl_capacity_proj</span><span class="p">(</span><span class="n">Pn_1</span><span class="o">*</span><span class="n">qn</span><span class="p">,</span><span class="n">Pmax</span><span class="p">)</span>
        <span class="n">l</span><span class="p">,</span><span class="n">m</span> <span class="o">=</span> <span class="n">where</span><span class="p">(</span><span class="n">Pn</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">qn</span><span class="p">[</span><span class="n">l</span><span class="p">,</span><span class="n">m</span><span class="p">]</span> <span class="o">=</span> <span class="n">qn</span><span class="p">[</span><span class="n">l</span><span class="p">,</span><span class="n">m</span><span class="p">]</span><span class="o">*</span><span class="n">Pn_1</span><span class="p">[</span><span class="n">l</span><span class="p">,</span><span class="n">m</span><span class="p">]</span><span class="o">/</span><span class="n">Pn</span><span class="p">[</span><span class="n">l</span><span class="p">,</span><span class="n">m</span><span class="p">]</span>

    <span class="n">ci</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">Pn</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">ci</span> <span class="o">=</span> <span class="n">ci</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">size</span><span class="p">(</span><span class="n">ci</span><span class="p">),</span><span class="mi">1</span><span class="p">))</span>

    <span class="nb">print</span> <span class="s1">&#39;Bias 1:&#39;</span><span class="p">,((</span><span class="n">c</span><span class="o">-</span><span class="n">ci</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">/</span><span class="p">(</span><span class="n">c</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    <span class="c1">#print &#39;Bias 2:&#39;,((r-ri)**2).sum()/(r**2).sum()</span>
    <span class="nb">print</span> <span class="s1">&#39;Check sum: &#39;</span><span class="p">,</span><span class="n">ci</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>


    <span class="n">interp</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">Pn</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">Pn</span><span class="p">,</span><span class="n">interp</span>


<span class="k">def</span> <span class="nf">beg_proj_transp_rw_4</span><span class="p">(</span><span class="n">M</span><span class="p">,</span><span class="n">r</span><span class="p">,</span><span class="n">c</span><span class="p">,</span><span class="n">inf_val</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">beta</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span><span class="n">nb_iter</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span><span class="n">nb_rw</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">nw</span><span class="o">=</span><span class="mi">4</span><span class="p">):</span>
    <span class="n">max_num_exp</span> <span class="o">=</span> <span class="mi">2000</span>
    <span class="n">lambd</span> <span class="o">=</span> <span class="n">beta</span><span class="o">/</span><span class="n">M</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
    <span class="n">K</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="kc">None</span>
    <span class="n">Mtemp</span><span class="o">=</span><span class="kc">None</span>
    <span class="k">if</span> <span class="n">inf_val</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">i</span><span class="p">,</span><span class="n">j</span> <span class="o">=</span> <span class="n">where</span><span class="p">(</span><span class="n">M</span><span class="o">==</span><span class="n">inf_val</span><span class="p">)</span>
        <span class="n">i0</span><span class="p">,</span><span class="n">j0</span> <span class="o">=</span> <span class="n">where</span><span class="p">(</span><span class="n">M</span><span class="o">&lt;</span><span class="n">inf_val</span><span class="p">)</span>
        <span class="n">Mtemp</span> <span class="o">=</span> <span class="n">M</span><span class="p">[</span><span class="n">i0</span><span class="p">,</span><span class="n">j0</span><span class="p">]</span>
        <span class="n">lambd</span> <span class="o">=</span> <span class="n">beta</span><span class="o">/</span><span class="n">Mtemp</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>

    <span class="n">K</span> <span class="o">=</span> <span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">lambd</span><span class="o">*</span><span class="n">M</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">inf_val</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">K</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="n">P</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">K</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_iter</span><span class="p">):</span>
        <span class="n">P</span> <span class="o">=</span> <span class="n">kl_marg_proj</span><span class="p">(</span><span class="n">P</span><span class="p">,</span><span class="n">c</span><span class="p">)</span>
        <span class="n">P</span> <span class="o">=</span> <span class="n">transpose</span><span class="p">(</span><span class="n">kl_marg_proj</span><span class="p">(</span><span class="n">transpose</span><span class="p">(</span><span class="n">P</span><span class="p">),</span><span class="n">r</span><span class="p">))</span>
        <span class="n">ci</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">P</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">ci</span> <span class="o">=</span> <span class="n">ci</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">size</span><span class="p">(</span><span class="n">ci</span><span class="p">),</span><span class="mi">1</span><span class="p">))</span>
        <span class="n">ri</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">P</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">ri</span> <span class="o">=</span> <span class="n">ri</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">size</span><span class="p">(</span><span class="n">ri</span><span class="p">),</span><span class="mi">1</span><span class="p">))</span>
        <span class="nb">print</span> <span class="s1">&#39;Bias 1:&#39;</span><span class="p">,((</span><span class="n">c</span><span class="o">-</span><span class="n">ci</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">/</span><span class="p">(</span><span class="n">c</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="nb">print</span> <span class="s1">&#39;Bias 2:&#39;</span><span class="p">,((</span><span class="n">r</span><span class="o">-</span><span class="n">ri</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">/</span><span class="p">(</span><span class="n">r</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="nb">print</span> <span class="s1">&#39;Check sum :&#39;</span><span class="p">,</span><span class="n">ri</span><span class="o">.</span><span class="n">sum</span><span class="p">(),</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">ci</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>

    <span class="n">dist</span><span class="o">=</span><span class="nb">sum</span><span class="p">(</span><span class="n">M</span><span class="o">*</span><span class="n">P</span><span class="p">)</span>

    <span class="n">lamdb</span> <span class="o">=</span> <span class="n">lambd</span><span class="o">*</span><span class="mi">5</span>
    <span class="k">if</span> <span class="n">inf_val</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">i</span><span class="p">,</span><span class="n">j</span> <span class="o">=</span> <span class="n">where</span><span class="p">(</span><span class="n">M</span><span class="o">==</span><span class="n">inf_val</span><span class="p">)</span>
        <span class="n">i0</span><span class="p">,</span><span class="n">j0</span> <span class="o">=</span> <span class="n">where</span><span class="p">(</span><span class="n">M</span><span class="o">&lt;</span><span class="n">inf_val</span><span class="p">)</span>
        <span class="n">Mtemp</span> <span class="o">=</span> <span class="n">M</span><span class="p">[</span><span class="n">i0</span><span class="p">,</span><span class="n">j0</span><span class="p">]</span>
        <span class="n">lambd</span> <span class="o">=</span> <span class="n">beta</span><span class="o">/</span><span class="n">Mtemp</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>

    <span class="n">K</span> <span class="o">=</span> <span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">lambd</span><span class="o">*</span><span class="n">M</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">inf_val</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">K</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">Pn</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">K</span><span class="p">)</span>
    <span class="n">shap</span> <span class="o">=</span> <span class="n">Pn</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">w</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">r</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="nb">print</span> <span class="s1">&#39; ------------- Reweighting ------------ &#39;</span>
    <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_rw</span><span class="p">):</span>
        <span class="n">w</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">(</span><span class="n">shap</span><span class="p">)</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="mi">1</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
            <span class="n">i</span> <span class="o">=</span> <span class="n">where</span><span class="p">(</span><span class="n">w</span><span class="p">[</span><span class="n">m</span><span class="p">,:]</span><span class="o">==</span><span class="n">w</span><span class="p">[</span><span class="n">m</span><span class="p">,:]</span><span class="o">.</span><span class="n">max</span><span class="p">())</span>
            <span class="n">w</span><span class="p">[</span><span class="n">m</span><span class="p">,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">w</span><span class="p">[</span><span class="n">m</span><span class="p">,:]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>

            <span class="n">w</span><span class="p">[</span><span class="n">m</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">scaling_2</span><span class="p">((</span><span class="n">P</span><span class="p">[</span><span class="n">i</span><span class="p">[</span><span class="n">m</span><span class="p">],</span><span class="n">j</span><span class="p">[</span><span class="n">m</span><span class="p">]])</span><span class="o">/</span><span class="n">w1</span><span class="p">,</span><span class="n">nw</span><span class="p">,</span><span class="n">ainit</span><span class="o">=</span><span class="n">P</span><span class="p">[</span><span class="n">i</span><span class="p">[</span><span class="n">m</span><span class="p">],:]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">/</span><span class="mi">20</span><span class="p">,</span><span class="n">afinal</span><span class="o">=</span><span class="n">P</span><span class="p">[</span><span class="n">i</span><span class="p">[</span><span class="n">m</span><span class="p">],:]</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span>
        <span class="n">qn</span> <span class="o">=</span> <span class="n">ones</span><span class="p">(</span><span class="n">shap</span><span class="p">)</span>
        <span class="n">qn_1</span> <span class="o">=</span> <span class="n">ones</span><span class="p">(</span><span class="n">shap</span><span class="p">)</span>
        <span class="n">qn_2</span> <span class="o">=</span> <span class="n">ones</span><span class="p">(</span><span class="n">shap</span><span class="p">)</span>
        <span class="c1">#nb_iter=1</span>
        <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_iter</span><span class="p">):</span>
            <span class="n">Pn_1</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">Pn</span><span class="p">)</span>
            <span class="n">Pn</span> <span class="o">=</span> <span class="n">kl_marg_proj</span><span class="p">(</span><span class="n">Pn_1</span><span class="o">*</span><span class="n">qn_2</span><span class="p">,</span><span class="n">c</span><span class="p">)</span>
            <span class="n">l</span><span class="p">,</span><span class="n">m</span> <span class="o">=</span> <span class="n">where</span><span class="p">(</span><span class="n">Pn</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">qn_2</span><span class="p">[</span><span class="n">l</span><span class="p">,</span><span class="n">m</span><span class="p">]</span> <span class="o">=</span> <span class="n">qn_2</span><span class="p">[</span><span class="n">l</span><span class="p">,</span><span class="n">m</span><span class="p">]</span><span class="o">*</span><span class="n">Pn_1</span><span class="p">[</span><span class="n">l</span><span class="p">,</span><span class="n">m</span><span class="p">]</span><span class="o">/</span><span class="n">Pn</span><span class="p">[</span><span class="n">l</span><span class="p">,</span><span class="n">m</span><span class="p">]</span>

            <span class="n">Pn_1</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">Pn</span><span class="p">)</span>
            <span class="n">Pn</span> <span class="o">=</span> <span class="n">transpose</span><span class="p">(</span><span class="n">kl_marg_proj</span><span class="p">(</span><span class="n">transpose</span><span class="p">(</span><span class="n">Pn_1</span><span class="o">*</span><span class="n">qn_1</span><span class="p">),</span><span class="n">r</span><span class="p">))</span>
            <span class="n">l</span><span class="p">,</span><span class="n">m</span> <span class="o">=</span> <span class="n">where</span><span class="p">(</span><span class="n">Pn</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">qn_1</span><span class="p">[</span><span class="n">l</span><span class="p">,</span><span class="n">m</span><span class="p">]</span> <span class="o">=</span> <span class="n">qn_1</span><span class="p">[</span><span class="n">l</span><span class="p">,</span><span class="n">m</span><span class="p">]</span><span class="o">*</span><span class="n">Pn_1</span><span class="p">[</span><span class="n">l</span><span class="p">,</span><span class="n">m</span><span class="p">]</span><span class="o">/</span><span class="n">Pn</span><span class="p">[</span><span class="n">l</span><span class="p">,</span><span class="n">m</span><span class="p">]</span>
            <span class="c1">#qn_1 = copy(q1_n)</span>
            <span class="c1">#qn = copy(q2_n)</span>


            <span class="n">Pn_1</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">Pn</span><span class="p">)</span>
            <span class="n">Pn</span> <span class="o">=</span> <span class="n">kl_capacity_proj</span><span class="p">(</span><span class="n">Pn_1</span><span class="o">*</span><span class="n">qn</span><span class="p">,</span><span class="n">w</span><span class="p">)</span>
            <span class="n">l</span><span class="p">,</span><span class="n">m</span> <span class="o">=</span> <span class="n">where</span><span class="p">(</span><span class="n">Pn</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">qn</span><span class="p">[</span><span class="n">l</span><span class="p">,</span><span class="n">m</span><span class="p">]</span> <span class="o">=</span> <span class="n">qn</span><span class="p">[</span><span class="n">l</span><span class="p">,</span><span class="n">m</span><span class="p">]</span><span class="o">*</span><span class="n">Pn_1</span><span class="p">[</span><span class="n">l</span><span class="p">,</span><span class="n">m</span><span class="p">]</span><span class="o">/</span><span class="n">Pn</span><span class="p">[</span><span class="n">l</span><span class="p">,</span><span class="n">m</span><span class="p">]</span>

            <span class="n">ci</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">Pn</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">ci</span> <span class="o">=</span> <span class="n">ci</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">size</span><span class="p">(</span><span class="n">ci</span><span class="p">),</span><span class="mi">1</span><span class="p">))</span>

            <span class="n">ri</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">Pn</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">ri</span> <span class="o">=</span> <span class="n">ri</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">size</span><span class="p">(</span><span class="n">ri</span><span class="p">),</span><span class="mi">1</span><span class="p">))</span>

            <span class="nb">print</span> <span class="s1">&#39;Bias 1:&#39;</span><span class="p">,((</span><span class="n">c</span><span class="o">-</span><span class="n">ci</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">/</span><span class="p">(</span><span class="n">c</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
            <span class="nb">print</span> <span class="s1">&#39;Bias 2:&#39;</span><span class="p">,((</span><span class="n">r</span><span class="o">-</span><span class="n">ri</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">/</span><span class="p">(</span><span class="n">r</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
            <span class="nb">print</span> <span class="s1">&#39;Check sum :&#39;</span><span class="p">,</span><span class="n">ri</span><span class="o">.</span><span class="n">sum</span><span class="p">(),</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">ci</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>

    <span class="n">distw</span><span class="o">=</span><span class="nb">sum</span><span class="p">(</span><span class="n">M</span><span class="o">*</span><span class="n">Pn</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">P</span><span class="p">,</span><span class="n">Pn</span><span class="p">,</span><span class="n">dist</span><span class="p">,</span><span class="n">distw</span><span class="p">,</span><span class="n">w</span>

<span class="k">def</span> <span class="nf">beg_proj_transp_rw_4</span><span class="p">(</span><span class="n">M</span><span class="p">,</span><span class="n">r</span><span class="p">,</span><span class="n">c</span><span class="p">,</span><span class="n">corr_coeff</span><span class="p">,</span><span class="n">inf_val</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">beta</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span><span class="n">nb_iter</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span><span class="n">nb_rw</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">nw</span><span class="o">=</span><span class="mi">2</span><span class="p">):</span>
    <span class="n">max_num_exp</span> <span class="o">=</span> <span class="mi">2000</span>
    <span class="n">lambd</span> <span class="o">=</span> <span class="n">beta</span><span class="o">/</span><span class="n">M</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
    <span class="n">K</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="kc">None</span>
    <span class="n">Mtemp</span><span class="o">=</span><span class="kc">None</span>
    <span class="k">if</span> <span class="n">inf_val</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">i</span><span class="p">,</span><span class="n">j</span> <span class="o">=</span> <span class="n">where</span><span class="p">(</span><span class="n">M</span><span class="o">==</span><span class="n">inf_val</span><span class="p">)</span>
        <span class="n">i0</span><span class="p">,</span><span class="n">j0</span> <span class="o">=</span> <span class="n">where</span><span class="p">(</span><span class="n">M</span><span class="o">&lt;</span><span class="n">inf_val</span><span class="p">)</span>
        <span class="n">Mtemp</span> <span class="o">=</span> <span class="n">M</span><span class="p">[</span><span class="n">i0</span><span class="p">,</span><span class="n">j0</span><span class="p">]</span>
        <span class="n">lambd</span> <span class="o">=</span> <span class="n">beta</span><span class="o">/</span><span class="n">Mtemp</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>

    <span class="n">K</span> <span class="o">=</span> <span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">lambd</span><span class="o">*</span><span class="n">M</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">inf_val</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">K</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="n">P</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">K</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_iter</span><span class="p">):</span>
        <span class="n">P</span> <span class="o">=</span> <span class="n">kl_marg_proj</span><span class="p">(</span><span class="n">P</span><span class="p">,</span><span class="n">c</span><span class="p">)</span>
        <span class="n">P</span> <span class="o">=</span> <span class="n">transpose</span><span class="p">(</span><span class="n">kl_marg_proj</span><span class="p">(</span><span class="n">transpose</span><span class="p">(</span><span class="n">P</span><span class="p">),</span><span class="n">r</span><span class="p">))</span>
        <span class="n">ci</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">P</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">ci</span> <span class="o">=</span> <span class="n">ci</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">size</span><span class="p">(</span><span class="n">ci</span><span class="p">),</span><span class="mi">1</span><span class="p">))</span>
        <span class="n">ri</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">P</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">ri</span> <span class="o">=</span> <span class="n">ri</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">size</span><span class="p">(</span><span class="n">ri</span><span class="p">),</span><span class="mi">1</span><span class="p">))</span>
        <span class="nb">print</span> <span class="s1">&#39;Bias 1:&#39;</span><span class="p">,((</span><span class="n">c</span><span class="o">-</span><span class="n">ci</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">/</span><span class="p">(</span><span class="n">c</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="nb">print</span> <span class="s1">&#39;Bias 2:&#39;</span><span class="p">,((</span><span class="n">r</span><span class="o">-</span><span class="n">ri</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">/</span><span class="p">(</span><span class="n">r</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="nb">print</span> <span class="s1">&#39;Check sum :&#39;</span><span class="p">,</span><span class="n">ri</span><span class="o">.</span><span class="n">sum</span><span class="p">(),</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">ci</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>

    <span class="n">dist</span><span class="o">=</span><span class="nb">sum</span><span class="p">(</span><span class="n">M</span><span class="o">*</span><span class="n">P</span><span class="p">)</span>

<span class="c1">#lambd = lambd*5</span>
    <span class="k">if</span> <span class="n">inf_val</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">i</span><span class="p">,</span><span class="n">j</span> <span class="o">=</span> <span class="n">where</span><span class="p">(</span><span class="n">M</span><span class="o">==</span><span class="n">inf_val</span><span class="p">)</span>
        <span class="n">i0</span><span class="p">,</span><span class="n">j0</span> <span class="o">=</span> <span class="n">where</span><span class="p">(</span><span class="n">M</span><span class="o">&lt;</span><span class="n">inf_val</span><span class="p">)</span>
        <span class="n">Mtemp</span> <span class="o">=</span> <span class="n">M</span><span class="p">[</span><span class="n">i0</span><span class="p">,</span><span class="n">j0</span><span class="p">]</span>
        <span class="n">lambd</span> <span class="o">=</span> <span class="n">beta</span><span class="o">/</span><span class="n">Mtemp</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>

    <span class="n">K</span> <span class="o">=</span> <span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">lambd</span><span class="o">*</span><span class="n">M</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">inf_val</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">K</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">Pn</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">K</span><span class="p">)</span>
    <span class="n">shap</span> <span class="o">=</span> <span class="n">Pn</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">w</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">rad</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="nb">print</span> <span class="s1">&#39; ------------- Reweighting ------------ &#39;</span>
    <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_rw</span><span class="p">):</span>
        <span class="n">w</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">(</span><span class="n">shap</span><span class="p">)</span>
        <span class="n">rad</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="mi">1</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
            <span class="n">i</span> <span class="o">=</span> <span class="n">where</span><span class="p">(</span><span class="n">P</span><span class="p">[</span><span class="n">m</span><span class="p">,:]</span><span class="o">==</span><span class="n">P</span><span class="p">[</span><span class="n">m</span><span class="p">,:]</span><span class="o">.</span><span class="n">max</span><span class="p">())</span>
            <span class="n">w</span><span class="p">[</span><span class="n">m</span><span class="p">,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">P</span><span class="p">[</span><span class="n">m</span><span class="p">,:]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
            <span class="n">rmax</span> <span class="o">=</span> <span class="n">sqrt</span><span class="p">(((</span><span class="n">w</span><span class="p">[</span><span class="n">m</span><span class="p">,:]</span><span class="o">-</span><span class="n">P</span><span class="p">[</span><span class="n">m</span><span class="p">,:])</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span>
            <span class="n">rad</span><span class="p">[</span><span class="n">m</span><span class="p">]</span> <span class="o">=</span> <span class="n">rmax</span><span class="c1">#-utils.scaling_2(corr_coeff,nw,ainit=0,afinal=rmax)</span>

        <span class="n">qn</span> <span class="o">=</span> <span class="n">ones</span><span class="p">(</span><span class="n">shap</span><span class="p">)</span>
        <span class="n">qn_1</span> <span class="o">=</span> <span class="n">ones</span><span class="p">(</span><span class="n">shap</span><span class="p">)</span>
        <span class="n">qn_2</span> <span class="o">=</span> <span class="n">ones</span><span class="p">(</span><span class="n">shap</span><span class="p">)</span>
        <span class="c1">#nb_iter=1</span>
        <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_iter</span><span class="p">):</span>
            <span class="n">Pn_1</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">Pn</span><span class="p">)</span>
            <span class="n">Pn</span> <span class="o">=</span> <span class="n">kl_marg_proj</span><span class="p">(</span><span class="n">Pn_1</span><span class="o">*</span><span class="n">qn_2</span><span class="p">,</span><span class="n">c</span><span class="p">)</span>
            <span class="n">l</span><span class="p">,</span><span class="n">m</span> <span class="o">=</span> <span class="n">where</span><span class="p">(</span><span class="n">Pn</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">qn_2</span><span class="p">[</span><span class="n">l</span><span class="p">,</span><span class="n">m</span><span class="p">]</span> <span class="o">=</span> <span class="n">qn_2</span><span class="p">[</span><span class="n">l</span><span class="p">,</span><span class="n">m</span><span class="p">]</span><span class="o">*</span><span class="n">Pn_1</span><span class="p">[</span><span class="n">l</span><span class="p">,</span><span class="n">m</span><span class="p">]</span><span class="o">/</span><span class="n">Pn</span><span class="p">[</span><span class="n">l</span><span class="p">,</span><span class="n">m</span><span class="p">]</span>

            <span class="n">Pn_1</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">Pn</span><span class="p">)</span>
            <span class="n">Pn</span> <span class="o">=</span> <span class="n">transpose</span><span class="p">(</span><span class="n">kl_marg_proj</span><span class="p">(</span><span class="n">transpose</span><span class="p">(</span><span class="n">Pn_1</span><span class="o">*</span><span class="n">qn_1</span><span class="p">),</span><span class="n">r</span><span class="p">))</span>
            <span class="n">l</span><span class="p">,</span><span class="n">m</span> <span class="o">=</span> <span class="n">where</span><span class="p">(</span><span class="n">Pn</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">qn_1</span><span class="p">[</span><span class="n">l</span><span class="p">,</span><span class="n">m</span><span class="p">]</span> <span class="o">=</span> <span class="n">qn_1</span><span class="p">[</span><span class="n">l</span><span class="p">,</span><span class="n">m</span><span class="p">]</span><span class="o">*</span><span class="n">Pn_1</span><span class="p">[</span><span class="n">l</span><span class="p">,</span><span class="n">m</span><span class="p">]</span><span class="o">/</span><span class="n">Pn</span><span class="p">[</span><span class="n">l</span><span class="p">,</span><span class="n">m</span><span class="p">]</span>



            <span class="n">Pn_1</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">Pn</span><span class="p">)</span>
            <span class="c1">#Pn = kl_capacity_proj(Pn_1*qn,w)</span>
            <span class="n">Pn</span><span class="p">,</span><span class="n">bias3</span> <span class="o">=</span> <span class="n">kl_proj_sphere_mat</span><span class="p">(</span><span class="n">Pn_1</span><span class="o">*</span><span class="n">qn</span><span class="p">,</span><span class="n">w</span><span class="p">,</span><span class="n">rad</span><span class="p">)</span>
            <span class="n">l</span><span class="p">,</span><span class="n">m</span> <span class="o">=</span> <span class="n">where</span><span class="p">(</span><span class="n">Pn</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">qn</span><span class="p">[</span><span class="n">l</span><span class="p">,</span><span class="n">m</span><span class="p">]</span> <span class="o">=</span> <span class="n">qn</span><span class="p">[</span><span class="n">l</span><span class="p">,</span><span class="n">m</span><span class="p">]</span><span class="o">*</span><span class="n">Pn_1</span><span class="p">[</span><span class="n">l</span><span class="p">,</span><span class="n">m</span><span class="p">]</span><span class="o">/</span><span class="n">Pn</span><span class="p">[</span><span class="n">l</span><span class="p">,</span><span class="n">m</span><span class="p">]</span>

            <span class="n">ci</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">Pn</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">ci</span> <span class="o">=</span> <span class="n">ci</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">size</span><span class="p">(</span><span class="n">ci</span><span class="p">),</span><span class="mi">1</span><span class="p">))</span>

            <span class="n">ri</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">Pn</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">ri</span> <span class="o">=</span> <span class="n">ri</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">size</span><span class="p">(</span><span class="n">ri</span><span class="p">),</span><span class="mi">1</span><span class="p">))</span>

            <span class="nb">print</span> <span class="s1">&#39;Bias 1: &#39;</span><span class="p">,((</span><span class="n">c</span><span class="o">-</span><span class="n">ci</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">/</span><span class="p">(</span><span class="n">c</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
            <span class="nb">print</span> <span class="s1">&#39;Bias 2: &#39;</span><span class="p">,((</span><span class="n">r</span><span class="o">-</span><span class="n">ri</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">/</span><span class="p">(</span><span class="n">r</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
            <span class="nb">print</span> <span class="s1">&#39;Bias 3: &#39;</span><span class="p">,</span><span class="n">bias3</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
            <span class="nb">print</span> <span class="s1">&#39;Check sum :&#39;</span><span class="p">,</span><span class="n">r</span><span class="o">.</span><span class="n">sum</span><span class="p">(),</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">ci</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>

    <span class="n">distw</span><span class="o">=</span><span class="nb">sum</span><span class="p">(</span><span class="n">M</span><span class="o">*</span><span class="n">Pn</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">P</span><span class="p">,</span><span class="n">Pn</span><span class="p">,</span><span class="n">dist</span><span class="p">,</span><span class="n">distw</span><span class="p">,</span><span class="n">w</span><span class="p">,</span><span class="n">rad</span><span class="p">,</span><span class="n">Pn_1</span><span class="o">*</span><span class="n">qn</span>


<span class="k">def</span> <span class="nf">multi_marg_proj</span><span class="p">(</span><span class="n">P</span><span class="p">,</span><span class="n">distribs</span><span class="p">):</span> <span class="c1"># Marginalizes over columns, marginal distributions correspond to distribs lines</span>
    <span class="n">shap</span> <span class="o">=</span> <span class="n">P</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">l</span> <span class="o">=</span> <span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">proj</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">P</span><span class="p">)</span>
    <span class="n">bias</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">l</span><span class="p">,))</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">l</span><span class="p">):</span>
        <span class="n">c</span> <span class="o">=</span> <span class="n">distribs</span><span class="p">[</span><span class="n">k</span><span class="p">,:]</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">size</span><span class="p">(</span><span class="n">distribs</span><span class="p">[</span><span class="n">k</span><span class="p">,:]),</span><span class="mi">1</span><span class="p">))</span>
        <span class="n">proj</span><span class="p">[:,:,</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">kl_marg_proj</span><span class="p">(</span><span class="n">P</span><span class="p">[:,:,</span><span class="n">k</span><span class="p">],</span><span class="n">c</span><span class="p">)</span>
        <span class="n">bias</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="nb">sum</span><span class="p">(</span><span class="n">proj</span><span class="p">[:,:,</span><span class="n">k</span><span class="p">],</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">-</span><span class="n">distribs</span><span class="p">[</span><span class="n">k</span><span class="p">,:])</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">/</span><span class="p">((</span><span class="n">distribs</span><span class="p">[</span><span class="n">k</span><span class="p">,:])</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">proj</span><span class="p">,</span><span class="n">bias</span>

<span class="k">def</span> <span class="nf">common_marg_proj</span><span class="p">(</span><span class="n">P</span><span class="p">,</span><span class="n">weights</span><span class="p">):</span> <span class="c1"># Common Marginal over columns</span>
    <span class="n">shap</span> <span class="o">=</span> <span class="n">P</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">geo_bar</span> <span class="o">=</span> <span class="n">ones</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">],))</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
        <span class="n">geo_bar</span> <span class="o">=</span> <span class="n">geo_bar</span><span class="o">*</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="n">P</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">],</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span><span class="o">**</span><span class="n">weights</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
    <span class="n">bias</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">],))</span>
    <span class="n">geo_bar_c</span> <span class="o">=</span> <span class="n">geo_bar</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">size</span><span class="p">(</span><span class="n">geo_bar</span><span class="p">),</span><span class="mi">1</span><span class="p">))</span>
    <span class="n">ones_vect</span> <span class="o">=</span> <span class="n">ones</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>
    <span class="n">geo_bar_in</span> <span class="o">=</span> <span class="n">transpose</span><span class="p">(</span><span class="n">geo_bar_c</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">ones_vect</span><span class="p">))</span>

    <span class="n">proj</span><span class="p">,</span><span class="n">bias</span> <span class="o">=</span> <span class="n">multi_marg_proj</span><span class="p">(</span><span class="n">P</span><span class="p">,</span><span class="n">geo_bar_in</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
        <span class="n">bias</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="nb">sum</span><span class="p">(</span><span class="n">proj</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">],</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">-</span><span class="n">geo_bar</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">/</span><span class="p">(</span><span class="n">geo_bar</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">proj</span><span class="p">,</span><span class="n">bias</span>

<span class="k">def</span> <span class="nf">beg_proj_transp_bar</span><span class="p">(</span><span class="n">dist_mats</span><span class="p">,</span><span class="n">distribs</span><span class="p">,</span><span class="n">weights</span><span class="p">,</span><span class="n">inf_val</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">beta</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span><span class="n">nb_iter</span><span class="o">=</span><span class="mi">20</span><span class="p">):</span>
    <span class="n">max_num_exp</span> <span class="o">=</span> <span class="mi">2000</span>
    <span class="n">lambd</span> <span class="o">=</span> <span class="n">beta</span><span class="o">/</span><span class="n">dist_mats</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
    <span class="n">K</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="kc">None</span>
    <span class="n">Mtemp</span><span class="o">=</span><span class="kc">None</span>
    <span class="k">if</span> <span class="n">inf_val</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span> <span class="o">=</span> <span class="n">where</span><span class="p">(</span><span class="n">dist_mats</span><span class="o">==</span><span class="n">inf_val</span><span class="p">)</span>
        <span class="n">i0</span><span class="p">,</span><span class="n">j0</span><span class="p">,</span><span class="n">k0</span> <span class="o">=</span> <span class="n">where</span><span class="p">(</span><span class="n">dist_mats</span><span class="o">&lt;</span><span class="n">inf_val</span><span class="p">)</span>
        <span class="n">Mtemp</span> <span class="o">=</span> <span class="n">dist_mats</span><span class="p">[</span><span class="n">i0</span><span class="p">,</span><span class="n">j0</span><span class="p">,</span><span class="n">k0</span><span class="p">]</span>
        <span class="n">lambd</span> <span class="o">=</span> <span class="n">beta</span><span class="o">/</span><span class="n">Mtemp</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>

    <span class="n">K</span> <span class="o">=</span> <span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">lambd</span><span class="o">*</span><span class="n">dist_mats</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">inf_val</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">K</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="n">P</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">K</span><span class="p">)</span>
    <span class="n">l</span> <span class="o">=</span> <span class="n">dist_mats</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">bias1</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">l</span><span class="p">,))</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_iter</span><span class="p">):</span>
        <span class="n">P</span><span class="p">,</span><span class="n">bias1</span> <span class="o">=</span> <span class="n">multi_marg_proj</span><span class="p">(</span><span class="n">P</span><span class="p">,</span><span class="n">distribs</span><span class="p">)</span>
        <span class="n">tP</span><span class="p">,</span><span class="n">bias2</span> <span class="o">=</span> <span class="n">common_marg_proj</span><span class="p">(</span><span class="n">utils</span><span class="o">.</span><span class="n">stack_transpose</span><span class="p">(</span><span class="n">P</span><span class="p">),</span><span class="n">weights</span><span class="p">)</span>
        <span class="n">P</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">stack_transpose</span><span class="p">(</span><span class="n">tP</span><span class="p">)</span>


    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">l</span><span class="p">):</span>
        <span class="n">bias1</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="nb">sum</span><span class="p">(</span><span class="n">P</span><span class="p">[:,:,</span><span class="n">k</span><span class="p">],</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">-</span><span class="n">distribs</span><span class="p">[</span><span class="n">k</span><span class="p">,:])</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">/</span><span class="p">((</span><span class="n">distribs</span><span class="p">[</span><span class="n">k</span><span class="p">,:])</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    <span class="nb">print</span> <span class="s1">&#39;Multimarg bias: &#39;</span><span class="p">,</span><span class="n">bias1</span>
    <span class="nb">print</span> <span class="s1">&#39;Common marg bias: &#39;</span><span class="p">,</span><span class="n">bias2</span>
    <span class="n">bar</span><span class="o">=</span><span class="nb">sum</span><span class="p">(</span><span class="n">P</span><span class="p">[:,:,</span><span class="mi">0</span><span class="p">],</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">P</span><span class="p">,</span><span class="n">bar</span>

<span class="k">def</span> <span class="nf">beg_proj_transp_bar_located</span><span class="p">(</span><span class="n">dist_mats</span><span class="p">,</span><span class="n">distribs</span><span class="p">,</span><span class="n">weights</span><span class="p">,</span><span class="n">target_pos</span><span class="p">,</span><span class="n">src_pos1</span><span class="p">,</span><span class="n">src_pos2</span><span class="p">,</span><span class="n">inf_val</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">beta</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span><span class="n">nb_iter</span><span class="o">=</span><span class="mi">20</span><span class="p">):</span>
    <span class="n">max_num_exp</span> <span class="o">=</span> <span class="mi">2000</span>
    <span class="n">lambd</span> <span class="o">=</span> <span class="n">beta</span><span class="o">/</span><span class="n">dist_mats</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
    <span class="c1">#print &quot;dist_mats.max(): &quot;,dist_mats.max()</span>
    <span class="n">shap</span> <span class="o">=</span> <span class="n">dist_mats</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">K</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="kc">None</span>
    <span class="n">Mtemp</span><span class="o">=</span><span class="kc">None</span>
    <span class="k">if</span> <span class="n">inf_val</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span> <span class="o">=</span> <span class="n">where</span><span class="p">(</span><span class="n">dist_mats</span><span class="o">==</span><span class="n">inf_val</span><span class="p">)</span>
        <span class="n">i0</span><span class="p">,</span><span class="n">j0</span><span class="p">,</span><span class="n">k0</span> <span class="o">=</span> <span class="n">where</span><span class="p">(</span><span class="n">dist_mats</span><span class="o">&lt;</span><span class="n">inf_val</span><span class="p">)</span>
        <span class="n">Mtemp</span> <span class="o">=</span> <span class="n">dist_mats</span><span class="p">[</span><span class="n">i0</span><span class="p">,</span><span class="n">j0</span><span class="p">,</span><span class="n">k0</span><span class="p">]</span>
        <span class="n">lambd</span> <span class="o">=</span> <span class="n">beta</span><span class="o">/</span><span class="n">Mtemp</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>

    <span class="n">K</span> <span class="o">=</span> <span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">lambd</span><span class="o">*</span><span class="n">dist_mats</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">inf_val</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">K</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="n">P</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">K</span><span class="p">)</span>
    <span class="n">l</span> <span class="o">=</span> <span class="n">dist_mats</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">bias1</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">l</span><span class="p">,))</span>

    <span class="c1"># Location contraint parameters</span>
    <span class="n">b</span> <span class="o">=</span> <span class="n">target_pos</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>
    <span class="n">A</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span><span class="n">size</span><span class="p">(</span><span class="n">src_pos1</span><span class="p">)))</span>
    <span class="n">A</span><span class="p">[</span><span class="mi">0</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">src_pos1</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">size</span><span class="p">(</span><span class="n">src_pos1</span><span class="p">),))</span>
    <span class="n">A</span><span class="p">[</span><span class="mi">1</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">src_pos2</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">size</span><span class="p">(</span><span class="n">src_pos2</span><span class="p">),))</span>
    <span class="n">xinit</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_iter</span><span class="p">):</span>



        <span class="n">tP</span><span class="p">,</span><span class="n">bias2</span> <span class="o">=</span> <span class="n">common_marg_proj</span><span class="p">(</span><span class="n">utils</span><span class="o">.</span><span class="n">stack_transpose</span><span class="p">(</span><span class="n">P</span><span class="p">),</span><span class="n">weights</span><span class="p">)</span>
        <span class="n">P</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">stack_transpose</span><span class="p">(</span><span class="n">tP</span><span class="p">)</span>

        <span class="c1"># Location constraint</span>
        <span class="n">lines_marg</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">P</span><span class="p">[:,:,</span><span class="mi">0</span><span class="p">],</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="mi">1</span><span class="p">))</span>
        <span class="n">pivot_loc</span> <span class="o">=</span> <span class="n">pos_lin_cons</span><span class="p">(</span><span class="n">A</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">lines_marg</span><span class="p">,</span><span class="n">xinit</span><span class="p">,</span><span class="n">nb_iter</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span><span class="n">tol</span><span class="o">=</span><span class="mf">1e-32</span><span class="p">,</span><span class="n">mu</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">xinit</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">pivot_loc</span><span class="p">)</span>
        <span class="n">pivn</span> <span class="o">=</span> <span class="n">pivot_loc</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">ones</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">])))</span>
        <span class="n">tP</span><span class="p">,</span><span class="n">bias2</span> <span class="o">=</span> <span class="n">multi_marg_proj</span><span class="p">(</span><span class="n">utils</span><span class="o">.</span><span class="n">stack_transpose</span><span class="p">(</span><span class="n">P</span><span class="p">),</span><span class="n">transpose</span><span class="p">(</span><span class="n">pivn</span><span class="p">))</span>
        <span class="n">P</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">stack_transpose</span><span class="p">(</span><span class="n">tP</span><span class="p">)</span>
        <span class="n">P</span><span class="p">,</span><span class="n">bias1</span> <span class="o">=</span> <span class="n">multi_marg_proj</span><span class="p">(</span><span class="n">P</span><span class="p">,</span><span class="n">distribs</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">l</span><span class="p">):</span>
            <span class="n">bias1</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="nb">sum</span><span class="p">(</span><span class="n">P</span><span class="p">[:,:,</span><span class="n">k</span><span class="p">],</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">-</span><span class="n">distribs</span><span class="p">[</span><span class="n">k</span><span class="p">,:])</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">/</span><span class="p">((</span><span class="n">distribs</span><span class="p">[</span><span class="n">k</span><span class="p">,:])</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
            <span class="n">bias2</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="nb">sum</span><span class="p">(</span><span class="n">P</span><span class="p">[:,:,</span><span class="n">k</span><span class="p">],</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">-</span><span class="nb">sum</span><span class="p">(</span><span class="n">P</span><span class="p">[:,:,</span><span class="mi">0</span><span class="p">],</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">/</span><span class="p">((</span><span class="nb">sum</span><span class="p">(</span><span class="n">P</span><span class="p">[:,:,</span><span class="n">k</span><span class="p">],</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="n">pos_err</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">A</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">pivot_loc</span><span class="p">)</span><span class="o">-</span><span class="n">b</span><span class="p">)</span>
    <span class="nb">print</span> <span class="s1">&#39;Multimarg bias: &#39;</span><span class="p">,</span><span class="n">bias1</span>
    <span class="nb">print</span> <span class="s1">&#39;Common marg bias: &#39;</span><span class="p">,</span><span class="n">bias2</span>
    <span class="nb">print</span> <span class="s1">&#39;Location error: &#39;</span><span class="p">,</span><span class="n">pos_err</span>

    <span class="n">bar</span><span class="o">=</span><span class="nb">sum</span><span class="p">(</span><span class="n">P</span><span class="p">[:,:,</span><span class="mi">0</span><span class="p">],</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">P</span><span class="p">,</span><span class="n">bar</span>


<span class="k">def</span> <span class="nf">beg_proj_transp_ptbar</span><span class="p">(</span><span class="n">dist_mat</span><span class="p">,</span><span class="n">next_mat</span><span class="p">,</span><span class="n">distribs</span><span class="p">,</span><span class="n">weights</span><span class="p">,</span><span class="n">inf_val</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">beta</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span><span class="n">nb_iter</span><span class="o">=</span><span class="mi">100</span><span class="p">):</span>
    <span class="n">shap</span> <span class="o">=</span> <span class="n">distribs</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">bar</span> <span class="o">=</span> <span class="n">distribs</span><span class="p">[</span><span class="mi">0</span><span class="p">,:]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">wbar</span> <span class="o">=</span> <span class="n">weights</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">wold</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
        <span class="n">distrib2</span> <span class="o">=</span> <span class="n">distribs</span><span class="p">[</span><span class="n">i</span><span class="p">,:]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">P</span><span class="p">,</span><span class="n">dist</span> <span class="o">=</span> <span class="n">beg_proj_transp</span><span class="p">(</span><span class="n">double</span><span class="p">(</span><span class="n">dist_mat</span><span class="p">),</span><span class="n">bar</span><span class="p">,</span><span class="n">distrib2</span><span class="p">,</span><span class="n">beta</span><span class="o">=</span><span class="n">beta</span><span class="p">,</span><span class="n">nb_iter</span><span class="o">=</span><span class="n">nb_iter</span><span class="p">)</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">weights</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">/</span><span class="p">(</span><span class="n">wbar</span><span class="o">+</span><span class="n">weights</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        <span class="n">bar</span> <span class="o">=</span> <span class="n">displacement_interp_graph</span><span class="p">(</span><span class="n">P</span><span class="p">,</span><span class="n">sqrt</span><span class="p">(</span><span class="n">dist_mat</span><span class="p">),</span><span class="n">next_mat</span><span class="p">,</span><span class="n">t</span><span class="p">)</span>
        <span class="n">wbar</span> <span class="o">=</span> <span class="n">wbar</span><span class="o">+</span><span class="n">weights</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">bar</span>

<span class="k">def</span> <span class="nf">graph_transport_ptbar</span><span class="p">(</span><span class="n">dist_mat</span><span class="p">,</span><span class="n">next_mat</span><span class="p">,</span><span class="n">graph_ind</span><span class="p">,</span><span class="n">S</span><span class="p">,</span><span class="n">target_feat</span><span class="p">,</span><span class="n">anchor_ind</span><span class="p">,</span><span class="n">nb_loops</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">tol</span><span class="o">=</span><span class="mf">0.001</span><span class="p">,</span><span class="n">lin_prog_en</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">beta</span><span class="o">=</span><span class="mi">60</span><span class="p">):</span> <span class="c1"># The distribution are in distribs columns;  they are assumed to be sorted in increasing order of distance to the target location of interpolation</span>
    <span class="n">nb_src</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">graph_ind</span><span class="p">)</span>
    <span class="n">starting_ind</span> <span class="o">=</span> <span class="n">graph_ind</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">target_ind</span> <span class="o">=</span> <span class="n">graph_ind</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">path</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">get_path</span><span class="p">(</span><span class="n">next_mat</span><span class="p">,</span><span class="n">starting_ind</span><span class="p">,</span><span class="n">target_ind</span><span class="p">)</span>
    <span class="n">ind_activ</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">path</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">,))</span>

    <span class="n">ind_activ</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">starting_ind</span>
    <span class="n">ind_activ</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">=</span> <span class="n">array</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>

    <span class="n">distrib_final</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">dist_mat</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="mi">1</span><span class="p">))</span>
    <span class="n">distrib_final</span><span class="p">[</span><span class="n">starting_ind</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">i</span><span class="o">=</span><span class="mi">0</span>
    <span class="n">err</span> <span class="o">=</span> <span class="mi">100</span>
    <span class="n">ind_activ</span> <span class="o">=</span> <span class="n">ind_activ</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
    <span class="n">l_ind_activ</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">ind_activ</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_loops</span><span class="p">):</span>
        <span class="k">while</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">nb_src</span><span class="o">-</span><span class="mi">1</span> <span class="ow">and</span> <span class="n">err</span> <span class="o">&gt;</span><span class="n">tol</span><span class="p">:</span>
            <span class="n">distrib_1</span> <span class="o">=</span> <span class="n">distrib_final</span><span class="p">[</span><span class="n">ind_activ</span><span class="p">]</span>
            <span class="n">distrib_2</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">distrib_1</span><span class="p">),</span><span class="mi">1</span><span class="p">))</span>
            <span class="n">distrib_2</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">dist_mat_in</span> <span class="o">=</span> <span class="n">dist_mat</span><span class="p">[</span><span class="n">ix_</span><span class="p">(</span><span class="n">ind_activ</span><span class="p">,</span><span class="n">ind_activ</span><span class="p">)]</span>
            <span class="k">if</span> <span class="n">lin_prog_en</span><span class="p">:</span>
                <span class="n">mapping</span><span class="p">,</span><span class="n">optim_res</span> <span class="o">=</span> <span class="n">lin_prog_transp</span><span class="p">(</span><span class="n">distrib_1</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">distrib_1</span><span class="p">),)),</span><span class="n">distrib_2</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">distrib_2</span><span class="p">),)),</span><span class="n">double</span><span class="p">(</span><span class="n">dist_mat_in</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">mapping</span><span class="p">,</span><span class="n">sinkh_dist</span> <span class="o">=</span> <span class="n">beg_proj_transp</span><span class="p">(</span><span class="n">double</span><span class="p">(</span><span class="n">dist_mat_in</span><span class="p">),</span><span class="n">distrib_1</span><span class="p">,</span><span class="n">distrib_2</span><span class="p">,</span><span class="n">inf_val</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">beta</span><span class="o">=</span><span class="n">beta</span><span class="p">,</span><span class="n">nb_iter</span><span class="o">=</span><span class="mi">50</span><span class="p">)</span>
            <span class="n">interp_opt</span><span class="p">,</span><span class="n">err</span> <span class="o">=</span> <span class="n">acc_displacement_interp_graph</span><span class="p">(</span><span class="n">mapping</span><span class="p">,</span><span class="n">dist_mat</span><span class="p">,</span><span class="n">next_mat</span><span class="p">,</span><span class="n">S</span><span class="p">,</span><span class="n">anchor_ind</span><span class="p">,</span><span class="n">target_feat</span><span class="p">,</span><span class="n">samp</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span><span class="n">tol</span><span class="o">=</span><span class="n">tol</span><span class="p">,</span><span class="n">nb_iter_max</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span><span class="n">ind_cv</span><span class="o">=</span><span class="n">ind_activ</span><span class="p">)</span>

            <span class="n">distrib_final</span> <span class="o">=</span> <span class="n">interp_opt</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">dist_mat</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="mi">1</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">l</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">nb_src</span><span class="o">-</span><span class="mi">2</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">ind_activ</span><span class="p">)):</span>

                        <span class="n">path</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">get_path</span><span class="p">(</span><span class="n">next_mat</span><span class="p">,</span><span class="n">ind_activ</span><span class="p">[</span><span class="n">k</span><span class="p">],</span><span class="n">graph_ind</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">2</span><span class="p">])</span>
                        <span class="k">for</span> <span class="n">z</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">path</span><span class="p">)):</span>
                            <span class="k">if</span> <span class="n">path</span><span class="p">[</span><span class="n">z</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">l_ind_activ</span><span class="p">:</span>
                                <span class="n">l_ind_activ</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">path</span><span class="p">[</span><span class="n">z</span><span class="p">])</span>
                <span class="n">ind_activ</span> <span class="o">=</span> <span class="n">array</span><span class="p">(</span><span class="n">l_ind_activ</span><span class="p">)</span>
                <span class="n">ind_activ</span> <span class="o">=</span> <span class="n">ind_activ</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
            <span class="n">i</span><span class="o">+=</span><span class="mi">1</span>

    <span class="n">Sout</span> <span class="o">=</span> <span class="n">S</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">distrib_final</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">Sout</span><span class="p">,</span><span class="n">distrib_final</span>


<span class="k">def</span> <span class="nf">displacement_interp_graph</span><span class="p">(</span><span class="n">P</span><span class="p">,</span><span class="n">geod_dist</span><span class="p">,</span><span class="n">next_mat</span><span class="p">,</span><span class="n">t</span><span class="p">,</span><span class="n">ind_cv</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="n">shap</span> <span class="o">=</span> <span class="n">P</span><span class="o">.</span><span class="n">shape</span>
    <span class="k">if</span> <span class="n">ind_cv</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">ind_cv</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">interpt</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">diag</span><span class="p">(</span><span class="n">geod_dist</span><span class="p">))</span><span class="o">*</span><span class="mi">0</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
            <span class="n">dist</span> <span class="o">=</span> <span class="n">geod_dist</span><span class="p">[</span><span class="n">ind_cv</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">ind_cv</span><span class="p">[</span><span class="n">j</span><span class="p">]]</span><span class="o">*</span><span class="n">t</span>
            <span class="k">if</span> <span class="n">P</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">i</span><span class="o">!=</span><span class="n">j</span><span class="p">:</span>
                    <span class="n">path</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">get_path</span><span class="p">(</span><span class="n">next_mat</span><span class="p">,</span><span class="n">ind_cv</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">ind_cv</span><span class="p">[</span><span class="n">j</span><span class="p">])</span>
                    <span class="n">dist_cur</span><span class="o">=</span> <span class="n">geod_dist</span><span class="p">[</span><span class="n">ind_cv</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">path</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
                    <span class="n">ind</span><span class="o">=</span><span class="mi">0</span>
                    <span class="k">while</span><span class="p">(</span><span class="n">dist_cur</span><span class="o">&lt;</span><span class="n">dist</span><span class="p">):</span>
                        <span class="n">ind</span><span class="o">+=</span><span class="mi">1</span>
                        <span class="n">dist_cur</span><span class="o">=</span> <span class="n">geod_dist</span><span class="p">[</span><span class="n">ind_cv</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">path</span><span class="p">[</span><span class="n">ind</span><span class="p">]]</span>
                    <span class="n">ind_1</span> <span class="o">=</span> <span class="n">ind_cv</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">ind</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
                        <span class="n">ind_1</span> <span class="o">=</span> <span class="n">path</span><span class="p">[</span><span class="n">ind</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                    <span class="n">delta</span> <span class="o">=</span> <span class="n">geod_dist</span><span class="p">[</span><span class="n">ind_1</span><span class="p">,</span><span class="n">path</span><span class="p">[</span><span class="n">ind</span><span class="p">]]</span>
                    <span class="n">deltat</span> <span class="o">=</span> <span class="n">dist</span> <span class="o">-</span> <span class="n">geod_dist</span><span class="p">[</span><span class="n">ind_cv</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">ind_1</span><span class="p">]</span>
                    <span class="n">w</span> <span class="o">=</span> <span class="n">deltat</span><span class="o">/</span><span class="n">delta</span>
                    <span class="c1">#print w,ind_1,path[ind]</span>
                    <span class="k">if</span> <span class="n">w</span><span class="o">&gt;</span><span class="mi">1</span> <span class="ow">or</span> <span class="n">w</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">:</span>
                        <span class="s2">&quot;warning: bug in displacement interpolation on the graph&quot;</span>
                    <span class="n">interpt</span><span class="p">[</span><span class="n">ind_1</span><span class="p">]</span><span class="o">+=</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">w</span><span class="p">)</span><span class="o">*</span><span class="n">P</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span>
                    <span class="n">interpt</span><span class="p">[</span><span class="n">path</span><span class="p">[</span><span class="n">ind</span><span class="p">]]</span><span class="o">+=</span><span class="n">w</span><span class="o">*</span><span class="n">P</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">interpt</span><span class="p">[</span><span class="n">ind_cv</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">=</span> <span class="n">P</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">i</span><span class="p">]</span>
    <span class="c1">#interpt = interpt.reshape((shap[0],1))</span>
    <span class="c1">#k = where(interpt&gt;0)</span>
    <span class="c1">#print k</span>
    <span class="k">return</span> <span class="n">interpt</span>

<span class="k">def</span> <span class="nf">displacement_interp_graph_samp</span><span class="p">(</span><span class="n">P</span><span class="p">,</span><span class="n">geod_dist</span><span class="p">,</span><span class="n">next_mat</span><span class="p">,</span><span class="n">t</span><span class="p">,</span><span class="n">ind_cv</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="n">nb_points</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
    <span class="n">shap</span> <span class="o">=</span> <span class="n">geod_dist</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">interpt</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">nb_points</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_points</span><span class="p">):</span>
        <span class="n">interpt</span><span class="p">[:,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">displacement_interp_graph</span><span class="p">(</span><span class="n">P</span><span class="p">,</span><span class="n">geod_dist</span><span class="p">,</span><span class="n">next_mat</span><span class="p">,</span><span class="n">t</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">ind_cv</span><span class="o">=</span><span class="n">ind_cv</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">interpt</span>

<span class="k">def</span> <span class="nf">acc_displacement_interp_graph</span><span class="p">(</span><span class="n">P</span><span class="p">,</span><span class="n">geod_dist</span><span class="p">,</span><span class="n">next_mat</span><span class="p">,</span><span class="n">S</span><span class="p">,</span><span class="n">anchor_ind</span><span class="p">,</span><span class="n">target_feat</span><span class="p">,</span><span class="n">samp</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span><span class="n">tol</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span><span class="n">nb_iter_max</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span><span class="n">ind_cv</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="n">range_ref</span> <span class="o">=</span> <span class="n">array</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">samp</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>
    <span class="n">ti</span> <span class="o">=</span> <span class="mf">0.</span>
    <span class="n">te</span> <span class="o">=</span> <span class="mf">1.</span>
    <span class="n">range_i</span> <span class="o">=</span> <span class="p">((</span><span class="n">te</span><span class="o">-</span><span class="n">ti</span><span class="p">)</span><span class="o">/</span><span class="n">samp</span><span class="p">)</span><span class="o">*</span><span class="n">range_ref</span> <span class="o">+</span><span class="n">ti</span>
    <span class="n">err</span> <span class="o">=</span> <span class="mi">100</span>
    <span class="n">nb_iter</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">ones_vect</span> <span class="o">=</span> <span class="n">ones</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span><span class="n">samp</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>
    <span class="n">target_feat_mat</span> <span class="o">=</span> <span class="n">target_feat</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">ones_vect</span><span class="p">)</span>
    <span class="n">interp_opt</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">while</span> <span class="n">err</span><span class="o">&gt;</span><span class="n">tol</span> <span class="ow">and</span> <span class="n">nb_iter</span><span class="o">&lt;</span><span class="n">nb_iter_max</span><span class="p">:</span>
        <span class="n">interpt</span> <span class="o">=</span> <span class="n">displacement_interp_graph_samp</span><span class="p">(</span><span class="n">P</span><span class="p">,</span><span class="n">geod_dist</span><span class="p">,</span><span class="n">next_mat</span><span class="p">,</span><span class="n">range_i</span><span class="p">,</span><span class="n">ind_cv</span><span class="o">=</span><span class="n">ind_cv</span><span class="p">)</span>
        <span class="n">target_interp</span> <span class="o">=</span> <span class="n">S</span><span class="p">[</span><span class="n">anchor_ind</span><span class="p">,:]</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">interpt</span><span class="p">)</span>
        <span class="n">err_sq</span> <span class="o">=</span> <span class="p">((</span><span class="n">target_interp</span> <span class="o">-</span> <span class="n">target_feat_mat</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">ind</span> <span class="o">=</span>   <span class="n">argsort</span><span class="p">(</span><span class="n">err_sq</span><span class="p">)</span>
        <span class="n">err</span> <span class="o">=</span> <span class="n">err_sq</span><span class="p">[</span><span class="n">ind</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">/</span><span class="nb">sum</span><span class="p">(</span><span class="n">target_feat</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">interp_opt</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">interpt</span><span class="p">[:,</span><span class="n">ind</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span>
        <span class="n">ti</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">range_i</span><span class="p">[</span><span class="n">ind</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span><span class="n">range_i</span><span class="p">[</span><span class="n">ind</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span>
        <span class="n">te</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">range_i</span><span class="p">[</span><span class="n">ind</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span><span class="n">range_i</span><span class="p">[</span><span class="n">ind</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span>
        <span class="c1">#print range_i</span>
        <span class="c1">#print &quot;ti, te, err&quot;,range_i[ind[0]],&quot; &quot;,range_i[ind[1]],&quot; &quot;,err,&quot; tol: &quot;,tol</span>
        <span class="c1">#print err_sq</span>
        <span class="n">range_i</span> <span class="o">=</span> <span class="p">((</span><span class="n">te</span><span class="o">-</span><span class="n">ti</span><span class="p">)</span><span class="o">/</span><span class="n">samp</span><span class="p">)</span><span class="o">*</span><span class="n">range_ref</span> <span class="o">+</span><span class="n">ti</span>
        <span class="n">nb_iter</span><span class="o">+=</span><span class="mi">1</span>
        <span class="c1">#print where(interp_opt&gt;0)</span>
    <span class="k">return</span> <span class="n">interp_opt</span><span class="p">,</span><span class="n">err</span>

<span class="k">def</span> <span class="nf">low_rank_deconv</span><span class="p">(</span><span class="n">im_stack</span><span class="p">,</span><span class="n">psf_stack</span><span class="p">,</span><span class="n">mu</span><span class="p">,</span><span class="n">ksig</span><span class="p">,</span><span class="n">nb_iter</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span><span class="n">nb_rw</span><span class="o">=</span><span class="mi">2</span><span class="p">):</span>
    <span class="n">shap</span> <span class="o">=</span> <span class="n">im_stack</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">w</span> <span class="o">=</span> <span class="n">ones</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">],))</span>
    <span class="n">mat_stack</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span> <span class="c1"># Images correspond to lines</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
        <span class="n">mat_stack</span><span class="p">[</span><span class="n">i</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">im_stack</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">],))</span>
    <span class="n">U</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">Vt</span> <span class="o">=</span> <span class="n">linalg</span><span class="o">.</span><span class="n">svd</span><span class="p">(</span><span class="n">mat_stack</span><span class="p">,</span><span class="n">full_matrices</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">sigma</span> <span class="o">=</span> <span class="n">s</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">/</span><span class="mi">2</span><span class="p">)]</span>
    <span class="c1">#n=max(shap0[0],shap0[1])</span>
    <span class="n">nu</span> <span class="o">=</span> <span class="n">ksig</span><span class="o">*</span><span class="n">sigma</span><span class="o">*</span><span class="n">ones</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">],))</span>
    <span class="n">lip_coeff</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">],))</span>
    <span class="n">psf_stack_adj</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">psf_stack</span><span class="p">)</span>
    <span class="n">psf_norm_2</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">],))</span>
    <span class="n">thresh_type</span><span class="o">=</span><span class="mi">1</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
        <span class="n">lip_coeff</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">psf_stack</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">])</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span><span class="o">**</span><span class="mi">2</span>
        <span class="n">psf_stack_adj</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">rot90</span><span class="p">(</span><span class="n">psf_stack</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">],</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">psf_norm_2</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">sqrt</span><span class="p">((</span><span class="n">psf_stack</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span>

    <span class="n">thresh_coeff</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">mu</span><span class="o">*</span><span class="n">psf_norm_2</span><span class="o">/</span><span class="n">lip_coeff</span><span class="p">)</span>
    <span class="n">nu</span> <span class="o">=</span> <span class="n">thresh_coeff</span><span class="o">*</span><span class="n">nu</span>
    <span class="n">grad</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">im_stack</span><span class="p">)</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">im_stack</span><span class="p">)</span>
    <span class="n">im_deconv</span> <span class="o">=</span> <span class="n">im_stack</span><span class="o">*</span><span class="mi">0</span>
    <span class="n">mat_deconv</span> <span class="o">=</span> <span class="n">mat_stack</span><span class="o">*</span><span class="mi">0</span>
    <span class="n">mse</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">nb_iter</span><span class="p">,))</span>

    <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_rw</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_iter</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
                <span class="n">res</span><span class="p">[:,:,</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">im_stack</span><span class="p">[:,:,</span><span class="n">k</span><span class="p">]</span><span class="o">-</span><span class="n">scisig</span><span class="o">.</span><span class="n">fftconvolve</span><span class="p">(</span><span class="n">im_deconv</span><span class="p">[:,:,</span><span class="n">k</span><span class="p">],</span><span class="n">psf_stack</span><span class="p">[:,:,</span><span class="n">k</span><span class="p">],</span><span class="n">mode</span><span class="o">=</span><span class="s1">&#39;same&#39;</span><span class="p">)</span>
                <span class="n">mse</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+=</span> <span class="p">(</span><span class="n">res</span><span class="p">[:,:,</span><span class="n">k</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
                <span class="n">grad</span><span class="p">[:,:,</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">scisig</span><span class="o">.</span><span class="n">convolve</span><span class="p">(</span><span class="n">res</span><span class="p">[:,:,</span><span class="n">k</span><span class="p">],</span><span class="n">psf_stack_adj</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">],</span><span class="n">mode</span><span class="o">=</span><span class="s1">&#39;same&#39;</span><span class="p">)</span>
            <span class="nb">print</span> <span class="n">mse</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="c1"># -------- Gradient step -------- #</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
                <span class="n">im_deconv</span><span class="p">[:,:,</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">im_deconv</span><span class="p">[:,:,</span><span class="n">k</span><span class="p">]</span> <span class="o">-</span> <span class="p">(</span><span class="n">mu</span><span class="o">/</span><span class="n">lip_coeff</span><span class="p">[</span><span class="n">k</span><span class="p">])</span><span class="o">*</span><span class="n">grad</span><span class="p">[:,:,</span><span class="n">k</span><span class="p">]</span>
                <span class="n">mat_deconv</span><span class="p">[</span><span class="n">k</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">im_deconv</span><span class="p">[:,:,</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">],))</span>

            <span class="c1"># ------ Low rank constraint ---- #</span>
            <span class="n">mat_deconv</span><span class="p">,</span><span class="n">si</span><span class="p">,</span><span class="n">U</span><span class="p">,</span><span class="n">Vt</span> <span class="o">=</span> <span class="n">nuc_norm_thresh</span><span class="p">(</span><span class="n">mat_deconv</span><span class="p">,</span><span class="n">nu</span><span class="o">*</span><span class="n">w</span><span class="p">,</span><span class="n">thresh_type</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
                <span class="n">im_deconv</span><span class="p">[:,:,</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">mat_deconv</span><span class="p">[</span><span class="n">k</span><span class="p">,:]</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
        <span class="n">U</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">Vt</span> <span class="o">=</span> <span class="n">linalg</span><span class="o">.</span><span class="n">svd</span><span class="p">(</span><span class="n">mat_deconv</span><span class="p">,</span><span class="n">full_matrices</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">w</span> <span class="o">=</span> <span class="mi">1</span><span class="o">/</span><span class="p">((</span><span class="n">s</span><span class="o">/</span><span class="p">(</span><span class="n">thresh_coeff</span><span class="o">*</span><span class="n">ksig</span><span class="o">*</span><span class="n">sigma</span><span class="p">))</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">im_deconv</span><span class="p">,</span><span class="n">mat_deconv</span><span class="p">,</span><span class="n">res</span>


<span class="k">def</span> <span class="nf">low_rank_sr</span><span class="p">(</span><span class="n">im_stack</span><span class="p">,</span><span class="n">mu</span><span class="p">,</span><span class="n">upfact</span><span class="p">,</span><span class="n">klambd</span><span class="p">,</span><span class="n">shifts</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">nb_iter</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span><span class="n">nb_rw</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">lanc_rad</span><span class="o">=</span><span class="mi">10</span><span class="p">):</span>
    <span class="n">shap</span> <span class="o">=</span> <span class="n">im_stack</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">w</span> <span class="o">=</span> <span class="n">ones</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">],))</span>
    <span class="n">mat_stack</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span> <span class="c1"># Images correspond to lines</span>
    <span class="k">if</span> <span class="n">shifts</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">shifts</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">shift_est</span><span class="p">(</span><span class="n">im_stack</span><span class="p">)</span><span class="o">*</span><span class="n">upfact</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
        <span class="n">mat_stack</span><span class="p">[</span><span class="n">i</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">im_stack</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">],))</span>
    <span class="n">U</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">Vt</span> <span class="o">=</span> <span class="n">linalg</span><span class="o">.</span><span class="n">svd</span><span class="p">(</span><span class="n">mat_stack</span><span class="p">,</span><span class="n">full_matrices</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

       <span class="c1">#n=max(shap0[0],shap0[1])</span>
    <span class="n">nu</span> <span class="o">=</span> <span class="n">klambd</span><span class="o">*</span><span class="n">s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">ones</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">],))</span>
    <span class="n">nu</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="mi">0</span>
    <span class="n">nu</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">=</span><span class="mi">0</span>
    <span class="n">lip_coeff</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">],))</span>

    <span class="n">shift_ker_stack</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="mi">2</span><span class="o">*</span><span class="n">lanc_rad</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="o">*</span><span class="n">lanc_rad</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>
    <span class="n">shift_ker_stack_adj</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="mi">2</span><span class="o">*</span><span class="n">lanc_rad</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="o">*</span><span class="n">lanc_rad</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>
    <span class="n">ker_norm_2</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">],))</span>
    <span class="n">thresh_type</span><span class="o">=</span><span class="mi">1</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
        <span class="n">uin</span> <span class="o">=</span> <span class="n">shifts</span><span class="p">[</span><span class="n">i</span><span class="p">,:]</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span><span class="o">*</span><span class="n">upfact</span>
        <span class="n">shift_ker_stack</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">lanczos</span><span class="p">(</span><span class="n">uin</span><span class="p">,</span><span class="n">n</span><span class="o">=</span><span class="n">lanc_rad</span><span class="p">)</span>
        <span class="n">lip_coeff</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">shift_ker_stack</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">])</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span><span class="o">**</span><span class="mi">2</span>
        <span class="n">shift_ker_stack_adj</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">rot90</span><span class="p">(</span><span class="n">shift_ker_stack</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">],</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">ker_norm_2</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">sqrt</span><span class="p">((</span><span class="n">shift_ker_stack</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span>

    <span class="n">thresh_coeff</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">mu</span><span class="o">*</span><span class="n">ker_norm_2</span><span class="o">/</span><span class="n">lip_coeff</span><span class="p">)</span>
    <span class="n">nu</span> <span class="o">=</span> <span class="n">thresh_coeff</span><span class="o">*</span><span class="n">nu</span>
    <span class="n">grad</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">upfact</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">upfact</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>
    <span class="n">im_hr</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">upfact</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">upfact</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>
    <span class="n">mat_hr</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">upfact</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span>
    <span class="n">mse</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">nb_iter</span><span class="p">,))</span>

    <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_rw</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_iter</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">l</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
                <span class="n">mse</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">=</span><span class="mi">0</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
                <span class="n">res</span><span class="p">[:,:,</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">im_stack</span><span class="p">[:,:,</span><span class="n">k</span><span class="p">]</span><span class="o">-</span><span class="n">utils</span><span class="o">.</span><span class="n">decim</span><span class="p">(</span><span class="n">scisig</span><span class="o">.</span><span class="n">fftconvolve</span><span class="p">(</span><span class="n">im_hr</span><span class="p">[:,:,</span><span class="n">k</span><span class="p">],</span><span class="n">shift_ker_stack</span><span class="p">[:,:,</span><span class="n">k</span><span class="p">],</span><span class="n">mode</span><span class="o">=</span><span class="s1">&#39;same&#39;</span><span class="p">),</span><span class="n">upfact</span><span class="p">,</span><span class="n">av_en</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                <span class="n">mse</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+=</span> <span class="p">(</span><span class="n">res</span><span class="p">[:,:,</span><span class="n">k</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
                <span class="n">grad</span><span class="p">[:,:,</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">scisig</span><span class="o">.</span><span class="n">convolve</span><span class="p">(</span><span class="n">utils</span><span class="o">.</span><span class="n">transpose_decim</span><span class="p">(</span><span class="n">res</span><span class="p">[:,:,</span><span class="n">k</span><span class="p">],</span><span class="n">upfact</span><span class="p">),</span><span class="n">shift_ker_stack_adj</span><span class="p">[:,:,</span><span class="n">k</span><span class="p">],</span><span class="n">mode</span><span class="o">=</span><span class="s1">&#39;same&#39;</span><span class="p">)</span>
            <span class="nb">print</span> <span class="n">mse</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="c1"># -------- Gradient step -------- #</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
                <span class="n">im_hr</span><span class="p">[:,:,</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">im_hr</span><span class="p">[:,:,</span><span class="n">k</span><span class="p">]</span> <span class="o">-</span> <span class="p">(</span><span class="n">mu</span><span class="o">/</span><span class="n">lip_coeff</span><span class="p">[</span><span class="n">k</span><span class="p">])</span><span class="o">*</span><span class="n">grad</span><span class="p">[:,:,</span><span class="n">k</span><span class="p">]</span>
                <span class="n">mat_hr</span><span class="p">[</span><span class="n">k</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">im_hr</span><span class="p">[:,:,</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">upfact</span><span class="o">**</span><span class="mi">2</span><span class="p">,))</span>

            <span class="c1"># ------ Low rank constraint ---- #</span>
            <span class="n">mat_hr</span><span class="p">,</span><span class="n">si</span><span class="p">,</span><span class="n">U</span><span class="p">,</span><span class="n">Vt</span> <span class="o">=</span> <span class="n">nuc_norm_thresh</span><span class="p">(</span><span class="n">mat_hr</span><span class="p">,</span><span class="n">nu</span><span class="o">*</span><span class="n">w</span><span class="p">,</span><span class="n">thresh_type</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
                <span class="n">im_hr</span><span class="p">[:,:,</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">mat_hr</span><span class="p">[</span><span class="n">k</span><span class="p">,:]</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">upfact</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">upfact</span><span class="p">))</span>
        <span class="n">U</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">Vt</span> <span class="o">=</span> <span class="n">linalg</span><span class="o">.</span><span class="n">svd</span><span class="p">(</span><span class="n">mat_hr</span><span class="p">,</span><span class="n">full_matrices</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">w</span><span class="p">[</span><span class="mi">2</span><span class="p">:]</span> <span class="o">=</span> <span class="mi">1</span><span class="o">/</span><span class="p">((</span><span class="n">s</span><span class="p">[</span><span class="mi">2</span><span class="p">:]</span><span class="o">/</span><span class="n">nu</span><span class="p">[</span><span class="mi">2</span><span class="p">:])</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">im_hr</span><span class="p">,</span><span class="n">mat_hr</span><span class="p">,</span><span class="n">res</span>


<span class="k">def</span> <span class="nf">robust_stacking</span><span class="p">(</span><span class="n">im_stack</span><span class="p">,</span><span class="n">mu</span><span class="p">,</span><span class="n">upfact</span><span class="p">,</span><span class="n">opt</span><span class="p">,</span><span class="n">shifts</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">nsig</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span><span class="n">nb_iter</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span><span class="n">nb_rw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span><span class="n">lanc_rad</span><span class="o">=</span><span class="mi">10</span><span class="p">):</span>

    <span class="n">shap</span> <span class="o">=</span> <span class="n">im_stack</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">w</span> <span class="o">=</span> <span class="n">ones</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">],))</span>
    <span class="k">if</span> <span class="n">shifts</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">shifts</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">shift_est</span><span class="p">(</span><span class="n">im_stack</span><span class="p">)</span><span class="o">*</span><span class="n">upfact</span>

    <span class="n">lip_coeff</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">],))</span>

    <span class="n">shift_ker_stack</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="mi">2</span><span class="o">*</span><span class="n">lanc_rad</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="o">*</span><span class="n">lanc_rad</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>
    <span class="n">shift_ker_stack_adj</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="mi">2</span><span class="o">*</span><span class="n">lanc_rad</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="o">*</span><span class="n">lanc_rad</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>
    <span class="n">ker_norm_2</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">],))</span>
    <span class="n">thresh_type</span><span class="o">=</span><span class="mi">1</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
        <span class="n">uin</span> <span class="o">=</span> <span class="n">shifts</span><span class="p">[</span><span class="n">i</span><span class="p">,:]</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span><span class="o">*</span><span class="n">upfact</span>
        <span class="n">shift_ker_stack</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">lanczos</span><span class="p">(</span><span class="n">uin</span><span class="p">,</span><span class="n">n</span><span class="o">=</span><span class="n">lanc_rad</span><span class="p">)</span>
        <span class="n">lip_coeff</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">shift_ker_stack</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">])</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span><span class="o">**</span><span class="mi">2</span>
        <span class="n">shift_ker_stack_adj</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">rot90</span><span class="p">(</span><span class="n">shift_ker_stack</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">],</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">ker_norm_2</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">sqrt</span><span class="p">((</span><span class="n">shift_ker_stack</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span>

    <span class="n">lip_coeff_t</span> <span class="o">=</span> <span class="n">lip_coeff</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    <span class="n">thresh_coeff</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">mu</span><span class="o">*</span><span class="n">ker_norm_2</span><span class="o">/</span><span class="n">lip_coeff</span><span class="p">)</span>
    <span class="n">grad</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">upfact</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">upfact</span><span class="p">))</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>
    <span class="n">im_hr</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">upfact</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">upfact</span><span class="p">))</span>
    <span class="n">mse</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">nb_iter</span><span class="p">,))</span>

    <span class="n">weights</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">coeff_init</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">mr_file</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_rw</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
        <span class="n">nb_subiter</span> <span class="o">=</span> <span class="mi">50</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_iter</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
                <span class="n">nb_subiter</span><span class="o">=</span><span class="mi">5</span>
            <span class="k">if</span> <span class="n">l</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
                <span class="n">mse</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">=</span><span class="mi">0</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
                <span class="n">res</span><span class="p">[:,:,</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">im_stack</span><span class="p">[:,:,</span><span class="n">k</span><span class="p">]</span><span class="o">-</span><span class="n">utils</span><span class="o">.</span><span class="n">decim</span><span class="p">(</span><span class="n">scisig</span><span class="o">.</span><span class="n">fftconvolve</span><span class="p">(</span><span class="n">im_hr</span><span class="p">,</span><span class="n">shift_ker_stack</span><span class="p">[:,:,</span><span class="n">k</span><span class="p">],</span><span class="n">mode</span><span class="o">=</span><span class="s1">&#39;same&#39;</span><span class="p">),</span><span class="n">upfact</span><span class="p">,</span><span class="n">av_en</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                <span class="n">mse</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+=</span> <span class="p">(</span><span class="n">res</span><span class="p">[:,:,</span><span class="n">k</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
                <span class="n">grad</span> <span class="o">=</span> <span class="n">grad</span> <span class="o">-</span><span class="n">scisig</span><span class="o">.</span><span class="n">convolve</span><span class="p">(</span><span class="n">utils</span><span class="o">.</span><span class="n">transpose_decim</span><span class="p">(</span><span class="n">res</span><span class="p">[:,:,</span><span class="n">k</span><span class="p">],</span><span class="n">upfact</span><span class="p">),</span><span class="n">shift_ker_stack_adj</span><span class="p">[:,:,</span><span class="n">k</span><span class="p">],</span><span class="n">mode</span><span class="o">=</span><span class="s1">&#39;same&#39;</span><span class="p">)</span>
            <span class="nb">print</span> <span class="n">mse</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="c1"># -------- Gradient step -------- #</span>
            <span class="n">im_hr</span> <span class="o">=</span> <span class="n">im_hr</span> <span class="o">-</span> <span class="p">(</span><span class="n">mu</span><span class="o">/</span><span class="n">lip_coeff_t</span><span class="p">)</span><span class="o">*</span><span class="n">grad</span>

            <span class="c1"># ---- Analysis constraint ---- #</span>
            <span class="c1"># Wavelet noise estimation</span>
            <span class="n">sig_map</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">res_sig_map</span><span class="p">((</span><span class="n">mu</span><span class="o">/</span><span class="n">lip_coeff_t</span><span class="p">)</span><span class="o">*</span><span class="n">grad</span><span class="p">,</span><span class="n">opt</span><span class="o">=</span><span class="n">opt</span><span class="p">)</span>
            <span class="n">grad</span><span class="o">=</span><span class="n">grad</span><span class="o">*</span><span class="mi">0</span>
            <span class="n">thresh_map</span> <span class="o">=</span> <span class="n">nsig</span><span class="o">*</span><span class="n">sig_map</span>
            <span class="k">if</span> <span class="n">weights</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">thresh_map</span> <span class="o">=</span> <span class="n">thresh_map</span><span class="o">*</span><span class="n">weights</span>
            <span class="n">im_hr</span><span class="p">,</span><span class="n">mr_file</span><span class="p">,</span><span class="n">n</span><span class="p">,</span><span class="n">coeff_init</span> <span class="o">=</span> <span class="n">wvl_analysis_op</span><span class="p">(</span><span class="n">im_hr</span><span class="p">,</span><span class="n">thresh_map</span><span class="p">,</span><span class="n">opt</span><span class="o">=</span><span class="n">opt</span><span class="p">,</span><span class="n">coeff_init</span><span class="o">=</span><span class="n">coeff_init</span><span class="p">,</span><span class="n">mr_file</span><span class="o">=</span><span class="n">mr_file</span><span class="p">,</span><span class="n">nb_iter</span><span class="o">=</span><span class="n">nb_subiter</span><span class="p">)</span>
        <span class="c1"># ---- Weights update ---- #</span>
        <span class="n">coeffx</span><span class="p">,</span><span class="n">mr_file</span> <span class="o">=</span> <span class="n">isap</span><span class="o">.</span><span class="n">mr_trans</span><span class="p">(</span><span class="n">im_hr</span><span class="p">,</span><span class="n">opt</span><span class="o">=</span><span class="n">opt</span><span class="p">)</span>
        <span class="n">weights</span>  <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="nb">abs</span><span class="p">(</span><span class="n">coeffx</span><span class="p">[:,:,:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span><span class="o">/</span><span class="p">(</span><span class="n">nsig</span><span class="o">*</span><span class="n">sig_map</span><span class="p">))</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">im_hr</span><span class="p">,</span><span class="n">res</span>


<span class="k">def</span> <span class="nf">low_rank_sr_mod</span><span class="p">(</span><span class="n">im_stack</span><span class="p">,</span><span class="n">model</span><span class="p">,</span><span class="n">mu</span><span class="p">,</span><span class="n">upfact</span><span class="p">,</span><span class="n">ksig</span><span class="p">,</span><span class="n">nb_iter</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span><span class="n">nb_rw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span><span class="n">lanc_rad</span><span class="o">=</span><span class="mi">10</span><span class="p">):</span>
    <span class="n">shap</span> <span class="o">=</span> <span class="n">im_stack</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">w</span> <span class="o">=</span> <span class="n">ones</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">],))</span>
    <span class="n">mat_stack</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span> <span class="c1"># Images correspond to lines</span>
    <span class="n">shifts</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">int_grid_shift</span><span class="p">(</span><span class="n">im_stack</span><span class="p">)</span><span class="o">*</span><span class="n">upfact</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
        <span class="n">mat_stack</span><span class="p">[</span><span class="n">i</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">im_stack</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">],))</span>
    <span class="n">U</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">Vt</span> <span class="o">=</span> <span class="n">linalg</span><span class="o">.</span><span class="n">svd</span><span class="p">(</span><span class="n">mat_stack</span><span class="p">,</span><span class="n">full_matrices</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="n">sigma</span> <span class="o">=</span> <span class="n">s</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">/</span><span class="mi">2</span><span class="p">)]</span>
    <span class="c1">#n=max(shap0[0],shap0[1])</span>
    <span class="n">nu</span> <span class="o">=</span> <span class="n">ksig</span><span class="o">*</span><span class="n">sigma</span><span class="o">*</span><span class="n">ones</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">],))</span>
    <span class="n">lip_coeff</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">],))</span>

    <span class="n">shift_ker_stack</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="mi">2</span><span class="o">*</span><span class="n">lanc_rad</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="o">*</span><span class="n">lanc_rad</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>
    <span class="n">shift_ker_stack_adj</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="mi">2</span><span class="o">*</span><span class="n">lanc_rad</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="o">*</span><span class="n">lanc_rad</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>
    <span class="n">ker_norm_2</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">],))</span>
    <span class="n">thresh_type</span><span class="o">=</span><span class="mi">1</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
        <span class="n">uin</span> <span class="o">=</span> <span class="n">shifts</span><span class="p">[</span><span class="n">i</span><span class="p">,:]</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span><span class="o">*</span><span class="n">upfact</span>
        <span class="n">shift_ker_stack</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">lanczos</span><span class="p">(</span><span class="n">uin</span><span class="p">,</span><span class="n">n</span><span class="o">=</span><span class="n">lanc_rad</span><span class="p">)</span>
        <span class="n">lip_coeff</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">shift_ker_stack</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">])</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span><span class="o">**</span><span class="mi">2</span>
        <span class="n">shift_ker_stack_adj</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">rot90</span><span class="p">(</span><span class="n">shift_ker_stack</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">],</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">ker_norm_2</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">sqrt</span><span class="p">((</span><span class="n">shift_ker_stack</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span>

    <span class="n">thresh_coeff</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">mu</span><span class="o">*</span><span class="n">ker_norm_2</span><span class="o">/</span><span class="n">lip_coeff</span><span class="p">)</span>
    <span class="n">nu</span> <span class="o">=</span> <span class="n">thresh_coeff</span><span class="o">*</span><span class="n">nu</span>
    <span class="n">grad</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">upfact</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">upfact</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>
    <span class="n">im_hr</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">upfact</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">upfact</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>
    <span class="n">delta_hr</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">upfact</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">upfact</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>
    <span class="n">mat_hr</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">upfact</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span>
    <span class="n">mse</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">nb_iter</span><span class="p">,))</span>

    <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_rw</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_iter</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">l</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
                <span class="n">mse</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">=</span><span class="mi">0</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
                <span class="n">res</span><span class="p">[:,:,</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">im_stack</span><span class="p">[:,:,</span><span class="n">k</span><span class="p">]</span><span class="o">-</span><span class="n">utils</span><span class="o">.</span><span class="n">decim</span><span class="p">(</span><span class="n">scisig</span><span class="o">.</span><span class="n">fftconvolve</span><span class="p">(</span><span class="n">delta_hr</span><span class="p">[:,:,</span><span class="n">k</span><span class="p">]</span><span class="o">+</span><span class="n">model</span><span class="p">,</span><span class="n">shift_ker_stack</span><span class="p">[:,:,</span><span class="n">k</span><span class="p">],</span><span class="n">mode</span><span class="o">=</span><span class="s1">&#39;same&#39;</span><span class="p">),</span><span class="n">upfact</span><span class="p">,</span><span class="n">av_en</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                <span class="n">mse</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+=</span> <span class="p">(</span><span class="n">res</span><span class="p">[:,:,</span><span class="n">k</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
                <span class="n">grad</span><span class="p">[:,:,</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">scisig</span><span class="o">.</span><span class="n">convolve</span><span class="p">(</span><span class="n">utils</span><span class="o">.</span><span class="n">transpose_decim</span><span class="p">(</span><span class="n">res</span><span class="p">[:,:,</span><span class="n">k</span><span class="p">],</span><span class="n">upfact</span><span class="p">),</span><span class="n">shift_ker_stack_adj</span><span class="p">[:,:,</span><span class="n">k</span><span class="p">],</span><span class="n">mode</span><span class="o">=</span><span class="s1">&#39;same&#39;</span><span class="p">)</span>
            <span class="nb">print</span> <span class="n">mse</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="c1"># -------- Gradient step -------- #</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
                <span class="n">delta_hr</span><span class="p">[:,:,</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">delta_hr</span><span class="p">[:,:,</span><span class="n">k</span><span class="p">]</span> <span class="o">-</span> <span class="p">(</span><span class="n">mu</span><span class="o">/</span><span class="n">lip_coeff</span><span class="p">[</span><span class="n">k</span><span class="p">])</span><span class="o">*</span><span class="n">grad</span><span class="p">[:,:,</span><span class="n">k</span><span class="p">]</span>
                <span class="n">mat_hr</span><span class="p">[</span><span class="n">k</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">delta_hr</span><span class="p">[:,:,</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">upfact</span><span class="o">**</span><span class="mi">2</span><span class="p">,))</span>

            <span class="c1"># ------ Low rank constraint ---- #</span>
            <span class="n">mat_hr</span><span class="p">,</span><span class="n">si</span><span class="p">,</span><span class="n">U</span><span class="p">,</span><span class="n">Vt</span> <span class="o">=</span> <span class="n">nuc_norm_thresh</span><span class="p">(</span><span class="n">mat_hr</span><span class="p">,</span><span class="n">nu</span><span class="o">*</span><span class="n">w</span><span class="p">,</span><span class="n">thresh_type</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
                <span class="n">delta_hr</span><span class="p">[:,:,</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">mat_hr</span><span class="p">[</span><span class="n">k</span><span class="p">,:]</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">upfact</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">upfact</span><span class="p">))</span>
        <span class="n">U</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">Vt</span> <span class="o">=</span> <span class="n">linalg</span><span class="o">.</span><span class="n">svd</span><span class="p">(</span><span class="n">mat_hr</span><span class="p">,</span><span class="n">full_matrices</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">w</span> <span class="o">=</span> <span class="mi">1</span><span class="o">/</span><span class="p">((</span><span class="n">s</span><span class="o">/</span><span class="p">(</span><span class="n">thresh_coeff</span><span class="o">*</span><span class="n">ksig</span><span class="o">*</span><span class="n">sigma</span><span class="p">))</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
        <span class="n">im_hr</span><span class="p">[:,:,</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">delta_hr</span><span class="p">[:,:,</span><span class="n">k</span><span class="p">]</span><span class="o">+</span><span class="n">model</span>
    <span class="k">return</span> <span class="n">im_hr</span><span class="p">,</span><span class="n">mat_hr</span><span class="p">,</span><span class="n">res</span><span class="p">,</span><span class="n">delta_hr</span>

<span class="k">def</span> <span class="nf">proj_tg_sph</span><span class="p">(</span><span class="n">y</span><span class="p">,</span><span class="n">x</span><span class="p">,</span><span class="n">o</span><span class="p">,</span><span class="n">r</span><span class="p">):</span> <span class="c1"># Projects y on a the tangent plane at x on a sphere centered on o, with a radius r</span>
    <span class="n">a</span> <span class="o">=</span> <span class="p">((</span><span class="n">y</span><span class="o">-</span><span class="n">x</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">x</span><span class="o">-</span><span class="n">o</span><span class="p">))</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">/</span><span class="n">r</span><span class="o">**</span><span class="mi">2</span>
    <span class="n">projy</span> <span class="o">=</span> <span class="n">y</span> <span class="o">-</span> <span class="n">a</span><span class="o">*</span><span class="p">(</span><span class="n">x</span><span class="o">-</span><span class="n">o</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">projy</span>

<span class="k">def</span> <span class="nf">KL</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">inf_val</span><span class="o">=</span><span class="n">double</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">**</span><span class="mi">63</span><span class="p">):</span>
    <span class="nb">id</span> <span class="o">=</span> <span class="n">where</span><span class="p">(</span><span class="n">y</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">kl_d</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="nb">id</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="n">log</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="nb">id</span><span class="p">]</span><span class="o">/</span><span class="n">y</span><span class="p">[</span><span class="nb">id</span><span class="p">])</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">+</span><span class="n">y</span><span class="p">[</span><span class="nb">id</span><span class="p">])</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    <span class="n">id_check</span> <span class="o">=</span> <span class="n">where</span><span class="p">(</span><span class="n">x</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">y_check</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="n">id_check</span><span class="p">]</span>
    <span class="n">l</span> <span class="o">=</span> <span class="n">size</span><span class="p">(</span><span class="n">where</span><span class="p">(</span><span class="n">y_check</span><span class="o">==</span><span class="mi">0</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">l</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
        <span class="n">kl_d</span> <span class="o">=</span> <span class="n">inf_val</span>
    <span class="k">return</span> <span class="n">kl_d</span>

<span class="k">def</span> <span class="nf">kl_proj_sphere</span><span class="p">(</span><span class="n">y</span><span class="p">,</span><span class="n">o</span><span class="p">,</span><span class="n">r</span><span class="p">,</span><span class="n">mu</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">nb_iter</span><span class="o">=</span><span class="mi">40</span><span class="p">,</span><span class="n">tol</span><span class="o">=</span><span class="mi">10</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mi">10</span><span class="p">)):</span> <span class="c1"># Finds argmin_x KL(x|y) s.t. ||y-x||_2 = r; O is assumed to be a dirac mass</span>
    <span class="n">xout</span> <span class="o">=</span> <span class="n">proj_sphere</span><span class="p">(</span><span class="n">y</span><span class="p">,</span><span class="n">o</span><span class="p">,</span><span class="n">r</span><span class="p">)</span>
    <span class="n">io</span> <span class="o">=</span> <span class="n">where</span><span class="p">(</span><span class="n">o</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">o</span><span class="p">[</span><span class="n">io</span><span class="p">]</span><span class="o">&gt;=</span><span class="n">r</span> <span class="ow">and</span> <span class="n">y</span><span class="p">[</span><span class="n">io</span><span class="p">]</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">xout</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">xout</span> <span class="o">=</span> <span class="n">y</span>
        <span class="nb">id</span> <span class="o">=</span> <span class="n">where</span><span class="p">(</span><span class="n">y</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">)</span>
        <span class="c1">#step = mu*r/sqrt((y**2).sum())</span>
        <span class="n">grad</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">size</span><span class="p">(</span><span class="n">y</span><span class="p">),))</span>
        <span class="n">des_dir</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">size</span><span class="p">(</span><span class="n">y</span><span class="p">),))</span>
        <span class="n">i</span><span class="o">=</span><span class="mi">0</span>
        <span class="n">kl_old</span> <span class="o">=</span> <span class="n">KL</span><span class="p">(</span><span class="n">xout</span><span class="p">,</span><span class="n">y</span><span class="p">)</span>
        <span class="n">kl</span> <span class="o">=</span> <span class="n">kl_old</span><span class="o">+</span><span class="mi">1</span>
        <span class="k">while</span> <span class="p">(</span><span class="n">i</span><span class="o">&lt;</span><span class="n">nb_iter</span> <span class="ow">and</span> <span class="nb">abs</span><span class="p">(</span><span class="n">kl</span><span class="o">-</span><span class="n">kl_old</span><span class="p">)</span><span class="o">/</span><span class="n">kl</span> <span class="o">&gt;</span><span class="n">tol</span><span class="p">):</span>
            <span class="c1">#print xout[id].min()</span>
            <span class="n">grad</span><span class="p">[</span><span class="nb">id</span><span class="p">]</span> <span class="o">=</span> <span class="n">proj_tg_sph</span><span class="p">(</span><span class="n">log</span><span class="p">(</span><span class="n">xout</span><span class="p">[</span><span class="nb">id</span><span class="p">]</span><span class="o">/</span><span class="n">y</span><span class="p">[</span><span class="nb">id</span><span class="p">]),</span><span class="n">xout</span><span class="p">[</span><span class="nb">id</span><span class="p">],</span><span class="n">o</span><span class="p">[</span><span class="nb">id</span><span class="p">],</span><span class="n">r</span><span class="p">)</span>
            <span class="n">des_dir</span><span class="p">[</span><span class="nb">id</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">xout</span><span class="p">[</span><span class="nb">id</span><span class="p">]</span><span class="o">*</span><span class="n">grad</span><span class="p">[</span><span class="nb">id</span><span class="p">]</span>
            <span class="n">step</span><span class="p">,</span><span class="n">m</span><span class="p">,</span><span class="n">count</span> <span class="o">=</span> <span class="n">armijo_step_kl</span><span class="p">(</span><span class="n">grad</span><span class="p">,</span><span class="n">des_dir</span><span class="p">,</span><span class="n">xout</span><span class="p">,</span><span class="n">o</span><span class="p">,</span><span class="n">r</span><span class="p">,</span><span class="n">y</span><span class="p">)</span>
            <span class="n">xtemp</span> <span class="o">=</span> <span class="n">xout</span><span class="o">+</span><span class="n">step</span>
            <span class="c1">#print xtemp.min()</span>
            <span class="n">xout</span> <span class="o">=</span> <span class="n">proj_sphere</span><span class="p">(</span><span class="n">xtemp</span><span class="p">,</span><span class="n">o</span><span class="p">,</span><span class="n">r</span><span class="p">)</span>
            <span class="n">kl_old</span> <span class="o">=</span> <span class="n">kl</span>
            <span class="n">kl</span> <span class="o">=</span> <span class="n">KL</span><span class="p">(</span><span class="n">xout</span><span class="p">,</span><span class="n">y</span><span class="p">)</span>
            <span class="c1">#print &quot;divergence: &quot;,kl,&quot; armijo power: &quot;,m,&quot; count: &quot;,count</span>
            <span class="n">i</span><span class="o">+=</span><span class="mi">1</span>
        <span class="k">return</span> <span class="n">xout</span>

<span class="k">def</span> <span class="nf">kl_proj_sphere_mat</span><span class="p">(</span><span class="n">y</span><span class="p">,</span><span class="n">o</span><span class="p">,</span><span class="n">r</span><span class="p">,</span><span class="n">mu</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span><span class="n">nb_iter</span><span class="o">=</span><span class="mi">40</span><span class="p">):</span>
    <span class="n">shap</span> <span class="o">=</span> <span class="n">y</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">output</span> <span class="o">=</span> <span class="n">y</span><span class="o">*</span><span class="mi">0</span>
    <span class="n">bias</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">size</span><span class="p">(</span><span class="n">r</span><span class="p">),))</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>

        <span class="n">disti</span> <span class="o">=</span> <span class="n">sqrt</span><span class="p">(((</span><span class="n">y</span><span class="p">[</span><span class="n">i</span><span class="p">,:]</span><span class="o">-</span><span class="n">o</span><span class="p">[</span><span class="n">i</span><span class="p">,:])</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span>
        <span class="c1">#print i,&quot;/&quot;,shap[0],&quot; r = &quot;,r[i],&quot; disti = &quot;,disti</span>
        <span class="k">if</span> <span class="n">disti</span> <span class="o">&lt;=</span> <span class="n">r</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>
            <span class="n">output</span><span class="p">[</span><span class="n">i</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">y</span><span class="p">[</span><span class="n">i</span><span class="p">,:]</span>
            <span class="n">bias</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">r</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-</span><span class="n">disti</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">yi</span> <span class="o">=</span> <span class="n">kl_proj_sphere</span><span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="n">i</span><span class="p">,:],</span><span class="n">o</span><span class="p">[</span><span class="n">i</span><span class="p">,:],</span><span class="n">r</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">mu</span><span class="o">=</span><span class="n">mu</span><span class="p">,</span><span class="n">nb_iter</span><span class="o">=</span><span class="n">nb_iter</span><span class="p">)</span>
            <span class="n">disti</span> <span class="o">=</span> <span class="n">sqrt</span><span class="p">(((</span><span class="n">yi</span><span class="o">-</span><span class="n">o</span><span class="p">[</span><span class="n">i</span><span class="p">,:])</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span>
            <span class="n">bias</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">r</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-</span><span class="n">disti</span>
            <span class="n">output</span><span class="p">[</span><span class="n">i</span><span class="p">,:]</span><span class="o">=</span><span class="n">yi</span>
    <span class="k">return</span> <span class="n">output</span><span class="p">,</span><span class="n">bias</span>


<span class="k">def</span> <span class="nf">armijo_step_kl</span><span class="p">(</span><span class="n">grad</span><span class="p">,</span><span class="n">des_dir</span><span class="p">,</span><span class="n">xk</span><span class="p">,</span><span class="n">o</span><span class="p">,</span><span class="n">r</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">sigma</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span><span class="n">beta</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">tol</span><span class="o">=</span><span class="mi">10</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mi">30</span><span class="p">),</span><span class="n">count_max</span><span class="o">=</span><span class="mi">50</span><span class="p">):</span>
    <span class="n">m</span><span class="o">=</span><span class="mi">0</span>
    <span class="n">a</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">i</span> <span class="o">=</span> <span class="n">where</span><span class="p">(</span><span class="n">y</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">n</span> <span class="o">=</span> <span class="p">(</span><span class="n">grad</span><span class="o">*</span><span class="n">des_dir</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    <span class="n">ind</span> <span class="o">=</span> <span class="n">where</span><span class="p">(</span><span class="n">y</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">)</span>

    <span class="n">cur_cost</span> <span class="o">=</span> <span class="p">(</span><span class="n">xk</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="n">log</span><span class="p">(</span><span class="n">xk</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span><span class="o">/</span><span class="n">y</span><span class="p">[</span><span class="n">ind</span><span class="p">])</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    <span class="n">xtemp</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">size</span><span class="p">(</span><span class="n">y</span><span class="p">),))</span>
    <span class="n">nb_iter</span><span class="o">=</span><span class="mi">0</span>
    <span class="k">while</span> <span class="n">a</span><span class="o">==</span><span class="kc">True</span> <span class="ow">and</span> <span class="n">nb_iter</span><span class="o">&lt;</span><span class="n">count_max</span><span class="p">:</span>
        <span class="n">rhs</span> <span class="o">=</span> <span class="o">-</span><span class="n">sigma</span><span class="o">*</span><span class="n">alpha</span><span class="o">*</span><span class="p">(</span><span class="n">beta</span><span class="o">**</span><span class="n">m</span><span class="p">)</span><span class="o">*</span><span class="n">n</span>
        <span class="n">xtemp</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span> <span class="o">=</span> <span class="n">proj_sphere</span><span class="p">(</span><span class="n">xk</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span><span class="o">+</span><span class="n">alpha</span><span class="o">*</span><span class="p">(</span><span class="n">beta</span><span class="o">**</span><span class="n">m</span><span class="p">)</span><span class="o">*</span><span class="n">des_dir</span><span class="p">[</span><span class="n">ind</span><span class="p">],</span><span class="n">o</span><span class="p">[</span><span class="n">ind</span><span class="p">],</span><span class="n">r</span><span class="p">)</span>
        <span class="n">ind_neg</span> <span class="o">=</span> <span class="n">where</span><span class="p">(</span><span class="n">xtemp</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span><span class="o">&lt;=</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">size</span><span class="p">(</span><span class="n">ind_neg</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
            <span class="n">cost_updt</span> <span class="o">=</span> <span class="p">(</span><span class="n">xtemp</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="n">log</span><span class="p">(</span><span class="n">xtemp</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span><span class="o">/</span><span class="n">y</span><span class="p">[</span><span class="n">ind</span><span class="p">])</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">cur_cost</span><span class="o">-</span><span class="n">cost_updt</span><span class="o">&gt;=</span><span class="n">rhs</span> <span class="ow">or</span> <span class="nb">abs</span><span class="p">(</span><span class="n">cur_cost</span><span class="o">-</span><span class="n">cost_updt</span><span class="p">)</span><span class="o">/</span><span class="n">cur_cost</span> <span class="o">&lt;</span><span class="n">tol</span><span class="p">:</span>
                <span class="n">a</span><span class="o">=</span><span class="kc">False</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">m</span><span class="o">+=</span><span class="mi">2</span>
                <span class="c1">#print &quot;rhs: &quot;,rhs</span>
                <span class="c1">#print &quot;cur_cost-cost_updt = &quot;,cur_cost-cost_updt</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">m</span><span class="o">+=</span><span class="mi">2</span>
        <span class="n">nb_iter</span><span class="o">+=</span><span class="mi">1</span>
        <span class="c1">#else:</span>
            <span class="c1">#print &quot;size(ind_neg) = &quot;,size(ind_neg)</span>
    <span class="n">step</span> <span class="o">=</span> <span class="n">alpha</span><span class="o">*</span><span class="p">(</span><span class="n">beta</span><span class="o">**</span><span class="n">m</span><span class="p">)</span><span class="o">*</span><span class="n">des_dir</span>
    <span class="k">return</span> <span class="n">step</span><span class="p">,</span><span class="n">m</span><span class="p">,</span><span class="n">nb_iter</span>

<span class="k">def</span> <span class="nf">pow_meth</span><span class="p">(</span><span class="n">opname</span><span class="p">,</span><span class="n">op_param</span><span class="p">,</span><span class="n">siz</span><span class="p">,</span><span class="n">tol</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span><span class="n">ainit</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">nb_iter_max</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span><span class="n">opt_vect</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>

    <span class="n">a</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">ainit</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">a</span> <span class="o">=</span> <span class="n">ainit</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">size</span><span class="p">(</span><span class="n">siz</span><span class="p">)</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">a</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="n">siz</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">size</span><span class="p">(</span><span class="n">siz</span><span class="p">)</span><span class="o">==</span><span class="mi">2</span><span class="p">:</span>
            <span class="n">a</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="n">siz</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">siz</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">elif</span> <span class="n">size</span><span class="p">(</span><span class="n">siz</span><span class="p">)</span><span class="o">==</span><span class="mi">3</span><span class="p">:</span>
            <span class="n">a</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="n">siz</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">siz</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">siz</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
        <span class="n">a</span> <span class="o">=</span> <span class="n">a</span><span class="o">/</span><span class="n">sqrt</span><span class="p">(((</span><span class="n">a</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span>

    <span class="n">L_old</span> <span class="o">=</span> <span class="mi">10</span>
    <span class="n">L</span><span class="o">=</span><span class="mi">1</span>
    <span class="n">i</span><span class="o">=</span><span class="mi">0</span>
    <span class="nb">print</span> <span class="s2">&quot;----------- spec_rad est ---------- : &quot;</span>

    <span class="k">while</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">nb_iter_max</span> <span class="ow">and</span> <span class="p">(</span><span class="mi">100</span><span class="o">*</span><span class="nb">abs</span><span class="p">(</span><span class="n">L</span><span class="o">-</span><span class="n">L_old</span><span class="p">))</span><span class="o">/</span><span class="n">L</span><span class="o">&gt;</span><span class="n">tol</span><span class="p">:</span>
        <span class="nb">print</span> <span class="n">L</span>
        <span class="n">op_param</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">a</span>
        <span class="n">b</span> <span class="o">=</span> <span class="n">opname</span><span class="p">(</span><span class="n">op_param</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">opt_vect</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">b</span><span class="o">-=</span><span class="nb">sum</span><span class="p">(</span><span class="n">b</span><span class="o">*</span><span class="n">opt_vect</span><span class="p">)</span><span class="o">*</span><span class="n">opt_vect</span>
        <span class="n">L_old</span> <span class="o">=</span> <span class="n">L</span>
        <span class="n">L</span> <span class="o">=</span> <span class="n">sqrt</span><span class="p">(((</span><span class="n">b</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span>
        <span class="n">a</span> <span class="o">=</span> <span class="n">b</span><span class="o">/</span><span class="n">L</span>
        <span class="n">i</span><span class="o">+=</span><span class="mi">1</span>

    <span class="k">if</span> <span class="n">i</span><span class="o">==</span><span class="n">nb_iter_max</span><span class="p">:</span>
        <span class="nb">print</span> <span class="s2">&quot;Warning max number if iterations reached in pow_meth&quot;</span>
    <span class="k">return</span> <span class="n">a</span><span class="p">,</span><span class="n">L</span>

<span class="k">def</span> <span class="nf">op_eig_space</span><span class="p">(</span><span class="nb">input</span><span class="p">):</span> <span class="c1"># Let A be a matrix representing op_name, this function applies I-A/eig_val, eig_val being an non zero eigenvalue of A</span>
    <span class="n">op_name</span> <span class="o">=</span> <span class="nb">input</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">eig_val</span> <span class="o">=</span> <span class="nb">input</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">out</span> <span class="o">=</span> <span class="nb">input</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">op_name</span><span class="p">(</span><span class="nb">input</span><span class="p">)</span><span class="o">/</span><span class="n">eig_val</span>
    <span class="k">return</span> <span class="n">out</span>

<span class="k">def</span> <span class="nf">min_eig_val</span><span class="p">(</span><span class="n">opname</span><span class="p">,</span><span class="n">op_param</span><span class="p">,</span><span class="n">siz</span><span class="p">,</span><span class="n">tol</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span><span class="n">eig_max</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">eig_min_init</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">nb_iter_max</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span><span class="n">L_max</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span> <span class="c1"># The operation is supposed to be positive and non singular</span>


    <span class="n">eig_max</span><span class="p">,</span><span class="n">L_max</span> <span class="o">=</span> <span class="n">pow_meth</span><span class="p">(</span><span class="n">opname</span><span class="p">,</span><span class="n">op_param</span><span class="p">,</span><span class="n">siz</span><span class="p">,</span><span class="n">tol</span><span class="o">=</span><span class="n">tol</span><span class="p">,</span><span class="n">ainit</span><span class="o">=</span><span class="n">eig_max</span><span class="p">,</span><span class="n">nb_iter_max</span><span class="o">=</span><span class="n">nb_iter_max</span><span class="p">)</span>
    <span class="n">op_param2</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">op_param</span><span class="p">)</span>
    <span class="n">op_param2</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">opname</span><span class="p">)</span>
    <span class="n">op_param2</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">L_max</span><span class="p">)</span>
    <span class="n">eig_min</span><span class="p">,</span><span class="n">coeff_min</span> <span class="o">=</span> <span class="n">pow_meth</span><span class="p">(</span><span class="n">op_eig_space</span><span class="p">,</span><span class="n">op_param2</span><span class="p">,</span><span class="n">siz</span><span class="p">,</span><span class="n">tol</span><span class="o">=</span><span class="n">tol</span><span class="p">,</span><span class="n">ainit</span><span class="o">=</span><span class="n">eig_min_init</span><span class="p">,</span><span class="n">nb_iter_max</span><span class="o">=</span><span class="n">nb_iter_max</span><span class="p">)</span>
    <span class="c1"># Smaller eigenvalue estimation</span>
    <span class="nb">print</span> <span class="s2">&quot;Coeff_min: &quot;</span><span class="p">,</span><span class="n">coeff_min</span>
    <span class="n">L_min</span> <span class="o">=</span> <span class="n">L_max</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">coeff_min</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">eig_min</span><span class="p">,</span><span class="n">L_min</span>

<span class="k">def</span> <span class="nf">conjugate_grad</span><span class="p">(</span><span class="n">op</span><span class="p">,</span><span class="n">op_param</span><span class="p">,</span><span class="n">nb_iter</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span><span class="n">tol</span><span class="o">=</span><span class="mi">10</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mi">10</span><span class="p">)):</span>
    <span class="n">target_val</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">op_param</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">op_param_in</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">op_param</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">target_val</span><span class="o">*</span><span class="mi">0</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">target_val</span><span class="p">)</span>
    <span class="n">p</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
    <span class="n">temp1</span> <span class="o">=</span> <span class="p">(</span><span class="n">r</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    <span class="n">temp1_old</span> <span class="o">=</span> <span class="n">temp1</span>
    <span class="n">i</span><span class="o">=</span><span class="mi">0</span>
    <span class="n">err_rel</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">op_param_test</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">op_param</span><span class="p">)</span>
    <span class="k">while</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">nb_iter</span> <span class="ow">and</span> <span class="n">err_rel</span><span class="o">&gt;</span><span class="n">tol</span><span class="p">:</span>
        <span class="n">op_param_in</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">p</span>
        <span class="n">temp2</span> <span class="o">=</span> <span class="n">op</span><span class="p">(</span><span class="n">op_param_in</span><span class="p">)</span>
        <span class="n">alpha</span> <span class="o">=</span> <span class="n">temp1</span><span class="o">/</span><span class="p">((</span><span class="n">temp2</span><span class="o">*</span><span class="n">p</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">x</span> <span class="o">+</span> <span class="n">alpha</span><span class="o">*</span><span class="n">p</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">r</span> <span class="o">-</span> <span class="n">alpha</span><span class="o">*</span><span class="n">temp2</span>
        <span class="n">op_param_test</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">x</span>
        <span class="n">temp3</span> <span class="o">=</span> <span class="n">op</span><span class="p">(</span><span class="n">op_param_test</span><span class="p">)</span>
        <span class="n">err_rel</span> <span class="o">=</span> <span class="p">((</span><span class="n">temp3</span><span class="o">-</span><span class="n">target_val</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">/</span><span class="p">(</span><span class="n">target_val</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>

        <span class="n">temp1_old</span> <span class="o">=</span> <span class="n">temp1</span>
        <span class="n">temp1</span> <span class="o">=</span> <span class="p">(</span><span class="n">r</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="n">beta</span> <span class="o">=</span> <span class="n">temp1</span><span class="o">/</span><span class="n">temp1_old</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">r</span> <span class="o">+</span> <span class="n">beta</span><span class="o">*</span><span class="n">p</span>
        <span class="n">i</span><span class="o">+=</span><span class="mi">1</span>

    <span class="nb">print</span> <span class="s2">&quot;res: &quot;</span><span class="p">,</span><span class="n">err_rel</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">x</span> <span class="o">+</span> <span class="n">alpha</span><span class="o">*</span><span class="n">p</span>
    <span class="k">return</span> <span class="n">x</span>


<span class="k">def</span> <span class="nf">trans_sr_op</span><span class="p">(</span><span class="nb">input</span><span class="p">):</span>
    <span class="n">x</span> <span class="o">=</span> <span class="nb">input</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">upfact</span> <span class="o">=</span> <span class="nb">input</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">ker_adj</span> <span class="o">=</span> <span class="nb">input</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">output</span> <span class="o">=</span> <span class="n">scisig</span><span class="o">.</span><span class="n">convolve</span><span class="p">(</span><span class="n">utils</span><span class="o">.</span><span class="n">transpose_decim</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">upfact</span><span class="p">),</span><span class="n">ker_adj</span><span class="p">,</span><span class="n">mode</span><span class="o">=</span><span class="s1">&#39;same&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">output</span>

<span class="k">def</span> <span class="nf">sr_op</span><span class="p">(</span><span class="nb">input</span><span class="p">):</span>
    <span class="n">x</span> <span class="o">=</span> <span class="nb">input</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">upfact</span> <span class="o">=</span> <span class="nb">input</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">ker</span> <span class="o">=</span> <span class="nb">input</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">output</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">decim</span><span class="p">(</span><span class="n">scisig</span><span class="o">.</span><span class="n">fftconvolve</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">ker</span><span class="p">,</span><span class="n">mode</span><span class="o">=</span><span class="s1">&#39;same&#39;</span><span class="p">),</span><span class="n">upfact</span><span class="p">,</span><span class="n">av_en</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">output</span>

<span class="k">def</span> <span class="nf">sr_op_trans</span><span class="p">(</span><span class="nb">input</span><span class="p">):</span> <span class="c1"># AA^T</span>
    <span class="n">x</span> <span class="o">=</span> <span class="nb">input</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">upfact</span> <span class="o">=</span> <span class="nb">input</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">ker</span> <span class="o">=</span> <span class="nb">input</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">ker_adj</span> <span class="o">=</span> <span class="nb">input</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>

    <span class="n">input_trans</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
    <span class="n">input_trans</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">copy</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
    <span class="n">input_trans</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">upfact</span><span class="p">)</span>
    <span class="n">input_trans</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ker_adj</span><span class="p">)</span>
    <span class="n">output_temp</span> <span class="o">=</span> <span class="n">trans_sr_op</span><span class="p">(</span><span class="n">input_trans</span><span class="p">)</span>

    <span class="n">input_op</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
    <span class="n">input_op</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">copy</span><span class="p">(</span><span class="n">output_temp</span><span class="p">))</span>
    <span class="n">input_op</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">upfact</span><span class="p">)</span>
    <span class="n">input_op</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ker</span><span class="p">)</span>
    <span class="n">output</span> <span class="o">=</span> <span class="n">sr_opt</span><span class="p">(</span><span class="n">input_op</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">output</span>

<span class="k">def</span> <span class="nf">conv_op_trans</span><span class="p">(</span><span class="nb">input</span><span class="p">):</span> <span class="c1"># M^TM M being a convolutive operator</span>
    <span class="n">x</span> <span class="o">=</span> <span class="nb">input</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">ker</span> <span class="o">=</span> <span class="nb">input</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">ker_adj</span> <span class="o">=</span> <span class="nb">input</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
    <span class="c1">#output = scisig.fftconvolve(scisig.fftconvolve(x,ker,mode=&#39;same&#39;),ker_adj,mode=&#39;same&#39;)</span>
    <span class="n">output</span> <span class="o">=</span> <span class="n">scisig</span><span class="o">.</span><span class="n">convolve2d</span><span class="p">(</span><span class="n">scisig</span><span class="o">.</span><span class="n">convolve2d</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">ker</span><span class="p">,</span><span class="n">mode</span><span class="o">=</span><span class="s1">&#39;same&#39;</span><span class="p">),</span><span class="n">ker_adj</span><span class="p">,</span><span class="n">mode</span><span class="o">=</span><span class="s1">&#39;same&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">output</span>

<span class="k">def</span> <span class="nf">conv_pseudo_inv</span><span class="p">(</span><span class="n">y</span><span class="p">,</span><span class="n">ker</span><span class="p">,</span><span class="n">ker_adj</span><span class="p">,</span><span class="n">nb_iter</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span><span class="n">tol</span><span class="o">=</span><span class="mi">10</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mi">15</span><span class="p">)):</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">scisig</span><span class="o">.</span><span class="n">fftconvolve</span><span class="p">(</span><span class="n">y</span><span class="p">,</span><span class="n">ker_adj</span><span class="p">,</span><span class="n">mode</span><span class="o">=</span><span class="s1">&#39;same&#39;</span><span class="p">)</span>
    <span class="nb">input</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
    <span class="nb">input</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="nb">input</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ker</span><span class="p">)</span>
    <span class="nb">input</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ker_adj</span><span class="p">)</span>
    <span class="n">out</span> <span class="o">=</span> <span class="n">conjugate_grad</span><span class="p">(</span><span class="n">conv_op_trans</span><span class="p">,</span><span class="nb">input</span><span class="p">,</span><span class="n">nb_iter</span><span class="o">=</span><span class="n">nb_iter</span><span class="p">,</span><span class="n">tol</span><span class="o">=</span><span class="n">tol</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">out</span>


<span class="k">def</span> <span class="nf">sr_op_trans_stack</span><span class="p">(</span><span class="nb">input</span><span class="p">):</span> <span class="c1"># sum_i w_i*A_i^TA_i</span>
    <span class="n">x</span> <span class="o">=</span> <span class="nb">input</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">upfact</span> <span class="o">=</span> <span class="nb">input</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">ker</span> <span class="o">=</span> <span class="nb">input</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">ker_adj</span> <span class="o">=</span> <span class="nb">input</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
    <span class="n">shap</span> <span class="o">=</span> <span class="n">ker_adj</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">w</span> <span class="o">=</span> <span class="nb">input</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>
    <span class="n">sig</span> <span class="o">=</span> <span class="nb">input</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span>
    <span class="n">flux</span> <span class="o">=</span> <span class="nb">input</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span>
    <span class="n">flux_ref</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">flux</span><span class="p">)</span>
    <span class="n">output</span> <span class="o">=</span> <span class="n">x</span><span class="o">*</span><span class="mi">0</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
        <span class="n">input_op</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="n">input_op</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">input_op</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">upfact</span><span class="p">)</span>
        <span class="n">input_op</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ker</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">])</span>
        <span class="n">output_temp</span> <span class="o">=</span> <span class="n">sr_op</span><span class="p">(</span><span class="n">input_op</span><span class="p">)</span>

        <span class="n">input_trans</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="n">input_trans</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">output_temp</span><span class="p">)</span>
        <span class="n">input_trans</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">upfact</span><span class="p">)</span>
        <span class="n">input_trans</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ker_adj</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">])</span>
        <span class="n">output</span> <span class="o">=</span> <span class="n">output</span> <span class="o">+</span> <span class="p">((</span><span class="n">w</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">*</span><span class="n">flux_ref</span><span class="o">/</span><span class="p">(</span><span class="n">flux</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">*</span><span class="n">sig</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">trans_sr_op</span><span class="p">(</span><span class="n">input_trans</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">output</span>

<span class="k">def</span> <span class="nf">sr_stack_op</span><span class="p">(</span><span class="nb">input</span><span class="p">):</span>
    <span class="n">S</span> <span class="o">=</span> <span class="nb">input</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">upfact</span> <span class="o">=</span> <span class="nb">input</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">ker</span> <span class="o">=</span> <span class="nb">input</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">ker_adj</span> <span class="o">=</span> <span class="nb">input</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
    <span class="n">shap</span> <span class="o">=</span> <span class="n">ker_adj</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">A</span> <span class="o">=</span> <span class="nb">input</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>
    <span class="n">sig</span> <span class="o">=</span> <span class="nb">input</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span>
    <span class="n">flux</span> <span class="o">=</span> <span class="nb">input</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span>
    <span class="n">flux_ref</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">flux</span><span class="p">)</span>
    <span class="n">nb_im</span> <span class="o">=</span> <span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">shapS</span> <span class="o">=</span> <span class="n">S</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">output</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">shapS</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="n">upfact</span><span class="p">,</span><span class="n">shapS</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="n">upfact</span><span class="p">,</span><span class="n">nb_im</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_im</span><span class="p">):</span>
        <span class="n">im_i</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">shapS</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">shapS</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shapS</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
            <span class="n">im_i</span><span class="o">+=</span><span class="n">S</span><span class="p">[:,:,</span><span class="n">j</span><span class="p">]</span><span class="o">*</span><span class="n">A</span><span class="p">[</span><span class="n">j</span><span class="p">,</span><span class="n">i</span><span class="p">]</span>
        <span class="n">output</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">flux</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">/</span><span class="p">(</span><span class="n">flux_ref</span><span class="o">*</span><span class="n">sig</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span><span class="o">*</span><span class="n">utils</span><span class="o">.</span><span class="n">decim</span><span class="p">(</span><span class="n">scisig</span><span class="o">.</span><span class="n">fftconvolve</span><span class="p">(</span><span class="n">im_i</span><span class="p">,</span><span class="n">ker</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">],</span><span class="n">mode</span><span class="o">=</span><span class="s1">&#39;same&#39;</span><span class="p">),</span><span class="n">upfact</span><span class="p">,</span><span class="n">av_en</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">output</span>

<span class="k">def</span> <span class="nf">sr_stack_trans</span><span class="p">(</span><span class="nb">input</span><span class="p">):</span>
    <span class="n">y</span> <span class="o">=</span> <span class="nb">input</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">upfact</span> <span class="o">=</span> <span class="nb">input</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">ker</span> <span class="o">=</span> <span class="nb">input</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">ker_adj</span> <span class="o">=</span> <span class="nb">input</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
    <span class="n">A</span> <span class="o">=</span> <span class="nb">input</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>
    <span class="n">shapA</span> <span class="o">=</span> <span class="n">A</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">sig</span> <span class="o">=</span> <span class="nb">input</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span>
    <span class="n">flux</span> <span class="o">=</span> <span class="nb">input</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span>
    <span class="n">flux_ref</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">flux</span><span class="p">)</span>
    <span class="n">shapy</span> <span class="o">=</span> <span class="n">y</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">output</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">shapy</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">upfact</span><span class="p">,</span><span class="n">shapy</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">upfact</span><span class="p">,</span><span class="n">shapA</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
    <span class="n">nb_im</span> <span class="o">=</span> <span class="n">shapy</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_im</span><span class="p">):</span>
        <span class="n">im_i</span> <span class="o">=</span> <span class="p">(</span><span class="n">flux</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">/</span><span class="p">(</span><span class="n">flux_ref</span><span class="o">*</span><span class="n">sig</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span><span class="o">*</span><span class="n">scisig</span><span class="o">.</span><span class="n">convolve</span><span class="p">(</span><span class="n">utils</span><span class="o">.</span><span class="n">transpose_decim</span><span class="p">(</span><span class="n">y</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">],</span><span class="n">upfact</span><span class="p">),</span><span class="n">ker_adj</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">],</span><span class="n">mode</span><span class="o">=</span><span class="s1">&#39;same&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shapA</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
            <span class="n">output</span><span class="p">[:,:,</span><span class="n">j</span><span class="p">]</span> <span class="o">+=</span> <span class="n">im_i</span><span class="o">*</span><span class="n">A</span><span class="p">[</span><span class="n">j</span><span class="p">,</span><span class="n">i</span><span class="p">]</span>
            <span class="c1">#print &quot;========&gt; param optim :&quot;,(flux[i]/(flux_ref*sig[i]))</span>
    <span class="k">return</span> <span class="n">output</span>

<span class="k">def</span> <span class="nf">sr_stack_trans_op_src</span><span class="p">(</span><span class="nb">input</span><span class="p">):</span> <span class="c1"># M^TM</span>
    <span class="n">output1</span> <span class="o">=</span> <span class="n">sr_stack_op</span><span class="p">(</span><span class="nb">input</span><span class="p">)</span>
    <span class="n">input2</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="nb">input</span><span class="p">)</span>
    <span class="n">input2</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">output1</span>
    <span class="n">output</span> <span class="o">=</span> <span class="n">sr_stack_trans</span><span class="p">(</span><span class="n">input2</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">output</span>


<span class="k">def</span> <span class="nf">sr_stack_trans_op_cons_src</span><span class="p">(</span><span class="nb">input</span><span class="p">):</span> <span class="c1"># M^TM+ AA^T</span>
    <span class="n">output1</span> <span class="o">=</span> <span class="n">sr_stack_trans_op_src</span><span class="p">(</span><span class="nb">input</span><span class="p">)</span>
    <span class="n">S</span> <span class="o">=</span> <span class="nb">input</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">A</span> <span class="o">=</span> <span class="nb">input</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>
    <span class="n">A2</span> <span class="o">=</span> <span class="n">A</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">transpose</span><span class="p">(</span><span class="n">A</span><span class="p">))</span>
    <span class="n">output2</span> <span class="o">=</span> <span class="n">output1</span><span class="o">*</span><span class="mi">0</span>
    <span class="n">shap</span> <span class="o">=</span> <span class="n">A2</span><span class="o">.</span><span class="n">shape</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
            <span class="n">output2</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">]</span> <span class="o">+=</span> <span class="n">S</span><span class="p">[:,:,</span><span class="n">j</span><span class="p">]</span><span class="o">*</span><span class="n">A2</span><span class="p">[</span><span class="n">j</span><span class="p">,</span><span class="n">i</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">output1</span><span class="o">+</span><span class="n">output2</span>


<span class="k">def</span> <span class="nf">sr_op_stack_pseudo_inv</span><span class="p">(</span><span class="nb">input</span><span class="p">):</span>
    <span class="n">stack</span> <span class="o">=</span> <span class="nb">input</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">upfact</span> <span class="o">=</span> <span class="nb">input</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">ker</span> <span class="o">=</span> <span class="nb">input</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">ker_adj</span> <span class="o">=</span> <span class="nb">input</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
    <span class="n">shap</span> <span class="o">=</span> <span class="n">stack</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">w</span> <span class="o">=</span> <span class="nb">input</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>
    <span class="n">sig</span> <span class="o">=</span> <span class="nb">input</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span>
    <span class="n">flux</span> <span class="o">=</span> <span class="nb">input</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span>
    <span class="n">flux_ref</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">flux</span><span class="p">)</span>
    <span class="n">output_temp</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">upfact</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">upfact</span><span class="p">))</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
        <span class="n">input_trans</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="n">input_trans</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">copy</span><span class="p">(</span><span class="n">stack</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">]))</span>
        <span class="n">input_trans</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">upfact</span><span class="p">)</span>
        <span class="n">input_trans</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">copy</span><span class="p">(</span><span class="n">ker_adj</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">]))</span>
        <span class="n">output_temp</span> <span class="o">=</span> <span class="n">output_temp</span> <span class="o">+</span> <span class="p">(</span><span class="n">w</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">*</span><span class="n">flux_ref</span><span class="o">/</span><span class="p">(</span><span class="n">flux</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">*</span><span class="n">sig</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span><span class="o">*</span><span class="n">trans_sr_op</span><span class="p">(</span><span class="n">input_trans</span><span class="p">)</span>

    <span class="c1"># Inversion</span>
    <span class="n">input_2</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
    <span class="n">input_2</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">output_temp</span><span class="p">)</span>
    <span class="n">input_2</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">upfact</span><span class="p">)</span>
    <span class="n">input_2</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">copy</span><span class="p">(</span><span class="n">ker</span><span class="p">))</span>
    <span class="n">input_2</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">copy</span><span class="p">(</span><span class="n">ker_adj</span><span class="p">))</span>
    <span class="n">input_2</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">copy</span><span class="p">(</span><span class="n">w</span><span class="p">))</span>
    <span class="n">input_2</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">copy</span><span class="p">(</span><span class="n">sig</span><span class="p">))</span>
    <span class="n">input_2</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">copy</span><span class="p">(</span><span class="n">flux</span><span class="p">))</span>

    <span class="n">output</span> <span class="o">=</span> <span class="n">conjugate_grad</span><span class="p">(</span><span class="n">sr_op_trans_stack</span><span class="p">,</span><span class="n">input_2</span><span class="p">,</span><span class="n">nb_iter</span><span class="o">=</span><span class="mi">25</span><span class="p">,</span><span class="n">tol</span><span class="o">=</span><span class="mi">10</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mi">5</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">output</span>


<span class="k">def</span> <span class="nf">shift_assign</span><span class="p">(</span><span class="n">shifts</span><span class="p">,</span><span class="n">input_list</span><span class="p">,</span><span class="n">lanc_rad</span><span class="o">=</span><span class="mi">10</span><span class="p">):</span>
    <span class="n">shap</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">shifts</span><span class="p">)</span>
    <span class="n">shifts_in</span> <span class="o">=</span> <span class="n">shifts</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">shap</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span>
    <span class="n">ker</span><span class="p">,</span><span class="n">ker_stack</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">shift_ker_stack</span><span class="p">(</span><span class="n">shifts_in</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">lanc_rad</span><span class="o">=</span><span class="n">lanc_rad</span><span class="p">)</span>
    <span class="nb">input</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">input_list</span><span class="p">)</span>
    <span class="nb">input</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">ker</span><span class="p">)</span>
    <span class="nb">input</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">ker_stack</span><span class="p">)</span>
    <span class="k">return</span> <span class="nb">input</span>

<span class="k">def</span> <span class="nf">sr_shift_penalty</span><span class="p">(</span><span class="nb">input</span><span class="p">):</span>
    <span class="n">x_opt</span> <span class="o">=</span> <span class="n">sr_op_stack_pseudo_inv</span><span class="p">(</span><span class="nb">input</span><span class="p">)</span>
    <span class="n">stack</span> <span class="o">=</span> <span class="nb">input</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">upfact</span> <span class="o">=</span> <span class="nb">input</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">ker</span> <span class="o">=</span> <span class="nb">input</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">ker_adj</span> <span class="o">=</span> <span class="nb">input</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
    <span class="n">shap</span> <span class="o">=</span> <span class="n">stack</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">w</span> <span class="o">=</span> <span class="nb">input</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>
    <span class="n">sig</span> <span class="o">=</span> <span class="nb">input</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span>
    <span class="n">flux</span> <span class="o">=</span> <span class="nb">input</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span>
    <span class="n">flux_ref</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">flux</span><span class="p">)</span>

    <span class="n">cost</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
        <span class="n">input_op</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="n">input_op</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">copy</span><span class="p">(</span><span class="n">x_opt</span><span class="p">))</span>
        <span class="n">input_op</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">upfact</span><span class="p">)</span>
        <span class="n">input_op</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ker</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">])</span>
        <span class="n">output_temp</span> <span class="o">=</span> <span class="n">sr_op</span><span class="p">(</span><span class="n">input_op</span><span class="p">)</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">stack</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="p">(</span><span class="n">w</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">*</span><span class="n">flux_ref</span><span class="o">/</span><span class="p">(</span><span class="n">flux</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">*</span><span class="n">sig</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span><span class="o">*</span><span class="n">output_temp</span>
        <span class="n">cost</span><span class="o">+=</span><span class="p">(</span><span class="n">res</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">cost</span>

<span class="k">def</span> <span class="nf">shifts_optim</span><span class="p">(</span><span class="n">im_stack</span><span class="p">,</span><span class="n">upfact</span><span class="p">,</span><span class="n">shifts_0</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">sig</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">nsig_shift_est</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span><span class="n">flux</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">w</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">lanc_rad</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span><span class="n">shifts_range</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">nb_iter</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>


    <span class="n">shap</span> <span class="o">=</span> <span class="n">im_stack</span><span class="o">.</span><span class="n">shape</span>

    <span class="k">if</span> <span class="n">shifts_0</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">sig_est</span><span class="o">=</span><span class="kc">None</span>
        <span class="k">if</span> <span class="n">sig</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">sig_est</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">im_gauss_nois_est_cube</span><span class="p">(</span><span class="n">im_stack</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">sig_est</span> <span class="o">=</span> <span class="n">sig</span>
        <span class="c1">#shifts = utils.shift_est(psf_stack)*upfact</span>
        <span class="n">anchor</span> <span class="o">=</span> <span class="n">double</span><span class="p">([</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span><span class="o">/</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">upfact</span><span class="p">)</span>
        <span class="nb">map</span> <span class="o">=</span> <span class="n">ones</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
            <span class="nb">map</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">]</span> <span class="o">*=</span> <span class="n">nsig_shift_est</span><span class="o">*</span><span class="n">sig_est</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="nb">print</span> <span class="s1">&#39;First guess estimation...&#39;</span>
        <span class="n">im_stack_shift</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">thresholding_3D</span><span class="p">(</span><span class="n">im_stack</span><span class="p">,</span><span class="nb">map</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">shifts_0</span> <span class="o">=</span> <span class="o">-</span><span class="n">utils</span><span class="o">.</span><span class="n">shift_est_2_anch</span><span class="p">(</span><span class="n">im_stack_shift</span><span class="p">,</span><span class="n">anchor</span><span class="p">)</span><span class="o">*</span><span class="n">upfact</span>
        <span class="nb">print</span> <span class="s1">&#39;Done...&#39;</span>

    <span class="n">ker</span><span class="p">,</span><span class="n">ker_adj</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">shift_ker_stack</span><span class="p">(</span><span class="n">shifts_0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">lanc_rad</span><span class="o">=</span><span class="n">lanc_rad</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">sig</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">sig</span> <span class="o">=</span> <span class="n">ones</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">],))</span>
    <span class="k">if</span> <span class="n">flux</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">flux</span> <span class="o">=</span> <span class="n">ones</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">],))</span>
    <span class="k">if</span> <span class="n">w</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">w</span> <span class="o">=</span> <span class="n">ones</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">],))</span>



    <span class="nb">input</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
    <span class="nb">input</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">im_stack</span><span class="p">)</span>
    <span class="nb">input</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">upfact</span><span class="p">)</span>
    <span class="nb">input</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">copy</span><span class="p">(</span><span class="n">ker</span><span class="p">))</span>
    <span class="nb">input</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">copy</span><span class="p">(</span><span class="n">ker_adj</span><span class="p">))</span>
    <span class="nb">input</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">copy</span><span class="p">(</span><span class="n">w</span><span class="p">))</span>
    <span class="nb">input</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">copy</span><span class="p">(</span><span class="n">sig</span><span class="p">))</span>
    <span class="nb">input</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">copy</span><span class="p">(</span><span class="n">flux</span><span class="p">))</span>
    <span class="n">shifts_0_in</span> <span class="o">=</span> <span class="n">shifts_0</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="mi">2</span><span class="p">,))</span>

    <span class="k">if</span> <span class="n">shifts_range</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">list_range</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="o">*</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
            <span class="n">list_range</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">shifts_0_in</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-</span><span class="n">upfact</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span><span class="n">shifts_0_in</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">+</span><span class="n">upfact</span><span class="o">/</span><span class="mi">2</span><span class="p">))</span>
        <span class="n">shifts_range</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">list_range</span><span class="p">)</span>
    <span class="nb">print</span> <span class="n">shifts_range</span>

    <span class="n">cost_eval</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">shifts</span> <span class="p">:</span> <span class="n">sr_shift_penalty</span><span class="p">(</span><span class="n">shift_assign</span><span class="p">(</span><span class="n">shifts</span><span class="p">,</span><span class="nb">input</span><span class="p">,</span><span class="n">lanc_rad</span><span class="o">=</span><span class="n">lanc_rad</span><span class="p">))</span>
    <span class="nb">print</span> <span class="s2">&quot;Initial cost: &quot;</span><span class="p">,</span><span class="n">cost_eval</span><span class="p">(</span><span class="n">shifts_0_in</span><span class="p">)</span>
    <span class="nb">print</span> <span class="s1">&#39;Shifts estimation...&#39;</span>
    <span class="n">opt</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;maxiter&#39;</span><span class="p">:</span> <span class="n">nb_iter</span><span class="p">,</span><span class="s1">&#39;disp&#39;</span><span class="p">:</span><span class="kc">True</span><span class="p">}</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">minimize</span><span class="p">(</span><span class="n">cost_eval</span><span class="p">,</span><span class="n">shifts_0_in</span><span class="p">,</span><span class="n">bounds</span> <span class="o">=</span> <span class="n">shifts_range</span><span class="p">,</span><span class="n">options</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;maxiter&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;disp&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">})</span>
    <span class="nb">print</span> <span class="s1">&#39;Done...&#39;</span>
    <span class="n">shifts_est</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">x</span>
    <span class="nb">print</span> <span class="s2">&quot;Final cost: &quot;</span><span class="p">,</span><span class="n">cost_eval</span><span class="p">(</span><span class="n">shifts_est</span><span class="p">)</span>

    <span class="n">sr_image</span> <span class="o">=</span> <span class="n">sr_op_stack_pseudo_inv</span><span class="p">(</span><span class="n">shift_assign</span><span class="p">(</span><span class="n">shifts_est</span><span class="p">,</span><span class="nb">input</span><span class="p">,</span><span class="n">lanc_rad</span><span class="o">=</span><span class="n">lanc_rad</span><span class="p">))</span>

    <span class="n">shifts_est</span> <span class="o">=</span> <span class="n">shifts_est</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>

    <span class="n">shift_assign</span><span class="p">(</span><span class="n">shifts</span><span class="p">,</span><span class="n">input_list</span><span class="p">,</span><span class="n">lanc_rad</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">res</span><span class="p">,</span><span class="n">shifts_est</span><span class="p">,</span><span class="n">sr_image</span>





<span class="k">def</span> <span class="nf">sr_op_trans_stack_translate</span><span class="p">(</span><span class="nb">input</span><span class="p">):</span> <span class="c1"># Evaluates (id + lambd*M^TM)x</span>
    <span class="n">lambd</span> <span class="o">=</span> <span class="nb">input</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">out</span> <span class="o">=</span> <span class="nb">input</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">lambd</span><span class="o">*</span><span class="n">sr_op_trans_stack</span><span class="p">(</span><span class="nb">input</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">out</span>

<span class="k">def</span> <span class="nf">sr_op_trans_stack_translate_inv</span><span class="p">(</span><span class="nb">input</span><span class="p">,</span><span class="n">nb_iter</span><span class="p">,</span><span class="n">tol</span><span class="o">=</span><span class="mi">10</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mi">10</span><span class="p">)):</span> <span class="c1"># Evaluates (id + lambd*M^TM)^-1 X</span>
    <span class="n">out</span> <span class="o">=</span> <span class="n">conjugate_grad</span><span class="p">(</span><span class="n">sr_op_trans_stack_translate</span><span class="p">,</span><span class="nb">input</span><span class="p">,</span><span class="n">nb_iter</span><span class="o">=</span><span class="n">nb_iter</span><span class="p">,</span><span class="n">tol</span><span class="o">=</span><span class="n">tol</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">out</span>

<span class="k">def</span> <span class="nf">sr_op_trans_stack_prox</span><span class="p">(</span><span class="nb">input</span><span class="p">,</span><span class="n">nb_iter</span><span class="p">,</span><span class="n">tol</span><span class="o">=</span><span class="mi">10</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mi">15</span><span class="p">)):</span> <span class="c1"># Evaluates the proximity operator of lambd*||y-Mx||^2 at z</span>
    <span class="n">lambd</span> <span class="o">=</span> <span class="nb">input</span><span class="p">[</span><span class="o">-</span><span class="mi">3</span><span class="p">]</span>
    <span class="n">z</span> <span class="o">=</span> <span class="nb">input</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">lr_stack</span> <span class="o">=</span> <span class="nb">input</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="c1"># LR data</span>
    <span class="n">shap</span> <span class="o">=</span> <span class="n">lr_stack</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">temp</span> <span class="o">=</span> <span class="n">z</span><span class="o">*</span><span class="mi">0</span>
    <span class="n">upfact</span> <span class="o">=</span> <span class="nb">input</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>  <span class="c1"># Refer to the above sr_op functions for the convention on the structure function</span>
    <span class="n">ker_adj</span> <span class="o">=</span> <span class="nb">input</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
    <span class="n">w</span> <span class="o">=</span> <span class="nb">input</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>
    <span class="n">sig</span> <span class="o">=</span> <span class="nb">input</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span>
    <span class="n">flux</span> <span class="o">=</span> <span class="nb">input</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span>
    <span class="n">flux_ref</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">flux</span><span class="p">)</span>
    <span class="n">input_trans</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
    <span class="n">input_trans</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">copy</span><span class="p">(</span><span class="n">lr_stack</span><span class="p">[:,:,</span><span class="mi">0</span><span class="p">]))</span>
    <span class="n">input_trans</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">upfact</span><span class="p">)</span>
    <span class="n">input_trans</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">copy</span><span class="p">(</span><span class="n">ker_adj</span><span class="p">[:,:,</span><span class="mi">0</span><span class="p">]))</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
        <span class="n">input_trans</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">lr_stack</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">])</span>
        <span class="n">input_trans</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">ker_adj</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">])</span>
        <span class="n">temp</span> <span class="o">=</span> <span class="n">temp</span> <span class="o">+</span> <span class="p">(</span><span class="n">w</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">*</span><span class="n">flux_ref</span><span class="o">/</span><span class="p">(</span><span class="n">flux</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">*</span><span class="n">sig</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span><span class="o">*</span><span class="n">trans_sr_op</span><span class="p">(</span><span class="n">input_trans</span><span class="p">)</span>

    <span class="nb">input</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">z</span><span class="o">+</span><span class="n">lambd</span><span class="o">*</span><span class="n">temp</span>
    <span class="n">input_loc</span> <span class="o">=</span> <span class="nb">input</span><span class="p">[:</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">out</span> <span class="o">=</span> <span class="n">conjugate_grad</span><span class="p">(</span><span class="n">sr_op_trans_stack_translate</span><span class="p">,</span><span class="n">input_loc</span><span class="p">,</span><span class="n">nb_iter</span><span class="o">=</span><span class="n">nb_iter</span><span class="p">,</span><span class="n">tol</span><span class="o">=</span><span class="n">tol</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">out</span>

<span class="k">def</span> <span class="nf">sr_op_trans_stack_pseudo_inv</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">ker</span><span class="p">,</span><span class="n">ker_adj</span><span class="p">,</span><span class="n">up_fact</span><span class="p">,</span><span class="n">w</span><span class="p">,</span><span class="n">sig</span><span class="p">,</span><span class="n">flux</span><span class="p">,</span><span class="n">nb_iter</span><span class="p">,</span><span class="n">tol</span><span class="o">=</span><span class="mi">10</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mi">4</span><span class="p">)):</span>
    <span class="nb">input</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
    <span class="n">shap</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span>
    <span class="nb">input</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="nb">input</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">up_fact</span><span class="p">)</span>
    <span class="nb">input</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ker</span><span class="p">)</span>
    <span class="nb">input</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ker_adj</span><span class="p">)</span>
    <span class="nb">input</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">w</span><span class="p">)</span>
    <span class="nb">input</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sig</span><span class="p">)</span>
    <span class="nb">input</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">flux</span><span class="p">)</span>
    <span class="n">flux_ref</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">flux</span><span class="p">)</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">up_fact</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">up_fact</span><span class="p">))</span>
    <span class="n">input_trans</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
    <span class="n">input_trans</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">copy</span><span class="p">(</span><span class="n">x</span><span class="p">[:,:,</span><span class="mi">0</span><span class="p">]))</span>
    <span class="n">input_trans</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">up_fact</span><span class="p">)</span>
    <span class="n">input_trans</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">copy</span><span class="p">(</span><span class="n">ker_adj</span><span class="p">[:,:,</span><span class="mi">0</span><span class="p">]))</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
        <span class="n">input_trans</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">x</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">])</span>
        <span class="n">input_trans</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">ker_adj</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">])</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">y</span><span class="o">+</span><span class="p">((</span><span class="n">w</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">*</span><span class="n">flux_ref</span><span class="o">/</span><span class="p">(</span><span class="n">flux</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">*</span><span class="n">sig</span><span class="p">[</span><span class="n">i</span><span class="p">])))</span><span class="o">*</span><span class="n">trans_sr_op</span><span class="p">(</span><span class="n">input_trans</span><span class="p">)</span>
    <span class="nb">input</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="n">y</span>
    <span class="n">out</span> <span class="o">=</span> <span class="n">conjugate_grad</span><span class="p">(</span><span class="n">sr_op_trans_stack</span><span class="p">,</span><span class="nb">input</span><span class="p">,</span><span class="n">nb_iter</span><span class="o">=</span><span class="n">nb_iter</span><span class="p">,</span><span class="n">tol</span><span class="o">=</span><span class="n">tol</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">out</span>

<span class="sd">&quot;&quot;&quot;def sr_op_trans_stack_pseudo_inv_ortho(x,ker,ker_adj,up_fact,w,sig,flux,nb_iter,src,tol=10**(-4)):</span>
<span class="sd">    input = list()</span>
<span class="sd">    shap = x.shape</span>
<span class="sd">    input.append(x)</span>
<span class="sd">    input.append(up_fact)</span>
<span class="sd">    input.append(ker)</span>
<span class="sd">    input.append(ker_adj)</span>
<span class="sd">    input.append(w)</span>
<span class="sd">    input.append(sig)</span>
<span class="sd">    input.append(flux)</span>
<span class="sd">    flux_ref = np.median(flux)</span>
<span class="sd">    y = zeros((shap[0]*up_fact,shap[1]*up_fact))</span>
<span class="sd">    input_trans = list()</span>
<span class="sd">    input_trans.append(copy(x[:,:,0]))</span>
<span class="sd">    input_trans.append(up_fact)</span>
<span class="sd">    input_trans.append(copy(ker_adj[:,:,0]))</span>

<span class="sd">    for i in range(0,shap[2]):</span>
<span class="sd">        input_trans[0] = copy(x[:,:,i])</span>
<span class="sd">        input_trans[2] = copy(ker_adj[:,:,i])</span>
<span class="sd">        y = y+((w[i]*flux_ref/(flux[i]*sig[i])))*trans_sr_op(input_trans)</span>
<span class="sd">    input[0]=copy(y)</span>
<span class="sd">    lsq = conjugate_grad(sr_op_trans_stack,input,nb_iter=nb_iter,tol=tol)</span>
<span class="sd">    shap = src.shape</span>
<span class="sd">    temp = copy(src)</span>
<span class="sd">    if size(shap)&gt;2:</span>
<span class="sd">        for i in range(0,shap[2]):</span>

<span class="sd">            temp[:,:,i] =</span>
<span class="sd">return out&quot;&quot;&quot;</span>

<span class="k">def</span> <span class="nf">sr_op_equal_cons</span><span class="p">(</span><span class="n">y</span><span class="p">,</span><span class="n">target_im</span><span class="p">,</span><span class="n">upfact</span><span class="p">,</span><span class="n">ker</span><span class="p">,</span><span class="n">ker_adj</span><span class="p">,</span><span class="n">nb_iter</span><span class="o">=</span><span class="mi">100</span><span class="p">):</span> <span class="c1"># Projection of y onto the contraint target_im = D*W*x where D and W are respectively shift and downsampling operators</span>

    <span class="n">u</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">decim</span><span class="p">(</span><span class="n">scisig</span><span class="o">.</span><span class="n">fftconvolve</span><span class="p">(</span><span class="n">y</span><span class="p">,</span><span class="n">ker</span><span class="p">,</span><span class="n">mode</span><span class="o">=</span><span class="s1">&#39;same&#39;</span><span class="p">),</span><span class="n">upfact</span><span class="p">,</span><span class="n">av_en</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">-</span><span class="n">target_im</span>

    <span class="n">op_param</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
    <span class="n">op_param</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">copy</span><span class="p">(</span><span class="n">u</span><span class="p">))</span>
    <span class="n">op_param</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">upfact</span><span class="p">)</span>
    <span class="n">op_param</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ker</span><span class="p">)</span>
    <span class="n">op_param</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ker_adj</span><span class="p">)</span>
    <span class="n">v</span> <span class="o">=</span> <span class="n">conjugate_grad</span><span class="p">(</span><span class="n">conjugate_grad</span><span class="p">,</span><span class="n">op_param</span><span class="p">,</span><span class="n">nb_iter</span><span class="o">=</span><span class="n">nb_iter</span><span class="p">)</span>

    <span class="n">proj</span> <span class="o">=</span> <span class="n">y</span> <span class="o">-</span> <span class="n">scisig</span><span class="o">.</span><span class="n">convolve</span><span class="p">(</span><span class="n">utils</span><span class="o">.</span><span class="n">transpose_decim</span><span class="p">(</span><span class="n">v</span><span class="p">,</span><span class="n">upfact</span><span class="p">),</span><span class="n">ker_adj</span><span class="p">,</span><span class="n">mode</span><span class="o">=</span><span class="s1">&#39;same&#39;</span><span class="p">)</span>
    <span class="n">err</span> <span class="o">=</span> <span class="p">((</span><span class="n">utils</span><span class="o">.</span><span class="n">decim</span><span class="p">(</span><span class="n">scisig</span><span class="o">.</span><span class="n">fftconvolve</span><span class="p">(</span><span class="n">proj</span><span class="p">,</span><span class="n">ker</span><span class="p">,</span><span class="n">mode</span><span class="o">=</span><span class="s1">&#39;same&#39;</span><span class="p">),</span><span class="n">upfact</span><span class="p">,</span><span class="n">av_en</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">-</span><span class="n">target_im</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">/</span><span class="p">(</span><span class="n">target_im</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    <span class="nb">print</span> <span class="s2">&quot;Projection error: &quot;</span><span class="p">,</span><span class="n">err</span>
    <span class="k">return</span> <span class="n">proj</span>

<span class="k">def</span> <span class="nf">sr_op_inequal_cons</span><span class="p">(</span><span class="n">y</span><span class="p">,</span><span class="n">target_im</span><span class="p">,</span><span class="n">upfact</span><span class="p">,</span><span class="n">ker</span><span class="p">,</span><span class="n">ker_adj</span><span class="p">,</span><span class="n">sigma</span><span class="p">,</span><span class="n">u_init</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">nb_iter</span><span class="o">=</span><span class="mi">100</span><span class="p">):</span>

    <span class="n">shap</span> <span class="o">=</span> <span class="n">target_im</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">if</span> <span class="n">u_init</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">u_init</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">(</span><span class="n">shap</span><span class="p">)</span>
    <span class="n">o</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">(</span><span class="n">shap</span><span class="p">)</span>
    <span class="n">u</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">u_init</span><span class="p">)</span>
    <span class="n">p</span> <span class="o">=</span> <span class="n">y</span> <span class="o">-</span> <span class="n">scisig</span><span class="o">.</span><span class="n">convolve</span><span class="p">(</span><span class="n">utils</span><span class="o">.</span><span class="n">transpose_decim</span><span class="p">(</span><span class="n">u_init</span><span class="p">,</span><span class="n">upfact</span><span class="p">),</span><span class="n">ker_adj</span><span class="p">,</span><span class="n">mode</span><span class="o">=</span><span class="s1">&#39;same&#39;</span><span class="p">)</span>
    <span class="n">mu</span> <span class="o">=</span> <span class="mi">1</span><span class="o">/</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">ker</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_iter</span><span class="p">):</span>
        <span class="n">z</span> <span class="o">=</span> <span class="n">u</span><span class="o">/</span><span class="n">mu</span> <span class="o">+</span> <span class="n">utils</span><span class="o">.</span><span class="n">decim</span><span class="p">(</span><span class="n">scisig</span><span class="o">.</span><span class="n">fftconvolve</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">ker</span><span class="p">,</span><span class="n">mode</span><span class="o">=</span><span class="s1">&#39;same&#39;</span><span class="p">),</span><span class="n">upfact</span><span class="p">,</span><span class="n">av_en</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">-</span><span class="n">target_im</span>
        <span class="n">u</span> <span class="o">=</span> <span class="n">mu</span><span class="o">*</span><span class="p">(</span><span class="n">z</span><span class="o">-</span><span class="n">proj_sphere</span><span class="p">(</span><span class="n">z</span><span class="p">,</span><span class="n">o</span><span class="p">,</span><span class="n">sigma</span><span class="p">))</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">alpha</span> <span class="o">-</span> <span class="n">scisig</span><span class="o">.</span><span class="n">convolve</span><span class="p">(</span><span class="n">utils</span><span class="o">.</span><span class="n">transpose_decim</span><span class="p">(</span><span class="n">u</span><span class="p">,</span><span class="n">upfact</span><span class="p">),</span><span class="n">ker_adj</span><span class="p">,</span><span class="n">mode</span><span class="o">=</span><span class="s1">&#39;same&#39;</span><span class="p">)</span>
    <span class="nb">print</span> <span class="s1">&#39;radius :&#39;</span><span class="p">,</span><span class="n">sigma</span><span class="p">,</span><span class="s1">&#39; Current dist: &#39;</span><span class="p">,</span><span class="n">sqrt</span><span class="p">(((</span><span class="n">target_im</span><span class="o">-</span><span class="n">utils</span><span class="o">.</span><span class="n">decim</span><span class="p">(</span><span class="n">scisig</span><span class="o">.</span><span class="n">fftconvolve</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">ker</span><span class="p">,</span><span class="n">mode</span><span class="o">=</span><span class="s1">&#39;same&#39;</span><span class="p">),</span><span class="n">upfact</span><span class="p">,</span><span class="n">av_en</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span>
    <span class="n">u_init</span> <span class="o">=</span> <span class="n">u</span>
    <span class="k">return</span> <span class="n">p</span><span class="p">,</span><span class="n">u_init</span>

<span class="k">def</span> <span class="nf">lowrank_sr_eq_cons_dr</span><span class="p">(</span><span class="n">psf_stack</span><span class="p">,</span><span class="n">shift</span><span class="p">,</span><span class="n">upfact</span><span class="p">,</span><span class="n">nb_iter</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span><span class="n">mu</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span><span class="n">n_eig</span><span class="o">=</span><span class="mi">3</span><span class="p">):</span> <span class="c1"># n_eig: order of the reference eigenvalue</span>

    <span class="n">shap</span> <span class="o">=</span> <span class="n">psf_stack</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">mat_stack</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span> <span class="c1"># Images correspond to lines</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
        <span class="n">mat_stack</span><span class="p">[</span><span class="n">i</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">psf_stack</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">],))</span>
    <span class="n">U</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">Vt</span> <span class="o">=</span> <span class="n">linalg</span><span class="o">.</span><span class="n">svd</span><span class="p">(</span><span class="n">mat_stack</span><span class="p">,</span><span class="n">full_matrices</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">gamma</span> <span class="o">=</span> <span class="n">s</span><span class="p">[</span><span class="n">n_eig</span><span class="p">]</span><span class="o">*</span><span class="n">upfact</span><span class="o">**</span><span class="mi">2</span>
    <span class="n">nu</span> <span class="o">=</span> <span class="n">gamma</span><span class="o">*</span><span class="n">ones</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">],))</span>
    <span class="n">im_hr</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">upfact</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">upfact</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>
    <span class="n">mat_hr</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">upfact</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span>
    <span class="n">thresh_type</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="n">shift_ker_stack</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="mi">2</span><span class="o">*</span><span class="n">lanc_rad</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="o">*</span><span class="n">lanc_rad</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>
    <span class="n">shift_ker_stack_adj</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="mi">2</span><span class="o">*</span><span class="n">lanc_rad</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="o">*</span><span class="n">lanc_rad</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
        <span class="n">uin</span> <span class="o">=</span> <span class="n">shifts</span><span class="p">[</span><span class="n">i</span><span class="p">,:]</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span><span class="o">*</span><span class="n">upfact</span>
        <span class="n">shift_ker_stack</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">lanczos</span><span class="p">(</span><span class="n">uin</span><span class="p">,</span><span class="n">n</span><span class="o">=</span><span class="n">lanc_rad</span><span class="p">)</span>
        <span class="n">shift_ker_stack_adj</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">rot90</span><span class="p">(</span><span class="n">shift_ker_stack</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">],</span><span class="mi">2</span><span class="p">)</span>


    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_iter</span><span class="p">):</span>

        <span class="c1"># ------- Low rank constraint ----- #</span>
        <span class="n">mat_temp</span><span class="p">,</span><span class="n">si</span><span class="p">,</span><span class="n">U</span><span class="p">,</span><span class="n">Vt</span> <span class="o">=</span> <span class="n">nuc_norm_thresh</span><span class="p">(</span><span class="n">mat_hr</span><span class="p">,</span><span class="n">nu</span><span class="o">*</span><span class="n">w</span><span class="p">,</span><span class="n">thresh_type</span><span class="p">)</span>
        <span class="n">mat_hr</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">mat_temp</span> <span class="o">-</span> <span class="n">mat_hr</span>

        <span class="c1"># ------- Equality constraint ----- #</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
            <span class="n">temp_k</span> <span class="o">=</span> <span class="n">sr_op_equal_cons</span><span class="p">(</span><span class="n">mat_hr</span><span class="p">[</span><span class="n">k</span><span class="p">,:]</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">])),</span><span class="n">psf_stack</span><span class="p">[:,:,</span><span class="n">k</span><span class="p">],</span><span class="n">upfact</span><span class="p">,</span><span class="n">shift_ker_stack</span><span class="p">[:,:,</span><span class="n">k</span><span class="p">],</span><span class="n">shift_ker_stack_adj</span><span class="p">[:,:,</span><span class="n">k</span><span class="p">],</span><span class="n">nb_iter</span><span class="o">=</span><span class="mi">50</span><span class="p">)</span>
            <span class="n">im_hr</span><span class="p">[:,:,</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">mu</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">im_hr</span><span class="p">[:,:,</span><span class="n">k</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="n">mu</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">temp_k</span><span class="o">-</span><span class="n">mat_hr</span><span class="p">[</span><span class="n">k</span><span class="p">,:]</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">])))</span>
            <span class="n">mat_hr</span><span class="p">[</span><span class="n">k</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">im_hr</span><span class="p">[:,:,</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>


        <span class="n">U</span><span class="p">,</span> <span class="n">si</span><span class="p">,</span> <span class="n">Vt</span> <span class="o">=</span> <span class="n">linalg</span><span class="o">.</span><span class="n">svd</span><span class="p">(</span><span class="n">mat_hr</span><span class="p">,</span><span class="n">full_matrices</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="nb">print</span> <span class="s1">&#39;Nuclear norm: &#39;</span><span class="p">,</span><span class="nb">abs</span><span class="p">(</span><span class="n">si</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">im_hr</span><span class="p">,</span><span class="n">mat_hr</span>


<span class="k">def</span> <span class="nf">lowrank_sr_ineq_cons_dr</span><span class="p">(</span><span class="n">psf_stack</span><span class="p">,</span><span class="n">shift</span><span class="p">,</span><span class="n">upfact</span><span class="p">,</span><span class="n">nb_iter</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span><span class="n">mu</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span><span class="n">n_eig</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span><span class="n">p_val_chi2</span><span class="o">=</span><span class="mf">0.95</span><span class="p">):</span> <span class="c1"># n_eig: order of the reference eigenvalue</span>

    <span class="n">shap</span> <span class="o">=</span> <span class="n">psf_stack</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">mat_stack</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span> <span class="c1"># Images correspond to lines</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
        <span class="n">mat_stack</span><span class="p">[</span><span class="n">i</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">psf_stack</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">],))</span>
    <span class="n">U</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">Vt</span> <span class="o">=</span> <span class="n">linalg</span><span class="o">.</span><span class="n">svd</span><span class="p">(</span><span class="n">mat_stack</span><span class="p">,</span><span class="n">full_matrices</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">gamma</span> <span class="o">=</span> <span class="n">s</span><span class="p">[</span><span class="n">n_eig</span><span class="p">]</span><span class="o">*</span><span class="n">upfact</span><span class="o">**</span><span class="mi">2</span>
    <span class="n">nu</span> <span class="o">=</span> <span class="n">gamma</span><span class="o">*</span><span class="n">ones</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">],))</span>
    <span class="n">im_hr</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">upfact</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">upfact</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>
    <span class="n">mat_hr</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">upfact</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span>
    <span class="n">thresh_type</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">res_stack</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">psf_stack</span><span class="p">)</span>
    <span class="n">shift_ker_stack</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="mi">2</span><span class="o">*</span><span class="n">lanc_rad</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="o">*</span><span class="n">lanc_rad</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>
    <span class="n">shift_ker_stack_adj</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="mi">2</span><span class="o">*</span><span class="n">lanc_rad</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="o">*</span><span class="n">lanc_rad</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
        <span class="n">uin</span> <span class="o">=</span> <span class="n">shifts</span><span class="p">[</span><span class="n">i</span><span class="p">,:]</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span><span class="o">*</span><span class="n">upfact</span>
        <span class="n">shift_ker_stack</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">lanczos</span><span class="p">(</span><span class="n">uin</span><span class="p">,</span><span class="n">n</span><span class="o">=</span><span class="n">lanc_rad</span><span class="p">)</span>
        <span class="n">shift_ker_stack_adj</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">rot90</span><span class="p">(</span><span class="n">shift_ker_stack</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">],</span><span class="mi">2</span><span class="p">)</span>


    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_iter</span><span class="p">):</span>

        <span class="c1"># ------- Low rank constraint ----- #</span>
        <span class="n">mat_temp</span><span class="p">,</span><span class="n">si</span><span class="p">,</span><span class="n">U</span><span class="p">,</span><span class="n">Vt</span> <span class="o">=</span> <span class="n">nuc_norm_thresh</span><span class="p">(</span><span class="n">mat_hr</span><span class="p">,</span><span class="n">nu</span><span class="o">*</span><span class="n">w</span><span class="p">,</span><span class="n">thresh_type</span><span class="p">)</span>
        <span class="n">mat_hr</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">mat_temp</span> <span class="o">-</span> <span class="n">mat_hr</span>

        <span class="c1"># ------- Inequality constraint ----- #</span>

        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
            <span class="n">res_stack</span><span class="p">[:,:,</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">decim</span><span class="p">(</span><span class="n">scisig</span><span class="o">.</span><span class="n">fftconvolve</span><span class="p">(</span><span class="n">mat_hr</span><span class="p">[</span><span class="n">k</span><span class="p">,:]</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">])),</span><span class="n">shift_ker_stack</span><span class="p">[:,:,</span><span class="n">k</span><span class="p">],</span><span class="n">mode</span><span class="o">=</span><span class="s1">&#39;same&#39;</span><span class="p">),</span><span class="n">upfact</span><span class="p">,</span><span class="n">av_en</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">-</span><span class="n">psf_stack</span><span class="p">[:,:,</span><span class="n">k</span><span class="p">]</span>
            <span class="n">sig</span> <span class="o">=</span> <span class="n">im_gauss_nois_est</span><span class="p">(</span><span class="n">res_stack</span><span class="p">[:,:,</span><span class="n">k</span><span class="p">])</span>
            <span class="n">r</span> <span class="o">=</span> <span class="n">sig</span><span class="o">*</span><span class="n">scistats</span><span class="o">.</span><span class="n">chi2</span><span class="o">.</span><span class="n">interval</span><span class="p">(</span><span class="n">p_val_chi2</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">temp_k</span> <span class="o">=</span> <span class="n">sr_op_inequal_cons</span><span class="p">(</span><span class="n">mat_hr</span><span class="p">[</span><span class="n">k</span><span class="p">,:]</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">])),</span><span class="n">psf_stack</span><span class="p">[:,:,</span><span class="n">k</span><span class="p">],</span><span class="n">upfact</span><span class="p">,</span><span class="n">shift_ker_stack</span><span class="p">[:,:,</span><span class="n">k</span><span class="p">],</span><span class="n">shift_ker_stack_adj</span><span class="p">[:,:,</span><span class="n">k</span><span class="p">],</span><span class="n">r</span><span class="p">,</span><span class="n">nb_iter</span><span class="o">=</span><span class="mi">50</span><span class="p">)</span>
            <span class="n">im_hr</span><span class="p">[:,:,</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">mu</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">im_hr</span><span class="p">[:,:,</span><span class="n">k</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="n">mu</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">temp_k</span><span class="o">-</span><span class="n">mat_hr</span><span class="p">[</span><span class="n">k</span><span class="p">,:]</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">])))</span>
            <span class="n">mat_hr</span><span class="p">[</span><span class="n">k</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">im_hr</span><span class="p">[:,:,</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>

        <span class="n">U</span><span class="p">,</span> <span class="n">si</span><span class="p">,</span> <span class="n">Vt</span> <span class="o">=</span> <span class="n">linalg</span><span class="o">.</span><span class="n">svd</span><span class="p">(</span><span class="n">mat_hr</span><span class="p">,</span><span class="n">full_matrices</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="nb">print</span> <span class="s1">&#39;Nuclear norm: &#39;</span><span class="p">,</span><span class="nb">abs</span><span class="p">(</span><span class="n">si</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">im_hr</span><span class="p">,</span><span class="n">mat_hr</span>

<span class="k">def</span> <span class="nf">non_unif_smoothing</span><span class="p">(</span><span class="n">tree</span><span class="p">,</span><span class="n">weights</span><span class="p">,</span><span class="n">first_guess</span><span class="p">,</span><span class="n">lr_data</span><span class="p">,</span><span class="n">lr_data_est</span><span class="p">,</span><span class="n">mu</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">spec_rad</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">nb_iter</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span><span class="n">tol</span><span class="o">=</span><span class="mf">0.01</span><span class="p">):</span>
    <span class="n">shap</span> <span class="o">=</span> <span class="n">lr_data</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">bound</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">],))</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
        <span class="n">bound</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="n">lr_data</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">]</span><span class="o">*</span><span class="n">lr_data_est</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">])</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">/</span><span class="p">(</span><span class="n">lr_data_est</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">-</span> <span class="n">first_guess</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

    <span class="n">a</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">weights</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">spec_rad</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">spec_rad</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">a</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span> <span class="s2">&quot;real spec rad: &quot;</span><span class="p">,</span><span class="n">spec_rad</span><span class="p">,</span><span class="s2">&quot; estimate: &quot;</span><span class="p">,</span><span class="mi">2</span><span class="o">*</span><span class="n">a</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>

    <span class="n">x</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">first_guess</span><span class="p">)</span>
    <span class="n">z</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">t</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">cost_ref</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">res_ref</span> <span class="o">=</span><span class="mi">0</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
        <span class="n">res_ref</span> <span class="o">=</span> <span class="n">res_ref</span><span class="o">+</span><span class="p">((</span><span class="n">lr_data</span><span class="p">[:,:,</span><span class="n">k</span><span class="p">]</span><span class="o">-</span><span class="n">first_guess</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">*</span><span class="n">lr_data_est</span><span class="p">[:,:,</span><span class="n">k</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    <span class="nb">print</span> <span class="s2">&quot;-------res_ref: &quot;</span><span class="p">,</span><span class="n">res_ref</span><span class="p">,</span><span class="s2">&quot;-------&quot;</span>
    <span class="n">cost_old</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">cost</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">i</span><span class="o">=</span><span class="mi">0</span>
    <span class="k">while</span> <span class="n">i</span> <span class="o">&lt;</span><span class="n">nb_iter</span> <span class="ow">and</span> <span class="mi">100</span><span class="o">*</span><span class="nb">abs</span><span class="p">(</span><span class="n">cost</span><span class="o">-</span><span class="n">cost_old</span><span class="p">)</span><span class="o">/</span><span class="n">cost</span><span class="o">&gt;</span><span class="n">tol</span><span class="p">:</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">z</span> <span class="o">-</span> <span class="n">mu</span><span class="o">*</span><span class="n">grad_nn_unif_smooth</span><span class="p">(</span><span class="n">z</span><span class="p">,</span><span class="n">tree</span><span class="p">,</span><span class="n">weights</span><span class="p">,</span><span class="n">a</span><span class="p">)</span><span class="o">/</span><span class="n">spec_rad</span>
        <span class="n">x_old</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">pt_wise_bound</span><span class="p">(</span><span class="n">y</span><span class="p">,</span><span class="n">first_guess</span><span class="p">,</span><span class="n">bound</span><span class="p">)</span>
        <span class="n">t_old</span> <span class="o">=</span> <span class="n">t</span>
        <span class="n">t</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">4</span><span class="o">*</span><span class="n">t</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span><span class="o">/</span><span class="mi">2</span>
        <span class="n">lambd</span> <span class="o">=</span> <span class="mi">1</span><span class="o">+</span><span class="p">(</span><span class="n">t_old</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="n">t</span>
        <span class="n">z</span> <span class="o">=</span> <span class="n">x_old</span> <span class="o">+</span> <span class="n">lambd</span><span class="o">*</span><span class="p">(</span><span class="n">x</span><span class="o">-</span><span class="n">x_old</span><span class="p">)</span>
        <span class="n">res</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="n">i</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
            <span class="n">cost_old</span> <span class="o">=</span> <span class="n">cost</span>
        <span class="n">cost</span><span class="o">=</span><span class="mi">0</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
            <span class="n">res</span> <span class="o">=</span> <span class="n">res</span><span class="o">+</span><span class="p">((</span><span class="n">lr_data</span><span class="p">[:,:,</span><span class="n">k</span><span class="p">]</span><span class="o">-</span><span class="n">z</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">*</span><span class="n">lr_data_est</span><span class="p">[:,:,</span><span class="n">k</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
            <span class="n">cost</span> <span class="o">=</span> <span class="n">cost</span><span class="o">+</span> <span class="p">(((</span><span class="n">z</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">*</span><span class="n">ones</span><span class="p">((</span><span class="n">size</span><span class="p">(</span><span class="n">tree</span><span class="p">[</span><span class="n">k</span><span class="p">,:]),))</span><span class="o">-</span><span class="n">z</span><span class="p">[</span><span class="n">tree</span><span class="p">[</span><span class="n">k</span><span class="p">,:]])</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">weights</span><span class="p">[</span><span class="n">k</span><span class="p">,:])</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="nb">print</span> <span class="s2">&quot;cost: &quot;</span><span class="p">,</span><span class="n">cost</span><span class="p">,</span><span class="s2">&quot; res: &quot;</span><span class="p">,</span><span class="n">res</span>
        <span class="n">i</span><span class="o">+=</span><span class="mi">1</span>
    <span class="k">return</span> <span class="n">z</span>

<span class="k">def</span> <span class="nf">lsq_coeff2D</span><span class="p">(</span><span class="n">u</span><span class="p">,</span><span class="n">v</span><span class="p">):</span> <span class="c1"># Find the scalar a which minimizes ||a*u-v||^2</span>
    <span class="n">a</span> <span class="o">=</span> <span class="p">(</span><span class="n">u</span><span class="o">*</span><span class="n">v</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">/</span><span class="p">(</span><span class="n">u</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">a</span>

<span class="k">def</span> <span class="nf">lsq_coeff_stack</span><span class="p">(</span><span class="n">u</span><span class="p">,</span><span class="n">v</span><span class="p">):</span>
    <span class="n">shap</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">a</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">],))</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
        <span class="n">a</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">lsq_coeff2D</span><span class="p">(</span><span class="n">u</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">],</span><span class="n">v</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">a</span>

<span class="k">def</span> <span class="nf">lsq_mult_coeff</span><span class="p">(</span><span class="n">im</span><span class="p">,</span><span class="n">src</span><span class="p">,</span><span class="n">man</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="n">shap</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">mat</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
            <span class="n">mat</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">src</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">]</span><span class="o">*</span><span class="n">src</span><span class="p">[:,:,</span><span class="n">j</span><span class="p">])</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    <span class="n">v</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="mi">1</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
        <span class="n">v</span><span class="p">[</span><span class="n">k</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">im</span><span class="o">*</span><span class="n">src</span><span class="p">[:,:,</span><span class="n">k</span><span class="p">])</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>

    <span class="n">output</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">man</span><span class="p">:</span>
        <span class="n">output</span> <span class="o">=</span> <span class="n">man_inv</span><span class="p">(</span><span class="n">mat</span><span class="p">)</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">output</span> <span class="o">=</span> <span class="n">LA</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">mat</span><span class="p">)</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">output</span><span class="p">,</span><span class="n">mat</span><span class="p">,</span><span class="n">v</span>

<span class="k">def</span> <span class="nf">man_inv</span><span class="p">(</span><span class="n">mat</span><span class="p">,</span><span class="n">cond</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="n">U</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">Vt</span> <span class="o">=</span> <span class="n">linalg</span><span class="o">.</span><span class="n">svd</span><span class="p">(</span><span class="n">mat</span><span class="p">,</span><span class="n">full_matrices</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="n">eig</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">s</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">s</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">s</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
        <span class="k">if</span> <span class="n">cond</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">s</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">&gt;</span><span class="n">s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="n">cond</span><span class="p">:</span>
                <span class="n">eig</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">eig</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">cond</span><span class="o">/</span><span class="n">s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">s</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
                <span class="n">eig</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">inv</span> <span class="o">=</span> <span class="n">U</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">eig</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">Vt</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">inv</span>


<span class="k">def</span> <span class="nf">lsq_mult_coeff_stack</span><span class="p">(</span><span class="n">im</span><span class="p">,</span><span class="n">src</span><span class="p">,</span><span class="n">man</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="n">shap1</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">shap2</span> <span class="o">=</span> <span class="n">im</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">coeff_out</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">shap1</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">shap2</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>
    <span class="n">v</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">shap1</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">shap2</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>
    <span class="n">mat</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">shap1</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">shap1</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">shap1</span><span class="p">[</span><span class="mi">3</span><span class="p">]))</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap2</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
        <span class="n">outi</span><span class="p">,</span><span class="n">mati</span><span class="p">,</span><span class="n">vi</span> <span class="o">=</span> <span class="n">lsq_mult_coeff</span><span class="p">(</span><span class="n">im</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">],</span><span class="n">src</span><span class="p">[:,:,:,</span><span class="n">i</span><span class="p">],</span><span class="n">man</span><span class="o">=</span><span class="n">man</span><span class="p">)</span>
        <span class="n">coeff_out</span><span class="p">[:,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">outi</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">shap1</span><span class="p">[</span><span class="mi">2</span><span class="p">],))</span>
        <span class="n">mat</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">mati</span><span class="p">)</span>
        <span class="n">v</span><span class="p">[:,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">vi</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">shap1</span><span class="p">[</span><span class="mi">2</span><span class="p">],))</span>
    <span class="k">return</span> <span class="n">coeff_out</span><span class="p">,</span><span class="n">mat</span><span class="p">,</span><span class="n">v</span>

<span class="k">def</span> <span class="nf">lsq_mult_coeff_stack_pos</span><span class="p">(</span><span class="n">im</span><span class="p">,</span><span class="n">src_hr</span><span class="p">,</span><span class="n">src_lr</span><span class="p">,</span><span class="n">tol_neg</span><span class="o">=-</span><span class="mi">10</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mi">18</span><span class="p">),</span><span class="n">nb_iter</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span><span class="n">z_init</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">mu</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span><span class="n">tol</span><span class="o">=</span><span class="mf">0.00001</span><span class="p">):</span>
    <span class="n">coeff_lsq</span><span class="p">,</span><span class="n">mat</span><span class="p">,</span><span class="n">v</span> <span class="o">=</span> <span class="n">lsq_mult_coeff_stack</span><span class="p">(</span><span class="n">im</span><span class="p">,</span><span class="n">src_lr</span><span class="p">)</span>
    <span class="n">coeff_pos</span> <span class="o">=</span> <span class="n">coeff_lsq</span><span class="o">*</span><span class="mi">0</span>
    <span class="n">shap</span> <span class="o">=</span> <span class="n">src_lr</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">nb_im</span> <span class="o">=</span> <span class="n">shap</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
    <span class="n">nb_src</span> <span class="o">=</span> <span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">shap2</span> <span class="o">=</span> <span class="n">src_hr</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">z</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">shap2</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">shap2</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">nb_im</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">z_init</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">z</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">z_init</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">z</span><span class="p">)</span>
    <span class="n">grad</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">t</span><span class="o">=</span><span class="mi">0</span>
    <span class="n">mats</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>
    <span class="k">for</span> <span class="n">k1</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
        <span class="k">for</span> <span class="n">k2</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">k1</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
            <span class="n">mats</span><span class="p">[</span><span class="n">k1</span><span class="p">,</span><span class="n">k2</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">src_hr</span><span class="p">[:,:,</span><span class="n">k1</span><span class="p">]</span><span class="o">*</span><span class="n">src_hr</span><span class="p">[:,:,</span><span class="n">k2</span><span class="p">])</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
            <span class="n">mats</span><span class="p">[</span><span class="n">k2</span><span class="p">,</span><span class="n">k1</span><span class="p">]</span> <span class="o">=</span> <span class="n">mats</span><span class="p">[</span><span class="n">k1</span><span class="p">,</span><span class="n">k2</span><span class="p">]</span>
    <span class="n">spec_rad</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">3</span><span class="p">]))</span>
    <span class="n">U</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">Vt</span> <span class="o">=</span> <span class="n">linalg</span><span class="o">.</span><span class="n">svd</span><span class="p">(</span><span class="n">mats</span><span class="p">,</span><span class="n">full_matrices</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">spec1</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">3</span><span class="p">]):</span>
        <span class="n">U</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">Vt</span> <span class="o">=</span> <span class="n">linalg</span><span class="o">.</span><span class="n">svd</span><span class="p">(</span><span class="n">mat</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">],</span><span class="n">full_matrices</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">spec_rad</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">spec1</span><span class="o">*</span><span class="n">s</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
    <span class="n">res</span><span class="o">=</span><span class="mi">1</span>
    <span class="n">res_old</span><span class="o">=</span><span class="mi">0</span>
    <span class="n">k</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">im_est_hr</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">shap2</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">shap2</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">nb_im</span><span class="p">))</span>
    <span class="k">while</span> <span class="n">k</span> <span class="o">&lt;</span><span class="n">nb_iter</span> <span class="ow">and</span> <span class="mi">100</span><span class="o">*</span><span class="nb">abs</span><span class="p">(</span><span class="n">res</span><span class="o">-</span><span class="n">res_old</span><span class="p">)</span><span class="o">/</span><span class="n">res</span><span class="o">&gt;</span><span class="n">tol</span><span class="p">:</span>
        <span class="n">k</span><span class="o">+=</span><span class="mi">1</span>
        <span class="n">res_old</span><span class="o">=</span><span class="n">res</span>
        <span class="n">res</span><span class="o">=</span><span class="mi">0</span>
        <span class="n">told</span> <span class="o">=</span> <span class="n">t</span>
        <span class="n">t</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">4</span><span class="o">*</span><span class="n">t</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span><span class="o">/</span><span class="mi">2</span>
        <span class="n">lambd</span> <span class="o">=</span> <span class="mi">1</span><span class="o">+</span><span class="p">(</span><span class="n">told</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="n">t</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_im</span><span class="p">):</span>
            <span class="n">v1</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">nb_src</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_src</span><span class="p">):</span>
                <span class="n">v1</span><span class="p">[</span><span class="n">l</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">src_hr</span><span class="p">[:,:,</span><span class="n">l</span><span class="p">]</span><span class="o">*</span><span class="n">z</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">])</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
            <span class="c1"># Primal variable update (not mandatory)</span>
            <span class="n">coeff_pos</span><span class="p">[:,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="p">(</span><span class="n">mat</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">v1</span><span class="p">))</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">nb_src</span><span class="p">,))</span> <span class="o">+</span> <span class="n">coeff_lsq</span><span class="p">[:,</span><span class="n">i</span><span class="p">]</span>
            <span class="n">im_est_hr</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">]</span> <span class="o">*=</span> <span class="mi">0</span>
            <span class="n">im_est_lr</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
            <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_src</span><span class="p">):</span>
                <span class="n">im_est_hr</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">]</span><span class="o">+=</span><span class="n">coeff_pos</span><span class="p">[</span><span class="n">l</span><span class="p">,</span><span class="n">i</span><span class="p">]</span><span class="o">*</span><span class="n">src_hr</span><span class="p">[:,:,</span><span class="n">l</span><span class="p">]</span>
                <span class="n">im_est_lr</span><span class="o">+=</span><span class="n">coeff_pos</span><span class="p">[</span><span class="n">l</span><span class="p">,</span><span class="n">i</span><span class="p">]</span><span class="o">*</span><span class="n">src_lr</span><span class="p">[:,:,</span><span class="n">l</span><span class="p">,</span><span class="n">i</span><span class="p">]</span>
            <span class="n">res</span><span class="o">+=</span><span class="p">((</span><span class="n">im</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">]</span><span class="o">-</span><span class="n">im_est_lr</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
            <span class="n">v2</span> <span class="o">=</span> <span class="n">mat</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">v1</span><span class="p">)</span> <span class="o">-</span> <span class="n">coeff_lsq</span><span class="p">[:,</span><span class="n">i</span><span class="p">]</span>
            <span class="n">grad</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="o">*</span><span class="n">grad</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_src</span><span class="p">):</span>
                <span class="n">grad</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">]</span> <span class="o">+=</span> <span class="n">v2</span><span class="p">[</span><span class="n">l</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">src_hr</span><span class="p">[:,:,</span><span class="n">l</span><span class="p">]</span>
            <span class="n">y</span> <span class="o">=</span> <span class="n">z</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">mu</span><span class="o">*</span><span class="n">grad</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">]</span><span class="o">/</span><span class="n">spec_rad</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">xold</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">x</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">])</span>
            <span class="n">x</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">y</span><span class="o">-</span><span class="n">mu</span><span class="o">*</span><span class="n">pos_proj_mat</span><span class="p">(</span><span class="n">y</span><span class="o">*</span><span class="n">spec_rad</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">/</span><span class="n">mu</span><span class="p">,</span><span class="n">tol</span><span class="o">=-</span><span class="n">tol_neg</span><span class="p">)</span><span class="o">/</span><span class="n">spec_rad</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">z</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">xold</span><span class="o">+</span><span class="n">lambd</span><span class="o">*</span><span class="p">(</span><span class="n">x</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">]</span><span class="o">-</span><span class="n">xold</span><span class="p">)</span>

        <span class="nb">print</span> <span class="s2">&quot;Pos coeff est residual: &quot;</span><span class="p">,</span><span class="n">res</span>
        <span class="nb">print</span> <span class="s2">&quot;Min reconstructed val: &quot;</span><span class="p">,</span><span class="n">im_est_hr</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
    <span class="n">v1</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">nb_src</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_im</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_src</span><span class="p">):</span>
            <span class="n">v1</span><span class="p">[</span><span class="n">l</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">src_hr</span><span class="p">[:,:,</span><span class="n">l</span><span class="p">]</span><span class="o">*</span><span class="n">z</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">])</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
            <span class="c1"># Primal variable update (not mandatory)</span>
            <span class="n">coeff_pos</span><span class="p">[:,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="p">(</span><span class="n">mat</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">v1</span><span class="p">))</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">nb_src</span><span class="p">,))</span> <span class="o">+</span> <span class="n">coeff_lsq</span><span class="p">[:,</span><span class="n">i</span><span class="p">]</span>
    <span class="n">z_init</span><span class="o">=</span><span class="n">z</span>
    <span class="k">return</span> <span class="n">coeff_pos</span>

<span class="k">def</span> <span class="nf">lsq_mult_coeff_stack_pos_2</span><span class="p">(</span><span class="n">im</span><span class="p">,</span><span class="n">src_lr</span><span class="p">,</span><span class="n">nb_iter</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span><span class="n">mu</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span><span class="n">tol</span><span class="o">=</span><span class="mf">0.001</span><span class="p">):</span>
    <span class="n">coeff_lsq</span><span class="p">,</span><span class="n">mat</span><span class="p">,</span><span class="n">v</span> <span class="o">=</span> <span class="n">lsq_mult_coeff_stack</span><span class="p">(</span><span class="n">im</span><span class="p">,</span><span class="n">src_lr</span><span class="p">)</span>
    <span class="n">shap</span> <span class="o">=</span> <span class="n">src_lr</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">nb_im</span> <span class="o">=</span> <span class="n">shap</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
    <span class="n">nb_src</span> <span class="o">=</span> <span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>

    <span class="n">z</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">coeff_lsq</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">z</span><span class="p">)</span>
    <span class="n">grad</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">t</span><span class="o">=</span><span class="mi">1</span>
    <span class="n">spec_rad</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">3</span><span class="p">]))</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">3</span><span class="p">]):</span>
        <span class="n">U</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">Vt</span> <span class="o">=</span> <span class="n">linalg</span><span class="o">.</span><span class="n">svd</span><span class="p">(</span><span class="n">mat</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">],</span><span class="n">full_matrices</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">spec_rad</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
    <span class="n">res</span><span class="o">=</span><span class="mi">1</span>
    <span class="n">res_old</span><span class="o">=</span><span class="mi">0</span>
    <span class="n">k</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">while</span> <span class="n">k</span> <span class="o">&lt;</span><span class="n">nb_iter</span> <span class="ow">and</span> <span class="mi">100</span><span class="o">*</span><span class="nb">abs</span><span class="p">(</span><span class="n">res</span><span class="o">-</span><span class="n">res_old</span><span class="p">)</span><span class="o">/</span><span class="n">res</span><span class="o">&gt;</span><span class="n">tol</span><span class="p">:</span>
        <span class="n">k</span><span class="o">+=</span><span class="mi">1</span>
        <span class="n">res_old</span><span class="o">=</span><span class="n">res</span>
        <span class="n">res</span><span class="o">=</span><span class="mi">0</span>
        <span class="n">told</span> <span class="o">=</span> <span class="n">t</span>
        <span class="n">t</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">4</span><span class="o">*</span><span class="n">t</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span><span class="o">/</span><span class="mi">2</span>
        <span class="n">lambd</span> <span class="o">=</span> <span class="mi">1</span><span class="o">+</span><span class="p">(</span><span class="n">told</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="n">t</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_im</span><span class="p">):</span>
            <span class="n">im_est_lr</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
            <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_src</span><span class="p">):</span>
                <span class="n">im_est_lr</span><span class="o">+=</span><span class="n">z</span><span class="p">[</span><span class="n">l</span><span class="p">,</span><span class="n">i</span><span class="p">]</span><span class="o">*</span><span class="n">src_lr</span><span class="p">[:,:,</span><span class="n">l</span><span class="p">,</span><span class="n">i</span><span class="p">]</span>
            <span class="n">res</span><span class="o">+=</span><span class="p">((</span><span class="n">im</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">]</span><span class="o">-</span><span class="n">im_est_lr</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
            <span class="n">grad</span><span class="p">[:,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">squeeze</span><span class="p">(</span><span class="n">mat</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">z</span><span class="p">[:,</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">nb_src</span><span class="p">,</span><span class="mi">1</span><span class="p">))))</span><span class="o">-</span><span class="n">v</span><span class="p">[:,</span><span class="n">i</span><span class="p">]</span>
            <span class="n">y</span> <span class="o">=</span> <span class="n">z</span><span class="p">[:,</span><span class="n">i</span><span class="p">]</span><span class="o">-</span><span class="n">mu</span><span class="o">*</span><span class="n">grad</span><span class="p">[:,</span><span class="n">i</span><span class="p">]</span><span class="o">/</span><span class="n">spec_rad</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">xold</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">x</span><span class="p">[:,</span><span class="n">i</span><span class="p">])</span>
            <span class="n">x</span><span class="p">[:,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">pos_proj</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
            <span class="n">z</span><span class="p">[:,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">xold</span> <span class="o">+</span> <span class="n">lambd</span><span class="o">*</span><span class="p">(</span><span class="n">x</span><span class="p">[:,</span><span class="n">i</span><span class="p">]</span><span class="o">-</span><span class="n">xold</span><span class="p">)</span>
        <span class="nb">print</span> <span class="s2">&quot;Pos coeff est residual: &quot;</span><span class="p">,</span><span class="n">res</span>
    <span class="k">return</span> <span class="n">z</span>

<span class="k">def</span> <span class="nf">smoothing_line_search_opt_coeff</span><span class="p">(</span><span class="n">tree</span><span class="p">,</span><span class="n">weights</span><span class="p">,</span><span class="n">u</span><span class="p">,</span><span class="n">v</span><span class="p">,</span><span class="n">a</span><span class="p">):</span>
    <span class="n">M</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span>
    <span class="n">b</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>
    <span class="n">shap</span> <span class="o">=</span> <span class="n">weights</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">nb_pts</span> <span class="o">=</span> <span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">nb_neighs</span> <span class="o">=</span> <span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_pts</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_neighs</span><span class="p">):</span>
            <span class="n">M</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="n">weights</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span><span class="o">*</span><span class="p">((</span><span class="n">u</span><span class="p">[:,</span><span class="n">i</span><span class="p">]</span><span class="o">-</span><span class="n">u</span><span class="p">[:,</span><span class="n">tree</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]])</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
            <span class="n">M</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="n">weights</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span><span class="o">*</span><span class="p">((</span><span class="n">v</span><span class="p">[:,</span><span class="n">i</span><span class="p">]</span><span class="o">-</span><span class="n">v</span><span class="p">[:,</span><span class="n">tree</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]])</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
            <span class="n">M</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="n">weights</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span><span class="o">*</span><span class="p">((</span><span class="n">u</span><span class="p">[:,</span><span class="n">i</span><span class="p">]</span><span class="o">-</span><span class="n">u</span><span class="p">[:,</span><span class="n">tree</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]])</span><span class="o">*</span><span class="p">(</span><span class="n">v</span><span class="p">[:,</span><span class="n">i</span><span class="p">]</span><span class="o">-</span><span class="n">v</span><span class="p">[:,</span><span class="n">tree</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]]))</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
            <span class="n">b</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="o">-=</span> <span class="n">weights</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span><span class="o">*</span><span class="p">((</span><span class="n">u</span><span class="p">[:,</span><span class="n">i</span><span class="p">]</span><span class="o">-</span><span class="n">u</span><span class="p">[:,</span><span class="n">tree</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]])</span><span class="o">*</span><span class="p">(</span><span class="n">a</span><span class="p">[:,</span><span class="n">i</span><span class="p">]</span><span class="o">-</span><span class="n">a</span><span class="p">[:,</span><span class="n">tree</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]]))</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
            <span class="n">b</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="o">-=</span> <span class="n">weights</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span><span class="o">*</span><span class="p">((</span><span class="n">v</span><span class="p">[:,</span><span class="n">i</span><span class="p">]</span><span class="o">-</span><span class="n">v</span><span class="p">[:,</span><span class="n">tree</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]])</span><span class="o">*</span><span class="p">(</span><span class="n">a</span><span class="p">[:,</span><span class="n">i</span><span class="p">]</span><span class="o">-</span><span class="n">a</span><span class="p">[:,</span><span class="n">tree</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]]))</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    <span class="n">M</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">M</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">output</span> <span class="o">=</span> <span class="n">LA</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">M</span><span class="p">)</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">output</span>

<span class="k">def</span> <span class="nf">line_search_lsq_mult_coeff_stack</span><span class="p">(</span><span class="n">im</span><span class="p">,</span><span class="n">src</span><span class="p">,</span><span class="n">u</span><span class="p">,</span><span class="n">v</span><span class="p">,</span><span class="n">a</span><span class="p">):</span>
    <span class="n">shap</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">M</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span>
    <span class="n">b</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">3</span><span class="p">]):</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
            <span class="n">temp1</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
            <span class="n">temp1</span> <span class="o">+=</span> <span class="n">src</span><span class="p">[:,:,</span><span class="n">j</span><span class="p">,</span><span class="n">i</span><span class="p">]</span><span class="o">*</span><span class="n">u</span><span class="p">[</span><span class="n">j</span><span class="p">,</span><span class="n">i</span><span class="p">]</span>
            <span class="n">M</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="p">(</span><span class="n">temp1</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
            <span class="n">temp2</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
            <span class="n">temp2</span> <span class="o">+=</span> <span class="n">src</span><span class="p">[:,:,</span><span class="n">j</span><span class="p">,</span><span class="n">i</span><span class="p">]</span><span class="o">*</span><span class="n">v</span><span class="p">[</span><span class="n">j</span><span class="p">,</span><span class="n">i</span><span class="p">]</span>
            <span class="n">M</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="p">(</span><span class="n">temp2</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
            <span class="n">M</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="p">(</span><span class="n">temp1</span><span class="o">*</span><span class="n">temp2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
            <span class="n">temp</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">im</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">])</span>
            <span class="n">temp</span> <span class="o">-=</span> <span class="n">src</span><span class="p">[:,:,</span><span class="n">j</span><span class="p">,</span><span class="n">i</span><span class="p">]</span><span class="o">*</span><span class="n">a</span><span class="p">[</span><span class="n">j</span><span class="p">,</span><span class="n">i</span><span class="p">]</span>
            <span class="n">b</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="p">(</span><span class="n">temp</span><span class="o">*</span><span class="n">temp1</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
            <span class="n">b</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="p">(</span><span class="n">temp</span><span class="o">*</span><span class="n">temp2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    <span class="n">M</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">M</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">output</span> <span class="o">=</span> <span class="n">LA</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">M</span><span class="p">)</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">output</span>

<span class="k">def</span> <span class="nf">non_unif_smoothing_mult_coeff</span><span class="p">(</span><span class="n">im</span><span class="p">,</span><span class="n">src</span><span class="p">,</span><span class="n">tree</span><span class="p">,</span><span class="n">weights</span><span class="p">,</span><span class="n">nb_iter</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span><span class="n">spec_rad</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">tol</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span><span class="n">Ainit</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="n">a</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">weights</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">shap</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">shap2</span> <span class="o">=</span> <span class="n">tree</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">nb_neigh</span> <span class="o">=</span> <span class="n">shap2</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">spec_rad</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">spec_rad</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">a</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">*</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span> <span class="s2">&quot;real spec rad: &quot;</span><span class="p">,</span><span class="n">spec_rad</span><span class="p">,</span><span class="s2">&quot; estimate: &quot;</span><span class="p">,</span><span class="mi">2</span><span class="o">*</span><span class="n">a</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
    <span class="n">ref_smooth</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">res_res</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">if</span> <span class="n">Ainit</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">Ainit</span> <span class="o">=</span> <span class="n">ones</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">shap</span><span class="p">[</span><span class="mi">3</span><span class="p">]))</span>
    <span class="n">cost_old</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">cost</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">A</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">Ainit</span><span class="p">)</span>
    <span class="n">i</span><span class="o">=</span><span class="mi">0</span>
    <span class="k">while</span> <span class="n">i</span> <span class="o">&lt;</span><span class="n">nb_iter</span> <span class="ow">and</span> <span class="mi">100</span><span class="o">*</span><span class="nb">abs</span><span class="p">(</span><span class="n">cost</span><span class="o">-</span><span class="n">cost_old</span><span class="p">)</span><span class="o">/</span><span class="n">cost</span><span class="o">&gt;</span><span class="n">tol</span><span class="p">:</span>
        <span class="n">u</span> <span class="o">=</span> <span class="mi">0</span><span class="o">*</span><span class="n">Ainit</span>
        <span class="n">v</span> <span class="o">=</span> <span class="mi">0</span><span class="o">*</span><span class="n">Ainit</span>
        <span class="n">res_smooth</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">im</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">3</span><span class="p">]):</span>
            <span class="n">i1</span><span class="p">,</span><span class="n">i2</span> <span class="o">=</span> <span class="n">where</span><span class="p">(</span><span class="n">tree</span><span class="o">==</span><span class="n">k</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_neigh</span><span class="p">):</span>
                <span class="n">u</span><span class="p">[:,</span><span class="n">k</span><span class="p">]</span><span class="o">-=</span><span class="n">weights</span><span class="p">[</span><span class="n">k</span><span class="p">,</span><span class="n">l</span><span class="p">]</span><span class="o">*</span><span class="n">A</span><span class="p">[:,</span><span class="n">tree</span><span class="p">[</span><span class="n">k</span><span class="p">,</span><span class="n">l</span><span class="p">]]</span>
            <span class="n">w</span><span class="o">=</span><span class="n">weights</span><span class="p">[</span><span class="n">k</span><span class="p">,:]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">size</span><span class="p">(</span><span class="n">i1</span><span class="p">)):</span>
                <span class="n">p</span> <span class="o">=</span> <span class="n">where</span><span class="p">((</span><span class="n">tree</span><span class="p">[</span><span class="n">k</span><span class="p">,:]</span><span class="o">==</span><span class="n">i1</span><span class="p">[</span><span class="n">j</span><span class="p">]))</span>
                <span class="k">if</span> <span class="n">size</span><span class="p">(</span><span class="n">p</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
                    <span class="n">w</span><span class="o">+=</span><span class="n">weights</span><span class="p">[</span><span class="n">i1</span><span class="p">[</span><span class="n">j</span><span class="p">],</span><span class="n">i2</span><span class="p">[</span><span class="n">j</span><span class="p">]]</span>
                    <span class="n">u</span><span class="p">[:,</span><span class="n">k</span><span class="p">]</span><span class="o">-=</span><span class="n">weights</span><span class="p">[</span><span class="n">i1</span><span class="p">[</span><span class="n">j</span><span class="p">],</span><span class="n">i2</span><span class="p">[</span><span class="n">j</span><span class="p">]]</span><span class="o">*</span><span class="n">A</span><span class="p">[:,</span><span class="n">i1</span><span class="p">[</span><span class="n">j</span><span class="p">]]</span>
            <span class="n">u</span><span class="p">[:,</span><span class="n">k</span><span class="p">]</span><span class="o">+=</span><span class="n">w</span><span class="o">*</span><span class="n">A</span><span class="p">[:,</span><span class="n">k</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
                <span class="n">res_smooth</span><span class="p">[:,:,</span><span class="n">k</span><span class="p">]</span> <span class="o">-=</span> <span class="n">A</span><span class="p">[</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">]</span><span class="o">*</span><span class="n">src</span><span class="p">[:,:,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
                <span class="n">v</span><span class="p">[</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="p">(</span><span class="n">res_smooth</span><span class="p">[:,:,</span><span class="n">k</span><span class="p">]</span><span class="o">*</span><span class="n">src</span><span class="p">[:,:,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">])</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="n">cost_res</span> <span class="o">=</span> <span class="p">(</span><span class="n">res_smooth</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="nb">print</span> <span class="s2">&quot; ------- Cur res: &quot;</span><span class="p">,</span><span class="n">cost_res</span><span class="p">,</span><span class="s2">&quot; ----------- &quot;</span>
        <span class="n">cost_smooth</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">3</span><span class="p">]):</span>
            <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_neigh</span><span class="p">):</span>
                <span class="n">cost_smooth</span><span class="o">+=</span><span class="p">((</span><span class="n">A</span><span class="p">[:,</span><span class="n">k</span><span class="p">]</span><span class="o">-</span><span class="n">A</span><span class="p">[:,</span><span class="n">tree</span><span class="p">[</span><span class="n">k</span><span class="p">,</span><span class="n">l</span><span class="p">]])</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">*</span><span class="n">weights</span><span class="p">[</span><span class="n">k</span><span class="p">,</span><span class="n">l</span><span class="p">]</span>
        <span class="nb">print</span> <span class="s2">&quot; ------- Cur smoothness: &quot;</span><span class="p">,</span><span class="n">cost_smooth</span><span class="p">,</span><span class="s2">&quot; ----------- &quot;</span>
        <span class="n">cost_old</span> <span class="o">=</span> <span class="n">cost</span>
        <span class="n">cost</span> <span class="o">=</span> <span class="n">cost_res</span><span class="o">+</span><span class="n">cost_smooth</span>
        <span class="n">coeff1</span> <span class="o">=</span> <span class="n">smoothing_line_search_opt_coeff</span><span class="p">(</span><span class="n">tree</span><span class="p">,</span><span class="n">weights</span><span class="p">,</span><span class="o">-</span><span class="n">u</span><span class="p">,</span><span class="o">-</span><span class="n">u</span><span class="p">,</span><span class="n">A</span><span class="p">)</span>
        <span class="n">coeff2</span> <span class="o">=</span> <span class="n">line_search_lsq_mult_coeff_stack</span><span class="p">(</span><span class="n">im</span><span class="p">,</span><span class="n">src</span><span class="p">,</span><span class="o">-</span><span class="n">u</span><span class="p">,</span><span class="o">-</span><span class="n">u</span><span class="p">,</span><span class="n">A</span><span class="p">)</span>
        <span class="n">mu1</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">coeff1</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span><span class="n">coeff2</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]),</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">mu2</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">coeff1</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span><span class="n">coeff2</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]),</span><span class="mi">0</span><span class="p">)</span>
        <span class="c1">#mu1 = mean([coeff1[0,0],coeff2[0,0]])</span>
        <span class="c1">#mu2 = mean([coeff1[1,0],coeff2[1,0]])</span>
        <span class="nb">print</span> <span class="s2">&quot; Data fidelity direction coeffs: &quot;</span><span class="p">,</span><span class="n">coeff2</span><span class="p">,</span><span class="s2">&quot; Smoothness direction: &quot;</span><span class="p">,</span><span class="n">coeff1</span>
        <span class="n">A</span> <span class="o">=</span> <span class="n">A</span><span class="o">-</span><span class="n">mu1</span><span class="o">*</span><span class="n">u</span><span class="o">-</span><span class="n">mu2</span><span class="o">*</span><span class="n">v</span>
        <span class="n">i</span><span class="o">+=</span><span class="mi">1</span>
    <span class="k">return</span> <span class="n">A</span>

<span class="k">def</span> <span class="nf">non_unif_smoothing_mult_coeff_pos</span><span class="p">(</span><span class="n">im</span><span class="p">,</span><span class="n">src</span><span class="p">,</span><span class="n">tree</span><span class="p">,</span><span class="n">weights</span><span class="p">,</span><span class="n">mu</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span><span class="n">nb_iter</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span><span class="n">spec_rad</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">tol</span><span class="o">=</span><span class="mf">0.001</span><span class="p">,</span><span class="n">Ainit</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="n">a</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">weights</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">shap</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">shap2</span> <span class="o">=</span> <span class="n">tree</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">nb_neigh</span> <span class="o">=</span> <span class="n">shap2</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

    <span class="n">smooth_spec_rad</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">a</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">*</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">ref_smooth</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">res_res</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">Atemp</span><span class="p">,</span><span class="n">mat</span><span class="p">,</span><span class="n">v</span> <span class="o">=</span> <span class="n">lsq_mult_coeff_stack</span><span class="p">(</span><span class="n">im</span><span class="p">,</span><span class="n">src</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">Ainit</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">Atemp</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">Ainit</span> <span class="o">=</span> <span class="n">pos_proj</span><span class="p">(</span><span class="n">Atemp</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">Atemp</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">Ainit</span> <span class="o">=</span> <span class="n">pos_proj_mat</span><span class="p">(</span><span class="n">Atemp</span><span class="p">)</span>
    <span class="n">lambd_vect</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">(</span><span class="n">shap</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span> <span class="c1"># Balance paramters</span>

    <span class="n">cost_old</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">cost</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">A</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">Ainit</span><span class="p">)</span>
    <span class="n">i</span><span class="o">=</span><span class="mi">0</span>
    <span class="n">cost_smooth_ref</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">3</span><span class="p">]):</span>
        <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_neigh</span><span class="p">):</span>
            <span class="n">cost_smooth_ref</span><span class="o">+=</span><span class="p">((</span><span class="n">Ainit</span><span class="p">[:,</span><span class="n">k</span><span class="p">]</span><span class="o">-</span><span class="n">Ainit</span><span class="p">[:,</span><span class="n">tree</span><span class="p">[</span><span class="n">k</span><span class="p">,</span><span class="n">l</span><span class="p">]])</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">*</span><span class="n">weights</span><span class="p">[</span><span class="n">k</span><span class="p">,</span><span class="n">l</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">3</span><span class="p">]):</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">im</span><span class="p">[:,:,</span><span class="n">k</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
            <span class="n">res</span><span class="o">-=</span><span class="n">Ainit</span><span class="p">[</span><span class="n">l</span><span class="p">,</span><span class="n">k</span><span class="p">]</span><span class="o">*</span><span class="n">src</span><span class="p">[:,:,</span><span class="n">l</span><span class="p">,</span><span class="n">k</span><span class="p">]</span>
        <span class="n">lambd_vect</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">cost_smooth_ref</span><span class="o">/</span><span class="p">(</span><span class="n">shap</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="n">res</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span>

    <span class="n">spec_rad</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">3</span><span class="p">]))</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">3</span><span class="p">]):</span>
        <span class="n">U</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">Vt</span> <span class="o">=</span> <span class="n">linalg</span><span class="o">.</span><span class="n">svd</span><span class="p">(</span><span class="n">mat</span><span class="p">[:,:,</span><span class="n">k</span><span class="p">],</span><span class="n">full_matrices</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">spec_rad</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">*</span><span class="n">lambd_vect</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
    <span class="n">grad_lip</span> <span class="o">=</span> <span class="n">smooth_spec_rad</span><span class="o">+</span><span class="n">spec_rad</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>

    <span class="n">x</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">A</span><span class="p">)</span>
    <span class="n">grad</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">t</span><span class="o">=</span><span class="mi">1</span>
    <span class="n">spec_rad</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">3</span><span class="p">]))</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">3</span><span class="p">]):</span>
        <span class="n">U</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">Vt</span> <span class="o">=</span> <span class="n">linalg</span><span class="o">.</span><span class="n">svd</span><span class="p">(</span><span class="n">mat</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">],</span><span class="n">full_matrices</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">spec_rad</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
    <span class="n">res</span><span class="o">=</span><span class="mi">1</span>
    <span class="n">res_old</span><span class="o">=</span><span class="mi">0</span>
    <span class="nb">iter</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">while</span> <span class="nb">iter</span> <span class="o">&lt;</span><span class="n">nb_iter</span> <span class="ow">and</span> <span class="mi">100</span><span class="o">*</span><span class="nb">abs</span><span class="p">(</span><span class="n">res</span><span class="o">-</span><span class="n">res_old</span><span class="p">)</span><span class="o">/</span><span class="n">res</span><span class="o">&gt;</span><span class="n">tol</span><span class="p">:</span>
        <span class="nb">iter</span><span class="o">+=</span><span class="mi">1</span>
        <span class="n">res_old</span><span class="o">=</span><span class="n">res</span>
        <span class="n">told</span> <span class="o">=</span> <span class="n">t</span>
        <span class="n">t</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">4</span><span class="o">*</span><span class="n">t</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span><span class="o">/</span><span class="mi">2</span>
        <span class="n">lambd</span> <span class="o">=</span> <span class="mi">1</span><span class="o">+</span><span class="p">(</span><span class="n">told</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="n">t</span>
        <span class="n">u</span> <span class="o">=</span> <span class="mi">0</span><span class="o">*</span><span class="n">Ainit</span> <span class="c1"># Smoothness related gradient</span>
        <span class="n">v</span> <span class="o">=</span> <span class="mi">0</span><span class="o">*</span><span class="n">Ainit</span> <span class="c1"># Gradient related gradient</span>
        <span class="n">res_smooth</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">im</span><span class="p">)</span>
        <span class="n">res_smooth_2</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">im</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">3</span><span class="p">]):</span>
            <span class="n">i1</span><span class="p">,</span><span class="n">i2</span> <span class="o">=</span> <span class="n">where</span><span class="p">(</span><span class="n">tree</span><span class="o">==</span><span class="n">k</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_neigh</span><span class="p">):</span>
                <span class="n">u</span><span class="p">[:,</span><span class="n">k</span><span class="p">]</span><span class="o">-=</span><span class="n">weights</span><span class="p">[</span><span class="n">k</span><span class="p">,</span><span class="n">l</span><span class="p">]</span><span class="o">*</span><span class="n">A</span><span class="p">[:,</span><span class="n">tree</span><span class="p">[</span><span class="n">k</span><span class="p">,</span><span class="n">l</span><span class="p">]]</span>
            <span class="n">w</span><span class="o">=</span><span class="n">weights</span><span class="p">[</span><span class="n">k</span><span class="p">,:]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">size</span><span class="p">(</span><span class="n">i1</span><span class="p">)):</span>
                <span class="n">p</span> <span class="o">=</span> <span class="n">where</span><span class="p">((</span><span class="n">tree</span><span class="p">[</span><span class="n">k</span><span class="p">,:]</span><span class="o">==</span><span class="n">i1</span><span class="p">[</span><span class="n">j</span><span class="p">]))</span>
                <span class="k">if</span> <span class="n">size</span><span class="p">(</span><span class="n">p</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
                    <span class="n">w</span><span class="o">+=</span><span class="n">weights</span><span class="p">[</span><span class="n">i1</span><span class="p">[</span><span class="n">j</span><span class="p">],</span><span class="n">i2</span><span class="p">[</span><span class="n">j</span><span class="p">]]</span>
                    <span class="n">u</span><span class="p">[:,</span><span class="n">k</span><span class="p">]</span><span class="o">-=</span><span class="n">weights</span><span class="p">[</span><span class="n">i1</span><span class="p">[</span><span class="n">j</span><span class="p">],</span><span class="n">i2</span><span class="p">[</span><span class="n">j</span><span class="p">]]</span><span class="o">*</span><span class="n">A</span><span class="p">[:,</span><span class="n">i1</span><span class="p">[</span><span class="n">j</span><span class="p">]]</span>
            <span class="n">u</span><span class="p">[:,</span><span class="n">k</span><span class="p">]</span><span class="o">+=</span><span class="n">w</span><span class="o">*</span><span class="n">A</span><span class="p">[:,</span><span class="n">k</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
                <span class="n">res_smooth</span><span class="p">[:,:,</span><span class="n">k</span><span class="p">]</span> <span class="o">-=</span> <span class="n">A</span><span class="p">[</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">]</span><span class="o">*</span><span class="n">src</span><span class="p">[:,:,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">]</span>
                <span class="n">res_smooth_2</span><span class="p">[:,:,</span><span class="n">k</span><span class="p">]</span> <span class="o">-=</span> <span class="n">lambd_vect</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">*</span><span class="n">A</span><span class="p">[</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">]</span><span class="o">*</span><span class="n">src</span><span class="p">[:,:,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">]</span> <span class="c1"># For the objective function value</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
                <span class="n">v</span><span class="p">[</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">lambd_vect</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="n">res_smooth</span><span class="p">[:,:,</span><span class="n">k</span><span class="p">]</span><span class="o">*</span><span class="n">src</span><span class="p">[:,:,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">])</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
            <span class="n">cost_smooth</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">3</span><span class="p">]):</span>
                <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_neigh</span><span class="p">):</span>
                    <span class="n">cost_smooth</span><span class="o">+=</span><span class="p">((</span><span class="n">A</span><span class="p">[:,</span><span class="n">k</span><span class="p">]</span><span class="o">-</span><span class="n">A</span><span class="p">[:,</span><span class="n">tree</span><span class="p">[</span><span class="n">k</span><span class="p">,</span><span class="n">l</span><span class="p">]])</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">*</span><span class="n">weights</span><span class="p">[</span><span class="n">k</span><span class="p">,</span><span class="n">l</span><span class="p">]</span>
        <span class="n">res_val</span> <span class="o">=</span> <span class="p">(</span><span class="n">res_smooth</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">cost_smooth</span><span class="o">+</span><span class="p">(</span><span class="n">res_smooth_2</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="nb">print</span> <span class="s2">&quot;smoothness criteria: &quot;</span><span class="p">,</span><span class="n">cost_smooth</span><span class="p">,</span><span class="s2">&quot; residual: &quot;</span><span class="p">,</span><span class="n">res_val</span><span class="p">,</span><span class="s2">&quot; objective val: &quot;</span><span class="p">,</span><span class="n">res</span>
        <span class="n">grad</span> <span class="o">=</span> <span class="n">u</span><span class="o">+</span><span class="n">v</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">A</span> <span class="o">-</span> <span class="n">mu</span><span class="o">*</span><span class="n">grad</span><span class="o">/</span><span class="n">grad_lip</span>
        <span class="n">xold</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">pos_proj_mat</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
        <span class="n">A</span> <span class="o">=</span> <span class="n">xold</span> <span class="o">+</span> <span class="n">lambd</span><span class="o">*</span><span class="p">(</span><span class="n">x</span><span class="o">-</span><span class="n">xold</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">A</span>

<span class="k">def</span> <span class="nf">smoothing_matrix</span><span class="p">(</span><span class="n">tree</span><span class="p">,</span><span class="n">weights</span><span class="p">):</span>
    <span class="n">shap</span> <span class="o">=</span> <span class="n">tree</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">M</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
    <span class="n">nb_neigh</span> <span class="o">=</span> <span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
        <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_neigh</span><span class="p">):</span>
            <span class="n">M</span><span class="p">[</span><span class="n">k</span><span class="p">,</span><span class="n">tree</span><span class="p">[</span><span class="n">k</span><span class="p">,</span><span class="n">l</span><span class="p">]]</span><span class="o">=-</span><span class="n">weights</span><span class="p">[</span><span class="n">k</span><span class="p">,</span><span class="n">l</span><span class="p">]</span>
            <span class="n">w</span><span class="o">=</span><span class="n">weights</span><span class="p">[</span><span class="n">k</span><span class="p">,:]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
            <span class="n">i1</span><span class="p">,</span><span class="n">i2</span> <span class="o">=</span> <span class="n">where</span><span class="p">(</span><span class="n">tree</span><span class="o">==</span><span class="n">k</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">size</span><span class="p">(</span><span class="n">i1</span><span class="p">)):</span>
                <span class="n">p</span> <span class="o">=</span> <span class="n">where</span><span class="p">((</span><span class="n">tree</span><span class="p">[</span><span class="n">k</span><span class="p">,:]</span><span class="o">==</span><span class="n">i1</span><span class="p">[</span><span class="n">j</span><span class="p">]))</span>
                <span class="k">if</span> <span class="n">size</span><span class="p">(</span><span class="n">p</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
                    <span class="n">w</span><span class="o">+=</span><span class="n">weights</span><span class="p">[</span><span class="n">i1</span><span class="p">[</span><span class="n">j</span><span class="p">],</span><span class="n">i2</span><span class="p">[</span><span class="n">j</span><span class="p">]]</span>
                    <span class="n">M</span><span class="p">[</span><span class="n">k</span><span class="p">,</span><span class="n">i1</span><span class="p">[</span><span class="n">j</span><span class="p">]]</span><span class="o">=-</span><span class="n">weights</span><span class="p">[</span><span class="n">i1</span><span class="p">[</span><span class="n">j</span><span class="p">],</span><span class="n">i2</span><span class="p">[</span><span class="n">j</span><span class="p">]]</span>
        <span class="n">M</span><span class="p">[</span><span class="n">k</span><span class="p">,</span><span class="n">k</span><span class="p">]</span><span class="o">=</span><span class="n">w</span>
    <span class="k">return</span> <span class="n">M</span>

<span class="k">def</span> <span class="nf">smoothing_prox</span><span class="p">(</span><span class="n">p_smth_mat</span><span class="p">,</span><span class="n">M</span><span class="p">):</span>
    <span class="n">out</span> <span class="o">=</span> <span class="n">M</span><span class="o">*</span><span class="mi">0</span>
    <span class="n">shap</span> <span class="o">=</span> <span class="n">M</span><span class="o">.</span><span class="n">shape</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
        <span class="n">y1</span> <span class="o">=</span> <span class="n">M</span><span class="p">[</span><span class="n">k</span><span class="p">,:]</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="mi">1</span><span class="p">))</span>
        <span class="n">y2</span> <span class="o">=</span> <span class="n">p_smth_mat</span><span class="p">[:,:,</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">y1</span><span class="p">)</span>
        <span class="n">out</span><span class="p">[</span><span class="n">k</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">y2</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">],))</span>
    <span class="k">return</span> <span class="n">out</span>

<span class="k">def</span> <span class="nf">spreading_constraint_src_update_cp</span><span class="p">(</span><span class="n">X</span><span class="p">,</span><span class="n">A</span><span class="p">,</span><span class="n">centroid</span><span class="p">,</span><span class="n">Sinit</span><span class="p">,</span><span class="n">res_max</span><span class="p">,</span><span class="n">eps</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span><span class="n">nb_iter</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span><span class="n">tol</span><span class="o">=</span><span class="mf">1e-15</span><span class="p">,</span><span class="n">accel_en</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="n">shap</span> <span class="o">=</span> <span class="n">Sinit</span><span class="o">.</span><span class="n">shape</span>
    <span class="c1"># Spectral radius setting</span>
    <span class="c1"># -- Coeff matrix</span>
    <span class="n">U</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">Vt</span> <span class="o">=</span> <span class="n">linalg</span><span class="o">.</span><span class="n">svd</span><span class="p">(</span><span class="n">A</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">transpose</span><span class="p">(</span><span class="n">A</span><span class="p">)),</span><span class="n">full_matrices</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">spec_rad</span> <span class="o">=</span> <span class="n">sqrt</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">max</span><span class="p">())</span>
    <span class="n">to</span> <span class="o">=</span> <span class="n">spec_rad</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">sig</span> <span class="o">=</span> <span class="n">eps</span><span class="o">/</span><span class="p">(</span><span class="n">to</span><span class="o">*</span><span class="n">spec_rad</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="c1"># Weight related to the dual variables</span>
    <span class="n">theta</span> <span class="o">=</span> <span class="mf">0.9</span>

    <span class="c1"># Dual variable (residual constraint)</span>
    <span class="n">Y1</span> <span class="o">=</span> <span class="n">Sinit</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">A</span><span class="p">)</span>
    <span class="n">O</span> <span class="o">=</span> <span class="n">Y1</span><span class="o">*</span><span class="mi">0</span>
    <span class="c1"># Primal variable (spreading constraint)</span>
    <span class="n">V</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">Sinit</span><span class="p">)</span>
    <span class="n">ones_vect</span> <span class="o">=</span> <span class="n">ones</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
    <span class="n">centroidn</span> <span class="o">=</span> <span class="n">centroid</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">ones_vect</span><span class="p">)</span>

    <span class="c1"># Main variable</span>
    <span class="n">S</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">Sinit</span><span class="p">)</span>

    <span class="n">cost</span><span class="o">=</span><span class="mi">2</span>
    <span class="n">cost_old</span><span class="o">=</span><span class="mi">1</span>
    <span class="nb">iter</span><span class="o">=</span><span class="mi">0</span>

    <span class="n">ref_mse</span> <span class="o">=</span> <span class="p">((</span><span class="n">X</span><span class="o">-</span><span class="n">Sinit</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">A</span><span class="p">))</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    <span class="nb">print</span> <span class="s2">&quot;---&gt;&gt;ref res: &lt;&lt;---&quot;</span><span class="p">,</span><span class="n">ref_mse</span>

    <span class="k">while</span> <span class="nb">iter</span><span class="o">&lt;</span><span class="n">nb_iter</span> <span class="ow">and</span> <span class="mi">100</span><span class="o">*</span><span class="nb">abs</span><span class="p">(</span><span class="n">cost</span><span class="o">-</span><span class="n">cost_old</span><span class="p">)</span><span class="o">/</span><span class="nb">abs</span><span class="p">(</span><span class="n">cost_old</span><span class="p">)</span><span class="o">&gt;</span><span class="n">tol</span><span class="p">:</span>
        <span class="nb">iter</span><span class="o">+=</span><span class="mi">1</span>

        <span class="c1"># Dual variables update</span>
        <span class="c1"># -- residual constraint variable update</span>
        <span class="n">temp1</span> <span class="o">=</span> <span class="n">Y1</span><span class="o">+</span><span class="n">sig</span><span class="o">*</span><span class="n">S</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">A</span><span class="p">)</span><span class="o">-</span><span class="n">sig</span><span class="o">*</span><span class="n">X</span>
        <span class="n">Y1</span> <span class="o">=</span> <span class="n">temp1</span><span class="o">-</span><span class="n">sig</span><span class="o">*</span><span class="n">proj_sphere</span><span class="p">(</span><span class="n">temp1</span><span class="o">/</span><span class="n">sig</span><span class="p">,</span><span class="n">O</span><span class="p">,</span><span class="n">sqrt</span><span class="p">(</span><span class="n">res_max</span><span class="p">))</span> <span class="c1"># Moreau id</span>

        <span class="c1"># Primal variable update</span>
        <span class="n">Vold</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">V</span><span class="p">)</span>
        <span class="n">temp2</span> <span class="o">=</span> <span class="n">V</span> <span class="o">-</span> <span class="n">to</span><span class="o">*</span><span class="n">Y1</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">transpose</span><span class="p">(</span><span class="n">A</span><span class="p">))</span>
        <span class="n">V</span> <span class="o">=</span> <span class="p">(</span><span class="n">temp2</span> <span class="o">+</span> <span class="n">to</span><span class="o">*</span><span class="n">centroidn</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">to</span><span class="p">)</span>

        <span class="c1"># Main variable update</span>
        <span class="k">if</span> <span class="n">accel_en</span><span class="p">:</span>
            <span class="n">theta</span> <span class="o">=</span> <span class="mi">1</span><span class="o">/</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="mi">2</span><span class="o">*</span><span class="n">to</span><span class="p">)</span>
            <span class="n">to</span> <span class="o">=</span> <span class="n">theta</span><span class="o">*</span><span class="n">to</span>
            <span class="n">sig</span> <span class="o">=</span> <span class="n">sig</span><span class="o">/</span><span class="n">theta</span>
        <span class="n">S</span> <span class="o">=</span> <span class="n">V</span> <span class="o">+</span> <span class="n">theta</span><span class="o">*</span><span class="p">(</span><span class="n">V</span><span class="o">-</span><span class="n">Vold</span><span class="p">)</span>

        <span class="c1"># Sanity check</span>
        <span class="n">min_comp</span> <span class="o">=</span> <span class="p">((</span><span class="n">V</span><span class="o">-</span><span class="n">centroidn</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="n">max_comp</span> <span class="o">=</span> <span class="p">(</span><span class="n">Y1</span><span class="o">*</span><span class="n">V</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">A</span><span class="p">))</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="n">res</span> <span class="o">=</span> <span class="p">((</span><span class="n">X</span><span class="o">-</span><span class="n">S</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">A</span><span class="p">))</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="n">cost_old</span> <span class="o">=</span> <span class="n">cost</span>
        <span class="n">cost</span> <span class="o">=</span> <span class="n">min_comp</span><span class="o">+</span><span class="n">max_comp</span>
    <span class="nb">print</span> <span class="s2">&quot;residual: &quot;</span><span class="p">,</span><span class="n">res</span><span class="p">,</span><span class="s2">&quot; min comp: &quot;</span><span class="p">,</span><span class="n">min_comp</span><span class="p">,</span><span class="s2">&quot; max comp: &quot;</span><span class="p">,</span><span class="n">max_comp</span><span class="p">,</span><span class="s2">&quot; cost: &quot;</span><span class="p">,</span><span class="n">cost</span>

    <span class="k">return</span> <span class="n">S</span>


<span class="k">def</span> <span class="nf">sparse_bar_coord_pb_field_cp</span><span class="p">(</span><span class="n">S</span><span class="p">,</span><span class="n">X</span><span class="p">,</span><span class="n">res_max</span><span class="p">,</span><span class="n">Ainit</span><span class="p">,</span><span class="n">thresh_map</span><span class="p">,</span><span class="n">thresh_type</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">nb_iter</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span><span class="n">tol</span><span class="o">=</span><span class="mf">1e-15</span><span class="p">,</span><span class="n">eps</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span><span class="n">accel_en</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span> <span class="c1"># calculates the best &quot;barycentric&quot; coordinates of X columns with respect to S columns with a sparsity constraint on the coefficients matrix</span>
    <span class="n">shap1</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">shap2</span> <span class="o">=</span> <span class="n">S</span><span class="o">.</span><span class="n">shape</span>
    <span class="c1"># Spectral radius setting</span>
    <span class="c1"># -- Sources matrix</span>
    <span class="n">U</span><span class="p">,</span> <span class="n">s1</span><span class="p">,</span> <span class="n">Vt</span> <span class="o">=</span> <span class="n">linalg</span><span class="o">.</span><span class="n">svd</span><span class="p">(</span><span class="n">transpose</span><span class="p">(</span><span class="n">S</span><span class="p">)</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">S</span><span class="p">),</span><span class="n">full_matrices</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="c1"># -- Column summation matrix</span>
    <span class="n">s2</span>  <span class="o">=</span> <span class="n">shap2</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">spec_rad</span> <span class="o">=</span> <span class="n">sqrt</span><span class="p">(</span><span class="n">s1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">s2</span><span class="p">)</span>
    <span class="n">to</span> <span class="o">=</span> <span class="n">spec_rad</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">sig</span> <span class="o">=</span> <span class="n">eps</span><span class="o">/</span><span class="p">(</span><span class="n">to</span><span class="o">*</span><span class="n">spec_rad</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="c1"># Weight related to the dual variables</span>
    <span class="n">theta</span> <span class="o">=</span> <span class="mf">0.9</span>
    <span class="c1"># Dual variables</span>
    <span class="c1"># -- Residual constraint variable</span>
    <span class="n">Y1</span> <span class="o">=</span> <span class="n">S</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">Ainit</span><span class="p">)</span>
    <span class="n">O</span> <span class="o">=</span> <span class="n">Y1</span><span class="o">*</span><span class="mi">0</span>
    <span class="c1"># -- Columns normalization variable</span>
    <span class="n">Y2</span> <span class="o">=</span> <span class="n">ones</span><span class="p">((</span><span class="n">shap1</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="mi">1</span><span class="p">))</span>
    <span class="n">ones_vect1</span> <span class="o">=</span> <span class="n">ones</span><span class="p">((</span><span class="n">shap1</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="mi">1</span><span class="p">))</span>
    <span class="n">ones_vect2</span> <span class="o">=</span> <span class="n">ones</span><span class="p">((</span><span class="n">shap2</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="mi">1</span><span class="p">))</span>
    <span class="c1"># Primal variable</span>
    <span class="n">V</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">Ainit</span><span class="p">)</span>

    <span class="c1"># Main variable</span>
    <span class="n">A</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">Ainit</span><span class="p">)</span>

    <span class="n">ref_mse</span> <span class="o">=</span> <span class="p">((</span><span class="n">X</span><span class="o">-</span><span class="n">S</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">Ainit</span><span class="p">))</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    <span class="nb">print</span> <span class="s2">&quot;---&gt;&gt;ref res: &lt;&lt;---&quot;</span><span class="p">,</span><span class="n">ref_mse</span>

    <span class="n">cost</span><span class="o">=</span><span class="mi">2</span>
    <span class="n">cost_old</span><span class="o">=</span><span class="mi">1</span>
    <span class="nb">iter</span><span class="o">=</span><span class="mi">0</span>
    <span class="n">var</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">while</span> <span class="nb">iter</span><span class="o">&lt;</span><span class="n">nb_iter</span><span class="p">:</span> <span class="c1">#and 100*abs(cost-cost_old)/abs(cost_old)&gt;tol:</span>
        <span class="nb">iter</span><span class="o">+=</span><span class="mi">1</span>
        <span class="c1"># Dual variables update</span>

        <span class="c1"># -- residual constraint variable update</span>
        <span class="n">temp1</span> <span class="o">=</span> <span class="n">Y1</span><span class="o">+</span><span class="n">sig</span><span class="o">*</span><span class="n">S</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">A</span><span class="p">)</span><span class="o">-</span><span class="n">sig</span><span class="o">*</span><span class="n">X</span>
        <span class="n">Y1</span> <span class="o">=</span> <span class="n">temp1</span><span class="o">-</span><span class="n">sig</span><span class="o">*</span><span class="n">proj_sphere</span><span class="p">(</span><span class="n">temp1</span><span class="o">/</span><span class="n">sig</span><span class="p">,</span><span class="n">O</span><span class="p">,</span><span class="n">sqrt</span><span class="p">(</span><span class="n">res_max</span><span class="p">))</span> <span class="c1"># Moreau id</span>

        <span class="c1"># -- columns normalization constraint variable update</span>
        <span class="n">temp2</span> <span class="o">=</span> <span class="n">Y2</span><span class="o">+</span><span class="n">sig</span><span class="o">*</span><span class="p">(</span><span class="n">A</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">shap1</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="mi">1</span><span class="p">))</span>
        <span class="n">Y2</span> <span class="o">=</span> <span class="n">temp2</span> <span class="o">-</span> <span class="n">sig</span><span class="o">*</span><span class="n">ones_vect1</span> <span class="c1"># Moreau id</span>

        <span class="c1"># Primal variable update</span>
        <span class="n">temp3</span> <span class="o">=</span> <span class="n">V</span> <span class="o">-</span> <span class="n">to</span><span class="o">*</span><span class="p">(</span><span class="n">transpose</span><span class="p">(</span><span class="n">S</span><span class="p">)</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">Y1</span><span class="p">)</span><span class="o">+</span><span class="n">ones_vect2</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">transpose</span><span class="p">(</span><span class="n">Y2</span><span class="p">)))</span>
        <span class="n">Vold</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">V</span><span class="p">)</span>
        <span class="n">V</span> <span class="o">=</span> <span class="n">pos_proj</span><span class="p">(</span><span class="n">utils</span><span class="o">.</span><span class="n">thresholding</span><span class="p">(</span><span class="n">temp3</span><span class="p">,</span><span class="n">to</span><span class="o">*</span><span class="n">thresh_map</span><span class="p">,</span><span class="n">thresh_type</span><span class="p">))</span>

        <span class="c1"># Main variable update</span>
        <span class="k">if</span> <span class="n">accel_en</span><span class="p">:</span>
            <span class="n">theta</span> <span class="o">=</span> <span class="mi">1</span><span class="o">/</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="mi">2</span><span class="o">*</span><span class="n">to</span><span class="p">)</span>
            <span class="n">to</span> <span class="o">=</span> <span class="n">theta</span><span class="o">*</span><span class="n">to</span>
            <span class="n">sig</span> <span class="o">=</span> <span class="n">sig</span><span class="o">/</span><span class="n">theta</span>
        <span class="n">Aold</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">A</span><span class="p">)</span>
        <span class="n">A</span> <span class="o">=</span> <span class="n">V</span> <span class="o">+</span> <span class="n">theta</span><span class="o">*</span><span class="p">(</span><span class="n">V</span><span class="o">-</span><span class="n">Vold</span><span class="p">)</span>

        <span class="c1"># Sanity check</span>
        <span class="n">min_comp</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">V</span><span class="o">*</span><span class="n">thresh_map</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="n">max_comp</span> <span class="o">=</span> <span class="p">(</span><span class="n">Y1</span><span class="o">*</span><span class="p">(</span><span class="n">S</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">V</span><span class="p">)))</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">+</span><span class="p">(</span><span class="n">Y2</span><span class="o">*</span><span class="p">(</span><span class="n">V</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">shap1</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="mi">1</span><span class="p">)))</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="n">cost_old</span> <span class="o">=</span> <span class="n">cost</span>
        <span class="n">cost</span> <span class="o">=</span> <span class="n">min_comp</span><span class="o">+</span><span class="n">max_comp</span>
        <span class="n">min_val</span> <span class="o">=</span> <span class="n">A</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
        <span class="n">mean_row_A</span> <span class="o">=</span> <span class="n">A</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">/</span><span class="n">shap1</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">cur_res</span> <span class="o">=</span> <span class="p">((</span><span class="n">X</span><span class="o">-</span><span class="n">S</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">A</span><span class="p">))</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="n">var</span> <span class="o">=</span> <span class="mi">100</span><span class="o">*</span><span class="p">((</span><span class="n">A</span><span class="o">-</span><span class="n">Aold</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">/</span><span class="p">(</span><span class="n">Aold</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    <span class="nb">print</span> <span class="s2">&quot;min_val: &quot;</span><span class="p">,</span><span class="n">min_val</span><span class="p">,</span><span class="s2">&quot; min_comp: &quot;</span><span class="p">,</span><span class="n">min_comp</span><span class="p">,</span><span class="s2">&quot; max_comp: &quot;</span><span class="p">,</span><span class="n">max_comp</span><span class="p">,</span><span class="s2">&quot; residual: &quot;</span><span class="p">,</span><span class="n">cur_res</span><span class="p">,</span><span class="s2">&quot; mean rows sum: &quot;</span><span class="p">,</span><span class="n">mean_row_A</span><span class="p">,</span><span class="s2">&quot; cost function: &quot;</span><span class="p">,</span><span class="n">cost</span>

    <span class="c1">#A = pos_proj(A)</span>
    <span class="c1">#A = A/(ones_vect2.dot((A.sum(axis=0)).reshape(1,shap1[1])))</span>

    <span class="k">return</span> <span class="n">A</span>

<span class="k">def</span> <span class="nf">non_unif_smoothing_mult_coeff_pos_cp</span><span class="p">(</span><span class="n">im</span><span class="p">,</span><span class="n">src</span><span class="p">,</span><span class="n">tree</span><span class="p">,</span><span class="n">weights</span><span class="p">,</span><span class="n">theta</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span><span class="n">p_smth_mat_inv</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">to</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">eps</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span><span class="n">nb_iter</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span><span class="n">tol</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span><span class="n">Ainit</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">pos_en</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span> <span class="c1"># to is the weight related to the primal variable</span>

    <span class="n">shap</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">nb_neigh</span> <span class="o">=</span> <span class="n">tree</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">Atemp</span><span class="p">,</span><span class="n">mat</span><span class="p">,</span><span class="n">v</span> <span class="o">=</span> <span class="n">lsq_mult_coeff_stack</span><span class="p">(</span><span class="n">im</span><span class="p">,</span><span class="n">src</span><span class="p">)</span>
    <span class="n">nb_src</span> <span class="o">=</span> <span class="n">Atemp</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">Ainit</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">pos_en</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">nb_src</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
                <span class="n">Ainit</span> <span class="o">=</span> <span class="n">pos_proj</span><span class="p">(</span><span class="n">Atemp</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">nb_src</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">:</span>
                <span class="n">Ainit</span> <span class="o">=</span> <span class="n">pos_proj_mat</span><span class="p">(</span><span class="n">Atemp</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">Ainit</span> <span class="o">=</span> <span class="n">Atemp</span>
    <span class="n">spec_rad</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">3</span><span class="p">]))</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">3</span><span class="p">]):</span>
        <span class="n">U</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">Vt</span> <span class="o">=</span> <span class="n">linalg</span><span class="o">.</span><span class="n">svd</span><span class="p">(</span><span class="n">mat</span><span class="p">[:,:,</span><span class="n">k</span><span class="p">],</span><span class="n">full_matrices</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">spec_rad</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
    <span class="n">spec_norm</span><span class="o">=</span><span class="kc">None</span>
    <span class="k">if</span> <span class="n">pos_en</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
        <span class="n">spec_norm</span> <span class="o">=</span> <span class="n">sqrt</span><span class="p">(</span><span class="n">spec_rad</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">spec_norm</span> <span class="o">=</span> <span class="n">sqrt</span><span class="p">(</span><span class="n">spec_rad</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span>
    <span class="k">if</span> <span class="n">to</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">a</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">weights</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="c1">#to = (2*a.max())**(-1)</span>
        <span class="n">to</span> <span class="o">=</span> <span class="mi">1</span><span class="o">/</span><span class="n">spec_norm</span>
    <span class="k">if</span> <span class="n">p_smth_mat_inv</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">p_smth_mat_inv</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span><span class="n">shap</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span><span class="n">nb_src</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">ind</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_src</span><span class="p">):</span>
            <span class="n">p_smth_mat</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span><span class="n">shap</span><span class="p">[</span><span class="mi">3</span><span class="p">]))</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">3</span><span class="p">]):</span>
                <span class="n">i1</span><span class="p">,</span><span class="n">i2</span> <span class="o">=</span> <span class="n">where</span><span class="p">(</span><span class="n">tree</span><span class="o">==</span><span class="n">k</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_neigh</span><span class="p">):</span>
                    <span class="n">p_smth_mat</span><span class="p">[</span><span class="n">k</span><span class="p">,</span><span class="n">tree</span><span class="p">[</span><span class="n">k</span><span class="p">,</span><span class="n">l</span><span class="p">]]</span><span class="o">=-</span><span class="n">weights</span><span class="p">[</span><span class="n">k</span><span class="p">,</span><span class="n">l</span><span class="p">,</span><span class="n">ind</span><span class="p">]</span>
                <span class="n">w</span><span class="o">=</span><span class="n">weights</span><span class="p">[</span><span class="n">k</span><span class="p">,:,</span><span class="n">ind</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">size</span><span class="p">(</span><span class="n">i1</span><span class="p">)):</span>
                    <span class="n">p</span> <span class="o">=</span> <span class="n">where</span><span class="p">((</span><span class="n">tree</span><span class="p">[</span><span class="n">k</span><span class="p">,:]</span><span class="o">==</span><span class="n">i1</span><span class="p">[</span><span class="n">j</span><span class="p">]))</span>
                    <span class="k">if</span> <span class="n">size</span><span class="p">(</span><span class="n">p</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
                        <span class="n">w</span><span class="o">+=</span><span class="n">weights</span><span class="p">[</span><span class="n">i1</span><span class="p">[</span><span class="n">j</span><span class="p">],</span><span class="n">i2</span><span class="p">[</span><span class="n">j</span><span class="p">],</span><span class="n">ind</span><span class="p">]</span>
                        <span class="n">p_smth_mat</span><span class="p">[</span><span class="n">k</span><span class="p">,</span><span class="n">i1</span><span class="p">[</span><span class="n">j</span><span class="p">]]</span> <span class="o">=</span> <span class="o">-</span><span class="n">weights</span><span class="p">[</span><span class="n">i1</span><span class="p">[</span><span class="n">j</span><span class="p">],</span><span class="n">i2</span><span class="p">[</span><span class="n">j</span><span class="p">],</span><span class="n">ind</span><span class="p">]</span>
                <span class="n">p_smth_mat</span><span class="p">[</span><span class="n">k</span><span class="p">,</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">w</span>
            <span class="n">mat_temp</span> <span class="o">=</span> <span class="n">eye</span><span class="p">(</span><span class="n">shap</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span><span class="o">+</span><span class="n">to</span><span class="o">*</span><span class="n">p_smth_mat</span>
            <span class="n">p_smth_mat_inv</span><span class="p">[:,:,</span><span class="n">ind</span><span class="p">]</span> <span class="o">=</span> <span class="n">LA</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">mat_temp</span><span class="p">)</span>

    <span class="n">sig</span> <span class="o">=</span> <span class="n">eps</span><span class="o">/</span><span class="p">(</span><span class="n">to</span><span class="o">*</span><span class="n">spec_norm</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="c1"># Weight related to the dual variables</span>

    <span class="c1"># Dual variables</span>
    <span class="n">y1</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">Ainit</span><span class="p">)</span>
    <span class="n">y2</span> <span class="o">=</span> <span class="n">im</span><span class="o">*</span><span class="mi">0</span>
    <span class="n">o</span> <span class="o">=</span> <span class="n">y2</span><span class="o">*</span><span class="mi">0</span>
    <span class="n">rad</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">3</span><span class="p">],))</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">3</span><span class="p">]):</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">im</span><span class="p">[:,:,</span><span class="n">k</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
            <span class="n">res</span><span class="o">-=</span><span class="n">Ainit</span><span class="p">[</span><span class="n">l</span><span class="p">,</span><span class="n">k</span><span class="p">]</span><span class="o">*</span><span class="n">src</span><span class="p">[:,:,</span><span class="n">l</span><span class="p">,</span><span class="n">k</span><span class="p">]</span>
        <span class="n">y2</span><span class="p">[:,:,</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">res</span>
        <span class="n">rad</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">res</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    <span class="nb">print</span> <span class="s2">&quot;---&gt;&gt;ref res: &lt;&lt;---&quot;</span><span class="p">,</span><span class="n">rad</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    <span class="c1"># Primal variable</span>
    <span class="n">v</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">Ainit</span><span class="p">)</span>

    <span class="c1"># Main variable</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">Ainit</span><span class="p">)</span>

    <span class="n">cost</span><span class="o">=</span><span class="mi">1</span>
    <span class="n">cost_old</span><span class="o">=</span><span class="mi">0</span>
    <span class="nb">iter</span><span class="o">=</span><span class="mi">0</span>

    <span class="k">while</span> <span class="nb">iter</span><span class="o">&lt;</span><span class="n">nb_iter</span> <span class="ow">and</span> <span class="mi">100</span><span class="o">*</span><span class="nb">abs</span><span class="p">(</span><span class="n">cost</span><span class="o">-</span><span class="n">cost_old</span><span class="p">)</span><span class="o">/</span><span class="nb">abs</span><span class="p">(</span><span class="n">cost</span><span class="p">)</span><span class="o">&gt;</span><span class="n">tol</span> <span class="p">:</span>

        <span class="nb">iter</span><span class="o">+=</span><span class="mi">1</span>
        <span class="c1"># Dual variables update</span>
            <span class="c1"># Positivity</span>
        <span class="n">temp1</span> <span class="o">=</span> <span class="n">y1</span><span class="o">+</span><span class="n">sig</span><span class="o">*</span><span class="n">x</span>
        <span class="k">if</span> <span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">y1</span> <span class="o">=</span> <span class="o">-</span><span class="n">pos_proj</span><span class="p">(</span><span class="o">-</span><span class="n">temp1</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">y1</span> <span class="o">=</span> <span class="o">-</span><span class="n">pos_proj_mat</span><span class="p">(</span><span class="o">-</span><span class="n">temp1</span><span class="p">)</span>

            <span class="c1"># Residual constraint</span>
        <span class="n">temp2</span> <span class="o">=</span> <span class="n">y2</span><span class="o">*</span><span class="mi">0</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">3</span><span class="p">]):</span>
            <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
                <span class="n">temp2</span><span class="p">[:,:,</span><span class="n">k</span><span class="p">]</span> <span class="o">+=</span><span class="n">sig</span><span class="o">*</span><span class="n">x</span><span class="p">[</span><span class="n">l</span><span class="p">,</span><span class="n">k</span><span class="p">]</span><span class="o">*</span><span class="n">src</span><span class="p">[:,:,</span><span class="n">l</span><span class="p">,</span><span class="n">k</span><span class="p">]</span>
        <span class="n">temp2</span><span class="o">+=</span><span class="n">y2</span><span class="o">-</span><span class="n">sig</span><span class="o">*</span><span class="n">im</span>
        <span class="n">y2</span> <span class="o">=</span> <span class="n">temp2</span><span class="o">-</span><span class="n">sig</span><span class="o">*</span><span class="n">proj_sphere_cube</span><span class="p">(</span><span class="n">temp2</span><span class="o">/</span><span class="n">sig</span><span class="p">,</span><span class="n">o</span><span class="p">,</span><span class="n">sqrt</span><span class="p">(</span><span class="n">rad</span><span class="p">))</span> <span class="c1"># Moreau id</span>

        <span class="c1"># Primal variable update</span>
        <span class="n">temp3</span> <span class="o">=</span> <span class="n">to</span><span class="o">*</span><span class="n">copy</span><span class="p">(</span><span class="n">y1</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">3</span><span class="p">]):</span>
            <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
                <span class="n">temp3</span><span class="p">[</span><span class="n">l</span><span class="p">,</span><span class="n">k</span><span class="p">]</span><span class="o">+=</span><span class="n">to</span><span class="o">*</span><span class="p">(</span><span class="n">src</span><span class="p">[:,:,</span><span class="n">l</span><span class="p">,</span><span class="n">k</span><span class="p">]</span><span class="o">*</span><span class="n">y2</span><span class="p">[:,:,</span><span class="n">k</span><span class="p">])</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="n">temp4</span> <span class="o">=</span> <span class="n">v</span> <span class="o">-</span> <span class="n">temp3</span>
        <span class="n">vold</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
        <span class="n">v</span> <span class="o">=</span> <span class="n">smoothing_prox</span><span class="p">(</span><span class="n">p_smth_mat_inv</span><span class="p">,</span><span class="n">temp4</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">v</span><span class="o">+</span><span class="n">theta</span><span class="o">*</span><span class="p">(</span><span class="n">v</span><span class="o">-</span><span class="n">vold</span><span class="p">)</span>

        <span class="c1"># Sanity check</span>
        <span class="n">cost_smooth</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">3</span><span class="p">]):</span>
            <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_neigh</span><span class="p">):</span>
                <span class="n">cost_smooth</span><span class="o">+=</span><span class="p">(((</span><span class="n">x</span><span class="p">[:,</span><span class="n">k</span><span class="p">]</span><span class="o">-</span><span class="n">x</span><span class="p">[:,</span><span class="n">tree</span><span class="p">[</span><span class="n">k</span><span class="p">,</span><span class="n">l</span><span class="p">]])</span><span class="o">*</span><span class="n">sqrt</span><span class="p">(</span><span class="n">weights</span><span class="p">[</span><span class="n">k</span><span class="p">,</span><span class="n">l</span><span class="p">,:]))</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="c1"># Objective value</span>
        <span class="n">temp5</span> <span class="o">=</span> <span class="n">y2</span><span class="o">*</span><span class="mi">0</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">3</span><span class="p">]):</span>
            <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
                <span class="n">temp5</span><span class="p">[:,:,</span><span class="n">k</span><span class="p">]</span> <span class="o">+=</span><span class="n">x</span><span class="p">[</span><span class="n">l</span><span class="p">,</span><span class="n">k</span><span class="p">]</span><span class="o">*</span><span class="n">src</span><span class="p">[:,:,</span><span class="n">l</span><span class="p">,</span><span class="n">k</span><span class="p">]</span>
        <span class="n">max_comp</span> <span class="o">=</span> <span class="p">(</span><span class="n">temp5</span><span class="o">*</span><span class="n">y2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">+</span><span class="p">(</span><span class="n">y1</span><span class="o">*</span><span class="n">x</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="n">temp5</span><span class="o">-=</span><span class="n">im</span>
        <span class="n">min_comp</span> <span class="o">=</span> <span class="n">cost_smooth</span>
        <span class="n">cost_old</span> <span class="o">=</span> <span class="n">cost</span>
        <span class="n">cost</span> <span class="o">=</span> <span class="n">min_comp</span><span class="o">+</span><span class="n">max_comp</span>
        <span class="nb">print</span> <span class="s2">&quot;residual: &quot;</span><span class="p">,(</span><span class="n">temp5</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(),</span> <span class="s2">&quot; smoothness: &quot;</span><span class="p">,</span><span class="n">cost_smooth</span><span class="p">,</span><span class="s2">&quot; linear part: &quot;</span><span class="p">,</span><span class="n">max_comp</span><span class="p">,</span><span class="s2">&quot; objective val: &quot;</span><span class="p">,</span><span class="n">cost</span><span class="p">,</span><span class="s2">&quot; min val: &quot;</span><span class="p">,</span><span class="n">x</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>


    <span class="k">return</span> <span class="n">x</span>



<span class="k">def</span> <span class="nf">non_unif_smoothing_mult_coeff_pos_cp_2</span><span class="p">(</span><span class="n">im</span><span class="p">,</span><span class="n">src</span><span class="p">,</span><span class="n">src_hr</span><span class="p">,</span><span class="n">tree</span><span class="p">,</span><span class="n">weights</span><span class="p">,</span><span class="n">theta</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span><span class="n">p_smth_mat_inv</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">to</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">eps</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span><span class="n">nb_iter</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span><span class="n">tol</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span><span class="n">Ainit</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">pos_en</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span> <span class="c1"># to is the weight related to the primal variable</span>

    <span class="n">shap</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">shap1</span> <span class="o">=</span> <span class="n">src_hr</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">src_mat</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
            <span class="n">src_mat</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">src_hr</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">]</span><span class="o">*</span><span class="n">src_hr</span><span class="p">[:,:,</span><span class="n">j</span><span class="p">])</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    <span class="n">src_mat</span> <span class="o">=</span> <span class="n">src_mat</span><span class="o">+</span><span class="n">transpose</span><span class="p">(</span><span class="n">src_mat</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
        <span class="n">src_mat</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">src</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    <span class="n">U</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">Vt</span> <span class="o">=</span> <span class="n">linalg</span><span class="o">.</span><span class="n">svd</span><span class="p">(</span><span class="n">src_mat</span><span class="p">,</span><span class="n">full_matrices</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">spec_rad_pos</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
    <span class="n">nb_neigh</span> <span class="o">=</span> <span class="n">tree</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">Atemp</span><span class="p">,</span><span class="n">mat</span><span class="p">,</span><span class="n">v</span> <span class="o">=</span> <span class="n">lsq_mult_coeff_stack</span><span class="p">(</span><span class="n">im</span><span class="p">,</span><span class="n">src</span><span class="p">)</span>
    <span class="n">nb_src</span> <span class="o">=</span> <span class="n">Atemp</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">Ainit</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">pos_en</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">nb_src</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
                <span class="n">Ainit</span> <span class="o">=</span> <span class="n">pos_proj</span><span class="p">(</span><span class="n">Atemp</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">nb_src</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">:</span>
                <span class="n">Ainit</span> <span class="o">=</span> <span class="n">pos_proj_mat</span><span class="p">(</span><span class="n">Atemp</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">Ainit</span> <span class="o">=</span> <span class="n">Atemp</span>
    <span class="n">spec_rad</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">3</span><span class="p">]))</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">3</span><span class="p">]):</span>
        <span class="n">U</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">Vt</span> <span class="o">=</span> <span class="n">linalg</span><span class="o">.</span><span class="n">svd</span><span class="p">(</span><span class="n">mat</span><span class="p">[:,:,</span><span class="n">k</span><span class="p">],</span><span class="n">full_matrices</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">spec_rad</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
    <span class="n">spec_norm</span><span class="o">=</span><span class="kc">None</span>
    <span class="k">if</span> <span class="n">pos_en</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
        <span class="n">spec_norm</span> <span class="o">=</span> <span class="n">sqrt</span><span class="p">(</span><span class="n">spec_rad</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">+</span><span class="n">spec_rad_pos</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">spec_norm</span> <span class="o">=</span> <span class="n">sqrt</span><span class="p">(</span><span class="n">spec_rad</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span>
    <span class="sd">&quot;&quot;&quot;if to is None:</span>
<span class="sd">        a = sum(weights,axis=1)</span>
<span class="sd">        #to = (2*a.max())**(-1)</span>
<span class="sd">        to = 1/spec_norm&quot;&quot;&quot;</span>
    <span class="n">to</span> <span class="o">=</span> <span class="mf">1.0</span><span class="o">/</span><span class="n">spec_norm</span>

    <span class="k">if</span> <span class="n">p_smth_mat_inv</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">p_smth_mat_inv</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span><span class="n">shap</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span><span class="n">nb_src</span><span class="p">))</span>
        <span class="n">p_smth_mat_stack</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span><span class="n">shap</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span><span class="n">nb_src</span><span class="p">))</span>
        <span class="n">spec_rad_stack</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">nb_src</span><span class="p">,))</span>
        <span class="k">for</span> <span class="n">ind</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_src</span><span class="p">):</span>
            <span class="n">p_smth_mat</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span><span class="n">shap</span><span class="p">[</span><span class="mi">3</span><span class="p">]))</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">3</span><span class="p">]):</span>
                <span class="n">i1</span><span class="p">,</span><span class="n">i2</span> <span class="o">=</span> <span class="n">where</span><span class="p">(</span><span class="n">tree</span><span class="o">==</span><span class="n">k</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_neigh</span><span class="p">):</span>
                    <span class="n">p_smth_mat</span><span class="p">[</span><span class="n">k</span><span class="p">,</span><span class="n">tree</span><span class="p">[</span><span class="n">k</span><span class="p">,</span><span class="n">l</span><span class="p">]]</span><span class="o">=-</span><span class="n">weights</span><span class="p">[</span><span class="n">k</span><span class="p">,</span><span class="n">l</span><span class="p">,</span><span class="n">ind</span><span class="p">]</span>
                <span class="n">w</span><span class="o">=</span><span class="n">weights</span><span class="p">[</span><span class="n">k</span><span class="p">,:,</span><span class="n">ind</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">size</span><span class="p">(</span><span class="n">i1</span><span class="p">)):</span>
                    <span class="n">p</span> <span class="o">=</span> <span class="n">where</span><span class="p">((</span><span class="n">tree</span><span class="p">[</span><span class="n">k</span><span class="p">,:]</span><span class="o">==</span><span class="n">i1</span><span class="p">[</span><span class="n">j</span><span class="p">]))</span>
                    <span class="k">if</span> <span class="n">size</span><span class="p">(</span><span class="n">p</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
                        <span class="n">w</span><span class="o">+=</span><span class="n">weights</span><span class="p">[</span><span class="n">i1</span><span class="p">[</span><span class="n">j</span><span class="p">],</span><span class="n">i2</span><span class="p">[</span><span class="n">j</span><span class="p">],</span><span class="n">ind</span><span class="p">]</span>
                        <span class="n">p_smth_mat</span><span class="p">[</span><span class="n">k</span><span class="p">,</span><span class="n">i1</span><span class="p">[</span><span class="n">j</span><span class="p">]]</span> <span class="o">=</span> <span class="o">-</span><span class="n">weights</span><span class="p">[</span><span class="n">i1</span><span class="p">[</span><span class="n">j</span><span class="p">],</span><span class="n">i2</span><span class="p">[</span><span class="n">j</span><span class="p">],</span><span class="n">ind</span><span class="p">]</span>
                <span class="n">p_smth_mat</span><span class="p">[</span><span class="n">k</span><span class="p">,</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">w</span>
            <span class="n">p_smth_mat_stack</span><span class="p">[:,:,</span><span class="n">ind</span><span class="p">]</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">p_smth_mat</span><span class="p">)</span><span class="c1">#transpose(p_smth_mat).dot(p_smth_mat)</span>
            <span class="n">U</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">Vt</span> <span class="o">=</span> <span class="n">linalg</span><span class="o">.</span><span class="n">svd</span><span class="p">(</span><span class="n">p_smth_mat_stack</span><span class="p">[:,:,</span><span class="n">ind</span><span class="p">],</span><span class="n">full_matrices</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">spec_rad_stack</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
        <span class="c1">#to = 1.0/spec_rad_stack.max()</span>
        <span class="k">for</span> <span class="n">ind</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_src</span><span class="p">):</span>
            <span class="n">mat_temp</span> <span class="o">=</span> <span class="n">eye</span><span class="p">(</span><span class="n">shap</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span><span class="o">+</span><span class="n">to</span><span class="o">*</span><span class="n">p_smth_mat_stack</span><span class="p">[:,:,</span><span class="n">ind</span><span class="p">]</span>
            <span class="n">p_smth_mat_inv</span><span class="p">[:,:,</span><span class="n">ind</span><span class="p">]</span> <span class="o">=</span> <span class="n">LA</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">mat_temp</span><span class="p">)</span>

    <span class="n">sig</span> <span class="o">=</span> <span class="n">eps</span><span class="o">/</span><span class="p">(</span><span class="n">to</span><span class="o">*</span><span class="n">spec_norm</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="c1"># Weight related to the dual variables</span>

    <span class="c1"># Dual variables</span>
    <span class="c1">#y1 = copy(Ainit)</span>
    <span class="n">y1</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">shap1</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">shap1</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">shap</span><span class="p">[</span><span class="mi">3</span><span class="p">]))</span>
    <span class="n">y2</span> <span class="o">=</span> <span class="n">im</span><span class="o">*</span><span class="mi">0</span>
    <span class="n">o</span> <span class="o">=</span> <span class="n">y2</span><span class="o">*</span><span class="mi">0</span>
    <span class="n">rad</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">3</span><span class="p">],))</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">3</span><span class="p">]):</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">im</span><span class="p">[:,:,</span><span class="n">k</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
            <span class="n">res</span><span class="o">-=</span><span class="n">Ainit</span><span class="p">[</span><span class="n">l</span><span class="p">,</span><span class="n">k</span><span class="p">]</span><span class="o">*</span><span class="n">src</span><span class="p">[:,:,</span><span class="n">l</span><span class="p">,</span><span class="n">k</span><span class="p">]</span>
        <span class="n">y2</span><span class="p">[:,:,</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">res</span>
        <span class="n">rad</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">res</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    <span class="nb">print</span> <span class="s2">&quot;---&gt;&gt; ref res: &lt;&lt;---&quot;</span><span class="p">,</span><span class="n">rad</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    <span class="c1"># Primal variable</span>
    <span class="n">v</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">Ainit</span><span class="p">)</span>

    <span class="c1"># Main variable</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">Ainit</span><span class="p">)</span>

    <span class="n">cost</span><span class="o">=</span><span class="mi">1</span>
    <span class="n">cost_old</span><span class="o">=</span><span class="mi">0</span>
    <span class="nb">iter</span><span class="o">=</span><span class="mi">0</span>
    <span class="n">temp6</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">while</span> <span class="nb">iter</span><span class="o">&lt;</span><span class="n">nb_iter</span> <span class="ow">and</span> <span class="mi">100</span><span class="o">*</span><span class="nb">abs</span><span class="p">(</span><span class="n">cost</span><span class="o">-</span><span class="n">cost_old</span><span class="p">)</span><span class="o">/</span><span class="nb">abs</span><span class="p">(</span><span class="n">cost</span><span class="p">)</span><span class="o">&gt;</span><span class="n">tol</span> <span class="p">:</span>

        <span class="nb">iter</span><span class="o">+=</span><span class="mi">1</span>
        <span class="c1"># Dual variables update</span>
        <span class="c1"># Positivity</span>
        <span class="c1">#temp1 = y1+sig*x</span>
        <span class="n">temp1</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">y1</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">3</span><span class="p">]):</span>
            <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
                <span class="n">temp1</span><span class="p">[:,:,</span><span class="n">k</span><span class="p">]</span> <span class="o">+=</span><span class="n">sig</span><span class="o">*</span><span class="n">x</span><span class="p">[</span><span class="n">l</span><span class="p">,</span><span class="n">k</span><span class="p">]</span><span class="o">*</span><span class="n">src_hr</span><span class="p">[:,:,</span><span class="n">l</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">y1</span> <span class="o">=</span> <span class="n">temp1</span><span class="o">-</span><span class="n">sig</span><span class="o">*</span><span class="n">pos_proj_mat</span><span class="p">(</span><span class="n">temp1</span><span class="o">/</span><span class="n">sig</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">y1</span> <span class="o">=</span> <span class="n">temp1</span><span class="o">-</span><span class="n">sig</span><span class="o">*</span><span class="n">pos_proj_cube</span><span class="p">(</span><span class="n">temp1</span><span class="o">/</span><span class="n">sig</span><span class="p">)</span>

        <span class="c1"># Residual constraint</span>
        <span class="n">temp2</span> <span class="o">=</span> <span class="n">y2</span><span class="o">*</span><span class="mi">0</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">3</span><span class="p">]):</span>
            <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
                <span class="n">temp2</span><span class="p">[:,:,</span><span class="n">k</span><span class="p">]</span> <span class="o">+=</span><span class="n">sig</span><span class="o">*</span><span class="n">x</span><span class="p">[</span><span class="n">l</span><span class="p">,</span><span class="n">k</span><span class="p">]</span><span class="o">*</span><span class="n">src</span><span class="p">[:,:,</span><span class="n">l</span><span class="p">,</span><span class="n">k</span><span class="p">]</span>
        <span class="n">temp2</span><span class="o">+=</span><span class="n">y2</span><span class="o">-</span><span class="n">sig</span><span class="o">*</span><span class="n">im</span>
        <span class="n">y2</span> <span class="o">=</span> <span class="n">temp2</span><span class="o">-</span><span class="n">sig</span><span class="o">*</span><span class="n">proj_sphere_cube</span><span class="p">(</span><span class="n">temp2</span><span class="o">/</span><span class="n">sig</span><span class="p">,</span><span class="n">o</span><span class="p">,</span><span class="n">sqrt</span><span class="p">(</span><span class="n">rad</span><span class="p">))</span> <span class="c1"># Moreau id</span>

        <span class="c1"># Primal variable update</span>
        <span class="n">temp3</span> <span class="o">=</span> <span class="n">x</span><span class="o">*</span><span class="mi">0</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">3</span><span class="p">]):</span>
            <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
                <span class="n">temp3</span><span class="p">[</span><span class="n">l</span><span class="p">,</span><span class="n">k</span><span class="p">]</span><span class="o">+=</span><span class="n">to</span><span class="o">*</span><span class="p">((</span><span class="n">src</span><span class="p">[:,:,</span><span class="n">l</span><span class="p">,</span><span class="n">k</span><span class="p">]</span><span class="o">*</span><span class="n">y2</span><span class="p">[:,:,</span><span class="n">k</span><span class="p">])</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">+</span><span class="p">(</span><span class="n">src_hr</span><span class="p">[:,:,</span><span class="n">l</span><span class="p">]</span><span class="o">*</span><span class="n">y1</span><span class="p">[:,:,</span><span class="n">k</span><span class="p">])</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span>
        <span class="n">temp4</span> <span class="o">=</span> <span class="n">v</span> <span class="o">-</span> <span class="n">temp3</span>
        <span class="n">vold</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
        <span class="n">v</span> <span class="o">=</span> <span class="n">smoothing_prox</span><span class="p">(</span><span class="n">p_smth_mat_inv</span><span class="p">,</span><span class="n">temp4</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">v</span><span class="o">+</span><span class="n">theta</span><span class="o">*</span><span class="p">(</span><span class="n">v</span><span class="o">-</span><span class="n">vold</span><span class="p">)</span>

        <span class="c1"># Sanity check</span>
        <span class="n">cost_smooth</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">3</span><span class="p">]):</span>
            <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_neigh</span><span class="p">):</span>
                <span class="n">cost_smooth</span><span class="o">+=</span><span class="p">(((</span><span class="n">x</span><span class="p">[:,</span><span class="n">k</span><span class="p">]</span><span class="o">-</span><span class="n">x</span><span class="p">[:,</span><span class="n">tree</span><span class="p">[</span><span class="n">k</span><span class="p">,</span><span class="n">l</span><span class="p">]])</span><span class="o">*</span><span class="n">sqrt</span><span class="p">(</span><span class="n">weights</span><span class="p">[</span><span class="n">k</span><span class="p">,</span><span class="n">l</span><span class="p">,:]))</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="c1"># Objective value</span>
        <span class="n">temp5</span> <span class="o">=</span> <span class="n">y2</span><span class="o">*</span><span class="mi">0</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">3</span><span class="p">]):</span>
            <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
                <span class="n">temp5</span><span class="p">[:,:,</span><span class="n">k</span><span class="p">]</span> <span class="o">+=</span><span class="n">x</span><span class="p">[</span><span class="n">l</span><span class="p">,</span><span class="n">k</span><span class="p">]</span><span class="o">*</span><span class="n">src</span><span class="p">[:,:,</span><span class="n">l</span><span class="p">,</span><span class="n">k</span><span class="p">]</span>
        <span class="n">temp6</span> <span class="o">=</span> <span class="n">y1</span><span class="o">*</span><span class="mi">0</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">3</span><span class="p">]):</span>
            <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
                <span class="n">temp6</span><span class="p">[:,:,</span><span class="n">k</span><span class="p">]</span> <span class="o">+=</span><span class="n">x</span><span class="p">[</span><span class="n">l</span><span class="p">,</span><span class="n">k</span><span class="p">]</span><span class="o">*</span><span class="n">src_hr</span><span class="p">[:,:,</span><span class="n">l</span><span class="p">]</span>
        <span class="n">max_comp</span> <span class="o">=</span> <span class="p">(</span><span class="n">temp5</span><span class="o">*</span><span class="n">y2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">+</span><span class="p">(</span><span class="n">y1</span><span class="o">*</span><span class="n">temp6</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="n">temp5</span><span class="o">-=</span><span class="n">im</span>
        <span class="n">min_comp</span> <span class="o">=</span> <span class="n">cost_smooth</span>
        <span class="n">cost_old</span> <span class="o">=</span> <span class="n">cost</span>
        <span class="n">cost</span> <span class="o">=</span> <span class="n">min_comp</span><span class="o">+</span><span class="n">max_comp</span>
        <span class="nb">print</span> <span class="s2">&quot;residual: &quot;</span><span class="p">,(</span><span class="n">temp5</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(),</span> <span class="s2">&quot; smoothness: &quot;</span><span class="p">,</span><span class="n">cost_smooth</span><span class="p">,</span><span class="s2">&quot; linear part: &quot;</span><span class="p">,</span><span class="n">max_comp</span><span class="p">,</span><span class="s2">&quot; objective val: &quot;</span><span class="p">,</span><span class="n">cost</span><span class="p">,</span><span class="s2">&quot; min val: &quot;</span><span class="p">,</span><span class="n">temp6</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>

    <span class="n">min_val_map</span> <span class="o">=</span> <span class="n">temp6</span><span class="p">[:,:,</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap1</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap1</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
            <span class="n">min_val_map</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">temp6</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,:]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
    <span class="nb">print</span> <span class="s2">&quot;median min val: &quot;</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">min_val_map</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">x</span><span class="p">,</span><span class="n">min_val_map</span>

<span class="k">def</span> <span class="nf">non_unif_smoothing_mult_coeff_pos_cp_3</span><span class="p">(</span><span class="n">im</span><span class="p">,</span><span class="n">src</span><span class="p">,</span><span class="n">src_hr</span><span class="p">,</span><span class="n">tree</span><span class="p">,</span><span class="n">weights</span><span class="p">,</span><span class="n">e</span><span class="p">,</span><span class="n">theta</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span><span class="n">p_smth_mat_inv</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">to</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">eps</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span><span class="n">nb_iter</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span><span class="n">tol</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span><span class="n">Ainit</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">pos_en</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">reg_param</span><span class="o">=</span><span class="mi">1000</span><span class="p">):</span> <span class="c1"># to is the weight related to the primal variable;  e is a nothc filter parameter</span>

    <span class="n">shap</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">shap1</span> <span class="o">=</span> <span class="n">src_hr</span><span class="o">.</span><span class="n">shape</span>
    <span class="nb">print</span> <span class="n">shap1</span>
    <span class="n">src_mat</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
            <span class="n">src_mat</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">src_hr</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">]</span><span class="o">*</span><span class="n">src_hr</span><span class="p">[:,:,</span><span class="n">j</span><span class="p">])</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    <span class="n">src_mat</span> <span class="o">=</span> <span class="n">src_mat</span><span class="o">+</span><span class="n">transpose</span><span class="p">(</span><span class="n">src_mat</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
        <span class="n">src_mat</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">src</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    <span class="n">U</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">Vt</span> <span class="o">=</span> <span class="n">linalg</span><span class="o">.</span><span class="n">svd</span><span class="p">(</span><span class="n">src_mat</span><span class="p">,</span><span class="n">full_matrices</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">spec_rad_pos</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
    <span class="n">nb_neigh</span> <span class="o">=</span> <span class="n">tree</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">Atemp</span><span class="p">,</span><span class="n">mat</span><span class="p">,</span><span class="n">v</span> <span class="o">=</span> <span class="n">lsq_mult_coeff_stack</span><span class="p">(</span><span class="n">im</span><span class="p">,</span><span class="n">src</span><span class="p">)</span>
    <span class="n">nb_src</span> <span class="o">=</span> <span class="n">Atemp</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">Ainit</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">pos_en</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">nb_src</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
                <span class="n">Ainit</span> <span class="o">=</span> <span class="n">pos_proj</span><span class="p">(</span><span class="n">Atemp</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">nb_src</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">:</span>
                <span class="n">Ainit</span> <span class="o">=</span> <span class="n">pos_proj_mat</span><span class="p">(</span><span class="n">Atemp</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">Ainit</span> <span class="o">=</span> <span class="n">Atemp</span>
    <span class="n">spec_rad</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">3</span><span class="p">]))</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">3</span><span class="p">]):</span>
        <span class="n">U</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">Vt</span> <span class="o">=</span> <span class="n">linalg</span><span class="o">.</span><span class="n">svd</span><span class="p">(</span><span class="n">mat</span><span class="p">[:,:,</span><span class="n">k</span><span class="p">],</span><span class="n">full_matrices</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">spec_rad</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
    <span class="n">spec_norm</span><span class="o">=</span><span class="kc">None</span>
    <span class="k">if</span> <span class="n">pos_en</span><span class="p">:</span>
        <span class="n">spec_norm</span> <span class="o">=</span> <span class="n">sqrt</span><span class="p">(</span><span class="n">spec_rad</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">+</span><span class="n">spec_rad_pos</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">spec_norm</span> <span class="o">=</span> <span class="n">sqrt</span><span class="p">(</span><span class="n">spec_rad</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span>
    <span class="k">if</span> <span class="n">to</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">a</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">weights</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="c1">#to = (2*a.max())**(-1)</span>
    <span class="n">to</span> <span class="o">=</span> <span class="mi">1</span><span class="o">/</span><span class="p">(</span><span class="n">spec_norm</span><span class="p">)</span>
    <span class="nb">print</span> <span class="s1">&#39;----smoothing cp spec_rad-----: &#39;</span><span class="p">,</span><span class="n">spec_norm</span>
    <span class="n">lambd_init</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">p_smth_mat_stack</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">p_smth_mat_inv</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">p_smth_mat_inv</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span><span class="n">shap</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span><span class="n">nb_src</span><span class="p">))</span>
        <span class="n">p_smth_mat_stack</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span><span class="n">shap</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span><span class="n">nb_src</span><span class="p">))</span>
        <span class="n">spec_rad_stack</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">nb_src</span><span class="p">,))</span>
        <span class="k">for</span> <span class="n">ind</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_src</span><span class="p">):</span>
            <span class="n">p_smth_mat</span> <span class="o">=</span> <span class="n">non_uniform_smoothing_mat_2</span><span class="p">(</span><span class="n">weights</span><span class="p">[:,:,</span><span class="n">ind</span><span class="p">],</span><span class="n">e</span><span class="p">[</span><span class="n">ind</span><span class="p">])</span>
            <span class="c1">#p_smth_mat_stack[:,:,ind] = transpose(p_smth_mat).dot(p_smth_mat)</span>
            <span class="n">p_smth_mat_stack</span><span class="p">[:,:,</span><span class="n">ind</span><span class="p">]</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">p_smth_mat</span><span class="p">)</span>
            <span class="n">U</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">Vt</span> <span class="o">=</span> <span class="n">linalg</span><span class="o">.</span><span class="n">svd</span><span class="p">(</span><span class="n">p_smth_mat_stack</span><span class="p">[:,:,</span><span class="n">ind</span><span class="p">],</span><span class="n">full_matrices</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">spec_rad_stack</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
        <span class="n">to</span> <span class="o">=</span> <span class="mf">1.0</span><span class="o">/</span><span class="n">spec_rad_stack</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
        <span class="n">lambd_init</span> <span class="o">=</span> <span class="n">reg_param</span><span class="o">*</span><span class="n">spec_rad_stack</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">ind</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_src</span><span class="p">):</span>
            <span class="n">mat_temp</span> <span class="o">=</span> <span class="n">eye</span><span class="p">(</span><span class="n">shap</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span><span class="o">+</span><span class="n">to</span><span class="o">*</span><span class="n">p_smth_mat_stack</span><span class="p">[:,:,</span><span class="n">ind</span><span class="p">]</span>
            <span class="n">p_smth_mat_inv</span><span class="p">[:,:,</span><span class="n">ind</span><span class="p">]</span> <span class="o">=</span> <span class="n">LA</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">mat_temp</span><span class="p">)</span>

    <span class="n">sig</span> <span class="o">=</span> <span class="n">eps</span><span class="o">/</span><span class="p">(</span><span class="n">to</span><span class="o">*</span><span class="n">spec_norm</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="c1"># Weight related to the dual variables</span>

    <span class="c1"># Dual variables</span>
    <span class="c1">#y1 = copy(Ainit)</span>
    <span class="n">y1</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">shap1</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">shap1</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">shap</span><span class="p">[</span><span class="mi">3</span><span class="p">]))</span>
    <span class="n">y2</span> <span class="o">=</span> <span class="n">im</span><span class="o">*</span><span class="mi">0</span>
    <span class="n">o</span> <span class="o">=</span> <span class="n">y2</span><span class="o">*</span><span class="mi">0</span>
    <span class="n">rad</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">3</span><span class="p">],))</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">3</span><span class="p">]):</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">im</span><span class="p">[:,:,</span><span class="n">k</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
            <span class="n">res</span><span class="o">-=</span><span class="n">Ainit</span><span class="p">[</span><span class="n">l</span><span class="p">,</span><span class="n">k</span><span class="p">]</span><span class="o">*</span><span class="n">src</span><span class="p">[:,:,</span><span class="n">l</span><span class="p">,</span><span class="n">k</span><span class="p">]</span>
        <span class="n">y2</span><span class="p">[:,:,</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">res</span>
        <span class="n">rad</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">res</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    <span class="nb">print</span> <span class="s2">&quot;---&gt;&gt; ref res: &lt;&lt;---&quot;</span><span class="p">,</span><span class="n">rad</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    <span class="n">ref_res</span> <span class="o">=</span> <span class="n">rad</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    <span class="c1"># Primal variable</span>
    <span class="n">v</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">Ainit</span><span class="p">)</span>

    <span class="c1"># Main variable</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">Ainit</span><span class="p">)</span>
    <span class="n">cost</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">cur_res</span> <span class="o">=</span><span class="mi">2</span><span class="o">*</span><span class="n">ref_res</span>
    <span class="n">cost_old</span><span class="o">=</span><span class="mi">0</span>
    <span class="nb">iter</span><span class="o">=</span><span class="mi">0</span>
    <span class="n">temp6</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">array</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">3</span><span class="p">]))</span>
    <span class="k">while</span> <span class="nb">iter</span><span class="o">&lt;</span><span class="n">nb_iter</span> <span class="ow">and</span> <span class="mi">100</span><span class="o">*</span><span class="nb">abs</span><span class="p">((</span><span class="n">cost</span><span class="o">-</span><span class="n">cost_old</span><span class="p">)</span><span class="o">/</span><span class="n">cost</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">1</span>  <span class="ow">and</span> <span class="mi">100</span><span class="o">*</span><span class="nb">abs</span><span class="p">((</span><span class="n">cur_res</span><span class="o">-</span><span class="n">ref_res</span><span class="p">)</span><span class="o">/</span><span class="n">ref_res</span><span class="p">)</span><span class="o">&gt;</span><span class="mf">0.0001</span><span class="p">:</span>

        <span class="nb">iter</span><span class="o">+=</span><span class="mi">1</span>
        <span class="c1"># Dual variables update</span>
        <span class="c1"># Positivity</span>
        <span class="c1">#temp1 = y1+sig*x</span>
        <span class="k">if</span> <span class="n">pos_en</span><span class="p">:</span>
            <span class="n">temp1</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">y1</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">3</span><span class="p">]):</span>
                <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
                    <span class="n">temp1</span><span class="p">[:,:,</span><span class="n">k</span><span class="p">]</span> <span class="o">+=</span><span class="n">sig</span><span class="o">*</span><span class="n">x</span><span class="p">[</span><span class="n">l</span><span class="p">,</span><span class="n">k</span><span class="p">]</span><span class="o">*</span><span class="n">src_hr</span><span class="p">[:,:,</span><span class="n">l</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
                <span class="n">y1</span> <span class="o">=</span> <span class="n">temp1</span><span class="o">-</span><span class="n">sig</span><span class="o">*</span><span class="n">pos_proj_mat</span><span class="p">(</span><span class="n">temp1</span><span class="o">/</span><span class="n">sig</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">y1</span> <span class="o">=</span> <span class="n">temp1</span><span class="o">-</span><span class="n">sig</span><span class="o">*</span><span class="n">pos_proj_cube</span><span class="p">(</span><span class="n">temp1</span><span class="o">/</span><span class="n">sig</span><span class="p">)</span>

        <span class="c1"># Residual constraint</span>
        <span class="n">temp2</span> <span class="o">=</span> <span class="n">y2</span><span class="o">*</span><span class="mi">0</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">3</span><span class="p">]):</span>
            <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
                <span class="n">temp2</span><span class="p">[:,:,</span><span class="n">k</span><span class="p">]</span> <span class="o">+=</span><span class="n">sig</span><span class="o">*</span><span class="n">x</span><span class="p">[</span><span class="n">l</span><span class="p">,</span><span class="n">k</span><span class="p">]</span><span class="o">*</span><span class="n">src</span><span class="p">[:,:,</span><span class="n">l</span><span class="p">,</span><span class="n">k</span><span class="p">]</span>
        <span class="n">temp2</span><span class="o">+=</span><span class="n">y2</span><span class="o">-</span><span class="n">sig</span><span class="o">*</span><span class="n">im</span>
        <span class="n">y2</span> <span class="o">=</span> <span class="n">temp2</span><span class="o">-</span><span class="n">sig</span><span class="o">*</span><span class="n">proj_sphere_cube</span><span class="p">(</span><span class="n">temp2</span><span class="o">/</span><span class="n">sig</span><span class="p">,</span><span class="n">o</span><span class="p">,</span><span class="n">sqrt</span><span class="p">(</span><span class="n">rad</span><span class="p">))</span> <span class="c1"># Moreau id</span>

        <span class="c1"># Primal variable update</span>
        <span class="n">temp3</span> <span class="o">=</span> <span class="n">x</span><span class="o">*</span><span class="mi">0</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">3</span><span class="p">]):</span>
            <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
                <span class="k">if</span> <span class="n">pos_en</span><span class="p">:</span>
                    <span class="n">temp3</span><span class="p">[</span><span class="n">l</span><span class="p">,</span><span class="n">k</span><span class="p">]</span><span class="o">+=</span><span class="n">to</span><span class="o">*</span><span class="p">((</span><span class="n">src</span><span class="p">[:,:,</span><span class="n">l</span><span class="p">,</span><span class="n">k</span><span class="p">]</span><span class="o">*</span><span class="n">y2</span><span class="p">[:,:,</span><span class="n">k</span><span class="p">])</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">+</span><span class="p">(</span><span class="n">src_hr</span><span class="p">[:,:,</span><span class="n">l</span><span class="p">]</span><span class="o">*</span><span class="n">y1</span><span class="p">[:,:,</span><span class="n">k</span><span class="p">])</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">temp3</span><span class="p">[</span><span class="n">l</span><span class="p">,</span><span class="n">k</span><span class="p">]</span><span class="o">+=</span><span class="n">to</span><span class="o">*</span><span class="p">((</span><span class="n">src</span><span class="p">[:,:,</span><span class="n">l</span><span class="p">,</span><span class="n">k</span><span class="p">]</span><span class="o">*</span><span class="n">y2</span><span class="p">[:,:,</span><span class="n">k</span><span class="p">])</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span>
        <span class="n">temp4</span> <span class="o">=</span> <span class="n">v</span> <span class="o">-</span> <span class="n">temp3</span>
        <span class="n">vold</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">ind</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_src</span><span class="p">):</span>
            <span class="n">mat_temp</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">to</span><span class="o">*</span><span class="n">lambd_init</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="nb">iter</span><span class="o">/</span><span class="p">(</span><span class="n">nb_iter</span><span class="o">-</span><span class="mi">1</span><span class="p">)))</span><span class="o">*</span><span class="n">eye</span><span class="p">(</span><span class="n">shap</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span><span class="o">+</span><span class="n">to</span><span class="o">*</span><span class="n">p_smth_mat_stack</span><span class="p">[:,:,</span><span class="n">ind</span><span class="p">]</span> <span class="c1"># /(iter+1)**2</span>
            <span class="n">p_smth_mat_inv</span><span class="p">[:,:,</span><span class="n">ind</span><span class="p">]</span> <span class="o">=</span> <span class="n">LA</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">mat_temp</span><span class="p">)</span>
        <span class="n">v</span> <span class="o">=</span> <span class="n">smoothing_prox</span><span class="p">(</span><span class="n">p_smth_mat_inv</span><span class="p">,</span><span class="n">temp4</span><span class="o">+</span><span class="p">(</span><span class="n">to</span><span class="o">*</span><span class="n">lambd_init</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="nb">iter</span><span class="o">/</span><span class="p">(</span><span class="n">nb_iter</span><span class="o">-</span><span class="mi">1</span><span class="p">)))</span><span class="o">*</span><span class="n">Ainit</span><span class="p">)</span> <span class="c1">#/(iter+1)**2</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">v</span><span class="o">+</span><span class="n">theta</span><span class="o">*</span><span class="p">(</span><span class="n">v</span><span class="o">-</span><span class="n">vold</span><span class="p">)</span>

        <span class="c1"># Sanity check</span>
        <span class="n">cost_smooth</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">3</span><span class="p">]):</span>
            <span class="n">ind_k</span> <span class="o">=</span> <span class="n">where</span><span class="p">(</span><span class="n">r</span><span class="o">!=</span><span class="n">k</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
                <span class="n">cost_smooth</span><span class="o">+=</span><span class="p">(((</span><span class="n">e</span><span class="o">*</span><span class="n">x</span><span class="p">[:,</span><span class="n">k</span><span class="p">]</span><span class="o">-</span><span class="n">x</span><span class="p">[:,</span><span class="n">ind_k</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">l</span><span class="p">]])</span><span class="o">*</span><span class="n">weights</span><span class="p">[</span><span class="n">k</span><span class="p">,</span><span class="n">l</span><span class="p">,:])</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span><span class="o">**</span><span class="mi">2</span>
        <span class="c1"># Objective value</span>
        <span class="n">temp5</span> <span class="o">=</span> <span class="n">y2</span><span class="o">*</span><span class="mi">0</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">3</span><span class="p">]):</span>
            <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
                <span class="n">temp5</span><span class="p">[:,:,</span><span class="n">k</span><span class="p">]</span> <span class="o">+=</span><span class="n">x</span><span class="p">[</span><span class="n">l</span><span class="p">,</span><span class="n">k</span><span class="p">]</span><span class="o">*</span><span class="n">src</span><span class="p">[:,:,</span><span class="n">l</span><span class="p">,</span><span class="n">k</span><span class="p">]</span>
        <span class="n">temp6</span> <span class="o">=</span> <span class="n">y1</span><span class="o">*</span><span class="mi">0</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">3</span><span class="p">]):</span>
            <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
                <span class="n">temp6</span><span class="p">[:,:,</span><span class="n">k</span><span class="p">]</span> <span class="o">+=</span><span class="n">x</span><span class="p">[</span><span class="n">l</span><span class="p">,</span><span class="n">k</span><span class="p">]</span><span class="o">*</span><span class="n">src_hr</span><span class="p">[:,:,</span><span class="n">l</span><span class="p">]</span>
        <span class="n">max_comp</span> <span class="o">=</span> <span class="p">(</span><span class="n">temp5</span><span class="o">*</span><span class="n">y2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">+</span><span class="p">(</span><span class="n">y1</span><span class="o">*</span><span class="n">temp6</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="n">temp5</span><span class="o">-=</span><span class="n">im</span>
        <span class="n">min_comp</span> <span class="o">=</span> <span class="n">cost_smooth</span>
        <span class="n">cost_old</span> <span class="o">=</span> <span class="n">cost</span>
        <span class="n">cost</span> <span class="o">=</span> <span class="n">min_comp</span><span class="o">+</span><span class="n">max_comp</span>
        <span class="n">cur_res</span> <span class="o">=</span> <span class="p">(</span><span class="n">temp5</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="nb">print</span> <span class="s2">&quot;residual: &quot;</span><span class="p">,</span> <span class="n">cur_res</span> <span class="p">,</span> <span class="s2">&quot; smoothness: &quot;</span><span class="p">,</span><span class="n">cost_smooth</span><span class="p">,</span><span class="s2">&quot; linear part: &quot;</span><span class="p">,</span><span class="n">max_comp</span><span class="p">,</span><span class="s2">&quot; objective val: &quot;</span><span class="p">,</span><span class="n">cost</span><span class="p">,</span><span class="s2">&quot; min val: &quot;</span><span class="p">,</span><span class="n">temp6</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>

    <span class="n">min_val_map</span> <span class="o">=</span> <span class="n">temp6</span><span class="p">[:,:,</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap1</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap1</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
            <span class="n">min_val_map</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">temp6</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,:]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
    <span class="nb">print</span> <span class="s2">&quot;median min val: &quot;</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">min_val_map</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">x</span><span class="p">,</span><span class="n">min_val_map</span>

<span class="k">def</span> <span class="nf">non_unif_smoothing_mult_coeff_pos_cp_4</span><span class="p">(</span><span class="n">im</span><span class="p">,</span><span class="n">src</span><span class="p">,</span><span class="n">src_hr</span><span class="p">,</span><span class="n">tree</span><span class="p">,</span><span class="n">basis</span><span class="p">,</span><span class="n">alpha_init</span><span class="p">,</span><span class="n">theta</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span><span class="n">p_smth_mat_inv</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">to</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">eps</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span><span class="n">nb_iter</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span><span class="n">tol</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span><span class="n">Ainit</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">pos_en</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">reg_param</span><span class="o">=</span><span class="mi">1000</span><span class="p">):</span> <span class="c1"># to is the weight related to the primal variable;  basis is a concatenation of the optimal notch filter operator eigenvectors</span>

    <span class="n">shap</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">shap1</span> <span class="o">=</span> <span class="n">src_hr</span><span class="o">.</span><span class="n">shape</span>
    <span class="nb">print</span> <span class="n">shap1</span>
    <span class="n">src_mat</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
            <span class="n">src_mat</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">src_hr</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">]</span><span class="o">*</span><span class="n">src_hr</span><span class="p">[:,:,</span><span class="n">j</span><span class="p">])</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    <span class="n">src_mat</span> <span class="o">=</span> <span class="n">src_mat</span><span class="o">+</span><span class="n">transpose</span><span class="p">(</span><span class="n">src_mat</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
        <span class="n">src_mat</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">src</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    <span class="n">U</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">Vt</span> <span class="o">=</span> <span class="n">linalg</span><span class="o">.</span><span class="n">svd</span><span class="p">(</span><span class="n">src_mat</span><span class="p">,</span><span class="n">full_matrices</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">U</span><span class="p">,</span> <span class="n">s2</span><span class="p">,</span> <span class="n">Vt</span> <span class="o">=</span> <span class="n">linalg</span><span class="o">.</span><span class="n">svd</span><span class="p">(</span><span class="n">basis</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">transpose</span><span class="p">(</span><span class="n">basis</span><span class="p">)),</span><span class="n">full_matrices</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="n">spec_rad_pos</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">*</span><span class="n">s2</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
    <span class="n">nb_neigh</span> <span class="o">=</span> <span class="n">tree</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">Atemp</span><span class="p">,</span><span class="n">mat</span><span class="p">,</span><span class="n">v</span> <span class="o">=</span> <span class="n">lsq_mult_coeff_stack</span><span class="p">(</span><span class="n">im</span><span class="p">,</span><span class="n">src</span><span class="p">)</span>
    <span class="n">nb_src</span> <span class="o">=</span> <span class="n">Atemp</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">Ainit</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">pos_en</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">nb_src</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
                <span class="n">Ainit</span> <span class="o">=</span> <span class="n">pos_proj</span><span class="p">(</span><span class="n">Atemp</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">nb_src</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">:</span>
                <span class="n">Ainit</span> <span class="o">=</span> <span class="n">pos_proj_mat</span><span class="p">(</span><span class="n">Atemp</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">Ainit</span> <span class="o">=</span> <span class="n">Atemp</span>
    <span class="n">spec_rad</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">3</span><span class="p">]))</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">3</span><span class="p">]):</span>
        <span class="n">U</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">Vt</span> <span class="o">=</span> <span class="n">linalg</span><span class="o">.</span><span class="n">svd</span><span class="p">(</span><span class="n">mat</span><span class="p">[:,:,</span><span class="n">k</span><span class="p">],</span><span class="n">full_matrices</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">spec_rad</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="c1">#*(basis[:,k]**2).sum()</span>
    <span class="n">spec_norm</span><span class="o">=</span><span class="kc">None</span>
    <span class="k">if</span> <span class="n">pos_en</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
        <span class="n">spec_norm</span> <span class="o">=</span> <span class="n">sqrt</span><span class="p">(</span><span class="n">spec_rad</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">*</span><span class="n">s2</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">+</span><span class="n">spec_rad_pos</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">spec_norm</span> <span class="o">=</span> <span class="n">sqrt</span><span class="p">(</span><span class="n">spec_rad</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span>
    <span class="sd">&quot;&quot;&quot;if to is None:</span>
<span class="sd">        a = sum(weights,axis=1)</span>
<span class="sd">        #to = (2*a.max())**(-1)</span>
<span class="sd">        to = 1/spec_norm&quot;&quot;&quot;</span>

    <span class="nb">print</span> <span class="s1">&#39;----smoothing cp spec_rad-----: &#39;</span><span class="p">,</span><span class="n">spec_norm</span>
    <span class="n">lambd_init</span> <span class="o">=</span> <span class="kc">None</span>


    <span class="n">to</span> <span class="o">=</span> <span class="n">eps</span>

    <span class="n">shap_alph</span> <span class="o">=</span> <span class="n">alpha_init</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">thresh</span> <span class="o">=</span> <span class="n">ones</span><span class="p">((</span><span class="n">shap_alph</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">shap_alph</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span><span class="o">*</span><span class="n">to</span>

    <span class="n">sig</span> <span class="o">=</span> <span class="mf">0.8</span><span class="o">/</span><span class="p">(</span><span class="n">to</span><span class="o">*</span><span class="n">spec_norm</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="c1"># Weight related to the dual variables</span>

    <span class="c1"># Dual variables</span>
    <span class="c1">#y1 = copy(Ainit)</span>
    <span class="n">y1</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">shap1</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">shap1</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">shap</span><span class="p">[</span><span class="mi">3</span><span class="p">]))</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">3</span><span class="p">]):</span>
        <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
            <span class="n">y1</span><span class="p">[:,:,</span><span class="n">k</span><span class="p">]</span> <span class="o">+=</span><span class="n">Ainit</span><span class="p">[</span><span class="n">l</span><span class="p">,</span><span class="n">k</span><span class="p">]</span><span class="o">*</span><span class="n">src_hr</span><span class="p">[:,:,</span><span class="n">l</span><span class="p">]</span>
    <span class="n">y2</span> <span class="o">=</span> <span class="n">im</span><span class="o">*</span><span class="mi">0</span>
    <span class="n">o</span> <span class="o">=</span> <span class="n">y2</span><span class="o">*</span><span class="mi">0</span>
    <span class="n">rad</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">3</span><span class="p">],))</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">3</span><span class="p">]):</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">im</span><span class="p">[:,:,</span><span class="n">k</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
            <span class="n">res</span><span class="o">-=</span><span class="n">Ainit</span><span class="p">[</span><span class="n">l</span><span class="p">,</span><span class="n">k</span><span class="p">]</span><span class="o">*</span><span class="n">src</span><span class="p">[:,:,</span><span class="n">l</span><span class="p">,</span><span class="n">k</span><span class="p">]</span>
            <span class="n">y2</span><span class="p">[:,:,</span><span class="n">k</span><span class="p">]</span> <span class="o">+=</span> <span class="n">Ainit</span><span class="p">[</span><span class="n">l</span><span class="p">,</span><span class="n">k</span><span class="p">]</span><span class="o">*</span><span class="n">src</span><span class="p">[:,:,</span><span class="n">l</span><span class="p">,</span><span class="n">k</span><span class="p">]</span>
        <span class="n">rad</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">res</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    <span class="nb">print</span> <span class="s2">&quot;---&gt;&gt; ref res: &lt;&lt;---&quot;</span><span class="p">,</span><span class="n">rad</span><span class="o">.</span><span class="n">sum</span><span class="p">(),</span><span class="s2">&quot; ---&gt;&gt; ref l1 norm: &lt;&lt;---&quot;</span><span class="p">,</span><span class="nb">abs</span><span class="p">(</span><span class="n">alpha_init</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    <span class="n">ref_res</span> <span class="o">=</span> <span class="n">rad</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    <span class="c1"># Primal variable</span>
    <span class="n">v</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">alpha_init</span><span class="p">)</span>

    <span class="c1"># Main variable</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">alpha_init</span><span class="p">)</span>
    <span class="n">cost</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">cur_res</span> <span class="o">=</span><span class="mi">2</span><span class="o">*</span><span class="n">ref_res</span>
    <span class="n">cost_old</span><span class="o">=</span><span class="mi">0</span>
    <span class="nb">iter</span><span class="o">=</span><span class="mi">0</span>
    <span class="n">temp6</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">array</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">3</span><span class="p">]))</span>

    <span class="k">while</span> <span class="nb">iter</span><span class="o">&lt;</span><span class="n">nb_iter</span>  <span class="ow">and</span> <span class="mi">100</span><span class="o">*</span><span class="nb">abs</span><span class="p">((</span><span class="n">cur_res</span><span class="o">-</span><span class="n">ref_res</span><span class="p">)</span><span class="o">/</span><span class="n">ref_res</span><span class="p">)</span><span class="o">&gt;</span><span class="mf">0.0001</span><span class="p">:</span><span class="c1">#  and 100*abs((cost-cost_old)/cost)&gt;1:</span>

        <span class="nb">iter</span><span class="o">+=</span><span class="mi">1</span>
        <span class="c1"># Dual variables update</span>
        <span class="c1"># Positivity</span>
        <span class="c1">#temp1 = y1+sig*x</span>
        <span class="k">if</span> <span class="n">pos_en</span><span class="p">:</span>
            <span class="n">temp1</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">y1</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">3</span><span class="p">]):</span>
                <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
                    <span class="n">temp1</span><span class="p">[:,:,</span><span class="n">k</span><span class="p">]</span> <span class="o">+=</span><span class="n">sig</span><span class="o">*</span><span class="n">x</span><span class="p">[</span><span class="n">l</span><span class="p">,</span><span class="n">k</span><span class="p">]</span><span class="o">*</span><span class="n">src_hr</span><span class="p">[:,:,</span><span class="n">l</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
                <span class="n">y1</span> <span class="o">=</span> <span class="n">temp1</span><span class="o">-</span><span class="n">sig</span><span class="o">*</span><span class="n">pos_proj_mat</span><span class="p">(</span><span class="n">temp1</span><span class="o">/</span><span class="n">sig</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">y1</span> <span class="o">=</span> <span class="n">temp1</span><span class="o">-</span><span class="n">sig</span><span class="o">*</span><span class="n">pos_proj_cube</span><span class="p">(</span><span class="n">temp1</span><span class="o">/</span><span class="n">sig</span><span class="p">)</span>

        <span class="c1"># Residual constraint</span>
        <span class="n">temp2</span> <span class="o">=</span> <span class="n">y2</span><span class="o">*</span><span class="mi">0</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">3</span><span class="p">]):</span>
            <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
                <span class="n">temp2</span><span class="p">[:,:,</span><span class="n">k</span><span class="p">]</span> <span class="o">+=</span><span class="n">sig</span><span class="o">*</span><span class="n">x</span><span class="p">[</span><span class="n">l</span><span class="p">,</span><span class="n">k</span><span class="p">]</span><span class="o">*</span><span class="n">src</span><span class="p">[:,:,</span><span class="n">l</span><span class="p">,</span><span class="n">k</span><span class="p">]</span>
        <span class="n">temp2</span><span class="o">+=</span><span class="n">y2</span><span class="o">-</span><span class="n">sig</span><span class="o">*</span><span class="n">im</span>
        <span class="n">y2</span> <span class="o">=</span> <span class="n">temp2</span><span class="o">-</span><span class="n">sig</span><span class="o">*</span><span class="n">proj_sphere_cube</span><span class="p">(</span><span class="n">temp2</span><span class="o">/</span><span class="n">sig</span><span class="p">,</span><span class="n">o</span><span class="p">,</span><span class="n">sqrt</span><span class="p">(</span><span class="n">rad</span><span class="p">))</span> <span class="c1"># Moreau id</span>

        <span class="c1"># Primal variable update</span>
        <span class="n">temp3</span> <span class="o">=</span> <span class="n">Ainit</span><span class="o">*</span><span class="mi">0</span>
        <span class="n">temp30</span> <span class="o">=</span> <span class="n">Ainit</span><span class="o">*</span><span class="mi">0</span>
        <span class="n">temp31</span> <span class="o">=</span> <span class="n">alpha_init</span><span class="o">*</span><span class="mi">0</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">3</span><span class="p">]):</span>
            <span class="n">temp30</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="mi">1</span><span class="p">))</span>
            <span class="n">bask</span> <span class="o">=</span> <span class="n">basis</span><span class="p">[:,</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">basis</span><span class="p">[:,</span><span class="n">k</span><span class="p">])))</span>
            <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
                <span class="n">temp30</span><span class="p">[</span><span class="n">l</span><span class="p">]</span><span class="o">+=</span><span class="n">to</span><span class="o">*</span><span class="p">(</span><span class="n">src</span><span class="p">[:,:,</span><span class="n">l</span><span class="p">,</span><span class="n">k</span><span class="p">]</span><span class="o">*</span><span class="n">y2</span><span class="p">[:,:,</span><span class="n">k</span><span class="p">])</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">pos_en</span><span class="p">:</span>
                    <span class="n">temp3</span><span class="p">[</span><span class="n">l</span><span class="p">,</span><span class="n">k</span><span class="p">]</span><span class="o">+=</span><span class="n">to</span><span class="o">*</span><span class="p">(</span><span class="n">src_hr</span><span class="p">[:,:,</span><span class="n">l</span><span class="p">]</span><span class="o">*</span><span class="n">y1</span><span class="p">[:,:,</span><span class="n">k</span><span class="p">])</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
            <span class="n">temp31</span><span class="o">+=</span><span class="n">temp30</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">bask</span><span class="p">)</span>

        <span class="n">temp4</span> <span class="o">=</span> <span class="n">v</span> <span class="o">-</span> <span class="n">temp31</span> <span class="o">-</span> <span class="n">temp3</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">transpose</span><span class="p">(</span><span class="n">basis</span><span class="p">))</span>
        <span class="n">vold</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
        <span class="n">v</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">thresholding</span><span class="p">(</span><span class="n">temp4</span><span class="p">,</span><span class="n">thresh</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">v</span><span class="o">+</span><span class="n">theta</span><span class="o">*</span><span class="p">(</span><span class="n">v</span><span class="o">-</span><span class="n">vold</span><span class="p">)</span>

        <span class="c1"># Sanity check</span>
        <span class="n">cost_smooth</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="n">xcheck</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">basis</span><span class="p">)</span>
        <span class="c1"># Objective value</span>
        <span class="n">temp5</span> <span class="o">=</span> <span class="n">y2</span><span class="o">*</span><span class="mi">0</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">3</span><span class="p">]):</span>
            <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
                <span class="n">temp5</span><span class="p">[:,:,</span><span class="n">k</span><span class="p">]</span> <span class="o">+=</span><span class="n">xcheck</span><span class="p">[</span><span class="n">l</span><span class="p">,</span><span class="n">k</span><span class="p">]</span><span class="o">*</span><span class="n">src</span><span class="p">[:,:,</span><span class="n">l</span><span class="p">,</span><span class="n">k</span><span class="p">]</span>
        <span class="n">temp6</span> <span class="o">=</span> <span class="n">y1</span><span class="o">*</span><span class="mi">0</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">3</span><span class="p">]):</span>
            <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
                <span class="n">temp6</span><span class="p">[:,:,</span><span class="n">k</span><span class="p">]</span> <span class="o">+=</span><span class="n">xcheck</span><span class="p">[</span><span class="n">l</span><span class="p">,</span><span class="n">k</span><span class="p">]</span><span class="o">*</span><span class="n">src_hr</span><span class="p">[:,:,</span><span class="n">l</span><span class="p">]</span>
        <span class="n">max_comp</span> <span class="o">=</span> <span class="p">(</span><span class="n">temp5</span><span class="o">*</span><span class="n">y2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">+</span><span class="p">(</span><span class="n">y1</span><span class="o">*</span><span class="n">temp6</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="n">temp5</span><span class="o">-=</span><span class="n">im</span>
        <span class="n">min_comp</span> <span class="o">=</span> <span class="n">cost_smooth</span>
        <span class="n">cost_old</span> <span class="o">=</span> <span class="n">cost</span>
        <span class="n">cost</span> <span class="o">=</span> <span class="n">min_comp</span><span class="o">+</span><span class="n">max_comp</span>
        <span class="n">cur_res</span> <span class="o">=</span> <span class="p">(</span><span class="n">temp5</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="nb">print</span> <span class="s2">&quot;residual: &quot;</span><span class="p">,</span> <span class="n">cur_res</span> <span class="p">,</span> <span class="s2">&quot; l1 norm: &quot;</span><span class="p">,</span><span class="n">cost_smooth</span><span class="p">,</span><span class="s2">&quot; linear part: &quot;</span><span class="p">,</span><span class="n">max_comp</span><span class="p">,</span><span class="s2">&quot; objective val: &quot;</span><span class="p">,</span><span class="n">cost</span><span class="p">,</span><span class="s2">&quot; min val: &quot;</span><span class="p">,</span><span class="n">temp6</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>


    <span class="n">min_val_map</span> <span class="o">=</span> <span class="n">temp6</span><span class="p">[:,:,</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap1</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap1</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
            <span class="n">min_val_map</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">temp6</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,:]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
    <span class="nb">print</span> <span class="s2">&quot;median min val: &quot;</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">min_val_map</span><span class="p">)</span>
    <span class="n">mat_out</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">basis</span><span class="p">)</span>


    <span class="k">return</span> <span class="n">mat_out</span><span class="p">,</span><span class="n">x</span><span class="p">,</span><span class="n">min_val_map</span>



<span class="k">def</span> <span class="nf">non_unif_smoothing_mult_coeff_pos_cp_5</span><span class="p">(</span><span class="n">im</span><span class="p">,</span><span class="n">src</span><span class="p">,</span><span class="n">src_hr</span><span class="p">,</span><span class="n">tree</span><span class="p">,</span><span class="n">basis</span><span class="p">,</span><span class="n">alpha_init</span><span class="p">,</span><span class="n">theta</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span><span class="n">p_smth_mat_inv</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">to</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">eps</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span><span class="n">nb_iter</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span><span class="n">tol</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span><span class="n">Ainit</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">pos_en</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">reg_param</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span><span class="n">spars_en</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span> <span class="c1"># to is the weight related to the primal variable;  basis is a concatenation of the optimal notch filter operator eigenvectors</span>

    <span class="n">shap</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">shap1</span> <span class="o">=</span> <span class="n">src_hr</span><span class="o">.</span><span class="n">shape</span>

    <span class="n">src_mat</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
            <span class="n">src_mat</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">src_hr</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">]</span><span class="o">*</span><span class="n">src_hr</span><span class="p">[:,:,</span><span class="n">j</span><span class="p">])</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    <span class="n">src_mat</span> <span class="o">=</span> <span class="n">src_mat</span><span class="o">+</span><span class="n">transpose</span><span class="p">(</span><span class="n">src_mat</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
        <span class="n">src_mat</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">src</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    <span class="n">U</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">Vt</span> <span class="o">=</span> <span class="n">linalg</span><span class="o">.</span><span class="n">svd</span><span class="p">(</span><span class="n">src_mat</span><span class="p">,</span><span class="n">full_matrices</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">U</span><span class="p">,</span> <span class="n">s2</span><span class="p">,</span> <span class="n">Vt</span> <span class="o">=</span> <span class="n">linalg</span><span class="o">.</span><span class="n">svd</span><span class="p">(</span><span class="n">basis</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">transpose</span><span class="p">(</span><span class="n">basis</span><span class="p">)),</span><span class="n">full_matrices</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="n">spec_rad_pos</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">*</span><span class="n">s2</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
    <span class="n">nb_neigh</span> <span class="o">=</span> <span class="n">tree</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">Atemp</span><span class="p">,</span><span class="n">mat</span><span class="p">,</span><span class="n">v</span> <span class="o">=</span> <span class="n">lsq_mult_coeff_stack</span><span class="p">(</span><span class="n">im</span><span class="p">,</span><span class="n">src</span><span class="p">)</span>
    <span class="n">spec_rad</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">3</span><span class="p">]))</span>

    <span class="n">rad</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">3</span><span class="p">],))</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">3</span><span class="p">]):</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">im</span><span class="p">[:,:,</span><span class="n">k</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
            <span class="n">res</span><span class="o">-=</span><span class="n">Ainit</span><span class="p">[</span><span class="n">l</span><span class="p">,</span><span class="n">k</span><span class="p">]</span><span class="o">*</span><span class="n">src</span><span class="p">[:,:,</span><span class="n">l</span><span class="p">,</span><span class="n">k</span><span class="p">]</span>
        <span class="n">rad</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">res</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    <span class="nb">print</span> <span class="s2">&quot;---&gt;&gt; ref res: &lt;&lt;---&quot;</span><span class="p">,</span><span class="n">rad</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>

    <span class="n">ref_res</span> <span class="o">=</span> <span class="n">rad</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    <span class="n">cost</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">cost_old</span><span class="o">=</span><span class="mi">0</span>


    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">3</span><span class="p">]):</span>
        <span class="n">U</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">Vt</span> <span class="o">=</span> <span class="n">linalg</span><span class="o">.</span><span class="n">svd</span><span class="p">(</span><span class="n">mat</span><span class="p">[:,:,</span><span class="n">k</span><span class="p">],</span><span class="n">full_matrices</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">spec_rad</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="c1">#*(basis[:,k]**2).sum()</span>
    <span class="n">spec_norm</span><span class="o">=</span><span class="n">spec_rad</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">*</span><span class="n">s2</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
    <span class="n">shapb</span> <span class="o">=</span> <span class="n">basis</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">alpha</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">alpha_init</span><span class="p">)</span><span class="o">*</span><span class="mi">0</span>
    <span class="n">i</span><span class="o">=</span><span class="mi">0</span>

    <span class="n">t</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">alphax</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">alpha</span><span class="p">)</span>
    <span class="n">shap_alpha</span> <span class="o">=</span> <span class="n">alpha</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">supports</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">shap_alpha</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">shap_alpha</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="nb">min</span><span class="p">(</span><span class="n">nb_iter</span><span class="p">,</span><span class="n">shapb</span><span class="p">[</span><span class="mi">0</span><span class="p">])))</span>
    <span class="k">while</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="nb">min</span><span class="p">(</span><span class="n">nb_iter</span><span class="p">,</span><span class="n">shapb</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="ow">and</span> <span class="mi">100</span><span class="o">*</span><span class="nb">abs</span><span class="p">((</span><span class="n">cost</span><span class="o">-</span><span class="n">cost_old</span><span class="p">)</span><span class="o">/</span><span class="n">cost</span><span class="p">)</span><span class="o">&gt;</span><span class="mf">0.01</span><span class="p">)</span> <span class="ow">or</span> <span class="n">cost</span><span class="o">&gt;</span><span class="mf">1.1</span><span class="o">*</span><span class="n">ref_res</span> <span class="p">:</span>
        <span class="n">A</span> <span class="o">=</span> <span class="n">alpha</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">basis</span><span class="p">)</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">im</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">3</span><span class="p">]):</span>
            <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
                <span class="n">res</span><span class="p">[:,:,</span><span class="n">k</span><span class="p">]</span><span class="o">-=</span><span class="n">A</span><span class="p">[</span><span class="n">l</span><span class="p">,</span><span class="n">k</span><span class="p">]</span><span class="o">*</span><span class="n">src</span><span class="p">[:,:,</span><span class="n">l</span><span class="p">,</span><span class="n">k</span><span class="p">]</span>
        <span class="nb">print</span> <span class="s2">&quot; -------- mse: &quot;</span><span class="p">,</span><span class="nb">sum</span><span class="p">(</span><span class="n">res</span><span class="o">**</span><span class="mi">2</span><span class="p">),</span><span class="s2">&quot;-----------&quot;</span>
        <span class="n">cost_old</span> <span class="o">=</span> <span class="n">cost</span>
        <span class="n">cost</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">res</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">temp</span> <span class="o">=</span> <span class="n">Ainit</span><span class="o">*</span><span class="mi">0</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">3</span><span class="p">]):</span>
            <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
                <span class="n">temp</span><span class="p">[</span><span class="n">l</span><span class="p">,</span><span class="n">k</span><span class="p">]</span><span class="o">+=</span><span class="p">(</span><span class="n">src</span><span class="p">[:,:,</span><span class="n">l</span><span class="p">,</span><span class="n">k</span><span class="p">]</span><span class="o">*</span><span class="n">res</span><span class="p">[:,:,</span><span class="n">k</span><span class="p">])</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="n">grad</span> <span class="o">=</span> <span class="o">-</span><span class="n">temp</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">transpose</span><span class="p">(</span><span class="n">basis</span><span class="p">))</span>
        <span class="n">alphay</span> <span class="o">=</span> <span class="n">alpha</span> <span class="o">-</span> <span class="n">grad</span><span class="o">/</span><span class="n">spec_norm</span>
        <span class="n">alphax_old</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">alphax</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">spars_en</span><span class="p">:</span>
            <span class="n">alphax</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">lineskthresholding</span><span class="p">(</span><span class="n">alphay</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">int</span><span class="p">(</span><span class="n">floor</span><span class="p">(</span><span class="n">sqrt</span><span class="p">(</span><span class="n">i</span><span class="p">)))</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">supports</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">alphax</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">alphax</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">alphay</span><span class="p">)</span>
        <span class="n">told</span> <span class="o">=</span> <span class="n">t</span>
        <span class="n">t</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">4</span><span class="o">*</span><span class="n">t</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span><span class="mi">1</span><span class="p">))</span><span class="o">/</span><span class="mi">2</span>
        <span class="n">lambd</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">+</span> <span class="p">(</span><span class="n">told</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="n">t</span>
        <span class="n">alpha</span>  <span class="o">=</span> <span class="n">alphax_old</span> <span class="o">+</span> <span class="n">lambd</span><span class="o">*</span><span class="p">(</span><span class="n">alphax</span><span class="o">-</span><span class="n">alphax_old</span><span class="p">)</span>
        <span class="n">supp</span> <span class="o">=</span> <span class="n">where</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">alpha</span><span class="p">[</span><span class="mi">0</span><span class="p">,:])</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">)</span>
        <span class="c1">#print &quot;-------- Support: &quot;,supp,&quot; ----------&quot;</span>
        <span class="n">i</span><span class="o">+=</span><span class="mi">1</span>
    <span class="n">mat_out</span> <span class="o">=</span> <span class="n">alpha</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">basis</span><span class="p">)</span>



    <span class="k">return</span> <span class="n">mat_out</span><span class="p">,</span><span class="n">alpha</span><span class="p">,</span><span class="n">supports</span>

<span class="k">def</span> <span class="nf">non_unif_smoothing_mult_coeff_pos_cp_6</span><span class="p">(</span><span class="n">im</span><span class="p">,</span><span class="n">src</span><span class="p">,</span><span class="n">nb_iter</span><span class="o">=</span><span class="mi">100</span><span class="p">):</span> <span class="c1"># to is the weight related to the primal variable;  basis is a concatenation of the optimal notch filter operator eigenvectors</span>


    <span class="n">Ainit</span><span class="p">,</span><span class="n">mat</span><span class="p">,</span><span class="n">v</span> <span class="o">=</span> <span class="n">lsq_mult_coeff_stack</span><span class="p">(</span><span class="n">im</span><span class="p">,</span><span class="n">src</span><span class="p">)</span>

    <span class="n">shap</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">spec_rad</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">3</span><span class="p">]))</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">3</span><span class="p">]):</span>
        <span class="n">U</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">Vt</span> <span class="o">=</span> <span class="n">linalg</span><span class="o">.</span><span class="n">svd</span><span class="p">(</span><span class="n">mat</span><span class="p">[:,:,</span><span class="n">k</span><span class="p">],</span><span class="n">full_matrices</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">spec_rad</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="c1">#*(basis[:,k]**2).sum()</span>
    <span class="n">spec_norm</span><span class="o">=</span><span class="n">spec_rad</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>

    <span class="n">A</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">Ainit</span><span class="p">)</span>

    <span class="n">t</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">Ax</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">A</span><span class="p">)</span>
    <span class="n">rad</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">3</span><span class="p">],))</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">3</span><span class="p">]):</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">im</span><span class="p">[:,:,</span><span class="n">k</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
            <span class="n">res</span><span class="o">-=</span><span class="n">Ainit</span><span class="p">[</span><span class="n">l</span><span class="p">,</span><span class="n">k</span><span class="p">]</span><span class="o">*</span><span class="n">src</span><span class="p">[:,:,</span><span class="n">l</span><span class="p">,</span><span class="n">k</span><span class="p">]</span>
        <span class="n">rad</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">res</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    <span class="nb">print</span> <span class="s2">&quot;---&gt;&gt; ref res: &lt;&lt;---&quot;</span><span class="p">,</span><span class="n">rad</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>

    <span class="n">ref_res</span> <span class="o">=</span> <span class="n">rad</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    <span class="n">cost</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">cost_old</span><span class="o">=</span><span class="mi">0</span>
    <span class="n">i</span><span class="o">=</span><span class="mi">0</span>
    <span class="k">while</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="n">nb_iter</span> <span class="ow">and</span> <span class="mi">100</span><span class="o">*</span><span class="nb">abs</span><span class="p">((</span><span class="n">cost</span><span class="o">-</span><span class="n">cost_old</span><span class="p">)</span><span class="o">/</span><span class="n">cost</span><span class="p">)</span><span class="o">&gt;</span><span class="mf">0.01</span><span class="p">)</span> <span class="ow">or</span> <span class="n">cost</span><span class="o">&gt;</span><span class="mf">1.1</span><span class="o">*</span><span class="n">ref_res</span> <span class="p">:</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">im</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">3</span><span class="p">]):</span>
            <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
                <span class="n">res</span><span class="p">[:,:,</span><span class="n">k</span><span class="p">]</span><span class="o">-=</span><span class="n">A</span><span class="p">[</span><span class="n">l</span><span class="p">,</span><span class="n">k</span><span class="p">]</span><span class="o">*</span><span class="n">src</span><span class="p">[:,:,</span><span class="n">l</span><span class="p">,</span><span class="n">k</span><span class="p">]</span>
        <span class="nb">print</span> <span class="s2">&quot; -------- mse: &quot;</span><span class="p">,</span><span class="nb">sum</span><span class="p">(</span><span class="n">res</span><span class="o">**</span><span class="mi">2</span><span class="p">),</span><span class="s2">&quot;-----------&quot;</span>
        <span class="n">cost_old</span> <span class="o">=</span> <span class="n">cost</span>
        <span class="n">cost</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">res</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">temp</span> <span class="o">=</span> <span class="n">Ainit</span><span class="o">*</span><span class="mi">0</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">3</span><span class="p">]):</span>
            <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
                <span class="n">temp</span><span class="p">[</span><span class="n">l</span><span class="p">,</span><span class="n">k</span><span class="p">]</span><span class="o">+=</span><span class="p">(</span><span class="n">src</span><span class="p">[:,:,</span><span class="n">l</span><span class="p">,</span><span class="n">k</span><span class="p">]</span><span class="o">*</span><span class="n">res</span><span class="p">[:,:,</span><span class="n">k</span><span class="p">])</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="n">grad</span> <span class="o">=</span> <span class="o">-</span><span class="n">temp</span>
        <span class="n">Ay</span> <span class="o">=</span> <span class="n">A</span> <span class="o">-</span> <span class="n">grad</span><span class="o">/</span><span class="n">spec_norm</span>
        <span class="n">Ax_old</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">Ax</span><span class="p">)</span>
        <span class="n">Ax</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">Ay</span><span class="p">)</span>
        <span class="n">told</span> <span class="o">=</span> <span class="n">t</span>
        <span class="n">t</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">4</span><span class="o">*</span><span class="n">t</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span><span class="mi">1</span><span class="p">))</span><span class="o">/</span><span class="mi">2</span>
        <span class="n">lambd</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">+</span> <span class="p">(</span><span class="n">told</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="n">t</span>
        <span class="n">A</span>  <span class="o">=</span> <span class="n">Ax_old</span> <span class="o">+</span> <span class="n">lambd</span><span class="o">*</span><span class="p">(</span><span class="n">Ax</span><span class="o">-</span><span class="n">Ax_old</span><span class="p">)</span>

        <span class="n">i</span><span class="o">+=</span><span class="mi">1</span>


    <span class="k">return</span> <span class="n">A</span>

<span class="k">def</span> <span class="nf">non_unif_smoothing_mult_coeff_pos_cp_5_dirty</span><span class="p">(</span><span class="n">im</span><span class="p">,</span><span class="n">src</span><span class="p">,</span><span class="n">src_hr</span><span class="p">,</span><span class="n">tree</span><span class="p">,</span><span class="n">basis</span><span class="p">,</span><span class="n">alpha_init</span><span class="p">,</span><span class="n">theta</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span><span class="n">p_smth_mat_inv</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">to</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">eps</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span><span class="n">nb_iter</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span><span class="n">tol</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span><span class="n">Ainit</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">pos_en</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">reg_param</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span><span class="n">spars_en</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">spars_perc</span><span class="o">=</span><span class="mf">0.1</span><span class="p">):</span>

    <span class="n">Atemp</span><span class="p">,</span><span class="n">mat</span><span class="p">,</span><span class="n">v</span> <span class="o">=</span> <span class="n">lsq_mult_coeff_stack</span><span class="p">(</span><span class="n">im</span><span class="p">,</span><span class="n">src</span><span class="p">)</span>

    <span class="n">alpha</span> <span class="o">=</span> <span class="n">alpha_init</span><span class="o">*</span><span class="mi">0</span>

    <span class="n">shap</span> <span class="o">=</span> <span class="n">basis</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">supp_size</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">int</span><span class="p">(</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">spars_perc</span><span class="p">)</span>

    <span class="n">res</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">Atemp</span><span class="p">)</span>
    <span class="n">Aout</span> <span class="o">=</span> <span class="n">Atemp</span><span class="o">*</span><span class="mi">0</span>
    <span class="n">basis_stack</span> <span class="o">=</span> <span class="n">ones</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">Atemp</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">Atemp</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
        <span class="n">basis_stack</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">basis</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">supp_size</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">Atemp</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
            <span class="n">res_vec</span> <span class="o">=</span> <span class="n">reshape</span><span class="p">(</span><span class="n">copy</span><span class="p">(</span><span class="n">res</span><span class="p">[</span><span class="n">j</span><span class="p">,:]),[</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">proj</span> <span class="o">=</span> <span class="n">basis_stack</span><span class="p">[:,:,</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">res_vec</span><span class="p">)</span>
            <span class="n">coeff</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">proj</span><span class="p">)</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
            <span class="n">ind</span> <span class="o">=</span> <span class="n">where</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">proj</span><span class="p">)</span><span class="o">==</span><span class="n">coeff</span><span class="p">)</span>
            <span class="nb">id</span> <span class="o">=</span> <span class="n">ind</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nb">id</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">:</span>
                <span class="nb">id</span> <span class="o">=</span> <span class="nb">id</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">alpha</span><span class="p">[</span><span class="n">j</span><span class="p">,</span><span class="nb">id</span><span class="p">]</span> <span class="o">=</span> <span class="n">proj</span><span class="p">[</span><span class="nb">id</span><span class="p">]</span>
            <span class="n">Aout</span><span class="p">[</span><span class="n">j</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">Aout</span><span class="p">[</span><span class="n">j</span><span class="p">,:]</span><span class="o">+</span><span class="n">proj</span><span class="p">[</span><span class="nb">id</span><span class="p">]</span><span class="o">*</span><span class="n">reshape</span><span class="p">(</span><span class="n">basis_stack</span><span class="p">[</span><span class="nb">id</span><span class="p">,:,</span><span class="n">j</span><span class="p">],[</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">],])</span>
            <span class="n">vect_select</span> <span class="o">=</span> <span class="n">reshape</span><span class="p">(</span><span class="n">copy</span><span class="p">(</span><span class="n">basis_stack</span><span class="p">[</span><span class="nb">id</span><span class="p">,:,</span><span class="n">j</span><span class="p">]),[</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="mi">1</span><span class="p">])</span>

            <span class="n">res</span><span class="p">[</span><span class="n">j</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">res</span><span class="p">[</span><span class="n">j</span><span class="p">,:]</span> <span class="o">-</span> <span class="n">proj</span><span class="p">[</span><span class="nb">id</span><span class="p">]</span><span class="o">*</span><span class="n">reshape</span><span class="p">(</span><span class="n">basis_stack</span><span class="p">[</span><span class="nb">id</span><span class="p">,:,</span><span class="n">j</span><span class="p">],[</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">],])</span>
            <span class="n">basis_stack</span><span class="p">[:,:,</span><span class="n">j</span><span class="p">]</span><span class="o">-=</span> <span class="n">basis_stack</span><span class="p">[:,:,</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">vect_select</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">transpose</span><span class="p">(</span><span class="n">vect_select</span><span class="p">)))</span>
            <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
                <span class="n">n</span> <span class="o">=</span> <span class="n">sqrt</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="n">basis_stack</span><span class="p">[</span><span class="n">f</span><span class="p">,:,</span><span class="n">j</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">n</span><span class="o">&gt;</span><span class="mi">10</span><span class="o">**-</span><span class="mi">31</span><span class="p">:</span>
                    <span class="n">basis_stack</span><span class="p">[</span><span class="n">f</span><span class="p">,:,</span><span class="n">j</span><span class="p">]</span><span class="o">/=</span><span class="n">n</span>
            <span class="nb">print</span> <span class="n">basis</span><span class="o">.</span><span class="n">shape</span>
        <span class="nb">print</span> <span class="s2">&quot;residual: &quot;</span><span class="p">,</span><span class="nb">sum</span><span class="p">(</span><span class="n">res</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>

    <span class="n">mat_out</span> <span class="o">=</span> <span class="n">alpha</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">basis</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">mat_out</span><span class="p">,</span><span class="n">alpha</span>


<span class="k">def</span> <span class="nf">non_unif_interp_mult_coeff_BT</span><span class="p">(</span><span class="n">Aref</span><span class="p">,</span><span class="n">comp_ref</span><span class="p">,</span><span class="n">posi_ref</span><span class="p">,</span><span class="n">posi_target</span><span class="p">,</span><span class="n">e</span><span class="p">,</span><span class="n">p</span><span class="p">,</span><span class="n">tol</span><span class="o">=</span><span class="mi">10</span><span class="o">**-</span><span class="mi">5</span><span class="p">,</span><span class="n">nb_iter</span><span class="o">=</span><span class="mi">200</span><span class="p">):</span> <span class="c1"># e,p: notch filters paramters</span>

    <span class="n">shapA</span> <span class="o">=</span> <span class="n">Aref</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">nb_ref</span> <span class="o">=</span> <span class="n">shapA</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">posi_in</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">nb_ref</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span>
    <span class="n">posi_in</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">nb_ref</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">posi_ref</span>
    <span class="n">posi_in</span><span class="p">[</span><span class="n">nb_ref</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">posi_target</span>
    <span class="n">dists_unsorted</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">feat_dist_mat</span><span class="p">(</span><span class="n">posi_in</span><span class="p">)</span>
    <span class="n">dist_med</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">dists_unsorted</span><span class="p">)</span>
    <span class="n">dist_weights_in</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">nb_ref</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">nb_ref</span><span class="p">,</span><span class="n">shapA</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
    <span class="k">for</span> <span class="n">ind</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shapA</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
        <span class="n">dist_weights_in</span><span class="p">[:,:,</span><span class="n">ind</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">dist_med</span><span class="o">/</span><span class="n">dists_unsorted</span><span class="p">)</span><span class="o">**</span><span class="n">p</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span>
        <span class="n">dist_weights_in</span><span class="p">[:,:,</span><span class="n">ind</span><span class="p">]</span> <span class="o">=</span> <span class="n">dist_weights_in</span><span class="p">[:,:,</span><span class="n">ind</span><span class="p">]</span><span class="o">/</span><span class="n">sqrt</span><span class="p">((</span><span class="n">dist_weights_in</span><span class="p">[:,:,</span><span class="n">ind</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span>

    <span class="n">basis</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">(((</span><span class="n">nb_ref</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">shapA</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">nb_ref</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shapA</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
        <span class="n">mati</span> <span class="o">=</span> <span class="n">non_uniform_smoothing_mat_2</span><span class="p">(</span><span class="n">dist_weights_in</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">],</span><span class="n">e</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        <span class="n">U</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">Vt</span> <span class="o">=</span> <span class="n">linalg</span><span class="o">.</span><span class="n">svd</span><span class="p">(</span><span class="n">mati</span><span class="p">,</span><span class="n">full_matrices</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">basis</span><span class="p">[</span><span class="n">i</span><span class="o">*</span><span class="p">(</span><span class="n">nb_ref</span><span class="o">+</span><span class="mi">1</span><span class="p">):(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">nb_ref</span><span class="o">+</span><span class="mi">1</span><span class="p">),:]</span> <span class="o">=</span> <span class="n">Vt</span>

    <span class="n">M</span> <span class="o">=</span> <span class="n">transpose</span><span class="p">(</span><span class="n">basis</span><span class="p">[:,:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">basis</span><span class="p">[:,:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">U</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">Vt</span> <span class="o">=</span> <span class="n">linalg</span><span class="o">.</span><span class="n">svd</span><span class="p">(</span><span class="n">M</span><span class="p">,</span><span class="n">full_matrices</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">spec_norm</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
    <span class="n">cost</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">cost_old</span><span class="o">=</span><span class="mi">0</span>

    <span class="n">i</span><span class="o">=</span><span class="mi">0</span>
    <span class="n">alpha</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">shapA</span><span class="p">[</span><span class="mi">0</span><span class="p">],(</span><span class="n">nb_ref</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">shapA</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
    <span class="n">t</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">alphax</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">alpha</span><span class="p">)</span>
    <span class="k">while</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="n">nb_iter</span> <span class="ow">and</span> <span class="mi">100</span><span class="o">*</span><span class="nb">abs</span><span class="p">((</span><span class="n">cost</span><span class="o">-</span><span class="n">cost_old</span><span class="p">)</span><span class="o">/</span><span class="n">cost</span><span class="p">)</span><span class="o">&gt;</span><span class="mf">0.01</span><span class="p">)</span> <span class="ow">or</span> <span class="n">cost</span><span class="o">&gt;</span><span class="n">tol</span> <span class="p">:</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">Aref</span><span class="o">-</span><span class="n">alpha</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">basis</span><span class="p">[:,:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">cost_old</span> <span class="o">=</span> <span class="n">cost</span>
        <span class="n">cost</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">res</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
        <span class="nb">print</span> <span class="s2">&quot;--------- mse: &quot;</span><span class="p">,</span><span class="n">cost</span><span class="p">,</span><span class="s2">&quot; -------------&quot;</span>
        <span class="n">grad</span> <span class="o">=</span> <span class="o">-</span><span class="n">res</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">transpose</span><span class="p">(</span><span class="n">basis</span><span class="p">[:,:</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>
        <span class="n">alphay</span> <span class="o">=</span> <span class="n">alpha</span> <span class="o">-</span> <span class="n">grad</span><span class="o">/</span><span class="n">spec_norm</span>
        <span class="n">alphax_old</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">alphax</span><span class="p">)</span>
        <span class="n">alphax</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">lineskthresholding</span><span class="p">(</span><span class="n">alphay</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">int</span><span class="p">(</span><span class="n">floor</span><span class="p">(</span><span class="n">sqrt</span><span class="p">(</span><span class="n">i</span><span class="p">)))</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">told</span> <span class="o">=</span> <span class="n">t</span>
        <span class="n">t</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">4</span><span class="o">*</span><span class="n">t</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span><span class="mi">1</span><span class="p">))</span><span class="o">/</span><span class="mi">2</span>
        <span class="n">lambd</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">+</span> <span class="p">(</span><span class="n">told</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="n">t</span>
        <span class="n">alpha</span>  <span class="o">=</span> <span class="n">alphax_old</span> <span class="o">+</span> <span class="n">lambd</span><span class="o">*</span><span class="p">(</span><span class="n">alphax</span><span class="o">-</span><span class="n">alphax_old</span><span class="p">)</span>
        <span class="n">i</span><span class="o">+=</span><span class="mi">1</span>

    <span class="n">Aout</span> <span class="o">=</span> <span class="n">alpha</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">basis</span><span class="p">)</span>
    <span class="n">im_interp</span> <span class="o">=</span> <span class="mi">0</span><span class="o">*</span><span class="n">comp_ref</span><span class="p">[:,:,</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shapA</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
        <span class="n">im_interp</span><span class="o">+=</span><span class="n">comp_ref</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">]</span><span class="o">*</span><span class="n">Aout</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">im_interp</span>

<span class="k">def</span> <span class="nf">non_unif_interp_mult_coeff_pos_cp</span><span class="p">(</span><span class="n">Aref</span><span class="p">,</span><span class="n">comp_ref</span><span class="p">,</span><span class="n">posi_ref</span><span class="p">,</span><span class="n">posi_target</span><span class="p">,</span><span class="n">e</span><span class="p">,</span><span class="n">p</span><span class="p">,</span><span class="n">tol</span><span class="o">=</span><span class="mi">10</span><span class="o">**-</span><span class="mi">5</span><span class="p">,</span><span class="n">eps</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span><span class="n">theta</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span><span class="n">nb_iter</span><span class="o">=</span><span class="mi">200</span><span class="p">):</span> <span class="c1"># e,p: notch filters paramters</span>
    <span class="n">shapA</span> <span class="o">=</span> <span class="n">Aref</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">nb_ref</span> <span class="o">=</span> <span class="n">shapA</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">posi_in</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">nb_ref</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span>
    <span class="n">posi_in</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">nb_ref</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">posi_ref</span>
    <span class="n">posi_in</span><span class="p">[</span><span class="n">nb_ref</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">posi_target</span>
    <span class="n">dists_unsorted</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">feat_dist_mat</span><span class="p">(</span><span class="n">posi_in</span><span class="p">)</span>
    <span class="n">dist_med</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">dists_unsorted</span><span class="p">)</span>
    <span class="n">dist_weights_in</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">nb_ref</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">nb_ref</span><span class="p">,</span><span class="n">shapA</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
    <span class="k">for</span> <span class="n">ind</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shapA</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
        <span class="n">dist_weights_in</span><span class="p">[:,:,</span><span class="n">ind</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">dist_med</span><span class="o">/</span><span class="n">dists_unsorted</span><span class="p">)</span><span class="o">**</span><span class="n">p</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span>
        <span class="n">dist_weights_in</span><span class="p">[:,:,</span><span class="n">ind</span><span class="p">]</span> <span class="o">=</span> <span class="n">dist_weights_in</span><span class="p">[:,:,</span><span class="n">ind</span><span class="p">]</span><span class="o">/</span><span class="n">sqrt</span><span class="p">((</span><span class="n">dist_weights_in</span><span class="p">[:,:,</span><span class="n">ind</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span>

    <span class="n">basis</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">(((</span><span class="n">nb_ref</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">shapA</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">nb_ref</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shapA</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
        <span class="n">mati</span> <span class="o">=</span> <span class="n">non_uniform_smoothing_mat_2</span><span class="p">(</span><span class="n">dist_weights_in</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">],</span><span class="n">e</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        <span class="n">U</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">Vt</span> <span class="o">=</span> <span class="n">linalg</span><span class="o">.</span><span class="n">svd</span><span class="p">(</span><span class="n">mati</span><span class="p">,</span><span class="n">full_matrices</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">basis</span><span class="p">[</span><span class="n">i</span><span class="o">*</span><span class="p">(</span><span class="n">nb_ref</span><span class="o">+</span><span class="mi">1</span><span class="p">):(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">nb_ref</span><span class="o">+</span><span class="mi">1</span><span class="p">),:]</span> <span class="o">=</span> <span class="n">Vt</span>

    <span class="n">M</span> <span class="o">=</span> <span class="n">transpose</span><span class="p">(</span><span class="n">basis</span><span class="p">[:,:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">basis</span><span class="p">[:,:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">U</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">Vt</span> <span class="o">=</span> <span class="n">linalg</span><span class="o">.</span><span class="n">svd</span><span class="p">(</span><span class="n">M</span><span class="p">,</span><span class="n">full_matrices</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">spec_norm_fid</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
    <span class="n">lsq_mat</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">shapA</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">shapA</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shapA</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shapA</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
            <span class="n">lsq_mat</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">comp_ref</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">]</span><span class="o">*</span><span class="n">comp_ref</span><span class="p">[:,:,</span><span class="n">j</span><span class="p">])</span>
    <span class="n">U</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">Vt</span> <span class="o">=</span> <span class="n">linalg</span><span class="o">.</span><span class="n">svd</span><span class="p">(</span><span class="n">lsq_mat</span><span class="p">,</span><span class="n">full_matrices</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">spec_norm_pos</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">*</span><span class="nb">sum</span><span class="p">(</span><span class="n">basis</span><span class="p">[:,</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>

    <span class="n">spec_norm</span> <span class="o">=</span> <span class="n">sqrt</span><span class="p">(</span><span class="n">spec_norm_fid</span><span class="o">+</span><span class="n">spec_norm_pos</span><span class="p">)</span>
    <span class="n">sig</span> <span class="o">=</span> <span class="n">eps</span><span class="o">/</span><span class="n">spec_norm</span>
    <span class="n">to</span> <span class="o">=</span> <span class="n">eps</span><span class="o">/</span><span class="p">(</span><span class="n">sig</span><span class="o">*</span><span class="n">spec_norm</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">cost</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">cost_old</span><span class="o">=</span><span class="mi">0</span>

    <span class="n">i</span><span class="o">=</span><span class="mi">0</span>

    <span class="c1"># Dual variables</span>
    <span class="n">Y1</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">Aref</span><span class="p">)</span><span class="o">*</span><span class="mi">0</span>
    <span class="n">Y2</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">comp_ref</span><span class="p">[:,:,</span><span class="mi">0</span><span class="p">])</span><span class="o">*</span><span class="mi">0</span>

    <span class="c1"># Primal variable</span>
    <span class="n">X</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">shapA</span><span class="p">[</span><span class="mi">0</span><span class="p">],(</span><span class="n">nb_ref</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">shapA</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>

    <span class="c1"># Main variable</span>
    <span class="n">alpha</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">shapA</span><span class="p">[</span><span class="mi">0</span><span class="p">],(</span><span class="n">nb_ref</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">shapA</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
    <span class="n">res</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">Aref</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
    <span class="k">while</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="n">nb_iter</span> <span class="ow">and</span> <span class="mi">100</span><span class="o">*</span><span class="nb">abs</span><span class="p">((</span><span class="n">cost</span><span class="o">-</span><span class="n">cost_old</span><span class="p">)</span><span class="o">/</span><span class="n">cost</span><span class="p">)</span><span class="o">&gt;</span><span class="mf">0.01</span><span class="p">)</span> <span class="ow">or</span> <span class="n">res</span><span class="o">&gt;</span><span class="n">tol</span> <span class="p">:</span>

        <span class="c1"># Dual variable update</span>

        <span class="c1"># Data attachement</span>
        <span class="n">temp1</span> <span class="o">=</span> <span class="n">Y1</span><span class="o">+</span><span class="n">sig</span><span class="o">*</span><span class="n">alpha</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">basis</span><span class="p">[:,:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">Y1</span> <span class="o">=</span> <span class="p">(</span><span class="n">temp1</span><span class="o">-</span><span class="n">sig</span><span class="o">*</span><span class="n">Aref</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">sig</span><span class="p">)</span>

        <span class="c1"># Positivity</span>
        <span class="n">coeff_temp</span> <span class="o">=</span> <span class="n">sig</span><span class="o">*</span><span class="n">alpha</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">basis</span><span class="p">[:,</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(((</span><span class="n">nb_ref</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">shapA</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="mi">1</span><span class="p">)))</span>
        <span class="n">temp2</span> <span class="o">=</span> <span class="n">comp_ref</span><span class="p">[:,:,</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="mi">0</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shapA</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
            <span class="n">temp2</span><span class="o">+=</span><span class="n">coeff_temp</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">*</span><span class="n">comp_ref</span><span class="p">[:,:,</span><span class="n">j</span><span class="p">]</span>

        <span class="n">Y2</span> <span class="o">=</span> <span class="n">temp2</span><span class="o">-</span><span class="n">sig</span><span class="o">*</span><span class="n">pos_proj_mat</span><span class="p">(</span><span class="n">temp2</span><span class="o">/</span><span class="n">sig</span><span class="p">)</span>

        <span class="c1"># Primal variable update</span>
        <span class="n">coeff_temp</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">shapA</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="mi">1</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shapA</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
            <span class="n">coeff_temp</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">comp_ref</span><span class="p">[:,:,</span><span class="n">j</span><span class="p">]</span><span class="o">*</span><span class="n">Y2</span><span class="p">)</span>

        <span class="n">temp31</span> <span class="o">=</span> <span class="n">coeff_temp</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">basis</span><span class="p">[:,</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">1</span><span class="p">,(</span><span class="n">nb_ref</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">shapA</span><span class="p">[</span><span class="mi">0</span><span class="p">])))</span>
        <span class="n">temp3</span> <span class="o">=</span> <span class="n">temp31</span> <span class="o">+</span> <span class="n">Y1</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">transpose</span><span class="p">(</span><span class="n">basis</span><span class="p">[:,:</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>

        <span class="n">Xold</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
        <span class="n">X</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">lineskthresholding</span><span class="p">(</span><span class="n">X</span><span class="o">-</span><span class="n">to</span><span class="o">*</span><span class="n">temp3</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">int</span><span class="p">(</span><span class="n">floor</span><span class="p">(</span><span class="n">sqrt</span><span class="p">(</span><span class="n">i</span><span class="p">)))</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>

        <span class="c1"># Main variable update</span>
        <span class="n">alpha</span> <span class="o">=</span> <span class="n">X</span><span class="o">+</span><span class="n">theta</span><span class="o">*</span><span class="p">(</span><span class="n">X</span><span class="o">-</span><span class="n">Xold</span><span class="p">)</span>

        <span class="n">i</span><span class="o">+=</span><span class="mi">1</span>
        <span class="n">cost_old</span> <span class="o">=</span> <span class="n">cost</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">cost</span>
        <span class="n">cost</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">((</span><span class="n">alpha</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">basis</span><span class="p">[:,:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">-</span> <span class="n">Aref</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
        <span class="c1"># Sanity check</span>
        <span class="nb">print</span> <span class="s2">&quot;-------- res: &quot;</span><span class="p">,</span><span class="n">cost</span><span class="p">,</span><span class="s2">&quot;-------- Min val: &quot;</span><span class="p">,</span><span class="n">temp2</span><span class="o">.</span><span class="n">min</span><span class="p">()</span><span class="o">/</span><span class="n">sig</span><span class="p">,</span><span class="s2">&quot; ---------&quot;</span>

    <span class="n">Aout</span> <span class="o">=</span> <span class="n">alpha</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">basis</span><span class="p">)</span>
    <span class="n">im_interp</span> <span class="o">=</span> <span class="mi">0</span><span class="o">*</span><span class="n">comp_ref</span><span class="p">[:,:,</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shapA</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
        <span class="n">im_interp</span><span class="o">+=</span><span class="n">comp_ref</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">]</span><span class="o">*</span><span class="n">Aout</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">im_interp</span><span class="p">,</span><span class="n">Aout</span><span class="p">,</span><span class="n">basis</span>


<span class="k">def</span> <span class="nf">non_unif_interp_mult_coeff</span><span class="p">(</span><span class="n">Aref</span><span class="p">,</span><span class="n">comp_ref</span><span class="p">,</span><span class="n">posi_ref</span><span class="p">,</span><span class="n">posi_target</span><span class="p">,</span><span class="n">e</span><span class="p">,</span><span class="n">p</span><span class="p">,</span><span class="n">tol</span><span class="o">=</span><span class="mi">10</span><span class="o">**-</span><span class="mi">5</span><span class="p">,</span><span class="n">eps</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span><span class="n">theta</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span><span class="n">nb_iter</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span><span class="n">pos_en</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>

    <span class="n">shap1</span> <span class="o">=</span> <span class="n">posi_target</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">shap2</span> <span class="o">=</span> <span class="n">comp_ref</span><span class="o">.</span><span class="n">shape</span>

    <span class="n">im_interp</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">shap2</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">shap2</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">shap1</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap1</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
        <span class="nb">print</span> <span class="s2">&quot;---------- Interpolation &quot;</span><span class="p">,</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="s2">&quot;/&quot;</span><span class="p">,</span><span class="n">shap1</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="s2">&quot;------------&quot;</span>
        <span class="k">if</span> <span class="n">pos_en</span><span class="p">:</span>
            <span class="n">im_interp</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">],</span><span class="n">Aouti</span><span class="p">,</span><span class="n">basis_i</span> <span class="o">=</span> <span class="n">non_unif_interp_mult_coeff_pos_cp</span><span class="p">(</span><span class="n">Aref</span><span class="p">,</span><span class="n">comp_ref</span><span class="p">,</span><span class="n">posi_ref</span><span class="p">,</span><span class="n">posi_target</span><span class="p">[</span><span class="n">i</span><span class="p">,:],</span><span class="n">e</span><span class="p">,</span><span class="n">p</span><span class="p">,</span><span class="n">tol</span><span class="o">=</span><span class="n">tol</span><span class="p">,</span><span class="n">eps</span><span class="o">=</span><span class="n">eps</span><span class="p">,</span><span class="n">theta</span><span class="o">=</span><span class="n">theta</span><span class="p">,</span><span class="n">nb_iter</span><span class="o">=</span><span class="n">nb_iter</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">im_interp</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">],</span><span class="n">Aouti</span><span class="p">,</span><span class="n">basis_i</span> <span class="o">=</span> <span class="n">non_unif_interp_mult_coeff_BT</span><span class="p">(</span><span class="n">Aref</span><span class="p">,</span><span class="n">comp_ref</span><span class="p">,</span><span class="n">posi_ref</span><span class="p">,</span><span class="n">posi_target</span><span class="p">[</span><span class="n">i</span><span class="p">,:],</span><span class="n">e</span><span class="p">,</span><span class="n">p</span><span class="p">,</span><span class="n">tol</span><span class="o">=</span><span class="n">tol</span><span class="p">,</span><span class="n">eps</span><span class="o">=</span><span class="n">eps</span><span class="p">,</span><span class="n">nb_iter</span><span class="o">=</span><span class="n">nb_iter</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">im_interp</span>


<span class="sd">&quot;&quot;&quot;def non_unif_smoothing_mult_coeff_pos_cp_4(im,src,src_hr,tree,weights,l1_rad,weights_thresh,opt=opt,mr_file=mr_file,theta=0.8,p_smth_mat_inv=None,to=None,eps=0.8,nb_iter=100,tol=0.01,Ainit=None,pos_en=0): # to is the weight related to the primal variable</span>

<span class="sd">    shap = src.shape</span>
<span class="sd">    shap1 = src_hr.shape</span>
<span class="sd">    src_mat = zeros((shap[2],shap[2]))</span>
<span class="sd">    src_mat = utils.cube_gram_mat(src_hr)</span>
<span class="sd">    U, s, Vt = linalg.svd(src_mat,full_matrices=False)</span>
<span class="sd">    spec_rad_pos = s.max()</span>
<span class="sd">    nb_neigh = tree.shape[1]</span>
<span class="sd">    Atemp,mat,v = lsq_mult_coeff_stack(im,src)</span>
<span class="sd">    nb_src = Atemp.shape[0]</span>
<span class="sd">    if Ainit is None:</span>
<span class="sd">        if pos_en==1:</span>
<span class="sd">            if nb_src==1:</span>
<span class="sd">                Ainit = pos_proj(Atemp)</span>
<span class="sd">            elif nb_src&gt;1:</span>
<span class="sd">                Ainit = pos_proj_mat(Atemp)</span>
<span class="sd">        else:</span>
<span class="sd">            Ainit = Atemp</span>

<span class="sd">    w_max = 0</span>
<span class="sd">    spec_rad_spars = sqrt(spec_rad_pos)*weights_thresh.max()*(l1_rad.min()**(-1))*shap[3]</span>



<span class="sd">    spec_rad = zeros((shap[3]))</span>
<span class="sd">    for k in range(0,shap[3]):</span>
<span class="sd">        U, s, Vt = linalg.svd(mat[:,:,k],full_matrices=False)</span>
<span class="sd">        spec_rad[k] = s.max()</span>
<span class="sd">    spec_norm=None</span>
<span class="sd">    if pos_en==1:</span>
<span class="sd">        spec_norm = sqrt(spec_rad.sum()+spec_rad_pos+spec_rad_spars**2)</span>
<span class="sd">    else:</span>
<span class="sd">        spec_norm = sqrt(spec_rad.sum()+spec_rad_spars**2)</span>
<span class="sd">    if to is None:</span>
<span class="sd">        a = sum(weights,axis=1)</span>
<span class="sd">    #to = (2*a.max())**(-1)</span>
<span class="sd">    to = 1/(spec_norm)</span>
<span class="sd">    print &#39;----smoothing cp spec_rad-----: &#39;,spec_norm</span>
<span class="sd">    if p_smth_mat_inv is None:</span>
<span class="sd">        p_smth_mat_inv = zeros((shap[3],shap[3],nb_src))</span>
<span class="sd">        p_smth_mat_stack = zeros((shap[3],shap[3],nb_src))</span>
<span class="sd">        spec_rad_stack = zeros((nb_src,))</span>
<span class="sd">        for ind in range(0,nb_src):</span>
<span class="sd">            p_smth_mat = non_uniform_smoothing_mat(weights[:,:,ind])</span>
<span class="sd">            #p_smth_mat_stack[:,:,ind] = transpose(p_smth_mat).dot(p_smth_mat)</span>
<span class="sd">            p_smth_mat_stack[:,:,ind] = copy(p_smth_mat)</span>
<span class="sd">            U, s, Vt = linalg.svd(p_smth_mat_stack[:,:,ind],full_matrices=False)</span>
<span class="sd">            spec_rad_stack[ind] = s.max()</span>
<span class="sd">        #to = 1.0/spec_rad_stack.max()</span>
<span class="sd">        for ind in range(0,nb_src):</span>
<span class="sd">            mat_temp = eye(shap[3])+to*p_smth_mat_stack[:,:,ind]</span>
<span class="sd">            p_smth_mat_inv[:,:,ind] = LA.inv(mat_temp)</span>

<span class="sd">    sig = eps/(to*spec_norm**2) # Weight related to the dual variables</span>
<span class="sd">    # Dual variables</span>
<span class="sd">    #y1 = copy(Ainit)</span>
<span class="sd">    y1 = zeros((shap1[0],shap1[1],shap[3]))</span>
<span class="sd">    y2 = im*0</span>
<span class="sd">    o = y2*0</span>
<span class="sd">    y3 = weights_thresh*0</span>
<span class="sd">    rad = zeros((shap[3],))</span>
<span class="sd">    for k in range(0,shap[3]):</span>
<span class="sd">        res = copy(im[:,:,k])</span>
<span class="sd">        for l in range(0,shap[2]):</span>
<span class="sd">            res-=Ainit[l,k]*src[:,:,l,k]</span>
<span class="sd">        y2[:,:,k] = -res</span>
<span class="sd">        rad[k] = (res**2).sum()</span>
<span class="sd">    print &quot;---&gt;&gt; ref res: &lt;&lt;---&quot;,rad.sum()</span>
<span class="sd">    # Primal variable</span>
<span class="sd">    v = copy(Ainit)</span>

<span class="sd">    # Main variable</span>
<span class="sd">    x = copy(Ainit)</span>

<span class="sd">    cost=1</span>
<span class="sd">    cost_old=0</span>
<span class="sd">    iter=0</span>
<span class="sd">    temp6 = None</span>
<span class="sd">    r = array(range(0,shap[3]))</span>


<span class="sd">    while iter&lt;nb_iter and 100*abs(cost-cost_old)/abs(cost)&gt;tol :</span>

<span class="sd">        iter+=1</span>
<span class="sd">        # Dual variables update</span>
<span class="sd">        # Positivity</span>
<span class="sd">        #temp1 = y1+sig*x</span>
<span class="sd">        temp1 = copy(y1)</span>
<span class="sd">        for k in range(0,shap[3]):</span>
<span class="sd">            for l in range(0,shap[2]):</span>
<span class="sd">                temp1[:,:,k] +=sig*x[l,k]*src_hr[:,:,l]</span>
<span class="sd">        if shap[2]==1:</span>
<span class="sd">            y1 = temp1-sig*pos_proj_mat(temp1/sig)</span>
<span class="sd">        else:</span>
<span class="sd">            y1 = temp1-sig*pos_proj_cube(temp1/sig)</span>

<span class="sd">        # Residual constraint</span>
<span class="sd">        temp2 = y2*0</span>
<span class="sd">        for k in range(0,shap[3]):</span>
<span class="sd">            for l in range(0,shap[2]):</span>
<span class="sd">                temp2[:,:,k] +=sig*x[l,k]*src[:,:,l,k]</span>
<span class="sd">        temp2+=y2-sig*im</span>
<span class="sd">        y2 = temp2-sig*proj_sphere_cube(temp2/sig,o,sqrt(rad)) # Moreau id</span>

<span class="sd">        # Primal variable update</span>
<span class="sd">        temp3 = x*0</span>
<span class="sd">        for k in range(0,shap[3]):</span>
<span class="sd">            for l in range(0,shap[2]):</span>
<span class="sd">                temp3[l,k]+=to*((src[:,:,l,k]*y2[:,:,k]).sum()+(src_hr[:,:,l]*y1[:,:,k]).sum())</span>
<span class="sd">        temp4 = v - temp3</span>
<span class="sd">        vold = copy(v)</span>
<span class="sd">        v = smoothing_prox(p_smth_mat_inv,temp4)</span>
<span class="sd">        x = v+theta*(v-vold)</span>
<span class="sd">        # Sanity check</span>
<span class="sd">        cost_smooth = 0</span>
<span class="sd">        for k in range(0,shap[3]):</span>
<span class="sd">            ind_k = where(r!=k)</span>
<span class="sd">            for l in range(0,shap[3]-1):</span>
<span class="sd">                cost_smooth+=(((x[:,k]-x[:,ind_k[0][l]])*sqrt(weights[k,l,:])).sum())**2</span>
<span class="sd">        # Objective value</span>
<span class="sd">        temp5 = y2*0</span>
<span class="sd">        for k in range(0,shap[3]):</span>
<span class="sd">            for l in range(0,shap[2]):</span>
<span class="sd">                temp5[:,:,k] +=x[l,k]*src[:,:,l,k]</span>
<span class="sd">        temp6 = y1*0</span>
<span class="sd">        for k in range(0,shap[3]):</span>
<span class="sd">            for l in range(0,shap[2]):</span>
<span class="sd">                temp6[:,:,k] +=x[l,k]*src_hr[:,:,l]</span>
<span class="sd">        max_comp = (temp5*y2).sum()+(y1*temp6).sum()</span>
<span class="sd">        temp5-=im</span>
<span class="sd">        min_comp = cost_smooth</span>
<span class="sd">        cost_old = cost</span>
<span class="sd">        cost = min_comp+max_comp</span>
<span class="sd">        print &quot;residual: &quot;,(temp5**2).sum(), &quot; smoothness: &quot;,cost_smooth,&quot; linear part: &quot;,max_comp,&quot; objective val: &quot;,cost,&quot; min val: &quot;,temp6.min()</span>

<span class="sd">    min_val_map = temp6[:,:,0]</span>
<span class="sd">    for i in range(0,shap1[0]):</span>
<span class="sd">        for j in range(0,shap1[0]):</span>
<span class="sd">            min_val_map[i,j] = temp6[i,j,:].min()</span>
<span class="sd">    print &quot;median min val: &quot;,np.median(min_val_map)</span>

<span class="sd">    return x,min_val_map&quot;&quot;&quot;</span>


<span class="k">def</span> <span class="nf">non_uniform_smoothing_mat</span><span class="p">(</span><span class="n">weights_mat</span><span class="p">):</span> <span class="c1"># the ith line of the weight matrix contains the weights relating the ith feature to the n-1 other features</span>
    <span class="n">shap</span> <span class="o">=</span> <span class="n">weights_mat</span><span class="o">.</span><span class="n">shape</span>

    <span class="n">mat_out</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
    <span class="n">mat_temp</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
    <span class="n">temp_col</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="mi">1</span><span class="p">))</span>
    <span class="n">temp_col_2</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="mi">1</span><span class="p">))</span>
    <span class="n">ind</span> <span class="o">=</span> <span class="n">array</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
        <span class="n">ai</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">weights_mat</span><span class="p">[</span><span class="n">i</span><span class="p">,:])</span>
        <span class="n">temp_col</span> <span class="o">=</span> <span class="n">temp_col</span><span class="o">*</span><span class="mi">0</span>
        <span class="n">ik</span> <span class="o">=</span> <span class="n">where</span><span class="p">(</span><span class="n">ind</span><span class="o">!=</span><span class="n">i</span><span class="p">)</span>
        <span class="n">temp_col</span><span class="p">[</span><span class="n">ik</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="n">weights_mat</span><span class="p">[</span><span class="n">i</span><span class="p">,:],(</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>
        <span class="n">temp_col_2</span><span class="p">[</span><span class="n">ik</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="n">weights_mat</span><span class="p">[</span><span class="n">i</span><span class="p">,:],(</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>
        <span class="n">temp_col_2</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">ai</span>
        <span class="n">mat_temp</span><span class="p">[:,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">ndarray</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="n">temp_col_2</span><span class="o">*</span><span class="n">ai</span><span class="p">)</span>
        <span class="n">mat_out</span> <span class="o">+=</span> <span class="n">temp_col_2</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">transpose</span><span class="p">(</span><span class="n">temp_col</span><span class="p">))</span>
    <span class="n">mat_out</span><span class="o">+=</span> <span class="n">mat_temp</span>

    <span class="k">return</span> <span class="n">mat_out</span>

<div class="viewcode-block" id="non_uniform_smoothing_bas_mat"><a class="viewcode-back" href="../optim_utils.html#optim_utils.non_uniform_smoothing_bas_mat">[docs]</a><span class="k">def</span> <span class="nf">non_uniform_smoothing_bas_mat</span><span class="p">(</span><span class="n">weights</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; **[???]**</span>
<span class="sd">    </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">shap</span> <span class="o">=</span> <span class="n">weights</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">A</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
    <span class="n">B</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>

    <span class="n">range_ref</span> <span class="o">=</span> <span class="n">array</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
        <span class="n">ik</span> <span class="o">=</span> <span class="n">where</span><span class="p">(</span><span class="n">range_ref</span><span class="o">!=</span><span class="n">i</span><span class="p">)</span>
        <span class="n">A</span><span class="p">[</span><span class="n">ik</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">weights</span><span class="p">[</span><span class="n">i</span><span class="p">,:]</span>
        <span class="n">B</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">weights</span><span class="p">[</span><span class="n">i</span><span class="p">,:])</span>

    <span class="k">return</span> <span class="n">A</span><span class="p">,</span><span class="n">B</span></div>

<div class="viewcode-block" id="non_uniform_smoothing_mat_2"><a class="viewcode-back" href="../optim_utils.html#optim_utils.non_uniform_smoothing_mat_2">[docs]</a><span class="k">def</span> <span class="nf">non_uniform_smoothing_mat_2</span><span class="p">(</span><span class="n">weights</span><span class="p">,</span><span class="n">e</span><span class="p">):</span> <span class="c1"># e&gt;=0</span>
    <span class="sd">&quot;&quot;&quot; **[???]**</span>
<span class="sd">    </span>
<span class="sd">    Calls:</span>
<span class="sd">    </span>
<span class="sd">    * :func:`optim_utils.non_uniform_smoothing_bas_mat`</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">A</span><span class="p">,</span><span class="n">B</span> <span class="o">=</span> <span class="n">non_uniform_smoothing_bas_mat</span><span class="p">(</span><span class="n">weights</span><span class="p">)</span>
    <span class="n">mat_out</span> <span class="o">=</span> <span class="n">A</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">transpose</span><span class="p">(</span><span class="n">A</span><span class="p">))</span><span class="o">+</span> <span class="n">e</span><span class="o">*</span><span class="p">(</span><span class="n">A</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">B</span><span class="p">)</span><span class="o">+</span> <span class="n">B</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">transpose</span><span class="p">(</span><span class="n">A</span><span class="p">)))</span> <span class="o">+</span> <span class="p">(</span><span class="n">e</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">B</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">B</span><span class="p">)</span> <span class="c1"># B is diagonal matrix</span>
    <span class="k">return</span> <span class="n">mat_out</span></div>

<div class="viewcode-block" id="non_uniform_smoothing_mat_dist_1"><a class="viewcode-back" href="../optim_utils.html#optim_utils.non_uniform_smoothing_mat_dist_1">[docs]</a><span class="k">def</span> <span class="nf">non_uniform_smoothing_mat_dist_1</span><span class="p">(</span><span class="n">dist</span><span class="p">,</span><span class="n">expo_range</span><span class="p">,</span><span class="n">e</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; **[???] Computes some distance matrix, *again*.**</span>
<span class="sd">    </span>
<span class="sd">    Calls:</span>
<span class="sd">    </span>
<span class="sd">    * :func:`optim_utils.non_uniform_smoothing_mat_2`</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">dist_med</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">dist</span><span class="p">)</span>
    <span class="n">nb_samp</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">expo_range</span><span class="p">)</span>
    <span class="n">nb_im</span> <span class="o">=</span> <span class="n">dist</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">mat_stack</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">nb_im</span><span class="p">,</span><span class="n">nb_im</span><span class="p">,</span><span class="n">nb_samp</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_samp</span><span class="p">):</span>
        <span class="n">dist_weights</span> <span class="o">=</span> <span class="p">(</span><span class="n">dist_med</span><span class="o">/</span><span class="n">dist</span><span class="p">)</span><span class="o">**</span><span class="n">expo_range</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">dist_weigths</span> <span class="o">=</span> <span class="n">dist_weights</span><span class="o">/</span><span class="n">dist_weights</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
        <span class="n">mat_stack</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">non_uniform_smoothing_mat_2</span><span class="p">(</span><span class="n">dist_weights</span><span class="p">,</span><span class="n">e</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">mat_stack</span></div>

<div class="viewcode-block" id="non_uniform_smoothing_mat_dist_2"><a class="viewcode-back" href="../optim_utils.html#optim_utils.non_uniform_smoothing_mat_dist_2">[docs]</a><span class="k">def</span> <span class="nf">non_uniform_smoothing_mat_dist_2</span><span class="p">(</span><span class="n">dist</span><span class="p">,</span><span class="n">expo</span><span class="p">,</span><span class="n">e_range</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Same as :func:`optim_utils.non_uniform_smoothing_mat_dist_1`, but with</span>
<span class="sd">    constant ``expo`` and varying ``e`` (as opposed to constant ``e`` and </span>
<span class="sd">    varying ``expo``.</span>
<span class="sd">    </span>
<span class="sd">    Calls:</span>
<span class="sd">    </span>
<span class="sd">    * :func:`optim_utils.non_uniform_smoothing_mat_2`</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">dist_med</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">dist</span><span class="p">)</span>
    <span class="n">nb_samp</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">e_range</span><span class="p">)</span>
    <span class="n">nb_im</span> <span class="o">=</span> <span class="n">dist</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">mat_stack</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">nb_im</span><span class="p">,</span><span class="n">nb_im</span><span class="p">,</span><span class="n">nb_samp</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_samp</span><span class="p">):</span>
        <span class="n">dist_weights</span> <span class="o">=</span> <span class="p">(</span><span class="n">dist_med</span><span class="o">/</span><span class="n">dist</span><span class="p">)</span><span class="o">**</span><span class="n">expo</span>
        <span class="n">dist_weigths</span> <span class="o">=</span> <span class="n">dist_weights</span><span class="o">/</span><span class="n">dist_weights</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
        <span class="n">mat_stack</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">non_uniform_smoothing_mat_2</span><span class="p">(</span><span class="n">dist_weights</span><span class="p">,</span><span class="n">e_range</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">mat_stack</span></div>

<span class="k">def</span> <span class="nf">notch_filt_optim</span><span class="p">(</span><span class="n">test_mat</span><span class="p">,</span><span class="n">dist</span><span class="p">,</span><span class="n">expo_range</span><span class="p">,</span><span class="n">e_range</span><span class="p">,</span><span class="n">nb_iter</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span><span class="n">tol</span><span class="o">=</span><span class="mf">0.01</span><span class="p">):</span>
    <span class="n">expo_out</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">e_out</span> <span class="o">=</span> <span class="mf">0.5</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_iter</span><span class="p">):</span>
        <span class="n">mat_stack</span> <span class="o">=</span> <span class="n">non_uniform_smoothing_mat_dist_1</span><span class="p">(</span><span class="n">dist</span><span class="p">,</span><span class="n">expo_range</span><span class="p">,</span><span class="n">e_out</span><span class="p">)</span>
        <span class="n">loss</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">kernel_testmat_stack</span><span class="p">(</span><span class="n">mat_stack</span><span class="p">,</span><span class="n">test_mat</span><span class="p">,</span><span class="n">tol</span><span class="o">=</span><span class="n">tol</span><span class="p">)</span>
        <span class="n">j</span> <span class="o">=</span> <span class="n">where</span><span class="p">(</span><span class="n">loss</span><span class="o">==</span><span class="n">loss</span><span class="o">.</span><span class="n">max</span><span class="p">())</span>
        <span class="n">expo_out</span> <span class="o">=</span> <span class="n">expo_range</span><span class="p">[</span><span class="n">j</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]]</span>
        <span class="n">mat_stack</span> <span class="o">=</span> <span class="n">non_uniform_smoothing_mat_dist_2</span><span class="p">(</span><span class="n">dist</span><span class="p">,</span><span class="n">expo_out</span><span class="p">,</span><span class="n">e_range</span><span class="p">)</span>
        <span class="n">loss</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">kernel_testmat_stack</span><span class="p">(</span><span class="n">mat_stack</span><span class="p">,</span><span class="n">test_mat</span><span class="p">,</span><span class="n">tol</span><span class="o">=</span><span class="n">tol</span><span class="p">)</span>
        <span class="n">j</span> <span class="o">=</span> <span class="n">where</span><span class="p">(</span><span class="n">loss</span><span class="o">==</span><span class="n">loss</span><span class="o">.</span><span class="n">max</span><span class="p">())</span>
        <span class="n">e_out</span> <span class="o">=</span> <span class="n">e_range</span><span class="p">[</span><span class="n">j</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]]</span>
        <span class="nb">print</span> <span class="s2">&quot;optimal loss: &quot;</span><span class="p">,</span><span class="n">loss</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="nb">print</span> <span class="s2">&quot; Optimum values: &quot;</span><span class="p">,</span><span class="n">expo_out</span><span class="p">,</span><span class="s2">&quot; &quot;</span><span class="p">,</span><span class="n">e_out</span><span class="c1">#,&quot; &quot;,expo_range,&quot; &quot;,e_range</span>
    <span class="k">return</span> <span class="n">expo_out</span><span class="p">,</span><span class="n">e_out</span>

<div class="viewcode-block" id="notch_filt_optim_2"><a class="viewcode-back" href="../optim_utils.html#optim_utils.notch_filt_optim_2">[docs]</a><span class="k">def</span> <span class="nf">notch_filt_optim_2</span><span class="p">(</span><span class="n">test_mat</span><span class="p">,</span><span class="n">dist</span><span class="p">,</span><span class="n">expo_range</span><span class="p">,</span><span class="n">e_range</span><span class="p">,</span><span class="n">nb_iter</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span><span class="n">tol</span><span class="o">=</span><span class="mf">0.01</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;**[???]** Finds notch filter hyperparameters I guess?</span>
<span class="sd">    </span>
<span class="sd">    Calls:</span>
<span class="sd">    </span>
<span class="sd">    * :func:`optim_utils.non_uniform_smoothing_mat_dist_1`</span>
<span class="sd">    * :func:`utils.kernel_mat_stack_test_unit`</span>
<span class="sd">    * :func:`optim_utils.non_uniform_smoothing_mat_dist_2`</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">expo_out</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">e_out</span> <span class="o">=</span> <span class="mf">0.5</span>
    <span class="n">loss</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">vect</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">ker</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">j2</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_iter</span><span class="p">):</span>
        <span class="n">mat_stack</span> <span class="o">=</span> <span class="n">non_uniform_smoothing_mat_dist_1</span><span class="p">(</span><span class="n">dist</span><span class="p">,</span><span class="n">expo_range</span><span class="p">,</span><span class="n">e_out</span><span class="p">)</span>
        <span class="n">vect</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">loss</span><span class="p">,</span><span class="n">ker</span><span class="p">,</span><span class="n">j2</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">kernel_mat_stack_test_unit</span><span class="p">(</span><span class="n">mat_stack</span><span class="p">,</span><span class="n">test_mat</span><span class="p">,</span><span class="n">tol</span><span class="o">=</span><span class="n">tol</span><span class="p">)</span>
        <span class="nb">print</span> <span class="s2">&quot;=========== Loss out ==========: &quot;</span><span class="p">,</span><span class="n">loss</span>
        <span class="n">expo_out</span> <span class="o">=</span> <span class="n">expo_range</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
        <span class="n">mat_stack</span> <span class="o">=</span> <span class="n">non_uniform_smoothing_mat_dist_2</span><span class="p">(</span><span class="n">dist</span><span class="p">,</span><span class="n">expo_out</span><span class="p">,</span><span class="n">e_range</span><span class="p">)</span>
        <span class="n">vect</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">loss</span><span class="p">,</span><span class="n">ker</span><span class="p">,</span><span class="n">j2</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">kernel_mat_stack_test_unit</span><span class="p">(</span><span class="n">mat_stack</span><span class="p">,</span><span class="n">test_mat</span><span class="p">,</span><span class="n">tol</span><span class="o">=</span><span class="n">tol</span><span class="p">)</span>
        <span class="nb">print</span> <span class="s2">&quot;=========== Loss out ==========: &quot;</span><span class="p">,</span><span class="n">loss</span>
        <span class="n">e_out</span> <span class="o">=</span> <span class="n">e_range</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">expo_out</span><span class="p">,</span><span class="n">e_out</span><span class="p">,</span><span class="n">loss</span><span class="p">,</span><span class="n">vect</span><span class="p">,</span><span class="n">ker</span><span class="p">,</span><span class="n">j2</span></div>

<div class="viewcode-block" id="analysis"><a class="viewcode-back" href="../optim_utils.html#optim_utils.analysis">[docs]</a><span class="k">def</span> <span class="nf">analysis</span><span class="p">(</span><span class="n">cube</span><span class="p">,</span><span class="n">sig</span><span class="p">,</span><span class="n">field_dist</span><span class="p">,</span><span class="n">p_min</span> <span class="o">=</span> <span class="mf">0.01</span><span class="p">,</span><span class="n">e_min</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span><span class="n">e_max</span><span class="o">=</span><span class="mf">1.99</span><span class="p">,</span><span class="n">nb_max</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span><span class="n">tol</span><span class="o">=</span><span class="mf">0.01</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Computes graph-constraint related values, see RCA paper sections 5.2 and (especially) 5.5.3.</span>
<span class="sd">    </span>
<span class="sd">    </span>
<span class="sd">    Calls:</span>
<span class="sd">    </span>
<span class="sd">    * :func:`utils.knn_interf`</span>
<span class="sd">    * :func:`optim_utils.pow_law_select`</span>
<span class="sd">    * :func:`utils.feat_dist_mat`</span>
<span class="sd">    * :func:`utils.log_sampling`</span>
<span class="sd">    * :func:`optim_utils.notch_filt_optim_2`</span>
<span class="sd">    * :func:`utils.mat_to_cube`</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">nb_samp_opt</span> <span class="o">=</span> <span class="mi">10</span>
    <span class="n">shap</span> <span class="o">=</span> <span class="n">cube</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">nb_neighs</span> <span class="o">=</span> <span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span>
    <span class="n">neigh</span><span class="p">,</span><span class="n">dists</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">knn_interf</span><span class="p">(</span><span class="n">field_dist</span><span class="p">,</span><span class="n">nb_neighs</span><span class="p">)</span>
    <span class="n">p_max</span> <span class="o">=</span> <span class="n">pow_law_select</span><span class="p">(</span><span class="n">dists</span><span class="p">,</span><span class="n">nb_neighs</span><span class="p">)</span>
    <span class="nb">print</span> <span class="s2">&quot;power max = &quot;</span><span class="p">,</span><span class="n">p_max</span>

    <span class="nb">print</span> <span class="s2">&quot;Done...&quot;</span>
    <span class="n">dists_unsorted</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">feat_dist_mat</span><span class="p">(</span><span class="n">field_dist</span><span class="p">)</span>
    <span class="n">e_range</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">log_sampling</span><span class="p">(</span><span class="n">e_min</span><span class="p">,</span><span class="n">e_max</span><span class="p">,</span><span class="n">nb_samp_opt</span><span class="p">)</span>
    <span class="n">p_range</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">log_sampling</span><span class="p">(</span><span class="n">p_min</span><span class="p">,</span><span class="n">p_max</span><span class="p">,</span><span class="n">nb_samp_opt</span><span class="p">)</span>
    <span class="n">res_mat</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">transpose</span><span class="p">(</span><span class="n">cube</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]))))</span>

    <span class="n">list_comp</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
    <span class="n">list_e</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
    <span class="n">list_p</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
    <span class="n">list_ind</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
    <span class="n">list_ker</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
    <span class="n">err</span> <span class="o">=</span> <span class="mf">1e20</span>
    <span class="n">nb_iter</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">while</span> <span class="n">nb_iter</span><span class="o">&lt;</span><span class="n">nb_max</span><span class="p">:</span> <span class="c1"># err&gt;sig and</span>
        <span class="n">expo_out</span><span class="p">,</span><span class="n">e_out</span><span class="p">,</span><span class="n">loss</span><span class="p">,</span><span class="n">vect</span><span class="p">,</span><span class="n">ker</span><span class="p">,</span><span class="n">j</span> <span class="o">=</span> <span class="n">notch_filt_optim_2</span><span class="p">(</span><span class="n">res_mat</span><span class="p">,</span><span class="n">dists_unsorted</span><span class="p">,</span><span class="n">p_range</span><span class="p">,</span><span class="n">e_range</span><span class="p">,</span><span class="n">nb_iter</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span><span class="n">tol</span><span class="o">=</span><span class="n">tol</span><span class="p">)</span>
        <span class="n">list_e</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">e_out</span><span class="p">)</span>
        <span class="n">list_p</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">expo_out</span><span class="p">)</span>
        <span class="n">list_comp</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">vect</span><span class="p">)</span>
        <span class="n">list_ind</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">j</span><span class="p">)</span>
        <span class="n">list_ker</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ker</span><span class="p">)</span>
        <span class="n">nb_iter</span><span class="o">+=</span><span class="mi">1</span>
        <span class="n">res_mat</span> <span class="o">=</span> <span class="n">res_mat</span><span class="o">-</span><span class="n">transpose</span><span class="p">(</span><span class="n">vect</span><span class="p">)</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">vect</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">res_mat</span><span class="p">))</span>
        <span class="nb">print</span> <span class="s2">&quot;nb_comp: &quot;</span><span class="p">,</span><span class="n">nb_iter</span><span class="p">,</span><span class="s2">&quot; residual: &quot;</span><span class="p">,</span><span class="n">loss</span><span class="p">,</span><span class="s2">&quot; e: &quot;</span><span class="p">,</span><span class="n">e_out</span><span class="p">,</span><span class="s2">&quot; p: &quot;</span><span class="p">,</span><span class="n">expo_out</span><span class="p">,</span><span class="s2">&quot;chosen index: &quot;</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="s2">&quot;/&quot;</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
        <span class="n">err</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">res_mat</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>

    <span class="n">e_vect</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">nb_iter</span><span class="p">,))</span>
    <span class="n">p_vect</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">nb_iter</span><span class="p">,))</span>
    <span class="n">weights</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">nb_iter</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>
    <span class="n">ker</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">nb_iter</span><span class="o">*</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>
    <span class="n">ind</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">nb_iter</span><span class="p">,</span><span class="n">nb_iter</span><span class="o">*</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_iter</span><span class="p">):</span>
        <span class="n">e_vect</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">list_e</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">p_vect</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">list_p</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">weights</span><span class="p">[</span><span class="n">i</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">list_comp</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">],))</span>
        <span class="n">ker</span><span class="p">[</span><span class="n">i</span><span class="o">*</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]:(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">],:]</span> <span class="o">=</span> <span class="n">list_ker</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">ind</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">i</span><span class="o">*</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">+</span><span class="n">list_ind</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">=</span> <span class="mi">1</span>


    <span class="n">res_mat</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">transpose</span><span class="p">(</span><span class="n">cube</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]))))</span>
    <span class="n">proj_coeff</span> <span class="o">=</span> <span class="n">weights</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">res_mat</span><span class="p">)</span>
    <span class="n">comp</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">mat_to_cube</span><span class="p">(</span><span class="n">proj_coeff</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

    <span class="n">proj_data</span> <span class="o">=</span> <span class="n">transpose</span><span class="p">(</span><span class="n">weights</span><span class="p">)</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">proj_coeff</span><span class="p">)</span>
    <span class="n">proj_data</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">mat_to_cube</span><span class="p">(</span><span class="n">proj_data</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

    <span class="k">return</span> <span class="n">e_vect</span><span class="p">,</span><span class="n">p_vect</span><span class="p">,</span><span class="n">weights</span><span class="p">,</span><span class="n">comp</span><span class="p">,</span><span class="n">proj_data</span><span class="p">,</span><span class="n">ker</span><span class="p">,</span><span class="n">ind</span></div>



<span class="k">def</span> <span class="nf">weight_init</span><span class="p">(</span><span class="n">weights_mat</span><span class="p">,</span><span class="n">data_cube</span><span class="p">,</span><span class="n">nb_iter</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span><span class="n">winit</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="n">mat</span> <span class="o">=</span> <span class="n">non_uniform_smoothing_mat</span><span class="p">(</span><span class="n">weights_mat</span><span class="p">)</span>
    <span class="n">siz</span> <span class="o">=</span> <span class="n">data_cube</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">w</span><span class="o">=</span><span class="n">winit</span>
    <span class="k">if</span> <span class="n">winit</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">w</span> <span class="o">=</span> <span class="p">((</span><span class="n">data_cube</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)))</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">/</span><span class="n">sqrt</span><span class="p">(</span><span class="n">siz</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">siz</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">w</span> <span class="o">=</span> <span class="n">w</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">siz</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="mi">1</span><span class="p">))</span>
    <span class="n">U</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">Vt</span> <span class="o">=</span> <span class="n">linalg</span><span class="o">.</span><span class="n">svd</span><span class="p">(</span><span class="n">mat</span><span class="p">,</span><span class="n">full_matrices</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">lip</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">s</span><span class="p">)</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_iter</span><span class="p">):</span>
        <span class="n">z</span> <span class="o">=</span> <span class="n">mat</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">w</span><span class="p">)</span><span class="o">/</span><span class="n">lip</span>
        <span class="n">w</span> <span class="o">=</span> <span class="n">w</span> <span class="o">-</span> <span class="n">z</span>
        <span class="c1">#print (z**2).sum()</span>
    <span class="n">w</span> <span class="o">=</span> <span class="n">w</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">siz</span><span class="p">[</span><span class="mi">2</span><span class="p">],))</span>
    <span class="k">return</span> <span class="n">w</span>

<span class="k">def</span> <span class="nf">weights_mat_test</span><span class="p">(</span><span class="n">weights</span><span class="p">,</span><span class="n">nb_iter</span><span class="o">=</span><span class="mi">100</span><span class="p">):</span>
    <span class="n">mse</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">nb_iter</span><span class="p">,))</span>
    <span class="n">shap</span> <span class="o">=</span> <span class="n">weights</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">w</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

    <span class="n">mat</span> <span class="o">=</span> <span class="n">non_uniform_smoothing_mat</span><span class="p">(</span><span class="n">weights</span><span class="p">)</span>
    <span class="n">U</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">Vt</span> <span class="o">=</span> <span class="n">linalg</span><span class="o">.</span><span class="n">svd</span><span class="p">(</span><span class="n">mat</span><span class="p">,</span><span class="n">full_matrices</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">lip</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">array</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_iter</span><span class="p">):</span>
        <span class="n">cost</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
            <span class="n">ind_k</span> <span class="o">=</span> <span class="n">where</span><span class="p">(</span><span class="n">r</span><span class="o">!=</span><span class="n">k</span><span class="p">)</span>
            <span class="n">a</span><span class="o">=</span><span class="mi">0</span>
            <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
                <span class="n">a</span><span class="o">+=</span> <span class="p">(</span><span class="n">w</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">-</span><span class="n">w</span><span class="p">[</span><span class="n">ind_k</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">l</span><span class="p">]])</span><span class="o">*</span><span class="n">weights</span><span class="p">[</span><span class="n">k</span><span class="p">,</span><span class="n">l</span><span class="p">]</span>
            <span class="n">cost</span><span class="o">+=</span><span class="n">a</span><span class="o">**</span><span class="mi">2</span>
        <span class="n">grad</span> <span class="o">=</span> <span class="n">mat</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">w</span><span class="p">)</span>
        <span class="n">w</span> <span class="o">=</span> <span class="n">w</span> <span class="o">-</span> <span class="n">grad</span><span class="o">/</span><span class="n">lip</span>

    <span class="k">return</span> <span class="n">w</span>

<span class="k">def</span> <span class="nf">non_unif_smoothing_mult_coeff_pos_dr</span><span class="p">(</span><span class="n">im</span><span class="p">,</span><span class="n">src_hr</span><span class="p">,</span><span class="n">src_lr</span><span class="p">,</span><span class="n">tree</span><span class="p">,</span><span class="n">weights</span><span class="p">,</span><span class="n">upfact</span><span class="p">,</span><span class="n">ker</span><span class="p">,</span><span class="n">ker_adj</span><span class="p">,</span><span class="n">sig_est</span><span class="p">,</span><span class="n">flux_est</span><span class="p">,</span><span class="n">p_smth_mat_inv</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">to</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">eps</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span><span class="n">nb_iter</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span><span class="n">tol</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span><span class="n">Ainit</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">pos_en</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
    <span class="n">shap</span> <span class="o">=</span> <span class="n">src_lr</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">nb_neigh</span> <span class="o">=</span> <span class="n">tree</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">Atemp</span><span class="p">,</span><span class="n">mat</span><span class="p">,</span><span class="n">v</span> <span class="o">=</span> <span class="n">lsq_mult_coeff_stack</span><span class="p">(</span><span class="n">im</span><span class="p">,</span><span class="n">src_lr</span><span class="p">)</span>
    <span class="n">nb_src</span> <span class="o">=</span> <span class="n">Atemp</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">Ainit</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">Ainit</span> <span class="o">=</span> <span class="n">Atemp</span>
    <span class="n">spec_rad</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">3</span><span class="p">]))</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">3</span><span class="p">]):</span>
        <span class="n">U</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">Vt</span> <span class="o">=</span> <span class="n">linalg</span><span class="o">.</span><span class="n">svd</span><span class="p">(</span><span class="n">mat</span><span class="p">[:,:,</span><span class="n">k</span><span class="p">],</span><span class="n">full_matrices</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">spec_rad</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
    <span class="n">spec_norm</span> <span class="o">=</span> <span class="n">sqrt</span><span class="p">(</span><span class="n">spec_rad</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span>
    <span class="n">gam</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">if</span> <span class="n">p_smth_mat_inv</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">p_smth_mat_inv</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span><span class="n">shap</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span><span class="n">nb_src</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">ind</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_src</span><span class="p">):</span>
            <span class="n">p_smth_mat</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span><span class="n">shap</span><span class="p">[</span><span class="mi">3</span><span class="p">]))</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">3</span><span class="p">]):</span>
                <span class="n">i1</span><span class="p">,</span><span class="n">i2</span> <span class="o">=</span> <span class="n">where</span><span class="p">(</span><span class="n">tree</span><span class="o">==</span><span class="n">k</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_neigh</span><span class="p">):</span>
                    <span class="n">p_smth_mat</span><span class="p">[</span><span class="n">k</span><span class="p">,</span><span class="n">tree</span><span class="p">[</span><span class="n">k</span><span class="p">,</span><span class="n">l</span><span class="p">]]</span><span class="o">=-</span><span class="n">weights</span><span class="p">[</span><span class="n">k</span><span class="p">,</span><span class="n">l</span><span class="p">,</span><span class="n">ind</span><span class="p">]</span>
                <span class="n">w</span><span class="o">=</span><span class="n">weights</span><span class="p">[</span><span class="n">k</span><span class="p">,:,</span><span class="n">ind</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">size</span><span class="p">(</span><span class="n">i1</span><span class="p">)):</span>
                    <span class="n">p</span> <span class="o">=</span> <span class="n">where</span><span class="p">((</span><span class="n">tree</span><span class="p">[</span><span class="n">k</span><span class="p">,:]</span><span class="o">==</span><span class="n">i1</span><span class="p">[</span><span class="n">j</span><span class="p">]))</span>
                    <span class="k">if</span> <span class="n">size</span><span class="p">(</span><span class="n">p</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
                        <span class="n">w</span><span class="o">+=</span><span class="n">weights</span><span class="p">[</span><span class="n">i1</span><span class="p">[</span><span class="n">j</span><span class="p">],</span><span class="n">i2</span><span class="p">[</span><span class="n">j</span><span class="p">],</span><span class="n">ind</span><span class="p">]</span>
                        <span class="n">p_smth_mat</span><span class="p">[</span><span class="n">k</span><span class="p">,</span><span class="n">i1</span><span class="p">[</span><span class="n">j</span><span class="p">]]</span> <span class="o">=</span> <span class="o">-</span><span class="n">weights</span><span class="p">[</span><span class="n">i1</span><span class="p">[</span><span class="n">j</span><span class="p">],</span><span class="n">i2</span><span class="p">[</span><span class="n">j</span><span class="p">],</span><span class="n">ind</span><span class="p">]</span>
                <span class="n">p_smth_mat</span><span class="p">[</span><span class="n">k</span><span class="p">,</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">w</span>
            <span class="n">mat_temp</span> <span class="o">=</span> <span class="n">eye</span><span class="p">(</span><span class="n">shap</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span><span class="o">+</span><span class="n">gam</span><span class="o">*</span><span class="n">p_smth_mat</span>
            <span class="n">p_smth_mat_inv</span><span class="p">[:,:,</span><span class="n">ind</span><span class="p">]</span> <span class="o">=</span> <span class="n">LA</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">mat_temp</span><span class="p">)</span>


    <span class="c1"># Inequality constraint radius</span>
    <span class="n">rad</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">3</span><span class="p">],))</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">3</span><span class="p">]):</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">im</span><span class="p">[:,:,</span><span class="n">k</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
            <span class="n">res</span><span class="o">-=</span><span class="n">Ainit</span><span class="p">[</span><span class="n">l</span><span class="p">,</span><span class="n">k</span><span class="p">]</span><span class="o">*</span><span class="n">src_lr</span><span class="p">[:,:,</span><span class="n">l</span><span class="p">,</span><span class="n">k</span><span class="p">]</span>
        <span class="n">rad</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">res</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    <span class="nb">print</span> <span class="s2">&quot;---&gt;&gt;ref res: &lt;&lt;---&quot;</span><span class="p">,</span><span class="n">rad</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>

    <span class="c1"># Kernels setting</span>
    <span class="n">ker_in</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">ker</span><span class="p">)</span>
    <span class="n">ker_adj_in</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">ker_adj</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">3</span><span class="p">]):</span>
        <span class="n">ker_in</span><span class="p">[:,:,</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">flux_est</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">*</span><span class="n">ker_in</span><span class="p">[:,:,</span><span class="n">k</span><span class="p">]</span><span class="o">/</span><span class="n">sig_est</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
        <span class="n">ker_adj_in</span><span class="p">[:,:,</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">flux_est</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">*</span><span class="n">ker_adj_in</span><span class="p">[:,:,</span><span class="n">k</span><span class="p">]</span><span class="o">/</span><span class="n">sig_est</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>

    <span class="c1"># Optimization variables init</span>
    <span class="n">Atemp</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">Ainit</span><span class="p">)</span>
    <span class="n">Xtemp</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">upfact</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">upfact</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">3</span><span class="p">]))</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">3</span><span class="p">]):</span>
        <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
            <span class="n">Xtemp</span><span class="p">[:,:,</span><span class="n">k</span><span class="p">]</span><span class="o">+=</span><span class="n">src_hr</span><span class="p">[:,:,</span><span class="n">l</span><span class="p">]</span><span class="o">*</span><span class="n">Ainit</span><span class="p">[</span><span class="n">l</span><span class="p">,</span><span class="n">k</span><span class="p">]</span>

    <span class="n">A</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">X</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">i</span><span class="o">=</span><span class="mi">0</span>
    <span class="n">cost</span><span class="o">=</span><span class="mi">1</span>
    <span class="n">cost_old</span><span class="o">=</span><span class="mi">0</span>
    <span class="nb">iter</span><span class="o">=</span><span class="mi">0</span>
    <span class="n">corr_coeff</span><span class="o">=</span><span class="kc">None</span>
    <span class="n">lambd</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="nb">print</span> <span class="s2">&quot;Orthogonality check: &quot;</span><span class="p">,(</span><span class="n">src_hr</span><span class="p">[:,:,</span><span class="mi">0</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(),</span><span class="s2">&quot; &quot;</span><span class="p">,(</span><span class="n">src_hr</span><span class="p">[:,:,</span><span class="mi">1</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(),</span><span class="s2">&quot; &quot;</span><span class="p">,(</span><span class="n">src_hr</span><span class="p">[:,:,</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">src_hr</span><span class="p">[:,:,</span><span class="mi">1</span><span class="p">])</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    <span class="k">while</span> <span class="nb">iter</span><span class="o">&lt;</span><span class="n">nb_iter</span> <span class="ow">and</span> <span class="mi">100</span><span class="o">*</span><span class="nb">abs</span><span class="p">(</span><span class="n">cost</span><span class="o">-</span><span class="n">cost_old</span><span class="p">)</span><span class="o">/</span><span class="nb">abs</span><span class="p">(</span><span class="n">cost</span><span class="p">)</span><span class="o">&gt;</span><span class="n">tol</span> <span class="p">:</span>
        <span class="nb">iter</span><span class="o">+=</span><span class="mi">1</span>
        <span class="n">A</span><span class="p">,</span><span class="n">X</span><span class="p">,</span><span class="n">corr_coeff</span> <span class="o">=</span> <span class="n">proj_dict_equal_pos_dyks_stack</span><span class="p">(</span><span class="n">Atemp</span><span class="p">,</span><span class="n">Xtemp</span><span class="p">,</span><span class="n">src_hr</span><span class="p">,</span><span class="n">corr_coeff</span><span class="o">=</span><span class="n">corr_coeff</span><span class="p">,</span><span class="n">nb_iter</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span><span class="n">tol</span><span class="o">=</span><span class="mi">10</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mi">10</span><span class="p">))</span>
        <span class="n">Atemp</span> <span class="o">=</span> <span class="n">Atemp</span><span class="o">+</span><span class="n">lambd</span><span class="o">*</span><span class="p">(</span><span class="n">smoothing_prox</span><span class="p">(</span><span class="n">p_smth_mat_inv</span><span class="p">,</span><span class="mi">2</span><span class="o">*</span><span class="n">A</span><span class="o">-</span><span class="n">Atemp</span><span class="p">)</span><span class="o">-</span><span class="n">A</span><span class="p">)</span>
        <span class="n">Xtemp</span> <span class="o">=</span> <span class="n">Xtemp</span><span class="o">+</span><span class="n">lambd</span><span class="o">*</span><span class="p">(</span><span class="n">proj_sphere_decim_conv_stack</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">X</span><span class="o">-</span><span class="n">Xtemp</span><span class="p">,</span><span class="n">im</span><span class="p">,</span><span class="n">sqrt</span><span class="p">(</span><span class="n">rad</span><span class="p">),</span><span class="n">upfact</span><span class="p">,</span><span class="n">ker_in</span><span class="p">,</span><span class="n">ker_adj_in</span><span class="p">)</span><span class="o">-</span><span class="n">X</span><span class="p">)</span>
        <span class="c1"># Sanity check</span>
        <span class="n">cost_smooth</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">3</span><span class="p">]):</span>
            <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_neigh</span><span class="p">):</span>
                <span class="n">cost_smooth</span><span class="o">+=</span><span class="p">(((</span><span class="n">A</span><span class="p">[:,</span><span class="n">k</span><span class="p">]</span><span class="o">-</span><span class="n">A</span><span class="p">[:,</span><span class="n">tree</span><span class="p">[</span><span class="n">k</span><span class="p">,</span><span class="n">l</span><span class="p">]])</span><span class="o">*</span><span class="n">sqrt</span><span class="p">(</span><span class="n">weights</span><span class="p">[</span><span class="n">k</span><span class="p">,</span><span class="n">l</span><span class="p">,:]))</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="c1"># Objective value</span>
        <span class="n">temp1</span> <span class="o">=</span> <span class="n">im</span><span class="o">*</span><span class="mi">0</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">3</span><span class="p">]):</span>
            <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
                <span class="n">temp1</span><span class="p">[:,:,</span><span class="n">k</span><span class="p">]</span> <span class="o">+=</span><span class="n">A</span><span class="p">[</span><span class="n">l</span><span class="p">,</span><span class="n">k</span><span class="p">]</span><span class="o">*</span><span class="n">src_lr</span><span class="p">[:,:,</span><span class="n">l</span><span class="p">,</span><span class="n">k</span><span class="p">]</span>
        <span class="n">temp1</span><span class="o">-=</span><span class="n">im</span>
        <span class="c1"># Positivity check</span>
        <span class="n">temp2</span> <span class="o">=</span> <span class="n">X</span><span class="o">*</span><span class="mi">0</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">3</span><span class="p">]):</span>
            <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
                <span class="n">temp2</span><span class="p">[:,:,</span><span class="n">k</span><span class="p">]</span><span class="o">+=</span><span class="n">src_hr</span><span class="p">[:,:,</span><span class="n">l</span><span class="p">]</span><span class="o">*</span><span class="n">A</span><span class="p">[</span><span class="n">l</span><span class="p">,</span><span class="n">k</span><span class="p">]</span>
        <span class="n">cost_old</span> <span class="o">=</span> <span class="n">cost</span>
        <span class="n">cost</span> <span class="o">=</span> <span class="n">cost_smooth</span>
        <span class="nb">print</span> <span class="s2">&quot;residual: &quot;</span><span class="p">,(</span><span class="n">temp1</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(),</span><span class="s2">&quot; smoothness: &quot;</span><span class="p">,</span><span class="n">cost_smooth</span><span class="p">,</span><span class="s2">&quot; min val: &quot;</span><span class="p">,</span><span class="n">temp2</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">A</span>


<span class="k">def</span> <span class="nf">pt_wise_bound</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">a1</span><span class="p">,</span><span class="n">a2</span><span class="p">):</span>

    <span class="n">x_proj</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">i1</span> <span class="o">=</span> <span class="n">where</span><span class="p">(</span><span class="n">x</span><span class="o">&gt;</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">a1</span><span class="p">,</span><span class="n">a2</span><span class="p">))</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">))</span>
    <span class="n">i2</span> <span class="o">=</span> <span class="n">where</span><span class="p">(</span><span class="n">x</span><span class="o">&lt;</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span><span class="n">a1</span><span class="p">,</span><span class="n">a2</span><span class="p">))</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">))</span>
    <span class="n">i3</span> <span class="o">=</span> <span class="n">where</span><span class="p">(</span><span class="n">a1</span><span class="o">==</span><span class="n">a2</span><span class="p">)</span>
    <span class="n">x_proj</span><span class="p">[</span><span class="n">i1</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">a1</span><span class="p">[</span><span class="n">i1</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span><span class="n">a2</span><span class="p">[</span><span class="n">i1</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span>
    <span class="n">x_proj</span><span class="p">[</span><span class="n">i2</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span><span class="n">a1</span><span class="p">[</span><span class="n">i2</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span><span class="n">a2</span><span class="p">[</span><span class="n">i2</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span>
    <span class="n">x_proj</span><span class="p">[</span><span class="n">i3</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="n">a1</span><span class="p">[</span><span class="n">i3</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
    <span class="k">return</span> <span class="n">x_proj</span>

<span class="k">def</span> <span class="nf">grad_nn_unif_smooth</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">tree</span><span class="p">,</span><span class="n">weights</span><span class="p">,</span><span class="n">wsum</span><span class="p">):</span>
    <span class="n">grad</span> <span class="o">=</span> <span class="n">x</span><span class="o">*</span><span class="n">wsum</span>
    <span class="n">shap</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
        <span class="n">grad</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="n">weights</span><span class="p">[</span><span class="n">i</span><span class="p">,:]</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span> <span class="o">-</span> <span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">tree</span><span class="p">[</span><span class="n">i</span><span class="p">,:]]</span><span class="o">*</span><span class="n">weights</span><span class="p">[</span><span class="n">i</span><span class="p">,:])</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">grad</span>

<span class="k">def</span> <span class="nf">grad_nn_unif_smooth_imp</span><span class="p">(</span><span class="nb">input</span><span class="p">):</span>
    <span class="n">x</span> <span class="o">=</span> <span class="nb">input</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">tree</span> <span class="o">=</span> <span class="nb">input</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">weights</span> <span class="o">=</span> <span class="nb">input</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">wsum</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">weights</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">grad</span> <span class="o">=</span> <span class="n">grad_nn_unif_smooth</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">tree</span><span class="p">,</span><span class="n">weights</span><span class="p">,</span><span class="n">wsum</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">grad</span>



<span class="k">def</span> <span class="nf">proj_affine_pos</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">u</span><span class="p">):</span> <span class="c1"># Projects x onto the set {y,ak*y+uk&gt;=0, k=1..n}; a is entry-wise positive</span>
    <span class="n">proj</span><span class="o">=</span><span class="n">copy</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="nb">id</span> <span class="o">=</span> <span class="n">where</span><span class="p">(</span><span class="n">a</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">shap</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
            <span class="n">cons_vec</span> <span class="o">=</span> <span class="o">-</span><span class="n">u</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="nb">id</span><span class="p">]</span><span class="o">/</span><span class="n">a</span><span class="p">[</span><span class="nb">id</span><span class="p">]</span>
            <span class="n">proj</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">],</span><span class="n">cons_vec</span><span class="o">.</span><span class="n">max</span><span class="p">())</span>
    <span class="k">return</span> <span class="n">proj</span>

<span class="k">def</span> <span class="nf">proj_affine_pos2</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">u</span><span class="p">,</span><span class="n">min_val_map</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span> <span class="c1"># Projects x onto the set {y,ak*y+uk&gt;=min_val_map, k=1..n};</span>
    <span class="n">proj</span><span class="o">=</span><span class="n">copy</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">id1</span> <span class="o">=</span> <span class="n">where</span><span class="p">(</span><span class="n">a</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">id2</span> <span class="o">=</span> <span class="n">where</span><span class="p">(</span><span class="n">a</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">shap</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">c1</span> <span class="o">=</span> <span class="o">-</span><span class="mi">10</span><span class="o">**</span><span class="mi">15</span>
    <span class="n">c2</span> <span class="o">=</span> <span class="mi">10</span><span class="o">**</span><span class="mi">15</span>
    <span class="k">if</span> <span class="n">min_val_map</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">min_val_map</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
            <span class="k">if</span> <span class="n">size</span><span class="p">(</span><span class="n">id1</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
                <span class="n">cons_vec_pos</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="n">u</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">id1</span><span class="p">]</span><span class="o">+</span><span class="n">min_val_map</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">])</span><span class="o">/</span><span class="n">a</span><span class="p">[</span><span class="n">id1</span><span class="p">]</span>
                <span class="n">c1</span> <span class="o">=</span> <span class="n">cons_vec_pos</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">size</span><span class="p">(</span><span class="n">id2</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
                <span class="n">cons_vec_neg</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="n">u</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">id2</span><span class="p">]</span><span class="o">+</span><span class="n">min_val_map</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">])</span><span class="o">/</span><span class="n">a</span><span class="p">[</span><span class="n">id2</span><span class="p">]</span>
                <span class="n">c2</span> <span class="o">=</span> <span class="n">cons_vec_neg</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span><span class="o">&lt;=</span><span class="n">c1</span><span class="p">:</span>
                <span class="n">proj</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span><span class="o">=</span><span class="n">c1</span>
            <span class="k">elif</span> <span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span><span class="o">&gt;=</span><span class="n">c2</span><span class="p">:</span>
                <span class="n">proj</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span><span class="o">=</span><span class="n">c2</span>
    <span class="k">return</span> <span class="n">proj</span>

<div class="viewcode-block" id="pow_law_select"><a class="viewcode-back" href="../optim_utils.html#optim_utils.pow_law_select">[docs]</a><span class="k">def</span> <span class="nf">pow_law_select</span><span class="p">(</span><span class="n">dist_weights</span><span class="p">,</span><span class="n">nb_neigh</span><span class="p">,</span><span class="n">min_val</span><span class="o">=</span><span class="mi">10</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mi">15</span><span class="p">)):</span>
    <span class="sd">&quot;&quot;&quot; **[???] but related to proximity constrains hyperparameters**</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">a</span> <span class="o">=</span> <span class="n">dist_weights</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="n">dist_weights</span><span class="p">[:,</span><span class="n">nb_neigh</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">r_med</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
    <span class="nb">print</span> <span class="s2">&quot;r_med: &quot;</span><span class="p">,</span><span class="n">r_med</span><span class="p">,</span><span class="n">nb_neigh</span>
    <span class="n">p</span> <span class="o">=</span> <span class="n">log</span><span class="p">(</span><span class="n">min_val</span><span class="p">)</span><span class="o">/</span><span class="n">log</span><span class="p">(</span><span class="n">r_med</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">p</span></div>

<span class="k">def</span> <span class="nf">low_rank_comp_wise</span><span class="p">(</span><span class="n">psf_stack</span><span class="p">,</span><span class="n">upfact</span><span class="p">,</span><span class="n">shifts</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">nb_iter</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span><span class="n">nb_subiter</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span><span class="n">nb_subiter_min</span><span class="o">=</span><span class="mi">7</span><span class="p">,</span><span class="n">mu</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span><span class="n">nb_comp_max</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span><span class="n">tol</span><span class="o">=</span><span class="mf">0.1</span><span class="p">):</span>

    <span class="k">if</span> <span class="n">shifts</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">shifts</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">shift_est</span><span class="p">(</span><span class="n">psf_stack</span><span class="p">)</span><span class="o">*</span><span class="n">upfact</span>
    <span class="n">shift_ker_stack</span><span class="p">,</span><span class="n">shift_ker_stack_adj</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">shift_ker_stack</span><span class="p">(</span><span class="n">shifts</span><span class="p">,</span><span class="n">upfact</span><span class="p">)</span>
    <span class="n">shap</span> <span class="o">=</span> <span class="n">psf_stack</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">weights</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">nb_comp_max</span><span class="p">))</span>
    <span class="n">comp</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">upfact</span><span class="o">*</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">upfact</span><span class="o">*</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">nb_comp_max</span><span class="p">))</span>
    <span class="nb">input</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">upfact</span><span class="o">*</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">upfact</span><span class="o">*</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
    <span class="nb">input</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="nb">input</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">upfact</span><span class="p">)</span>
    <span class="nb">input</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">shift_ker_stack</span><span class="p">)</span>
    <span class="nb">input</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">shift_ker_stack_adj</span><span class="p">)</span>
    <span class="n">w</span> <span class="o">=</span> <span class="n">ones</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">],))</span>
    <span class="n">im_hr</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">upfact</span><span class="o">*</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">upfact</span><span class="o">*</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>
    <span class="nb">input</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">w</span><span class="p">)</span>
    <span class="n">siz_in</span> <span class="o">=</span> <span class="n">upfact</span><span class="o">*</span><span class="n">array</span><span class="p">(</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">eig_init</span><span class="p">,</span><span class="n">spec_rad_init</span> <span class="o">=</span> <span class="n">pow_meth</span><span class="p">(</span><span class="n">sr_op_trans_stack</span><span class="p">,</span><span class="nb">input</span><span class="p">,</span><span class="n">siz_in</span><span class="p">)</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">psf_stack</span><span class="p">)</span>
    <span class="n">comp_lr</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">psf_stack</span><span class="p">)</span>
    <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">buff</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">nb_subiter_min</span><span class="p">))</span>
    <span class="n">comp_var</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">nb_comp_max</span><span class="p">,))</span>
    <span class="k">while</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">nb_comp_max</span> <span class="ow">and</span> <span class="n">w</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
        <span class="n">w</span> <span class="o">=</span> <span class="n">ones</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">],))</span>
        <span class="n">spec_rad</span> <span class="o">=</span> <span class="n">spec_rad_init</span>
        <span class="n">eig</span> <span class="o">=</span> <span class="n">eig_init</span>
        <span class="n">resk</span> <span class="o">=</span> <span class="n">res</span><span class="o">*</span><span class="mi">0</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_iter</span><span class="p">):</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">comp</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">])</span>
            <span class="n">t</span><span class="o">=</span><span class="mi">1</span>
            <span class="c1"># kth component estimation</span>
            <span class="n">cur_res</span><span class="o">=</span><span class="mi">100</span>
            <span class="n">res_old</span><span class="o">=</span><span class="mi">1</span>
            <span class="n">j</span><span class="o">=</span><span class="mi">0</span>
            <span class="k">while</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">nb_subiter</span> <span class="ow">and</span> <span class="mi">100</span><span class="o">*</span><span class="nb">abs</span><span class="p">(</span><span class="n">cur_res</span><span class="o">-</span><span class="n">res_old</span><span class="p">)</span><span class="o">/</span><span class="n">res_old</span><span class="o">&gt;</span><span class="mf">0.1</span><span class="p">:</span>

                <span class="n">res_old</span> <span class="o">=</span> <span class="n">cur_res</span>
                <span class="c1"># Gradient computation</span>
                <span class="n">grad</span> <span class="o">=</span> <span class="n">x</span><span class="o">*</span><span class="mi">0</span>
                <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
                    <span class="n">resk</span><span class="p">[:,:,</span><span class="n">l</span><span class="p">]</span> <span class="o">=</span> <span class="n">res</span><span class="p">[:,:,</span><span class="n">l</span><span class="p">]</span><span class="o">-</span><span class="n">w</span><span class="p">[</span><span class="n">l</span><span class="p">]</span><span class="o">*</span><span class="n">utils</span><span class="o">.</span><span class="n">decim</span><span class="p">(</span><span class="n">scisig</span><span class="o">.</span><span class="n">fftconvolve</span><span class="p">(</span><span class="n">comp</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">],</span><span class="n">shift_ker_stack</span><span class="p">[:,:,</span><span class="n">l</span><span class="p">],</span><span class="n">mode</span><span class="o">=</span><span class="s1">&#39;same&#39;</span><span class="p">),</span><span class="n">upfact</span><span class="p">,</span><span class="n">av_en</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                    <span class="n">grad</span> <span class="o">=</span> <span class="n">grad</span> <span class="o">-</span><span class="n">w</span><span class="p">[</span><span class="n">l</span><span class="p">]</span><span class="o">*</span><span class="n">scisig</span><span class="o">.</span><span class="n">convolve</span><span class="p">(</span><span class="n">utils</span><span class="o">.</span><span class="n">transpose_decim</span><span class="p">(</span><span class="n">resk</span><span class="p">[:,:,</span><span class="n">l</span><span class="p">],</span><span class="n">upfact</span><span class="p">),</span><span class="n">shift_ker_stack_adj</span><span class="p">[:,:,</span><span class="n">l</span><span class="p">],</span><span class="n">mode</span><span class="o">=</span><span class="s1">&#39;same&#39;</span><span class="p">)</span>

                <span class="n">buff</span><span class="p">[</span><span class="n">j</span><span class="o">%</span><span class="n">nb_subiter_min</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">resk</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>

                <span class="nb">print</span> <span class="s2">&quot;mse: &quot;</span><span class="p">,</span> <span class="n">buff</span><span class="p">[</span><span class="n">j</span><span class="o">%</span><span class="n">nb_subiter_min</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">j</span><span class="o">&gt;=</span><span class="n">nb_subiter_min</span><span class="p">:</span>
                    <span class="n">cur_res</span> <span class="o">=</span> <span class="n">buff</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">cur_res</span> <span class="o">=</span> <span class="n">buff</span><span class="p">[</span><span class="n">j</span><span class="o">%</span><span class="n">nb_subiter_min</span><span class="p">]</span>

                <span class="n">y</span> <span class="o">=</span> <span class="n">comp</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">mu</span><span class="o">*</span><span class="n">grad</span><span class="o">/</span><span class="n">spec_rad</span>
                <span class="c1"># Positivity constraint</span>
                <span class="n">xnew</span> <span class="o">=</span> <span class="n">proj_affine_pos</span><span class="p">(</span><span class="n">y</span><span class="p">,</span><span class="n">w</span><span class="p">,</span><span class="n">im_hr</span><span class="p">)</span>
                <span class="c1">#xnew = pos_proj_mat(y)</span>
                <span class="n">tnew</span>  <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">4</span><span class="o">*</span><span class="n">t</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span><span class="o">/</span><span class="mi">2</span>
                <span class="n">lambd</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">+</span> <span class="p">(</span><span class="n">t</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="n">tnew</span>
                <span class="n">t</span> <span class="o">=</span> <span class="n">tnew</span>
                <span class="c1"># Acceleration</span>
                <span class="n">comp</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">x</span><span class="o">+</span><span class="n">lambd</span><span class="o">*</span><span class="p">(</span><span class="n">xnew</span><span class="o">-</span><span class="n">x</span><span class="p">)</span>
                <span class="n">x</span> <span class="o">=</span> <span class="n">xnew</span>
                <span class="n">j</span><span class="o">+=</span><span class="mi">1</span>
            <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
                <span class="n">comp_lr</span><span class="p">[:,:,</span><span class="n">l</span><span class="p">]</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">decim</span><span class="p">(</span><span class="n">scisig</span><span class="o">.</span><span class="n">fftconvolve</span><span class="p">(</span><span class="n">comp</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">],</span><span class="n">shift_ker_stack</span><span class="p">[:,:,</span><span class="n">l</span><span class="p">],</span><span class="n">mode</span><span class="o">=</span><span class="s1">&#39;same&#39;</span><span class="p">),</span><span class="n">upfact</span><span class="p">,</span><span class="n">av_en</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

            <span class="c1"># kth component estimation coeff estimation</span>
            <span class="n">w</span> <span class="o">=</span> <span class="n">pos_proj</span><span class="p">(</span><span class="n">lsq_coeff_stack</span><span class="p">(</span><span class="n">comp_lr</span><span class="p">,</span><span class="n">res</span><span class="p">))</span>
            <span class="nb">print</span> <span class="s2">&quot;weights: &quot;</span><span class="p">,</span><span class="n">w</span>
            <span class="nb">input</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">=</span><span class="n">w</span>
            <span class="n">eig</span><span class="p">,</span><span class="n">spec_rad</span> <span class="o">=</span> <span class="n">pow_meth</span><span class="p">(</span><span class="n">sr_op_trans_stack</span><span class="p">,</span><span class="nb">input</span><span class="p">,</span><span class="n">siz_in</span><span class="p">,</span><span class="n">ainit</span><span class="o">=</span><span class="n">eig</span><span class="p">)</span>
        <span class="n">comp_var</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">std</span><span class="p">(</span><span class="n">w</span><span class="p">)</span><span class="o">*</span><span class="n">sqrt</span><span class="p">(((</span><span class="n">comp</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span>
        <span class="nb">print</span> <span class="s2">&quot;---------- &quot;</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="s2">&quot;th component variability ----------- :&quot;</span><span class="p">,</span><span class="n">comp_var</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="c1"># Residual update and HR images update</span>
        <span class="k">if</span> <span class="n">w</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
                <span class="n">res</span><span class="p">[:,:,</span><span class="n">l</span><span class="p">]</span> <span class="o">=</span> <span class="n">res</span><span class="p">[:,:,</span><span class="n">l</span><span class="p">]</span><span class="o">-</span><span class="n">w</span><span class="p">[</span><span class="n">l</span><span class="p">]</span><span class="o">*</span><span class="n">utils</span><span class="o">.</span><span class="n">decim</span><span class="p">(</span><span class="n">scisig</span><span class="o">.</span><span class="n">fftconvolve</span><span class="p">(</span><span class="n">comp</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">],</span><span class="n">shift_ker_stack</span><span class="p">[:,:,</span><span class="n">l</span><span class="p">],</span><span class="n">mode</span><span class="o">=</span><span class="s1">&#39;same&#39;</span><span class="p">),</span><span class="n">upfact</span><span class="p">,</span><span class="n">av_en</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                <span class="n">im_hr</span><span class="p">[:,:,</span><span class="n">l</span><span class="p">]</span> <span class="o">=</span> <span class="n">im_hr</span><span class="p">[:,:,</span><span class="n">l</span><span class="p">]</span><span class="o">+</span><span class="n">w</span><span class="p">[</span><span class="n">l</span><span class="p">]</span><span class="o">*</span><span class="n">comp</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">]</span>
            <span class="n">weights</span><span class="p">[:,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">w</span>
        <span class="n">i</span><span class="o">+=</span><span class="mi">1</span>

    <span class="k">return</span> <span class="n">im_hr</span><span class="p">,</span><span class="n">comp</span><span class="p">,</span><span class="n">weights</span><span class="p">,</span><span class="n">res</span>



<span class="k">def</span> <span class="nf">low_rank_comp_wise_sparse</span><span class="p">(</span><span class="n">psf_stack</span><span class="p">,</span><span class="n">upfact</span><span class="p">,</span><span class="n">opt</span><span class="p">,</span><span class="n">nsig</span><span class="p">,</span><span class="n">shifts</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">nb_iter</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span><span class="n">nb_subiter</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span><span class="n">nb_subiter_min</span><span class="o">=</span><span class="mi">7</span><span class="p">,</span><span class="n">mu</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span><span class="n">nb_comp_max</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span><span class="n">tol</span><span class="o">=</span><span class="mf">0.1</span><span class="p">):</span>

    <span class="k">if</span> <span class="n">shifts</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">shifts</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">shift_est</span><span class="p">(</span><span class="n">psf_stack</span><span class="p">)</span><span class="o">*</span><span class="n">upfact</span>
    <span class="n">shift_ker_stack</span><span class="p">,</span><span class="n">shift_ker_stack_adj</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">shift_ker_stack</span><span class="p">(</span><span class="n">shifts</span><span class="p">,</span><span class="n">upfact</span><span class="p">)</span>
    <span class="n">shap</span> <span class="o">=</span> <span class="n">psf_stack</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">weights</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">nb_comp_max</span><span class="p">))</span>
    <span class="n">comp</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">upfact</span><span class="o">*</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">upfact</span><span class="o">*</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">nb_comp_max</span><span class="p">))</span>
    <span class="nb">input</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">upfact</span><span class="o">*</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">upfact</span><span class="o">*</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
    <span class="nb">input</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="nb">input</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">upfact</span><span class="p">)</span>
    <span class="nb">input</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">shift_ker_stack</span><span class="p">)</span>
    <span class="nb">input</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">shift_ker_stack_adj</span><span class="p">)</span>
    <span class="n">w</span> <span class="o">=</span> <span class="n">ones</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">],))</span>
    <span class="n">im_hr</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">upfact</span><span class="o">*</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">upfact</span><span class="o">*</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>
    <span class="nb">input</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">w</span><span class="p">)</span>
    <span class="n">input_trans</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="nb">input</span><span class="p">)</span>


    <span class="n">siz_in</span> <span class="o">=</span> <span class="n">upfact</span><span class="o">*</span><span class="n">array</span><span class="p">(</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">eig_max</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">eig_min_init</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">eig_vect_min</span><span class="p">,</span><span class="n">gam</span> <span class="o">=</span> <span class="n">min_eig_val</span><span class="p">(</span><span class="n">sr_op_trans_stack</span><span class="p">,</span><span class="nb">input</span><span class="p">,</span><span class="n">siz_in</span><span class="p">,</span><span class="n">eig_max</span><span class="o">=</span><span class="n">eig_max</span><span class="p">,</span><span class="n">eig_min_init</span><span class="o">=</span><span class="n">eig_min_init</span><span class="p">)</span>
    <span class="n">eig_min_init</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">eig_vect_min</span><span class="p">)</span>



    <span class="c1"># Accelerated Chamb-Pock variables</span>
    <span class="n">comp</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">upfact</span><span class="o">*</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">upfact</span><span class="o">*</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">nb_comp_max</span><span class="p">))</span> <span class="c1"># Main variable</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">upfact</span><span class="o">*</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">upfact</span><span class="o">*</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span> <span class="c1"># Primal variable</span>
    <span class="n">xold</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">upfact</span><span class="o">*</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">upfact</span><span class="o">*</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
    <span class="n">u</span><span class="p">,</span><span class="n">mr_file</span> <span class="o">=</span> <span class="n">isap</span><span class="o">.</span><span class="n">mr_trans</span><span class="p">(</span><span class="n">comp</span><span class="p">[:,:,</span><span class="mi">0</span><span class="p">],</span><span class="n">opt</span><span class="o">=</span><span class="n">opt</span><span class="p">)</span> <span class="c1"># First dual variable</span>
    <span class="n">u</span> <span class="o">=</span> <span class="n">u</span><span class="o">*</span><span class="mi">0</span>
    <span class="n">v</span> <span class="o">=</span> <span class="mi">0</span><span class="o">*</span><span class="n">comp</span><span class="p">[:,:,</span><span class="mi">0</span><span class="p">]</span> <span class="c1"># Second dual variable</span>
    <span class="n">grad</span> <span class="o">=</span> <span class="n">x</span><span class="o">*</span><span class="mi">0</span>

    <span class="n">shap2</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">weights_sp</span> <span class="o">=</span> <span class="n">ones</span><span class="p">((</span><span class="n">shap2</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">shap2</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">shap2</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">psf_stack</span><span class="p">)</span>
    <span class="n">comp_lr</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">psf_stack</span><span class="p">)</span>
    <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">buff</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">nb_subiter_min</span><span class="p">))</span>
    <span class="n">comp_var</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">nb_comp_max</span><span class="p">,))</span>
    <span class="n">rho</span> <span class="o">=</span> <span class="mf">0.9</span> <span class="c1"># to*rho&lt;L**2</span>
    <span class="n">to</span> <span class="o">=</span> <span class="mf">0.9</span>
    <span class="n">to_old</span> <span class="o">=</span> <span class="n">ones</span><span class="p">((</span><span class="mi">2</span><span class="p">,))</span><span class="o">*</span><span class="n">to</span>
    <span class="n">theta</span><span class="o">=</span><span class="mf">0.8</span>
    <span class="n">input_trans</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">to</span><span class="p">)</span>

    <span class="n">input_trans_prox</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">input_trans</span><span class="p">)</span>
    <span class="n">input_trans_prox</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">copy</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
    <span class="n">input_trans_prox</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">copy</span><span class="p">(</span><span class="n">psf_stack</span><span class="p">))</span>

    <span class="n">nb_iter_noisest</span> <span class="o">=</span> <span class="mi">20</span>

    <span class="n">thresh_type</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">tol_conj_grad</span><span class="o">=</span><span class="mi">10</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mi">10</span><span class="p">)</span>
    <span class="k">while</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">nb_comp_max</span> <span class="ow">and</span> <span class="n">w</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">i</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">tol_conj_grad</span> <span class="o">=</span> <span class="mi">10</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mi">10</span><span class="p">)</span>
        <span class="n">w</span> <span class="o">=</span> <span class="n">ones</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">],))</span>
        <span class="c1">#spec_rad = spec_rad_init</span>
        <span class="c1">#eig = eig_init</span>
        <span class="n">resk</span> <span class="o">=</span> <span class="n">res</span><span class="o">*</span><span class="mi">0</span>
        <span class="n">input_trans_prox</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>
        <span class="n">weights_sp</span> <span class="o">=</span> <span class="n">ones</span><span class="p">((</span><span class="n">shap2</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">shap2</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">shap2</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>
        <span class="nb">input</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">=</span><span class="n">w</span>
        <span class="n">input_trans</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">=</span><span class="n">w</span>
        <span class="n">input_trans_prox</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">=</span><span class="n">w</span>

        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_iter</span><span class="p">):</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">comp</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">])</span>
            <span class="n">t</span><span class="o">=</span><span class="mi">1</span>
            <span class="c1"># kth component estimation</span>
            <span class="n">cur_res</span><span class="o">=</span><span class="mi">100</span>
            <span class="n">res_old</span><span class="o">=</span><span class="mi">1</span>
            <span class="n">j</span><span class="o">=</span><span class="mi">0</span>
            <span class="k">while</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">nb_subiter</span> <span class="ow">and</span> <span class="mi">100</span><span class="o">*</span><span class="nb">abs</span><span class="p">(</span><span class="n">cur_res</span><span class="o">-</span><span class="n">res_old</span><span class="p">)</span><span class="o">/</span><span class="n">res_old</span><span class="o">&gt;</span><span class="mf">0.1</span><span class="p">:</span>
                <span class="n">res_old</span> <span class="o">=</span> <span class="n">cur_res</span>
                <span class="c1"># Residual computation</span>
                <span class="n">grad</span> <span class="o">=</span> <span class="mi">0</span><span class="o">*</span><span class="n">grad</span>
                <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
                    <span class="n">resk</span><span class="p">[:,:,</span><span class="n">l</span><span class="p">]</span> <span class="o">=</span> <span class="n">res</span><span class="p">[:,:,</span><span class="n">l</span><span class="p">]</span><span class="o">-</span><span class="n">w</span><span class="p">[</span><span class="n">l</span><span class="p">]</span><span class="o">*</span><span class="n">utils</span><span class="o">.</span><span class="n">decim</span><span class="p">(</span><span class="n">scisig</span><span class="o">.</span><span class="n">fftconvolve</span><span class="p">(</span><span class="n">comp</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">],</span><span class="n">shift_ker_stack</span><span class="p">[:,:,</span><span class="n">l</span><span class="p">],</span><span class="n">mode</span><span class="o">=</span><span class="s1">&#39;same&#39;</span><span class="p">),</span><span class="n">upfact</span><span class="p">,</span><span class="n">av_en</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                    <span class="n">grad</span> <span class="o">=</span> <span class="n">grad</span> <span class="o">-</span><span class="n">w</span><span class="p">[</span><span class="n">l</span><span class="p">]</span><span class="o">*</span><span class="n">scisig</span><span class="o">.</span><span class="n">convolve</span><span class="p">(</span><span class="n">utils</span><span class="o">.</span><span class="n">transpose_decim</span><span class="p">(</span><span class="n">resk</span><span class="p">[:,:,</span><span class="n">l</span><span class="p">],</span><span class="n">upfact</span><span class="p">),</span><span class="n">shift_ker_stack_adj</span><span class="p">[:,:,</span><span class="n">l</span><span class="p">],</span><span class="n">mode</span><span class="o">=</span><span class="s1">&#39;same&#39;</span><span class="p">)</span>

                <span class="c1"># Noise estimation</span>
                <span class="n">input_trans</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="n">to_old</span><span class="p">[</span><span class="n">k</span><span class="o">%</span><span class="mi">2</span><span class="p">]</span>
                <span class="n">input_trans</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">grad</span><span class="p">)</span>
                <span class="n">noise_vect_1</span> <span class="o">=</span> <span class="n">sr_op_trans_stack_translate_inv</span><span class="p">(</span><span class="n">input_trans</span><span class="p">,</span><span class="n">nb_iter_noisest</span><span class="p">)</span>
                <span class="n">sig_map</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">res_sig_map</span><span class="p">(</span><span class="n">noise_vect_1</span><span class="o">*</span><span class="n">to_old</span><span class="p">[</span><span class="n">k</span><span class="o">%</span><span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="n">rho</span><span class="p">,</span><span class="n">opt</span><span class="o">=</span><span class="n">opt</span><span class="p">)</span>
                <span class="n">thresh_map</span> <span class="o">=</span> <span class="n">nsig</span><span class="o">*</span><span class="n">sig_map</span>

                <span class="c1"># Dual variables update</span>
                <span class="c1"># Positivity</span>
                <span class="n">t1</span> <span class="o">=</span> <span class="n">v</span><span class="o">+</span><span class="n">rho</span><span class="o">*</span><span class="n">comp</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">]</span>
                <span class="n">v</span> <span class="o">=</span> <span class="n">t1</span><span class="o">-</span><span class="n">rho</span><span class="o">*</span><span class="n">proj_affine_pos</span><span class="p">(</span><span class="n">t1</span><span class="o">/</span><span class="n">rho</span><span class="p">,</span><span class="n">w</span><span class="p">,</span><span class="n">im_hr</span><span class="p">)</span>
                <span class="c1"># Sparsity</span>
                <span class="n">t2</span><span class="p">,</span><span class="n">mr_file</span> <span class="o">=</span> <span class="n">isap</span><span class="o">.</span><span class="n">mr_trans</span><span class="p">(</span><span class="n">comp</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">],</span><span class="n">opt</span><span class="o">=</span><span class="n">opt</span><span class="p">)</span>
                <span class="n">t3</span> <span class="o">=</span> <span class="n">u</span><span class="o">+</span><span class="n">rho</span><span class="o">*</span><span class="n">t2</span>
                <span class="n">u</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">l_inf_ball_proj_3D</span><span class="p">(</span><span class="n">t3</span><span class="p">,</span><span class="n">thresh_map</span><span class="o">*</span><span class="n">weights_sp</span><span class="p">,</span><span class="n">thresh_type</span><span class="p">)</span>

                <span class="c1"># Primal variable update</span>
                <span class="n">t4</span> <span class="o">=</span> <span class="n">isap</span><span class="o">.</span><span class="n">mr_recons_coeff</span><span class="p">(</span><span class="n">u</span><span class="p">,</span><span class="n">mr_file</span><span class="p">)</span><span class="o">+</span><span class="n">v</span>
                <span class="n">t5</span> <span class="o">=</span> <span class="n">x</span> <span class="o">-</span> <span class="n">to_old</span><span class="p">[(</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">%</span><span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="n">t4</span>
                <span class="n">xold</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
                <span class="n">input_trans_prox</span><span class="p">[</span><span class="o">-</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">to_old</span><span class="p">[(</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">%</span><span class="mi">2</span><span class="p">]</span>
                <span class="n">input_trans_prox</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">t5</span>
                <span class="c1"># Ref value</span>
                <span class="n">prox_cost</span><span class="o">=</span><span class="mi">0</span>
                <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
                    <span class="n">prox_cost</span> <span class="o">=</span> <span class="n">prox_cost</span> <span class="o">+</span> <span class="p">((</span><span class="n">res</span><span class="p">[:,:,</span><span class="n">l</span><span class="p">]</span><span class="o">-</span><span class="n">w</span><span class="p">[</span><span class="n">l</span><span class="p">]</span><span class="o">*</span><span class="n">utils</span><span class="o">.</span><span class="n">decim</span><span class="p">(</span><span class="n">scisig</span><span class="o">.</span><span class="n">fftconvolve</span><span class="p">(</span><span class="n">t5</span><span class="p">,</span><span class="n">shift_ker_stack</span><span class="p">[:,:,</span><span class="n">l</span><span class="p">],</span><span class="n">mode</span><span class="o">=</span><span class="s1">&#39;same&#39;</span><span class="p">),</span><span class="n">upfact</span><span class="p">,</span><span class="n">av_en</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
                <span class="nb">print</span> <span class="s2">&quot;ref prox cost value: &quot;</span><span class="p">,</span><span class="n">to_old</span><span class="p">[(</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">%</span><span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="n">prox_cost</span>
                <span class="n">x</span> <span class="o">=</span> <span class="n">sr_op_trans_stack_prox</span><span class="p">(</span><span class="n">input_trans_prox</span><span class="p">,</span><span class="n">nb_iter_noisest</span><span class="p">,</span><span class="n">tol</span><span class="o">=</span><span class="n">tol_conj_grad</span><span class="p">)</span>
                <span class="c1"># Optimal value</span>
                <span class="n">prox_opt</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
                    <span class="n">prox_cost</span> <span class="o">=</span> <span class="n">prox_cost</span> <span class="o">+</span> <span class="p">((</span><span class="n">res</span><span class="p">[:,:,</span><span class="n">l</span><span class="p">]</span><span class="o">-</span><span class="n">w</span><span class="p">[</span><span class="n">l</span><span class="p">]</span><span class="o">*</span><span class="n">utils</span><span class="o">.</span><span class="n">decim</span><span class="p">(</span><span class="n">scisig</span><span class="o">.</span><span class="n">fftconvolve</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">shift_ker_stack</span><span class="p">[:,:,</span><span class="n">l</span><span class="p">],</span><span class="n">mode</span><span class="o">=</span><span class="s1">&#39;same&#39;</span><span class="p">),</span><span class="n">upfact</span><span class="p">,</span><span class="n">av_en</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
                <span class="nb">print</span> <span class="s2">&quot;optimal prox cost value: &quot;</span><span class="p">,</span><span class="n">to_old</span><span class="p">[(</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">%</span><span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="n">prox_cost</span><span class="o">+</span><span class="p">((</span><span class="n">x</span><span class="o">-</span><span class="n">t5</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>

                <span class="c1"># Hyper parameters update</span>
                <span class="c1">#theta = 1.0/sqrt(1+2*gam*to_old[(k+1)%2])</span>
                <span class="c1">#to_old[k%2] = theta*to_old[(k+1)%2]</span>
                <span class="c1">#rho = rho/theta</span>

                <span class="c1"># Acceleration</span>
                <span class="n">comp</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">x</span><span class="o">+</span><span class="n">theta</span><span class="o">*</span><span class="p">(</span><span class="n">x</span><span class="o">-</span><span class="n">xold</span><span class="p">)</span>
                <span class="n">j</span><span class="o">+=</span><span class="mi">1</span>



            <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
                <span class="n">comp_lr</span><span class="p">[:,:,</span><span class="n">l</span><span class="p">]</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">decim</span><span class="p">(</span><span class="n">scisig</span><span class="o">.</span><span class="n">fftconvolve</span><span class="p">(</span><span class="n">comp</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">],</span><span class="n">shift_ker_stack</span><span class="p">[:,:,</span><span class="n">l</span><span class="p">],</span><span class="n">mode</span><span class="o">=</span><span class="s1">&#39;same&#39;</span><span class="p">),</span><span class="n">upfact</span><span class="p">,</span><span class="n">av_en</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

            <span class="c1"># kth component estimation coeff estimation</span>
            <span class="n">w</span> <span class="o">=</span> <span class="n">lsq_coeff_stack</span><span class="p">(</span><span class="n">comp_lr</span><span class="p">,</span><span class="n">res</span><span class="p">)</span>
            <span class="nb">print</span> <span class="s2">&quot;weights: &quot;</span><span class="p">,</span><span class="n">w</span>
            <span class="nb">input</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">=</span><span class="n">w</span>
            <span class="n">eig_vect_min</span><span class="p">,</span><span class="n">gam</span> <span class="o">=</span> <span class="n">min_eig_val</span><span class="p">(</span><span class="n">sr_op_trans_stack</span><span class="p">,</span><span class="nb">input</span><span class="p">,</span><span class="n">siz_in</span><span class="p">,</span><span class="n">eig_max</span><span class="o">=</span><span class="n">eig_max</span><span class="p">,</span><span class="n">eig_min_init</span><span class="o">=</span><span class="n">eig_min_init</span><span class="p">)</span>
            <span class="n">eig_min_init</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">eig_vect_min</span><span class="p">)</span>
            <span class="n">input_trans</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">=</span><span class="n">w</span>
            <span class="n">input_trans_prox</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">=</span><span class="n">w</span>
            <span class="c1"># Reweighting</span>
            <span class="n">coeffx</span><span class="p">,</span><span class="n">mr_file</span> <span class="o">=</span> <span class="n">isap</span><span class="o">.</span><span class="n">mr_trans</span><span class="p">(</span><span class="n">comp</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">],</span><span class="n">opt</span><span class="o">=</span><span class="n">opt</span><span class="p">)</span>
            <span class="n">weights_sp</span>  <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="nb">abs</span><span class="p">(</span><span class="n">coeffx</span><span class="p">[:,:,:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span><span class="o">/</span><span class="p">(</span><span class="n">nsig</span><span class="o">*</span><span class="n">sig_map</span><span class="p">))</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>

        <span class="n">comp_var</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">std</span><span class="p">(</span><span class="n">w</span><span class="p">)</span><span class="o">*</span><span class="n">sqrt</span><span class="p">(((</span><span class="n">comp</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span>
        <span class="c1">#print &quot;---------- &quot;,i,&quot;th component variability ----------- :&quot;,comp_var[i]</span>
        <span class="c1"># Residual update and HR images update</span>
        <span class="k">if</span> <span class="n">w</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
                <span class="n">res</span><span class="p">[:,:,</span><span class="n">l</span><span class="p">]</span> <span class="o">=</span> <span class="n">res</span><span class="p">[:,:,</span><span class="n">l</span><span class="p">]</span><span class="o">-</span><span class="n">w</span><span class="p">[</span><span class="n">l</span><span class="p">]</span><span class="o">*</span><span class="n">utils</span><span class="o">.</span><span class="n">decim</span><span class="p">(</span><span class="n">scisig</span><span class="o">.</span><span class="n">fftconvolve</span><span class="p">(</span><span class="n">comp</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">],</span><span class="n">shift_ker_stack</span><span class="p">[:,:,</span><span class="n">l</span><span class="p">],</span><span class="n">mode</span><span class="o">=</span><span class="s1">&#39;same&#39;</span><span class="p">),</span><span class="n">upfact</span><span class="p">,</span><span class="n">av_en</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                <span class="n">im_hr</span><span class="p">[:,:,</span><span class="n">l</span><span class="p">]</span> <span class="o">=</span> <span class="n">im_hr</span><span class="p">[:,:,</span><span class="n">l</span><span class="p">]</span><span class="o">+</span><span class="n">w</span><span class="p">[</span><span class="n">l</span><span class="p">]</span><span class="o">*</span><span class="n">comp</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">]</span>
            <span class="n">weights</span><span class="p">[:,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">w</span>
        <span class="n">i</span><span class="o">+=</span><span class="mi">1</span>

    <span class="k">return</span> <span class="n">im_hr</span><span class="p">,</span><span class="n">comp</span><span class="p">,</span><span class="n">weights</span><span class="p">,</span><span class="n">res</span>


<span class="k">def</span> <span class="nf">low_rank_comp_wise_sparse_dist</span><span class="p">(</span><span class="n">psf_stack_in</span><span class="p">,</span><span class="n">field_dist</span><span class="p">,</span><span class="n">upfact</span><span class="p">,</span><span class="n">opt</span><span class="p">,</span><span class="n">nsig</span><span class="p">,</span><span class="n">neigh_frac</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span><span class="n">dist_weight_deg</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">shifts</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">opt_shift_est</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">nsig_shift_est</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">sig_est</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">flux_est</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">nb_iter</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span><span class="n">nb_subiter</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span><span class="n">nb_subiter_min</span><span class="o">=</span><span class="mi">7</span><span class="p">,</span><span class="n">mu</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span><span class="n">nb_comp_max</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span><span class="n">tol</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span><span class="n">wvl_transp_cor</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">accel_en</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">decay_fact</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
    <span class="n">psf_stack</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">psf_stack_in</span><span class="p">)</span>

    <span class="c1"># Degradation operator parameters estimation</span>
    <span class="k">if</span> <span class="n">shifts</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1">#shifts = utils.shift_est(psf_stack)*upfact</span>
        <span class="n">shifts</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">wvl_shift_est</span><span class="p">(</span><span class="n">psf_stack</span><span class="p">,</span><span class="n">opt_shift_est</span><span class="p">,</span><span class="n">nsig_shift_est</span><span class="p">)</span><span class="o">*</span><span class="n">upfact</span>
    <span class="n">shift_ker_stack</span><span class="p">,</span><span class="n">shift_ker_stack_adj</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">shift_ker_stack</span><span class="p">(</span><span class="n">shifts</span><span class="p">,</span><span class="n">upfact</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">sig_est</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">sig_est</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">im_gauss_nois_est_cube</span><span class="p">(</span><span class="n">psf_stack_in</span><span class="p">,</span><span class="n">opt</span><span class="o">=</span><span class="n">opt_shift_est</span><span class="p">)</span>
    <span class="n">sig_min</span> <span class="o">=</span> <span class="n">sig_est</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
    <span class="n">sig_est</span> <span class="o">=</span> <span class="n">sig_est</span><span class="o">/</span><span class="n">sig_min</span>
    <span class="n">shap</span> <span class="o">=</span> <span class="n">psf_stack</span><span class="o">.</span><span class="n">shape</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
        <span class="n">psf_stack</span><span class="p">[:,:,</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">psf_stack</span><span class="p">[:,:,</span><span class="n">k</span><span class="p">]</span><span class="o">/</span><span class="n">sig_est</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">flux_est</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">flux_est</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">flux_estimate_stack</span><span class="p">(</span><span class="n">psf_stack_in</span><span class="p">,</span><span class="n">rad</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
    <span class="n">flux_ref</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">flux_est</span><span class="p">)</span>
    <span class="n">weights</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">nb_comp_max</span><span class="p">))</span>
    <span class="n">comp</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">upfact</span><span class="o">*</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">upfact</span><span class="o">*</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">nb_comp_max</span><span class="p">))</span>
    <span class="nb">input</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">upfact</span><span class="o">*</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">upfact</span><span class="o">*</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
    <span class="nb">input</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="nb">input</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">upfact</span><span class="p">)</span>
    <span class="nb">input</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">shift_ker_stack</span><span class="p">)</span>
    <span class="nb">input</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">shift_ker_stack_adj</span><span class="p">)</span>
    <span class="n">w</span> <span class="o">=</span> <span class="n">ones</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">],))</span>
    <span class="n">im_hr</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">upfact</span><span class="o">*</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">upfact</span><span class="o">*</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>
    <span class="nb">input</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">w</span><span class="p">)</span>
    <span class="nb">input</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sig_est</span><span class="p">)</span>
    <span class="nb">input</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">flux_est</span><span class="p">)</span>
    <span class="n">input_trans</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="nb">input</span><span class="p">)</span>

    <span class="c1"># Distances settings</span>
    <span class="nb">print</span> <span class="s2">&quot;Contructing PSF tree...&quot;</span>
    <span class="n">neigh</span><span class="p">,</span><span class="n">dists</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">knn_interf</span><span class="p">(</span><span class="n">field_dist</span><span class="p">,</span><span class="nb">int</span><span class="p">(</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="n">neigh_frac</span><span class="p">))</span>
    <span class="nb">print</span> <span class="s2">&quot;Done...&quot;</span>
    <span class="n">dist_med</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">dists</span><span class="p">)</span>
    <span class="n">dist_weights</span> <span class="o">=</span> <span class="p">(</span><span class="n">dist_med</span><span class="o">/</span><span class="n">dists</span><span class="p">)</span><span class="o">**</span><span class="n">dist_weight_deg</span>
    <span class="c1"># Spatial smoothing operator gradient lip constant estimation</span>
    <span class="n">spec_rad_smooth</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="sd">&quot;&quot;&quot;input_dist_op = list()</span>
<span class="sd">    input_dist_op.append(w)</span>
<span class="sd">    input_dist_op.append(neigh)</span>
<span class="sd">    input_dist_op.append(dist_weights)</span>
<span class="sd">    eig_smooth,spec_rad_smooth = pow_meth(grad_nn_unif_smooth_imp,input_dist_op,shap[2])&quot;&quot;&quot;</span>

    <span class="n">siz_in</span> <span class="o">=</span> <span class="n">upfact</span><span class="o">*</span><span class="n">array</span><span class="p">(</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">eig_max</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">eig_min_init</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">gam</span><span class="o">=</span><span class="kc">None</span>
    <span class="k">if</span> <span class="n">accel_en</span><span class="o">==</span><span class="kc">True</span><span class="p">:</span>
        <span class="n">eig_vect_min</span><span class="p">,</span><span class="n">gam</span> <span class="o">=</span> <span class="n">min_eig_val</span><span class="p">(</span><span class="n">sr_op_trans_stack</span><span class="p">,</span><span class="nb">input</span><span class="p">,</span><span class="n">siz_in</span><span class="p">,</span><span class="n">eig_max</span><span class="o">=</span><span class="n">eig_max</span><span class="p">,</span><span class="n">eig_min_init</span><span class="o">=</span><span class="n">eig_min_init</span><span class="p">)</span>
        <span class="n">gam</span> <span class="o">=</span> <span class="n">gam</span><span class="o">*</span><span class="mf">0.9</span>
        <span class="n">eig_min_init</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">eig_vect_min</span><span class="p">)</span>


    <span class="c1"># Accelerated Chamb-Pock variables</span>
    <span class="n">comp</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">upfact</span><span class="o">*</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">upfact</span><span class="o">*</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">nb_comp_max</span><span class="p">))</span> <span class="c1"># Main variable</span>
    <span class="n">comp_old</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">upfact</span><span class="o">*</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">upfact</span><span class="o">*</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">upfact</span><span class="o">*</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">upfact</span><span class="o">*</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span> <span class="c1"># Primal variable</span>
    <span class="n">u</span><span class="p">,</span><span class="n">mr_file</span> <span class="o">=</span> <span class="n">isap</span><span class="o">.</span><span class="n">mr_trans</span><span class="p">(</span><span class="n">comp</span><span class="p">[:,:,</span><span class="mi">0</span><span class="p">],</span><span class="n">opt</span><span class="o">=</span><span class="n">opt</span><span class="p">)</span> <span class="c1"># First dual variable</span>
    <span class="n">u</span> <span class="o">=</span> <span class="n">u</span><span class="o">*</span><span class="mi">0</span>
    <span class="n">v</span> <span class="o">=</span> <span class="mi">0</span><span class="o">*</span><span class="n">comp</span><span class="p">[:,:,</span><span class="mi">0</span><span class="p">]</span> <span class="c1"># Second dual variable</span>
    <span class="n">grad</span> <span class="o">=</span> <span class="n">x</span><span class="o">*</span><span class="mi">0</span>

    <span class="n">shap2</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">weights_sp</span> <span class="o">=</span> <span class="n">ones</span><span class="p">((</span><span class="n">shap2</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">shap2</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">shap2</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">psf_stack</span><span class="p">)</span>
    <span class="n">comp_lr</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">psf_stack</span><span class="p">)</span>
    <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">buff</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">nb_subiter_min</span><span class="p">))</span>
    <span class="n">comp_var</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">nb_comp_max</span><span class="p">,))</span>
    <span class="n">rho</span> <span class="o">=</span> <span class="mf">0.9</span><span class="o">/</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="c1"># to*rho&lt;L**(-2)</span>
    <span class="n">to</span> <span class="o">=</span> <span class="mf">0.9</span><span class="o">/</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">to_old</span> <span class="o">=</span> <span class="n">ones</span><span class="p">((</span><span class="mi">2</span><span class="p">,))</span><span class="o">*</span><span class="n">to</span>
    <span class="n">theta</span><span class="o">=</span><span class="mi">1</span>
    <span class="n">input_trans</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">to</span><span class="p">)</span>

    <span class="n">input_trans_prox</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">input_trans</span><span class="p">)</span>
    <span class="n">input_trans_prox</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">copy</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
    <span class="n">input_trans_prox</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">copy</span><span class="p">(</span><span class="n">psf_stack</span><span class="p">))</span>

    <span class="n">nb_iter_noisest</span> <span class="o">=</span> <span class="mi">20</span>
    <span class="n">thresh_type</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">noise_vect_1</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">sig_map</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">cur_res</span><span class="o">=</span><span class="mf">100000000.0</span>
    <span class="n">res_old</span><span class="o">=</span><span class="mf">1000000000.0</span>
    <span class="k">while</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">nb_comp_max</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">i</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
            <span class="n">w</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">abs_val_reverting</span><span class="p">(</span><span class="n">weights</span><span class="p">[:,</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="c1">#spec_rad = spec_rad_init</span>
        <span class="c1">#eig = eig_init</span>
        <span class="n">resk</span> <span class="o">=</span> <span class="n">res</span><span class="o">*</span><span class="mi">0</span>
        <span class="n">input_trans_prox</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>
        <span class="n">weights_sp</span> <span class="o">=</span> <span class="n">ones</span><span class="p">((</span><span class="n">shap2</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">shap2</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">shap2</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>
        <span class="nb">input</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">=</span><span class="n">w</span>
        <span class="n">input_trans</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">=</span><span class="n">w</span>
        <span class="n">input_trans_prox</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">=</span><span class="n">w</span>

        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_iter</span><span class="p">):</span>
            <span class="n">t</span><span class="o">=</span><span class="mi">1</span>
            <span class="c1"># ith component estimation</span>
            <span class="n">j</span><span class="o">=</span><span class="mi">0</span>
            <span class="c1">#print &#39;--------------- &#39;,nb_subiter,&#39; ----------------&#39;</span>
            <span class="n">res_old</span> <span class="o">=</span> <span class="n">cur_res</span><span class="o">*</span><span class="mi">2</span>

            <span class="k">while</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">nb_subiter</span> <span class="ow">and</span> <span class="mi">100</span><span class="o">*</span><span class="nb">abs</span><span class="p">(</span><span class="n">cur_res</span><span class="o">-</span><span class="n">res_old</span><span class="p">)</span><span class="o">/</span><span class="n">res_old</span><span class="o">&gt;</span><span class="mf">0.1</span><span class="p">:</span><span class="c1"># and cur_res&lt;res_old:</span>
                <span class="n">res_old</span> <span class="o">=</span> <span class="n">cur_res</span>
                <span class="c1"># Residual computation</span>
                <span class="n">grad</span> <span class="o">=</span> <span class="n">grad</span><span class="o">*</span><span class="mi">0</span>
                <span class="k">if</span> <span class="n">j</span><span class="o">==</span><span class="mi">0</span> <span class="ow">and</span> <span class="n">k</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
                        <span class="n">resk</span><span class="p">[:,:,</span><span class="n">l</span><span class="p">]</span> <span class="o">=</span> <span class="n">res</span><span class="p">[:,:,</span><span class="n">l</span><span class="p">]</span><span class="o">-</span><span class="p">(</span><span class="n">w</span><span class="p">[</span><span class="n">l</span><span class="p">]</span><span class="o">*</span><span class="n">flux_ref</span><span class="o">/</span><span class="p">(</span><span class="n">sig_est</span><span class="p">[</span><span class="n">l</span><span class="p">]</span><span class="o">*</span><span class="n">flux_est</span><span class="p">[</span><span class="n">l</span><span class="p">]))</span><span class="o">*</span><span class="n">utils</span><span class="o">.</span><span class="n">decim</span><span class="p">(</span><span class="n">scisig</span><span class="o">.</span><span class="n">fftconvolve</span><span class="p">(</span><span class="n">comp</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">],</span><span class="n">shift_ker_stack</span><span class="p">[:,:,</span><span class="n">l</span><span class="p">],</span><span class="n">mode</span><span class="o">=</span><span class="s1">&#39;same&#39;</span><span class="p">),</span><span class="n">upfact</span><span class="p">,</span><span class="n">av_en</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                        <span class="n">grad</span> <span class="o">=</span> <span class="n">grad</span><span class="o">-</span><span class="p">(</span><span class="n">w</span><span class="p">[</span><span class="n">l</span><span class="p">]</span><span class="o">*</span><span class="n">flux_ref</span><span class="o">/</span><span class="p">(</span><span class="n">sig_est</span><span class="p">[</span><span class="n">l</span><span class="p">]</span><span class="o">*</span><span class="n">flux_est</span><span class="p">[</span><span class="n">l</span><span class="p">]))</span><span class="o">*</span><span class="n">scisig</span><span class="o">.</span><span class="n">convolve</span><span class="p">(</span><span class="n">utils</span><span class="o">.</span><span class="n">transpose_decim</span><span class="p">(</span><span class="n">resk</span><span class="p">[:,:,</span><span class="n">l</span><span class="p">],</span><span class="n">upfact</span><span class="p">),</span><span class="n">shift_ker_stack_adj</span><span class="p">[:,:,</span><span class="n">l</span><span class="p">],</span><span class="n">mode</span><span class="o">=</span><span class="s1">&#39;same&#39;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">grad</span> <span class="o">=</span> <span class="n">grad</span><span class="o">-</span><span class="p">(</span><span class="n">w</span><span class="p">[</span><span class="n">l</span><span class="p">]</span><span class="o">*</span><span class="n">flux_ref</span><span class="o">/</span><span class="p">(</span><span class="n">sig_est</span><span class="p">[</span><span class="n">l</span><span class="p">]</span><span class="o">*</span><span class="n">flux_est</span><span class="p">[</span><span class="n">l</span><span class="p">]))</span><span class="o">*</span><span class="n">scisig</span><span class="o">.</span><span class="n">convolve</span><span class="p">(</span><span class="n">utils</span><span class="o">.</span><span class="n">transpose_decim</span><span class="p">(</span><span class="n">resk</span><span class="p">[:,:,</span><span class="n">l</span><span class="p">],</span><span class="n">upfact</span><span class="p">),</span><span class="n">shift_ker_stack_adj</span><span class="p">[:,:,</span><span class="n">l</span><span class="p">],</span><span class="n">mode</span><span class="o">=</span><span class="s1">&#39;same&#39;</span><span class="p">)</span>

                <span class="n">buff</span><span class="p">[</span><span class="n">j</span><span class="o">%</span><span class="n">nb_subiter_min</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">resk</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>


                <span class="k">if</span> <span class="n">j</span><span class="o">&gt;=</span><span class="n">nb_subiter_min</span><span class="p">:</span>
                    <span class="n">cur_res</span> <span class="o">=</span> <span class="n">buff</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">cur_res</span> <span class="o">=</span> <span class="n">buff</span><span class="p">[</span><span class="n">j</span><span class="o">%</span><span class="n">nb_subiter_min</span><span class="p">]</span>

                <span class="c1"># Noise estimation</span>
                <span class="n">input_trans</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="n">to_old</span><span class="p">[</span><span class="n">k</span><span class="o">%</span><span class="mi">2</span><span class="p">]</span>
                <span class="n">input_trans</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">grad</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">j</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
                    <span class="n">noise_vect_1</span> <span class="o">=</span> <span class="n">sr_op_trans_stack_translate_inv</span><span class="p">(</span><span class="n">input_trans</span><span class="p">,</span><span class="n">nb_iter_noisest</span><span class="p">)</span>
                    <span class="n">sig_map</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">res_sig_map</span><span class="p">(</span><span class="n">noise_vect_1</span><span class="o">*</span><span class="n">to_old</span><span class="p">[</span><span class="n">k</span><span class="o">%</span><span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="n">rho</span><span class="p">,</span><span class="n">opt</span><span class="o">=</span><span class="n">opt</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">j</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
                    <span class="nb">print</span> <span class="s2">&quot;Estimated noise at the first scales: &quot;</span><span class="p">,</span><span class="n">sig_map</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,:]</span>
                <span class="n">thresh_map</span> <span class="o">=</span> <span class="n">nsig</span><span class="o">*</span><span class="n">sig_map</span>

                <span class="c1"># Dual variables update</span>
                <span class="c1"># Positivity</span>
                <span class="n">t1</span> <span class="o">=</span> <span class="n">v</span><span class="o">+</span><span class="n">rho</span><span class="o">*</span><span class="n">comp</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">]</span>
                <span class="n">v</span> <span class="o">=</span> <span class="n">t1</span><span class="o">-</span><span class="n">rho</span><span class="o">*</span><span class="n">proj_affine_pos2</span><span class="p">(</span><span class="n">t1</span><span class="o">/</span><span class="n">rho</span><span class="p">,</span><span class="n">w</span><span class="p">,</span><span class="n">im_hr</span><span class="p">)</span>
                <span class="c1"># Sparsity</span>
                <span class="n">t2</span><span class="p">,</span><span class="n">mr_file</span> <span class="o">=</span> <span class="n">isap</span><span class="o">.</span><span class="n">mr_trans</span><span class="p">(</span><span class="n">comp</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">],</span><span class="n">opt</span><span class="o">=</span><span class="n">opt</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">i</span><span class="o">==</span><span class="mi">0</span> <span class="ow">and</span> <span class="n">k</span><span class="o">==</span><span class="mi">0</span> <span class="ow">and</span> <span class="p">(</span><span class="n">comp</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
                    <span class="n">tempy</span> <span class="o">=</span> <span class="n">isap</span><span class="o">.</span><span class="n">mr_recons_coeff</span><span class="p">(</span><span class="n">t2</span><span class="p">,</span><span class="n">mr_file</span><span class="p">)</span>
                    <span class="n">a</span> <span class="o">=</span> <span class="p">(</span><span class="n">comp</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">]</span><span class="o">*</span><span class="n">tempy</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
                    <span class="n">b</span> <span class="o">=</span> <span class="p">(</span><span class="n">t2</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
                    <span class="n">wvl_transp_cor</span> <span class="o">=</span> <span class="n">b</span><span class="o">/</span><span class="n">a</span>
                    <span class="nb">print</span> <span class="s1">&#39;--------- correction coeff: &#39;</span><span class="p">,</span><span class="n">wvl_transp_cor</span><span class="p">,</span><span class="s1">&#39; --------------------&#39;</span>

                <span class="n">t3</span> <span class="o">=</span> <span class="n">u</span><span class="o">+</span><span class="n">rho</span><span class="o">*</span><span class="n">t2</span>
                <span class="n">u</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">l_inf_ball_proj_3D</span><span class="p">(</span><span class="n">t3</span><span class="p">,</span><span class="n">thresh_map</span><span class="o">*</span><span class="n">weights_sp</span><span class="p">,</span><span class="n">thresh_type</span><span class="p">)</span>

                <span class="c1"># Primal variable update</span>
                <span class="n">t4</span> <span class="o">=</span> <span class="n">isap</span><span class="o">.</span><span class="n">mr_recons_coeff</span><span class="p">(</span><span class="n">u</span><span class="p">,</span><span class="n">mr_file</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">wvl_transp_cor</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">t5</span> <span class="o">=</span> <span class="n">t4</span><span class="o">+</span><span class="n">v</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">t5</span> <span class="o">=</span> <span class="n">wvl_transp_cor</span><span class="o">*</span><span class="n">t4</span><span class="o">+</span><span class="n">v</span>
                <span class="n">t6</span> <span class="o">=</span> <span class="n">x</span> <span class="o">-</span> <span class="n">to_old</span><span class="p">[(</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">%</span><span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="n">t5</span>
                <span class="n">xold</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
                <span class="n">input_trans_prox</span><span class="p">[</span><span class="o">-</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">to_old</span><span class="p">[(</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">%</span><span class="mi">2</span><span class="p">]</span>
                <span class="n">input_trans_prox</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">t6</span>
                <span class="c1"># Ref value</span>
                <span class="n">prox_cost</span><span class="o">=</span><span class="mi">0</span>
                <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
                    <span class="n">prox_cost</span> <span class="o">=</span> <span class="n">prox_cost</span> <span class="o">+</span> <span class="p">((</span><span class="n">res</span><span class="p">[:,:,</span><span class="n">l</span><span class="p">]</span><span class="o">-</span><span class="p">(</span><span class="n">w</span><span class="p">[</span><span class="n">l</span><span class="p">]</span><span class="o">*</span><span class="n">flux_ref</span><span class="o">/</span><span class="p">(</span><span class="n">sig_est</span><span class="p">[</span><span class="n">l</span><span class="p">]</span><span class="o">*</span><span class="n">flux_est</span><span class="p">[</span><span class="n">l</span><span class="p">]))</span><span class="o">*</span><span class="n">utils</span><span class="o">.</span><span class="n">decim</span><span class="p">(</span><span class="n">scisig</span><span class="o">.</span><span class="n">fftconvolve</span><span class="p">(</span><span class="n">t6</span><span class="p">,</span><span class="n">shift_ker_stack</span><span class="p">[:,:,</span><span class="n">l</span><span class="p">],</span><span class="n">mode</span><span class="o">=</span><span class="s1">&#39;same&#39;</span><span class="p">),</span><span class="n">upfact</span><span class="p">,</span><span class="n">av_en</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
                <span class="nb">print</span> <span class="s2">&quot;ref prox cost value: &quot;</span><span class="p">,</span><span class="n">to_old</span><span class="p">[(</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">%</span><span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="n">prox_cost</span>
                <span class="n">x</span> <span class="o">=</span> <span class="n">sr_op_trans_stack_prox</span><span class="p">(</span><span class="n">input_trans_prox</span><span class="p">,</span><span class="n">nb_iter_noisest</span><span class="p">)</span>
                <span class="c1"># Optimal value</span>
                <span class="n">prox_opt</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
                    <span class="n">prox_opt</span> <span class="o">=</span> <span class="n">prox_opt</span> <span class="o">+</span> <span class="p">((</span><span class="n">res</span><span class="p">[:,:,</span><span class="n">l</span><span class="p">]</span><span class="o">-</span><span class="p">(</span><span class="n">w</span><span class="p">[</span><span class="n">l</span><span class="p">]</span><span class="o">*</span><span class="n">flux_ref</span><span class="o">/</span><span class="p">(</span><span class="n">sig_est</span><span class="p">[</span><span class="n">l</span><span class="p">]</span><span class="o">*</span><span class="n">flux_est</span><span class="p">[</span><span class="n">l</span><span class="p">]))</span><span class="o">*</span><span class="n">utils</span><span class="o">.</span><span class="n">decim</span><span class="p">(</span><span class="n">scisig</span><span class="o">.</span><span class="n">fftconvolve</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">shift_ker_stack</span><span class="p">[:,:,</span><span class="n">l</span><span class="p">],</span><span class="n">mode</span><span class="o">=</span><span class="s1">&#39;same&#39;</span><span class="p">),</span><span class="n">upfact</span><span class="p">,</span><span class="n">av_en</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
                <span class="nb">print</span> <span class="s2">&quot;optimal prox cost value: &quot;</span><span class="p">,</span><span class="n">to_old</span><span class="p">[(</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">%</span><span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="n">prox_opt</span><span class="o">+</span><span class="p">((</span><span class="n">x</span><span class="o">-</span><span class="n">t6</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>

                <span class="c1"># Acceleration</span>
                <span class="c1"># Hyper parameters update</span>
                <span class="k">if</span> <span class="n">accel_en</span><span class="o">==</span><span class="kc">True</span><span class="p">:</span>
                    <span class="n">theta</span> <span class="o">=</span> <span class="mf">1.0</span><span class="o">/</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="mi">2</span><span class="o">*</span><span class="n">gam</span><span class="o">*</span><span class="n">to_old</span><span class="p">[(</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">%</span><span class="mi">2</span><span class="p">])</span>
                    <span class="n">to_old</span><span class="p">[</span><span class="n">k</span><span class="o">%</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">theta</span><span class="o">*</span><span class="n">to_old</span><span class="p">[(</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">%</span><span class="mi">2</span><span class="p">]</span>
                    <span class="n">rho</span> <span class="o">=</span> <span class="n">rho</span><span class="o">/</span><span class="n">theta</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">theta</span> <span class="o">=</span> <span class="n">theta</span><span class="o">*</span><span class="n">exp</span><span class="p">((</span><span class="o">-</span><span class="n">j</span><span class="o">/</span><span class="n">decay_fact</span><span class="p">))</span>
                <span class="n">comp_old</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">comp</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">])</span>
                <span class="n">comp</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">x</span><span class="o">+</span><span class="n">theta</span><span class="o">*</span><span class="p">(</span><span class="n">x</span><span class="o">-</span><span class="n">xold</span><span class="p">)</span>
                <span class="n">j</span><span class="o">+=</span><span class="mi">1</span>

                <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
                    <span class="n">resk</span><span class="p">[:,:,</span><span class="n">l</span><span class="p">]</span> <span class="o">=</span> <span class="n">res</span><span class="p">[:,:,</span><span class="n">l</span><span class="p">]</span><span class="o">-</span><span class="p">(</span><span class="n">w</span><span class="p">[</span><span class="n">l</span><span class="p">]</span><span class="o">*</span><span class="n">flux_ref</span><span class="o">/</span><span class="p">(</span><span class="n">sig_est</span><span class="p">[</span><span class="n">l</span><span class="p">]</span><span class="o">*</span><span class="n">flux_est</span><span class="p">[</span><span class="n">l</span><span class="p">]))</span><span class="o">*</span><span class="n">utils</span><span class="o">.</span><span class="n">decim</span><span class="p">(</span><span class="n">scisig</span><span class="o">.</span><span class="n">fftconvolve</span><span class="p">(</span><span class="n">comp</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">],</span><span class="n">shift_ker_stack</span><span class="p">[:,:,</span><span class="n">l</span><span class="p">],</span><span class="n">mode</span><span class="o">=</span><span class="s1">&#39;same&#39;</span><span class="p">),</span><span class="n">upfact</span><span class="p">,</span><span class="n">av_en</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                <span class="n">buff</span><span class="p">[</span><span class="n">j</span><span class="o">%</span><span class="n">nb_subiter_min</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">resk</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>

                <span class="nb">print</span> <span class="s2">&quot;mse: &quot;</span><span class="p">,</span> <span class="n">buff</span><span class="p">[</span><span class="n">j</span><span class="o">%</span><span class="n">nb_subiter_min</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">j</span><span class="o">&gt;=</span><span class="n">nb_subiter_min</span><span class="p">:</span>
                    <span class="n">cur_res</span> <span class="o">=</span> <span class="n">buff</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">cur_res</span> <span class="o">=</span> <span class="n">buff</span><span class="p">[</span><span class="n">j</span><span class="o">%</span><span class="n">nb_subiter_min</span><span class="p">]</span>

                <span class="k">if</span> <span class="n">i</span><span class="o">==</span><span class="mi">0</span> <span class="ow">and</span> <span class="n">k</span><span class="o">==</span><span class="mi">0</span> <span class="ow">and</span> <span class="n">wvl_transp_cor</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">rho</span> <span class="o">=</span> <span class="mf">0.9</span><span class="o">/</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">wvl_transp_cor</span><span class="p">)</span>
                    <span class="n">to_old</span> <span class="o">=</span> <span class="mf">0.9</span><span class="o">*</span><span class="n">ones</span><span class="p">((</span><span class="mi">2</span><span class="p">,))</span><span class="o">/</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">wvl_transp_cor</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">j</span><span class="o">==</span><span class="mi">1</span> <span class="ow">and</span> <span class="n">cur_res</span><span class="o">&gt;</span><span class="n">res_old</span><span class="p">:</span>
                    <span class="n">res_old</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">cur_res</span>        <span class="c1"># Might tolerate a degration of the residual in the first iteration of the estimation loop of a component</span>
            <span class="k">if</span> <span class="n">cur_res</span><span class="o">&gt;</span><span class="n">res_old</span><span class="p">:</span>
                <span class="n">comp</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">]</span><span class="o">=</span><span class="n">copy</span><span class="p">(</span><span class="n">comp_old</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
                <span class="n">comp_lr</span><span class="p">[:,:,</span><span class="n">l</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">flux_ref</span><span class="o">/</span><span class="p">(</span><span class="n">sig_est</span><span class="p">[</span><span class="n">l</span><span class="p">]</span><span class="o">*</span><span class="n">flux_est</span><span class="p">[</span><span class="n">l</span><span class="p">]))</span><span class="o">*</span><span class="n">utils</span><span class="o">.</span><span class="n">decim</span><span class="p">(</span><span class="n">scisig</span><span class="o">.</span><span class="n">fftconvolve</span><span class="p">(</span><span class="n">comp</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">],</span><span class="n">shift_ker_stack</span><span class="p">[:,:,</span><span class="n">l</span><span class="p">],</span><span class="n">mode</span><span class="o">=</span><span class="s1">&#39;same&#39;</span><span class="p">),</span><span class="n">upfact</span><span class="p">,</span><span class="n">av_en</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>


            <span class="k">if</span> <span class="n">k</span><span class="o">&lt;</span><span class="n">nb_iter</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">accel_en</span><span class="o">==</span><span class="kc">True</span><span class="p">:</span>
                    <span class="n">eig_vect_min</span><span class="p">,</span><span class="n">gam</span> <span class="o">=</span> <span class="n">min_eig_val</span><span class="p">(</span><span class="n">sr_op_trans_stack</span><span class="p">,</span><span class="nb">input</span><span class="p">,</span><span class="n">siz_in</span><span class="p">,</span><span class="n">eig_max</span><span class="o">=</span><span class="n">eig_max</span><span class="p">,</span><span class="n">eig_min_init</span><span class="o">=</span><span class="n">eig_min_init</span><span class="p">)</span>
                    <span class="n">gam</span> <span class="o">=</span> <span class="mf">0.9</span><span class="o">*</span><span class="n">gam</span>
                    <span class="n">eig_min_init</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">eig_vect_min</span><span class="p">)</span>

                <span class="c1"># Reweighting</span>
                <span class="n">coeffx</span><span class="p">,</span><span class="n">mr_file</span> <span class="o">=</span> <span class="n">isap</span><span class="o">.</span><span class="n">mr_trans</span><span class="p">(</span><span class="n">comp</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">],</span><span class="n">opt</span><span class="o">=</span><span class="n">opt</span><span class="p">)</span>
                <span class="n">weights_sp</span>  <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="nb">abs</span><span class="p">(</span><span class="n">coeffx</span><span class="p">[:,:,:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span><span class="o">/</span><span class="p">(</span><span class="n">nsig</span><span class="o">*</span><span class="n">sig_map</span><span class="p">))</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
            <span class="c1"># ith component coeff estimation</span>
            <span class="k">if</span> <span class="n">k</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
                <span class="n">w</span> <span class="o">=</span> <span class="n">lsq_coeff_stack</span><span class="p">(</span><span class="n">comp_lr</span><span class="p">,</span><span class="n">res</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">w</span> <span class="o">=</span> <span class="n">non_unif_smoothing</span><span class="p">(</span><span class="n">neigh</span><span class="p">,</span><span class="n">dist_weights</span><span class="p">,</span><span class="n">w</span><span class="p">,</span><span class="n">res</span><span class="p">,</span><span class="n">comp_lr</span><span class="p">,</span><span class="n">mu</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">spec_rad</span><span class="o">=</span><span class="n">spec_rad_smooth</span><span class="p">,</span><span class="n">nb_iter</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
            <span class="nb">print</span> <span class="s2">&quot;weights: &quot;</span><span class="p">,</span><span class="n">w</span>
            <span class="nb">input</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">=</span><span class="n">w</span>
            <span class="n">input_trans</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">=</span><span class="n">w</span>
            <span class="n">input_trans_prox</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">=</span><span class="n">w</span>

            <span class="c1"># Hyper parameters reset</span>
            <span class="n">rho</span> <span class="o">=</span> <span class="mf">0.9</span><span class="o">/</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">wvl_transp_cor</span><span class="p">)</span>
            <span class="n">to_old</span> <span class="o">=</span> <span class="mf">0.9</span><span class="o">*</span><span class="n">ones</span><span class="p">((</span><span class="mi">2</span><span class="p">,))</span><span class="o">/</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">wvl_transp_cor</span><span class="p">)</span>

        <span class="c1"># Residual update and HR images update</span>
        <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">w</span><span class="p">)</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
                <span class="n">res</span><span class="p">[:,:,</span><span class="n">l</span><span class="p">]</span> <span class="o">=</span> <span class="n">res</span><span class="p">[:,:,</span><span class="n">l</span><span class="p">]</span><span class="o">-</span><span class="p">(</span><span class="n">w</span><span class="p">[</span><span class="n">l</span><span class="p">]</span><span class="o">*</span><span class="n">flux_ref</span><span class="o">/</span><span class="p">(</span><span class="n">sig_est</span><span class="p">[</span><span class="n">l</span><span class="p">]</span><span class="o">*</span><span class="n">flux_est</span><span class="p">[</span><span class="n">l</span><span class="p">]))</span><span class="o">*</span><span class="n">utils</span><span class="o">.</span><span class="n">decim</span><span class="p">(</span><span class="n">scisig</span><span class="o">.</span><span class="n">fftconvolve</span><span class="p">(</span><span class="n">comp</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">],</span><span class="n">shift_ker_stack</span><span class="p">[:,:,</span><span class="n">l</span><span class="p">],</span><span class="n">mode</span><span class="o">=</span><span class="s1">&#39;same&#39;</span><span class="p">),</span><span class="n">upfact</span><span class="p">,</span><span class="n">av_en</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                <span class="n">im_hr</span><span class="p">[:,:,</span><span class="n">l</span><span class="p">]</span> <span class="o">=</span> <span class="n">im_hr</span><span class="p">[:,:,</span><span class="n">l</span><span class="p">]</span><span class="o">+</span><span class="n">w</span><span class="p">[</span><span class="n">l</span><span class="p">]</span><span class="o">*</span><span class="n">comp</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">]</span>
            <span class="n">weights</span><span class="p">[:,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">w</span>
        <span class="n">i</span><span class="o">+=</span><span class="mi">1</span>
        <span class="c1"># Optim variables resetting</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="o">*</span><span class="mi">0</span>
        <span class="n">u</span> <span class="o">=</span> <span class="n">u</span><span class="o">*</span><span class="mi">0</span>
        <span class="n">v</span> <span class="o">=</span> <span class="n">v</span><span class="o">*</span><span class="mi">0</span>

    <span class="k">return</span> <span class="n">im_hr</span><span class="p">,</span><span class="n">comp</span><span class="p">,</span><span class="n">weights</span><span class="p">,</span><span class="n">res</span><span class="p">,</span><span class="n">sig_est</span><span class="o">*</span><span class="n">sig_min</span><span class="p">,</span><span class="n">flux_est</span><span class="p">,</span><span class="n">shifts</span>

<span class="k">def</span> <span class="nf">low_rank_comp_wise_sparse_dist_recond</span><span class="p">(</span><span class="n">psf_stack_in</span><span class="p">,</span><span class="n">field_dist</span><span class="p">,</span><span class="n">upfact</span><span class="p">,</span><span class="n">opt</span><span class="p">,</span><span class="n">nsig</span><span class="p">,</span><span class="n">neigh_frac</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span><span class="n">dist_weight_deg</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">shifts</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">opt_shift_est</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">nsig_shift_est</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">sig_est</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">flux_est</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">nb_iter</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span><span class="n">nb_subiter</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span><span class="n">nb_subiter_min</span><span class="o">=</span><span class="mi">7</span><span class="p">,</span><span class="n">mu</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span><span class="n">nb_comp_max</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span><span class="n">tol</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span><span class="n">wvl_transp_cor</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">accel_en</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">decay_fact</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">cond_fact</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span><span class="n">weights_bal</span><span class="o">=</span><span class="mf">0.05</span><span class="p">):</span>
    <span class="nb">print</span> <span class="s2">&quot;---------------- Reconditioned RCA -----------------&quot;</span>
    <span class="n">psf_stack</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">psf_stack_in</span><span class="p">)</span>

    <span class="c1"># Degradation operator parameters estimation</span>
    <span class="k">if</span> <span class="n">sig_est</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">sig_est</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">im_gauss_nois_est_cube</span><span class="p">(</span><span class="n">psf_stack_in</span><span class="p">,</span><span class="n">opt</span><span class="o">=</span><span class="n">opt_shift_est</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">shifts</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1">#shifts = utils.shift_est(psf_stack)*upfact</span>
        <span class="c1">#shifts = utils.wvl_shift_est(psf_stack,opt_shift_est,nsig_shift_est)*upfact</span>
        <span class="n">shifts</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">thresh_shift_est</span><span class="p">(</span><span class="n">im_stack</span><span class="p">,</span><span class="n">sig_thresh</span><span class="o">=</span><span class="n">sig_est</span><span class="p">,</span><span class="n">opt</span><span class="o">=</span><span class="n">opt_shift_est</span><span class="p">)</span><span class="o">*</span><span class="n">upfact</span>
    <span class="n">shift_ker_stack</span><span class="p">,</span><span class="n">shift_ker_stack_adj</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">shift_ker_stack</span><span class="p">(</span><span class="n">shifts</span><span class="p">,</span><span class="n">upfact</span><span class="p">)</span>

    <span class="n">sig_min</span> <span class="o">=</span> <span class="n">sig_est</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
    <span class="n">sig_est</span> <span class="o">=</span> <span class="n">sig_est</span><span class="o">/</span><span class="n">sig_min</span>
    <span class="n">shap</span> <span class="o">=</span> <span class="n">psf_stack</span><span class="o">.</span><span class="n">shape</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
        <span class="n">psf_stack</span><span class="p">[:,:,</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">psf_stack</span><span class="p">[:,:,</span><span class="n">k</span><span class="p">]</span><span class="o">/</span><span class="n">sig_est</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">flux_est</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">flux_est</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">flux_estimate_stack</span><span class="p">(</span><span class="n">psf_stack_in</span><span class="p">,</span><span class="n">rad</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
    <span class="n">flux_ref</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">flux_est</span><span class="p">)</span>
    <span class="n">weights</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">nb_comp_max</span><span class="p">))</span>
    <span class="n">comp</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">upfact</span><span class="o">*</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">upfact</span><span class="o">*</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">nb_comp_max</span><span class="p">))</span>
    <span class="nb">input</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">upfact</span><span class="o">*</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">upfact</span><span class="o">*</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
    <span class="nb">input</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="nb">input</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">upfact</span><span class="p">)</span>
    <span class="nb">input</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">shift_ker_stack</span><span class="p">)</span>
    <span class="nb">input</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">shift_ker_stack_adj</span><span class="p">)</span>
    <span class="n">w</span> <span class="o">=</span> <span class="n">ones</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">],))</span>
    <span class="n">im_hr</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">upfact</span><span class="o">*</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">upfact</span><span class="o">*</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>
    <span class="nb">input</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">w</span><span class="p">)</span>
    <span class="nb">input</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sig_est</span><span class="p">)</span>
    <span class="nb">input</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">flux_est</span><span class="p">)</span>
    <span class="n">input_trans</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="nb">input</span><span class="p">)</span>

    <span class="c1"># Distances settings</span>
    <span class="nb">print</span> <span class="s2">&quot;Contructing PSF tree...&quot;</span>
    <span class="n">neigh</span><span class="p">,</span><span class="n">dists</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">knn_interf</span><span class="p">(</span><span class="n">field_dist</span><span class="p">,</span><span class="nb">int</span><span class="p">(</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="n">neigh_frac</span><span class="p">))</span>
    <span class="nb">print</span> <span class="s2">&quot;Done...&quot;</span>
    <span class="n">dist_med</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">dists</span><span class="p">)</span>
    <span class="n">dist_weights</span> <span class="o">=</span> <span class="p">(</span><span class="n">dist_med</span><span class="o">/</span><span class="n">dists</span><span class="p">)</span><span class="o">**</span><span class="n">dist_weight_deg</span>
    <span class="c1"># Spatial smoothing operator gradient lip constant estimation</span>
    <span class="n">spec_rad_smooth</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="sd">&quot;&quot;&quot;input_dist_op = list()</span>
<span class="sd">        input_dist_op.append(w)</span>
<span class="sd">        input_dist_op.append(neigh)</span>
<span class="sd">        input_dist_op.append(dist_weights)</span>
<span class="sd">        eig_smooth,spec_rad_smooth = pow_meth(grad_nn_unif_smooth_imp,input_dist_op,shap[2])&quot;&quot;&quot;</span>

    <span class="n">siz_in</span> <span class="o">=</span> <span class="n">upfact</span><span class="o">*</span><span class="n">array</span><span class="p">(</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">eig_max</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">eig_min_init</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">gam</span><span class="o">=</span><span class="kc">None</span>
    <span class="k">if</span> <span class="n">accel_en</span><span class="o">==</span><span class="kc">True</span><span class="p">:</span>
        <span class="n">eig_vect_min</span><span class="p">,</span><span class="n">gam</span> <span class="o">=</span> <span class="n">min_eig_val</span><span class="p">(</span><span class="n">sr_op_trans_stack</span><span class="p">,</span><span class="nb">input</span><span class="p">,</span><span class="n">siz_in</span><span class="p">,</span><span class="n">eig_max</span><span class="o">=</span><span class="n">eig_max</span><span class="p">,</span><span class="n">eig_min_init</span><span class="o">=</span><span class="n">eig_min_init</span><span class="p">)</span>
        <span class="n">gam</span> <span class="o">=</span> <span class="n">gam</span><span class="o">*</span><span class="mf">0.9</span>
        <span class="n">eig_min_init</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">eig_vect_min</span><span class="p">)</span>



    <span class="c1"># Accelerated Chamb-Pock variables</span>
    <span class="n">comp</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">upfact</span><span class="o">*</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">upfact</span><span class="o">*</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">nb_comp_max</span><span class="p">))</span> <span class="c1"># Main variable</span>
    <span class="n">comp_old</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">upfact</span><span class="o">*</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">upfact</span><span class="o">*</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">upfact</span><span class="o">*</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">upfact</span><span class="o">*</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span> <span class="c1"># Primal variable</span>
    <span class="n">u</span><span class="p">,</span><span class="n">mr_file</span> <span class="o">=</span> <span class="n">isap</span><span class="o">.</span><span class="n">mr_trans</span><span class="p">(</span><span class="n">comp</span><span class="p">[:,:,</span><span class="mi">0</span><span class="p">],</span><span class="n">opt</span><span class="o">=</span><span class="n">opt</span><span class="p">)</span> <span class="c1"># First dual variable</span>
    <span class="n">u</span> <span class="o">=</span> <span class="n">u</span><span class="o">*</span><span class="mi">0</span>
    <span class="n">v</span> <span class="o">=</span> <span class="mi">0</span><span class="o">*</span><span class="n">comp</span><span class="p">[:,:,</span><span class="mi">0</span><span class="p">]</span> <span class="c1"># Second dual variable</span>
    <span class="n">grad</span> <span class="o">=</span> <span class="n">x</span><span class="o">*</span><span class="mi">0</span>

    <span class="n">shap2</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">weights_sp</span> <span class="o">=</span> <span class="n">ones</span><span class="p">((</span><span class="n">shap2</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">shap2</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">shap2</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">psf_stack</span><span class="p">)</span>
    <span class="n">comp_lr</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">psf_stack</span><span class="p">)</span>
    <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">buff</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">nb_subiter_min</span><span class="p">))</span>
    <span class="n">comp_var</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">nb_comp_max</span><span class="p">,))</span>

    <span class="n">rho</span> <span class="o">=</span> <span class="n">weights_bal</span><span class="o">*</span><span class="mf">0.9</span><span class="o">/</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="c1"># to*rho&lt;L**(-2)</span>
    <span class="n">to</span> <span class="o">=</span> <span class="mf">0.9</span><span class="o">/</span><span class="p">(</span><span class="mi">3</span><span class="o">*</span><span class="n">rho</span><span class="p">)</span>
    <span class="n">to_old</span> <span class="o">=</span> <span class="n">ones</span><span class="p">((</span><span class="mi">2</span><span class="p">,))</span><span class="o">*</span><span class="n">to</span>
    <span class="n">theta</span><span class="o">=</span><span class="mi">1</span>
    <span class="n">input_trans</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">to</span><span class="p">)</span>

    <span class="n">input_trans_prox</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">input_trans</span><span class="p">)</span>
    <span class="n">input_trans_prox</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">copy</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
    <span class="n">input_trans_prox</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">copy</span><span class="p">(</span><span class="n">psf_stack</span><span class="p">))</span>

    <span class="n">nb_iter_noisest</span> <span class="o">=</span> <span class="mi">20</span>
    <span class="n">thresh_type</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">noise_vect_1</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">sig_map</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">cur_res</span><span class="o">=</span><span class="mf">100000000.0</span>
    <span class="n">res_old</span><span class="o">=</span><span class="mf">1000000000.0</span>
    <span class="k">while</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">nb_comp_max</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">i</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
            <span class="n">w</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">vect_recond</span><span class="p">(</span><span class="n">utils</span><span class="o">.</span><span class="n">abs_val_reverting</span><span class="p">(</span><span class="n">weights</span><span class="p">[:,</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]),</span><span class="n">cond_fact</span><span class="p">)</span>
        <span class="c1">#spec_rad = spec_rad_init</span>
        <span class="c1">#eig = eig_init</span>
        <span class="n">resk</span> <span class="o">=</span> <span class="n">res</span><span class="o">*</span><span class="mi">0</span>
        <span class="n">input_trans_prox</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>
        <span class="n">weights_sp</span> <span class="o">=</span> <span class="n">ones</span><span class="p">((</span><span class="n">shap2</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">shap2</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">shap2</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>
        <span class="nb">input</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">=</span><span class="n">w</span>
        <span class="n">input_trans</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">=</span><span class="n">w</span>
        <span class="n">input_trans_prox</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">=</span><span class="n">w</span>

        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_iter</span><span class="p">):</span>
            <span class="n">t</span><span class="o">=</span><span class="mi">1</span>
            <span class="c1"># ith component estimation</span>
            <span class="n">j</span><span class="o">=</span><span class="mi">0</span>
            <span class="c1">#print &#39;--------------- &#39;,nb_subiter,&#39; ----------------&#39;</span>
            <span class="n">res_old</span> <span class="o">=</span> <span class="n">cur_res</span><span class="o">*</span><span class="mi">2</span>

            <span class="k">while</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">nb_subiter</span> <span class="ow">and</span> <span class="mi">100</span><span class="o">*</span><span class="nb">abs</span><span class="p">(</span><span class="n">cur_res</span><span class="o">-</span><span class="n">res_old</span><span class="p">)</span><span class="o">/</span><span class="n">res_old</span><span class="o">&gt;</span><span class="mf">0.1</span><span class="p">:</span><span class="c1"># and cur_res&lt;res_old:</span>
                <span class="n">res_old</span> <span class="o">=</span> <span class="n">cur_res</span>
                <span class="c1"># Residual computation</span>
                <span class="n">grad</span> <span class="o">=</span> <span class="n">grad</span><span class="o">*</span><span class="mi">0</span>
                <span class="k">if</span> <span class="n">j</span><span class="o">==</span><span class="mi">0</span> <span class="ow">and</span> <span class="n">k</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
                        <span class="n">resk</span><span class="p">[:,:,</span><span class="n">l</span><span class="p">]</span> <span class="o">=</span> <span class="n">res</span><span class="p">[:,:,</span><span class="n">l</span><span class="p">]</span><span class="o">-</span><span class="p">(</span><span class="n">w</span><span class="p">[</span><span class="n">l</span><span class="p">]</span><span class="o">*</span><span class="n">flux_ref</span><span class="o">/</span><span class="p">(</span><span class="n">sig_est</span><span class="p">[</span><span class="n">l</span><span class="p">]</span><span class="o">*</span><span class="n">flux_est</span><span class="p">[</span><span class="n">l</span><span class="p">]))</span><span class="o">*</span><span class="n">utils</span><span class="o">.</span><span class="n">decim</span><span class="p">(</span><span class="n">scisig</span><span class="o">.</span><span class="n">fftconvolve</span><span class="p">(</span><span class="n">comp</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">],</span><span class="n">shift_ker_stack</span><span class="p">[:,:,</span><span class="n">l</span><span class="p">],</span><span class="n">mode</span><span class="o">=</span><span class="s1">&#39;same&#39;</span><span class="p">),</span><span class="n">upfact</span><span class="p">,</span><span class="n">av_en</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                        <span class="n">grad</span> <span class="o">=</span> <span class="n">grad</span><span class="o">-</span><span class="p">(</span><span class="n">w</span><span class="p">[</span><span class="n">l</span><span class="p">]</span><span class="o">*</span><span class="n">flux_ref</span><span class="o">/</span><span class="p">(</span><span class="n">sig_est</span><span class="p">[</span><span class="n">l</span><span class="p">]</span><span class="o">*</span><span class="n">flux_est</span><span class="p">[</span><span class="n">l</span><span class="p">]))</span><span class="o">*</span><span class="n">scisig</span><span class="o">.</span><span class="n">convolve</span><span class="p">(</span><span class="n">utils</span><span class="o">.</span><span class="n">transpose_decim</span><span class="p">(</span><span class="n">resk</span><span class="p">[:,:,</span><span class="n">l</span><span class="p">],</span><span class="n">upfact</span><span class="p">),</span><span class="n">shift_ker_stack_adj</span><span class="p">[:,:,</span><span class="n">l</span><span class="p">],</span><span class="n">mode</span><span class="o">=</span><span class="s1">&#39;same&#39;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">grad</span> <span class="o">=</span> <span class="n">grad</span><span class="o">-</span><span class="p">(</span><span class="n">w</span><span class="p">[</span><span class="n">l</span><span class="p">]</span><span class="o">*</span><span class="n">flux_ref</span><span class="o">/</span><span class="p">(</span><span class="n">sig_est</span><span class="p">[</span><span class="n">l</span><span class="p">]</span><span class="o">*</span><span class="n">flux_est</span><span class="p">[</span><span class="n">l</span><span class="p">]))</span><span class="o">*</span><span class="n">scisig</span><span class="o">.</span><span class="n">convolve</span><span class="p">(</span><span class="n">utils</span><span class="o">.</span><span class="n">transpose_decim</span><span class="p">(</span><span class="n">resk</span><span class="p">[:,:,</span><span class="n">l</span><span class="p">],</span><span class="n">upfact</span><span class="p">),</span><span class="n">shift_ker_stack_adj</span><span class="p">[:,:,</span><span class="n">l</span><span class="p">],</span><span class="n">mode</span><span class="o">=</span><span class="s1">&#39;same&#39;</span><span class="p">)</span>

                <span class="n">buff</span><span class="p">[</span><span class="n">j</span><span class="o">%</span><span class="n">nb_subiter_min</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">resk</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>


                <span class="k">if</span> <span class="n">j</span><span class="o">&gt;=</span><span class="n">nb_subiter_min</span><span class="p">:</span>
                    <span class="n">cur_res</span> <span class="o">=</span> <span class="n">buff</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">cur_res</span> <span class="o">=</span> <span class="n">buff</span><span class="p">[</span><span class="n">j</span><span class="o">%</span><span class="n">nb_subiter_min</span><span class="p">]</span>

                <span class="c1"># Noise estimation</span>
                <span class="n">input_trans</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="n">to_old</span><span class="p">[</span><span class="n">k</span><span class="o">%</span><span class="mi">2</span><span class="p">]</span>
                <span class="n">input_trans</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">grad</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">j</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
                    <span class="n">noise_vect_1</span> <span class="o">=</span> <span class="n">sr_op_trans_stack_translate_inv</span><span class="p">(</span><span class="n">input_trans</span><span class="p">,</span><span class="n">nb_iter_noisest</span><span class="p">)</span>
                    <span class="n">sig_map</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">res_sig_map</span><span class="p">(</span><span class="n">noise_vect_1</span><span class="o">*</span><span class="n">to_old</span><span class="p">[</span><span class="n">k</span><span class="o">%</span><span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="n">rho</span><span class="p">,</span><span class="n">opt</span><span class="o">=</span><span class="n">opt</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">j</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
                    <span class="nb">print</span> <span class="s2">&quot;Estimated noise at the first scales: &quot;</span><span class="p">,</span><span class="n">sig_map</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,:]</span>
                <span class="n">thresh_map</span> <span class="o">=</span> <span class="n">nsig</span><span class="o">*</span><span class="n">sig_map</span>

                <span class="c1"># Dual variables update</span>
                <span class="c1"># Positivity</span>
                <span class="n">t1</span> <span class="o">=</span> <span class="n">v</span><span class="o">+</span><span class="n">rho</span><span class="o">*</span><span class="n">comp</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">]</span>
                <span class="n">v</span> <span class="o">=</span> <span class="n">t1</span><span class="o">-</span><span class="n">rho</span><span class="o">*</span><span class="n">proj_affine_pos2</span><span class="p">(</span><span class="n">t1</span><span class="o">/</span><span class="n">rho</span><span class="p">,</span><span class="n">w</span><span class="p">,</span><span class="n">im_hr</span><span class="p">)</span>
                <span class="c1"># Sparsity</span>
                <span class="n">t2</span><span class="p">,</span><span class="n">mr_file</span> <span class="o">=</span> <span class="n">isap</span><span class="o">.</span><span class="n">mr_trans</span><span class="p">(</span><span class="n">comp</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">],</span><span class="n">opt</span><span class="o">=</span><span class="n">opt</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">i</span><span class="o">==</span><span class="mi">0</span> <span class="ow">and</span> <span class="n">k</span><span class="o">==</span><span class="mi">0</span> <span class="ow">and</span> <span class="p">(</span><span class="n">comp</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
                    <span class="n">tempy</span> <span class="o">=</span> <span class="n">isap</span><span class="o">.</span><span class="n">mr_recons_coeff</span><span class="p">(</span><span class="n">t2</span><span class="p">,</span><span class="n">mr_file</span><span class="p">)</span>
                    <span class="n">a</span> <span class="o">=</span> <span class="p">(</span><span class="n">comp</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">]</span><span class="o">*</span><span class="n">tempy</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
                    <span class="n">b</span> <span class="o">=</span> <span class="p">(</span><span class="n">t2</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
                    <span class="n">wvl_transp_cor</span> <span class="o">=</span> <span class="n">b</span><span class="o">/</span><span class="n">a</span>
                    <span class="nb">print</span> <span class="s1">&#39;--------- correction coeff: &#39;</span><span class="p">,</span><span class="n">wvl_transp_cor</span><span class="p">,</span><span class="s1">&#39; --------------------&#39;</span>

                <span class="n">t3</span> <span class="o">=</span> <span class="n">u</span><span class="o">+</span><span class="n">rho</span><span class="o">*</span><span class="n">t2</span>
                <span class="n">u</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">l_inf_ball_proj_3D</span><span class="p">(</span><span class="n">t3</span><span class="p">,</span><span class="n">thresh_map</span><span class="o">*</span><span class="n">weights_sp</span><span class="p">,</span><span class="n">thresh_type</span><span class="p">)</span>

                <span class="c1"># Primal variable update</span>
                <span class="n">t4</span> <span class="o">=</span> <span class="n">isap</span><span class="o">.</span><span class="n">mr_recons_coeff</span><span class="p">(</span><span class="n">u</span><span class="p">,</span><span class="n">mr_file</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">wvl_transp_cor</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">t5</span> <span class="o">=</span> <span class="n">t4</span><span class="o">+</span><span class="n">v</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">t5</span> <span class="o">=</span> <span class="n">wvl_transp_cor</span><span class="o">*</span><span class="n">t4</span><span class="o">+</span><span class="n">v</span>
                <span class="n">t6</span> <span class="o">=</span> <span class="n">x</span> <span class="o">-</span> <span class="n">to_old</span><span class="p">[(</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">%</span><span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="n">t5</span>
                <span class="n">xold</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
                <span class="n">input_trans_prox</span><span class="p">[</span><span class="o">-</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">to_old</span><span class="p">[(</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">%</span><span class="mi">2</span><span class="p">]</span>
                <span class="n">input_trans_prox</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">t6</span>
                <span class="c1"># Ref value</span>
                <span class="n">prox_cost</span><span class="o">=</span><span class="mi">0</span>
                <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
                    <span class="n">prox_cost</span> <span class="o">=</span> <span class="n">prox_cost</span> <span class="o">+</span> <span class="p">((</span><span class="n">res</span><span class="p">[:,:,</span><span class="n">l</span><span class="p">]</span><span class="o">-</span><span class="p">(</span><span class="n">w</span><span class="p">[</span><span class="n">l</span><span class="p">]</span><span class="o">*</span><span class="n">flux_ref</span><span class="o">/</span><span class="p">(</span><span class="n">sig_est</span><span class="p">[</span><span class="n">l</span><span class="p">]</span><span class="o">*</span><span class="n">flux_est</span><span class="p">[</span><span class="n">l</span><span class="p">]))</span><span class="o">*</span><span class="n">utils</span><span class="o">.</span><span class="n">decim</span><span class="p">(</span><span class="n">scisig</span><span class="o">.</span><span class="n">fftconvolve</span><span class="p">(</span><span class="n">t6</span><span class="p">,</span><span class="n">shift_ker_stack</span><span class="p">[:,:,</span><span class="n">l</span><span class="p">],</span><span class="n">mode</span><span class="o">=</span><span class="s1">&#39;same&#39;</span><span class="p">),</span><span class="n">upfact</span><span class="p">,</span><span class="n">av_en</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
                <span class="nb">print</span> <span class="s2">&quot;ref prox cost value: &quot;</span><span class="p">,</span><span class="n">to_old</span><span class="p">[(</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">%</span><span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="n">prox_cost</span>
                <span class="n">x</span> <span class="o">=</span> <span class="n">sr_op_trans_stack_prox</span><span class="p">(</span><span class="n">input_trans_prox</span><span class="p">,</span><span class="n">nb_iter_noisest</span><span class="p">)</span>
                <span class="c1"># Optimal value</span>
                <span class="n">prox_opt</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
                    <span class="n">prox_opt</span> <span class="o">=</span> <span class="n">prox_opt</span> <span class="o">+</span> <span class="p">((</span><span class="n">res</span><span class="p">[:,:,</span><span class="n">l</span><span class="p">]</span><span class="o">-</span><span class="p">(</span><span class="n">w</span><span class="p">[</span><span class="n">l</span><span class="p">]</span><span class="o">*</span><span class="n">flux_ref</span><span class="o">/</span><span class="p">(</span><span class="n">sig_est</span><span class="p">[</span><span class="n">l</span><span class="p">]</span><span class="o">*</span><span class="n">flux_est</span><span class="p">[</span><span class="n">l</span><span class="p">]))</span><span class="o">*</span><span class="n">utils</span><span class="o">.</span><span class="n">decim</span><span class="p">(</span><span class="n">scisig</span><span class="o">.</span><span class="n">fftconvolve</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">shift_ker_stack</span><span class="p">[:,:,</span><span class="n">l</span><span class="p">],</span><span class="n">mode</span><span class="o">=</span><span class="s1">&#39;same&#39;</span><span class="p">),</span><span class="n">upfact</span><span class="p">,</span><span class="n">av_en</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
                <span class="nb">print</span> <span class="s2">&quot;optimal prox cost value: &quot;</span><span class="p">,</span><span class="n">to_old</span><span class="p">[(</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">%</span><span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="n">prox_opt</span><span class="o">+</span><span class="p">((</span><span class="n">x</span><span class="o">-</span><span class="n">t6</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>

                <span class="c1"># Acceleration</span>
                <span class="c1"># Hyper parameters update</span>
                <span class="k">if</span> <span class="n">accel_en</span><span class="o">==</span><span class="kc">True</span><span class="p">:</span>
                    <span class="n">theta</span> <span class="o">=</span> <span class="mf">1.0</span><span class="o">/</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="mi">2</span><span class="o">*</span><span class="n">gam</span><span class="o">*</span><span class="n">to_old</span><span class="p">[(</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">%</span><span class="mi">2</span><span class="p">])</span>
                    <span class="n">to_old</span><span class="p">[</span><span class="n">k</span><span class="o">%</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">theta</span><span class="o">*</span><span class="n">to_old</span><span class="p">[(</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">%</span><span class="mi">2</span><span class="p">]</span>
                    <span class="n">rho</span> <span class="o">=</span> <span class="n">rho</span><span class="o">/</span><span class="n">theta</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">theta</span> <span class="o">=</span> <span class="n">theta</span><span class="o">*</span><span class="n">exp</span><span class="p">((</span><span class="o">-</span><span class="n">j</span><span class="o">/</span><span class="n">decay_fact</span><span class="p">))</span>
                <span class="n">comp_old</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">comp</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">])</span>
                <span class="n">comp</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">x</span><span class="o">+</span><span class="n">theta</span><span class="o">*</span><span class="p">(</span><span class="n">x</span><span class="o">-</span><span class="n">xold</span><span class="p">)</span>
                <span class="n">j</span><span class="o">+=</span><span class="mi">1</span>

                <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
                    <span class="n">resk</span><span class="p">[:,:,</span><span class="n">l</span><span class="p">]</span> <span class="o">=</span> <span class="n">res</span><span class="p">[:,:,</span><span class="n">l</span><span class="p">]</span><span class="o">-</span><span class="p">(</span><span class="n">w</span><span class="p">[</span><span class="n">l</span><span class="p">]</span><span class="o">*</span><span class="n">flux_ref</span><span class="o">/</span><span class="p">(</span><span class="n">sig_est</span><span class="p">[</span><span class="n">l</span><span class="p">]</span><span class="o">*</span><span class="n">flux_est</span><span class="p">[</span><span class="n">l</span><span class="p">]))</span><span class="o">*</span><span class="n">utils</span><span class="o">.</span><span class="n">decim</span><span class="p">(</span><span class="n">scisig</span><span class="o">.</span><span class="n">fftconvolve</span><span class="p">(</span><span class="n">comp</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">],</span><span class="n">shift_ker_stack</span><span class="p">[:,:,</span><span class="n">l</span><span class="p">],</span><span class="n">mode</span><span class="o">=</span><span class="s1">&#39;same&#39;</span><span class="p">),</span><span class="n">upfact</span><span class="p">,</span><span class="n">av_en</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                <span class="n">buff</span><span class="p">[</span><span class="n">j</span><span class="o">%</span><span class="n">nb_subiter_min</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">resk</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>

                <span class="nb">print</span> <span class="s2">&quot;mse: &quot;</span><span class="p">,</span> <span class="n">buff</span><span class="p">[</span><span class="n">j</span><span class="o">%</span><span class="n">nb_subiter_min</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">j</span><span class="o">&gt;=</span><span class="n">nb_subiter_min</span><span class="p">:</span>
                    <span class="n">cur_res</span> <span class="o">=</span> <span class="n">buff</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">cur_res</span> <span class="o">=</span> <span class="n">buff</span><span class="p">[</span><span class="n">j</span><span class="o">%</span><span class="n">nb_subiter_min</span><span class="p">]</span>

                <span class="k">if</span> <span class="n">i</span><span class="o">==</span><span class="mi">0</span> <span class="ow">and</span> <span class="n">k</span><span class="o">==</span><span class="mi">0</span> <span class="ow">and</span> <span class="n">wvl_transp_cor</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">rho</span> <span class="o">=</span> <span class="mf">0.9</span><span class="o">/</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">wvl_transp_cor</span><span class="p">)</span>
                    <span class="n">to_old</span> <span class="o">=</span> <span class="mf">0.9</span><span class="o">*</span><span class="n">ones</span><span class="p">((</span><span class="mi">2</span><span class="p">,))</span><span class="o">/</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">wvl_transp_cor</span><span class="p">)</span>

                <span class="c1">#if j==1 and cur_res&gt;res_old:</span>
                <span class="c1">#   res_old = 2*cur_res        # Might tolerate a degration of the residual in the first iteration of the estimation loop of a component</span>
            <span class="sd">&quot;&quot;&quot;if cur_res&gt;res_old:</span>
<span class="sd">                comp[:,:,i]=copy(comp_old)&quot;&quot;&quot;</span>
            <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
                <span class="n">comp_lr</span><span class="p">[:,:,</span><span class="n">l</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">flux_ref</span><span class="o">/</span><span class="p">(</span><span class="n">sig_est</span><span class="p">[</span><span class="n">l</span><span class="p">]</span><span class="o">*</span><span class="n">flux_est</span><span class="p">[</span><span class="n">l</span><span class="p">]))</span><span class="o">*</span><span class="n">utils</span><span class="o">.</span><span class="n">decim</span><span class="p">(</span><span class="n">scisig</span><span class="o">.</span><span class="n">fftconvolve</span><span class="p">(</span><span class="n">comp</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">],</span><span class="n">shift_ker_stack</span><span class="p">[:,:,</span><span class="n">l</span><span class="p">],</span><span class="n">mode</span><span class="o">=</span><span class="s1">&#39;same&#39;</span><span class="p">),</span><span class="n">upfact</span><span class="p">,</span><span class="n">av_en</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>


            <span class="k">if</span> <span class="n">k</span><span class="o">&lt;</span><span class="n">nb_iter</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">accel_en</span><span class="o">==</span><span class="kc">True</span><span class="p">:</span>
                    <span class="n">eig_vect_min</span><span class="p">,</span><span class="n">gam</span> <span class="o">=</span> <span class="n">min_eig_val</span><span class="p">(</span><span class="n">sr_op_trans_stack</span><span class="p">,</span><span class="nb">input</span><span class="p">,</span><span class="n">siz_in</span><span class="p">,</span><span class="n">eig_max</span><span class="o">=</span><span class="n">eig_max</span><span class="p">,</span><span class="n">eig_min_init</span><span class="o">=</span><span class="n">eig_min_init</span><span class="p">)</span>
                    <span class="n">gam</span> <span class="o">=</span> <span class="mf">0.9</span><span class="o">*</span><span class="n">gam</span>
                    <span class="n">eig_min_init</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">eig_vect_min</span><span class="p">)</span>

                <span class="c1"># Reweighting</span>
                <span class="n">coeffx</span><span class="p">,</span><span class="n">mr_file</span> <span class="o">=</span> <span class="n">isap</span><span class="o">.</span><span class="n">mr_trans</span><span class="p">(</span><span class="n">comp</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">],</span><span class="n">opt</span><span class="o">=</span><span class="n">opt</span><span class="p">)</span>
                <span class="n">weights_sp</span>  <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="nb">abs</span><span class="p">(</span><span class="n">coeffx</span><span class="p">[:,:,:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span><span class="o">/</span><span class="p">(</span><span class="n">nsig</span><span class="o">*</span><span class="n">sig_map</span><span class="p">))</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
            <span class="c1"># ith component coeff estimation</span>
            <span class="k">if</span> <span class="n">k</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
                <span class="n">w</span> <span class="o">=</span> <span class="n">lsq_coeff_stack</span><span class="p">(</span><span class="n">comp_lr</span><span class="p">,</span><span class="n">res</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">w</span> <span class="o">=</span> <span class="n">non_unif_smoothing</span><span class="p">(</span><span class="n">neigh</span><span class="p">,</span><span class="n">dist_weights</span><span class="p">,</span><span class="n">w</span><span class="p">,</span><span class="n">res</span><span class="p">,</span><span class="n">comp_lr</span><span class="p">,</span><span class="n">mu</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">spec_rad</span><span class="o">=</span><span class="n">spec_rad_smooth</span><span class="p">,</span><span class="n">nb_iter</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
            <span class="nb">print</span> <span class="s2">&quot;weights: &quot;</span><span class="p">,</span><span class="n">w</span>
            <span class="k">if</span> <span class="n">k</span><span class="o">&lt;</span><span class="n">nb_iter</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                <span class="n">w</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">vect_recond</span><span class="p">(</span><span class="n">w</span><span class="p">,</span><span class="n">cond_fact</span><span class="p">)</span>
                <span class="nb">print</span> <span class="s2">&quot;weights balanced: &quot;</span><span class="p">,</span><span class="n">w</span>
            <span class="nb">input</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">=</span><span class="n">w</span>
            <span class="n">input_trans</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">=</span><span class="n">w</span>
            <span class="n">input_trans_prox</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">=</span><span class="n">w</span>

            <span class="c1"># Hyper parameters reset</span>
            <span class="n">rho</span> <span class="o">=</span> <span class="n">weights_bal</span><span class="o">*</span><span class="mf">0.9</span><span class="o">/</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">wvl_transp_cor</span><span class="p">)</span>
            <span class="n">to_old</span> <span class="o">=</span> <span class="mf">0.9</span><span class="o">*</span><span class="n">ones</span><span class="p">((</span><span class="mi">2</span><span class="p">,))</span><span class="o">/</span><span class="p">((</span><span class="mi">1</span><span class="o">+</span><span class="n">wvl_transp_cor</span><span class="p">)</span><span class="o">*</span><span class="n">rho</span><span class="p">)</span>

        <span class="c1"># Residual update and HR images update</span>
        <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">w</span><span class="p">)</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
                <span class="n">res</span><span class="p">[:,:,</span><span class="n">l</span><span class="p">]</span> <span class="o">=</span> <span class="n">res</span><span class="p">[:,:,</span><span class="n">l</span><span class="p">]</span><span class="o">-</span><span class="p">(</span><span class="n">w</span><span class="p">[</span><span class="n">l</span><span class="p">]</span><span class="o">*</span><span class="n">flux_ref</span><span class="o">/</span><span class="p">(</span><span class="n">sig_est</span><span class="p">[</span><span class="n">l</span><span class="p">]</span><span class="o">*</span><span class="n">flux_est</span><span class="p">[</span><span class="n">l</span><span class="p">]))</span><span class="o">*</span><span class="n">utils</span><span class="o">.</span><span class="n">decim</span><span class="p">(</span><span class="n">scisig</span><span class="o">.</span><span class="n">fftconvolve</span><span class="p">(</span><span class="n">comp</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">],</span><span class="n">shift_ker_stack</span><span class="p">[:,:,</span><span class="n">l</span><span class="p">],</span><span class="n">mode</span><span class="o">=</span><span class="s1">&#39;same&#39;</span><span class="p">),</span><span class="n">upfact</span><span class="p">,</span><span class="n">av_en</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                <span class="n">im_hr</span><span class="p">[:,:,</span><span class="n">l</span><span class="p">]</span> <span class="o">=</span> <span class="n">im_hr</span><span class="p">[:,:,</span><span class="n">l</span><span class="p">]</span><span class="o">+</span><span class="n">w</span><span class="p">[</span><span class="n">l</span><span class="p">]</span><span class="o">*</span><span class="n">comp</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">]</span>
            <span class="n">weights</span><span class="p">[:,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">w</span>
        <span class="n">i</span><span class="o">+=</span><span class="mi">1</span>
        <span class="c1"># Optim variables resetting</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="o">*</span><span class="mi">0</span>
        <span class="n">u</span> <span class="o">=</span> <span class="n">u</span><span class="o">*</span><span class="mi">0</span>
        <span class="n">v</span> <span class="o">=</span> <span class="n">v</span><span class="o">*</span><span class="mi">0</span>

    <span class="k">return</span> <span class="n">im_hr</span><span class="p">,</span><span class="n">comp</span><span class="p">,</span><span class="n">weights</span><span class="p">,</span><span class="n">res</span><span class="p">,</span><span class="n">sig_est</span><span class="o">*</span><span class="n">sig_min</span><span class="p">,</span><span class="n">flux_est</span><span class="p">,</span><span class="n">shifts</span>

<span class="k">def</span> <span class="nf">low_rank_comp_wise_sparse_dist_recond_2</span><span class="p">(</span><span class="n">psf_stack_in</span><span class="p">,</span><span class="n">field_dist</span><span class="p">,</span><span class="n">upfact</span><span class="p">,</span><span class="n">opt</span><span class="p">,</span><span class="n">nsig</span><span class="p">,</span><span class="n">neigh_frac</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span><span class="n">dist_weight_deg</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">shifts</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">opt_shift_est</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">nsig_shift_est</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">sig_est</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">flux_est</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">nb_iter</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span><span class="n">nb_subiter</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span><span class="n">nb_subiter_min</span><span class="o">=</span><span class="mi">7</span><span class="p">,</span><span class="n">mu</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span><span class="n">nb_comp_max</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span><span class="n">tol</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span><span class="n">wvl_transp_cor</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">accel_en</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">decay_fact</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">cond_fact</span><span class="o">=</span><span class="mf">1.0</span><span class="p">):</span>
    <span class="nb">print</span> <span class="s2">&quot;---------------- Reconditioned RCA 2 -----------------&quot;</span>
    <span class="n">psf_stack</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">psf_stack_in</span><span class="p">)</span>

    <span class="c1"># Degradation operator parameters estimation</span>
    <span class="k">if</span> <span class="n">sig_est</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">sig_est</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">im_gauss_nois_est_cube</span><span class="p">(</span><span class="n">psf_stack_in</span><span class="p">,</span><span class="n">opt</span><span class="o">=</span><span class="n">opt_shift_est</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">shifts</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1">#shifts = utils.shift_est(psf_stack)*upfact</span>
        <span class="c1">#shifts = utils.wvl_shift_est(psf_stack,opt_shift_est,nsig_shift_est)*upfact</span>
        <span class="n">shifts</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">thresh_shift_est</span><span class="p">(</span><span class="n">psf_stack</span><span class="p">,</span><span class="n">sig_thresh</span><span class="o">=</span><span class="n">sig_est</span><span class="p">,</span><span class="n">opt</span><span class="o">=</span><span class="n">opt_shift_est</span><span class="p">)</span><span class="o">*</span><span class="n">upfact</span>
    <span class="n">shift_ker_stack</span><span class="p">,</span><span class="n">shift_ker_stack_adj</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">shift_ker_stack</span><span class="p">(</span><span class="n">shifts</span><span class="p">,</span><span class="n">upfact</span><span class="p">)</span>

    <span class="n">sig_min</span> <span class="o">=</span> <span class="n">sig_est</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
    <span class="n">sig_est</span> <span class="o">=</span> <span class="n">sig_est</span><span class="o">/</span><span class="n">sig_min</span>
    <span class="n">shap</span> <span class="o">=</span> <span class="n">psf_stack</span><span class="o">.</span><span class="n">shape</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
        <span class="n">psf_stack</span><span class="p">[:,:,</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">psf_stack</span><span class="p">[:,:,</span><span class="n">k</span><span class="p">]</span><span class="o">/</span><span class="n">sig_est</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">flux_est</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">flux_est</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">flux_estimate_stack</span><span class="p">(</span><span class="n">psf_stack_in</span><span class="p">,</span><span class="n">rad</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
    <span class="n">flux_ref</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">flux_est</span><span class="p">)</span>
    <span class="n">weights</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">nb_comp_max</span><span class="p">))</span>
    <span class="n">comp</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">upfact</span><span class="o">*</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">upfact</span><span class="o">*</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">nb_comp_max</span><span class="p">))</span>
    <span class="nb">input</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">upfact</span><span class="o">*</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">upfact</span><span class="o">*</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
    <span class="nb">input</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="nb">input</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">upfact</span><span class="p">)</span>
    <span class="nb">input</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">shift_ker_stack</span><span class="p">)</span>
    <span class="nb">input</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">shift_ker_stack_adj</span><span class="p">)</span>
    <span class="n">w</span> <span class="o">=</span> <span class="n">ones</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">],))</span>
    <span class="n">im_hr</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">upfact</span><span class="o">*</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">upfact</span><span class="o">*</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>
    <span class="nb">input</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">w</span><span class="p">)</span>
    <span class="nb">input</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sig_est</span><span class="p">)</span>
    <span class="nb">input</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">flux_est</span><span class="p">)</span>
    <span class="n">input_trans</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="nb">input</span><span class="p">)</span>

    <span class="c1"># Distances settings</span>
    <span class="nb">print</span> <span class="s2">&quot;Contructing PSF tree...&quot;</span>
    <span class="n">neigh</span><span class="p">,</span><span class="n">dists</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">knn_interf</span><span class="p">(</span><span class="n">field_dist</span><span class="p">,</span><span class="nb">int</span><span class="p">(</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="n">neigh_frac</span><span class="p">))</span>
    <span class="nb">print</span> <span class="s2">&quot;Done...&quot;</span>
    <span class="n">dist_med</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">dists</span><span class="p">)</span>
    <span class="n">dist_weights</span> <span class="o">=</span> <span class="p">(</span><span class="n">dist_med</span><span class="o">/</span><span class="n">dists</span><span class="p">)</span><span class="o">**</span><span class="n">dist_weight_deg</span>
    <span class="c1"># Spatial smoothing operator gradient lip constant estimation</span>
    <span class="n">spec_rad_smooth</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="sd">&quot;&quot;&quot;input_dist_op = list()</span>
<span class="sd">        input_dist_op.append(w)</span>
<span class="sd">        input_dist_op.append(neigh)</span>
<span class="sd">        input_dist_op.append(dist_weights)</span>
<span class="sd">        eig_smooth,spec_rad_smooth = pow_meth(grad_nn_unif_smooth_imp,input_dist_op,shap[2])&quot;&quot;&quot;</span>

    <span class="n">siz_in</span> <span class="o">=</span> <span class="n">upfact</span><span class="o">*</span><span class="n">array</span><span class="p">(</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">eig_max</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">eig_min_init</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">gam</span><span class="o">=</span><span class="kc">None</span>
    <span class="k">if</span> <span class="n">accel_en</span><span class="o">==</span><span class="kc">True</span><span class="p">:</span>
        <span class="n">eig_vect_min</span><span class="p">,</span><span class="n">gam</span> <span class="o">=</span> <span class="n">min_eig_val</span><span class="p">(</span><span class="n">sr_op_trans_stack</span><span class="p">,</span><span class="nb">input</span><span class="p">,</span><span class="n">siz_in</span><span class="p">,</span><span class="n">eig_max</span><span class="o">=</span><span class="n">eig_max</span><span class="p">,</span><span class="n">eig_min_init</span><span class="o">=</span><span class="n">eig_min_init</span><span class="p">)</span>
        <span class="n">gam</span> <span class="o">=</span> <span class="n">gam</span><span class="o">*</span><span class="mf">0.9</span>
        <span class="n">eig_min_init</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">eig_vect_min</span><span class="p">)</span>

    <span class="c1"># Accelerated Chamb-Pock variables</span>
    <span class="n">comp</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">upfact</span><span class="o">*</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">upfact</span><span class="o">*</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">nb_comp_max</span><span class="p">))</span> <span class="c1"># Main variable</span>
    <span class="n">comp_old</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">upfact</span><span class="o">*</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">upfact</span><span class="o">*</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">upfact</span><span class="o">*</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">upfact</span><span class="o">*</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span> <span class="c1"># Primal variable</span>
    <span class="n">u</span><span class="p">,</span><span class="n">mr_file</span> <span class="o">=</span> <span class="n">isap</span><span class="o">.</span><span class="n">mr_trans</span><span class="p">(</span><span class="n">comp</span><span class="p">[:,:,</span><span class="mi">0</span><span class="p">],</span><span class="n">opt</span><span class="o">=</span><span class="n">opt</span><span class="p">)</span> <span class="c1"># First dual variable</span>
    <span class="n">u</span> <span class="o">=</span> <span class="n">u</span><span class="o">*</span><span class="mi">0</span>
    <span class="n">v</span> <span class="o">=</span> <span class="mi">0</span><span class="o">*</span><span class="n">comp</span><span class="p">[:,:,</span><span class="mi">0</span><span class="p">]</span> <span class="c1"># Second dual variable</span>
    <span class="n">grad</span> <span class="o">=</span> <span class="n">x</span><span class="o">*</span><span class="mi">0</span>

    <span class="n">shap2</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">weights_sp</span> <span class="o">=</span> <span class="n">ones</span><span class="p">((</span><span class="n">shap2</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">shap2</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">shap2</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">psf_stack</span><span class="p">)</span>
    <span class="n">comp_lr</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">psf_stack</span><span class="p">)</span>
    <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">buff</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">nb_subiter_min</span><span class="p">))</span>
    <span class="n">comp_var</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">nb_comp_max</span><span class="p">,))</span>

    <span class="n">to</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">rho</span> <span class="o">=</span> <span class="kc">None</span> <span class="c1"># to*rho&lt;L**(-2)</span>
    <span class="n">to_old</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">theta</span><span class="o">=</span><span class="mi">1</span>
    <span class="n">input_trans</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">to</span><span class="p">)</span>

    <span class="n">input_trans_prox</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">input_trans</span><span class="p">)</span>
    <span class="n">input_trans_prox</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">copy</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
    <span class="n">input_trans_prox</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">copy</span><span class="p">(</span><span class="n">psf_stack</span><span class="p">))</span>

    <span class="n">nb_iter_noisest</span> <span class="o">=</span> <span class="mi">20</span>
    <span class="n">thresh_type</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">noise_vect_1</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">sig_map</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">cur_res</span><span class="o">=</span><span class="mf">100000000.0</span>
    <span class="n">res_old</span><span class="o">=</span><span class="mf">1000000000.0</span>
    <span class="n">abs_count</span><span class="o">=</span><span class="mi">1</span>
    <span class="k">while</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">nb_comp_max</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">i</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
            <span class="n">w</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">abs_val_reverting</span><span class="p">(</span><span class="n">weights</span><span class="p">[:,</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="c1">#spec_rad = spec_rad_init</span>
        <span class="c1">#eig = eig_init</span>
        <span class="n">resk</span> <span class="o">=</span> <span class="n">res</span><span class="o">*</span><span class="mi">0</span>
        <span class="n">input_trans_prox</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>
        <span class="n">weights_sp</span> <span class="o">=</span> <span class="n">ones</span><span class="p">((</span><span class="n">shap2</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">shap2</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">shap2</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>
        <span class="nb">input</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">=</span><span class="n">w</span>
        <span class="n">input_trans</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">=</span><span class="n">w</span>
        <span class="n">input_trans_prox</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">=</span><span class="n">w</span>
        <span class="n">eig_max</span><span class="p">,</span><span class="n">spec_rad</span> <span class="o">=</span> <span class="n">pow_meth</span><span class="p">(</span><span class="n">sr_op_trans_stack</span><span class="p">,</span><span class="nb">input</span><span class="p">,</span><span class="n">siz_in</span><span class="p">,</span><span class="n">ainit</span><span class="o">=</span><span class="n">eig_max</span><span class="p">)</span>
        <span class="nb">print</span> <span class="s2">&quot;spectral radius: &quot;</span><span class="p">,</span><span class="n">spec_rad</span>
        <span class="c1"># Hyper parameters reset</span>
        <span class="n">to</span> <span class="o">=</span> <span class="n">cond_fact</span><span class="o">/</span><span class="n">spec_rad</span>
        <span class="k">if</span> <span class="n">wvl_transp_cor</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">rho</span> <span class="o">=</span> <span class="mf">0.9</span><span class="o">/</span><span class="p">((</span><span class="mi">3</span><span class="o">*</span><span class="n">to</span><span class="p">)</span><span class="o">*</span><span class="n">abs_count</span><span class="p">)</span> <span class="c1"># to*rho&lt;L**(-2)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">rho</span> <span class="o">=</span> <span class="mf">0.9</span><span class="o">/</span><span class="p">(((</span><span class="mi">1</span><span class="o">+</span><span class="n">wvl_transp_cor</span><span class="p">)</span><span class="o">*</span><span class="n">to</span><span class="p">)</span><span class="o">*</span><span class="n">abs_count</span><span class="p">)</span> <span class="c1"># to*rho&lt;L**(-2)</span>
        <span class="n">to_old</span> <span class="o">=</span> <span class="n">ones</span><span class="p">((</span><span class="mi">2</span><span class="p">,))</span><span class="o">*</span><span class="n">to</span>
        <span class="n">input_trans_prox</span><span class="p">[</span><span class="o">-</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">to_old</span><span class="p">[(</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">%</span><span class="mi">2</span><span class="p">]</span>
        <span class="n">input_trans</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="n">to_old</span><span class="p">[(</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">%</span><span class="mi">2</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_iter</span><span class="p">):</span>
            <span class="n">t</span><span class="o">=</span><span class="mi">1</span>
            <span class="c1"># ith component estimation</span>
            <span class="n">j</span><span class="o">=</span><span class="mi">0</span>
            <span class="c1">#print &#39;--------------- &#39;,nb_subiter,&#39; ----------------&#39;</span>
            <span class="n">res_old</span> <span class="o">=</span> <span class="n">cur_res</span><span class="o">*</span><span class="mi">2</span>

            <span class="k">while</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">nb_subiter</span> <span class="ow">and</span> <span class="mi">100</span><span class="o">*</span><span class="nb">abs</span><span class="p">(</span><span class="n">cur_res</span><span class="o">-</span><span class="n">res_old</span><span class="p">)</span><span class="o">/</span><span class="n">res_old</span><span class="o">&gt;</span><span class="mf">0.1</span><span class="p">:</span><span class="c1"># and cur_res&lt;res_old:</span>
                <span class="n">abs_count</span><span class="o">+=</span><span class="mi">1</span>
                <span class="n">res_old</span> <span class="o">=</span> <span class="n">cur_res</span>
                <span class="c1"># Residual computation</span>
                <span class="n">grad</span> <span class="o">=</span> <span class="n">grad</span><span class="o">*</span><span class="mi">0</span>
                <span class="k">if</span> <span class="n">j</span><span class="o">==</span><span class="mi">0</span> <span class="ow">and</span> <span class="n">k</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
                        <span class="n">resk</span><span class="p">[:,:,</span><span class="n">l</span><span class="p">]</span> <span class="o">=</span> <span class="n">res</span><span class="p">[:,:,</span><span class="n">l</span><span class="p">]</span><span class="o">-</span><span class="p">(</span><span class="n">w</span><span class="p">[</span><span class="n">l</span><span class="p">]</span><span class="o">*</span><span class="n">flux_ref</span><span class="o">/</span><span class="p">(</span><span class="n">sig_est</span><span class="p">[</span><span class="n">l</span><span class="p">]</span><span class="o">*</span><span class="n">flux_est</span><span class="p">[</span><span class="n">l</span><span class="p">]))</span><span class="o">*</span><span class="n">utils</span><span class="o">.</span><span class="n">decim</span><span class="p">(</span><span class="n">scisig</span><span class="o">.</span><span class="n">fftconvolve</span><span class="p">(</span><span class="n">comp</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">],</span><span class="n">shift_ker_stack</span><span class="p">[:,:,</span><span class="n">l</span><span class="p">],</span><span class="n">mode</span><span class="o">=</span><span class="s1">&#39;same&#39;</span><span class="p">),</span><span class="n">upfact</span><span class="p">,</span><span class="n">av_en</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                        <span class="n">grad</span> <span class="o">=</span> <span class="n">grad</span><span class="o">-</span><span class="p">(</span><span class="n">w</span><span class="p">[</span><span class="n">l</span><span class="p">]</span><span class="o">*</span><span class="n">flux_ref</span><span class="o">/</span><span class="p">(</span><span class="n">sig_est</span><span class="p">[</span><span class="n">l</span><span class="p">]</span><span class="o">*</span><span class="n">flux_est</span><span class="p">[</span><span class="n">l</span><span class="p">]))</span><span class="o">*</span><span class="n">scisig</span><span class="o">.</span><span class="n">convolve</span><span class="p">(</span><span class="n">utils</span><span class="o">.</span><span class="n">transpose_decim</span><span class="p">(</span><span class="n">resk</span><span class="p">[:,:,</span><span class="n">l</span><span class="p">],</span><span class="n">upfact</span><span class="p">),</span><span class="n">shift_ker_stack_adj</span><span class="p">[:,:,</span><span class="n">l</span><span class="p">],</span><span class="n">mode</span><span class="o">=</span><span class="s1">&#39;same&#39;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">grad</span> <span class="o">=</span> <span class="n">grad</span><span class="o">-</span><span class="p">(</span><span class="n">w</span><span class="p">[</span><span class="n">l</span><span class="p">]</span><span class="o">*</span><span class="n">flux_ref</span><span class="o">/</span><span class="p">(</span><span class="n">sig_est</span><span class="p">[</span><span class="n">l</span><span class="p">]</span><span class="o">*</span><span class="n">flux_est</span><span class="p">[</span><span class="n">l</span><span class="p">]))</span><span class="o">*</span><span class="n">scisig</span><span class="o">.</span><span class="n">convolve</span><span class="p">(</span><span class="n">utils</span><span class="o">.</span><span class="n">transpose_decim</span><span class="p">(</span><span class="n">resk</span><span class="p">[:,:,</span><span class="n">l</span><span class="p">],</span><span class="n">upfact</span><span class="p">),</span><span class="n">shift_ker_stack_adj</span><span class="p">[:,:,</span><span class="n">l</span><span class="p">],</span><span class="n">mode</span><span class="o">=</span><span class="s1">&#39;same&#39;</span><span class="p">)</span>

                <span class="n">buff</span><span class="p">[</span><span class="n">j</span><span class="o">%</span><span class="n">nb_subiter_min</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">resk</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>


                <span class="k">if</span> <span class="n">j</span><span class="o">&gt;=</span><span class="n">nb_subiter_min</span><span class="p">:</span>
                    <span class="n">cur_res</span> <span class="o">=</span> <span class="n">buff</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">cur_res</span> <span class="o">=</span> <span class="n">buff</span><span class="p">[</span><span class="n">j</span><span class="o">%</span><span class="n">nb_subiter_min</span><span class="p">]</span>

                <span class="c1"># Noise estimation</span>
                <span class="n">input_trans</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="n">to_old</span><span class="p">[</span><span class="n">k</span><span class="o">%</span><span class="mi">2</span><span class="p">]</span>
                <span class="n">input_trans</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">grad</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">j</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
                    <span class="n">noise_vect_1</span> <span class="o">=</span> <span class="n">sr_op_trans_stack_translate_inv</span><span class="p">(</span><span class="n">input_trans</span><span class="p">,</span><span class="n">nb_iter_noisest</span><span class="p">)</span>
                    <span class="n">sig_map</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">res_sig_map</span><span class="p">(</span><span class="n">noise_vect_1</span><span class="o">*</span><span class="n">to_old</span><span class="p">[</span><span class="n">k</span><span class="o">%</span><span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="n">rho</span><span class="p">,</span><span class="n">opt</span><span class="o">=</span><span class="n">opt</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">j</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
                    <span class="nb">print</span> <span class="s2">&quot;Estimated noise at the first scales: &quot;</span><span class="p">,</span><span class="n">sig_map</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,:]</span>
                <span class="n">thresh_map</span> <span class="o">=</span> <span class="n">nsig</span><span class="o">*</span><span class="n">sig_map</span>

                <span class="c1"># Dual variables update</span>
                <span class="k">if</span> <span class="n">i</span><span class="o">==</span><span class="mi">0</span> <span class="ow">and</span> <span class="n">k</span><span class="o">==</span><span class="mi">0</span> <span class="ow">and</span> <span class="n">wvl_transp_cor</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">to</span> <span class="o">=</span> <span class="n">cond_fact</span><span class="o">/</span><span class="n">spec_rad</span>
                    <span class="n">rho</span> <span class="o">=</span> <span class="mf">0.9</span><span class="o">/</span><span class="p">((</span><span class="mi">1</span><span class="o">+</span><span class="n">wvl_transp_cor</span><span class="p">)</span><span class="o">*</span><span class="n">to</span><span class="o">*</span><span class="n">abs_count</span><span class="p">)</span> <span class="c1"># to*rho&lt;L**(-2)</span>
                    <span class="n">to_old</span> <span class="o">=</span> <span class="n">ones</span><span class="p">((</span><span class="mi">2</span><span class="p">,))</span><span class="o">*</span><span class="n">to</span>
                    <span class="n">input_trans_prox</span><span class="p">[</span><span class="o">-</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">to_old</span><span class="p">[(</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">%</span><span class="mi">2</span><span class="p">]</span>
                <span class="k">elif</span> <span class="n">wvl_transp_cor</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">rho</span> <span class="o">=</span> <span class="mf">0.9</span><span class="o">/</span><span class="p">((</span><span class="mi">1</span><span class="o">+</span><span class="n">wvl_transp_cor</span><span class="p">)</span><span class="o">*</span><span class="n">to</span><span class="o">*</span><span class="n">abs_count</span><span class="p">)</span>
                <span class="c1"># Positivity</span>
                <span class="n">t1</span> <span class="o">=</span> <span class="n">v</span><span class="o">+</span><span class="n">rho</span><span class="o">*</span><span class="n">comp</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">]</span>
                <span class="n">v</span> <span class="o">=</span> <span class="n">t1</span><span class="o">-</span><span class="n">rho</span><span class="o">*</span><span class="n">proj_affine_pos2</span><span class="p">(</span><span class="n">t1</span><span class="o">/</span><span class="n">rho</span><span class="p">,</span><span class="n">w</span><span class="p">,</span><span class="n">im_hr</span><span class="p">)</span>
                <span class="c1"># Sparsity</span>
                <span class="n">t2</span><span class="p">,</span><span class="n">mr_file</span> <span class="o">=</span> <span class="n">isap</span><span class="o">.</span><span class="n">mr_trans</span><span class="p">(</span><span class="n">comp</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">],</span><span class="n">opt</span><span class="o">=</span><span class="n">opt</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">i</span><span class="o">==</span><span class="mi">0</span> <span class="ow">and</span> <span class="n">k</span><span class="o">==</span><span class="mi">0</span> <span class="ow">and</span> <span class="p">(</span><span class="n">comp</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
                    <span class="n">tempy</span> <span class="o">=</span> <span class="n">isap</span><span class="o">.</span><span class="n">mr_recons_coeff</span><span class="p">(</span><span class="n">t2</span><span class="p">,</span><span class="n">mr_file</span><span class="p">)</span>
                    <span class="n">a</span> <span class="o">=</span> <span class="p">(</span><span class="n">comp</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">]</span><span class="o">*</span><span class="n">tempy</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
                    <span class="n">b</span> <span class="o">=</span> <span class="p">(</span><span class="n">t2</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
                    <span class="n">wvl_transp_cor</span> <span class="o">=</span> <span class="n">a</span><span class="o">/</span><span class="n">b</span>
                    <span class="nb">print</span> <span class="s1">&#39;--------- correction coeff: &#39;</span><span class="p">,</span><span class="n">wvl_transp_cor</span><span class="p">,</span><span class="s1">&#39; --------------------&#39;</span>

                <span class="n">t3</span> <span class="o">=</span> <span class="n">u</span><span class="o">+</span><span class="n">rho</span><span class="o">*</span><span class="n">t2</span>
                <span class="n">u</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">l_inf_ball_proj_3D</span><span class="p">(</span><span class="n">t3</span><span class="p">,</span><span class="n">thresh_map</span><span class="o">*</span><span class="n">weights_sp</span><span class="p">,</span><span class="n">thresh_type</span><span class="p">)</span>

                <span class="c1"># Primal variable update</span>
                <span class="n">t4</span> <span class="o">=</span> <span class="n">isap</span><span class="o">.</span><span class="n">mr_recons_coeff</span><span class="p">(</span><span class="n">u</span><span class="p">,</span><span class="n">mr_file</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">wvl_transp_cor</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">t5</span> <span class="o">=</span> <span class="n">t4</span><span class="o">+</span><span class="n">v</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">t5</span> <span class="o">=</span> <span class="n">wvl_transp_cor</span><span class="o">*</span><span class="n">t4</span><span class="o">+</span><span class="n">v</span>
                <span class="n">t6</span> <span class="o">=</span> <span class="n">x</span> <span class="o">-</span> <span class="n">to_old</span><span class="p">[(</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">%</span><span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="n">t5</span>
                <span class="n">xold</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
                <span class="n">input_trans_prox</span><span class="p">[</span><span class="o">-</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">to_old</span><span class="p">[(</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">%</span><span class="mi">2</span><span class="p">]</span>
                <span class="n">input_trans_prox</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">t6</span>
                <span class="c1"># Ref value</span>
                <span class="n">prox_cost</span><span class="o">=</span><span class="mi">0</span>
                <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
                    <span class="n">prox_cost</span> <span class="o">=</span> <span class="n">prox_cost</span> <span class="o">+</span> <span class="p">((</span><span class="n">res</span><span class="p">[:,:,</span><span class="n">l</span><span class="p">]</span><span class="o">-</span><span class="p">(</span><span class="n">w</span><span class="p">[</span><span class="n">l</span><span class="p">]</span><span class="o">*</span><span class="n">flux_ref</span><span class="o">/</span><span class="p">(</span><span class="n">sig_est</span><span class="p">[</span><span class="n">l</span><span class="p">]</span><span class="o">*</span><span class="n">flux_est</span><span class="p">[</span><span class="n">l</span><span class="p">]))</span><span class="o">*</span><span class="n">utils</span><span class="o">.</span><span class="n">decim</span><span class="p">(</span><span class="n">scisig</span><span class="o">.</span><span class="n">fftconvolve</span><span class="p">(</span><span class="n">t6</span><span class="p">,</span><span class="n">shift_ker_stack</span><span class="p">[:,:,</span><span class="n">l</span><span class="p">],</span><span class="n">mode</span><span class="o">=</span><span class="s1">&#39;same&#39;</span><span class="p">),</span><span class="n">upfact</span><span class="p">,</span><span class="n">av_en</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
                <span class="nb">print</span> <span class="s2">&quot;ref prox cost value: &quot;</span><span class="p">,</span><span class="n">to_old</span><span class="p">[(</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">%</span><span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="n">prox_cost</span>
                <span class="n">x</span> <span class="o">=</span> <span class="n">sr_op_trans_stack_prox</span><span class="p">(</span><span class="n">input_trans_prox</span><span class="p">,</span><span class="n">nb_iter_noisest</span><span class="p">)</span>
                <span class="c1"># Optimal value</span>
                <span class="n">prox_opt</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
                    <span class="n">prox_opt</span> <span class="o">=</span> <span class="n">prox_opt</span> <span class="o">+</span> <span class="p">((</span><span class="n">res</span><span class="p">[:,:,</span><span class="n">l</span><span class="p">]</span><span class="o">-</span><span class="p">(</span><span class="n">w</span><span class="p">[</span><span class="n">l</span><span class="p">]</span><span class="o">*</span><span class="n">flux_ref</span><span class="o">/</span><span class="p">(</span><span class="n">sig_est</span><span class="p">[</span><span class="n">l</span><span class="p">]</span><span class="o">*</span><span class="n">flux_est</span><span class="p">[</span><span class="n">l</span><span class="p">]))</span><span class="o">*</span><span class="n">utils</span><span class="o">.</span><span class="n">decim</span><span class="p">(</span><span class="n">scisig</span><span class="o">.</span><span class="n">fftconvolve</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">shift_ker_stack</span><span class="p">[:,:,</span><span class="n">l</span><span class="p">],</span><span class="n">mode</span><span class="o">=</span><span class="s1">&#39;same&#39;</span><span class="p">),</span><span class="n">upfact</span><span class="p">,</span><span class="n">av_en</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
                <span class="nb">print</span> <span class="s2">&quot;optimal prox cost value: &quot;</span><span class="p">,</span><span class="n">to_old</span><span class="p">[(</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">%</span><span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="n">prox_opt</span><span class="o">+</span><span class="p">((</span><span class="n">x</span><span class="o">-</span><span class="n">t6</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>

                <span class="c1"># Acceleration</span>
                <span class="c1"># Hyper parameters update</span>
                <span class="k">if</span> <span class="n">accel_en</span><span class="o">==</span><span class="kc">True</span><span class="p">:</span>
                    <span class="n">theta</span> <span class="o">=</span> <span class="mf">1.0</span><span class="o">/</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="mi">2</span><span class="o">*</span><span class="n">gam</span><span class="o">*</span><span class="n">to_old</span><span class="p">[(</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">%</span><span class="mi">2</span><span class="p">])</span>
                    <span class="n">to_old</span><span class="p">[</span><span class="n">k</span><span class="o">%</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">theta</span><span class="o">*</span><span class="n">to_old</span><span class="p">[(</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">%</span><span class="mi">2</span><span class="p">]</span>
                    <span class="n">rho</span> <span class="o">=</span> <span class="n">rho</span><span class="o">/</span><span class="n">theta</span>
                <span class="c1">#else:</span>
                    <span class="c1">#theta = theta*exp((-j/decay_fact))</span>
                <span class="n">comp_old</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">comp</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">])</span>
                <span class="n">comp</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">x</span><span class="o">+</span><span class="n">theta</span><span class="o">*</span><span class="p">(</span><span class="n">x</span><span class="o">-</span><span class="n">xold</span><span class="p">)</span>
                <span class="n">j</span><span class="o">+=</span><span class="mi">1</span>

                <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
                    <span class="n">resk</span><span class="p">[:,:,</span><span class="n">l</span><span class="p">]</span> <span class="o">=</span> <span class="n">res</span><span class="p">[:,:,</span><span class="n">l</span><span class="p">]</span><span class="o">-</span><span class="p">(</span><span class="n">w</span><span class="p">[</span><span class="n">l</span><span class="p">]</span><span class="o">*</span><span class="n">flux_ref</span><span class="o">/</span><span class="p">(</span><span class="n">sig_est</span><span class="p">[</span><span class="n">l</span><span class="p">]</span><span class="o">*</span><span class="n">flux_est</span><span class="p">[</span><span class="n">l</span><span class="p">]))</span><span class="o">*</span><span class="n">utils</span><span class="o">.</span><span class="n">decim</span><span class="p">(</span><span class="n">scisig</span><span class="o">.</span><span class="n">fftconvolve</span><span class="p">(</span><span class="n">comp</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">],</span><span class="n">shift_ker_stack</span><span class="p">[:,:,</span><span class="n">l</span><span class="p">],</span><span class="n">mode</span><span class="o">=</span><span class="s1">&#39;same&#39;</span><span class="p">),</span><span class="n">upfact</span><span class="p">,</span><span class="n">av_en</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                <span class="n">buff</span><span class="p">[</span><span class="n">j</span><span class="o">%</span><span class="n">nb_subiter_min</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">resk</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>

                <span class="nb">print</span> <span class="s2">&quot;mse: &quot;</span><span class="p">,</span> <span class="n">buff</span><span class="p">[</span><span class="n">j</span><span class="o">%</span><span class="n">nb_subiter_min</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">j</span><span class="o">&gt;=</span><span class="n">nb_subiter_min</span><span class="p">:</span>
                    <span class="n">cur_res</span> <span class="o">=</span> <span class="n">buff</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">cur_res</span> <span class="o">=</span> <span class="n">buff</span><span class="p">[</span><span class="n">j</span><span class="o">%</span><span class="n">nb_subiter_min</span><span class="p">]</span>

                 <span class="c1"># to*rho&lt;L**(-2)</span>
                    <span class="c1">#input_trans[8] = to_old[(k+1)%2]</span>
            <span class="c1">#if j==1 and cur_res&gt;res_old:</span>
            <span class="c1">#   res_old = 2*cur_res        # Might tolerate a degration of the residual in the first iteration of the estimation loop of a component</span>
            <span class="sd">&quot;&quot;&quot;if cur_res&gt;res_old:</span>
<span class="sd">                comp[:,:,i]=copy(comp_old)&quot;&quot;&quot;</span>
            <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
                <span class="n">comp_lr</span><span class="p">[:,:,</span><span class="n">l</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">flux_ref</span><span class="o">/</span><span class="p">(</span><span class="n">sig_est</span><span class="p">[</span><span class="n">l</span><span class="p">]</span><span class="o">*</span><span class="n">flux_est</span><span class="p">[</span><span class="n">l</span><span class="p">]))</span><span class="o">*</span><span class="n">utils</span><span class="o">.</span><span class="n">decim</span><span class="p">(</span><span class="n">scisig</span><span class="o">.</span><span class="n">fftconvolve</span><span class="p">(</span><span class="n">comp</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">],</span><span class="n">shift_ker_stack</span><span class="p">[:,:,</span><span class="n">l</span><span class="p">],</span><span class="n">mode</span><span class="o">=</span><span class="s1">&#39;same&#39;</span><span class="p">),</span><span class="n">upfact</span><span class="p">,</span><span class="n">av_en</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>


            <span class="k">if</span> <span class="n">k</span><span class="o">&lt;</span><span class="n">nb_iter</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">accel_en</span><span class="o">==</span><span class="kc">True</span><span class="p">:</span>
                    <span class="n">eig_vect_min</span><span class="p">,</span><span class="n">gam</span> <span class="o">=</span> <span class="n">min_eig_val</span><span class="p">(</span><span class="n">sr_op_trans_stack</span><span class="p">,</span><span class="nb">input</span><span class="p">,</span><span class="n">siz_in</span><span class="p">,</span><span class="n">eig_max</span><span class="o">=</span><span class="n">eig_max</span><span class="p">,</span><span class="n">eig_min_init</span><span class="o">=</span><span class="n">eig_min_init</span><span class="p">)</span>
                    <span class="n">gam</span> <span class="o">=</span> <span class="mf">0.9</span><span class="o">*</span><span class="n">gam</span>
                    <span class="n">eig_min_init</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">eig_vect_min</span><span class="p">)</span>
                <span class="c1"># Reweighting</span>
                <span class="n">coeffx</span><span class="p">,</span><span class="n">mr_file</span> <span class="o">=</span> <span class="n">isap</span><span class="o">.</span><span class="n">mr_trans</span><span class="p">(</span><span class="n">comp</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">],</span><span class="n">opt</span><span class="o">=</span><span class="n">opt</span><span class="p">)</span>
                <span class="n">weights_sp</span>  <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="nb">abs</span><span class="p">(</span><span class="n">coeffx</span><span class="p">[:,:,:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span><span class="o">/</span><span class="p">(</span><span class="n">nsig</span><span class="o">*</span><span class="n">sig_map</span><span class="p">))</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
                <span class="c1"># ith component coeff estimation</span>
            <span class="k">if</span> <span class="n">k</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
                <span class="n">w</span> <span class="o">=</span> <span class="n">lsq_coeff_stack</span><span class="p">(</span><span class="n">comp_lr</span><span class="p">,</span><span class="n">res</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">w</span> <span class="o">=</span> <span class="n">non_unif_smoothing</span><span class="p">(</span><span class="n">neigh</span><span class="p">,</span><span class="n">dist_weights</span><span class="p">,</span><span class="n">w</span><span class="p">,</span><span class="n">res</span><span class="p">,</span><span class="n">comp_lr</span><span class="p">,</span><span class="n">mu</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">spec_rad</span><span class="o">=</span><span class="n">spec_rad_smooth</span><span class="p">,</span><span class="n">nb_iter</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
            <span class="nb">print</span> <span class="s2">&quot;weights: &quot;</span><span class="p">,</span><span class="n">w</span>
            <span class="k">if</span> <span class="n">k</span><span class="o">&lt;</span><span class="n">nb_iter</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                <span class="nb">input</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">=</span><span class="n">w</span>
                <span class="n">input_trans</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">=</span><span class="n">w</span>
                <span class="n">input_trans_prox</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">=</span><span class="n">w</span>
                <span class="n">eig_max</span><span class="p">,</span><span class="n">spec_rad</span> <span class="o">=</span> <span class="n">pow_meth</span><span class="p">(</span><span class="n">sr_op_trans_stack</span><span class="p">,</span><span class="nb">input</span><span class="p">,</span><span class="n">siz_in</span><span class="p">,</span><span class="n">ainit</span><span class="o">=</span><span class="n">eig_max</span><span class="p">)</span>
                <span class="nb">print</span> <span class="s2">&quot;spectral radius: &quot;</span><span class="p">,</span><span class="n">spec_rad</span>
                <span class="c1"># Hyper parameters reset</span>
                <span class="n">to</span> <span class="o">=</span> <span class="n">cond_fact</span><span class="o">/</span><span class="n">spec_rad</span>
                <span class="n">rho</span> <span class="o">=</span> <span class="mf">0.9</span><span class="o">/</span><span class="p">((</span><span class="mi">1</span><span class="o">+</span><span class="n">wvl_transp_cor</span><span class="p">)</span><span class="o">*</span><span class="n">to</span><span class="o">*</span><span class="n">abs_count</span><span class="p">)</span> <span class="c1"># to*rho&lt;L**(-2)</span>
                <span class="n">to_old</span> <span class="o">=</span> <span class="n">ones</span><span class="p">((</span><span class="mi">2</span><span class="p">,))</span><span class="o">*</span><span class="n">to</span>
                <span class="n">input_trans_prox</span><span class="p">[</span><span class="o">-</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">to_old</span><span class="p">[(</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">%</span><span class="mi">2</span><span class="p">]</span>
                <span class="n">input_trans</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="n">to_old</span><span class="p">[(</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">%</span><span class="mi">2</span><span class="p">]</span>
        <span class="c1"># Residual update and HR images update</span>
        <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">w</span><span class="p">)</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
                <span class="n">res</span><span class="p">[:,:,</span><span class="n">l</span><span class="p">]</span> <span class="o">=</span> <span class="n">res</span><span class="p">[:,:,</span><span class="n">l</span><span class="p">]</span><span class="o">-</span><span class="p">(</span><span class="n">w</span><span class="p">[</span><span class="n">l</span><span class="p">]</span><span class="o">*</span><span class="n">flux_ref</span><span class="o">/</span><span class="p">(</span><span class="n">sig_est</span><span class="p">[</span><span class="n">l</span><span class="p">]</span><span class="o">*</span><span class="n">flux_est</span><span class="p">[</span><span class="n">l</span><span class="p">]))</span><span class="o">*</span><span class="n">utils</span><span class="o">.</span><span class="n">decim</span><span class="p">(</span><span class="n">scisig</span><span class="o">.</span><span class="n">fftconvolve</span><span class="p">(</span><span class="n">comp</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">],</span><span class="n">shift_ker_stack</span><span class="p">[:,:,</span><span class="n">l</span><span class="p">],</span><span class="n">mode</span><span class="o">=</span><span class="s1">&#39;same&#39;</span><span class="p">),</span><span class="n">upfact</span><span class="p">,</span><span class="n">av_en</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                <span class="n">im_hr</span><span class="p">[:,:,</span><span class="n">l</span><span class="p">]</span> <span class="o">=</span> <span class="n">im_hr</span><span class="p">[:,:,</span><span class="n">l</span><span class="p">]</span><span class="o">+</span><span class="n">w</span><span class="p">[</span><span class="n">l</span><span class="p">]</span><span class="o">*</span><span class="n">comp</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">]</span>
            <span class="n">weights</span><span class="p">[:,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">w</span>
        <span class="n">i</span><span class="o">+=</span><span class="mi">1</span>
        <span class="c1"># Optim variables resetting</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="o">*</span><span class="mi">0</span>
        <span class="n">u</span> <span class="o">=</span> <span class="n">u</span><span class="o">*</span><span class="mi">0</span>
        <span class="n">v</span> <span class="o">=</span> <span class="n">v</span><span class="o">*</span><span class="mi">0</span>

    <span class="k">return</span> <span class="n">im_hr</span><span class="p">,</span><span class="n">comp</span><span class="p">,</span><span class="n">weights</span><span class="p">,</span><span class="n">res</span><span class="p">,</span><span class="n">sig_est</span><span class="o">*</span><span class="n">sig_min</span><span class="p">,</span><span class="n">flux_est</span><span class="p">,</span><span class="n">shifts</span>



<span class="k">def</span> <span class="nf">low_rank_comp_wise_sparse_dist_GFB</span><span class="p">(</span><span class="n">psf_stack_in</span><span class="p">,</span><span class="n">field_dist</span><span class="p">,</span><span class="n">upfact</span><span class="p">,</span><span class="n">opt</span><span class="p">,</span><span class="n">nsig</span><span class="p">,</span>\
    <span class="n">neigh_frac</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span><span class="n">dist_weight_deg</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">shifts</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">opt_shift_est</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">nsig_shift_est</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>\
    <span class="n">sig_est</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">flux_est</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">nb_iter</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span><span class="n">nb_subiter</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span><span class="n">nb_subiter_min</span><span class="o">=</span><span class="mi">7</span><span class="p">,</span><span class="n">mu</span><span class="o">=</span><span class="mf">1.5</span><span class="p">,</span>\
    <span class="n">nb_comp_max</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span><span class="n">tol</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span><span class="n">wvl_transp_cor</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">cv_proof_en</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">line_search_en</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    <span class="n">psf_stack</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">psf_stack_in</span><span class="p">)</span>
    <span class="nb">print</span> <span class="s2">&quot;Minimiser: GFB&quot;</span>
    <span class="c1"># Degradation operator parameters estimation</span>
    <span class="k">if</span> <span class="n">shifts</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1">#shifts = utils.shift_est(psf_stack)*upfact</span>
        <span class="n">shifts</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">wvl_shift_est</span><span class="p">(</span><span class="n">psf_stack</span><span class="p">,</span><span class="n">opt_shift_est</span><span class="p">,</span><span class="n">nsig_shift_est</span><span class="p">)</span><span class="o">*</span><span class="n">upfact</span>
    <span class="n">shift_ker_stack</span><span class="p">,</span><span class="n">shift_ker_stack_adj</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">shift_ker_stack</span><span class="p">(</span><span class="n">shifts</span><span class="p">,</span><span class="n">upfact</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">sig_est</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">sig_est</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">im_gauss_nois_est_cube</span><span class="p">(</span><span class="n">psf_stack_in</span><span class="p">,</span><span class="n">opt</span><span class="o">=</span><span class="n">opt_shift_est</span><span class="p">)</span>
    <span class="n">sig_min</span> <span class="o">=</span> <span class="n">sig_est</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
    <span class="n">sig_est</span> <span class="o">=</span> <span class="n">sig_est</span><span class="o">/</span><span class="n">sig_min</span>
    <span class="n">shap</span> <span class="o">=</span> <span class="n">psf_stack</span><span class="o">.</span><span class="n">shape</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
        <span class="n">psf_stack</span><span class="p">[:,:,</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">psf_stack</span><span class="p">[:,:,</span><span class="n">k</span><span class="p">]</span><span class="o">/</span><span class="n">sig_est</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">flux_est</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">flux_est</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">flux_estimate_stack</span><span class="p">(</span><span class="n">psf_stack_in</span><span class="p">,</span><span class="n">rad</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
    <span class="n">flux_ref</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">flux_est</span><span class="p">)</span>
    <span class="n">weights</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">nb_comp_max</span><span class="p">))</span>
    <span class="n">w</span> <span class="o">=</span> <span class="n">ones</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">],))</span>
    <span class="n">im_hr</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">upfact</span><span class="o">*</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">upfact</span><span class="o">*</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>

    <span class="c1"># Distances settings</span>
    <span class="nb">print</span> <span class="s2">&quot;Contructing PSF tree...&quot;</span>
    <span class="n">neigh</span><span class="p">,</span><span class="n">dists</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">knn_interf</span><span class="p">(</span><span class="n">field_dist</span><span class="p">,</span><span class="nb">int</span><span class="p">(</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="n">neigh_frac</span><span class="p">))</span>
    <span class="nb">print</span> <span class="s2">&quot;Done...&quot;</span>
    <span class="n">dist_med</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">dists</span><span class="p">)</span>
    <span class="n">dist_weights</span> <span class="o">=</span> <span class="p">(</span><span class="n">dist_med</span><span class="o">/</span><span class="n">dists</span><span class="p">)</span><span class="o">**</span><span class="n">dist_weight_deg</span>
    <span class="c1"># Spatial smoothing operator gradient lip constant estimation</span>
    <span class="n">spec_rad_smooth</span> <span class="o">=</span> <span class="kc">None</span>


    <span class="n">siz_in</span> <span class="o">=</span> <span class="n">upfact</span><span class="o">*</span><span class="n">array</span><span class="p">(</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">eig_max</span> <span class="o">=</span> <span class="kc">None</span>


    <span class="c1"># GFB variables</span>
    <span class="nb">input</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">upfact</span><span class="o">*</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">upfact</span><span class="o">*</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
    <span class="nb">input</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="nb">input</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">upfact</span><span class="p">)</span>
    <span class="nb">input</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">shift_ker_stack</span><span class="p">)</span>
    <span class="nb">input</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">shift_ker_stack_adj</span><span class="p">)</span>
    <span class="n">w</span> <span class="o">=</span> <span class="n">ones</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">],))</span>
    <span class="n">im_hr</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">upfact</span><span class="o">*</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">upfact</span><span class="o">*</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>
    <span class="nb">input</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">w</span><span class="p">)</span>
    <span class="nb">input</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sig_est</span><span class="p">)</span>
    <span class="nb">input</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">flux_est</span><span class="p">)</span>
    <span class="n">comp</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">upfact</span><span class="o">*</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">upfact</span><span class="o">*</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">nb_comp_max</span><span class="p">))</span> <span class="c1"># Main variable</span>
    <span class="n">comp_old</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">upfact</span><span class="o">*</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">upfact</span><span class="o">*</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
    <span class="n">z1</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">upfact</span><span class="o">*</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">upfact</span><span class="o">*</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span> <span class="c1"># Sparse variable</span>
    <span class="n">z2</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">upfact</span><span class="o">*</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">upfact</span><span class="o">*</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span> <span class="c1"># Positive variable</span>
    <span class="n">compz1</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">upfact</span><span class="o">*</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">upfact</span><span class="o">*</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">nb_comp_max</span><span class="p">))</span> <span class="c1"># Main variable</span>
    <span class="n">compz2</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">upfact</span><span class="o">*</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">upfact</span><span class="o">*</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">nb_comp_max</span><span class="p">))</span> <span class="c1"># Main variable</span>
    <span class="n">coeff_init</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">w1</span> <span class="o">=</span> <span class="mf">0.8</span>
    <span class="n">w2</span> <span class="o">=</span> <span class="mf">0.2</span>
    <span class="n">lambd</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">grad</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">upfact</span><span class="o">*</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">upfact</span><span class="o">*</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>

    <span class="n">u</span><span class="p">,</span><span class="n">mr_file</span> <span class="o">=</span> <span class="n">isap</span><span class="o">.</span><span class="n">mr_trans</span><span class="p">(</span><span class="n">comp</span><span class="p">[:,:,</span><span class="mi">0</span><span class="p">],</span><span class="n">opt</span><span class="o">=</span><span class="n">opt</span><span class="p">)</span>
    <span class="n">shap2</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">weights_sp</span> <span class="o">=</span> <span class="n">ones</span><span class="p">((</span><span class="n">shap2</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">shap2</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">shap2</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">psf_stack</span><span class="p">)</span>
    <span class="n">comp_lr</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">psf_stack</span><span class="p">)</span>
    <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">buff</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">nb_subiter_min</span><span class="p">))</span>

    <span class="n">nb_iter_noisest</span> <span class="o">=</span> <span class="mi">20</span>
    <span class="n">nb_subiter_prox</span> <span class="o">=</span> <span class="mi">50</span>
    <span class="n">thresh_type</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">noise_vect_1</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">sig_map</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">cur_res</span><span class="o">=</span><span class="mf">100000000.0</span>
    <span class="n">res_old</span><span class="o">=</span><span class="mf">1000000000.0</span>
    <span class="nb">print</span> <span class="s2">&quot; -------------------- Debugging warning: constraints switched off; reweighting off; no coeff smoothing; positivity,fw-bw ------------------- &quot;</span>
    <span class="k">while</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">nb_comp_max</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">i</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
            <span class="n">w</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">abs_val_reverting</span><span class="p">(</span><span class="n">weights</span><span class="p">[:,</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="c1">#spec_rad = spec_rad_init</span>
        <span class="c1">#eig = eig_init</span>
        <span class="n">resk</span> <span class="o">=</span> <span class="n">res</span><span class="o">*</span><span class="mi">0</span>
        <span class="n">weights_sp</span> <span class="o">=</span> <span class="n">ones</span><span class="p">((</span><span class="n">shap2</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">shap2</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">shap2</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>
        <span class="nb">input</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">=</span><span class="n">w</span>
        <span class="n">eig_max</span><span class="p">,</span><span class="n">spec_rad</span> <span class="o">=</span> <span class="n">pow_meth</span><span class="p">(</span><span class="n">sr_op_trans_stack</span><span class="p">,</span><span class="nb">input</span><span class="p">,</span><span class="n">siz_in</span><span class="p">,</span><span class="n">ainit</span><span class="o">=</span><span class="n">eig_max</span><span class="p">)</span>
        <span class="sd">&quot;&quot;&quot;spec_rad=0</span>
<span class="sd">            for f in range(0,shap[2]):</span>
<span class="sd">            spec_rad = spec_rad+(w[f]*flux_ref/(sig_est[f]*flux_est[f]))**2*(abs(shift_ker_stack[:,:,f]).sum())**2</span>
<span class="sd">            print &quot;spectral radius: &quot;,spec_rad&quot;&quot;&quot;</span>

        <span class="n">nb_subiter_prox</span> <span class="o">=</span> <span class="mi">50</span>
        <span class="nb">print</span> <span class="s2">&quot;nb_iter: &quot;</span><span class="p">,</span><span class="n">nb_iter</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_iter</span><span class="p">):</span>
            <span class="n">t</span><span class="o">=</span><span class="mi">1</span>
            <span class="c1"># ith component estimation</span>
            <span class="n">j</span><span class="o">=</span><span class="mi">0</span>
            <span class="c1">#print &#39;--------------- &#39;,nb_subiter,&#39; ----------------&#39;</span>
            <span class="n">res_old</span> <span class="o">=</span> <span class="n">cur_res</span><span class="o">*</span><span class="mi">2</span>

            <span class="k">while</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">nb_subiter</span> <span class="ow">and</span> <span class="mi">100</span><span class="o">*</span><span class="nb">abs</span><span class="p">(</span><span class="n">cur_res</span><span class="o">-</span><span class="n">res_old</span><span class="p">)</span><span class="o">/</span><span class="n">res_old</span><span class="o">&gt;</span><span class="mf">0.1</span><span class="p">:</span>
                <span class="n">res_old</span> <span class="o">=</span> <span class="n">cur_res</span>
                <span class="c1"># Residual computation</span>
                <span class="n">grad</span> <span class="o">=</span> <span class="n">grad</span><span class="o">*</span><span class="mi">0</span>
                <span class="k">if</span> <span class="n">j</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
                        <span class="n">resk</span><span class="p">[:,:,</span><span class="n">l</span><span class="p">]</span> <span class="o">=</span> <span class="n">res</span><span class="p">[:,:,</span><span class="n">l</span><span class="p">]</span><span class="o">-</span><span class="p">(</span><span class="n">w</span><span class="p">[</span><span class="n">l</span><span class="p">]</span><span class="o">*</span><span class="n">flux_ref</span><span class="o">/</span><span class="p">(</span><span class="n">sig_est</span><span class="p">[</span><span class="n">l</span><span class="p">]</span><span class="o">*</span><span class="n">flux_est</span><span class="p">[</span><span class="n">l</span><span class="p">]))</span><span class="o">*</span><span class="n">utils</span><span class="o">.</span><span class="n">decim</span><span class="p">(</span><span class="n">scisig</span><span class="o">.</span><span class="n">fftconvolve</span><span class="p">(</span><span class="n">comp</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">],</span><span class="n">shift_ker_stack</span><span class="p">[:,:,</span><span class="n">l</span><span class="p">],</span><span class="n">mode</span><span class="o">=</span><span class="s1">&#39;same&#39;</span><span class="p">),</span><span class="n">upfact</span><span class="p">,</span><span class="n">av_en</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                        <span class="n">grad</span> <span class="o">=</span> <span class="n">grad</span><span class="o">-</span><span class="p">(</span><span class="n">w</span><span class="p">[</span><span class="n">l</span><span class="p">]</span><span class="o">*</span><span class="n">flux_ref</span><span class="o">/</span><span class="p">(</span><span class="n">sig_est</span><span class="p">[</span><span class="n">l</span><span class="p">]</span><span class="o">*</span><span class="n">flux_est</span><span class="p">[</span><span class="n">l</span><span class="p">]))</span><span class="o">*</span><span class="n">scisig</span><span class="o">.</span><span class="n">convolve</span><span class="p">(</span><span class="n">utils</span><span class="o">.</span><span class="n">transpose_decim</span><span class="p">(</span><span class="n">resk</span><span class="p">[:,:,</span><span class="n">l</span><span class="p">],</span><span class="n">upfact</span><span class="p">),</span><span class="n">shift_ker_stack_adj</span><span class="p">[:,:,</span><span class="n">l</span><span class="p">],</span><span class="n">mode</span><span class="o">=</span><span class="s1">&#39;same&#39;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
                        <span class="n">grad</span> <span class="o">=</span> <span class="n">grad</span><span class="o">-</span><span class="p">(</span><span class="n">w</span><span class="p">[</span><span class="n">l</span><span class="p">]</span><span class="o">*</span><span class="n">flux_ref</span><span class="o">/</span><span class="p">(</span><span class="n">sig_est</span><span class="p">[</span><span class="n">l</span><span class="p">]</span><span class="o">*</span><span class="n">flux_est</span><span class="p">[</span><span class="n">l</span><span class="p">]))</span><span class="o">*</span><span class="n">scisig</span><span class="o">.</span><span class="n">convolve</span><span class="p">(</span><span class="n">utils</span><span class="o">.</span><span class="n">transpose_decim</span><span class="p">(</span><span class="n">resk</span><span class="p">[:,:,</span><span class="n">l</span><span class="p">],</span><span class="n">upfact</span><span class="p">),</span><span class="n">shift_ker_stack_adj</span><span class="p">[:,:,</span><span class="n">l</span><span class="p">],</span><span class="n">mode</span><span class="o">=</span><span class="s1">&#39;same&#39;</span><span class="p">)</span>

                <span class="n">buff</span><span class="p">[</span><span class="n">j</span><span class="o">%</span><span class="n">nb_subiter_min</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">resk</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">j</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
                    <span class="nb">print</span> <span class="s2">&quot;---- Ref mse ---- &quot;</span><span class="p">,</span><span class="n">buff</span><span class="p">[</span><span class="n">j</span><span class="o">%</span><span class="n">nb_subiter_min</span><span class="p">]</span>

                <span class="k">if</span> <span class="n">j</span><span class="o">&gt;=</span><span class="n">nb_subiter_min</span><span class="p">:</span>
                    <span class="n">cur_res</span> <span class="o">=</span> <span class="n">buff</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">cur_res</span> <span class="o">=</span> <span class="n">buff</span><span class="p">[</span><span class="n">j</span><span class="o">%</span><span class="n">nb_subiter_min</span><span class="p">]</span>

                <span class="c1"># Exact line search</span>
                <span class="n">muj</span> <span class="o">=</span> <span class="n">mu</span><span class="o">/</span><span class="n">spec_rad</span>
                <span class="k">if</span> <span class="n">line_search_en</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
                    <span class="n">c1</span><span class="o">=</span><span class="mi">0</span>
                    <span class="n">c2</span><span class="o">=</span><span class="mi">0</span>
                    <span class="n">c3</span><span class="o">=</span><span class="mi">0</span>
                    <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
                        <span class="n">u1</span> <span class="o">=</span> <span class="n">res</span><span class="p">[:,:,</span><span class="n">l</span><span class="p">]</span><span class="o">-</span><span class="p">(</span><span class="n">w</span><span class="p">[</span><span class="n">l</span><span class="p">]</span><span class="o">*</span><span class="n">flux_ref</span><span class="o">/</span><span class="p">(</span><span class="n">sig_est</span><span class="p">[</span><span class="n">l</span><span class="p">]</span><span class="o">*</span><span class="n">flux_est</span><span class="p">[</span><span class="n">l</span><span class="p">]))</span><span class="o">*</span><span class="n">utils</span><span class="o">.</span><span class="n">decim</span><span class="p">(</span><span class="n">scisig</span><span class="o">.</span><span class="n">fftconvolve</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">comp</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">]</span><span class="o">-</span><span class="n">z1</span><span class="p">,</span><span class="n">shift_ker_stack</span><span class="p">[:,:,</span><span class="n">l</span><span class="p">],</span><span class="n">mode</span><span class="o">=</span><span class="s1">&#39;same&#39;</span><span class="p">),</span><span class="n">upfact</span><span class="p">,</span><span class="n">av_en</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                        <span class="n">u2</span> <span class="o">=</span> <span class="n">res</span><span class="p">[:,:,</span><span class="n">l</span><span class="p">]</span><span class="o">-</span><span class="p">(</span><span class="n">w</span><span class="p">[</span><span class="n">l</span><span class="p">]</span><span class="o">*</span><span class="n">flux_ref</span><span class="o">/</span><span class="p">(</span><span class="n">sig_est</span><span class="p">[</span><span class="n">l</span><span class="p">]</span><span class="o">*</span><span class="n">flux_est</span><span class="p">[</span><span class="n">l</span><span class="p">]))</span><span class="o">*</span><span class="n">utils</span><span class="o">.</span><span class="n">decim</span><span class="p">(</span><span class="n">scisig</span><span class="o">.</span><span class="n">fftconvolve</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">comp</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">]</span><span class="o">-</span><span class="n">z2</span><span class="p">,</span><span class="n">shift_ker_stack</span><span class="p">[:,:,</span><span class="n">l</span><span class="p">],</span><span class="n">mode</span><span class="o">=</span><span class="s1">&#39;same&#39;</span><span class="p">),</span><span class="n">upfact</span><span class="p">,</span><span class="n">av_en</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                        <span class="n">u3</span> <span class="o">=</span> <span class="o">-</span><span class="p">(</span><span class="n">w</span><span class="p">[</span><span class="n">l</span><span class="p">]</span><span class="o">*</span><span class="n">flux_ref</span><span class="o">/</span><span class="p">(</span><span class="n">sig_est</span><span class="p">[</span><span class="n">l</span><span class="p">]</span><span class="o">*</span><span class="n">flux_est</span><span class="p">[</span><span class="n">l</span><span class="p">]))</span><span class="o">*</span><span class="n">utils</span><span class="o">.</span><span class="n">decim</span><span class="p">(</span><span class="n">scisig</span><span class="o">.</span><span class="n">fftconvolve</span><span class="p">(</span><span class="n">grad</span><span class="p">,</span><span class="n">shift_ker_stack</span><span class="p">[:,:,</span><span class="n">l</span><span class="p">],</span><span class="n">mode</span><span class="o">=</span><span class="s1">&#39;same&#39;</span><span class="p">),</span><span class="n">upfact</span><span class="p">,</span><span class="n">av_en</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                        <span class="n">c1</span><span class="o">+=</span> <span class="p">(</span><span class="n">u1</span><span class="o">*</span><span class="n">u3</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
                        <span class="n">c2</span><span class="o">+=</span> <span class="p">(</span><span class="n">u2</span><span class="o">*</span><span class="n">u3</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
                        <span class="n">c3</span><span class="o">+=</span> <span class="p">(</span><span class="n">u3</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
                    <span class="n">muj</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">c1</span><span class="o">/</span><span class="n">c3</span><span class="p">,</span><span class="n">c2</span><span class="o">/</span><span class="n">c3</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">cv_proof_en</span> <span class="o">==</span><span class="mi">1</span><span class="p">:</span>
                    <span class="n">muj</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">muj</span><span class="p">,</span><span class="n">mu</span><span class="o">/</span><span class="n">spec_rad</span><span class="p">)</span>
                    <span class="nb">print</span> <span class="s2">&quot;Optimal step: &quot;</span><span class="p">,</span><span class="n">muj</span><span class="p">,</span><span class="s2">&quot; Max for cv proof: &quot;</span><span class="p">,</span><span class="mi">2</span><span class="o">/</span><span class="n">spec_rad</span>
                <span class="c1"># ---- Analysis constraint ---- #</span>
                <span class="c1"># Wavelet noise estimation</span>
                <span class="n">sig_map</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">res_sig_map</span><span class="p">(</span><span class="n">muj</span><span class="o">*</span><span class="n">grad</span><span class="p">,</span><span class="n">opt</span><span class="o">=</span><span class="n">opt</span><span class="p">)</span>
                <span class="n">temp1</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">comp</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">z1</span> <span class="o">-</span> <span class="n">muj</span><span class="o">*</span><span class="n">grad</span>
                <span class="n">thresh_map</span> <span class="o">=</span> <span class="n">nsig</span><span class="o">*</span><span class="n">sig_map</span>
                <span class="k">if</span> <span class="n">weights_sp</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">thresh_map</span> <span class="o">=</span> <span class="n">thresh_map</span><span class="o">*</span><span class="n">weights_sp</span>
                <span class="c1"># Sparsity</span>
                <span class="n">t2</span><span class="p">,</span><span class="n">mr_file</span> <span class="o">=</span> <span class="n">isap</span><span class="o">.</span><span class="n">mr_trans</span><span class="p">(</span><span class="n">comp</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">],</span><span class="n">opt</span><span class="o">=</span><span class="n">opt</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">i</span><span class="o">==</span><span class="mi">0</span> <span class="ow">and</span> <span class="n">k</span><span class="o">==</span><span class="mi">0</span> <span class="ow">and</span> <span class="p">(</span><span class="n">comp</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
                    <span class="n">tempy</span> <span class="o">=</span> <span class="n">isap</span><span class="o">.</span><span class="n">mr_recons_coeff</span><span class="p">(</span><span class="n">t2</span><span class="p">,</span><span class="n">mr_file</span><span class="p">)</span>
                    <span class="n">a</span> <span class="o">=</span> <span class="p">(</span><span class="n">comp</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">]</span><span class="o">*</span><span class="n">tempy</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
                    <span class="n">b</span> <span class="o">=</span> <span class="p">(</span><span class="n">t2</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
                    <span class="n">wvl_transp_cor</span> <span class="o">=</span> <span class="n">a</span><span class="o">/</span><span class="n">b</span>
                    <span class="nb">print</span> <span class="s1">&#39;--------- correction coeff: &#39;</span><span class="p">,</span><span class="n">wvl_transp_cor</span><span class="p">,</span><span class="s1">&#39; --------------------&#39;</span>

                <span class="c1">#result,mr_file,n,coeff_init = wvl_analysis_op(temp1,thresh_map,opt=opt,coeff_init=coeff_init,mr_file=mr_file,nb_iter=nb_subiter_prox,transp_coeff=wvl_transp_cor)</span>
                <span class="c1">#z1 = z1+lambd*(result-comp[:,:,i])</span>
                <span class="n">z1</span> <span class="o">=</span> <span class="n">z1</span><span class="o">+</span><span class="n">lambd</span><span class="o">*</span><span class="p">(</span><span class="n">temp1</span><span class="o">-</span><span class="n">comp</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">])</span>
                <span class="n">nb_subiter_prox</span> <span class="o">=</span> <span class="mi">10</span>
                <span class="c1"># ---- Positivity constraint ---- #</span>
                <span class="c1">#z2 = z2+lambd*(proj_affine_pos2(2*comp[:,:,i] - z2 - muj*grad,w,im_hr)-comp[:,:,i])</span>
                <span class="n">z2</span> <span class="o">=</span> <span class="n">z2</span><span class="o">+</span><span class="n">lambd</span><span class="o">*</span><span class="p">(</span><span class="n">comp</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">z2</span> <span class="o">-</span> <span class="n">muj</span><span class="o">*</span><span class="n">grad</span><span class="p">)</span>

                <span class="c1"># ---- Main variable update ---- #</span>
                <span class="n">comp</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">proj_affine_pos2</span><span class="p">(</span><span class="n">w1</span><span class="o">*</span><span class="n">z1</span> <span class="o">+</span> <span class="n">w2</span><span class="o">*</span><span class="n">z2</span><span class="p">,</span><span class="n">w</span><span class="p">,</span><span class="n">im_hr</span><span class="p">)</span>
                <span class="c1">#comp[:,:,i] = w1*z1 + w2*z2</span>

                <span class="k">if</span> <span class="n">j</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
                    <span class="nb">print</span> <span class="s2">&quot;Estimated noise at the first scales: &quot;</span><span class="p">,</span><span class="n">sig_map</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,:]</span>

                <span class="n">j</span><span class="o">+=</span><span class="mi">1</span>

                <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
                    <span class="n">resk</span><span class="p">[:,:,</span><span class="n">l</span><span class="p">]</span> <span class="o">=</span> <span class="n">res</span><span class="p">[:,:,</span><span class="n">l</span><span class="p">]</span><span class="o">-</span><span class="p">(</span><span class="n">w</span><span class="p">[</span><span class="n">l</span><span class="p">]</span><span class="o">*</span><span class="n">flux_ref</span><span class="o">/</span><span class="p">(</span><span class="n">sig_est</span><span class="p">[</span><span class="n">l</span><span class="p">]</span><span class="o">*</span><span class="n">flux_est</span><span class="p">[</span><span class="n">l</span><span class="p">]))</span><span class="o">*</span><span class="n">utils</span><span class="o">.</span><span class="n">decim</span><span class="p">(</span><span class="n">scisig</span><span class="o">.</span><span class="n">fftconvolve</span><span class="p">(</span><span class="n">comp</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">],</span><span class="n">shift_ker_stack</span><span class="p">[:,:,</span><span class="n">l</span><span class="p">],</span><span class="n">mode</span><span class="o">=</span><span class="s1">&#39;same&#39;</span><span class="p">),</span><span class="n">upfact</span><span class="p">,</span><span class="n">av_en</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                <span class="n">buff</span><span class="p">[</span><span class="n">j</span><span class="o">%</span><span class="n">nb_subiter_min</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">resk</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>

                <span class="nb">print</span> <span class="s2">&quot;mse: &quot;</span><span class="p">,</span> <span class="n">buff</span><span class="p">[</span><span class="n">j</span><span class="o">%</span><span class="n">nb_subiter_min</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">j</span><span class="o">&gt;=</span><span class="n">nb_subiter_min</span><span class="p">:</span>
                    <span class="n">cur_res</span> <span class="o">=</span> <span class="n">buff</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">cur_res</span> <span class="o">=</span> <span class="n">buff</span><span class="p">[</span><span class="n">j</span><span class="o">%</span><span class="n">nb_subiter_min</span><span class="p">]</span>


            <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
                <span class="n">comp_lr</span><span class="p">[:,:,</span><span class="n">l</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">flux_ref</span><span class="o">/</span><span class="p">(</span><span class="n">sig_est</span><span class="p">[</span><span class="n">l</span><span class="p">]</span><span class="o">*</span><span class="n">flux_est</span><span class="p">[</span><span class="n">l</span><span class="p">]))</span><span class="o">*</span><span class="n">utils</span><span class="o">.</span><span class="n">decim</span><span class="p">(</span><span class="n">scisig</span><span class="o">.</span><span class="n">fftconvolve</span><span class="p">(</span><span class="n">comp</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">],</span><span class="n">shift_ker_stack</span><span class="p">[:,:,</span><span class="n">l</span><span class="p">],</span><span class="n">mode</span><span class="o">=</span><span class="s1">&#39;same&#39;</span><span class="p">),</span><span class="n">upfact</span><span class="p">,</span><span class="n">av_en</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

            <span class="c1"># ith component coeff estimation</span>
            <span class="k">if</span> <span class="n">k</span><span class="o">&gt;=</span><span class="mi">0</span><span class="p">:</span>
                <span class="n">w</span> <span class="o">=</span> <span class="n">lsq_coeff_stack</span><span class="p">(</span><span class="n">comp_lr</span><span class="p">,</span><span class="n">res</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">w</span> <span class="o">=</span> <span class="n">non_unif_smoothing</span><span class="p">(</span><span class="n">neigh</span><span class="p">,</span><span class="n">dist_weights</span><span class="p">,</span><span class="n">w</span><span class="p">,</span><span class="n">res</span><span class="p">,</span><span class="n">comp_lr</span><span class="p">,</span><span class="n">mu</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">spec_rad</span><span class="o">=</span><span class="n">spec_rad_smooth</span><span class="p">,</span><span class="n">nb_iter</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
            <span class="nb">print</span> <span class="s2">&quot;------------------- Component &quot;</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="s2">&quot; ------------------&quot;</span>
            <span class="nb">print</span> <span class="s2">&quot;weights: &quot;</span><span class="p">,</span><span class="n">w</span>
            <span class="nb">input</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">=</span><span class="n">w</span>
            <span class="k">if</span> <span class="n">k</span><span class="o">&lt;</span><span class="n">nb_iter</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                <span class="c1"># Reweighting</span>
                <span class="c1">#coeffx,mr_file = isap.mr_trans(comp[:,:,i],opt=opt)</span>
                <span class="c1">#weights_sp  = (1+abs(coeffx[:,:,:-1])/(nsig*sig_map))**(-1)</span>

                <span class="c1"># Spectral radius</span>
                <span class="n">eig_max</span><span class="p">,</span><span class="n">spec_rad</span> <span class="o">=</span> <span class="n">pow_meth</span><span class="p">(</span><span class="n">sr_op_trans_stack</span><span class="p">,</span><span class="nb">input</span><span class="p">,</span><span class="n">siz_in</span><span class="p">,</span><span class="n">ainit</span><span class="o">=</span><span class="n">eig_max</span><span class="p">)</span>
                <span class="sd">&quot;&quot;&quot;spec_rad=0</span>
<span class="sd">                    for f in range(0,shap[2]):</span>
<span class="sd">                    spec_rad = spec_rad+(w[f]*flux_ref/(sig_est[f]*flux_est[f]))**2*(abs(shift_ker_stack[:,:,f]).sum())**2</span>
<span class="sd">                    print &quot;spectral radius: &quot;,spec_rad&quot;&quot;&quot;</span>


        <span class="c1"># Residual update and HR images update</span>
        <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">w</span><span class="p">)</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
                <span class="n">res</span><span class="p">[:,:,</span><span class="n">l</span><span class="p">]</span> <span class="o">=</span> <span class="n">res</span><span class="p">[:,:,</span><span class="n">l</span><span class="p">]</span><span class="o">-</span><span class="p">(</span><span class="n">w</span><span class="p">[</span><span class="n">l</span><span class="p">]</span><span class="o">*</span><span class="n">flux_ref</span><span class="o">/</span><span class="p">(</span><span class="n">sig_est</span><span class="p">[</span><span class="n">l</span><span class="p">]</span><span class="o">*</span><span class="n">flux_est</span><span class="p">[</span><span class="n">l</span><span class="p">]))</span><span class="o">*</span><span class="n">utils</span><span class="o">.</span><span class="n">decim</span><span class="p">(</span><span class="n">scisig</span><span class="o">.</span><span class="n">fftconvolve</span><span class="p">(</span><span class="n">comp</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">],</span><span class="n">shift_ker_stack</span><span class="p">[:,:,</span><span class="n">l</span><span class="p">],</span><span class="n">mode</span><span class="o">=</span><span class="s1">&#39;same&#39;</span><span class="p">),</span><span class="n">upfact</span><span class="p">,</span><span class="n">av_en</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                <span class="n">im_hr</span><span class="p">[:,:,</span><span class="n">l</span><span class="p">]</span> <span class="o">=</span> <span class="n">im_hr</span><span class="p">[:,:,</span><span class="n">l</span><span class="p">]</span><span class="o">+</span><span class="n">w</span><span class="p">[</span><span class="n">l</span><span class="p">]</span><span class="o">*</span><span class="n">comp</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">]</span>
            <span class="n">weights</span><span class="p">[:,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">w</span>
            <span class="nb">print</span> <span class="s2">&quot;---- Updated mse ---- &quot;</span><span class="p">,(</span><span class="n">res</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="n">compz1</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">z1</span>
        <span class="n">compz2</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">z2</span>
        <span class="n">i</span><span class="o">+=</span><span class="mi">1</span>
        <span class="c1"># Optim variables resetting</span>
        <span class="n">z1</span> <span class="o">=</span> <span class="n">z1</span><span class="o">*</span><span class="mi">0</span>
        <span class="n">z2</span> <span class="o">=</span> <span class="n">z2</span><span class="o">*</span><span class="mi">0</span>
    <span class="c1"># coeff_init = coeff_init*0</span>

    <span class="k">return</span> <span class="n">im_hr</span><span class="p">,</span><span class="n">comp</span><span class="p">,</span><span class="n">weights</span><span class="p">,</span><span class="n">res</span><span class="p">,</span><span class="n">sig_est</span><span class="o">*</span><span class="n">sig_min</span><span class="p">,</span><span class="n">flux_est</span><span class="p">,</span><span class="n">shifts</span><span class="p">,</span><span class="n">compz1</span><span class="p">,</span><span class="n">compz2</span>

<span class="k">def</span> <span class="nf">low_rank_global_src_est_cp</span><span class="p">(</span><span class="nb">input</span><span class="p">,</span><span class="n">weights</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">ksig</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span><span class="n">eps</span><span class="o">=</span><span class="mf">0.9</span><span class="p">,</span><span class="n">ainit</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">nb_iter</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span>\
    <span class="n">tol</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span><span class="n">nb_rw</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">pos_en</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">opt</span><span class="o">=</span><span class="s1">&#39;coif5&#39;</span><span class="p">,</span><span class="n">nb_scale</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">wav_en</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">wavr_en</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>\
    <span class="n">optr</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span><span class="n">nsig_hub</span><span class="o">=</span><span class="mi">1000000000000000000</span><span class="p">,</span><span class="n">Y1</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">Y2</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">Y3</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">V</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>\
    <span class="n">only_noise_est_en</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">select_en</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">thresh_perc</span> <span class="o">=</span> <span class="mf">0.01</span><span class="p">,</span><span class="n">rad</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>

    <span class="n">S</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="nb">input</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="c1"># (Main variable)</span>
    <span class="n">ref_mse</span> <span class="o">=</span> <span class="p">((</span><span class="n">y</span><span class="o">-</span><span class="n">sr_stack_op</span><span class="p">(</span><span class="nb">input</span><span class="p">))</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    <span class="n">l1_norm</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">S</span><span class="o">*</span><span class="n">weights</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    <span class="nb">print</span> <span class="s2">&quot;---&gt;&gt;ref res: &lt;&lt;---&quot;</span><span class="p">,</span><span class="n">ref_mse</span>
    <span class="nb">print</span> <span class="s2">&quot;---&gt;&gt;ref l1 norm: &lt;&lt;---&quot;</span><span class="p">,</span><span class="n">l1_norm</span>

    <span class="n">ker_adj</span> <span class="o">=</span> <span class="nb">input</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
    <span class="n">shap</span> <span class="o">=</span> <span class="n">ker_adj</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">A</span> <span class="o">=</span> <span class="nb">input</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>
    <span class="n">nb_im</span> <span class="o">=</span> <span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">shapS</span> <span class="o">=</span> <span class="n">S</span><span class="o">.</span><span class="n">shape</span>

    <span class="n">ind_select</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shapS</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>


    <span class="c1"># Spectral radius setting</span>
    <span class="n">spec_rad</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">pos_en</span><span class="p">:</span>
        <span class="n">eig_max</span><span class="p">,</span><span class="n">spec_rad</span> <span class="o">=</span> <span class="n">pow_meth</span><span class="p">(</span><span class="n">sr_stack_trans_op_cons_src</span><span class="p">,</span><span class="nb">input</span><span class="p">,</span><span class="n">shapS</span><span class="p">,</span><span class="n">ainit</span><span class="o">=</span><span class="n">ainit</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">eig_max</span><span class="p">,</span><span class="n">spec_rad</span> <span class="o">=</span> <span class="n">pow_meth</span><span class="p">(</span><span class="n">sr_stack_trans_op_src</span><span class="p">,</span><span class="nb">input</span><span class="p">,</span><span class="n">shapS</span><span class="p">,</span><span class="n">ainit</span><span class="o">=</span><span class="n">ainit</span><span class="p">)</span>
    <span class="n">corr_coeff</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">rad</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">if</span> <span class="n">wavr_en</span><span class="p">:</span>
        <span class="n">dirac</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">shapS</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">shapS</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
        <span class="n">dirac</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">shapS</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span><span class="p">),</span><span class="nb">int</span><span class="p">(</span><span class="n">shapS</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span><span class="p">)]</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">test</span><span class="p">,</span><span class="n">mr_file</span> <span class="o">=</span> <span class="n">isap</span><span class="o">.</span><span class="n">mr_trans</span><span class="p">(</span><span class="n">dirac</span><span class="p">,</span><span class="n">opt</span><span class="o">=</span><span class="n">optr</span><span class="p">)</span>
        <span class="n">corr_coeff</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">test</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
        <span class="nb">print</span> <span class="s2">&quot;correction coeff: &quot;</span><span class="p">,</span><span class="n">corr_coeff</span>
        <span class="n">spec_rad</span> <span class="o">=</span> <span class="n">sqrt</span><span class="p">(</span><span class="n">spec_rad</span><span class="o">+</span><span class="n">sqrt</span><span class="p">(</span><span class="n">corr_coeff</span><span class="p">))</span>
        <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">mr_file</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">spec_rad</span> <span class="o">=</span> <span class="n">sqrt</span><span class="p">(</span><span class="n">spec_rad</span><span class="p">)</span>
    <span class="n">sig</span> <span class="o">=</span> <span class="mi">100</span>
    <span class="n">to</span> <span class="o">=</span> <span class="n">eps</span><span class="o">/</span><span class="p">(</span><span class="n">sig</span><span class="o">*</span><span class="n">spec_rad</span><span class="p">)</span> <span class="c1"># Weight related to the dual variables</span>
    <span class="nb">print</span> <span class="s2">&quot;--------------------- sig = &quot;</span><span class="p">,</span><span class="n">sig</span><span class="p">,</span><span class="s2">&quot; ------------------ to = &quot;</span><span class="p">,</span><span class="n">to</span><span class="p">,</span><span class="s2">&quot;------------------------- spec rad = &quot;</span><span class="p">,</span><span class="n">spec_rad</span><span class="p">,</span><span class="s2">&quot; --------------------- &quot;</span>
    <span class="n">theta</span> <span class="o">=</span> <span class="mf">0.0</span>

    <span class="c1"># Dual variables</span>
    <span class="c1"># Data attachement</span>
    <span class="k">if</span> <span class="n">Y1</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">Y1</span> <span class="o">=</span> <span class="n">y</span><span class="o">*</span><span class="mi">0</span>
    <span class="n">input1</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="nb">input</span><span class="p">)</span>
    <span class="n">O</span> <span class="o">=</span> <span class="n">y</span><span class="o">*</span><span class="mi">0</span>
    <span class="c1"># Positivity</span>
    <span class="k">if</span> <span class="n">Y2</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">Y2</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">shapS</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">shapS</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">nb_im</span><span class="p">))</span>
    <span class="n">rweights_an</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
    <span class="c1"># Analysis constraint</span>
    <span class="n">data_trans</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">wavr_en</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">Y3</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">Y3</span> <span class="o">=</span> <span class="n">isap</span><span class="o">.</span><span class="n">mr_trans_stack</span><span class="p">(</span><span class="n">S</span><span class="o">*</span><span class="mi">0</span><span class="p">,</span><span class="n">opt</span><span class="o">=</span><span class="n">optr</span><span class="p">,</span><span class="n">clean_en</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">data_trans</span> <span class="o">=</span> <span class="n">isap</span><span class="o">.</span><span class="n">mr_trans_stack</span><span class="p">(</span><span class="n">S</span><span class="p">,</span><span class="n">opt</span><span class="o">=</span><span class="n">optr</span><span class="p">,</span><span class="n">clean_en</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="n">rad</span> <span class="o">=</span> <span class="n">ones</span><span class="p">((</span><span class="n">shapS</span><span class="p">[</span><span class="mi">2</span><span class="p">],))</span>



    <span class="c1"># Primal variable (Weighted L1 constraint)</span>
    <span class="n">input2</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="nb">input</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">V</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">V</span> <span class="o">=</span> <span class="n">S</span><span class="o">*</span><span class="mi">0</span>
    <span class="n">rweights</span> <span class="o">=</span> <span class="n">ones</span><span class="p">((</span><span class="n">shapS</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">shapS</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">shapS</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>

    <span class="n">cost</span><span class="o">=</span><span class="mi">0</span>
    <span class="n">cost_old</span><span class="o">=</span><span class="mi">1</span>
    <span class="nb">iter</span><span class="o">=</span><span class="mi">0</span>

    <span class="n">shapy</span> <span class="o">=</span> <span class="n">y</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">ones_mat</span> <span class="o">=</span> <span class="n">ones</span><span class="p">((</span><span class="n">shapS</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">shapS</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">shapS</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>

    <span class="n">wav_weights</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">wav_rweights</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">wav_weights_in</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">wav_en</span><span class="p">:</span>
        <span class="nb">print</span> <span class="s2">&quot;Wavelet noise estimation...&quot;</span>
        <span class="n">wav_weights</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">pywt_ksig_noise_2_stack</span><span class="p">(</span><span class="n">to</span><span class="o">*</span><span class="n">weights</span><span class="p">,</span><span class="n">opt</span><span class="o">=</span><span class="n">opt</span><span class="p">,</span><span class="n">nb_scale</span><span class="o">=</span><span class="n">nb_scale</span><span class="p">,</span><span class="n">nb_montecarlo</span><span class="o">=</span><span class="mi">1000</span><span class="p">)</span>
        <span class="nb">print</span> <span class="s2">&quot;Done.&quot;</span>
        <span class="n">wav_weights_in</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">wav_weights</span><span class="p">)</span>

    <span class="n">weights_noise</span> <span class="o">=</span> <span class="n">ones</span><span class="p">(</span><span class="n">shapS</span><span class="p">)</span>
    <span class="n">weights_spars</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">temp3</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="c1"># Transpose testing</span>

    <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_rw</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
        <span class="nb">print</span> <span class="n">l</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="s2">&quot;th pass/&quot;</span><span class="p">,</span><span class="n">nb_rw</span><span class="o">+</span><span class="mi">1</span>
        <span class="k">if</span> <span class="n">l</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">wav_en</span><span class="p">:</span>
                <span class="n">wav_weights_in</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">wav_weights</span><span class="p">)):</span>
                    <span class="n">a</span><span class="o">=</span><span class="nb">list</span><span class="p">()</span>
                    <span class="n">a</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">wav_weights</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">wav_rweights</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
                    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">wav_weights</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
                        <span class="n">a</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">wav_weights</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">wav_rweights</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span><span class="n">wav_weights</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">wav_rweights</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span><span class="n">wav_weights</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="n">wav_rweights</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">][</span><span class="mi">2</span><span class="p">]])</span>
                    <span class="n">wav_weights_in</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>

        <span class="k">while</span> <span class="nb">iter</span><span class="o">&lt;</span><span class="n">nb_iter</span> <span class="ow">and</span> <span class="mi">100</span><span class="o">*</span><span class="nb">abs</span><span class="p">(</span><span class="n">cost</span><span class="o">-</span><span class="n">cost_old</span><span class="p">)</span><span class="o">/</span><span class="nb">abs</span><span class="p">(</span><span class="n">cost_old</span><span class="p">)</span><span class="o">&gt;</span><span class="mf">0.001</span><span class="p">:</span>
            <span class="nb">print</span> <span class="s2">&quot;tol: &quot;</span><span class="p">,</span><span class="mi">100</span><span class="o">*</span><span class="nb">abs</span><span class="p">(</span><span class="n">cost</span><span class="o">-</span><span class="n">cost_old</span><span class="p">)</span><span class="o">/</span><span class="nb">abs</span><span class="p">(</span><span class="n">cost_old</span><span class="p">)</span>
            <span class="nb">iter</span><span class="o">+=</span><span class="mi">1</span>
            <span class="c1"># Dual variables update</span>
                        <span class="c1"># -- Analysis variable update</span>
            <span class="k">if</span> <span class="n">wavr_en</span><span class="p">:</span>
                <span class="c1">#if iter&lt;10:</span>
                <span class="k">if</span> <span class="n">l</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
                    <span class="n">rweights_an</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
                <span class="n">temp4</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">Y3</span><span class="p">)</span>
                <span class="n">temp5</span><span class="p">,</span><span class="n">files</span> <span class="o">=</span> <span class="n">isap</span><span class="o">.</span><span class="n">mr_trans_stack</span><span class="p">(</span><span class="n">S</span><span class="p">,</span><span class="n">opt</span><span class="o">=</span><span class="n">optr</span><span class="p">)</span>

                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">temp4</span><span class="p">)):</span>


                    <span class="n">temp4</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">+=</span><span class="n">sig</span><span class="o">*</span><span class="n">temp5</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                    <span class="n">temp6</span> <span class="o">=</span> <span class="kc">None</span>
                        <span class="c1">#if iter&lt;10:</span>
                    <span class="k">if</span> <span class="n">l</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
                        <span class="n">temp6</span><span class="p">,</span><span class="n">weights_temp</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">thresholding_perc</span><span class="p">(</span><span class="n">temp4</span><span class="p">[</span><span class="n">i</span><span class="p">][:,:,:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="n">sig</span><span class="p">,</span><span class="n">thresh_perc</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
                        <span class="n">rweights_an</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">weights_temp</span><span class="p">)</span>

                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">temp6</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">thresholding_3D</span><span class="p">(</span><span class="n">temp4</span><span class="p">[</span><span class="n">i</span><span class="p">][:,:,:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="n">sig</span><span class="p">,</span><span class="n">rweights_an</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="mi">1</span><span class="p">)</span>
                    <span class="n">temp4bis</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">temp4</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                    <span class="n">temp4bis</span><span class="p">[:,:,:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">temp6</span>
                    <span class="n">Y3</span><span class="p">[</span><span class="n">i</span><span class="p">][:,:,:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">temp4</span><span class="p">[</span><span class="n">i</span><span class="p">][:,:,:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">sig</span><span class="o">*</span><span class="n">temp6</span>
            <span class="c1"># -- Data attachment variable update</span>
            <span class="n">input1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">S</span><span class="p">)</span>
            <span class="n">temp1</span> <span class="o">=</span> <span class="n">Y1</span><span class="o">+</span><span class="n">sig</span><span class="o">*</span><span class="n">sr_stack_op</span><span class="p">(</span><span class="n">input1</span><span class="p">)</span>
            <span class="n">Y1</span> <span class="o">=</span> <span class="p">(</span><span class="n">temp1</span><span class="o">-</span><span class="n">sig</span><span class="o">*</span><span class="n">y</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">sig</span><span class="p">)</span>

            <span class="c1">#temp1 = Y1+sig*sr_stack_op(input1)</span>
            <span class="c1">#Y1 = temp1 - sig*y - sig*prox_hub_stack((temp1-sig*y)/sig,nsig_hub*ones((y.shape[2],)),1.0/sig)</span>

            <span class="c1"># -- Positivity variable update</span>
            <span class="k">if</span> <span class="n">pos_en</span><span class="p">:</span>
                <span class="n">temp2</span> <span class="o">=</span> <span class="n">Y2</span><span class="o">*</span><span class="mi">0</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_im</span><span class="p">):</span>
                    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shapS</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
                        <span class="n">temp2</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">]</span><span class="o">+=</span><span class="n">S</span><span class="p">[:,:,</span><span class="n">j</span><span class="p">]</span><span class="o">*</span><span class="n">A</span><span class="p">[</span><span class="n">j</span><span class="p">,</span><span class="n">i</span><span class="p">]</span>
                <span class="n">temp2</span> <span class="o">=</span> <span class="n">sig</span><span class="o">*</span><span class="n">temp2</span><span class="o">+</span><span class="n">Y2</span>
                <span class="n">Y2</span> <span class="o">=</span> <span class="o">-</span><span class="n">pos_proj_cube</span><span class="p">(</span><span class="o">-</span><span class="n">temp2</span><span class="p">)</span>




            <span class="c1"># Primal variable update</span>
            <span class="n">Vold</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">V</span><span class="p">)</span>
            <span class="n">temp30</span> <span class="o">=</span> <span class="n">V</span><span class="o">*</span><span class="mi">0</span>
            <span class="k">if</span> <span class="n">pos_en</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shapS</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
                    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_im</span><span class="p">):</span>
                        <span class="n">temp30</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">]</span><span class="o">+=</span><span class="n">Y2</span><span class="p">[:,:,</span><span class="n">j</span><span class="p">]</span><span class="o">*</span><span class="n">A</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span>
            <span class="n">input2</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">Y1</span>
            <span class="n">temp31</span> <span class="o">=</span> <span class="n">sr_stack_trans</span><span class="p">(</span><span class="n">input2</span><span class="p">)</span>
            <span class="n">temp32</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">temp3</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="n">wavr_en</span> <span class="ow">and</span> <span class="n">pos_en</span><span class="p">:</span>
                <span class="n">temp32</span> <span class="o">=</span> <span class="n">corr_coeff</span><span class="o">*</span><span class="n">isap</span><span class="o">.</span><span class="n">mr_recons_stack</span><span class="p">(</span><span class="n">files</span><span class="p">,</span><span class="n">shapS</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">files</span><span class="p">)):</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">files</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                <span class="n">temp3</span> <span class="o">=</span> <span class="n">V</span> <span class="o">-</span> <span class="n">to</span><span class="o">*</span><span class="p">(</span><span class="n">temp30</span><span class="o">+</span><span class="n">temp31</span><span class="o">+</span><span class="n">temp32</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">pos_en</span><span class="p">:</span>
                <span class="n">temp3</span> <span class="o">=</span> <span class="n">V</span> <span class="o">-</span> <span class="n">to</span><span class="o">*</span><span class="p">(</span><span class="n">temp30</span><span class="o">+</span><span class="n">temp31</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">wavr_en</span><span class="p">:</span>
                <span class="n">temp3</span> <span class="o">=</span> <span class="n">V</span> <span class="o">-</span> <span class="n">to</span><span class="o">*</span><span class="p">(</span><span class="n">temp30</span><span class="o">+</span><span class="n">temp32</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">temp3</span> <span class="o">=</span> <span class="n">V</span> <span class="o">-</span> <span class="n">to</span><span class="o">*</span><span class="n">temp31</span>
            <span class="c1">#for id in range(0,shapS[2]):</span>
                <span class="c1">#print &quot;Src &quot;,id,&quot; PNR: &quot;,ksig*sqrt(sum(V[:,:,id]**2))/sqrt(sum(weights[:,:,id]**2)),&quot; Comp noise:&quot;,sqrt(sum(weights[:,:,id]**2))</span>

            <span class="c1">#temp3 = V - to*temp31</span>
            <span class="k">if</span> <span class="n">wav_en</span><span class="p">:</span>
                <span class="n">V</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">pywt_filter_stack</span><span class="p">(</span><span class="n">temp3</span><span class="p">,</span><span class="n">ksig_map</span><span class="o">=</span><span class="n">wav_weights_in</span><span class="p">,</span><span class="n">opt</span><span class="o">=</span><span class="n">opt</span><span class="p">,</span><span class="n">nb_scale</span><span class="o">=</span><span class="n">nb_scale</span><span class="p">,</span><span class="n">thresh_type</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">wavr_en</span><span class="p">:</span>
                <span class="n">V</span> <span class="o">=</span> <span class="n">proj_sphere_cube</span><span class="p">(</span><span class="n">temp3</span><span class="p">,</span><span class="n">temp3</span><span class="o">*</span><span class="mi">0</span><span class="p">,</span><span class="n">rad</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">V</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">thresholding_3D</span><span class="p">(</span><span class="n">temp3</span><span class="p">,</span><span class="n">to</span><span class="o">*</span><span class="n">weights</span><span class="o">*</span><span class="n">rweights</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
                <span class="c1">#V = proj_sphere_cube(temp3,temp3*0,rad)</span>
                <span class="sd">&quot;&quot;&quot;if l==0:</span>
<span class="sd">                    V = temp3</span>
<span class="sd">                else:</span>
<span class="sd">                    V = utils.thresholding_3D(temp3,to*weights*rweights,1)</span>
<span class="sd">                    #V = utils.thresholding_3D(temp3,maximum(weights_noise*rweights,weights_spars*rweights),1)&quot;&quot;&quot;</span>





            <span class="c1"># Main variable update</span>

            <span class="n">S</span> <span class="o">=</span> <span class="n">V</span> <span class="o">+</span> <span class="n">theta</span><span class="o">*</span><span class="p">(</span><span class="n">V</span><span class="o">-</span><span class="n">Vold</span><span class="p">)</span>

            <span class="c1"># Sanity check</span>
            <span class="n">temp2</span> <span class="o">=</span> <span class="n">Y2</span><span class="o">*</span><span class="mi">0</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_im</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shapS</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
                    <span class="n">temp2</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">]</span><span class="o">+=</span><span class="n">S</span><span class="p">[:,:,</span><span class="n">j</span><span class="p">]</span><span class="o">*</span><span class="n">A</span><span class="p">[</span><span class="n">j</span><span class="p">,</span><span class="n">i</span><span class="p">]</span>

            <span class="n">cost_old</span> <span class="o">=</span> <span class="n">cost</span>
            <span class="n">input1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">S</span><span class="p">)</span>
            <span class="n">r</span> <span class="o">=</span> <span class="p">((</span><span class="n">y</span><span class="o">-</span><span class="n">sr_stack_op</span><span class="p">(</span><span class="n">input1</span><span class="p">))</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
            <span class="n">lw</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">S</span><span class="o">*</span><span class="n">weights</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">wavr_en</span><span class="p">:</span>
                <span class="n">d</span> <span class="o">=</span> <span class="n">r</span><span class="o">-</span><span class="n">cost</span>
                <span class="n">cost</span> <span class="o">=</span> <span class="n">cost</span><span class="o">+</span><span class="n">d</span><span class="o">/</span><span class="nb">iter</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">d</span> <span class="o">=</span> <span class="n">r</span><span class="o">+</span><span class="n">lw</span><span class="o">-</span><span class="n">cost</span>
                <span class="n">cost</span> <span class="o">=</span> <span class="n">cost</span><span class="o">+</span><span class="n">d</span><span class="o">/</span><span class="nb">iter</span>
            <span class="nb">print</span> <span class="s2">&quot;residual: &quot;</span><span class="p">,</span><span class="n">r</span><span class="p">,</span><span class="s2">&quot; min val: &quot;</span><span class="p">,</span><span class="n">temp2</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span><span class="s2">&quot; l1 term: &quot;</span><span class="p">,</span><span class="n">lw</span>
            <span class="c1"># Thresholds estimation</span>
        <span class="sd">&quot;&quot;&quot;if l==0:</span>
<span class="sd">            sig_temp = utils.im_gauss_nois_est_cube(S)</span>
<span class="sd">            k = 4</span>
<span class="sd">            for i in range(0,shap[2]):</span>
<span class="sd">                weights[:,:,i]*=sig_temp[i]*k</span>
<span class="sd">            perc = 0.2</span>
<span class="sd">            temp,weights_spars = utils.thresholding_perc(temp3,perc,1)&quot;&quot;&quot;</span>


        <span class="c1"># Reweighting</span>

        <span class="k">if</span> <span class="n">wav_en</span><span class="p">:</span>
            <span class="n">wcoeff</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">pywt_stack</span><span class="p">(</span><span class="n">S</span><span class="p">,</span><span class="n">opt</span><span class="o">=</span><span class="n">opt</span><span class="p">,</span><span class="n">nb_scale</span><span class="o">=</span><span class="n">nb_scale</span><span class="p">)</span>
            <span class="n">wav_rweights</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">wcoeff</span><span class="p">)):</span>
                <span class="n">a</span><span class="o">=</span><span class="nb">list</span><span class="p">()</span>
                <span class="n">a</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="mi">1</span><span class="o">+</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">wcoeff</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span><span class="o">/</span><span class="n">wav_weights</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]))</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>
                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">wcoeff</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
                    <span class="n">a</span><span class="o">.</span><span class="n">append</span><span class="p">([(</span><span class="mi">1</span><span class="o">+</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">wcoeff</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span><span class="o">/</span><span class="n">wav_weights</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]))</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">),(</span><span class="mi">1</span><span class="o">+</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">wcoeff</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span><span class="o">/</span><span class="n">wav_weights</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]))</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">),(</span><span class="mi">1</span><span class="o">+</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">wcoeff</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">][</span><span class="mi">2</span><span class="p">])</span><span class="o">/</span><span class="n">wav_weights</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">][</span><span class="mi">2</span><span class="p">]))</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)])</span>
                <span class="n">wav_rweights</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">wavr_en</span><span class="p">:</span>
            <span class="n">data_trans</span> <span class="o">=</span> <span class="n">isap</span><span class="o">.</span><span class="n">mr_trans_stack</span><span class="p">(</span><span class="n">S</span><span class="p">,</span><span class="n">opt</span><span class="o">=</span><span class="n">optr</span><span class="p">,</span><span class="n">clean_en</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">rweights_an</span><span class="p">)):</span>
                <span class="nb">print</span> <span class="n">i</span><span class="p">,</span><span class="s2">&quot;th source L1 norm&#39;s dual&quot;</span><span class="p">,</span><span class="nb">sum</span><span class="p">(</span><span class="n">Y3</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">*</span><span class="n">data_trans</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">-</span> <span class="p">(</span><span class="n">rweights_an</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">*</span><span class="n">Y3</span><span class="p">[</span><span class="n">i</span><span class="p">][:,:,:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">rweights_an</span><span class="p">)):</span>
                <span class="n">rweights_an</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*=</span> <span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">data_trans</span><span class="p">[</span><span class="n">i</span><span class="p">][:,:,:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span><span class="o">/</span><span class="n">rweights_an</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">rweights</span>  <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">S</span><span class="p">)</span><span class="o">/</span><span class="n">weights</span><span class="p">))</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
            <span class="c1">#rweights  = (1+(abs(S)/maximum(weights_noise,weights_spars)))**(-1)</span>

        <span class="nb">iter</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">cost</span><span class="o">=</span><span class="mi">2</span>
        <span class="n">cost_old</span><span class="o">=</span><span class="mi">1</span>

    <span class="n">list_ind</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>

    <span class="k">for</span> <span class="nb">id</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shapS</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
        <span class="n">a</span> <span class="o">=</span> <span class="n">ksig</span><span class="o">*</span><span class="n">sqrt</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="n">V</span><span class="p">[:,:,</span><span class="nb">id</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span><span class="o">/</span><span class="n">sqrt</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="n">weights</span><span class="p">[:,:,</span><span class="nb">id</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span>
        <span class="nb">print</span> <span class="s2">&quot;Src &quot;</span><span class="p">,</span><span class="nb">id</span><span class="p">,</span><span class="s2">&quot; PNR: &quot;</span><span class="p">,</span><span class="n">a</span>
        <span class="k">if</span> <span class="n">a</span><span class="o">&gt;=</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">list_ind</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">id</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">select_en</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">list_ind</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
        <span class="n">ind_select</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">list_ind</span><span class="p">)</span>
        <span class="n">S</span> <span class="o">=</span> <span class="n">S</span><span class="p">[:,:,</span><span class="n">ind_select</span><span class="p">]</span>
        <span class="n">V</span> <span class="o">=</span> <span class="n">V</span><span class="p">[:,:,</span><span class="n">ind_select</span><span class="p">]</span>


    <span class="k">return</span> <span class="n">S</span><span class="p">,</span><span class="n">Y1</span><span class="p">,</span><span class="n">Y2</span><span class="p">,</span><span class="n">Y3</span><span class="p">,</span><span class="n">V</span><span class="p">,</span><span class="n">rad</span><span class="p">,</span><span class="n">ind_select</span>


<span class="k">def</span> <span class="nf">low_rank_global_src_est_comb</span><span class="p">(</span><span class="nb">input</span><span class="p">,</span><span class="n">weights</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">ksig</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span><span class="n">eps</span><span class="o">=</span><span class="mf">0.9</span><span class="p">,</span><span class="n">ainit</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">nb_iter</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span><span class="n">tol</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span><span class="n">nb_rw</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">pos_en</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">opt</span><span class="o">=</span><span class="s1">&#39;coif5&#39;</span><span class="p">,</span><span class="n">nb_scale</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">wav_en</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">wavr_en</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">optr</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span><span class="n">nsig_hub</span><span class="o">=</span><span class="mi">1000000000000000000</span><span class="p">,</span><span class="n">Y2</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">Y3</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">V</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">cY3</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">only_noise_est_en</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">select_en</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">thresh_perc</span> <span class="o">=</span> <span class="mf">0.01</span><span class="p">,</span><span class="n">rad</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">filters</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">filters_rot</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">iter_min</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span><span class="n">mu</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span><span class="n">curv</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">nb_sc</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span><span class="n">nb_dir</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span><span class="n">curv_obj</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span><span class="n">Scurl</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">wavr_en</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
        <span class="n">curv</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="n">S</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="nb">input</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="c1"># (Main variable)</span>
    <span class="n">ref_mse</span> <span class="o">=</span> <span class="p">((</span><span class="n">y</span><span class="o">-</span><span class="n">sr_stack_op</span><span class="p">(</span><span class="nb">input</span><span class="p">))</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    <span class="n">l1_norm</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">S</span><span class="o">*</span><span class="n">weights</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    <span class="nb">print</span> <span class="s2">&quot;---&gt;&gt;ref res: &lt;&lt;---&quot;</span><span class="p">,</span><span class="n">ref_mse</span>
    <span class="nb">print</span> <span class="s2">&quot;---&gt;&gt;ref l1 norm: &lt;&lt;---&quot;</span><span class="p">,</span><span class="n">l1_norm</span>

    <span class="n">ker_adj</span> <span class="o">=</span> <span class="nb">input</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
    <span class="n">shap</span> <span class="o">=</span> <span class="n">ker_adj</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">A</span> <span class="o">=</span> <span class="nb">input</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>
    <span class="n">nb_im</span> <span class="o">=</span> <span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">shapS</span> <span class="o">=</span> <span class="n">S</span><span class="o">.</span><span class="n">shape</span>
    <span class="k">if</span> <span class="n">Scurl</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">Scurl</span> <span class="o">=</span> <span class="n">S</span><span class="o">*</span><span class="mi">0</span>
    <span class="n">Scurv</span> <span class="o">=</span> <span class="n">S</span><span class="o">*</span><span class="mi">0</span>
    <span class="n">ind_select</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shapS</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>

    <span class="n">spec_rad</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="c1"># Spectral radius setting</span>
    <span class="n">eig_max</span><span class="p">,</span><span class="n">spec_rad1</span> <span class="o">=</span> <span class="n">pow_meth</span><span class="p">(</span><span class="n">sr_stack_trans_op_src</span><span class="p">,</span><span class="nb">input</span><span class="p">,</span><span class="n">shapS</span><span class="p">,</span><span class="n">ainit</span><span class="o">=</span><span class="n">ainit</span><span class="p">)</span>
    <span class="n">U</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">Vt</span> <span class="o">=</span> <span class="n">linalg</span><span class="o">.</span><span class="n">svd</span><span class="p">(</span><span class="n">A</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">transpose</span><span class="p">(</span><span class="n">A</span><span class="p">)),</span><span class="n">full_matrices</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">spec_rad2</span> <span class="o">=</span> <span class="n">sqrt</span><span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>


    <span class="c1"># Dual variables</span>
    <span class="c1"># Data attachement</span>
    <span class="c1"># Positivity</span>
    <span class="k">if</span> <span class="n">Y2</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">Y2</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">shapS</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">shapS</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">nb_im</span><span class="p">))</span>

    <span class="n">rweights_an</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">weights_an</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">crweights_an</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">cweights_an</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="c1"># Analysis constraint</span>

    <span class="n">trans_data</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">ctrans_data</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">spec_rad3</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">corr_coeff</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">if</span> <span class="n">wavr_en</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">Y3</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">filters</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">Y3</span><span class="p">,</span><span class="n">filters</span> <span class="o">=</span> <span class="n">isap</span><span class="o">.</span><span class="n">mr_trans_stack_2</span><span class="p">(</span><span class="n">S</span><span class="o">*</span><span class="mi">0</span><span class="p">,</span><span class="n">opt</span><span class="o">=</span><span class="n">optr</span><span class="p">)</span>
            <span class="n">filters_rot</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">rot90_stack</span><span class="p">(</span><span class="n">filters</span><span class="p">)</span>
            <span class="n">Y3</span><span class="p">[:,:,</span><span class="o">-</span><span class="mi">1</span><span class="p">,:]</span><span class="o">*=</span><span class="mi">0</span> <span class="c1"># Puts the coarse scales to 0</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">filters</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
            <span class="n">spec_rad3</span> <span class="o">+=</span><span class="nb">sum</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">filters</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">]))</span><span class="o">**</span><span class="mi">2</span>
        <span class="n">spec_rad3</span> <span class="o">=</span> <span class="n">sqrt</span><span class="p">(</span><span class="n">spec_rad3</span><span class="p">)</span>
        <span class="n">weights_an_temp</span><span class="p">,</span><span class="n">filters_temp</span> <span class="o">=</span> <span class="n">isap</span><span class="o">.</span><span class="n">mr_trans_stack_2</span><span class="p">(</span><span class="n">weights</span><span class="p">,</span><span class="n">filters</span><span class="o">=</span><span class="n">filters</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">weights_an</span> <span class="o">=</span> <span class="mi">4</span><span class="o">*</span><span class="n">sqrt</span><span class="p">(</span><span class="n">weights_an_temp</span><span class="p">[:,:,:</span><span class="o">-</span><span class="mi">1</span><span class="p">,:])</span>
        <span class="n">rweights_an</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">Y3</span><span class="p">[:,:,:</span><span class="o">-</span><span class="mi">1</span><span class="p">,:])</span>
        <span class="k">if</span> <span class="n">curv</span> <span class="p">:</span>

            <span class="n">cY3</span><span class="p">,</span><span class="n">curv_obj</span><span class="p">,</span><span class="n">corr_coeff</span> <span class="o">=</span> <span class="n">isap</span><span class="o">.</span><span class="n">stack_pyct_fwd</span><span class="p">(</span><span class="n">S</span><span class="o">*</span><span class="mi">0</span><span class="p">,</span><span class="n">curv_obj</span><span class="o">=</span><span class="n">curv_obj</span><span class="p">,</span><span class="n">nb_sc</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span><span class="n">nb_dir</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span><span class="n">corr_en</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="nb">print</span> <span class="s2">&quot;Curvelets scaling coefficient: &quot;</span><span class="p">,</span><span class="n">corr_coeff</span>
            <span class="n">shapc</span> <span class="o">=</span> <span class="n">cY3</span><span class="o">.</span><span class="n">shape</span>
            <span class="n">cweights_an</span> <span class="o">=</span> <span class="n">ones</span><span class="p">((</span><span class="n">shapc</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">shapc</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
            <span class="n">crweights_an</span> <span class="o">=</span> <span class="n">ones</span><span class="p">((</span><span class="n">shapc</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">shapc</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shapc</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
                <span class="n">cweights_an</span><span class="p">[</span><span class="n">i</span><span class="p">,:]</span> <span class="o">*=</span> <span class="n">weights</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
            <span class="n">spec_rad3</span> <span class="o">=</span> <span class="n">spec_rad3</span><span class="o">+</span><span class="n">sqrt</span><span class="p">(</span><span class="n">corr_coeff</span><span class="p">)</span>


    <span class="k">if</span> <span class="n">wavr_en</span> <span class="ow">and</span> <span class="n">pos_en</span><span class="p">:</span>
        <span class="n">spec_rad</span> <span class="o">=</span> <span class="n">spec_rad1</span><span class="o">+</span><span class="n">spec_rad2</span><span class="o">+</span><span class="n">spec_rad3</span>
    <span class="k">elif</span> <span class="n">pos_en</span><span class="p">:</span>
        <span class="n">spec_rad</span> <span class="o">=</span> <span class="n">spec_rad1</span><span class="o">+</span><span class="n">spec_rad2</span>
    <span class="k">elif</span> <span class="n">wavr_en</span><span class="p">:</span>
        <span class="n">spec_rad</span> <span class="o">=</span> <span class="n">spec_rad1</span><span class="o">+</span><span class="n">spec_rad3</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">spec_rad</span> <span class="o">=</span> <span class="n">spec_rad1</span>

    <span class="n">rweights</span> <span class="o">=</span> <span class="n">ones</span><span class="p">((</span><span class="n">shapS</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">shapS</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">shapS</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>

    <span class="n">cost</span><span class="o">=</span><span class="mi">0</span>
    <span class="n">cost_old</span><span class="o">=</span><span class="mi">1</span>
    <span class="nb">iter</span><span class="o">=</span><span class="mi">0</span>

    <span class="n">shapy</span> <span class="o">=</span> <span class="n">y</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">ones_mat</span> <span class="o">=</span> <span class="n">ones</span><span class="p">((</span><span class="n">shapS</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">shapS</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">shapS</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>

    <span class="n">wav_weights</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">wav_rweights</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">wav_weights_in</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">weights_noise</span> <span class="o">=</span> <span class="n">ones</span><span class="p">(</span><span class="n">shapS</span><span class="p">)</span>

    <span class="n">weights_spars</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">temp3</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="n">input1</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="nb">input</span><span class="p">)</span>
    <span class="n">input2</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="nb">input</span><span class="p">)</span>
    <span class="n">filters_noise</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">Ycurv</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_rw</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
        <span class="nb">print</span> <span class="n">l</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="s2">&quot;th pass/&quot;</span><span class="p">,</span><span class="n">nb_rw</span><span class="o">+</span><span class="mi">1</span>

        <span class="k">while</span> <span class="p">(</span><span class="nb">iter</span><span class="o">&lt;</span><span class="n">nb_iter</span> <span class="ow">and</span> <span class="mi">100</span><span class="o">*</span><span class="nb">abs</span><span class="p">(</span><span class="n">cost</span><span class="o">-</span><span class="n">cost_old</span><span class="p">)</span><span class="o">/</span><span class="nb">abs</span><span class="p">(</span><span class="n">cost_old</span><span class="p">)</span><span class="o">&gt;</span><span class="mf">0.001</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">iter</span><span class="o">&lt;</span><span class="n">iter_min</span><span class="p">:</span>
            <span class="nb">print</span> <span class="s2">&quot;tol: &quot;</span><span class="p">,</span><span class="mi">100</span><span class="o">*</span><span class="nb">abs</span><span class="p">(</span><span class="n">cost</span><span class="o">-</span><span class="n">cost_old</span><span class="p">)</span><span class="o">/</span><span class="nb">abs</span><span class="p">(</span><span class="n">cost_old</span><span class="p">)</span>
            <span class="c1"># Checking transpose</span>
            <span class="sd">&quot;&quot;&quot;xtest = np.random.randn(shapS[0],shapS[1],shapS[2])</span>
<span class="sd">            tx,filters = isap.mr_trans_stack_2(xtest,filters=filters)</span>
<span class="sd">            shapY = tx.shape</span>
<span class="sd">            ytest = np.random.randn(shapY[0],shapY[1],shapY[2],shapY[3])</span>
<span class="sd">            ty = isap.mr_transf_transp_stack(ytest,filters_rot)</span>
<span class="sd">            print &quot;Transpose accuracy -------------&quot;,(xtest*ty).sum(),&quot;----------------&quot;,(ytest*tx).sum()&quot;&quot;&quot;</span>

            <span class="nb">iter</span><span class="o">+=</span><span class="mi">1</span>
            <span class="n">input1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">S</span><span class="o">+</span><span class="n">Scurv</span><span class="p">)</span>
            <span class="n">est</span> <span class="o">=</span> <span class="n">sr_stack_op</span><span class="p">(</span><span class="n">input1</span><span class="p">)</span>
            <span class="n">res</span> <span class="o">=</span> <span class="n">est</span> <span class="o">-</span> <span class="n">y</span>
            <span class="n">input2</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">res</span>
            <span class="n">gradS</span> <span class="o">=</span> <span class="n">sr_stack_trans</span><span class="p">(</span><span class="n">input2</span><span class="p">)</span>
            <span class="n">temp30</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="n">pos_en</span><span class="p">:</span>
                <span class="n">temp30</span> <span class="o">=</span> <span class="n">S</span><span class="o">*</span><span class="mi">0</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shapS</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
                    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_im</span><span class="p">):</span>
                        <span class="n">temp30</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">]</span><span class="o">+=</span><span class="n">Y2</span><span class="p">[:,:,</span><span class="n">j</span><span class="p">]</span><span class="o">*</span><span class="n">A</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span>
            <span class="n">temp31</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">ctemp31</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="n">wavr_en</span><span class="p">:</span>
                <span class="n">temp31</span> <span class="o">=</span> <span class="n">isap</span><span class="o">.</span><span class="n">mr_transf_transp_stack</span><span class="p">(</span><span class="n">Y3</span><span class="p">,</span><span class="n">filters_rot</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">curv</span><span class="p">:</span>
                    <span class="n">ctemp31</span><span class="o">=</span> <span class="n">corr_coeff</span><span class="o">*</span><span class="n">isap</span><span class="o">.</span><span class="n">stack_pyct_inv</span><span class="p">(</span><span class="n">cY3</span><span class="p">,</span><span class="n">curv_obj</span><span class="o">=</span><span class="n">curv_obj</span><span class="p">)</span>
            <span class="n">temp3</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">ctemp3</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="n">wavr_en</span> <span class="ow">and</span> <span class="n">pos_en</span><span class="p">:</span>
                <span class="n">temp3</span> <span class="o">=</span> <span class="n">temp30</span><span class="o">+</span><span class="n">temp31</span>
                <span class="k">if</span> <span class="n">curv</span><span class="p">:</span>
                    <span class="n">ctemp3</span> <span class="o">=</span> <span class="n">temp30</span><span class="o">+</span><span class="n">ctemp31</span>

            <span class="k">elif</span> <span class="n">pos_en</span><span class="p">:</span>
                <span class="n">temp3</span> <span class="o">=</span> <span class="n">temp30</span>
            <span class="k">elif</span> <span class="n">wavr_en</span><span class="p">:</span>
                <span class="n">temp3</span> <span class="o">=</span> <span class="n">temp31</span>
                <span class="k">if</span> <span class="n">curv</span><span class="p">:</span>
                    <span class="n">ctemp3</span> <span class="o">=</span> <span class="n">ctemp31</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">temp3</span> <span class="o">=</span> <span class="n">S</span><span class="o">*</span><span class="mi">0</span>
            <span class="n">P</span> <span class="o">=</span> <span class="n">S</span> <span class="o">-</span> <span class="n">mu</span><span class="o">*</span><span class="p">(</span><span class="n">temp3</span><span class="o">+</span><span class="n">gradS</span><span class="p">)</span><span class="o">/</span><span class="n">spec_rad</span>
            <span class="k">if</span> <span class="n">curv</span><span class="p">:</span>
                <span class="n">Pcurv</span> <span class="o">=</span> <span class="n">Scurv</span> <span class="o">-</span> <span class="n">mu</span><span class="o">*</span><span class="p">(</span><span class="n">ctemp3</span><span class="o">+</span><span class="n">gradS</span><span class="p">)</span><span class="o">/</span><span class="n">spec_rad</span>
                <span class="n">Ycurv</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">Pcurv</span><span class="o">-</span><span class="n">Scurv</span>
                <span class="n">Scurv</span> <span class="o">=</span> <span class="n">Scurv</span><span class="o">+</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="mf">1.0</span><span class="o">/</span><span class="p">(</span><span class="nb">iter</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span><span class="o">*</span><span class="p">(</span><span class="n">Pcurv</span><span class="o">-</span><span class="n">Scurv</span><span class="p">)</span>
                <span class="c1">#Scurv = copy(Pcurv)</span>

            <span class="k">if</span> <span class="n">wavr_en</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">True</span><span class="p">:</span>
                <span class="n">P</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">thresholding_3D</span><span class="p">(</span><span class="n">P</span><span class="p">,</span><span class="n">mu</span><span class="o">*</span><span class="n">weights</span><span class="o">*</span><span class="n">rweights</span><span class="o">/</span><span class="n">spec_rad</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>

            <span class="n">Y</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">P</span><span class="o">-</span><span class="n">S</span>
            <span class="n">S</span> <span class="o">=</span> <span class="n">S</span><span class="o">+</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="mf">1.0</span><span class="o">/</span><span class="p">(</span><span class="nb">iter</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span><span class="o">*</span><span class="p">(</span><span class="n">P</span><span class="o">-</span><span class="n">S</span><span class="p">)</span>
            <span class="c1">#S = copy(P)</span>
            <span class="k">if</span> <span class="n">pos_en</span><span class="p">:</span>
                <span class="n">temp2</span> <span class="o">=</span> <span class="n">Y2</span><span class="o">*</span><span class="mi">0</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_im</span><span class="p">):</span>
                    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shapS</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
                        <span class="n">temp2</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">]</span><span class="o">+=</span><span class="n">Y</span><span class="p">[:,:,</span><span class="n">j</span><span class="p">]</span><span class="o">*</span><span class="n">A</span><span class="p">[</span><span class="n">j</span><span class="p">,</span><span class="n">i</span><span class="p">]</span>
                <span class="n">tY2</span> <span class="o">=</span> <span class="o">-</span><span class="n">pos_proj_cube</span><span class="p">(</span><span class="o">-</span><span class="n">Y2</span><span class="o">-</span><span class="n">temp2</span><span class="o">/</span><span class="n">spec_rad</span><span class="p">)</span>
                <span class="n">Y2</span> <span class="o">=</span> <span class="n">Y2</span><span class="o">+</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="mf">1.0</span><span class="o">/</span><span class="p">(</span><span class="nb">iter</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span><span class="o">*</span><span class="p">(</span><span class="n">tY2</span><span class="o">-</span><span class="n">Y2</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">wavr_en</span><span class="p">:</span>
                <span class="n">temp3</span><span class="p">,</span><span class="n">filters</span> <span class="o">=</span> <span class="n">isap</span><span class="o">.</span><span class="n">mr_trans_stack_2</span><span class="p">(</span><span class="n">Y</span><span class="p">,</span><span class="n">filters</span><span class="o">=</span><span class="n">filters</span><span class="p">)</span>

                <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shapS</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
                    <span class="n">temp4</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="k">if</span> <span class="n">l</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
                        <span class="n">temp4</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">thresholding_3D</span><span class="p">(</span><span class="n">Y3</span><span class="p">[:,:,:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">k</span><span class="p">]</span><span class="o">+</span><span class="n">temp3</span><span class="p">[:,:,:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">k</span><span class="p">]</span><span class="o">*</span><span class="n">spec_rad</span><span class="p">,</span><span class="n">mu</span><span class="o">*</span><span class="n">weights_an</span><span class="p">[:,:,:,</span><span class="n">k</span><span class="p">],</span><span class="mi">1</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">temp4</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">thresholding_3D</span><span class="p">(</span><span class="n">Y3</span><span class="p">[:,:,:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">k</span><span class="p">]</span><span class="o">+</span><span class="n">temp3</span><span class="p">[:,:,:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">k</span><span class="p">]</span><span class="o">*</span><span class="n">spec_rad</span><span class="p">,</span><span class="n">mu</span><span class="o">*</span><span class="n">rweights_an</span><span class="p">[:,:,:,</span><span class="n">k</span><span class="p">]</span><span class="o">*</span><span class="n">weights_an</span><span class="p">[:,:,:,</span><span class="n">k</span><span class="p">],</span><span class="mi">1</span><span class="p">)</span>
                    <span class="n">tY3</span> <span class="o">=</span> <span class="n">Y3</span><span class="p">[:,:,:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">k</span><span class="p">]</span><span class="o">+</span><span class="n">temp3</span><span class="p">[:,:,:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">k</span><span class="p">]</span> <span class="o">-</span> <span class="n">temp4</span><span class="o">/</span><span class="n">spec_rad</span>
                    <span class="c1">#Y3[:,:,:-1,k] = copy(tY3)</span>
                    <span class="n">Y3</span><span class="p">[:,:,:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">Y3</span><span class="p">[:,:,:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">k</span><span class="p">]</span><span class="o">+</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="mf">1.0</span><span class="o">/</span><span class="p">(</span><span class="nb">iter</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span><span class="o">*</span><span class="p">(</span><span class="n">tY3</span><span class="o">-</span><span class="n">Y3</span><span class="p">[:,:,:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">k</span><span class="p">])</span>
                <span class="k">if</span> <span class="n">curv</span><span class="p">:</span>
                    <span class="n">ctemp3</span><span class="p">,</span><span class="n">curv_obj</span> <span class="o">=</span> <span class="n">isap</span><span class="o">.</span><span class="n">stack_pyct_fwd</span><span class="p">(</span><span class="n">Ycurv</span><span class="p">,</span><span class="n">curv_obj</span><span class="o">=</span><span class="n">curv_obj</span><span class="p">)</span>
                    <span class="n">ctemp4</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">thresholding</span><span class="p">(</span><span class="n">cY3</span><span class="o">+</span><span class="n">ctemp3</span><span class="o">*</span><span class="n">spec_rad</span><span class="p">,</span><span class="n">mu</span><span class="o">*</span><span class="n">cweights_an</span><span class="o">*</span><span class="n">crweights_an</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
                    <span class="n">ctY3</span> <span class="o">=</span> <span class="n">cY3</span><span class="o">+</span><span class="n">ctemp3</span> <span class="o">-</span> <span class="n">ctemp4</span><span class="o">/</span><span class="n">spec_rad</span>
                    <span class="c1">#cY3 = copy(ctY3)</span>
                    <span class="n">cY3</span> <span class="o">=</span> <span class="n">cY3</span><span class="o">+</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="mf">1.0</span><span class="o">/</span><span class="p">(</span><span class="nb">iter</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span><span class="o">*</span><span class="p">(</span><span class="n">ctY3</span><span class="o">-</span><span class="n">cY3</span><span class="p">)</span>


            <span class="n">cost_old</span> <span class="o">=</span> <span class="n">cost</span>
            <span class="n">cost</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">res</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
            <span class="c1"># ----------- Sanity check ----------- #</span>
            <span class="nb">print</span> <span class="s2">&quot;Mini val: &quot;</span><span class="p">,</span><span class="n">est</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span><span class="s2">&quot;; Residual: &quot;</span><span class="p">,</span><span class="n">cost</span><span class="p">,</span><span class="s2">&quot; Gradient&#39;s norm: &quot;</span><span class="p">,</span><span class="nb">sum</span><span class="p">(</span><span class="n">gradS</span><span class="o">**</span><span class="mi">2</span><span class="p">),</span><span class="s2">&quot; spectral norm: &quot;</span><span class="p">,</span><span class="n">spec_rad</span>
            <span class="k">if</span> <span class="n">wavr_en</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">True</span><span class="p">:</span>
                <span class="nb">print</span> <span class="s2">&quot;Weighted l1 norm direct domain: &quot;</span><span class="p">,</span><span class="nb">sum</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">weights</span><span class="o">*</span><span class="n">rweights</span><span class="o">*</span><span class="n">S</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">trans_data</span><span class="p">,</span><span class="n">filters</span> <span class="o">=</span> <span class="n">isap</span><span class="o">.</span><span class="n">mr_trans_stack_2</span><span class="p">(</span><span class="n">S</span><span class="p">,</span><span class="n">filters</span><span class="o">=</span><span class="n">filters</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">l</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
                    <span class="nb">print</span> <span class="s2">&quot;Weighted l1 norm analysis: &quot;</span><span class="p">,</span><span class="nb">sum</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">trans_data</span><span class="p">[:,:,:</span><span class="o">-</span><span class="mi">1</span><span class="p">,:]))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="nb">print</span> <span class="s2">&quot;Weighted l1 norm analysis: &quot;</span><span class="p">,</span><span class="nb">sum</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">trans_data</span><span class="p">[:,:,:</span><span class="o">-</span><span class="mi">1</span><span class="p">,:]</span><span class="o">*</span><span class="n">rweights_an</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">curv</span><span class="p">:</span>
                    <span class="n">ctrans_data</span><span class="p">,</span><span class="n">curv_obj</span> <span class="o">=</span> <span class="n">isap</span><span class="o">.</span><span class="n">stack_pyct_fwd</span><span class="p">(</span><span class="n">Scurv</span><span class="p">,</span><span class="n">curv_obj</span><span class="o">=</span><span class="n">curv_obj</span><span class="p">)</span>
                    <span class="nb">print</span> <span class="s2">&quot;Weighted l1 norm analysis (curvelets block): &quot;</span><span class="p">,</span><span class="nb">sum</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">ctrans_data</span><span class="o">*</span><span class="n">crweights_an</span><span class="p">))</span>


        <span class="k">if</span> <span class="n">wavr_en</span><span class="p">:</span>
            <span class="n">rweights_an</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">trans_data</span><span class="p">[:,:,:</span><span class="o">-</span><span class="mi">1</span><span class="p">,:])</span><span class="o">/</span><span class="n">weights_an</span><span class="p">))</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
            <span class="nb">print</span> <span class="s2">&quot;Weight max: &quot;</span><span class="p">,</span><span class="n">rweights_an</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span><span class="s2">&quot; Weight min: &quot;</span><span class="p">,</span><span class="n">rweights_an</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">curv</span><span class="p">:</span>
                <span class="n">crweights_an</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">ctrans_data</span><span class="p">)</span><span class="o">/</span><span class="n">cweights_an</span><span class="p">))</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">rweights</span>  <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">S</span><span class="p">)</span><span class="o">/</span><span class="n">weights</span><span class="p">))</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>

        <span class="nb">iter</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">cost</span><span class="o">=</span><span class="mi">2</span>
        <span class="n">cost_old</span><span class="o">=</span><span class="mi">1</span>

    <span class="n">list_ind</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>

    <span class="k">for</span> <span class="nb">id</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shapS</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
        <span class="n">a</span> <span class="o">=</span> <span class="n">ksig</span><span class="o">*</span><span class="n">sqrt</span><span class="p">(</span><span class="nb">sum</span><span class="p">((</span><span class="n">S</span><span class="p">[:,:,</span><span class="nb">id</span><span class="p">]</span><span class="o">+</span><span class="n">Scurv</span><span class="p">[:,:,</span><span class="nb">id</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span><span class="o">/</span><span class="n">sqrt</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="n">weights</span><span class="p">[:,:,</span><span class="nb">id</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span>
        <span class="nb">print</span> <span class="s2">&quot;Src &quot;</span><span class="p">,</span><span class="nb">id</span><span class="p">,</span><span class="s2">&quot; PNR: &quot;</span><span class="p">,</span><span class="n">a</span>
        <span class="k">if</span> <span class="n">a</span><span class="o">&gt;=</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">list_ind</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">id</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">select_en</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">list_ind</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
        <span class="n">ind_select</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">list_ind</span><span class="p">)</span>
        <span class="n">S</span> <span class="o">=</span> <span class="n">S</span><span class="p">[:,:,</span><span class="n">ind_select</span><span class="p">]</span>
        <span class="n">Scurv</span> <span class="o">=</span> <span class="n">Scurv</span><span class="p">[:,:,</span><span class="n">ind_select</span><span class="p">]</span>



    <span class="k">return</span> <span class="n">filters</span><span class="p">,</span><span class="n">filters_rot</span><span class="p">,</span><span class="n">Y2</span><span class="p">,</span><span class="n">Y3</span><span class="p">,</span><span class="n">cY3</span><span class="p">,</span><span class="n">S</span><span class="p">,</span><span class="n">Scurv</span><span class="p">,</span><span class="n">ind_select</span><span class="p">,</span><span class="n">curv_obj</span>




<span class="k">def</span> <span class="nf">robust_low_rank_global_src_est_cp</span><span class="p">(</span><span class="nb">input</span><span class="p">,</span><span class="n">weights</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">eps</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span><span class="n">ainit</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">nb_iter</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span><span class="n">tol</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">nsig</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span><span class="n">sig_im</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="n">S</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="nb">input</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="c1"># (Main variable)</span>
    <span class="n">upfact</span> <span class="o">=</span> <span class="nb">input</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">ker_adj</span> <span class="o">=</span> <span class="nb">input</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
    <span class="n">shap</span> <span class="o">=</span> <span class="n">ker_adj</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">A</span> <span class="o">=</span> <span class="nb">input</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>
    <span class="n">nb_im</span> <span class="o">=</span> <span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">shapS</span> <span class="o">=</span> <span class="n">S</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">ref_mse</span> <span class="o">=</span> <span class="p">((</span><span class="n">y</span><span class="o">-</span><span class="n">sr_stack_op</span><span class="p">(</span><span class="nb">input</span><span class="p">))</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    <span class="n">l1_norm</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">S</span><span class="o">*</span><span class="n">weights</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    <span class="nb">print</span> <span class="s2">&quot;---&gt;&gt;ref res: &lt;&lt;---&quot;</span><span class="p">,</span><span class="n">ref_mse</span>
    <span class="nb">print</span> <span class="s2">&quot;---&gt;&gt;ref l1 norm: &lt;&lt;---&quot;</span><span class="p">,</span><span class="n">l1_norm</span>
    <span class="n">scal</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">ref_mse</span><span class="o">/</span><span class="nb">abs</span><span class="p">(</span><span class="n">y</span><span class="o">-</span><span class="n">sr_stack_op</span><span class="p">(</span><span class="nb">input</span><span class="p">))</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>

    <span class="n">shap</span> <span class="o">=</span> <span class="n">S</span><span class="o">.</span><span class="n">shape</span>
    <span class="c1"># Spectral radius setting</span>
    <span class="n">eig_max</span><span class="p">,</span><span class="n">spec_rad</span> <span class="o">=</span> <span class="n">pow_meth</span><span class="p">(</span><span class="n">sr_stack_trans_op_cons_src</span><span class="p">,</span><span class="nb">input</span><span class="p">,</span><span class="n">shapS</span><span class="p">,</span><span class="n">ainit</span><span class="o">=</span><span class="n">ainit</span><span class="p">)</span>
    <span class="n">spec_rad</span> <span class="o">=</span> <span class="n">sqrt</span><span class="p">(</span><span class="n">spec_rad</span><span class="p">)</span>
    <span class="n">to</span> <span class="o">=</span> <span class="n">spec_rad</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">sig</span> <span class="o">=</span> <span class="n">eps</span><span class="o">/</span><span class="p">(</span><span class="n">to</span><span class="o">*</span><span class="n">spec_rad</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="c1"># Weight related to the dual variables</span>
    <span class="n">theta</span> <span class="o">=</span> <span class="mf">0.9</span>

    <span class="c1"># Dual variables</span>
    <span class="c1"># Data attachement</span>
    <span class="n">Y1</span> <span class="o">=</span> <span class="n">y</span><span class="o">*</span><span class="mi">0</span>
    <span class="n">input1</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="nb">input</span><span class="p">)</span>
    <span class="n">w</span> <span class="o">=</span> <span class="n">ones</span><span class="p">((</span><span class="n">shapS</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="n">upfact</span><span class="p">,</span><span class="n">shapS</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="n">upfact</span><span class="p">,</span><span class="n">nb_im</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">sig_im</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">sig_im</span> <span class="o">=</span> <span class="n">ones</span><span class="p">((</span><span class="n">nb_im</span><span class="p">,))</span>

    <span class="c1"># Positivity</span>
    <span class="n">Y2</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">shapS</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">shapS</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">nb_im</span><span class="p">))</span>
    <span class="c1"># Primal variable (Weighted L1 constraint)</span>
    <span class="n">input2</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="nb">input</span><span class="p">)</span>
    <span class="n">V</span> <span class="o">=</span> <span class="n">S</span><span class="o">*</span><span class="mi">0</span>
    <span class="n">ref_thresh</span> <span class="o">=</span> <span class="n">ones</span><span class="p">((</span><span class="n">shapS</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">shapS</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">shapS</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shapS</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
        <span class="n">ref_thresh</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">]</span> <span class="o">*=</span> <span class="n">median</span><span class="p">(</span><span class="n">weights</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">])</span>
    <span class="n">cost</span><span class="o">=</span><span class="mi">2</span>
    <span class="n">cost_old</span><span class="o">=</span><span class="mi">1</span>
    <span class="nb">iter</span><span class="o">=</span><span class="mi">0</span>
    <span class="n">sig_map</span><span class="o">=</span><span class="kc">None</span>
    <span class="k">while</span> <span class="nb">iter</span><span class="o">&lt;</span><span class="n">nb_iter</span><span class="p">:</span><span class="c1"># and 100*abs(cost-cost_old)/abs(cost_old)&gt;tol:</span>
        <span class="nb">iter</span><span class="o">+=</span><span class="mi">1</span>

        <span class="c1"># Dual variables update</span>
        <span class="c1"># -- Data attachment variable update</span>
        <span class="n">input1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">S</span><span class="p">)</span>
        <span class="n">temp1</span> <span class="o">=</span> <span class="n">Y1</span><span class="o">+</span><span class="n">sig</span><span class="o">*</span><span class="n">sr_stack_op</span><span class="p">(</span><span class="n">input1</span><span class="p">)</span>
        <span class="n">Y1</span> <span class="o">=</span> <span class="n">temp1</span> <span class="o">-</span> <span class="n">sig</span><span class="o">*</span><span class="n">y</span> <span class="o">-</span> <span class="n">sig</span><span class="o">*</span><span class="n">prox_hub_stack</span><span class="p">((</span><span class="n">temp1</span><span class="o">-</span><span class="n">sig</span><span class="o">*</span><span class="n">y</span><span class="p">)</span><span class="o">/</span><span class="n">sig</span><span class="p">,</span><span class="n">nsig</span><span class="o">*</span><span class="n">sig_im</span><span class="p">,</span><span class="mf">1.0</span><span class="o">/</span><span class="n">sig</span><span class="p">)</span>

        <span class="c1">#Y1 = utils.l_inf_ball_proj_3D((temp1-sig*y)/scal,w,1)</span>
        <span class="c1"># -- Positivity variable update</span>
        <span class="n">temp2</span> <span class="o">=</span> <span class="n">Y2</span><span class="o">*</span><span class="mi">0</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_im</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shapS</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
                <span class="n">temp2</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">]</span><span class="o">+=</span><span class="n">S</span><span class="p">[:,:,</span><span class="n">j</span><span class="p">]</span><span class="o">*</span><span class="n">A</span><span class="p">[</span><span class="n">j</span><span class="p">,</span><span class="n">i</span><span class="p">]</span>
        <span class="n">temp2</span> <span class="o">=</span> <span class="n">sig</span><span class="o">*</span><span class="n">temp2</span><span class="o">+</span><span class="n">Y2</span>
        <span class="n">Y2</span> <span class="o">=</span> <span class="o">-</span><span class="n">pos_proj_cube</span><span class="p">(</span><span class="o">-</span><span class="n">temp2</span><span class="p">)</span>
        <span class="c1"># Primal variable update</span>
        <span class="n">Vold</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">V</span><span class="p">)</span>
        <span class="n">temp30</span> <span class="o">=</span> <span class="n">V</span><span class="o">*</span><span class="mi">0</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shapS</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_im</span><span class="p">):</span>
                <span class="n">temp30</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">]</span><span class="o">+=</span><span class="n">Y2</span><span class="p">[:,:,</span><span class="n">j</span><span class="p">]</span><span class="o">*</span><span class="n">A</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span>
        <span class="n">input2</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">Y1</span>
        <span class="n">temp31</span> <span class="o">=</span> <span class="n">sr_stack_trans</span><span class="p">(</span><span class="n">input2</span><span class="p">)</span>
        <span class="n">temp3</span> <span class="o">=</span> <span class="n">V</span> <span class="o">-</span> <span class="n">to</span><span class="o">*</span><span class="p">(</span><span class="n">temp30</span><span class="o">+</span><span class="n">temp31</span><span class="p">)</span>
        <span class="n">V</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">thresholding_3D</span><span class="p">(</span><span class="n">temp3</span><span class="p">,</span><span class="n">to</span><span class="o">*</span><span class="n">weights</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
        <span class="c1"># Main variable update</span>

        <span class="n">S</span> <span class="o">=</span> <span class="n">V</span> <span class="o">+</span> <span class="n">theta</span><span class="o">*</span><span class="p">(</span><span class="n">V</span><span class="o">-</span><span class="n">Vold</span><span class="p">)</span>
        <span class="c1"># Sanity check</span>
        <span class="n">temp2</span> <span class="o">=</span> <span class="n">Y2</span><span class="o">*</span><span class="mi">0</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_im</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shapS</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
                <span class="n">temp2</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">]</span><span class="o">+=</span><span class="n">S</span><span class="p">[:,:,</span><span class="n">j</span><span class="p">]</span><span class="o">*</span><span class="n">A</span><span class="p">[</span><span class="n">j</span><span class="p">,</span><span class="n">i</span><span class="p">]</span>

        <span class="n">input1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">S</span><span class="p">)</span>
        <span class="n">cost_old</span> <span class="o">=</span> <span class="n">cost</span>
        <span class="n">r</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">y</span><span class="o">-</span><span class="n">sr_stack_op</span><span class="p">(</span><span class="n">input1</span><span class="p">))</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="n">l</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">S</span><span class="o">*</span><span class="n">weights</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="n">cost</span> <span class="o">=</span> <span class="n">r</span><span class="o">+</span><span class="n">l</span>
        <span class="nb">print</span> <span class="s2">&quot;residual: &quot;</span><span class="p">,</span><span class="n">r</span><span class="o">*</span><span class="n">scal</span><span class="p">,</span><span class="s2">&quot; min val: &quot;</span><span class="p">,</span><span class="n">temp2</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span><span class="s2">&quot; l1 term: &quot;</span><span class="p">,</span><span class="n">l</span>

    <span class="k">return</span> <span class="n">V</span>

<span class="k">def</span> <span class="nf">low_rank_comp_wise_sparse_dist_dyn_coeff_GFB</span><span class="p">(</span><span class="n">psf_stack_in</span><span class="p">,</span><span class="n">field_dist</span><span class="p">,</span><span class="n">upfact</span><span class="p">,</span><span class="n">opt</span><span class="p">,</span><span class="n">nsig</span><span class="p">,</span><span class="n">global_sparsity_en</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>\
    <span class="n">sr_en</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">sparsity_en</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">pix_sparsity</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">redun_fact</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span><span class="n">neigh_frac</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span><span class="n">dist_weight_deg</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">shifts</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>\
    <span class="n">opt_shift_est</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">nsig_shift_est</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span><span class="n">sig_est</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">flux_est</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">nb_iter</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span><span class="n">nb_subiter</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span><span class="n">nb_subiter_min</span><span class="o">=</span><span class="mi">7</span><span class="p">,</span>\
    <span class="n">mu</span><span class="o">=</span><span class="mf">1.5</span><span class="p">,</span><span class="n">nb_comp_max</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span><span class="n">tol</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span><span class="n">wvl_transp_cor</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">cv_proof_en</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">line_search_en</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">cond_fact</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span><span class="n">pos_relax</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>\
    <span class="n">nb_subiter_min_2</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span><span class="n">dyn_upload</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">positivity_en</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">score</span><span class="o">=</span><span class="mi">90</span><span class="p">,</span><span class="n">refine</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">robust_refine</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">nsig_hub</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>\
    <span class="n">res_check_en</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">tracking_en</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span> <span class="c1"># Representations coefficietns are updated in all the components loops</span>

    <span class="n">psf_stack</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">psf_stack_in</span><span class="p">)</span>
    <span class="n">shap</span> <span class="o">=</span> <span class="n">psf_stack</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">siz_in</span> <span class="o">=</span> <span class="n">upfact</span><span class="o">*</span><span class="n">array</span><span class="p">(</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
    <span class="nb">print</span> <span class="s2">&quot;Minimiser: GFB&quot;</span>
    <span class="k">if</span> <span class="n">sparsity_en</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
        <span class="nb">print</span> <span class="s2">&quot;----- Sparsity disable -----&quot;</span>
    <span class="c1"># Degradation operator parameters estimation</span>
    <span class="n">centroids</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">sig_est</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">sig_est</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">im_gauss_nois_est_cube</span><span class="p">(</span><span class="n">psf_stack_in</span><span class="p">,</span><span class="n">opt</span><span class="o">=</span><span class="n">opt_shift_est</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">shifts</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="nb">map</span> <span class="o">=</span> <span class="n">ones</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
            <span class="nb">map</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">]</span> <span class="o">*=</span> <span class="n">nsig_shift_est</span><span class="o">*</span><span class="n">sig_est</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="nb">print</span> <span class="s1">&#39;Shifts estimation...&#39;</span>
        <span class="n">psf_stack_shift</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">thresholding_3D</span><span class="p">(</span><span class="n">psf_stack_in</span><span class="p">,</span><span class="nb">map</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">shifts</span><span class="p">,</span><span class="n">centroids</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">shift_est</span><span class="p">(</span><span class="n">psf_stack_shift</span><span class="p">)</span>
        <span class="nb">print</span> <span class="s1">&#39;Done...&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span> <span class="s2">&quot;------------ /!\ Warning: shifts provided /!\ ---------&quot;</span>

    <span class="c1">#shifts = utils.wvl_shift_est(psf_stack,opt_shift_est,nsig_shift_est)*upfact</span>
    <span class="n">shift_ker_stack</span><span class="p">,</span><span class="n">shift_ker_stack_adj</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">shift_ker_stack</span><span class="p">(</span><span class="n">shifts</span><span class="p">,</span><span class="n">upfact</span><span class="p">)</span>
    <span class="n">sig_min</span> <span class="o">=</span> <span class="n">sig_est</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
    <span class="n">sig_min_vect</span> <span class="o">=</span> <span class="n">ones</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">],))</span><span class="o">*</span><span class="n">sig_min</span>
    <span class="n">sig_est</span> <span class="o">=</span> <span class="n">sig_est</span><span class="o">/</span><span class="n">sig_min</span>
    <span class="n">muj</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">nb_im</span> <span class="o">=</span> <span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
        <span class="n">psf_stack</span><span class="p">[:,:,</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">psf_stack</span><span class="p">[:,:,</span><span class="n">k</span><span class="p">]</span><span class="o">/</span><span class="n">sig_est</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
    <span class="nb">print</span> <span class="s2">&quot; ------ ref energy: &quot;</span><span class="p">,(</span><span class="n">psf_stack</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(),</span><span class="s2">&quot; ------- &quot;</span>
    <span class="k">if</span> <span class="n">flux_est</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">flux_est</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">flux_estimate_stack</span><span class="p">(</span><span class="n">psf_stack_in</span><span class="p">,</span><span class="n">rad</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
    <span class="n">flux_ref</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">flux_est</span><span class="p">)</span>

    <span class="n">weights</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">ref_weights</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">dyn_upload</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
        <span class="n">weights</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">nb_comp_max</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>
    <span class="n">w</span> <span class="o">=</span> <span class="n">ones</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">],))</span>
    <span class="n">im_hr</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">upfact</span><span class="o">*</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">upfact</span><span class="o">*</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>
    <span class="n">ref_im_hr</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">upfact</span><span class="o">*</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">upfact</span><span class="o">*</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>
    <span class="c1"># Distances settings</span>
    <span class="nb">print</span> <span class="s2">&quot;Contructing PSF tree...&quot;</span>
    <span class="c1">#nb_neighs = redun_fact*upfact**2</span>
    <span class="n">nb_neighs</span> <span class="o">=</span> <span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span>
    <span class="n">neigh</span><span class="p">,</span><span class="n">dists</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">knn_interf</span><span class="p">(</span><span class="n">field_dist</span><span class="p">,</span><span class="n">nb_neighs</span><span class="p">)</span>
    <span class="n">p_max</span> <span class="o">=</span> <span class="n">pow_law_select</span><span class="p">(</span><span class="n">dists</span><span class="p">,</span><span class="n">nb_neighs</span><span class="p">)</span>
    <span class="nb">print</span> <span class="s2">&quot;power max = &quot;</span><span class="p">,</span><span class="n">p_max</span>
    <span class="n">p_min</span> <span class="o">=</span> <span class="mf">0.01</span>
    <span class="nb">print</span> <span class="s2">&quot;Done...&quot;</span>
    <span class="n">e_min</span> <span class="o">=</span> <span class="mf">0.01</span>
    <span class="n">e_max</span> <span class="o">=</span> <span class="mf">1.99</span>
    <span class="n">nb_samp_opt</span> <span class="o">=</span> <span class="n">nb_comp_max</span><span class="o">*</span><span class="mi">10</span>
    <span class="n">dists_unsorted</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">feat_dist_mat</span><span class="p">(</span><span class="n">field_dist</span><span class="p">)</span>
    <span class="n">dist_med</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">dists</span><span class="p">)</span>
    <span class="n">dist_weights</span> <span class="o">=</span> <span class="p">(</span><span class="n">dist_med</span><span class="o">/</span><span class="n">dists_unsorted</span><span class="p">)</span><span class="o">**</span><span class="n">dist_weight_deg</span>
    <span class="c1">#dist_weights = (dist_med/dists)**dist_weight_deg</span>
    <span class="n">dist_weigths</span> <span class="o">=</span> <span class="n">dist_weights</span><span class="o">/</span><span class="n">dist_weights</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
    <span class="n">dist_weights_in</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="c1"># Spatial smoothing operator gradient lip constant estimation</span>
    <span class="n">spec_rad_smooth</span> <span class="o">=</span> <span class="kc">None</span>


    <span class="n">siz_in</span> <span class="o">=</span> <span class="n">upfact</span><span class="o">*</span><span class="n">array</span><span class="p">(</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">eig_max</span> <span class="o">=</span> <span class="kc">None</span>


    <span class="c1"># GFB variables</span>
    <span class="nb">input</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">upfact</span><span class="o">*</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">upfact</span><span class="o">*</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
    <span class="nb">input</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="nb">input</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">upfact</span><span class="p">)</span>
    <span class="nb">input</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">shift_ker_stack</span><span class="p">)</span>
    <span class="nb">input</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">shift_ker_stack_adj</span><span class="p">)</span>
    <span class="n">w</span> <span class="o">=</span> <span class="n">ones</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">],))</span>
    <span class="n">w_old</span> <span class="o">=</span> <span class="n">ones</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">],))</span>
    <span class="n">l1_norms</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">],))</span>
    <span class="n">im_hr</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">upfact</span><span class="o">*</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">upfact</span><span class="o">*</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>
    <span class="n">im_hr_dev</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">upfact</span><span class="o">*</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">upfact</span><span class="o">*</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>
    <span class="nb">input</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">w</span><span class="p">)</span>
    <span class="nb">input</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sig_est</span><span class="p">)</span>
    <span class="nb">input</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">flux_est</span><span class="p">)</span>
    <span class="n">comp</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">upfact</span><span class="o">*</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">upfact</span><span class="o">*</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">nb_comp_max</span><span class="p">))</span> <span class="c1"># Main variable</span>
    <span class="n">ref_comp</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">comp_old</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">upfact</span><span class="o">*</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">upfact</span><span class="o">*</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
    <span class="n">z1</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">upfact</span><span class="o">*</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">upfact</span><span class="o">*</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span> <span class="c1"># Sparse variable</span>
    <span class="n">z2</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">upfact</span><span class="o">*</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">upfact</span><span class="o">*</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span> <span class="c1"># Positive variable</span>
    <span class="n">compz1</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">upfact</span><span class="o">*</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">upfact</span><span class="o">*</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">nb_comp_max</span><span class="p">))</span> <span class="c1"># Main variable</span>
    <span class="n">compz2</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">upfact</span><span class="o">*</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">upfact</span><span class="o">*</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">nb_comp_max</span><span class="p">))</span> <span class="c1"># Main variable</span>
    <span class="n">min_val_map</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">upfact</span><span class="o">*</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">upfact</span><span class="o">*</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
    <span class="n">res_inter_comp</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">nb_comp_max</span><span class="p">,))</span>
    <span class="n">coeff_init</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">w1</span> <span class="o">=</span> <span class="mf">0.5</span>
    <span class="n">w2</span> <span class="o">=</span> <span class="mf">0.5</span>
    <span class="k">if</span> <span class="n">positivity_en</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">True</span> <span class="p">:</span>
        <span class="n">w2</span><span class="o">=</span><span class="mi">0</span>
        <span class="n">w1</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="n">lambd</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">grad</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">upfact</span><span class="o">*</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">upfact</span><span class="o">*</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>

    <span class="n">u</span><span class="p">,</span><span class="n">mr_file</span> <span class="o">=</span> <span class="n">isap</span><span class="o">.</span><span class="n">mr_trans</span><span class="p">(</span><span class="n">comp</span><span class="p">[:,:,</span><span class="mi">0</span><span class="p">],</span><span class="n">opt</span><span class="o">=</span><span class="n">opt</span><span class="p">)</span>
    <span class="n">shap2</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">weights_sp</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">pix_sparsity</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">weights_sp</span> <span class="o">=</span> <span class="n">ones</span><span class="p">((</span><span class="n">shap2</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">shap2</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">shap2</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">weights_sp</span> <span class="o">=</span> <span class="n">ones</span><span class="p">((</span><span class="n">upfact</span><span class="o">*</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">upfact</span><span class="o">*</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>

    <span class="n">thresh_save</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">if</span> <span class="n">pix_sparsity</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">thresh_save</span> <span class="o">=</span> <span class="n">ones</span><span class="p">((</span><span class="n">shap2</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">shap2</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">shap2</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">nb_comp_max</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">thresh_save</span> <span class="o">=</span> <span class="n">ones</span><span class="p">((</span><span class="n">upfact</span><span class="o">*</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">upfact</span><span class="o">*</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">nb_comp_max</span><span class="p">))</span>

    <span class="n">g_weights_sp</span> <span class="o">=</span> <span class="n">ones</span><span class="p">((</span><span class="n">shap2</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">shap2</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">shap2</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>
    <span class="n">g_weights_sp_2</span> <span class="o">=</span> <span class="n">ones</span><span class="p">((</span><span class="n">shap2</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">shap2</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">shap2</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>
    <span class="n">g_weights_sp</span><span class="p">[:,:,</span><span class="n">shap2</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">,:]</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="n">dev</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">g_weights_sp</span><span class="p">)</span><span class="o">*</span><span class="mi">0</span>
    <span class="n">thresh_map</span> <span class="o">=</span> <span class="n">weights_sp</span><span class="o">*</span><span class="mi">0</span>
    <span class="n">g_thresh_map</span> <span class="o">=</span> <span class="n">g_weights_sp</span><span class="o">*</span><span class="mi">0</span>
    <span class="n">g_thresh_map_2</span> <span class="o">=</span> <span class="n">g_weights_sp</span><span class="o">*</span><span class="mi">0</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">psf_stack</span><span class="p">)</span>
    <span class="n">ref_res</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">psf_stack</span><span class="p">)</span><span class="o">*</span><span class="mi">0</span>

    <span class="n">comp_lr</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">nb_comp_max</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>
    <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">buff</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">nb_subiter_min</span><span class="p">))</span>

    <span class="n">nb_iter_noisest</span> <span class="o">=</span> <span class="mi">20</span>
    <span class="n">nb_subiter_prox</span> <span class="o">=</span> <span class="mi">50</span>
    <span class="n">thresh_type</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">noise_vect_1</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">sig_map</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">cur_res</span><span class="o">=</span><span class="mf">100000000.0</span>
    <span class="n">res_old</span><span class="o">=</span><span class="mf">1000000000.0</span>
    <span class="n">cur_res_comp</span><span class="o">=</span><span class="mf">100000000.0</span>
    <span class="n">res_old_comp</span><span class="o">=</span><span class="mf">1000000000.0</span>
    <span class="n">to</span><span class="o">=</span><span class="kc">None</span>
    <span class="n">weights_init</span><span class="o">=</span><span class="kc">None</span>
    <span class="n">p_smth_mat_inv</span><span class="o">=</span><span class="kc">None</span>
    <span class="nb">print</span> <span class="s2">&quot; ------ ref energy: &quot;</span><span class="p">,(</span><span class="n">psf_stack</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(),</span><span class="s2">&quot; ------- &quot;</span>
    <span class="n">pows</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">nb_comp_max</span><span class="p">))</span>
    <span class="n">e_opt</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">nb_comp_max</span><span class="p">))</span>
    <span class="n">e_range</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">log_sampling</span><span class="p">(</span><span class="n">e_min</span><span class="p">,</span><span class="n">e_max</span><span class="p">,</span><span class="n">nb_samp_opt</span><span class="p">)</span>
    <span class="n">p_range</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">log_sampling</span><span class="p">(</span><span class="n">p_min</span><span class="p">,</span><span class="n">p_max</span><span class="p">,</span><span class="n">nb_samp_opt</span><span class="p">)</span>
    <span class="n">score_res</span> <span class="o">=</span> <span class="mi">100</span>
    <span class="n">detect_flag</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">thresh_max</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">comp_tracking</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">upfact</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">upfact</span><span class="p">,</span><span class="n">nb_comp_max</span><span class="p">,</span><span class="n">nb_subiter</span><span class="p">))</span>

    <span class="k">while</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">nb_comp_max</span> <span class="ow">and</span> <span class="n">score_res</span><span class="o">&gt;</span><span class="mi">100</span><span class="o">-</span><span class="n">score</span><span class="p">:</span>
        <span class="n">to</span><span class="o">=</span><span class="kc">None</span>
        <span class="n">p_smth_mat_inv</span><span class="o">=</span><span class="kc">None</span>
        <span class="c1">#res_mean = ((res.sum(axis=0))).sum(axis=0)/sqrt(shap[0]*shap[1])</span>
        <span class="c1">#res_mean = res_mean.reshape((shap[2],1))</span>
        <span class="n">res_mat</span> <span class="o">=</span> <span class="n">transpose</span><span class="p">(</span><span class="n">res</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">])))</span>
        <span class="n">p_out</span><span class="p">,</span><span class="n">e_out</span> <span class="o">=</span> <span class="n">notch_filt_optim</span><span class="p">(</span><span class="n">res_mat</span><span class="p">,</span><span class="n">dists_unsorted</span><span class="p">,</span><span class="n">p_range</span><span class="p">,</span><span class="n">e_range</span><span class="p">,</span><span class="n">nb_iter</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span><span class="n">tol</span><span class="o">=</span><span class="mf">0.0001</span><span class="p">)</span>
        <span class="n">pows</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">p_out</span>
        <span class="n">e_opt</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">e_out</span>
        <span class="sd">&quot;&quot;&quot;if i==0:</span>
<span class="sd">            pows[i]=p_min # =1</span>
<span class="sd">        else:</span>
<span class="sd">            pows[i]= (pows[i-1]+p_max)/2&quot;&quot;&quot;</span>
        <span class="n">dist_weights_in</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">nb_im</span><span class="p">,</span><span class="n">nb_neighs</span><span class="p">,</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">ind</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
            <span class="c1">#dist_weights_in[:,:,ind] = (dist_med/dists)**pows[ind]</span>
            <span class="n">dist_weights_in</span><span class="p">[:,:,</span><span class="n">ind</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">dist_med</span><span class="o">/</span><span class="n">dists_unsorted</span><span class="p">)</span><span class="o">**</span><span class="n">pows</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span>
            <span class="n">dist_weights_in</span><span class="p">[:,:,</span><span class="n">ind</span><span class="p">]</span> <span class="o">=</span> <span class="n">dist_weights_in</span><span class="p">[:,:,</span><span class="n">ind</span><span class="p">]</span><span class="o">/</span><span class="n">sqrt</span><span class="p">((</span><span class="n">dist_weights_in</span><span class="p">[:,:,</span><span class="n">ind</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span>

        <span class="c1">#if i&gt;0:</span>
        <span class="c1">#w = weight_init(dist_weights_in[:,:,i],res,nb_iter=0)</span>
        <span class="c1">#w = utils.abs_val_reverting(weights[i-1,:])</span>
        <span class="n">coeff_res</span><span class="p">,</span><span class="n">comp_res</span><span class="p">,</span><span class="n">est</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">cube_svd</span><span class="p">(</span><span class="n">utils</span><span class="o">.</span><span class="n">rect_crop_c</span><span class="p">(</span><span class="n">res</span><span class="p">,</span><span class="nb">int</span><span class="p">(</span><span class="mf">0.9</span><span class="o">*</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span><span class="nb">int</span><span class="p">(</span><span class="mf">0.9</span><span class="o">*</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span><span class="n">centroids</span><span class="p">))</span>

        <span class="c1">#coeff_res,comp_res,est = utils.cube_svd(res)</span>
        <span class="n">i0</span><span class="p">,</span><span class="n">j0</span> <span class="o">=</span> <span class="n">where</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">comp_res</span><span class="p">[:,:,</span><span class="mi">0</span><span class="p">])</span><span class="o">==</span><span class="nb">abs</span><span class="p">(</span><span class="n">comp_res</span><span class="p">[:,:,</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">max</span><span class="p">())</span>
        <span class="n">w</span> <span class="o">=</span> <span class="n">coeff_res</span><span class="p">[</span><span class="mi">0</span><span class="p">,:]</span><span class="o">*</span><span class="n">sign</span><span class="p">(</span><span class="n">comp_res</span><span class="p">[</span><span class="n">i0</span><span class="p">,</span><span class="n">j0</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span>
        <span class="c1">#w = weight_init(dist_weights_in[:,:,i],res,nb_iter=10,winit=w)</span>
        <span class="c1">#print &quot;warning coeff debug&quot;</span>
        <span class="c1">#w = w*0+1</span>
        <span class="n">resk</span> <span class="o">=</span> <span class="n">res</span><span class="o">*</span><span class="mi">0</span>
        <span class="k">if</span> <span class="n">pix_sparsity</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">weights_sp</span> <span class="o">=</span> <span class="n">ones</span><span class="p">((</span><span class="n">shap2</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">shap2</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">shap2</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">weights_sp</span> <span class="o">=</span> <span class="n">ones</span><span class="p">((</span><span class="n">upfact</span><span class="o">*</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">upfact</span><span class="o">*</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>

        <span class="n">nb_subiter_prox</span> <span class="o">=</span> <span class="mi">50</span>
        <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">weights_init</span><span class="o">=</span><span class="kc">None</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_iter</span><span class="p">):</span>
            <span class="c1"># Direction initialization</span>
            <span class="n">t</span><span class="o">=</span><span class="mi">1</span>

            <span class="nb">print</span> <span class="s2">&quot; ------ ref energy: &quot;</span><span class="p">,(</span><span class="n">psf_stack</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(),</span><span class="s2">&quot; ------- &quot;</span>

            <span class="c1"># Global residual calculation</span>
            <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
                <span class="n">res</span><span class="p">[:,:,</span><span class="n">l</span><span class="p">]</span> <span class="o">=</span> <span class="n">psf_stack</span><span class="p">[:,:,</span><span class="n">l</span><span class="p">]</span><span class="o">-</span><span class="p">(</span><span class="n">flux_ref</span><span class="o">/</span><span class="p">(</span><span class="n">sig_est</span><span class="p">[</span><span class="n">l</span><span class="p">]</span><span class="o">*</span><span class="n">flux_est</span><span class="p">[</span><span class="n">l</span><span class="p">]))</span><span class="o">*</span><span class="n">utils</span><span class="o">.</span><span class="n">decim</span><span class="p">(</span><span class="n">scisig</span><span class="o">.</span><span class="n">fftconvolve</span><span class="p">(</span><span class="n">im_hr</span><span class="p">[:,:,</span><span class="n">l</span><span class="p">],</span><span class="n">shift_ker_stack</span><span class="p">[:,:,</span><span class="n">l</span><span class="p">],</span><span class="n">mode</span><span class="o">=</span><span class="s1">&#39;same&#39;</span><span class="p">),</span><span class="n">upfact</span><span class="p">,</span><span class="n">av_en</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

            <span class="n">nsig_hub_k</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">res</span><span class="p">)</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">/</span><span class="n">sig_min</span>
            <span class="nb">print</span> <span class="s2">&quot;------------------- Component &quot;</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="s2">&quot; ------------------&quot;</span>
            <span class="nb">print</span> <span class="s2">&quot;weights: &quot;</span><span class="p">,</span><span class="n">w</span>
            <span class="nb">input</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">=</span><span class="n">w</span>
            <span class="k">if</span> <span class="n">i</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">i_l</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">i</span><span class="p">):</span>
                    <span class="nb">print</span> <span class="s2">&quot;weights &quot;</span><span class="p">,</span><span class="n">i_l</span><span class="p">,</span><span class="s2">&quot; comp:&quot;</span><span class="p">,</span><span class="n">weights</span><span class="p">[</span><span class="n">i_l</span><span class="p">,:]</span>

            <span class="c1"># Spectral radius</span>
            <span class="n">eig_max</span><span class="p">,</span><span class="n">spec_rad</span> <span class="o">=</span> <span class="n">pow_meth</span><span class="p">(</span><span class="n">sr_op_trans_stack</span><span class="p">,</span><span class="nb">input</span><span class="p">,</span><span class="n">siz_in</span><span class="p">,</span><span class="n">ainit</span><span class="o">=</span><span class="n">eig_max</span><span class="p">)</span>


            <span class="c1"># ith component estimation</span>
            <span class="n">j</span><span class="o">=</span><span class="mi">0</span>
            <span class="nb">print</span> <span class="s1">&#39;--------------- &#39;</span><span class="p">,</span><span class="n">nb_subiter</span><span class="p">,</span><span class="s1">&#39; ----------------&#39;</span>
            <span class="n">res_old</span> <span class="o">=</span> <span class="n">cur_res</span><span class="o">*</span><span class="mi">2</span>
            <span class="k">while</span> <span class="p">(</span><span class="n">j</span> <span class="o">&lt;</span> <span class="n">nb_subiter</span> <span class="ow">and</span> <span class="mi">100</span><span class="o">*</span><span class="nb">abs</span><span class="p">(</span><span class="n">cur_res</span><span class="o">-</span><span class="n">res_old</span><span class="p">)</span><span class="o">/</span><span class="n">res_old</span><span class="o">&gt;</span><span class="mf">0.01</span><span class="p">):</span><span class="c1"># or j&lt;nb_subiter_min_2:</span>

                <span class="n">res_old</span> <span class="o">=</span> <span class="n">cur_res</span>
                <span class="c1"># Residual computation</span>
                <span class="n">grad</span> <span class="o">=</span> <span class="n">grad</span><span class="o">*</span><span class="mi">0</span>
                <span class="n">nsig_hubj</span> <span class="o">=</span> <span class="n">nsig_hub</span>
                <span class="k">if</span> <span class="n">nsig_hub_k</span><span class="o">&gt;</span><span class="n">nsig_hub</span><span class="p">:</span>
                    <span class="n">atemp</span> <span class="o">=</span> <span class="n">double</span><span class="p">((</span><span class="n">nsig_hub_k</span><span class="o">-</span><span class="n">nsig_hub</span><span class="p">)</span><span class="o">*</span><span class="n">nb_subiter</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">nb_subiter</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
                    <span class="n">btemp</span> <span class="o">=</span> <span class="n">nsig_hub_k</span><span class="o">-</span><span class="n">atemp</span>
                    <span class="n">nsig_hubj</span> <span class="o">=</span> <span class="n">atemp</span><span class="o">/</span><span class="p">(</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">btemp</span>
                    <span class="nb">print</span> <span class="s2">&quot;Huber k sig: &quot;</span><span class="p">,</span><span class="n">nsig_hubj</span>
                <span class="k">if</span> <span class="n">j</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>

                    <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
                        <span class="n">resk</span><span class="p">[:,:,</span><span class="n">l</span><span class="p">]</span> <span class="o">=</span> <span class="n">res</span><span class="p">[:,:,</span><span class="n">l</span><span class="p">]</span><span class="o">-</span><span class="p">(</span><span class="n">w</span><span class="p">[</span><span class="n">l</span><span class="p">]</span><span class="o">*</span><span class="n">flux_ref</span><span class="o">/</span><span class="p">(</span><span class="n">sig_est</span><span class="p">[</span><span class="n">l</span><span class="p">]</span><span class="o">*</span><span class="n">flux_est</span><span class="p">[</span><span class="n">l</span><span class="p">]))</span><span class="o">*</span><span class="n">utils</span><span class="o">.</span><span class="n">decim</span><span class="p">(</span><span class="n">scisig</span><span class="o">.</span><span class="n">fftconvolve</span><span class="p">(</span><span class="n">comp</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">],</span><span class="n">shift_ker_stack</span><span class="p">[:,:,</span><span class="n">l</span><span class="p">],</span><span class="n">mode</span><span class="o">=</span><span class="s1">&#39;same&#39;</span><span class="p">),</span><span class="n">upfact</span><span class="p">,</span><span class="n">av_en</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                        <span class="n">s</span> <span class="o">=</span> <span class="n">sign</span><span class="p">(</span><span class="n">resk</span><span class="p">[:,:,</span><span class="n">l</span><span class="p">])</span>
                        <span class="n">ones_mat</span> <span class="o">=</span> <span class="n">ones</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>


                        <span class="n">ind1</span><span class="p">,</span><span class="n">ind2</span> <span class="o">=</span> <span class="n">where</span><span class="p">((</span><span class="nb">abs</span><span class="p">(</span><span class="n">resk</span><span class="p">[:,:,</span><span class="n">l</span><span class="p">]))</span><span class="o">&lt;</span><span class="n">nsig_hubj</span><span class="o">*</span><span class="n">sig_min</span><span class="p">)</span>
                        <span class="n">mask</span> <span class="o">=</span> <span class="n">ones</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
                        <span class="n">mask</span><span class="p">[</span><span class="n">ind1</span><span class="p">,</span><span class="n">ind2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
                        <span class="n">grad</span> <span class="o">=</span> <span class="n">grad</span><span class="o">-</span><span class="p">(</span><span class="n">w</span><span class="p">[</span><span class="n">l</span><span class="p">]</span><span class="o">*</span><span class="n">flux_ref</span><span class="o">/</span><span class="p">(</span><span class="n">sig_est</span><span class="p">[</span><span class="n">l</span><span class="p">]</span><span class="o">*</span><span class="n">flux_est</span><span class="p">[</span><span class="n">l</span><span class="p">]))</span><span class="o">*</span><span class="n">scisig</span><span class="o">.</span><span class="n">convolve</span><span class="p">(</span><span class="n">utils</span><span class="o">.</span><span class="n">transpose_decim</span><span class="p">((</span><span class="n">ones_mat</span><span class="o">-</span><span class="n">mask</span><span class="p">)</span><span class="o">*</span><span class="n">resk</span><span class="p">[:,:,</span><span class="n">l</span><span class="p">],</span><span class="n">upfact</span><span class="p">),</span><span class="n">shift_ker_stack_adj</span><span class="p">[:,:,</span><span class="n">l</span><span class="p">],</span><span class="n">mode</span><span class="o">=</span><span class="s1">&#39;same&#39;</span><span class="p">)</span><span class="o">-</span><span class="p">(</span><span class="n">w</span><span class="p">[</span><span class="n">l</span><span class="p">]</span><span class="o">*</span><span class="n">nsig_hubj</span><span class="o">*</span><span class="n">sig_min</span><span class="o">*</span><span class="n">flux_ref</span><span class="o">/</span><span class="p">(</span><span class="n">sig_est</span><span class="p">[</span><span class="n">l</span><span class="p">]</span><span class="o">*</span><span class="n">flux_est</span><span class="p">[</span><span class="n">l</span><span class="p">]))</span><span class="o">*</span><span class="n">scisig</span><span class="o">.</span><span class="n">convolve</span><span class="p">(</span><span class="n">utils</span><span class="o">.</span><span class="n">transpose_decim</span><span class="p">(</span><span class="n">mask</span><span class="o">*</span><span class="n">s</span><span class="p">,</span><span class="n">upfact</span><span class="p">),</span><span class="n">shift_ker_stack_adj</span><span class="p">[:,:,</span><span class="n">l</span><span class="p">],</span><span class="n">mode</span><span class="o">=</span><span class="s1">&#39;same&#39;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
                        <span class="n">s</span> <span class="o">=</span> <span class="n">sign</span><span class="p">(</span><span class="n">resk</span><span class="p">[:,:,</span><span class="n">l</span><span class="p">])</span>
                        <span class="n">ones_mat</span> <span class="o">=</span> <span class="n">ones</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
                        <span class="n">ind1</span><span class="p">,</span><span class="n">ind2</span> <span class="o">=</span> <span class="n">where</span><span class="p">((</span><span class="nb">abs</span><span class="p">(</span><span class="n">resk</span><span class="p">[:,:,</span><span class="n">l</span><span class="p">]))</span><span class="o">&lt;</span><span class="n">nsig_hubj</span><span class="o">*</span><span class="n">sig_min</span><span class="p">)</span>
                        <span class="n">mask</span> <span class="o">=</span> <span class="n">ones</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
                        <span class="n">mask</span><span class="p">[</span><span class="n">ind1</span><span class="p">,</span><span class="n">ind2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
                        <span class="n">grad</span> <span class="o">=</span> <span class="n">grad</span><span class="o">-</span><span class="p">(</span><span class="n">w</span><span class="p">[</span><span class="n">l</span><span class="p">]</span><span class="o">*</span><span class="n">flux_ref</span><span class="o">/</span><span class="p">(</span><span class="n">sig_est</span><span class="p">[</span><span class="n">l</span><span class="p">]</span><span class="o">*</span><span class="n">flux_est</span><span class="p">[</span><span class="n">l</span><span class="p">]))</span><span class="o">*</span><span class="n">scisig</span><span class="o">.</span><span class="n">convolve</span><span class="p">(</span><span class="n">utils</span><span class="o">.</span><span class="n">transpose_decim</span><span class="p">((</span><span class="n">ones_mat</span><span class="o">-</span><span class="n">mask</span><span class="p">)</span><span class="o">*</span><span class="n">resk</span><span class="p">[:,:,</span><span class="n">l</span><span class="p">],</span><span class="n">upfact</span><span class="p">),</span><span class="n">shift_ker_stack_adj</span><span class="p">[:,:,</span><span class="n">l</span><span class="p">],</span><span class="n">mode</span><span class="o">=</span><span class="s1">&#39;same&#39;</span><span class="p">)</span><span class="o">-</span><span class="p">(</span><span class="n">w</span><span class="p">[</span><span class="n">l</span><span class="p">]</span><span class="o">*</span><span class="n">nsig_hubj</span><span class="o">*</span><span class="n">sig_min</span><span class="o">*</span><span class="n">flux_ref</span><span class="o">/</span><span class="p">(</span><span class="n">sig_est</span><span class="p">[</span><span class="n">l</span><span class="p">]</span><span class="o">*</span><span class="n">flux_est</span><span class="p">[</span><span class="n">l</span><span class="p">]))</span><span class="o">*</span><span class="n">scisig</span><span class="o">.</span><span class="n">convolve</span><span class="p">(</span><span class="n">utils</span><span class="o">.</span><span class="n">transpose_decim</span><span class="p">(</span><span class="n">mask</span><span class="o">*</span><span class="n">s</span><span class="p">,</span><span class="n">upfact</span><span class="p">),</span><span class="n">shift_ker_stack_adj</span><span class="p">[:,:,</span><span class="n">l</span><span class="p">],</span><span class="n">mode</span><span class="o">=</span><span class="s1">&#39;same&#39;</span><span class="p">)</span>


                <span class="n">buff</span><span class="p">[</span><span class="n">j</span><span class="o">%</span><span class="n">nb_subiter_min</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">resk</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">j</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
                    <span class="nb">print</span> <span class="s2">&quot;---- Ref mse ---- &quot;</span><span class="p">,</span><span class="n">buff</span><span class="p">[</span><span class="n">j</span><span class="o">%</span><span class="n">nb_subiter_min</span><span class="p">]</span>

                <span class="k">if</span> <span class="n">j</span><span class="o">&gt;=</span><span class="n">nb_subiter_min</span><span class="p">:</span>
                    <span class="n">cur_res</span> <span class="o">=</span> <span class="n">buff</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">cur_res</span> <span class="o">=</span> <span class="n">buff</span><span class="p">[</span><span class="n">j</span><span class="o">%</span><span class="n">nb_subiter_min</span><span class="p">]</span>
                <span class="c1"># Exact line search</span>
                <span class="n">muj</span> <span class="o">=</span> <span class="n">mu</span><span class="o">/</span><span class="n">spec_rad</span>
                <span class="k">if</span> <span class="n">line_search_en</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
                    <span class="n">c1</span><span class="o">=</span><span class="mi">0</span>
                    <span class="n">c2</span><span class="o">=</span><span class="mi">0</span>
                    <span class="n">c3</span><span class="o">=</span><span class="mi">0</span>
                    <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
                        <span class="n">u1</span> <span class="o">=</span> <span class="n">res</span><span class="p">[:,:,</span><span class="n">l</span><span class="p">]</span><span class="o">-</span><span class="p">(</span><span class="n">w</span><span class="p">[</span><span class="n">l</span><span class="p">]</span><span class="o">*</span><span class="n">flux_ref</span><span class="o">/</span><span class="p">(</span><span class="n">sig_est</span><span class="p">[</span><span class="n">l</span><span class="p">]</span><span class="o">*</span><span class="n">flux_est</span><span class="p">[</span><span class="n">l</span><span class="p">]))</span><span class="o">*</span><span class="n">utils</span><span class="o">.</span><span class="n">decim</span><span class="p">(</span><span class="n">scisig</span><span class="o">.</span><span class="n">fftconvolve</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">comp</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">]</span><span class="o">-</span><span class="n">z1</span><span class="p">,</span><span class="n">shift_ker_stack</span><span class="p">[:,:,</span><span class="n">l</span><span class="p">],</span><span class="n">mode</span><span class="o">=</span><span class="s1">&#39;same&#39;</span><span class="p">),</span><span class="n">upfact</span><span class="p">,</span><span class="n">av_en</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                        <span class="n">u2</span> <span class="o">=</span> <span class="n">res</span><span class="p">[:,:,</span><span class="n">l</span><span class="p">]</span><span class="o">-</span><span class="p">(</span><span class="n">w</span><span class="p">[</span><span class="n">l</span><span class="p">]</span><span class="o">*</span><span class="n">flux_ref</span><span class="o">/</span><span class="p">(</span><span class="n">sig_est</span><span class="p">[</span><span class="n">l</span><span class="p">]</span><span class="o">*</span><span class="n">flux_est</span><span class="p">[</span><span class="n">l</span><span class="p">]))</span><span class="o">*</span><span class="n">utils</span><span class="o">.</span><span class="n">decim</span><span class="p">(</span><span class="n">scisig</span><span class="o">.</span><span class="n">fftconvolve</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">comp</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">]</span><span class="o">-</span><span class="n">z2</span><span class="p">,</span><span class="n">shift_ker_stack</span><span class="p">[:,:,</span><span class="n">l</span><span class="p">],</span><span class="n">mode</span><span class="o">=</span><span class="s1">&#39;same&#39;</span><span class="p">),</span><span class="n">upfact</span><span class="p">,</span><span class="n">av_en</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                        <span class="n">u3</span> <span class="o">=</span> <span class="o">-</span><span class="p">(</span><span class="n">w</span><span class="p">[</span><span class="n">l</span><span class="p">]</span><span class="o">*</span><span class="n">flux_ref</span><span class="o">/</span><span class="p">(</span><span class="n">sig_est</span><span class="p">[</span><span class="n">l</span><span class="p">]</span><span class="o">*</span><span class="n">flux_est</span><span class="p">[</span><span class="n">l</span><span class="p">]))</span><span class="o">*</span><span class="n">utils</span><span class="o">.</span><span class="n">decim</span><span class="p">(</span><span class="n">scisig</span><span class="o">.</span><span class="n">fftconvolve</span><span class="p">(</span><span class="n">grad</span><span class="p">,</span><span class="n">shift_ker_stack</span><span class="p">[:,:,</span><span class="n">l</span><span class="p">],</span><span class="n">mode</span><span class="o">=</span><span class="s1">&#39;same&#39;</span><span class="p">),</span><span class="n">upfact</span><span class="p">,</span><span class="n">av_en</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                        <span class="n">c1</span><span class="o">+=</span> <span class="p">(</span><span class="n">u1</span><span class="o">*</span><span class="n">u3</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
                        <span class="n">c2</span><span class="o">+=</span> <span class="p">(</span><span class="n">u2</span><span class="o">*</span><span class="n">u3</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
                        <span class="n">c3</span><span class="o">+=</span> <span class="p">(</span><span class="n">u3</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
                        <span class="n">muj</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">c1</span><span class="o">/</span><span class="n">c3</span><span class="p">,</span><span class="n">c2</span><span class="o">/</span><span class="n">c3</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">cv_proof_en</span> <span class="o">==</span><span class="mi">1</span><span class="p">:</span>
                    <span class="n">muj</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">muj</span><span class="p">,</span><span class="n">mu</span><span class="o">/</span><span class="n">spec_rad</span><span class="p">)</span>
                    <span class="nb">print</span> <span class="s2">&quot;Optimal step: &quot;</span><span class="p">,</span><span class="n">muj</span><span class="p">,</span><span class="s2">&quot; Max for cv proof: &quot;</span><span class="p">,</span><span class="mi">2</span><span class="o">/</span><span class="n">spec_rad</span>
                <span class="c1"># ---- Sparsity constraint ---- #</span>
                <span class="c1"># Wavelet noise estimation</span>
                <span class="c1">#temp1 = 2*comp[:,:,i] - z1 - muj*grad</span>
                <span class="n">temp1</span> <span class="o">=</span> <span class="n">comp</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">muj</span><span class="o">*</span><span class="n">grad</span>
                <span class="k">if</span> <span class="n">j</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
                    <span class="n">thresh_max</span> <span class="o">=</span> <span class="mf">0.9</span><span class="o">*</span><span class="nb">abs</span><span class="p">(</span><span class="n">temp1</span><span class="p">)</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
                <span class="c1">#result = copy(temp1)</span>
                <span class="k">if</span> <span class="n">sparsity_en</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">pix_sparsity</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">j</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
                            <span class="n">sig_map</span> <span class="o">=</span> <span class="n">muj</span><span class="o">*</span><span class="n">utils</span><span class="o">.</span><span class="n">acc_sig_map</span><span class="p">(</span><span class="n">shap</span><span class="p">,</span><span class="n">shift_ker_stack_adj</span><span class="p">,</span><span class="n">sig_est</span><span class="p">,</span><span class="n">flux_est</span><span class="p">,</span><span class="n">flux_ref</span><span class="p">,</span><span class="n">upfact</span><span class="p">,</span><span class="n">w</span><span class="p">,</span><span class="n">sig_data</span><span class="o">=</span><span class="n">sig_min_vect</span><span class="p">)</span>
                            <span class="n">sig_map</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">sig_map</span><span class="p">(</span><span class="n">muj</span><span class="o">*</span><span class="n">grad</span><span class="p">)</span>
                            <span class="n">thresh_map</span> <span class="o">=</span> <span class="n">nsig</span><span class="o">*</span><span class="n">sig_map</span>
                            <span class="n">thresh_map</span> <span class="o">=</span> <span class="n">thresh_map</span><span class="o">*</span><span class="n">weights_sp</span>
                        <span class="c1">#thresh_map = ones((shap[0]*upfact,shap[1]*upfact))*((thresh_max-nsig*sig_map.max())/((j+1)**2)) + nsig*sig_map</span>
                        <span class="n">result</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">thresholding</span><span class="p">(</span><span class="n">temp1</span><span class="p">,</span><span class="n">thresh_map</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">k</span><span class="o">==</span><span class="mi">0</span> <span class="ow">and</span> <span class="n">j</span><span class="o">==</span><span class="n">nb_subiter_min_2</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                            <span class="n">sig_map</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">res_sig_map</span><span class="p">(</span><span class="n">muj</span><span class="o">*</span><span class="n">grad</span><span class="p">,</span><span class="n">opt</span><span class="o">=</span><span class="n">opt</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">global_sparsity_en</span><span class="p">:</span>
                                <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
                                    <span class="n">g_thresh_map</span><span class="p">[:,:,:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">l</span><span class="p">]</span> <span class="o">=</span> <span class="n">w</span><span class="p">[</span><span class="n">l</span><span class="p">]</span><span class="o">*</span><span class="n">sig_map</span>
                                    <span class="n">g_thresh_map_2</span><span class="p">[:,:,:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">l</span><span class="p">]</span> <span class="o">=</span> <span class="n">sig_map</span>
                                <span class="n">g_thresh_map</span> <span class="o">=</span> <span class="n">nsig</span><span class="o">*</span><span class="n">g_thresh_map</span><span class="o">*</span><span class="n">g_weights_sp</span>
                                <span class="n">g_thresh_map_2</span> <span class="o">=</span> <span class="n">nsig</span><span class="o">*</span><span class="n">g_thresh_map</span><span class="o">*</span><span class="n">g_weights_sp_2</span>
                                <span class="k">if</span> <span class="n">i</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
                                    <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
                                        <span class="n">u</span><span class="p">,</span><span class="n">mr_file_temp</span> <span class="o">=</span> <span class="n">isap</span><span class="o">.</span><span class="n">mr_trans</span><span class="p">(</span><span class="n">im_hr_dev</span><span class="p">[:,:,</span><span class="n">l</span><span class="p">],</span><span class="n">opt</span><span class="o">=</span><span class="n">opt</span><span class="p">)</span>
                                        <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">mr_file_temp</span><span class="p">)</span>
                                        <span class="n">dev</span><span class="p">[:,:,:,</span><span class="n">l</span><span class="p">]</span> <span class="o">=</span> <span class="n">g_thresh_map</span><span class="p">[:,:,:,</span><span class="n">l</span><span class="p">]</span><span class="o">*</span><span class="n">u</span><span class="o">/</span><span class="n">w</span><span class="p">[</span><span class="n">l</span><span class="p">]</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">thresh_map</span> <span class="o">=</span> <span class="n">nsig</span><span class="o">*</span><span class="n">sig_map</span>
                                <span class="n">thresh_map</span> <span class="o">=</span> <span class="n">thresh_map</span><span class="o">*</span><span class="n">weights_sp</span>
                        <span class="c1"># Sparsity</span>
                        <span class="k">if</span> <span class="n">j</span><span class="o">&gt;=</span><span class="n">nb_subiter_min_2</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">global_sparsity_en</span><span class="p">:</span>
                                <span class="n">result</span><span class="p">,</span><span class="n">mr_file</span><span class="p">,</span><span class="n">n</span><span class="p">,</span><span class="n">coeff_init</span> <span class="o">=</span> <span class="n">wvl_analysis_op_src</span><span class="p">(</span><span class="n">temp1</span><span class="p">,</span><span class="n">dev</span><span class="p">,</span><span class="n">g_thresh_map</span><span class="o">/</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">w</span><span class="p">,</span><span class="n">mu</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">opt</span><span class="o">=</span><span class="n">opt</span><span class="p">,</span><span class="n">coeff_init</span><span class="o">=</span><span class="n">coeff_init</span><span class="p">,</span><span class="n">mr_file</span><span class="o">=</span><span class="n">mr_file</span><span class="p">,</span><span class="n">nb_iter</span><span class="o">=</span><span class="n">nb_subiter_prox</span><span class="p">)</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">result</span><span class="p">,</span><span class="n">mr_file</span><span class="p">,</span><span class="n">n</span><span class="p">,</span><span class="n">coeff_init</span> <span class="o">=</span> <span class="n">wvl_analysis_op</span><span class="p">(</span><span class="n">temp1</span><span class="p">,</span><span class="n">thresh_map</span><span class="p">,</span><span class="n">opt</span><span class="o">=</span><span class="n">opt</span><span class="p">,</span><span class="n">coeff_init</span><span class="o">=</span><span class="n">coeff_init</span><span class="p">,</span><span class="n">mr_file</span><span class="o">=</span><span class="n">mr_file</span><span class="p">,</span><span class="n">nb_iter</span><span class="o">=</span><span class="n">nb_subiter_prox</span><span class="p">)</span>
                            <span class="n">nb_subiter_prox</span> <span class="o">=</span> <span class="mi">10</span>

                <span class="c1">#z1 = z1+lambd*(result-comp[:,:,i])</span>
                <span class="c1"># ---- Positivity constraint ---- #</span>
                <span class="n">temp2</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">comp</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">z2</span> <span class="o">-</span> <span class="n">muj</span><span class="o">*</span><span class="n">grad</span>
                <span class="k">if</span> <span class="n">positivity_en</span><span class="p">:</span>
                    <span class="n">z2</span> <span class="o">=</span> <span class="n">z2</span><span class="o">+</span><span class="n">lambd</span><span class="o">*</span><span class="p">(</span><span class="n">proj_affine_pos2</span><span class="p">(</span><span class="n">temp2</span><span class="p">,</span><span class="n">w</span><span class="p">,</span><span class="n">im_hr</span><span class="p">,</span><span class="n">min_val_map</span><span class="o">=</span><span class="n">min_val_map</span><span class="p">)</span><span class="o">-</span><span class="n">comp</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">z2</span> <span class="o">=</span> <span class="n">z2</span><span class="o">+</span><span class="n">lambd</span><span class="o">*</span><span class="p">(</span><span class="n">temp2</span><span class="o">-</span><span class="n">comp</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">])</span>
                <span class="c1"># ---- Main variable update ---- #</span>
                <span class="c1">#comp[:,:,i] = w1*z1 + w2*z2</span>
                <span class="n">comp</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span>
                <span class="k">if</span> <span class="n">k</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
                    <span class="n">comp_tracking</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">comp</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">])</span>
                <span class="n">count</span><span class="o">+=</span><span class="mi">1</span>
                <span class="k">if</span> <span class="n">sparsity_en</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">pix_sparsity</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">j</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
                            <span class="nb">print</span> <span class="s2">&quot;========== Estimated back-progated noise in pixel domain (average): =========&quot;</span><span class="p">,</span><span class="n">mean</span><span class="p">(</span><span class="n">sig_map</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">k</span><span class="o">==</span><span class="mi">0</span> <span class="ow">and</span> <span class="n">j</span><span class="o">==</span><span class="n">nb_subiter_min_2</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                            <span class="nb">print</span> <span class="s2">&quot;========== Estimated noise at the first scales: =========&quot;</span><span class="p">,</span><span class="n">sig_map</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,:]</span>

                <span class="n">j</span><span class="o">+=</span><span class="mi">1</span>
                <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
                    <span class="n">resk</span><span class="p">[:,:,</span><span class="n">l</span><span class="p">]</span> <span class="o">=</span> <span class="n">res</span><span class="p">[:,:,</span><span class="n">l</span><span class="p">]</span><span class="o">-</span><span class="p">(</span><span class="n">w</span><span class="p">[</span><span class="n">l</span><span class="p">]</span><span class="o">*</span><span class="n">flux_ref</span><span class="o">/</span><span class="p">(</span><span class="n">sig_est</span><span class="p">[</span><span class="n">l</span><span class="p">]</span><span class="o">*</span><span class="n">flux_est</span><span class="p">[</span><span class="n">l</span><span class="p">]))</span><span class="o">*</span><span class="n">utils</span><span class="o">.</span><span class="n">decim</span><span class="p">(</span><span class="n">scisig</span><span class="o">.</span><span class="n">fftconvolve</span><span class="p">(</span><span class="n">comp</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">],</span><span class="n">shift_ker_stack</span><span class="p">[:,:,</span><span class="n">l</span><span class="p">],</span><span class="n">mode</span><span class="o">=</span><span class="s1">&#39;same&#39;</span><span class="p">),</span><span class="n">upfact</span><span class="p">,</span><span class="n">av_en</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                <span class="n">buff</span><span class="p">[</span><span class="n">j</span><span class="o">%</span><span class="n">nb_subiter_min</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">resk</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>

                <span class="nb">print</span> <span class="s2">&quot;mse: &quot;</span><span class="p">,</span> <span class="n">buff</span><span class="p">[</span><span class="n">j</span><span class="o">%</span><span class="n">nb_subiter_min</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">j</span><span class="o">&gt;=</span><span class="n">nb_subiter_min</span><span class="p">:</span>
                    <span class="n">cur_res</span> <span class="o">=</span> <span class="n">buff</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">cur_res</span> <span class="o">=</span> <span class="n">buff</span><span class="p">[</span><span class="n">j</span><span class="o">%</span><span class="n">nb_subiter_min</span><span class="p">]</span>
            <span class="n">res_inter_comp</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">buff</span><span class="p">[</span><span class="n">j</span><span class="o">%</span><span class="n">nb_subiter_min</span><span class="p">]</span>
            <span class="n">buff</span><span class="o">=</span><span class="n">buff</span><span class="o">*</span><span class="mi">0</span>
            <span class="c1"># First HR images update</span>
            <span class="n">im_hr</span> <span class="o">=</span> <span class="mi">0</span><span class="o">*</span><span class="n">im_hr</span>
            <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
                <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">i</span><span class="p">):</span>
                    <span class="n">im_hr</span><span class="p">[:,:,</span><span class="n">l</span><span class="p">]</span> <span class="o">=</span> <span class="n">im_hr</span><span class="p">[:,:,</span><span class="n">l</span><span class="p">]</span><span class="o">+</span><span class="n">weights</span><span class="p">[</span><span class="n">p</span><span class="p">,</span><span class="n">l</span><span class="p">]</span><span class="o">*</span><span class="n">comp</span><span class="p">[:,:,</span><span class="n">p</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">global_sparsity_en</span><span class="p">:</span>
                    <span class="n">coeffx</span><span class="p">,</span><span class="n">mr_file_2</span> <span class="o">=</span> <span class="n">isap</span><span class="o">.</span><span class="n">mr_trans</span><span class="p">(</span><span class="n">im_hr</span><span class="p">[:,:,</span><span class="n">l</span><span class="p">],</span><span class="n">opt</span><span class="o">=</span><span class="n">opt</span><span class="p">)</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">mr_file_2</span><span class="p">)</span>
            <span class="c1"># Reweighting</span>
            <span class="k">if</span> <span class="n">sparsity_en</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">global_sparsity_en</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
                        <span class="n">coeffx</span><span class="o">=</span><span class="kc">None</span>
                        <span class="k">if</span> <span class="n">i</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
                            <span class="n">coeffx</span><span class="p">,</span><span class="n">mr_file_2</span> <span class="o">=</span> <span class="n">isap</span><span class="o">.</span><span class="n">mr_trans</span><span class="p">(</span><span class="n">im_hr</span><span class="p">[:,:,</span><span class="n">l</span><span class="p">],</span><span class="n">opt</span><span class="o">=</span><span class="n">opt</span><span class="p">)</span>
                            <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">mr_file_2</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">coeffx</span><span class="p">,</span><span class="n">mr_file_2</span> <span class="o">=</span> <span class="n">isap</span><span class="o">.</span><span class="n">mr_trans</span><span class="p">(</span><span class="n">im_hr_dev</span><span class="p">[:,:,</span><span class="n">l</span><span class="p">],</span><span class="n">opt</span><span class="o">=</span><span class="n">opt</span><span class="p">)</span>
                            <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">mr_file_2</span><span class="p">)</span>

                        <span class="n">g_weights_sp</span><span class="p">[:,:,:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">l</span><span class="p">]</span>  <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="nb">abs</span><span class="p">(</span><span class="n">coeffx</span><span class="p">[:,:,:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span><span class="o">/</span><span class="p">(</span><span class="n">nsig</span><span class="o">*</span><span class="n">sig_map</span><span class="o">*</span><span class="n">wold</span><span class="p">[</span><span class="n">l</span><span class="p">]))</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
                        <span class="n">g_weights_sp_2</span><span class="p">[:,:,:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">l</span><span class="p">]</span>  <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="nb">abs</span><span class="p">(</span><span class="n">coeffx</span><span class="p">[:,:,:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span><span class="o">/</span><span class="p">(</span><span class="n">nsig</span><span class="o">*</span><span class="n">sig_map</span><span class="p">))</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">pix_sparsity</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">True</span><span class="p">:</span>
                    <span class="n">coeffx</span><span class="p">,</span><span class="n">mr_file_2</span> <span class="o">=</span> <span class="n">isap</span><span class="o">.</span><span class="n">mr_trans</span><span class="p">(</span><span class="n">comp</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">],</span><span class="n">opt</span><span class="o">=</span><span class="n">opt</span><span class="p">)</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">mr_file_2</span><span class="p">)</span>
                    <span class="n">weights_sp</span>  <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="nb">abs</span><span class="p">(</span><span class="n">coeffx</span><span class="p">[:,:,:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span><span class="o">/</span><span class="p">(</span><span class="n">nsig</span><span class="o">*</span><span class="n">sig_map</span><span class="p">))</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
                <span class="sd">&quot;&quot;&quot;else:</span>
<span class="sd">                    weights_sp  = (1+abs(comp[:,:,i])/(nsig*sig_map))**(-1)&quot;&quot;&quot;</span>

            <span class="c1"># Component normalization</span>
            <span class="n">a</span> <span class="o">=</span> <span class="n">sqrt</span><span class="p">((</span><span class="n">comp</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span>
            <span class="n">comp</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">comp</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">]</span><span class="o">/</span><span class="n">a</span>
            <span class="k">if</span> <span class="n">k</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
                <span class="n">weights</span><span class="p">[</span><span class="n">i</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">a</span><span class="o">*</span><span class="n">weights</span><span class="p">[</span><span class="n">i</span><span class="p">,:]</span>
            <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
                <span class="n">comp_lr</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">,</span><span class="n">l</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">flux_ref</span><span class="o">/</span><span class="p">(</span><span class="n">sig_est</span><span class="p">[</span><span class="n">l</span><span class="p">]</span><span class="o">*</span><span class="n">flux_est</span><span class="p">[</span><span class="n">l</span><span class="p">]))</span><span class="o">*</span><span class="n">utils</span><span class="o">.</span><span class="n">decim</span><span class="p">(</span><span class="n">scisig</span><span class="o">.</span><span class="n">fftconvolve</span><span class="p">(</span><span class="n">comp</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">],</span><span class="n">shift_ker_stack</span><span class="p">[:,:,</span><span class="n">l</span><span class="p">],</span><span class="n">mode</span><span class="o">=</span><span class="s1">&#39;same&#39;</span><span class="p">),</span><span class="n">upfact</span><span class="p">,</span><span class="n">av_en</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="c1"># Weights update</span>
            <span class="k">if</span> <span class="n">k</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">dyn_upload</span><span class="p">:</span>
                    <span class="n">weights</span><span class="p">,</span><span class="n">min_val_map</span> <span class="o">=</span> <span class="n">non_unif_smoothing_mult_coeff_pos_cp_3</span><span class="p">(</span><span class="n">psf_stack</span><span class="p">,</span><span class="n">comp_lr</span><span class="p">[:,:,</span><span class="mi">0</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,:],</span><span class="n">comp</span><span class="p">[:,:,</span><span class="mi">0</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">],</span><span class="n">neigh</span><span class="p">,</span><span class="n">dist_weights_in</span><span class="p">,</span><span class="n">e_opt</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">],</span><span class="n">p_smth_mat_inv</span><span class="o">=</span><span class="n">p_smth_mat_inv</span><span class="p">,</span><span class="n">to</span><span class="o">=</span><span class="n">to</span><span class="p">,</span><span class="n">nb_iter</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span><span class="n">tol</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span><span class="n">pos_en</span><span class="o">=</span><span class="n">positivity_en</span><span class="p">)</span>
                    <span class="n">wold</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">w</span><span class="p">)</span>
                    <span class="n">w</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">weights</span><span class="p">[</span><span class="n">i</span><span class="p">,:])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">wold</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">w</span><span class="p">)</span>
                    <span class="n">w</span><span class="p">,</span><span class="n">min_val_map</span> <span class="o">=</span> <span class="n">non_unif_smoothing_mult_coeff_pos_cp_3</span><span class="p">(</span><span class="n">res</span><span class="p">,</span><span class="n">comp_lr</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,:],</span><span class="n">comp</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">],</span><span class="n">neigh</span><span class="p">,</span><span class="n">dist_weights_in</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">],</span><span class="n">e_opt</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">],</span><span class="n">p_smth_mat_inv</span><span class="o">=</span><span class="n">p_smth_mat_inv</span><span class="p">,</span><span class="n">to</span><span class="o">=</span><span class="n">to</span><span class="p">,</span><span class="n">nb_iter</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span><span class="n">tol</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span><span class="n">pos_en</span><span class="o">=</span><span class="n">positivity_en</span><span class="p">)</span>
                    <span class="n">w</span> <span class="o">=</span> <span class="n">w</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">],))</span>
                    <span class="n">weights</span><span class="p">[</span><span class="n">i</span><span class="p">,:]</span>  <span class="o">=</span><span class="n">copy</span><span class="p">(</span><span class="n">w</span><span class="p">)</span>
                <span class="c1">#if global_sparsity_en:</span>
                    <span class="c1">#weights,min_val_map = non_unif_smoothing_mult_coeff_pos_cp_4(psf_stack,comp_lr[:,:,0:i+1,:],comp[:,:,0:i+1],neigh,dist_weights_in,opt=opt,mr_file=mr_file,l1_norms,g_thresh_map_2,p_smth_mat_inv=p_smth_mat_inv,to=to,nb_iter=30,tol=0.1)</span>
                <span class="c1">#else:</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">dyn_upload</span><span class="p">:</span>
                    <span class="n">weights</span><span class="p">,</span><span class="n">min_val_map</span> <span class="o">=</span> <span class="n">non_unif_smoothing_mult_coeff_pos_cp_3</span><span class="p">(</span><span class="n">psf_stack</span><span class="p">,</span><span class="n">comp_lr</span><span class="p">[:,:,</span><span class="mi">0</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,:],</span><span class="n">comp</span><span class="p">[:,:,</span><span class="mi">0</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">],</span><span class="n">neigh</span><span class="p">,</span><span class="n">dist_weights_in</span><span class="p">,</span><span class="n">e_opt</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">],</span><span class="n">p_smth_mat_inv</span><span class="o">=</span><span class="n">p_smth_mat_inv</span><span class="p">,</span><span class="n">to</span><span class="o">=</span><span class="n">to</span><span class="p">,</span><span class="n">nb_iter</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span><span class="n">tol</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span><span class="n">Ainit</span><span class="o">=</span><span class="n">weights</span><span class="p">,</span><span class="n">pos_en</span><span class="o">=</span><span class="n">positivity_en</span><span class="p">)</span>
                    <span class="n">wold</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">w</span><span class="p">)</span>
                    <span class="n">w</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">weights</span><span class="p">[</span><span class="n">i</span><span class="p">,:])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">wold</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">w</span><span class="p">)</span>
                    <span class="n">w</span><span class="p">,</span><span class="n">min_val_map</span> <span class="o">=</span> <span class="n">non_unif_smoothing_mult_coeff_pos_cp_3</span><span class="p">(</span><span class="n">res</span><span class="p">,</span><span class="n">comp_lr</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,:],</span><span class="n">comp</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">],</span><span class="n">neigh</span><span class="p">,</span><span class="n">dist_weights_in</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">],</span><span class="n">e_opt</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">],</span><span class="n">p_smth_mat_inv</span><span class="o">=</span><span class="n">p_smth_mat_inv</span><span class="p">,</span><span class="n">to</span><span class="o">=</span><span class="n">to</span><span class="p">,</span><span class="n">nb_iter</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span><span class="n">tol</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span><span class="n">Ainit</span> <span class="o">=</span> <span class="n">weights</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,:],</span><span class="n">pos_en</span><span class="o">=</span><span class="n">positivity_en</span><span class="p">)</span>
                    <span class="n">w</span> <span class="o">=</span> <span class="n">w</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">],))</span>
                    <span class="n">weights</span><span class="p">[</span><span class="n">i</span><span class="p">,:]</span>  <span class="o">=</span><span class="n">copy</span><span class="p">(</span><span class="n">w</span><span class="p">)</span>

            <span class="n">im_hr</span> <span class="o">=</span> <span class="mi">0</span><span class="o">*</span><span class="n">im_hr</span>
            <span class="n">im_hr_dev</span> <span class="o">=</span> <span class="mi">0</span><span class="o">*</span><span class="n">im_hr_dev</span>
            <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
                <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">i</span><span class="p">):</span>
                    <span class="n">im_hr</span><span class="p">[:,:,</span><span class="n">l</span><span class="p">]</span> <span class="o">=</span> <span class="n">im_hr</span><span class="p">[:,:,</span><span class="n">l</span><span class="p">]</span><span class="o">+</span><span class="n">weights</span><span class="p">[</span><span class="n">p</span><span class="p">,</span><span class="n">l</span><span class="p">]</span><span class="o">*</span><span class="n">comp</span><span class="p">[:,:,</span><span class="n">p</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">i</span><span class="o">&gt;</span><span class="mi">1</span> <span class="ow">and</span> <span class="n">p</span><span class="o">&gt;</span><span class="mi">0</span> <span class="ow">and</span> <span class="n">p</span><span class="o">&lt;</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                        <span class="n">im_hr_dev</span><span class="p">[:,:,</span><span class="n">l</span><span class="p">]</span> <span class="o">=</span> <span class="n">im_hr_dev</span><span class="p">[:,:,</span><span class="n">l</span><span class="p">]</span><span class="o">+</span><span class="n">weights</span><span class="p">[</span><span class="n">p</span><span class="p">,</span><span class="n">l</span><span class="p">]</span><span class="o">*</span><span class="n">comp</span><span class="p">[:,:,</span><span class="n">p</span><span class="p">]</span>

        <span class="c1"># Residual update and HR images update</span>
        <span class="n">res_old_comp</span> <span class="o">=</span> <span class="n">cur_res_comp</span>
        <span class="n">cur_res_comp</span> <span class="o">=</span> <span class="n">cur_res</span>
        <span class="n">im_hr</span> <span class="o">=</span> <span class="mi">0</span><span class="o">*</span><span class="n">im_hr</span>
        <span class="n">im_hr_dev</span> <span class="o">=</span> <span class="mi">0</span><span class="o">*</span><span class="n">im_hr_dev</span>
        <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
            <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
                <span class="n">im_hr</span><span class="p">[:,:,</span><span class="n">l</span><span class="p">]</span> <span class="o">=</span> <span class="n">im_hr</span><span class="p">[:,:,</span><span class="n">l</span><span class="p">]</span><span class="o">+</span><span class="n">weights</span><span class="p">[</span><span class="n">p</span><span class="p">,</span><span class="n">l</span><span class="p">]</span><span class="o">*</span><span class="n">comp</span><span class="p">[:,:,</span><span class="n">p</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">p</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
                    <span class="n">im_hr_dev</span><span class="p">[:,:,</span><span class="n">l</span><span class="p">]</span> <span class="o">=</span> <span class="n">im_hr_dev</span><span class="p">[:,:,</span><span class="n">l</span><span class="p">]</span><span class="o">+</span><span class="n">weights</span><span class="p">[</span><span class="n">p</span><span class="p">,</span><span class="n">l</span><span class="p">]</span><span class="o">*</span><span class="n">comp</span><span class="p">[:,:,</span><span class="n">p</span><span class="p">]</span>
            <span class="n">res</span><span class="p">[:,:,</span><span class="n">l</span><span class="p">]</span> <span class="o">=</span> <span class="n">psf_stack</span><span class="p">[:,:,</span><span class="n">l</span><span class="p">]</span><span class="o">-</span><span class="p">(</span><span class="n">flux_ref</span><span class="o">/</span><span class="p">(</span><span class="n">sig_est</span><span class="p">[</span><span class="n">l</span><span class="p">]</span><span class="o">*</span><span class="n">flux_est</span><span class="p">[</span><span class="n">l</span><span class="p">]))</span><span class="o">*</span><span class="n">utils</span><span class="o">.</span><span class="n">decim</span><span class="p">(</span><span class="n">scisig</span><span class="o">.</span><span class="n">fftconvolve</span><span class="p">(</span><span class="n">im_hr</span><span class="p">[:,:,</span><span class="n">l</span><span class="p">],</span><span class="n">shift_ker_stack</span><span class="p">[:,:,</span><span class="n">l</span><span class="p">],</span><span class="n">mode</span><span class="o">=</span><span class="s1">&#39;same&#39;</span><span class="p">),</span><span class="n">upfact</span><span class="p">,</span><span class="n">av_en</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="n">compz1</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">z1</span>
        <span class="n">compz2</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">z2</span>

        <span class="c1"># Optim variables resetting</span>
        <span class="n">z1</span> <span class="o">=</span> <span class="n">z1</span><span class="o">*</span><span class="mi">0</span>
        <span class="n">z2</span> <span class="o">=</span> <span class="n">z2</span><span class="o">*</span><span class="mi">0</span>
        <span class="k">if</span> <span class="n">sparsity_en</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">pix_sparsity</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">True</span><span class="p">:</span>
                <span class="n">thresh_save</span><span class="p">[:,:,:,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">thresh_map</span><span class="o">/</span><span class="n">muj</span>
                <span class="n">i1</span><span class="p">,</span><span class="n">i2</span><span class="p">,</span><span class="n">i3</span> <span class="o">=</span> <span class="n">where</span><span class="p">(</span><span class="n">weights_sp</span><span class="o">!=</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">weights_sp</span><span class="p">[</span><span class="n">i1</span><span class="p">,</span><span class="n">i2</span><span class="p">,</span><span class="n">i3</span><span class="p">]</span><span class="o">=</span><span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">thresh_save</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">thresh_map</span><span class="o">/</span><span class="n">muj</span>
                <span class="n">i1</span><span class="p">,</span><span class="n">i2</span> <span class="o">=</span> <span class="n">where</span><span class="p">(</span><span class="n">weights_sp</span><span class="o">!=</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">weights_sp</span><span class="p">[</span><span class="n">i1</span><span class="p">,</span><span class="n">i2</span><span class="p">]</span><span class="o">=</span><span class="mi">1</span>
            <span class="n">thresh_map</span> <span class="o">=</span> <span class="mi">0</span><span class="o">*</span><span class="n">thresh_map</span>
            <span class="n">i1</span><span class="p">,</span><span class="n">i2</span><span class="p">,</span><span class="n">i3</span><span class="p">,</span><span class="n">i4</span> <span class="o">=</span> <span class="n">where</span><span class="p">(</span><span class="n">g_weights_sp</span><span class="p">[:,:,:</span><span class="o">-</span><span class="mi">1</span><span class="p">,:]</span><span class="o">!=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">g_weights_sp</span><span class="p">[</span><span class="n">i1</span><span class="p">,</span><span class="n">i2</span><span class="p">,</span><span class="n">i3</span><span class="p">]</span><span class="o">=</span><span class="mi">1</span>
            <span class="n">g_thresh_map</span> <span class="o">=</span> <span class="mi">0</span><span class="o">*</span><span class="n">g_thresh_map</span>

        <span class="c1"># Residual check</span>
        <span class="k">if</span> <span class="n">res_check_en</span><span class="p">:</span>
            <span class="n">detect_flag</span><span class="p">,</span><span class="n">score_res</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">autocorrel_detection_stack</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>
            <span class="nb">print</span> <span class="s2">&quot;residual score: &quot;</span><span class="p">,</span><span class="n">score_res</span>
        <span class="n">i</span><span class="o">+=</span><span class="mi">1</span>
    <span class="k">if</span> <span class="n">nsig</span><span class="o">==</span><span class="mi">0</span> <span class="ow">or</span> <span class="n">sparsity_en</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
        <span class="nb">print</span> <span class="s2">&quot;Warning: no sparsity constraint&quot;</span>

    <span class="c1"># Refining</span>

    <span class="k">if</span> <span class="n">refine</span><span class="p">:</span>
        <span class="n">ainit</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">positivity_en</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">input_ref</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="n">input_ref</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">copy</span><span class="p">(</span><span class="n">comp</span><span class="p">[:,:,</span><span class="mi">0</span><span class="p">:</span><span class="n">i</span><span class="p">]))</span>
        <span class="n">input_ref</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">upfact</span><span class="p">)</span>
        <span class="n">input_ref</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">shift_ker_stack</span><span class="p">)</span>
        <span class="n">input_ref</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">shift_ker_stack_adj</span><span class="p">)</span>
        <span class="n">input_ref</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">weights</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">i</span><span class="p">,:])</span>
        <span class="n">ref_weights</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">weights</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">i</span><span class="p">,:])</span>
        <span class="n">input_ref</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sig_est</span><span class="p">)</span>
        <span class="n">input_ref</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">flux_est</span><span class="p">)</span>
        <span class="n">survivors</span> <span class="o">=</span> <span class="n">ones</span><span class="p">((</span><span class="n">i</span><span class="p">,))</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_iter</span><span class="p">):</span>
            <span class="c1"># Sources estimation</span>
            <span class="k">if</span> <span class="n">robust_refine</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">True</span><span class="p">:</span>
                <span class="n">ref_comp</span> <span class="o">=</span> <span class="n">low_rank_global_src_est_cp</span><span class="p">(</span><span class="n">input_ref</span><span class="p">,</span><span class="n">thresh_save</span><span class="p">[:,:,</span><span class="mi">0</span><span class="p">:</span><span class="n">i</span><span class="p">]</span><span class="o">/</span><span class="n">survivors</span><span class="o">.</span><span class="n">sum</span><span class="p">(),</span><span class="n">psf_stack</span><span class="p">,</span><span class="n">eps</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span><span class="n">ainit</span><span class="o">=</span><span class="n">ainit</span><span class="p">,</span><span class="n">nb_iter</span><span class="o">=</span><span class="n">nb_subiter</span><span class="p">,</span><span class="n">tol</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ref_comp</span> <span class="o">=</span> <span class="n">robust_low_rank_global_src_est_cp</span><span class="p">(</span><span class="n">input_ref</span><span class="p">,</span><span class="n">thresh_save</span><span class="p">[:,:,</span><span class="mi">0</span><span class="p">:</span><span class="n">i</span><span class="p">]</span><span class="o">/</span><span class="n">survivors</span><span class="o">.</span><span class="n">sum</span><span class="p">(),</span><span class="n">psf_stack</span><span class="p">,</span><span class="n">eps</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span><span class="n">ainit</span><span class="o">=</span><span class="n">ainit</span><span class="p">,</span><span class="n">nb_iter</span><span class="o">=</span><span class="n">nb_subiter</span><span class="p">,</span><span class="n">tol</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">sig_im</span><span class="o">=</span><span class="n">sig_min_vect</span><span class="p">,</span><span class="n">nsig</span><span class="o">=</span><span class="n">nsig_hub</span><span class="p">)</span>
            <span class="n">survivors</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">i</span><span class="p">,))</span>
            <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">i</span><span class="p">):</span>
                <span class="n">a</span> <span class="o">=</span> <span class="n">sqrt</span><span class="p">((</span><span class="n">ref_comp</span><span class="p">[:,:,</span><span class="n">l</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span>
                <span class="k">if</span> <span class="n">a</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
                    <span class="n">survivors</span><span class="p">[</span><span class="n">l</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
                    <span class="n">ref_comp</span><span class="p">[:,:,</span><span class="n">l</span><span class="p">]</span> <span class="o">/=</span> <span class="n">a</span>

                <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
                    <span class="n">comp_lr</span><span class="p">[:,:,</span><span class="n">l</span><span class="p">,</span><span class="n">p</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">flux_ref</span><span class="o">/</span><span class="p">(</span><span class="n">sig_est</span><span class="p">[</span><span class="n">p</span><span class="p">]</span><span class="o">*</span><span class="n">flux_est</span><span class="p">[</span><span class="n">p</span><span class="p">]))</span><span class="o">*</span><span class="n">utils</span><span class="o">.</span><span class="n">decim</span><span class="p">(</span><span class="n">scisig</span><span class="o">.</span><span class="n">fftconvolve</span><span class="p">(</span><span class="n">ref_comp</span><span class="p">[:,:,</span><span class="n">l</span><span class="p">],</span><span class="n">shift_ker_stack</span><span class="p">[:,:,</span><span class="n">p</span><span class="p">],</span><span class="n">mode</span><span class="o">=</span><span class="s1">&#39;same&#39;</span><span class="p">),</span><span class="n">upfact</span><span class="p">,</span><span class="n">av_en</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

            <span class="n">id0</span> <span class="o">=</span> <span class="n">where</span><span class="p">((</span><span class="n">survivors</span><span class="o">==</span><span class="mi">1</span><span class="p">))</span>
            <span class="nb">id</span> <span class="o">=</span> <span class="n">id0</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="c1"># Weights estimation</span>
            <span class="n">ref_weights</span> <span class="o">*=</span> <span class="mi">0</span>
            <span class="nb">print</span> <span class="nb">type</span><span class="p">(</span><span class="n">p_smth_mat_inv</span><span class="p">)</span>
            <span class="n">ref_weights_k</span><span class="p">,</span><span class="n">min_val_map</span> <span class="o">=</span> <span class="n">non_unif_smoothing_mult_coeff_pos_cp_3</span><span class="p">(</span><span class="n">psf_stack</span><span class="p">,</span><span class="n">comp_lr</span><span class="p">[:,:,</span><span class="nb">id</span><span class="p">,:],</span><span class="n">ref_comp</span><span class="p">[:,:,</span><span class="nb">id</span><span class="p">],</span><span class="n">neigh</span><span class="p">,</span><span class="n">dist_weights_in</span><span class="p">[:,:,</span><span class="nb">id</span><span class="p">],</span><span class="n">e_opt</span><span class="p">[</span><span class="nb">id</span><span class="p">],</span><span class="n">p_smth_mat_inv</span><span class="o">=</span><span class="n">p_smth_mat_inv</span><span class="p">,</span><span class="n">to</span><span class="o">=</span><span class="n">to</span><span class="p">,</span><span class="n">nb_iter</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span><span class="n">tol</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span><span class="n">Ainit</span><span class="o">=</span><span class="n">ref_weights</span><span class="p">[</span><span class="nb">id</span><span class="p">,:],</span><span class="n">pos_en</span><span class="o">=</span><span class="n">positivity_en</span><span class="p">)</span>
            <span class="n">ref_weights</span><span class="p">[</span><span class="nb">id</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">ref_weights_k</span>
            <span class="n">input_ref</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">ref_comp</span>
            <span class="n">input_ref</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">ref_weights</span>

        <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
            <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">i</span><span class="p">):</span>
                <span class="n">ref_im_hr</span><span class="p">[:,:,</span><span class="n">l</span><span class="p">]</span> <span class="o">=</span> <span class="n">ref_im_hr</span><span class="p">[:,:,</span><span class="n">l</span><span class="p">]</span><span class="o">+</span><span class="n">ref_weights</span><span class="p">[</span><span class="n">p</span><span class="p">,</span><span class="n">l</span><span class="p">]</span><span class="o">*</span><span class="n">ref_comp</span><span class="p">[:,:,</span><span class="n">p</span><span class="p">]</span>
            <span class="n">ref_res</span><span class="p">[:,:,</span><span class="n">l</span><span class="p">]</span> <span class="o">=</span> <span class="n">psf_stack</span><span class="p">[:,:,</span><span class="n">l</span><span class="p">]</span><span class="o">-</span><span class="p">(</span><span class="n">flux_ref</span><span class="o">/</span><span class="p">(</span><span class="n">sig_est</span><span class="p">[</span><span class="n">l</span><span class="p">]</span><span class="o">*</span><span class="n">flux_est</span><span class="p">[</span><span class="n">l</span><span class="p">]))</span><span class="o">*</span><span class="n">utils</span><span class="o">.</span><span class="n">decim</span><span class="p">(</span><span class="n">scisig</span><span class="o">.</span><span class="n">fftconvolve</span><span class="p">(</span><span class="n">ref_im_hr</span><span class="p">[:,:,</span><span class="n">l</span><span class="p">],</span><span class="n">shift_ker_stack</span><span class="p">[:,:,</span><span class="n">l</span><span class="p">],</span><span class="n">mode</span><span class="o">=</span><span class="s1">&#39;same&#39;</span><span class="p">),</span><span class="n">upfact</span><span class="p">,</span><span class="n">av_en</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">tracking_en</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">im_hr</span><span class="p">,</span><span class="n">ref_im_hr</span><span class="p">,</span><span class="n">comp</span><span class="p">,</span><span class="n">ref_comp</span><span class="p">,</span><span class="n">weights</span><span class="p">,</span><span class="n">ref_weights</span><span class="p">,</span><span class="n">res</span><span class="p">,</span><span class="n">ref_res</span><span class="p">,</span><span class="n">sig_est</span><span class="o">*</span><span class="n">sig_min</span><span class="p">,</span><span class="n">flux_est</span><span class="p">,</span><span class="n">shifts</span><span class="p">,</span><span class="n">compz1</span><span class="p">,</span><span class="n">compz2</span><span class="p">,</span><span class="n">res_inter_comp</span><span class="p">,</span><span class="n">detect_flag</span><span class="p">,</span><span class="n">comp_tracking</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">im_hr</span><span class="p">,</span><span class="n">ref_im_hr</span><span class="p">,</span><span class="n">comp</span><span class="p">,</span><span class="n">ref_comp</span><span class="p">,</span><span class="n">weights</span><span class="p">,</span><span class="n">ref_weights</span><span class="p">,</span><span class="n">res</span><span class="p">,</span><span class="n">ref_res</span><span class="p">,</span><span class="n">sig_est</span><span class="o">*</span><span class="n">sig_min</span><span class="p">,</span><span class="n">flux_est</span><span class="p">,</span><span class="n">shifts</span><span class="p">,</span><span class="n">compz1</span><span class="p">,</span><span class="n">compz2</span><span class="p">,</span><span class="n">res_inter_comp</span><span class="p">,</span><span class="n">detect_flag</span>

<span class="k">def</span> <span class="nf">low_rank_comp_wise_sparse_dist_dyn_coeff_GFB_joint</span><span class="p">(</span><span class="n">psf_stack_in</span><span class="p">,</span><span class="n">field_dist</span><span class="p">,</span><span class="n">upfact</span><span class="p">,</span><span class="n">opt</span><span class="p">,</span><span class="n">nsig</span><span class="p">,</span><span class="n">global_sparsity_en</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">sr_en</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">sparsity_en</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">pix_sparsity</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">redun_fact</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span><span class="n">neigh_frac</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span><span class="n">dist_weight_deg</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">shifts</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">opt_shift_est</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">nsig_shift_est</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span><span class="n">sig_est</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">flux_est</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">nb_iter</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span><span class="n">nb_subiter</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span><span class="n">nb_subiter_min</span><span class="o">=</span><span class="mi">7</span><span class="p">,</span><span class="n">mu</span><span class="o">=</span><span class="mf">1.5</span><span class="p">,</span><span class="n">nb_comp_max</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span><span class="n">tol</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span><span class="n">wvl_transp_cor</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">cv_proof_en</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">line_search_en</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">cond_fact</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span><span class="n">pos_relax</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_subiter_min_2</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span><span class="n">dyn_upload</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">positivity_en</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">score</span><span class="o">=</span><span class="mi">90</span><span class="p">,</span><span class="n">refine</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">robust_refine</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">nsig_hub</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span><span class="n">res_check_en</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">tracking_en</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">nb_rw</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">lsq_en</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">shifts_regist</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span><span class="n">wavr_en</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">curv</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>

    <span class="k">if</span> <span class="n">wavr_en</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
        <span class="n">curv</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">psf_stack</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">psf_stack_in</span><span class="p">)</span>
    <span class="n">shap</span> <span class="o">=</span> <span class="n">psf_stack</span><span class="o">.</span><span class="n">shape</span>
    <span class="k">if</span> <span class="n">nb_comp_max</span><span class="o">&gt;</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]:</span>
        <span class="nb">print</span> <span class="s2">&quot;/!\ Warning: number of components higher than the number of images; reduced to &quot;</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">siz_in</span> <span class="o">=</span> <span class="n">upfact</span><span class="o">*</span><span class="n">array</span><span class="p">(</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
    <span class="nb">print</span> <span class="s2">&quot;Minimiser: GFB&quot;</span>
    <span class="k">if</span> <span class="n">sparsity_en</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
        <span class="nb">print</span> <span class="s2">&quot;----- Sparsity disable -----&quot;</span>
    <span class="c1"># Degradation operator parameters estimation</span>
    <span class="n">centroids</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">sig_est</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="nb">print</span> <span class="s1">&#39;Noise level estimation...&#39;</span>
        <span class="n">sig_est</span><span class="p">,</span><span class="n">filters_lr</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">im_gauss_nois_est_cube</span><span class="p">(</span><span class="n">psf_stack_in</span><span class="p">,</span><span class="n">opt</span><span class="o">=</span><span class="n">opt_shift_est</span><span class="p">)</span>
        <span class="nb">print</span> <span class="s1">&#39;Done.&#39;</span>
    <span class="k">if</span> <span class="n">shifts_regist</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">shifts</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="nb">map</span> <span class="o">=</span> <span class="n">ones</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
                <span class="n">nsig_shifts</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">nsig_shift_est</span><span class="p">,</span><span class="mf">0.8</span><span class="o">*</span><span class="n">psf_stack_in</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">/</span><span class="n">sig_est</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                <span class="nb">map</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">]</span> <span class="o">*=</span> <span class="n">nsig_shifts</span><span class="o">*</span><span class="n">sig_est</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="nb">print</span> <span class="s1">&#39;Shifts estimation...&#39;</span>
            <span class="n">psf_stack_shift</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">thresholding_3D</span><span class="p">(</span><span class="n">psf_stack_in</span><span class="p">,</span><span class="nb">map</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">shifts</span><span class="p">,</span><span class="n">centroids</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">shift_est</span><span class="p">(</span><span class="n">psf_stack_shift</span><span class="p">)</span>
            <span class="nb">print</span> <span class="s1">&#39;Done.&#39;</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span> <span class="s2">&quot;------------ /!\ Warning: shifts provided /!\ ---------&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span> <span class="s2">&quot;------------ /!\ Warning: no registration /!\ ---------&quot;</span>
        <span class="n">shifts</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="mi">2</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">flux_est</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">flux_est</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">flux_estimate_stack</span><span class="p">(</span><span class="n">psf_stack</span><span class="p">,</span><span class="n">rad</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
    <span class="n">flux_ref</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">flux_est</span><span class="p">)</span>

    <span class="c1">#shifts = utils.wvl_shift_est(psf_stack,opt_shift_est,nsig_shift_est)*upfact</span>
    <span class="n">shift_ker_stack</span><span class="p">,</span><span class="n">shift_ker_stack_adj</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">shift_ker_stack</span><span class="p">(</span><span class="n">shifts</span><span class="p">,</span><span class="n">upfact</span><span class="p">)</span>
    <span class="n">sig_min</span> <span class="o">=</span> <span class="n">sig_est</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
    <span class="n">sig_min_vect</span> <span class="o">=</span> <span class="n">ones</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">],))</span><span class="o">*</span><span class="n">sig_min</span>
    <span class="n">sig_est</span> <span class="o">=</span> <span class="n">sig_est</span><span class="o">/</span><span class="n">sig_min</span>
    <span class="n">muj</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">nb_im</span> <span class="o">=</span> <span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
        <span class="n">psf_stack</span><span class="p">[:,:,</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">psf_stack</span><span class="p">[:,:,</span><span class="n">k</span><span class="p">]</span><span class="o">/</span><span class="n">sig_est</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
    <span class="nb">print</span> <span class="s2">&quot; ------ ref energy: &quot;</span><span class="p">,(</span><span class="n">psf_stack</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(),</span><span class="s2">&quot; ------- &quot;</span>

    <span class="nb">print</span> <span class="s2">&quot;flux min: &quot;</span><span class="p">,</span><span class="n">flux_est</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span><span class="s2">&quot; flux max: &quot;</span><span class="p">,</span><span class="n">flux_est</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span><span class="s2">&quot;sig min: &quot;</span><span class="p">,</span><span class="n">sig_est</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span><span class="s2">&quot; sig max: &quot;</span><span class="p">,</span><span class="n">sig_est</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
    <span class="n">weights</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">ref_weights</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">dyn_upload</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
        <span class="n">weights</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">nb_comp_max</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>
    <span class="n">w</span> <span class="o">=</span> <span class="n">ones</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">],))</span>
    <span class="n">im_hr</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">upfact</span><span class="o">*</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">upfact</span><span class="o">*</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>
    <span class="n">ref_im_hr</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">upfact</span><span class="o">*</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">upfact</span><span class="o">*</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>
    <span class="c1"># Distances settings</span>
    <span class="nb">print</span> <span class="s2">&quot;Contructing PSF tree...&quot;</span>
    <span class="c1">#nb_neighs = redun_fact*upfact**2</span>
    <span class="n">nb_neighs</span> <span class="o">=</span> <span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span>
    <span class="n">neigh</span><span class="p">,</span><span class="n">dists</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">knn_interf</span><span class="p">(</span><span class="n">field_dist</span><span class="p">,</span><span class="n">nb_neighs</span><span class="p">)</span>
    <span class="n">p_max</span> <span class="o">=</span> <span class="n">pow_law_select</span><span class="p">(</span><span class="n">dists</span><span class="p">,</span><span class="n">nb_neighs</span><span class="p">)</span>
    <span class="nb">print</span> <span class="s2">&quot;power max = &quot;</span><span class="p">,</span><span class="n">p_max</span>
    <span class="n">p_min</span> <span class="o">=</span> <span class="mf">0.01</span>
    <span class="nb">print</span> <span class="s2">&quot;Done...&quot;</span>
    <span class="n">e_min</span> <span class="o">=</span> <span class="mf">0.01</span>
    <span class="n">e_max</span> <span class="o">=</span> <span class="mf">1.99</span>
    <span class="n">nb_samp_opt</span> <span class="o">=</span> <span class="n">nb_comp_max</span><span class="o">*</span><span class="mi">10</span>
    <span class="n">dists_unsorted</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">feat_dist_mat</span><span class="p">(</span><span class="n">field_dist</span><span class="p">)</span>
    <span class="n">dist_med</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">dists</span><span class="p">)</span>
    <span class="n">dist_weights</span> <span class="o">=</span> <span class="p">(</span><span class="n">dist_med</span><span class="o">/</span><span class="n">dists_unsorted</span><span class="p">)</span><span class="o">**</span><span class="n">dist_weight_deg</span>
    <span class="c1">#dist_weights = (dist_med/dists)**dist_weight_deg</span>
    <span class="n">dist_weigths</span> <span class="o">=</span> <span class="n">dist_weights</span><span class="o">/</span><span class="n">dist_weights</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
    <span class="c1"># Spatial smoothing operator gradient lip constant estimation</span>
    <span class="n">spec_rad_smooth</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">siz_in</span> <span class="o">=</span> <span class="n">upfact</span><span class="o">*</span><span class="n">array</span><span class="p">(</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">eig_max</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="c1"># GFB variables</span>
    <span class="nb">input</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">upfact</span><span class="o">*</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">upfact</span><span class="o">*</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
    <span class="nb">input</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="nb">input</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">upfact</span><span class="p">)</span>
    <span class="nb">input</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">shift_ker_stack</span><span class="p">)</span>
    <span class="nb">input</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">shift_ker_stack_adj</span><span class="p">)</span>
    <span class="n">w</span> <span class="o">=</span> <span class="n">ones</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">],))</span>
    <span class="n">w_old</span> <span class="o">=</span> <span class="n">ones</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">],))</span>
    <span class="n">l1_norms</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">],))</span>
    <span class="n">im_hr</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">upfact</span><span class="o">*</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">upfact</span><span class="o">*</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>
    <span class="n">im_hr_curv</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">upfact</span><span class="o">*</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">upfact</span><span class="o">*</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>
    <span class="n">im_hr_dev</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">upfact</span><span class="o">*</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">upfact</span><span class="o">*</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>
    <span class="nb">input</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">w</span><span class="p">)</span>
    <span class="nb">input</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sig_est</span><span class="p">)</span>
    <span class="nb">input</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">flux_est</span><span class="p">)</span>
    <span class="n">comp</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">upfact</span><span class="o">*</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">upfact</span><span class="o">*</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">nb_comp_max</span><span class="p">))</span> <span class="c1"># Main variable</span>
    <span class="n">comp_curl</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">upfact</span><span class="o">*</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">upfact</span><span class="o">*</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">nb_comp_max</span><span class="p">))</span>
    <span class="n">ref_comp</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">comp_old</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">upfact</span><span class="o">*</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">upfact</span><span class="o">*</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
    <span class="n">z1</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">upfact</span><span class="o">*</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">upfact</span><span class="o">*</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span> <span class="c1"># Sparse variable</span>
    <span class="n">z2</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">upfact</span><span class="o">*</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">upfact</span><span class="o">*</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span> <span class="c1"># Positive variable</span>
    <span class="n">compz1</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">upfact</span><span class="o">*</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">upfact</span><span class="o">*</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">nb_comp_max</span><span class="p">))</span> <span class="c1"># Main variable</span>
    <span class="n">compz2</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">upfact</span><span class="o">*</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">upfact</span><span class="o">*</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">nb_comp_max</span><span class="p">))</span> <span class="c1"># Main variable</span>
    <span class="n">min_val_map</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">upfact</span><span class="o">*</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">upfact</span><span class="o">*</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
    <span class="n">res_inter_comp</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">nb_comp_max</span><span class="p">,))</span>
    <span class="n">coeff_init</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">w1</span> <span class="o">=</span> <span class="mf">0.5</span>
    <span class="n">w2</span> <span class="o">=</span> <span class="mf">0.5</span>
    <span class="k">if</span> <span class="n">positivity_en</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">True</span> <span class="p">:</span>
        <span class="n">w2</span><span class="o">=</span><span class="mi">0</span>
        <span class="n">w1</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="n">lambd</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">grad</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">upfact</span><span class="o">*</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">upfact</span><span class="o">*</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
    <span class="n">u</span><span class="p">,</span><span class="n">mr_file</span> <span class="o">=</span> <span class="n">isap</span><span class="o">.</span><span class="n">mr_trans</span><span class="p">(</span><span class="n">comp</span><span class="p">[:,:,</span><span class="mi">0</span><span class="p">],</span><span class="n">opt</span><span class="o">=</span><span class="n">opt</span><span class="p">)</span>
    <span class="n">shap2</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">weights_sp</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">pix_sparsity</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">weights_sp</span> <span class="o">=</span> <span class="n">ones</span><span class="p">((</span><span class="n">shap2</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">shap2</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">shap2</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">weights_sp</span> <span class="o">=</span> <span class="n">ones</span><span class="p">((</span><span class="n">upfact</span><span class="o">*</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">upfact</span><span class="o">*</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
    <span class="n">thresh_save</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">pix_sparsity</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">thresh_save</span> <span class="o">=</span> <span class="n">ones</span><span class="p">((</span><span class="n">shap2</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">shap2</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">shap2</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">nb_comp_max</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">thresh_save</span> <span class="o">=</span> <span class="n">ones</span><span class="p">((</span><span class="n">upfact</span><span class="o">*</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">upfact</span><span class="o">*</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">nb_comp_max</span><span class="p">))</span>
    <span class="n">g_weights_sp</span> <span class="o">=</span> <span class="n">ones</span><span class="p">((</span><span class="n">shap2</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">shap2</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">shap2</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>
    <span class="n">g_weights_sp_2</span> <span class="o">=</span> <span class="n">ones</span><span class="p">((</span><span class="n">shap2</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">shap2</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">shap2</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>
    <span class="n">g_weights_sp</span><span class="p">[:,:,</span><span class="n">shap2</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">,:]</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">dev</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">g_weights_sp</span><span class="p">)</span><span class="o">*</span><span class="mi">0</span>
    <span class="n">thresh_map</span> <span class="o">=</span> <span class="n">weights_sp</span><span class="o">*</span><span class="mi">0</span>
    <span class="n">g_thresh_map</span> <span class="o">=</span> <span class="n">g_weights_sp</span><span class="o">*</span><span class="mi">0</span>
    <span class="n">g_thresh_map_2</span> <span class="o">=</span> <span class="n">g_weights_sp</span><span class="o">*</span><span class="mi">0</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">psf_stack</span><span class="p">)</span>
    <span class="n">ref_res</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">psf_stack</span><span class="p">)</span><span class="o">*</span><span class="mi">0</span>
    <span class="n">comp_lr</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">nb_comp_max</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>
    <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">buff</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">nb_subiter_min</span><span class="p">))</span>
    <span class="n">nb_iter_noisest</span> <span class="o">=</span> <span class="mi">20</span>
    <span class="n">nb_subiter_prox</span> <span class="o">=</span> <span class="mi">50</span>
    <span class="n">thresh_type</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">noise_vect_1</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">sig_map</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">cur_res</span><span class="o">=</span><span class="mf">100000000.0</span>
    <span class="n">res_old</span><span class="o">=</span><span class="mf">1000000000.0</span>
    <span class="n">cur_res_comp</span><span class="o">=</span><span class="mf">100000000.0</span>
    <span class="n">res_old_comp</span><span class="o">=</span><span class="mf">1000000000.0</span>
    <span class="n">to</span><span class="o">=</span><span class="kc">None</span>
    <span class="n">weights_init</span><span class="o">=</span><span class="kc">None</span>
    <span class="n">p_smth_mat_inv</span><span class="o">=</span><span class="kc">None</span>
    <span class="nb">print</span> <span class="s2">&quot; ------ ref energy: &quot;</span><span class="p">,(</span><span class="n">psf_stack</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(),</span><span class="s2">&quot; ------- &quot;</span>
    <span class="n">pows</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">e_opt</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">e_range</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">p_range</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">lsq_en</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">True</span> <span class="ow">and</span> <span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">&gt;</span><span class="mi">2</span><span class="p">:</span>
        <span class="n">pows</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">nb_comp_max</span><span class="p">))</span>
        <span class="n">e_opt</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">nb_comp_max</span><span class="p">))</span>
        <span class="n">e_range</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">log_sampling</span><span class="p">(</span><span class="n">e_min</span><span class="p">,</span><span class="n">e_max</span><span class="p">,</span><span class="n">nb_samp_opt</span><span class="p">)</span>
        <span class="n">p_range</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">log_sampling</span><span class="p">(</span><span class="n">p_min</span><span class="p">,</span><span class="n">p_max</span><span class="p">,</span><span class="n">nb_samp_opt</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">==</span><span class="mi">2</span><span class="p">:</span>
        <span class="nb">print</span> <span class="s2">&quot;Number of sources insufficient to use the spatial constraint; activating the lsq&quot;</span>
        <span class="n">lsq_en</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">score_res</span> <span class="o">=</span> <span class="mi">100</span>
    <span class="n">detect_flag</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">thresh_max</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">comp_tracking</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">upfact</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">upfact</span><span class="p">,</span><span class="n">nb_comp_max</span><span class="p">,</span><span class="n">nb_subiter</span><span class="p">))</span>
    <span class="c1"># Weights init</span>
    <span class="n">p_opt</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">comp_temp</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">data</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">ker</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">alph_ref</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">alph</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">cube_est</span> <span class="o">=</span>  <span class="kc">None</span>
    <span class="k">if</span> <span class="n">lsq_en</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">shifts_regist</span><span class="p">:</span>
            <span class="n">weights</span><span class="p">,</span><span class="n">coeff_res</span><span class="p">,</span><span class="n">cube_est</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">cube_svd</span><span class="p">(</span><span class="n">utils</span><span class="o">.</span><span class="n">rect_crop_c</span><span class="p">(</span><span class="n">res</span><span class="p">,</span><span class="nb">int</span><span class="p">(</span><span class="mf">0.9</span><span class="o">*</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span><span class="nb">int</span><span class="p">(</span><span class="mf">0.9</span><span class="o">*</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span><span class="n">centroids</span><span class="p">),</span><span class="n">nb_comp</span><span class="o">=</span><span class="n">nb_comp_max</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">weights</span><span class="p">,</span><span class="n">coeff_res</span><span class="p">,</span><span class="n">cube_est</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">cube_svd</span><span class="p">(</span><span class="n">res</span><span class="p">,</span><span class="n">nb_comp</span><span class="o">=</span><span class="n">nb_comp_max</span><span class="p">)</span>
        <span class="c1">#coeff_res,comp_res,est = utils.cube_svd(res)</span>
        <span class="n">weights</span> <span class="o">=</span> <span class="n">weights</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">nb_comp_max</span><span class="p">,:]</span>
        <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_comp_max</span><span class="p">):</span>
            <span class="n">a</span> <span class="o">=</span> <span class="n">sqrt</span><span class="p">((</span><span class="n">weights</span><span class="p">[</span><span class="n">l</span><span class="p">,:]</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span>
            <span class="k">if</span> <span class="n">a</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
                <span class="n">weights</span><span class="p">[</span><span class="n">l</span><span class="p">,:]</span> <span class="o">/=</span> <span class="n">a</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">shifts_regist</span><span class="p">:</span>
            <span class="n">e_opt</span><span class="p">,</span><span class="n">p_opt</span><span class="p">,</span><span class="n">weights</span><span class="p">,</span><span class="n">comp_temp</span><span class="p">,</span><span class="n">data</span><span class="p">,</span><span class="n">ker</span><span class="p">,</span><span class="n">alph_ref</span>  <span class="o">=</span> <span class="n">analysis</span><span class="p">(</span><span class="n">utils</span><span class="o">.</span><span class="n">rect_crop_c</span><span class="p">(</span><span class="n">res</span><span class="p">,</span><span class="nb">int</span><span class="p">(</span><span class="mf">0.9</span><span class="o">*</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span><span class="nb">int</span><span class="p">(</span><span class="mf">0.9</span><span class="o">*</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span><span class="n">centroids</span><span class="p">),</span><span class="nb">int</span><span class="p">(</span><span class="mf">0.9</span><span class="o">*</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">*</span><span class="nb">int</span><span class="p">(</span><span class="mf">0.9</span><span class="o">*</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">*</span><span class="n">sig_min</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span><span class="n">field_dist</span><span class="p">,</span><span class="n">tol</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_max</span><span class="o">=</span><span class="n">nb_comp_max</span><span class="p">)</span>
            <span class="c1">#if wavr_en:</span>
            <span class="c1">#weights,coeff_res,est = utils.cube_svd(utils.rect_crop_c(res,int(0.9*shap[0]),int(0.9*shap[1]),centroids),nb_comp=nb_comp_max)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">e_opt</span><span class="p">,</span><span class="n">p_opt</span><span class="p">,</span><span class="n">weights</span><span class="p">,</span><span class="n">comp_temp</span><span class="p">,</span><span class="n">data</span><span class="p">,</span><span class="n">ker</span><span class="p">,</span><span class="n">alph_ref</span>  <span class="o">=</span> <span class="n">analysis</span><span class="p">(</span><span class="n">res</span><span class="p">,</span><span class="n">nb_im</span><span class="o">*</span><span class="nb">int</span><span class="p">(</span><span class="mf">0.9</span><span class="o">*</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">*</span><span class="nb">int</span><span class="p">(</span><span class="mf">0.9</span><span class="o">*</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">*</span><span class="n">sig_min</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span><span class="n">field_dist</span><span class="p">,</span><span class="n">tol</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_max</span><span class="o">=</span><span class="n">nb_comp_max</span><span class="p">)</span>
            <span class="c1">#if wavr_en:</span>
            <span class="c1">#weights,coeff_res,cube_est = utils.cube_svd(res,nb_comp=nb_comp_max)</span>

        <span class="n">alph</span> <span class="o">=</span> <span class="n">alph_ref</span>
        <span class="nb">print</span> <span class="s2">&quot;Mat constraint parameters:&quot;</span><span class="p">,</span><span class="n">e_opt</span><span class="p">,</span><span class="n">p_opt</span>

        <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_comp_max</span><span class="p">):</span>
            <span class="n">a</span> <span class="o">=</span> <span class="n">sqrt</span><span class="p">((</span><span class="n">weights</span><span class="p">[</span><span class="n">l</span><span class="p">,:]</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span>
            <span class="k">if</span> <span class="n">a</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
                <span class="n">weights</span><span class="p">[</span><span class="n">l</span><span class="p">,:]</span> <span class="o">/=</span> <span class="n">a</span>


    <span class="n">weights_temp</span><span class="p">,</span><span class="n">coeff_res_temp</span><span class="p">,</span><span class="n">cube_est</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">cube_svd</span><span class="p">(</span><span class="n">res</span><span class="p">,</span><span class="n">nb_comp</span><span class="o">=</span><span class="n">nb_comp_max</span><span class="p">)</span>
    <span class="nb">print</span> <span class="s2">&quot;============================&gt;&gt;&gt;&gt; min res: &quot;</span><span class="p">,</span><span class="nb">sum</span><span class="p">((</span><span class="n">cube_est</span><span class="o">-</span><span class="n">res</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">),</span><span class="s2">&quot; &lt;&lt;&lt;&lt;============================&quot;</span>
    <span class="c1">#print sum(abs(weights-alph.dot(ker)))</span>
    <span class="n">ainit</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">input_ref</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
    <span class="n">input_ref</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">copy</span><span class="p">(</span><span class="n">comp</span><span class="p">))</span>
    <span class="n">input_ref</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">upfact</span><span class="p">)</span>
    <span class="n">input_ref</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">shift_ker_stack</span><span class="p">)</span>
    <span class="n">input_ref</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">shift_ker_stack_adj</span><span class="p">)</span>
    <span class="n">input_ref</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">weights</span><span class="p">)</span>
    <span class="n">ref_weights</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">weights</span><span class="p">)</span>
    <span class="n">input_ref</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sig_est</span><span class="p">)</span>
    <span class="n">input_ref</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">flux_est</span><span class="p">)</span>
    <span class="n">survivors</span> <span class="o">=</span> <span class="n">ones</span><span class="p">((</span><span class="n">nb_comp_max</span><span class="p">,))</span>
    <span class="n">Y1</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">Y2</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">Y3</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">cY3</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">curv_obj</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">V</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">filters</span><span class="o">=</span><span class="kc">None</span>
    <span class="n">filters_rot</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">rad</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">select_en</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_iter</span><span class="p">):</span>
        <span class="c1"># Sources estimation</span>
        <span class="n">thresh</span> <span class="o">=</span> <span class="n">nsig</span><span class="o">*</span><span class="n">utils</span><span class="o">.</span><span class="n">acc_sig_maps</span><span class="p">(</span><span class="n">shap</span><span class="p">,</span><span class="n">shift_ker_stack_adj</span><span class="p">,</span><span class="n">sig_est</span><span class="p">,</span><span class="n">flux_est</span><span class="p">,</span><span class="n">flux_ref</span><span class="p">,</span><span class="n">upfact</span><span class="p">,</span><span class="n">weights</span><span class="p">,</span><span class="n">sig_data</span><span class="o">=</span><span class="n">sig_min_vect</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">k</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">select_en</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="c1">#comp,Y1,Y2,Y3,V,rad,ind_select = low_rank_global_src_est_cp(input_ref,thresh,psf_stack,ksig=nsig,eps=0.8,ainit=ainit,nb_iter=nb_subiter,tol=1,nb_rw=nb_rw,Y1=Y1,Y2=Y2,V=V,rad=None,select_en=select_en,wavr_en=wavr_en,optr=opt,pos_en=False)</span>
        <span class="n">filters</span><span class="p">,</span><span class="n">filters_rot</span><span class="p">,</span><span class="n">Y2</span><span class="p">,</span><span class="n">Y3</span><span class="p">,</span><span class="n">cY3</span><span class="p">,</span><span class="n">comp</span><span class="p">,</span><span class="n">comp_curv</span><span class="p">,</span><span class="n">ind_select</span><span class="p">,</span><span class="n">curv_obj</span> <span class="o">=</span> <span class="n">low_rank_global_src_est_comb</span><span class="p">(</span><span class="n">input_ref</span><span class="p">,</span>\
        <span class="n">thresh</span><span class="p">,</span><span class="n">psf_stack</span><span class="p">,</span><span class="n">ksig</span><span class="o">=</span><span class="n">nsig</span><span class="p">,</span><span class="n">eps</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span><span class="n">ainit</span><span class="o">=</span><span class="n">ainit</span><span class="p">,</span><span class="n">nb_iter</span><span class="o">=</span><span class="n">nb_subiter</span><span class="p">,</span><span class="n">tol</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">nb_rw</span><span class="o">=</span><span class="n">nb_rw</span><span class="p">,</span><span class="n">Y2</span><span class="o">=</span><span class="n">Y2</span><span class="p">,</span><span class="n">V</span><span class="o">=</span><span class="n">V</span><span class="p">,</span><span class="n">rad</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>\
        <span class="n">select_en</span><span class="o">=</span><span class="n">select_en</span><span class="p">,</span><span class="n">wavr_en</span><span class="o">=</span><span class="n">wavr_en</span><span class="p">,</span><span class="n">optr</span><span class="o">=</span><span class="n">opt</span><span class="p">,</span><span class="n">pos_en</span><span class="o">=</span><span class="n">positivity_en</span><span class="p">,</span><span class="n">filters</span><span class="o">=</span><span class="n">filters</span><span class="p">,</span><span class="n">filters_rot</span><span class="o">=</span><span class="n">filters_rot</span><span class="p">,</span>\
        <span class="n">curv</span><span class="o">=</span><span class="n">curv</span><span class="p">,</span><span class="n">curv_obj</span><span class="o">=</span><span class="n">curv_obj</span><span class="p">)</span>

        <span class="c1">#print &quot;============= &quot;,comp.shape,rad.shape,&quot; ==============&quot;</span>
        <span class="n">comp_lr</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">comp</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>
        <span class="n">survivors</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">nb_comp_max</span><span class="p">,))</span>
        <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">comp</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
            <span class="sd">&quot;&quot;&quot;a = sqrt((comp[:,:,l]**2).sum())</span>
<span class="sd">            if a&gt;0:</span>
<span class="sd">                survivors[l] = 1</span>
<span class="sd">                comp[:,:,l] /= a</span>
<span class="sd">                weights[l,:] *= a&quot;&quot;&quot;</span>

            <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
                <span class="n">comp_lr</span><span class="p">[:,:,</span><span class="n">l</span><span class="p">,</span><span class="n">p</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">flux_est</span><span class="p">[</span><span class="n">p</span><span class="p">]</span><span class="o">/</span><span class="p">(</span><span class="n">sig_est</span><span class="p">[</span><span class="n">p</span><span class="p">]</span><span class="o">*</span><span class="n">flux_ref</span><span class="p">))</span><span class="o">*</span><span class="n">utils</span><span class="o">.</span><span class="n">decim</span><span class="p">(</span><span class="n">scisig</span><span class="o">.</span><span class="n">fftconvolve</span><span class="p">(</span><span class="n">comp</span><span class="p">[:,:,</span><span class="n">l</span><span class="p">]</span><span class="o">+</span><span class="n">comp_curv</span><span class="p">[:,:,</span><span class="n">l</span><span class="p">],</span><span class="n">shift_ker_stack</span><span class="p">[:,:,</span><span class="n">p</span><span class="p">],</span><span class="n">mode</span><span class="o">=</span><span class="s1">&#39;same&#39;</span><span class="p">),</span><span class="n">upfact</span><span class="p">,</span><span class="n">av_en</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">id0</span> <span class="o">=</span> <span class="n">where</span><span class="p">((</span><span class="n">survivors</span><span class="o">==</span><span class="mi">1</span><span class="p">))</span>
        <span class="nb">id</span> <span class="o">=</span> <span class="n">id0</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="c1"># Weights estimation</span>
        <span class="c1">#weights_k,alph,min_val_map = non_unif_smoothing_mult_coeff_pos_cp_4(psf_stack,comp_lr[:,:,id,:],comp[:,:,id],neigh,ker,alph,to=to,nb_iter=2000,tol=0.1,Ainit=weights[id,:],pos_en=positivity_en)</span>
        <span class="c1">#weights_k,min_val_map = non_unif_smoothing_mult_coeff_pos_cp_3(psf_stack,comp_lr[:,:,id,:],comp[:,:,id],neigh,dist_weights_in,e_opt,ker,alph,to=to,nb_iter=nb_subiter,p_smth_mat_inv=p_smth_mat_inv,tol=0.1,Ainit=weights[id,:],pos_en=positivity_en)</span>
        <span class="c1">#weights_k,alph = non_unif_smoothing_mult_coeff_pos_cp_5(psf_stack,comp_lr[:,:,id,:],comp[:,:,id],neigh,ker,alph,to=to,nb_iter=nb_subiter,tol=0.1,Ainit=weights[id,:],pos_en=positivity_en)</span>
        <span class="n">n_max</span> <span class="o">=</span> <span class="n">nb_iter</span><span class="o">-</span><span class="mi">1</span>
        <span class="k">if</span> <span class="n">k</span> <span class="o">&lt;</span> <span class="n">n_max</span><span class="p">:</span>
            <span class="n">weights_k</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="n">lsq_en</span><span class="p">:</span>
                <span class="n">weights_k</span> <span class="o">=</span> <span class="n">non_unif_smoothing_mult_coeff_pos_cp_6</span><span class="p">(</span><span class="n">psf_stack</span><span class="p">,</span><span class="n">comp_lr</span><span class="p">,</span><span class="n">nb_iter</span><span class="o">=</span><span class="n">nb_subiter</span><span class="o">*</span><span class="mi">2</span><span class="p">)</span>
                <span class="c1">#weights_k,mat,v = lsq_mult_coeff_stack(psf_stack,comp_lr)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">weights_k</span><span class="p">,</span><span class="n">alph</span><span class="p">,</span><span class="n">supports</span> <span class="o">=</span> <span class="n">non_unif_smoothing_mult_coeff_pos_cp_5</span><span class="p">(</span><span class="n">psf_stack</span><span class="p">,</span><span class="n">comp_lr</span><span class="p">,</span><span class="n">comp</span><span class="o">+</span><span class="n">comp_curv</span><span class="p">,</span><span class="n">neigh</span><span class="p">,</span><span class="n">ker</span><span class="p">,</span><span class="n">alph</span><span class="p">[</span><span class="n">ind_select</span><span class="p">,:],</span><span class="n">to</span><span class="o">=</span><span class="n">to</span><span class="p">,</span><span class="n">nb_iter</span><span class="o">=</span><span class="n">nb_subiter</span><span class="o">*</span><span class="mi">2</span><span class="p">,</span><span class="n">tol</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span><span class="n">Ainit</span><span class="o">=</span><span class="n">weights</span><span class="p">[</span><span class="n">ind_select</span><span class="p">,:],</span><span class="n">pos_en</span><span class="o">=</span><span class="n">positivity_en</span><span class="p">)</span><span class="c1">#,spars_perc=1)#*double((k+1))/nb_iter)</span>
            <span class="c1">#weights[id,:] = weights_k</span>
            <span class="n">list_surv</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">comp</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
                <span class="n">a</span> <span class="o">=</span> <span class="n">sqrt</span><span class="p">((</span><span class="n">weights_k</span><span class="p">[</span><span class="n">l</span><span class="p">,:]</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span>
                <span class="k">if</span> <span class="n">a</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
                    <span class="n">list_surv</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">l</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">wavr_en</span><span class="p">:</span>
                        <span class="n">comp</span><span class="p">[:,:,</span><span class="n">l</span><span class="p">]</span> <span class="o">*=</span> <span class="n">a</span>
                        <span class="n">comp_curl</span><span class="p">[:,:,</span><span class="n">l</span><span class="p">]</span> <span class="o">*=</span> <span class="n">a</span>
                        <span class="n">weights_k</span><span class="p">[</span><span class="n">l</span><span class="p">,:]</span> <span class="o">/=</span> <span class="n">a</span>
            <span class="n">ind_select</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">list_surv</span><span class="p">)</span>
            <span class="n">weights</span> <span class="o">=</span> <span class="n">weights_k</span><span class="p">[</span><span class="n">ind_select</span><span class="p">,:]</span>
            <span class="n">input_ref</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">comp</span><span class="p">[:,:,</span><span class="n">ind_select</span><span class="p">]</span><span class="o">+</span><span class="n">comp_curv</span><span class="p">[:,:,</span><span class="n">ind_select</span><span class="p">]</span>
            <span class="n">input_ref</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">weights</span>
            <span class="k">if</span> <span class="n">curv</span><span class="p">:</span>
                <span class="n">cY3</span> <span class="o">=</span> <span class="n">cY3</span><span class="p">[</span><span class="n">ind_select</span><span class="p">,:]</span>
            <span class="c1">#V = V[:,:,ind_select]</span>
            <span class="c1">#rad = rad[ind_select,]</span>

    <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">comp</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
            <span class="k">if</span> <span class="n">curv</span><span class="p">:</span>
                <span class="n">im_hr_curv</span><span class="p">[:,:,</span><span class="n">l</span><span class="p">]</span> <span class="o">=</span> <span class="n">im_hr_curv</span><span class="p">[:,:,</span><span class="n">l</span><span class="p">]</span><span class="o">+</span><span class="n">weights</span><span class="p">[</span><span class="n">p</span><span class="p">,</span><span class="n">l</span><span class="p">]</span><span class="o">*</span><span class="n">comp_curv</span><span class="p">[:,:,</span><span class="n">p</span><span class="p">]</span>
            <span class="n">im_hr</span><span class="p">[:,:,</span><span class="n">l</span><span class="p">]</span> <span class="o">=</span> <span class="n">im_hr</span><span class="p">[:,:,</span><span class="n">l</span><span class="p">]</span><span class="o">+</span><span class="n">weights</span><span class="p">[</span><span class="n">p</span><span class="p">,</span><span class="n">l</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="n">comp</span><span class="p">[:,:,</span><span class="n">p</span><span class="p">]</span><span class="o">+</span><span class="n">comp_curv</span><span class="p">[:,:,</span><span class="n">p</span><span class="p">])</span>
            <span class="n">res</span><span class="p">[:,:,</span><span class="n">l</span><span class="p">]</span> <span class="o">=</span> <span class="n">psf_stack</span><span class="p">[:,:,</span><span class="n">l</span><span class="p">]</span><span class="o">-</span><span class="p">(</span><span class="n">flux_est</span><span class="p">[</span><span class="n">l</span><span class="p">]</span><span class="o">/</span><span class="p">(</span><span class="n">sig_est</span><span class="p">[</span><span class="n">l</span><span class="p">]</span><span class="o">*</span><span class="n">flux_ref</span><span class="p">))</span><span class="o">*</span><span class="n">utils</span><span class="o">.</span><span class="n">decim</span><span class="p">(</span><span class="n">scisig</span><span class="o">.</span><span class="n">fftconvolve</span><span class="p">(</span><span class="n">im_hr</span><span class="p">[:,:,</span><span class="n">l</span><span class="p">],</span><span class="n">shift_ker_stack</span><span class="p">[:,:,</span><span class="n">l</span><span class="p">],</span><span class="n">mode</span><span class="o">=</span><span class="s1">&#39;same&#39;</span><span class="p">),</span><span class="n">upfact</span><span class="p">,</span><span class="n">av_en</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">im_hr</span><span class="p">,</span><span class="n">im_hr_curv</span><span class="p">,</span><span class="n">comp</span><span class="p">,</span><span class="n">comp_curv</span><span class="p">,</span><span class="n">weights</span><span class="p">,</span><span class="n">res</span><span class="p">,</span><span class="n">sig_est</span><span class="o">*</span><span class="n">sig_min</span><span class="p">,</span><span class="n">flux_est</span><span class="p">,</span><span class="n">shifts</span><span class="p">,</span><span class="n">alph</span><span class="p">,</span><span class="n">alph_ref</span><span class="p">,</span><span class="n">e_opt</span><span class="p">,</span><span class="n">p_opt</span><span class="p">,</span><span class="n">ker</span><span class="p">,</span><span class="n">supports</span>

<span class="k">def</span> <span class="nf">transport_plan_update</span><span class="p">(</span><span class="n">P_stack_init</span><span class="p">,</span><span class="n">im_stack</span><span class="p">,</span><span class="n">supp</span><span class="p">,</span><span class="n">neighbors_graph</span><span class="p">,</span><span class="n">weights_neighbors</span><span class="p">,</span>\
                            <span class="n">spectrums</span><span class="p">,</span><span class="n">A</span><span class="p">,</span><span class="n">flux</span><span class="p">,</span><span class="n">sig</span><span class="p">,</span><span class="n">ker</span><span class="p">,</span><span class="n">D</span><span class="p">,</span><span class="n">ker_rot</span><span class="p">,</span><span class="n">nb_iter</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span><span class="n">mu</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span><span class="n">tol</span> <span class="o">=</span> <span class="mf">0.1</span><span class="p">):</span>

    <span class="c1"># Spectral radius calculation</span>
    <span class="n">shap_obs</span> <span class="o">=</span> <span class="n">im_stack</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">shap</span> <span class="o">=</span> <span class="p">(</span><span class="n">shap_obs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">D</span><span class="p">,</span><span class="n">shap_obs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">D</span><span class="p">)</span>

    <span class="n">input_op</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
    <span class="n">input_op</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">copy</span><span class="p">(</span><span class="n">P_stack_init</span><span class="p">))</span>
    <span class="n">input_op</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">shap</span><span class="p">)</span>
    <span class="n">input_op</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">supp</span><span class="p">)</span>
    <span class="n">input_op</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">neighbors_graph</span><span class="p">)</span>
    <span class="n">input_op</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">weights_neighbors</span><span class="p">)</span>
    <span class="n">input_op</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">spectrums</span><span class="p">)</span>
    <span class="n">input_op</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">A</span><span class="p">)</span>
    <span class="n">input_op</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">flux</span><span class="p">)</span>
    <span class="n">input_op</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sig</span><span class="p">)</span>
    <span class="n">input_op</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ker</span><span class="p">)</span>
    <span class="n">input_op</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">D</span><span class="p">)</span>
    <span class="n">input_op</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ker_rot</span><span class="p">)</span>

    <span class="n">eig_max</span><span class="p">,</span><span class="n">spec_rad</span> <span class="o">=</span> <span class="n">pow_meth</span><span class="p">(</span><span class="n">psf_learning_utils</span><span class="o">.</span><span class="n">transport_plan_projections_field_grad_mat</span><span class="p">,</span><span class="n">input_op</span><span class="p">,</span>\
                        <span class="n">P_stack_init</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
    <span class="c1">#spec_rad = 4.77321241379</span>
    <span class="n">t</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">told</span> <span class="o">=</span> <span class="n">t</span>

    <span class="n">z</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">P_stack_init</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">P_stack_init</span><span class="p">)</span>

    <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">var</span> <span class="o">=</span> <span class="mi">100</span>
    <span class="n">res_old</span> <span class="o">=</span> <span class="mi">100</span>
    <span class="k">while</span><span class="p">(</span><span class="n">i</span><span class="o">&lt;</span><span class="n">nb_iter</span> <span class="ow">and</span> <span class="n">var</span><span class="o">&gt;</span><span class="n">tol</span><span class="p">):</span>
        <span class="n">res</span><span class="p">,</span><span class="n">grad</span> <span class="o">=</span> <span class="n">psf_learning_utils</span><span class="o">.</span><span class="n">transport_plan_projections_field_gradient</span><span class="p">(</span><span class="n">im_stack</span><span class="p">,</span><span class="n">z</span><span class="p">,</span><span class="n">supp</span><span class="p">,</span>\
                    <span class="n">neighbors_graph</span><span class="p">,</span><span class="n">weights_neighbors</span><span class="p">,</span><span class="n">spectrums</span><span class="p">,</span><span class="n">A</span><span class="p">,</span><span class="n">flux</span><span class="p">,</span><span class="n">sig</span><span class="p">,</span><span class="n">ker</span><span class="p">,</span><span class="n">ker_rot</span><span class="p">,</span><span class="n">D</span><span class="p">)</span>
        <span class="n">res_en</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">res</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
        <span class="nb">print</span> <span class="s2">&quot;Residual energy: &quot;</span><span class="p">,</span><span class="n">res_en</span>
        <span class="n">var</span> <span class="o">=</span> <span class="mi">100</span><span class="o">*</span><span class="nb">abs</span><span class="p">(</span><span class="n">res_en</span><span class="o">-</span><span class="n">res_old</span><span class="p">)</span><span class="o">/</span><span class="n">res_old</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">z</span> <span class="o">-</span> <span class="n">mu</span><span class="o">*</span><span class="n">grad</span><span class="o">/</span><span class="n">spec_rad</span>
        <span class="n">x_old</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">y</span><span class="p">)</span> <span class="c1"># Prox = id</span>
        <span class="n">t_old</span> <span class="o">=</span> <span class="n">t</span>
        <span class="n">t</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="mi">4</span><span class="o">*</span><span class="n">t</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span><span class="o">/</span><span class="mi">2</span>
        <span class="n">lambd</span> <span class="o">=</span> <span class="mi">1</span><span class="o">+</span><span class="p">(</span><span class="n">t_old</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="n">t</span>
        <span class="n">z</span> <span class="o">=</span> <span class="n">x_old</span> <span class="o">+</span> <span class="n">lambd</span><span class="o">*</span><span class="p">(</span><span class="n">x</span><span class="o">-</span><span class="n">x_old</span><span class="p">)</span>
        <span class="n">i</span><span class="o">+=</span><span class="mi">1</span>
        <span class="n">gc</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">z</span>

<span class="k">def</span> <span class="nf">transport_plan_coeff_update</span><span class="p">(</span><span class="n">P_stack</span><span class="p">,</span><span class="n">im_stack</span><span class="p">,</span><span class="n">supp</span><span class="p">,</span><span class="n">neighbors_graph</span><span class="p">,</span><span class="n">weights_neighbors</span><span class="p">,</span>\
                            <span class="n">spectrums</span><span class="p">,</span><span class="n">A_init</span><span class="p">,</span><span class="n">flux</span><span class="p">,</span><span class="n">sig</span><span class="p">,</span><span class="n">ker</span><span class="p">,</span><span class="n">D</span><span class="p">,</span><span class="n">ker_rot</span><span class="p">,</span><span class="n">nb_iter</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span><span class="n">mu</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span><span class="n">tol</span> <span class="o">=</span> <span class="mf">0.1</span><span class="p">):</span>

    <span class="n">shap_obs</span> <span class="o">=</span> <span class="n">im_stack</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">shap</span> <span class="o">=</span> <span class="p">(</span><span class="n">shap_obs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">D</span><span class="p">,</span><span class="n">shap_obs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">D</span><span class="p">)</span>

    <span class="c1"># Spectral radius calculation</span>
    <span class="n">input_op</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
    <span class="n">input_op</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">A_init</span><span class="p">)</span>
    <span class="n">input_op</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">shap</span><span class="p">)</span>
    <span class="n">input_op</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">supp</span><span class="p">)</span>
    <span class="n">input_op</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">neighbors_graph</span><span class="p">)</span>
    <span class="n">input_op</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">weights_neighbors</span><span class="p">)</span>
    <span class="n">input_op</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">spectrums</span><span class="p">)</span>
    <span class="n">input_op</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">copy</span><span class="p">(</span><span class="n">P_stack</span><span class="p">))</span>
    <span class="n">input_op</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">flux</span><span class="p">)</span>
    <span class="n">input_op</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sig</span><span class="p">)</span>
    <span class="n">input_op</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ker</span><span class="p">)</span>
    <span class="n">input_op</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">D</span><span class="p">)</span>
    <span class="n">input_op</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ker_rot</span><span class="p">)</span>


    <span class="n">eig_max</span><span class="p">,</span><span class="n">spec_rad</span> <span class="o">=</span> <span class="n">pow_meth</span><span class="p">(</span><span class="n">psf_learning_utils</span><span class="o">.</span><span class="n">transport_plan_projections_field_coeff_grad_mat</span><span class="p">,</span><span class="n">input_op</span><span class="p">,</span>\
                        <span class="n">A_init</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
    <span class="n">t</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">told</span> <span class="o">=</span> <span class="n">t</span>

    <span class="n">z</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">A_init</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">A_init</span><span class="p">)</span>

    <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">var</span> <span class="o">=</span> <span class="mi">100</span>
    <span class="n">res_old</span> <span class="o">=</span> <span class="mi">100</span>
    <span class="k">while</span><span class="p">(</span><span class="n">i</span><span class="o">&lt;</span><span class="n">nb_iter</span> <span class="ow">and</span> <span class="n">var</span><span class="o">&gt;</span><span class="n">tol</span><span class="p">):</span>
        <span class="n">res</span><span class="p">,</span><span class="n">grad</span> <span class="o">=</span> <span class="n">psf_learning_utils</span><span class="o">.</span><span class="n">transport_plan_projections_field_coeff_gradient</span><span class="p">(</span><span class="n">im_stack</span><span class="p">,</span><span class="n">P_stack</span><span class="p">,</span><span class="n">supp</span><span class="p">,</span>\
                    <span class="n">neighbors_graph</span><span class="p">,</span><span class="n">weights_neighbors</span><span class="p">,</span><span class="n">spectrums</span><span class="p">,</span><span class="n">z</span><span class="p">,</span><span class="n">flux</span><span class="p">,</span><span class="n">sig</span><span class="p">,</span><span class="n">ker</span><span class="p">,</span><span class="n">ker_rot</span><span class="p">,</span><span class="n">D</span><span class="p">)</span>
        <span class="n">res_en</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">res</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
        <span class="nb">print</span> <span class="s2">&quot;Residual energy: &quot;</span><span class="p">,</span><span class="n">res_en</span>
        <span class="n">var</span> <span class="o">=</span> <span class="mi">100</span><span class="o">*</span><span class="nb">abs</span><span class="p">(</span><span class="n">res_en</span><span class="o">-</span><span class="n">res_old</span><span class="p">)</span><span class="o">/</span><span class="n">res_old</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">z</span> <span class="o">-</span> <span class="n">mu</span><span class="o">*</span><span class="n">grad</span><span class="o">/</span><span class="n">spec_rad</span>
        <span class="n">x_old</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">y</span><span class="p">)</span> <span class="c1"># Prox = id</span>
        <span class="n">t_old</span> <span class="o">=</span> <span class="n">t</span>
        <span class="n">t</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="mi">4</span><span class="o">*</span><span class="n">t</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span><span class="o">/</span><span class="mi">2</span>
        <span class="n">lambd</span> <span class="o">=</span> <span class="mi">1</span><span class="o">+</span><span class="p">(</span><span class="n">t_old</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="n">t</span>
        <span class="n">z</span> <span class="o">=</span> <span class="n">x_old</span> <span class="o">+</span> <span class="n">lambd</span><span class="o">*</span><span class="p">(</span><span class="n">x</span><span class="o">-</span><span class="n">x_old</span><span class="p">)</span>
        <span class="n">i</span><span class="o">+=</span><span class="mi">1</span>

    <span class="k">return</span> <span class="n">z</span>

<span class="k">def</span> <span class="nf">polychromatic_psf_field_est</span><span class="p">(</span><span class="n">im_stack</span><span class="p">,</span><span class="n">spectrums</span><span class="p">,</span><span class="n">wvl</span><span class="p">,</span><span class="n">D</span><span class="p">,</span><span class="n">opt_shift_est</span><span class="p">,</span><span class="n">nb_comp</span><span class="p">,</span><span class="n">nb_iter</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span><span class="n">nb_subiter</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span><span class="n">mu</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span>\
                        <span class="n">tol</span> <span class="o">=</span> <span class="mf">0.1</span><span class="p">,</span><span class="n">sig_supp</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span><span class="n">sig</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">shifts</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">flux</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">nsig_shift_est</span><span class="o">=</span><span class="mi">4</span><span class="p">):</span>

    <span class="nb">print</span> <span class="s2">&quot;--------------- Transport architecture setting ------------------&quot;</span>
    <span class="n">shap_obs</span> <span class="o">=</span> <span class="n">im_stack</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">shap</span> <span class="o">=</span> <span class="p">(</span><span class="n">shap_obs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">D</span><span class="p">,</span><span class="n">shap_obs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">D</span><span class="p">)</span>
    <span class="n">P_stack</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">diagonally_dominated_mat_stack</span><span class="p">(</span><span class="n">shap</span><span class="p">,</span><span class="n">nb_comp</span><span class="p">,</span><span class="n">sig</span><span class="o">=</span><span class="n">sig_supp</span><span class="p">,</span><span class="n">thresh_en</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">i</span><span class="p">,</span><span class="n">j</span> <span class="o">=</span> <span class="n">where</span><span class="p">(</span><span class="n">P_stack</span><span class="p">[:,:,</span><span class="mi">0</span><span class="p">]</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">supp</span> <span class="o">=</span> <span class="n">transpose</span><span class="p">(</span><span class="n">array</span><span class="p">([</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]))</span>
    <span class="n">t</span> <span class="o">=</span> <span class="p">(</span><span class="n">wvl</span><span class="o">-</span><span class="n">wvl</span><span class="o">.</span><span class="n">min</span><span class="p">())</span><span class="o">/</span><span class="p">(</span><span class="n">wvl</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">-</span><span class="n">wvl</span><span class="o">.</span><span class="n">min</span><span class="p">())</span>
    <span class="n">neighbors_graph</span><span class="p">,</span><span class="n">weights_neighbors</span><span class="p">,</span><span class="n">cent</span><span class="p">,</span><span class="n">coord_map</span><span class="p">,</span><span class="n">knn</span> <span class="o">=</span> <span class="n">psf_learning_utils</span><span class="o">.</span><span class="n">full_displacement</span><span class="p">(</span><span class="n">shap</span><span class="p">,</span><span class="n">supp</span><span class="p">,</span><span class="n">t</span><span class="p">,</span>\
    <span class="n">pol_en</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">cent</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">theta_param</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">pol_mod</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">coord_map</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">knn</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>

    <span class="nb">print</span> <span class="s2">&quot;--------------------- Forward operator parameters estimation ------------------------&quot;</span>
    <span class="n">centroids</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">sig</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">sig</span><span class="p">,</span><span class="n">filters</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">im_gauss_nois_est_cube</span><span class="p">(</span><span class="n">copy</span><span class="p">(</span><span class="n">im_stack</span><span class="p">),</span><span class="n">opt</span><span class="o">=</span><span class="n">opt_shift_est</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">shifts</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="nb">map</span> <span class="o">=</span> <span class="n">ones</span><span class="p">(</span><span class="n">im_stack</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap_obs</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
            <span class="nb">map</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">]</span> <span class="o">*=</span> <span class="n">nsig_shift_est</span><span class="o">*</span><span class="n">sig</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="nb">print</span> <span class="s1">&#39;Shifts estimation...&#39;</span>
        <span class="n">psf_stack_shift</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">thresholding_3D</span><span class="p">(</span><span class="n">copy</span><span class="p">(</span><span class="n">im_stack</span><span class="p">),</span><span class="nb">map</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">shifts</span><span class="p">,</span><span class="n">centroids</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">shift_est</span><span class="p">(</span><span class="n">psf_stack_shift</span><span class="p">)</span>
        <span class="nb">print</span> <span class="s1">&#39;Done...&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span> <span class="s2">&quot;------------ /!\ Warning: shifts provided /!\ -----------&quot;</span>
    <span class="n">ker</span><span class="p">,</span><span class="n">ker_rot</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">shift_ker_stack</span><span class="p">(</span><span class="n">shifts</span><span class="p">,</span><span class="n">D</span><span class="p">)</span>
    <span class="n">sig</span> <span class="o">/=</span><span class="n">sig</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap_obs</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
        <span class="n">im_stack</span><span class="p">[:,:,</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">im_stack</span><span class="p">[:,:,</span><span class="n">k</span><span class="p">]</span><span class="o">/</span><span class="n">sig</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
    <span class="nb">print</span> <span class="s2">&quot; ------ ref energy: &quot;</span><span class="p">,(</span><span class="n">im_stack</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(),</span><span class="s2">&quot; ------- &quot;</span>
    <span class="k">if</span> <span class="n">flux</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">flux</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">flux_estimate_stack</span><span class="p">(</span><span class="n">copy</span><span class="p">(</span><span class="n">im_stack</span><span class="p">),</span><span class="n">rad</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
    <span class="n">flux_ref</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">flux</span><span class="p">)</span>

    <span class="nb">print</span> <span class="s2">&quot;------------- Coeff init ------------&quot;</span>
    <span class="n">A</span><span class="p">,</span><span class="n">comp</span><span class="p">,</span><span class="n">cube_est</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">cube_svd</span><span class="p">(</span><span class="n">im_stack</span><span class="p">,</span><span class="n">nb_comp</span><span class="o">=</span><span class="n">nb_comp</span><span class="p">)</span>

    <span class="n">i</span><span class="o">=</span><span class="mi">0</span>
    <span class="nb">print</span> <span class="s2">&quot; --------- Main loop ---------- &quot;</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_iter</span><span class="p">):</span>
        <span class="nb">print</span> <span class="s2">&quot;----------------Iter &quot;</span><span class="p">,</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="s2">&quot;/&quot;</span><span class="p">,</span><span class="n">nb_iter</span><span class="p">,</span><span class="s2">&quot;-------------------&quot;</span>
        <span class="nb">print</span> <span class="s2">&quot;------------------- Transport plans estimation ------------------&quot;</span>
        <span class="n">P_stack</span> <span class="o">=</span> <span class="n">transport_plan_update</span><span class="p">(</span><span class="n">P_stack</span><span class="p">,</span><span class="n">im_stack</span><span class="p">,</span><span class="n">supp</span><span class="p">,</span><span class="n">neighbors_graph</span><span class="p">,</span><span class="n">weights_neighbors</span><span class="p">,</span>\
                                    <span class="n">spectrums</span><span class="p">,</span><span class="n">A</span><span class="p">,</span><span class="n">flux</span><span class="p">,</span><span class="n">sig</span><span class="p">,</span><span class="n">ker</span><span class="p">,</span><span class="n">D</span><span class="p">,</span><span class="n">ker_rot</span><span class="p">,</span><span class="n">nb_iter</span><span class="o">=</span><span class="n">nb_subiter</span><span class="p">,</span><span class="n">mu</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span><span class="n">tol</span> <span class="o">=</span> <span class="mf">0.1</span><span class="p">)</span>
        <span class="nb">print</span> <span class="s2">&quot;------------------- Coefficients estimation ----------------------&quot;</span>
        <span class="n">A</span> <span class="o">=</span> <span class="n">transport_plan_coeff_update</span><span class="p">(</span><span class="n">P_stack</span><span class="p">,</span><span class="n">im_stack</span><span class="p">,</span><span class="n">supp</span><span class="p">,</span><span class="n">neighbors_graph</span><span class="p">,</span><span class="n">weights_neighbors</span><span class="p">,</span>\
                                    <span class="n">spectrums</span><span class="p">,</span><span class="n">A</span><span class="p">,</span><span class="n">flux</span><span class="p">,</span><span class="n">sig</span><span class="p">,</span><span class="n">ker</span><span class="p">,</span><span class="n">D</span><span class="p">,</span><span class="n">ker_rot</span><span class="p">,</span><span class="n">nb_iter</span><span class="o">=</span><span class="n">nb_subiter</span><span class="p">,</span><span class="n">mu</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span><span class="n">tol</span> <span class="o">=</span> <span class="mf">0.1</span><span class="p">)</span>
        <span class="c1"># Normalization</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_comp</span><span class="p">):</span>
            <span class="n">l1_P</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">P_stack</span><span class="p">[:,:,</span><span class="n">j</span><span class="p">]))</span>
            <span class="n">P_stack</span><span class="p">[:,:,</span><span class="n">j</span><span class="p">]</span><span class="o">/=</span> <span class="n">l1_P</span>
            <span class="n">A</span><span class="p">[</span><span class="n">j</span><span class="p">,:]</span> <span class="o">*=</span> <span class="n">l1_P</span>

    <span class="n">psf_est</span> <span class="o">=</span> <span class="n">psf_learning_utils</span><span class="o">.</span><span class="n">field_reconstruction</span><span class="p">(</span><span class="n">P_stack</span><span class="p">,</span><span class="n">shap</span><span class="p">,</span><span class="n">supp</span><span class="p">,</span><span class="n">neighbors_graph</span><span class="p">,</span><span class="n">weights_neighbors</span><span class="p">,</span><span class="n">A</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">psf_est</span><span class="p">,</span><span class="n">P_stack</span><span class="p">,</span><span class="n">A</span>

<div class="viewcode-block" id="polychromatic_psf_field_est_2"><a class="viewcode-back" href="../optim_utils.html#optim_utils.polychromatic_psf_field_est_2">[docs]</a><span class="k">def</span> <span class="nf">polychromatic_psf_field_est_2</span><span class="p">(</span><span class="n">im_stack_in</span><span class="p">,</span><span class="n">spectrums</span><span class="p">,</span><span class="n">wvl</span><span class="p">,</span><span class="n">D</span><span class="p">,</span><span class="n">opt_shift_est</span><span class="p">,</span><span class="n">nb_comp</span><span class="p">,</span><span class="n">field_pos</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">nb_iter</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span><span class="n">nb_subiter</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span><span class="n">mu</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span>\
                        <span class="n">tol</span> <span class="o">=</span> <span class="mf">0.1</span><span class="p">,</span><span class="n">sig_supp</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span><span class="n">sig</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">shifts</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">flux</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">nsig_shift_est</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span><span class="n">pos_en</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span><span class="n">simplex_en</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>\
                        <span class="n">wvl_en</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">wvl_opt</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">nsig</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span><span class="n">graph_cons_en</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Main LambdaRCA function.</span>
<span class="sd">    </span>
<span class="sd">    Calls:</span>
<span class="sd">    </span>
<span class="sd">    * :func:`utils.get_noise_arr`</span>
<span class="sd">    * :func:`utils.diagonally_dominated_mat_stack` </span>
<span class="sd">    * :func:`psf_learning_utils.full_displacement` </span>
<span class="sd">    * :func:`utils.im_gauss_nois_est_cube` </span>
<span class="sd">    * :func:`utils.thresholding_3D` </span>
<span class="sd">    * :func:`utils.shift_est` </span>
<span class="sd">    * :func:`utils.shift_ker_stack` </span>
<span class="sd">    * :func:`utils.flux_estimate_stack` </span>
<span class="sd">    * :func:`optim_utils.analysis` </span>
<span class="sd">    * :func:`utils.cube_svd`</span>
<span class="sd">    * :func:`grads.polychrom_eigen_psf`</span>
<span class="sd">    * :func:`grads.polychrom_eigen_psf_coeff_graph`</span>
<span class="sd">    * :func:`grads.polychrom_eigen_psf_coeff`</span>
<span class="sd">    * :func:`psf_learning_utils.field_reconstruction`</span>
<span class="sd">    * :func:`operators.transport_plan_lin_comb_wavelet`</span>
<span class="sd">    * :func:`operators.transport_plan_marg_wavelet`</span>
<span class="sd">    * :func:`operators.transport_plan_lin_comb`</span>
<span class="sd">    * :func:`operators.transport_plan_lin_comb_coeff`</span>
<span class="sd">    * :func:`proxs.simplex_threshold`</span>
<span class="sd">    * :func:`proxs.Simplex`</span>
<span class="sd">    * :func:`proxs.KThreshold`</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">im_stack</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">im_stack_in</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">wvl_en</span><span class="p">:</span>
        <span class="kn">from</span> <span class="nn">utils</span> <span class="k">import</span> <span class="n">get_noise_arr</span>

    <span class="nb">print</span> <span class="s2">&quot;--------------- Transport architecture setting ------------------&quot;</span>
    <span class="n">nb_im</span> <span class="o">=</span> <span class="n">im_stack</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">shap_obs</span> <span class="o">=</span> <span class="n">im_stack</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">shap</span> <span class="o">=</span> <span class="p">(</span><span class="n">shap_obs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">D</span><span class="p">,</span><span class="n">shap_obs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">D</span><span class="p">)</span>
    <span class="n">P_stack</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">diagonally_dominated_mat_stack</span><span class="p">(</span><span class="n">shap</span><span class="p">,</span><span class="n">nb_comp</span><span class="p">,</span><span class="n">sig</span><span class="o">=</span><span class="n">sig_supp</span><span class="p">,</span><span class="n">thresh_en</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">i</span><span class="p">,</span><span class="n">j</span> <span class="o">=</span> <span class="n">where</span><span class="p">(</span><span class="n">P_stack</span><span class="p">[:,:,</span><span class="mi">0</span><span class="p">]</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">supp</span> <span class="o">=</span> <span class="n">transpose</span><span class="p">(</span><span class="n">array</span><span class="p">([</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]))</span>
    <span class="n">t</span> <span class="o">=</span> <span class="p">(</span><span class="n">wvl</span><span class="o">-</span><span class="n">wvl</span><span class="o">.</span><span class="n">min</span><span class="p">())</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">wvl</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">-</span><span class="n">wvl</span><span class="o">.</span><span class="n">min</span><span class="p">())</span>

    <span class="n">neighbors_graph</span><span class="p">,</span><span class="n">weights_neighbors</span><span class="p">,</span><span class="n">cent</span><span class="p">,</span><span class="n">coord_map</span><span class="p">,</span><span class="n">knn</span> <span class="o">=</span> <span class="n">psf_learning_utils</span><span class="o">.</span><span class="n">full_displacement</span><span class="p">(</span><span class="n">shap</span><span class="p">,</span><span class="n">supp</span><span class="p">,</span><span class="n">t</span><span class="p">,</span>\
    <span class="n">pol_en</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">cent</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">theta_param</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">pol_mod</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">coord_map</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">knn</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>

    <span class="nb">print</span> <span class="s2">&quot;------------------- Forward operator parameters estimation ------------------------&quot;</span>
    <span class="n">centroids</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">sig</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">sig</span><span class="p">,</span><span class="n">filters</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">im_gauss_nois_est_cube</span><span class="p">(</span><span class="n">copy</span><span class="p">(</span><span class="n">im_stack</span><span class="p">),</span><span class="n">opt</span><span class="o">=</span><span class="n">opt_shift_est</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">shifts</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="nb">map</span> <span class="o">=</span> <span class="n">ones</span><span class="p">(</span><span class="n">im_stack</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap_obs</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
            <span class="nb">map</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">]</span> <span class="o">*=</span> <span class="n">nsig_shift_est</span><span class="o">*</span><span class="n">sig</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="nb">print</span> <span class="s1">&#39;Shifts estimation...&#39;</span>
        <span class="n">psf_stack_shift</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">thresholding_3D</span><span class="p">(</span><span class="n">copy</span><span class="p">(</span><span class="n">im_stack</span><span class="p">),</span><span class="nb">map</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">shifts</span><span class="p">,</span><span class="n">centroids</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">shift_est</span><span class="p">(</span><span class="n">psf_stack_shift</span><span class="p">)</span>
        <span class="nb">print</span> <span class="s1">&#39;Done...&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span> <span class="s2">&quot;---------- /!\ Warning: shifts provided /!\ ---------&quot;</span>
    <span class="n">ker</span><span class="p">,</span><span class="n">ker_rot</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">shift_ker_stack</span><span class="p">(</span><span class="n">shifts</span><span class="p">,</span><span class="n">D</span><span class="p">)</span>
    <span class="n">sig</span> <span class="o">/=</span><span class="n">sig</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap_obs</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
        <span class="n">im_stack</span><span class="p">[:,:,</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">im_stack</span><span class="p">[:,:,</span><span class="n">k</span><span class="p">]</span><span class="o">/</span><span class="n">sig</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
    <span class="nb">print</span> <span class="s2">&quot; ------ ref energy: &quot;</span><span class="p">,(</span><span class="n">im_stack</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(),</span><span class="s2">&quot; ------- &quot;</span>
    <span class="k">if</span> <span class="n">flux</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">flux</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">flux_estimate_stack</span><span class="p">(</span><span class="n">copy</span><span class="p">(</span><span class="n">im_stack</span><span class="p">),</span><span class="n">rad</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">graph_cons_en</span><span class="p">:</span>
        <span class="nb">print</span> <span class="s2">&quot;-------------------- Spatial constraint setting -----------------------&quot;</span>
        <span class="n">e_opt</span><span class="p">,</span><span class="n">p_opt</span><span class="p">,</span><span class="n">weights</span><span class="p">,</span><span class="n">comp_temp</span><span class="p">,</span><span class="n">data</span><span class="p">,</span><span class="n">basis</span><span class="p">,</span><span class="n">alph</span>  <span class="o">=</span> <span class="n">analysis</span><span class="p">(</span><span class="n">im_stack</span><span class="p">,</span><span class="mf">0.1</span><span class="o">*</span><span class="n">prod</span><span class="p">(</span><span class="n">shap_obs</span><span class="p">)</span><span class="o">*</span><span class="n">sig</span><span class="o">.</span><span class="n">min</span><span class="p">()</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span><span class="n">field_pos</span><span class="p">,</span><span class="n">nb_max</span><span class="o">=</span><span class="n">nb_comp</span><span class="p">)</span>

    <span class="nb">print</span> <span class="s2">&quot;------------- Coeff init ------------&quot;</span>
    <span class="n">A</span><span class="p">,</span><span class="n">comp</span><span class="p">,</span><span class="n">cube_est</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">cube_svd</span><span class="p">(</span><span class="n">im_stack</span><span class="p">,</span><span class="n">nb_comp</span><span class="o">=</span><span class="n">nb_comp</span><span class="p">)</span>

    <span class="n">i</span><span class="o">=</span><span class="mi">0</span>
    <span class="nb">print</span> <span class="s2">&quot; --------- Optimization instances setting ---------- &quot;</span>

    <span class="c1"># Data fidelity related instances</span>
    <span class="n">polychrom_grad</span> <span class="o">=</span> <span class="n">grad</span><span class="o">.</span><span class="n">polychrom_eigen_psf</span><span class="p">(</span><span class="n">im_stack</span><span class="p">,</span> <span class="n">supp</span><span class="p">,</span> <span class="n">neighbors_graph</span><span class="p">,</span> \
                <span class="n">weights_neighbors</span><span class="p">,</span> <span class="n">spectrums</span><span class="p">,</span> <span class="n">A</span><span class="p">,</span> <span class="n">flux</span><span class="p">,</span> <span class="n">sig</span><span class="p">,</span> <span class="n">ker</span><span class="p">,</span> <span class="n">ker_rot</span><span class="p">,</span> <span class="n">D</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">graph_cons_en</span><span class="p">:</span>
        <span class="n">polychrom_grad_coeff</span> <span class="o">=</span> <span class="n">grad</span><span class="o">.</span><span class="n">polychrom_eigen_psf_coeff_graph</span><span class="p">(</span><span class="n">im_stack</span><span class="p">,</span> <span class="n">supp</span><span class="p">,</span> <span class="n">neighbors_graph</span><span class="p">,</span> \
                <span class="n">weights_neighbors</span><span class="p">,</span> <span class="n">spectrums</span><span class="p">,</span> <span class="n">P_stack</span><span class="p">,</span> <span class="n">flux</span><span class="p">,</span> <span class="n">sig</span><span class="p">,</span> <span class="n">ker</span><span class="p">,</span> <span class="n">ker_rot</span><span class="p">,</span> <span class="n">D</span><span class="p">,</span> <span class="n">basis</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">polychrom_grad_coeff</span> <span class="o">=</span> <span class="n">grad</span><span class="o">.</span><span class="n">polychrom_eigen_psf_coeff</span><span class="p">(</span><span class="n">im_stack</span><span class="p">,</span> <span class="n">supp</span><span class="p">,</span> <span class="n">neighbors_graph</span><span class="p">,</span> \
                <span class="n">weights_neighbors</span><span class="p">,</span> <span class="n">spectrums</span><span class="p">,</span> <span class="n">P_stack</span><span class="p">,</span> <span class="n">flux</span><span class="p">,</span> <span class="n">sig</span><span class="p">,</span> <span class="n">ker</span><span class="p">,</span> <span class="n">ker_rot</span><span class="p">,</span> <span class="n">D</span><span class="p">)</span>


    <span class="c1"># Dual variable related linear operators instances</span>
    <span class="n">dual_var_coeff</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">supp</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">nb_im</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">wvl_en</span> <span class="ow">and</span> <span class="n">pos_en</span><span class="p">:</span>
        <span class="n">lin_com</span> <span class="o">=</span> <span class="n">lambdaops</span><span class="o">.</span><span class="n">transport_plan_lin_comb_wavelet</span><span class="p">(</span><span class="n">A</span><span class="p">,</span><span class="n">supp</span><span class="p">,</span><span class="n">weights_neighbors</span><span class="p">,</span><span class="n">neighbors_graph</span><span class="p">,</span><span class="n">shap</span><span class="p">,</span><span class="n">wavelet_opt</span><span class="o">=</span><span class="n">wvl_opt</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">wvl_en</span><span class="p">:</span>
            <span class="n">lin_com</span> <span class="o">=</span> <span class="n">lambdaops</span><span class="o">.</span><span class="n">transport_plan_marg_wavelet</span><span class="p">(</span><span class="n">supp</span><span class="p">,</span><span class="n">weights_neighbors</span><span class="p">,</span><span class="n">neighbors_graph</span><span class="p">,</span><span class="n">shap</span><span class="p">,</span><span class="n">wavelet_opt</span><span class="o">=</span><span class="n">wvl_opt</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">lin_com</span> <span class="o">=</span> <span class="n">lambdaops</span><span class="o">.</span><span class="n">transport_plan_lin_comb</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">supp</span><span class="p">,</span><span class="n">shap</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">graph_cons_en</span><span class="p">:</span>
        <span class="n">lin_com_coeff</span> <span class="o">=</span> <span class="n">lambdaops</span><span class="o">.</span><span class="n">transport_plan_lin_comb_coeff</span><span class="p">(</span><span class="n">P_stack</span><span class="p">,</span> <span class="n">supp</span><span class="p">)</span>

    <span class="c1"># Proximity operators related instances</span>
    <span class="n">id_prox</span> <span class="o">=</span> <span class="n">Identity</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">wvl_en</span> <span class="ow">and</span> <span class="n">pos_en</span><span class="p">:</span>
        <span class="n">noise_map</span> <span class="o">=</span> <span class="n">get_noise_arr</span><span class="p">(</span><span class="n">lin_com</span><span class="o">.</span><span class="n">op</span><span class="p">(</span><span class="n">polychrom_grad</span><span class="o">.</span><span class="n">MtX</span><span class="p">(</span><span class="n">im_stack</span><span class="p">))[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">dual_var_plan</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">zeros</span><span class="p">((</span><span class="n">supp</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">nb_im</span><span class="p">)),</span><span class="n">zeros</span><span class="p">(</span><span class="n">noise_map</span><span class="o">.</span><span class="n">shape</span><span class="p">)])</span>
        <span class="n">dual_prox_plan</span> <span class="o">=</span> <span class="n">lambdaprox</span><span class="o">.</span><span class="n">simplex_threshold</span><span class="p">(</span><span class="n">lin_com</span><span class="p">,</span> <span class="n">nsig</span><span class="o">*</span><span class="n">noise_map</span><span class="p">,</span><span class="n">pos_en</span><span class="o">=</span><span class="p">(</span><span class="ow">not</span> <span class="n">simplex_en</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">wvl_en</span><span class="p">:</span>
            <span class="c1"># Noise estimation</span>
            <span class="n">noise_map</span> <span class="o">=</span> <span class="n">get_noise_arr</span><span class="p">(</span><span class="n">lin_com</span><span class="o">.</span><span class="n">op</span><span class="p">(</span><span class="n">polychrom_grad</span><span class="o">.</span><span class="n">MtX</span><span class="p">(</span><span class="n">im_stack</span><span class="p">)))</span>
            <span class="n">dual_var_plan</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">(</span><span class="n">noise_map</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
            <span class="n">dual_prox_plan</span> <span class="o">=</span> <span class="n">prox</span><span class="o">.</span><span class="n">SparseThreshold</span><span class="p">(</span><span class="n">lin_com</span><span class="p">,</span> <span class="n">nsig</span><span class="o">*</span><span class="n">noise_map</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">dual_var_plan</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">supp</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">nb_im</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">simplex_en</span><span class="p">:</span>
                <span class="n">dual_prox_plan</span> <span class="o">=</span> <span class="n">lambdaprox</span><span class="o">.</span><span class="n">Simplex</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">dual_prox_plan</span> <span class="o">=</span> <span class="n">prox</span><span class="o">.</span><span class="n">Positivity</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">graph_cons_en</span><span class="p">:</span>
        <span class="n">iter_func</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">floor</span><span class="p">(</span><span class="n">sqrt</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
        <span class="n">prox_coeff</span> <span class="o">=</span> <span class="n">lambdaprox</span><span class="o">.</span><span class="n">KThreshold</span><span class="p">(</span><span class="n">iter_func</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">simplex_en</span><span class="p">:</span>
            <span class="n">dual_prox_coeff</span> <span class="o">=</span> <span class="n">lambdaprox</span><span class="o">.</span><span class="n">Simplex</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">dual_prox_coeff</span> <span class="o">=</span> <span class="n">prox</span><span class="o">.</span><span class="n">Positivity</span><span class="p">()</span>

    <span class="c1"># ---- (Re)Setting hyperparameters</span>
    <span class="n">delta</span>  <span class="o">=</span> <span class="p">(</span><span class="n">polychrom_grad</span><span class="o">.</span><span class="n">inv_spec_rad</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="mi">4</span><span class="o">*</span><span class="n">lin_com</span><span class="o">.</span><span class="n">mat_norm</span><span class="o">**</span><span class="mi">2</span>
    <span class="n">w</span> <span class="o">=</span> <span class="mf">0.9</span>
    <span class="n">sigma_P</span> <span class="o">=</span> <span class="n">w</span><span class="o">*</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">delta</span><span class="p">)</span><span class="o">-</span><span class="n">polychrom_grad</span><span class="o">.</span><span class="n">inv_spec_rad</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">lin_com</span><span class="o">.</span><span class="n">mat_norm</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">tau_P</span> <span class="o">=</span> <span class="n">sigma_P</span>
    <span class="n">rho_P</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="c1"># Cost function instance</span>
    <span class="n">cost_op</span> <span class="o">=</span> <span class="n">costObj</span><span class="p">([</span><span class="n">polychrom_grad</span><span class="p">])</span>

    <span class="n">condat_min</span> <span class="o">=</span> <span class="n">optimalg</span><span class="o">.</span><span class="n">Condat</span><span class="p">(</span><span class="n">P_stack</span><span class="p">,</span> <span class="n">dual_var_plan</span><span class="p">,</span> <span class="n">polychrom_grad</span><span class="p">,</span> <span class="n">id_prox</span><span class="p">,</span> <span class="n">dual_prox_plan</span><span class="p">,</span> <span class="n">lin_com</span><span class="p">,</span> <span class="n">cost</span><span class="o">=</span><span class="n">cost_op</span><span class="p">,</span>\
                 <span class="n">rho</span><span class="o">=</span><span class="n">rho_P</span><span class="p">,</span>  <span class="n">sigma</span><span class="o">=</span><span class="n">sigma_P</span><span class="p">,</span> <span class="n">tau</span><span class="o">=</span><span class="n">tau_P</span><span class="p">,</span> <span class="n">rho_update</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">sigma_update</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">tau_update</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">auto_iterate</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="nb">print</span> <span class="s2">&quot;------------------- Transport plans estimation ------------------&quot;</span>

    <span class="n">condat_min</span><span class="o">.</span><span class="n">iterate</span><span class="p">(</span><span class="n">max_iter</span><span class="o">=</span><span class="n">nb_subiter</span><span class="p">)</span> <span class="c1"># ! actually runs optimisation</span>
    <span class="n">P_stack</span> <span class="o">=</span> <span class="n">condat_min</span><span class="o">.</span><span class="n">x_final</span>
    <span class="n">dual_var_plan</span> <span class="o">=</span> <span class="n">condat_min</span><span class="o">.</span><span class="n">y_final</span>

    <span class="n">obs_est</span> <span class="o">=</span> <span class="n">polychrom_grad</span><span class="o">.</span><span class="n">MX</span><span class="p">(</span><span class="n">P_stack</span><span class="p">)</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">im_stack</span> <span class="o">-</span> <span class="n">obs_est</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_iter</span><span class="p">):</span>
        <span class="nb">print</span> <span class="s2">&quot;----------------Iter &quot;</span><span class="p">,</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="s2">&quot;/&quot;</span><span class="p">,</span><span class="n">nb_iter</span><span class="p">,</span><span class="s2">&quot;-------------------&quot;</span>

        <span class="c1"># Parameters update</span>
        <span class="n">polychrom_grad_coeff</span><span class="o">.</span><span class="n">set_P</span><span class="p">(</span><span class="n">P_stack</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">graph_cons_en</span><span class="p">:</span>
            <span class="n">lin_com_coeff</span><span class="o">.</span><span class="n">set_P_stack</span><span class="p">(</span><span class="n">P_stack</span><span class="p">)</span>
            <span class="c1"># ---- (Re)Setting hyperparameters</span>
            <span class="n">delta</span>  <span class="o">=</span> <span class="p">(</span><span class="n">polychrom_grad_coeff</span><span class="o">.</span><span class="n">inv_spec_rad</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="mi">4</span><span class="o">*</span><span class="n">lin_com_coeff</span><span class="o">.</span><span class="n">mat_norm</span><span class="o">**</span><span class="mi">2</span>
            <span class="n">w</span> <span class="o">=</span> <span class="mf">0.9</span>
            <span class="n">sigma_coeff</span> <span class="o">=</span> <span class="n">w</span><span class="o">*</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">delta</span><span class="p">)</span><span class="o">-</span><span class="n">polychrom_grad_coeff</span><span class="o">.</span><span class="n">inv_spec_rad</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">lin_com_coeff</span><span class="o">.</span><span class="n">mat_norm</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
            <span class="n">tau_coeff</span> <span class="o">=</span> <span class="n">sigma_coeff</span>
            <span class="n">rho_coeff</span> <span class="o">=</span> <span class="mi">1</span>

        <span class="c1"># Coefficients cost function instance</span>
        <span class="n">cost_op_coeff</span> <span class="o">=</span> <span class="n">costObj</span><span class="p">([</span><span class="n">polychrom_grad_coeff</span><span class="p">])</span>

        <span class="k">if</span> <span class="n">graph_cons_en</span><span class="p">:</span>
            <span class="n">beta_param</span> <span class="o">=</span> <span class="n">polychrom_grad_coeff</span><span class="o">.</span><span class="n">inv_spec_rad</span><span class="c1"># set stepsize to inverse spectral radius of coefficient gradient</span>
            <span class="n">min_coeff</span> <span class="o">=</span> <span class="n">optimalg</span><span class="o">.</span><span class="n">ForwardBackward</span><span class="p">(</span><span class="n">alph</span><span class="p">,</span> <span class="n">polychrom_grad_coeff</span><span class="p">,</span> <span class="n">prox_coeff</span><span class="p">,</span> <span class="n">beta_param</span><span class="o">=</span><span class="n">beta_param</span><span class="p">,</span> 
                                                 <span class="n">cost</span><span class="o">=</span><span class="n">cost_op_coeff</span><span class="p">,</span><span class="n">auto_iterate</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">min_coeff</span> <span class="o">=</span> <span class="n">optimalg</span><span class="o">.</span><span class="n">Condat</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">dual_var_coeff</span><span class="p">,</span> <span class="n">polychrom_grad_coeff</span><span class="p">,</span> <span class="n">id_prox</span><span class="p">,</span> <span class="n">dual_prox_coeff</span><span class="p">,</span> <span class="n">lin_com_coeff</span><span class="p">,</span> <span class="n">cost</span><span class="o">=</span><span class="n">cost_op_coeff</span><span class="p">,</span>\
                                            <span class="n">rho</span><span class="o">=</span><span class="n">rho_coeff</span><span class="p">,</span>  <span class="n">sigma</span><span class="o">=</span><span class="n">sigma_coeff</span><span class="p">,</span> <span class="n">tau</span><span class="o">=</span><span class="n">tau_coeff</span><span class="p">,</span> <span class="n">rho_update</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">sigma_update</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>\
                                            <span class="n">tau_update</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">auto_iterate</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="nb">print</span> <span class="s2">&quot;------------------- Coefficients estimation ----------------------&quot;</span>
        <span class="n">min_coeff</span><span class="o">.</span><span class="n">iterate</span><span class="p">(</span><span class="n">max_iter</span><span class="o">=</span><span class="n">nb_subiter</span><span class="p">)</span> <span class="c1"># ! actually runs optimisation</span>
        <span class="k">if</span> <span class="n">graph_cons_en</span><span class="p">:</span>
            <span class="n">prox_coeff</span><span class="o">.</span><span class="n">reset_iter</span><span class="p">()</span>
            <span class="n">alph</span> <span class="o">=</span> <span class="n">min_coeff</span><span class="o">.</span><span class="n">x_final</span>
            <span class="n">A</span> <span class="o">=</span> <span class="n">alph</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">basis</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">A</span> <span class="o">=</span> <span class="n">min_coeff</span><span class="o">.</span><span class="n">x_final</span>
            <span class="n">dual_var_coeff</span> <span class="o">=</span> <span class="n">min_coeff</span><span class="o">.</span><span class="n">y_final</span>

        <span class="c1"># Parameters update</span>
        <span class="n">polychrom_grad</span><span class="o">.</span><span class="n">set_A</span><span class="p">(</span><span class="n">A</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">wvl_en</span><span class="p">:</span>
            <span class="n">lin_com</span><span class="o">.</span><span class="n">set_A</span><span class="p">(</span><span class="n">A</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">wvl_en</span><span class="p">:</span>
            <span class="c1"># Noise estimate update</span>
            <span class="n">noise_map</span> <span class="o">=</span> <span class="n">get_noise_arr</span><span class="p">(</span><span class="n">lin_com</span><span class="o">.</span><span class="n">op</span><span class="p">(</span><span class="n">polychrom_grad</span><span class="o">.</span><span class="n">MtX</span><span class="p">(</span><span class="n">im_stack</span><span class="p">))[</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">dual_prox_plan</span><span class="o">.</span><span class="n">update_weights</span><span class="p">(</span><span class="n">noise_map</span><span class="p">)</span>

        <span class="c1"># ---- (Re)Setting hyperparameters</span>
        <span class="n">delta</span>  <span class="o">=</span> <span class="p">(</span><span class="n">polychrom_grad</span><span class="o">.</span><span class="n">inv_spec_rad</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="mi">4</span><span class="o">*</span><span class="n">lin_com</span><span class="o">.</span><span class="n">mat_norm</span><span class="o">**</span><span class="mi">2</span>
        <span class="n">w</span> <span class="o">=</span> <span class="mf">0.9</span>
        <span class="n">sigma_P</span> <span class="o">=</span> <span class="n">w</span><span class="o">*</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">delta</span><span class="p">)</span><span class="o">-</span><span class="n">polychrom_grad</span><span class="o">.</span><span class="n">inv_spec_rad</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">lin_com</span><span class="o">.</span><span class="n">mat_norm</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">tau_P</span> <span class="o">=</span> <span class="n">sigma_P</span>
        <span class="n">rho_P</span> <span class="o">=</span> <span class="mi">1</span>

        <span class="c1"># Cost function instance</span>
        <span class="n">condat_min</span> <span class="o">=</span> <span class="n">optimalg</span><span class="o">.</span><span class="n">Condat</span><span class="p">(</span><span class="n">P_stack</span><span class="p">,</span> <span class="n">dual_var_plan</span><span class="p">,</span> <span class="n">polychrom_grad</span><span class="p">,</span> <span class="n">id_prox</span><span class="p">,</span> <span class="n">dual_prox_plan</span><span class="p">,</span> <span class="n">lin_com</span><span class="p">,</span> <span class="n">cost</span><span class="o">=</span><span class="n">cost_op</span><span class="p">,</span>\
                     <span class="n">rho</span><span class="o">=</span><span class="n">rho_P</span><span class="p">,</span>  <span class="n">sigma</span><span class="o">=</span><span class="n">sigma_P</span><span class="p">,</span> <span class="n">tau</span><span class="o">=</span><span class="n">tau_P</span><span class="p">,</span> <span class="n">rho_update</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">sigma_update</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                     <span class="n">tau_update</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">auto_iterate</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="nb">print</span> <span class="s2">&quot;------------------- Transport plans estimation ------------------&quot;</span>

        <span class="n">condat_min</span><span class="o">.</span><span class="n">iterate</span><span class="p">(</span><span class="n">max_iter</span><span class="o">=</span><span class="n">nb_subiter</span><span class="p">)</span> <span class="c1"># ! actually runs optimisation</span>
        <span class="n">P_stack</span> <span class="o">=</span> <span class="n">condat_min</span><span class="o">.</span><span class="n">x_final</span>
        <span class="n">dual_var_plan</span> <span class="o">=</span> <span class="n">condat_min</span><span class="o">.</span><span class="n">y_final</span>

        <span class="c1"># Normalization</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_comp</span><span class="p">):</span>
            <span class="n">l1_P</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">P_stack</span><span class="p">[:,:,</span><span class="n">j</span><span class="p">]))</span>
            <span class="n">P_stack</span><span class="p">[:,:,</span><span class="n">j</span><span class="p">]</span><span class="o">/=</span> <span class="n">l1_P</span>
            <span class="n">A</span><span class="p">[</span><span class="n">j</span><span class="p">,:]</span> <span class="o">*=</span> <span class="n">l1_P</span>
            <span class="k">if</span> <span class="n">graph_cons_en</span><span class="p">:</span>
                <span class="n">alph</span><span class="p">[</span><span class="n">j</span><span class="p">,:]</span> <span class="o">*=</span> <span class="n">l1_P</span>
        <span class="n">polychrom_grad</span><span class="o">.</span><span class="n">set_A</span><span class="p">(</span><span class="n">A</span><span class="p">)</span>
        <span class="c1"># Flux update</span>
        <span class="n">obs_est</span> <span class="o">=</span> <span class="n">polychrom_grad</span><span class="o">.</span><span class="n">MX</span><span class="p">(</span><span class="n">P_stack</span><span class="p">)</span>
        <span class="n">err_ref</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="nb">sum</span><span class="p">((</span><span class="n">obs_est</span><span class="o">-</span><span class="n">im_stack</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">flux_new</span> <span class="o">=</span> <span class="p">(</span><span class="n">obs_est</span><span class="o">*</span><span class="n">im_stack</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span><span class="o">/</span><span class="p">(</span><span class="n">obs_est</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>
        <span class="nb">print</span> <span class="s2">&quot;Flux correction: &quot;</span><span class="p">,</span><span class="n">flux_new</span>
        <span class="n">polychrom_grad</span><span class="o">.</span><span class="n">set_flux</span><span class="p">(</span><span class="n">polychrom_grad</span><span class="o">.</span><span class="n">get_flux</span><span class="p">()</span><span class="o">*</span><span class="n">flux_new</span><span class="p">)</span>
        <span class="n">polychrom_grad_coeff</span><span class="o">.</span><span class="n">set_flux</span><span class="p">(</span><span class="n">polychrom_grad_coeff</span><span class="o">.</span><span class="n">get_flux</span><span class="p">()</span><span class="o">*</span><span class="n">flux_new</span><span class="p">)</span>

        <span class="n">obs_est</span> <span class="o">=</span> <span class="n">polychrom_grad</span><span class="o">.</span><span class="n">MX</span><span class="p">(</span><span class="n">P_stack</span><span class="p">)</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">im_stack</span> <span class="o">-</span> <span class="n">obs_est</span>
        <span class="n">err_rec</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="nb">sum</span><span class="p">(</span><span class="n">res</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
        <span class="nb">print</span> <span class="s2">&quot;err_ref : &quot;</span><span class="p">,</span><span class="n">err_ref</span><span class="p">,</span><span class="s2">&quot; ; err_rec : &quot;</span><span class="p">,</span> <span class="n">err_rec</span>
        <span class="c1"># Computing residual</span>


    <span class="n">psf_est</span> <span class="o">=</span> <span class="n">psf_learning_utils</span><span class="o">.</span><span class="n">field_reconstruction</span><span class="p">(</span><span class="n">P_stack</span><span class="p">,</span><span class="n">shap</span><span class="p">,</span><span class="n">supp</span><span class="p">,</span><span class="n">neighbors_graph</span><span class="p">,</span><span class="n">weights_neighbors</span><span class="p">,</span><span class="n">A</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">psf_est</span><span class="p">,</span><span class="n">P_stack</span><span class="p">,</span><span class="n">A</span><span class="p">,</span><span class="n">res</span></div>


<span class="k">def</span> <span class="nf">test_lsq</span><span class="p">(</span><span class="n">Y</span><span class="p">,</span><span class="n">A</span><span class="p">,</span><span class="n">nb_iter</span><span class="o">=</span><span class="mi">1000</span><span class="p">):</span>
    <span class="n">shap1</span> <span class="o">=</span> <span class="n">Y</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">shap2</span> <span class="o">=</span> <span class="n">A</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">S</span>  <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">shap1</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">shap1</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">shap2</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
    <span class="n">U</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">Vt</span> <span class="o">=</span> <span class="n">linalg</span><span class="o">.</span><span class="n">svd</span><span class="p">(</span><span class="n">A</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">transpose</span><span class="p">(</span><span class="n">A</span><span class="p">)),</span><span class="n">full_matrices</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">spec_rad</span> <span class="o">=</span> <span class="n">s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">cur_est</span>  <span class="o">=</span><span class="kc">None</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_iter</span><span class="p">):</span>
        <span class="n">cur_est</span> <span class="o">=</span> <span class="n">Y</span><span class="o">*</span><span class="mi">0</span>
        <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap1</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
            <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap2</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
                <span class="n">cur_est</span><span class="p">[:,:,</span><span class="n">l</span><span class="p">]</span> <span class="o">+=</span> <span class="n">A</span><span class="p">[</span><span class="n">p</span><span class="p">,</span><span class="n">l</span><span class="p">]</span><span class="o">*</span><span class="n">S</span><span class="p">[:,:,</span><span class="n">p</span><span class="p">]</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">Y</span><span class="o">-</span><span class="n">cur_est</span>
        <span class="nb">print</span> <span class="s1">&#39;residual: &#39;</span><span class="p">,</span><span class="nb">sum</span><span class="p">(</span><span class="n">res</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">grad</span> <span class="o">=</span> <span class="n">S</span><span class="o">*</span><span class="mi">0</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap2</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap1</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
                <span class="n">grad</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">]</span><span class="o">-=</span><span class="n">res</span><span class="p">[:,:,</span><span class="n">j</span><span class="p">]</span><span class="o">*</span><span class="n">A</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span>

        <span class="n">S</span> <span class="o">=</span> <span class="n">S</span> <span class="o">-</span> <span class="n">grad</span><span class="o">/</span><span class="n">spec_rad</span>

    <span class="k">return</span> <span class="n">S</span><span class="p">,</span><span class="n">cur_est</span>


<span class="k">def</span> <span class="nf">low_rank_comp_wise_sparse_dist_dyn_coeff_GFB_m</span><span class="p">(</span><span class="n">psf_stack_in</span><span class="p">,</span><span class="n">field_dist</span><span class="p">,</span><span class="n">upfact</span><span class="p">,</span><span class="n">opt</span><span class="p">,</span><span class="n">nsig</span><span class="p">,</span><span class="n">global_sparsity_en</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">sr_en</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">sparsity_en</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">pix_sparsity</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">redun_fact</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span><span class="n">neigh_frac</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span><span class="n">dist_weight_deg</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">shifts</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">opt_shift_est</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">nsig_shift_est</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">sig_est</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">flux_est</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">nb_iter</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span><span class="n">nb_subiter</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span><span class="n">nb_subiter_min</span><span class="o">=</span><span class="mi">7</span><span class="p">,</span><span class="n">mu</span><span class="o">=</span><span class="mf">1.5</span><span class="p">,</span><span class="n">nb_comp_max</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span><span class="n">tol</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span><span class="n">wvl_transp_cor</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">cv_proof_en</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">line_search_en</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">cond_fact</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span><span class="n">pos_relax</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_subiter_min_2</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span><span class="n">dyn_upload</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">positivity_en</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">score</span><span class="o">=</span><span class="mi">90</span><span class="p">,</span><span class="n">refine</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">robust_refine</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">nsig_hub</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span><span class="n">nb_rw</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">lsq_en</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">shifts_regist</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span><span class="n">wavr_en</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">curv</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>

    <span class="n">shap</span> <span class="o">=</span> <span class="n">psf_stack_in</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">est</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">upfact</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">upfact</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">shap</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span><span class="n">shap</span><span class="p">[</span><span class="mi">4</span><span class="p">]))</span>
    <span class="n">resm</span> <span class="o">=</span>  <span class="n">zeros</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">shap</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span><span class="n">shap</span><span class="p">[</span><span class="mi">4</span><span class="p">]))</span>
    <span class="n">ref_est</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">refine</span><span class="p">:</span>
        <span class="n">ref_est</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">upfact</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">upfact</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">shap</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span><span class="n">shap</span><span class="p">[</span><span class="mi">4</span><span class="p">]))</span>
    <span class="n">no_shifts</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">if</span> <span class="n">shifts</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">no_shifts</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">4</span><span class="p">]):</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">3</span><span class="p">]):</span>
            <span class="nb">print</span> <span class="s2">&quot;==============================================SNR: &quot;</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="s2">&quot;/&quot;</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span><span class="s2">&quot;Field: &quot;</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="s2">&quot;/&quot;</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span><span class="s2">&quot;=======================================================&quot;</span>
            <span class="n">im_hr</span><span class="p">,</span><span class="n">im_hr_curv</span><span class="p">,</span><span class="n">comp</span><span class="p">,</span><span class="n">comp_curv</span><span class="p">,</span><span class="n">weights</span><span class="p">,</span><span class="n">res</span><span class="p">,</span><span class="n">sig_out</span><span class="p">,</span><span class="n">flux_est</span><span class="p">,</span><span class="n">shifts</span><span class="p">,</span><span class="n">alph</span><span class="p">,</span><span class="n">alph_ref</span><span class="p">,</span><span class="n">e_opt</span><span class="p">,</span><span class="n">p_opt</span><span class="p">,</span><span class="n">ker</span><span class="p">,</span><span class="n">supports</span> <span class="o">=</span> <span class="n">low_rank_comp_wise_sparse_dist_dyn_coeff_GFB_joint</span><span class="p">(</span><span class="n">psf_stack_in</span><span class="p">[:,:,:,</span><span class="n">i</span><span class="p">,</span><span class="n">k</span><span class="p">],</span><span class="n">field_dist</span><span class="p">,</span><span class="n">upfact</span><span class="p">,</span><span class="n">opt</span><span class="p">,</span><span class="n">nsig</span><span class="p">,</span><span class="n">global_sparsity_en</span><span class="o">=</span><span class="n">global_sparsity_en</span><span class="p">,</span><span class="n">sr_en</span><span class="o">=</span><span class="n">sr_en</span><span class="p">,</span><span class="n">sparsity_en</span><span class="o">=</span><span class="n">sparsity_en</span><span class="p">,</span><span class="n">pix_sparsity</span><span class="o">=</span><span class="n">pix_sparsity</span><span class="p">,</span><span class="n">redun_fact</span><span class="o">=</span><span class="n">redun_fact</span><span class="p">,</span><span class="n">neigh_frac</span><span class="o">=</span><span class="n">neigh_frac</span><span class="p">,</span><span class="n">dist_weight_deg</span><span class="o">=</span><span class="n">dist_weight_deg</span><span class="p">,</span><span class="n">shifts</span><span class="o">=</span><span class="n">shifts</span><span class="p">,</span><span class="n">opt_shift_est</span><span class="o">=</span><span class="n">opt_shift_est</span><span class="p">,</span><span class="n">nsig_shift_est</span><span class="o">=</span><span class="n">nsig_shift_est</span><span class="p">,</span><span class="n">sig_est</span><span class="o">=</span><span class="n">sig_est</span><span class="p">,</span><span class="n">flux_est</span><span class="o">=</span><span class="n">flux_est</span><span class="p">,</span><span class="n">nb_iter</span><span class="o">=</span><span class="n">nb_iter</span><span class="p">,</span><span class="n">nb_subiter</span><span class="o">=</span><span class="n">nb_subiter</span><span class="o">*</span><span class="mi">2</span><span class="p">,</span><span class="n">nb_subiter_min</span><span class="o">=</span><span class="n">nb_subiter_min</span><span class="p">,</span><span class="n">mu</span><span class="o">=</span><span class="n">mu</span><span class="p">,</span><span class="n">nb_comp_max</span><span class="o">=</span><span class="n">nb_comp_max</span><span class="p">,</span><span class="n">tol</span><span class="o">=</span><span class="n">tol</span><span class="p">,</span><span class="n">wvl_transp_cor</span><span class="o">=</span><span class="n">wvl_transp_cor</span><span class="p">,</span><span class="n">cv_proof_en</span><span class="o">=</span><span class="n">cv_proof_en</span><span class="p">,</span><span class="n">line_search_en</span><span class="o">=</span><span class="n">line_search_en</span><span class="p">,</span><span class="n">cond_fact</span><span class="o">=</span><span class="n">cond_fact</span><span class="p">,</span><span class="n">pos_relax</span><span class="o">=</span><span class="n">pos_relax</span><span class="p">,</span><span class="n">nb_subiter_min_2</span><span class="o">=</span><span class="n">nb_subiter_min_2</span><span class="p">,</span><span class="n">dyn_upload</span><span class="o">=</span><span class="n">dyn_upload</span><span class="p">,</span><span class="n">positivity_en</span><span class="o">=</span><span class="n">positivity_en</span><span class="p">,</span><span class="n">score</span><span class="o">=</span><span class="n">score</span><span class="p">,</span><span class="n">refine</span><span class="o">=</span><span class="n">refine</span><span class="p">,</span><span class="n">robust_refine</span><span class="o">=</span><span class="n">robust_refine</span><span class="p">,</span><span class="n">nsig_hub</span><span class="o">=</span><span class="n">nsig_hub</span><span class="p">,</span><span class="n">nb_rw</span><span class="o">=</span><span class="n">nb_rw</span><span class="p">,</span><span class="n">lsq_en</span><span class="o">=</span><span class="n">lsq_en</span><span class="p">,</span><span class="n">shifts_regist</span> <span class="o">=</span> <span class="n">shifts_regist</span><span class="p">,</span><span class="n">wavr_en</span><span class="o">=</span><span class="n">wavr_en</span><span class="p">,</span><span class="n">curv</span><span class="o">=</span><span class="n">curv</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">no_shifts</span><span class="p">:</span>
                <span class="n">shifts</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">est</span><span class="p">[:,:,:,</span><span class="n">i</span><span class="p">,</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">im_hr</span>
            <span class="n">resm</span><span class="p">[:,:,:,</span><span class="n">i</span><span class="p">,</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">res</span>



    <span class="k">return</span> <span class="n">est</span><span class="p">,</span><span class="n">resm</span>

<span class="k">def</span> <span class="nf">low_rank_comp_wise_sparse_dist_dyn_coeff_GFB_m2</span><span class="p">(</span><span class="n">psf_stack_in</span><span class="p">,</span><span class="n">field_dist</span><span class="p">,</span><span class="n">upfact</span><span class="p">,</span><span class="n">opt</span><span class="p">,</span><span class="n">nsig</span><span class="p">,</span><span class="n">global_sparsity_en</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">sr_en</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">sparsity_en</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">pix_sparsity</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">redun_fact</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span><span class="n">neigh_frac</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span><span class="n">dist_weight_deg</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">shifts_arr</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">opt_shift_est</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">nsig_shift_est</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">sig_est</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">flux_est</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">nb_iter</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span><span class="n">nb_subiter</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span><span class="n">nb_subiter_min</span><span class="o">=</span><span class="mi">7</span><span class="p">,</span><span class="n">mu</span><span class="o">=</span><span class="mf">1.5</span><span class="p">,</span><span class="n">nb_comp_max</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span><span class="n">tol</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span><span class="n">wvl_transp_cor</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">cv_proof_en</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">line_search_en</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">cond_fact</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span><span class="n">pos_relax</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_subiter_min_2</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span><span class="n">dyn_upload</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">positivity_en</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">score</span><span class="o">=</span><span class="mi">90</span><span class="p">,</span><span class="n">refine</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">robust_refine</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">nsig_hub</span><span class="o">=</span><span class="mi">5</span><span class="p">):</span>

    <span class="n">shap</span> <span class="o">=</span> <span class="n">psf_stack_in</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">shap2</span> <span class="o">=</span> <span class="n">shifts_arr</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">est</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">upfact</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">upfact</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">shap2</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>

    <span class="n">ref_est</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">refine</span><span class="p">:</span>
        <span class="n">ref_est</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">upfact</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">upfact</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">shap2</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>


    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap2</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
        <span class="nb">print</span> <span class="s2">&quot;==============================================&quot;</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="s2">&quot;/&quot;</span><span class="p">,</span><span class="n">shap2</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="s2">&quot;=======================================================&quot;</span>
        <span class="n">im_hr</span><span class="p">,</span><span class="n">ref_im_hr</span><span class="p">,</span><span class="n">comp</span><span class="p">,</span><span class="n">ref_comp</span><span class="p">,</span><span class="n">weights</span><span class="p">,</span><span class="n">ref_weights</span><span class="p">,</span><span class="n">res</span><span class="p">,</span><span class="n">ref_res</span><span class="p">,</span><span class="n">sig_out</span><span class="p">,</span><span class="n">flux_est</span><span class="p">,</span><span class="n">shifts</span><span class="p">,</span><span class="n">compz1</span><span class="p">,</span><span class="n">compz2</span><span class="p">,</span><span class="n">res_inter_comp</span><span class="p">,</span><span class="n">detect_flag</span> <span class="o">=</span> <span class="n">low_rank_comp_wise_sparse_dist_dyn_coeff_GFB</span><span class="p">(</span><span class="n">psf_stack_in</span><span class="p">,</span><span class="n">field_dist</span><span class="p">,</span><span class="n">upfact</span><span class="p">,</span><span class="n">opt</span><span class="p">,</span><span class="n">nsig</span><span class="p">,</span><span class="n">global_sparsity_en</span><span class="o">=</span><span class="n">global_sparsity_en</span><span class="p">,</span><span class="n">sr_en</span><span class="o">=</span><span class="n">sr_en</span><span class="p">,</span><span class="n">sparsity_en</span><span class="o">=</span><span class="n">sparsity_en</span><span class="p">,</span><span class="n">pix_sparsity</span><span class="o">=</span><span class="n">pix_sparsity</span><span class="p">,</span><span class="n">redun_fact</span><span class="o">=</span><span class="n">redun_fact</span><span class="p">,</span><span class="n">neigh_frac</span><span class="o">=</span><span class="n">neigh_frac</span><span class="p">,</span><span class="n">dist_weight_deg</span><span class="o">=</span><span class="n">dist_weight_deg</span><span class="p">,</span><span class="n">shifts</span><span class="o">=</span><span class="n">shifts_arr</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">],</span><span class="n">opt_shift_est</span><span class="o">=</span><span class="n">opt_shift_est</span><span class="p">,</span><span class="n">nsig_shift_est</span><span class="o">=</span><span class="n">nsig_shift_est</span><span class="p">,</span><span class="n">sig_est</span><span class="o">=</span><span class="n">sig_est</span><span class="p">,</span><span class="n">flux_est</span><span class="o">=</span><span class="n">flux_est</span><span class="p">,</span><span class="n">nb_iter</span><span class="o">=</span><span class="n">nb_iter</span><span class="p">,</span><span class="n">nb_subiter</span><span class="o">=</span><span class="n">nb_subiter</span><span class="p">,</span><span class="n">nb_subiter_min</span><span class="o">=</span><span class="n">nb_subiter_min</span><span class="p">,</span><span class="n">mu</span><span class="o">=</span><span class="n">mu</span><span class="p">,</span><span class="n">nb_comp_max</span><span class="o">=</span><span class="n">nb_comp_max</span><span class="p">,</span><span class="n">tol</span><span class="o">=</span><span class="n">tol</span><span class="p">,</span><span class="n">wvl_transp_cor</span><span class="o">=</span><span class="n">wvl_transp_cor</span><span class="p">,</span><span class="n">cv_proof_en</span><span class="o">=</span><span class="n">cv_proof_en</span><span class="p">,</span><span class="n">line_search_en</span><span class="o">=</span><span class="n">line_search_en</span><span class="p">,</span><span class="n">cond_fact</span><span class="o">=</span><span class="n">cond_fact</span><span class="p">,</span><span class="n">pos_relax</span><span class="o">=</span><span class="n">pos_relax</span><span class="p">,</span><span class="n">nb_subiter_min_2</span><span class="o">=</span><span class="n">nb_subiter_min_2</span><span class="p">,</span><span class="n">dyn_upload</span><span class="o">=</span><span class="n">dyn_upload</span><span class="p">,</span><span class="n">positivity_en</span><span class="o">=</span><span class="n">positivity_en</span><span class="p">,</span><span class="n">score</span><span class="o">=</span><span class="n">score</span><span class="p">,</span><span class="n">refine</span><span class="o">=</span><span class="n">refine</span><span class="p">,</span><span class="n">robust_refine</span><span class="o">=</span><span class="n">robust_refine</span><span class="p">,</span><span class="n">nsig_hub</span><span class="o">=</span><span class="n">nsig_hub</span><span class="p">)</span>

        <span class="n">est</span><span class="p">[:,:,:,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">im_hr</span>
        <span class="k">if</span> <span class="n">refine</span><span class="p">:</span>
            <span class="n">ref_est</span><span class="p">[:,:,:,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">ref_im_hr</span>

    <span class="k">return</span> <span class="n">est</span><span class="p">,</span><span class="n">ref_est</span>

<span class="k">def</span> <span class="nf">low_rank_comp_wise_sparse_dist_dyn_coeff_GFB_fast</span><span class="p">(</span><span class="n">psf_stack_in</span><span class="p">,</span><span class="n">field_dist</span><span class="p">,</span><span class="n">upfact</span><span class="p">,</span><span class="n">opt</span><span class="p">,</span><span class="n">nsig</span><span class="p">,</span><span class="n">neigh_frac</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span><span class="n">dist_weight_deg</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">shifts</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">opt_shift_est</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">nsig_shift_est</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">sig_est</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">flux_est</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">nb_iter</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span><span class="n">redun_fact</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">nb_subiter</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span><span class="n">nb_subiter_min</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span><span class="n">mu</span><span class="o">=</span><span class="mf">1.5</span><span class="p">,</span><span class="n">nb_comp_max</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span><span class="n">tol</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span><span class="n">wvl_transp_cor</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">cv_proof_en</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">line_search_en</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">cond_fact</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span><span class="n">pos_relax</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">ortho_en</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">ortho_en_strong</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span> <span class="c1"># Representations coefficietns are updated in all the components loops</span>
    <span class="k">if</span> <span class="n">ortho_en</span> <span class="ow">and</span> <span class="n">ortho_en_strong</span><span class="p">:</span>
        <span class="n">ortho_en</span><span class="o">=</span><span class="kc">False</span>
    <span class="n">psf_stack</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">psf_stack_in</span><span class="p">)</span>
    <span class="nb">print</span> <span class="s2">&quot;Minimiser: GFB&quot;</span>
    <span class="c1"># Degradation operator parameters estimation</span>
    <span class="k">if</span> <span class="n">shifts</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1">#shifts = utils.shift_est(psf_stack)*upfact</span>
        <span class="n">shifts</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">wvl_shift_est</span><span class="p">(</span><span class="n">psf_stack</span><span class="p">,</span><span class="n">opt_shift_est</span><span class="p">,</span><span class="n">nsig_shift_est</span><span class="p">)</span><span class="o">*</span><span class="n">upfact</span>
    <span class="n">shift_ker_stack</span><span class="p">,</span><span class="n">shift_ker_stack_adj</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">shift_ker_stack</span><span class="p">(</span><span class="n">shifts</span><span class="p">,</span><span class="n">upfact</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">sig_est</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">sig_est</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">im_gauss_nois_est_cube</span><span class="p">(</span><span class="n">psf_stack_in</span><span class="p">,</span><span class="n">opt</span><span class="o">=</span><span class="n">opt_shift_est</span><span class="p">)</span>
    <span class="n">sig_min</span> <span class="o">=</span> <span class="n">sig_est</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
    <span class="n">sig_est</span> <span class="o">=</span> <span class="n">sig_est</span><span class="o">/</span><span class="n">sig_min</span>
    <span class="n">shap</span> <span class="o">=</span> <span class="n">psf_stack</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">nb_im</span> <span class="o">=</span> <span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
        <span class="n">psf_stack</span><span class="p">[:,:,</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">psf_stack</span><span class="p">[:,:,</span><span class="n">k</span><span class="p">]</span><span class="o">/</span><span class="n">sig_est</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
    <span class="nb">print</span> <span class="s2">&quot; ------ ref energy: &quot;</span><span class="p">,(</span><span class="n">psf_stack</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(),</span><span class="s2">&quot; ------- &quot;</span>
    <span class="k">if</span> <span class="n">flux_est</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">flux_est</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">flux_estimate_stack</span><span class="p">(</span><span class="n">psf_stack_in</span><span class="p">,</span><span class="n">rad</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
    <span class="n">flux_ref</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">flux_est</span><span class="p">)</span>
    <span class="n">weights</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">w</span> <span class="o">=</span> <span class="n">ones</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">],))</span>
    <span class="n">im_hr</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">upfact</span><span class="o">*</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">upfact</span><span class="o">*</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>

    <span class="c1"># Distances settings</span>
    <span class="nb">print</span> <span class="s2">&quot;Contructing PSF tree...&quot;</span>
    <span class="n">nb_neighs</span> <span class="o">=</span> <span class="n">redun_fact</span><span class="o">*</span><span class="n">upfact</span><span class="o">**</span><span class="mi">2</span>
    <span class="n">neigh</span><span class="p">,</span><span class="n">dists</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">knn_interf</span><span class="p">(</span><span class="n">field_dist</span><span class="p">,</span><span class="n">nb_neighs</span><span class="p">)</span>
    <span class="n">p_max</span> <span class="o">=</span> <span class="n">pow_law_select</span><span class="p">(</span><span class="n">dists</span><span class="p">,</span><span class="n">nb_neighs</span><span class="p">)</span>
    <span class="nb">print</span> <span class="s2">&quot;power max = &quot;</span><span class="p">,</span><span class="n">p_max</span>
    <span class="n">p_min</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="nb">print</span> <span class="s2">&quot;Done...&quot;</span>
    <span class="n">dists</span> <span class="o">=</span> <span class="n">dists</span>
    <span class="n">dist_med</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">dists</span><span class="p">)</span>
    <span class="n">dist_weights</span> <span class="o">=</span> <span class="p">(</span><span class="n">dist_med</span><span class="o">/</span><span class="n">dists</span><span class="p">)</span><span class="o">**</span><span class="n">dist_weight_deg</span>
    <span class="n">dist_weigths</span> <span class="o">=</span> <span class="n">dist_weights</span><span class="o">/</span><span class="n">dist_weights</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
    <span class="c1"># Spatial smoothing operator gradient lip constant estimation</span>
    <span class="n">spec_rad_smooth</span> <span class="o">=</span> <span class="kc">None</span>


    <span class="n">siz_in</span> <span class="o">=</span> <span class="n">upfact</span><span class="o">*</span><span class="n">array</span><span class="p">(</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">eig_max</span> <span class="o">=</span> <span class="kc">None</span>


    <span class="c1"># GFB variables</span>
    <span class="nb">input</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">upfact</span><span class="o">*</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">upfact</span><span class="o">*</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
    <span class="nb">input</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="nb">input</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">upfact</span><span class="p">)</span>
    <span class="nb">input</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">shift_ker_stack</span><span class="p">)</span>
    <span class="nb">input</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">shift_ker_stack_adj</span><span class="p">)</span>
    <span class="n">w</span> <span class="o">=</span> <span class="n">ones</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">],))</span>
    <span class="n">im_hr</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">upfact</span><span class="o">*</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">upfact</span><span class="o">*</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>
    <span class="nb">input</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">copy</span><span class="p">(</span><span class="n">w</span><span class="p">))</span>
    <span class="nb">input</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sig_est</span><span class="p">)</span>
    <span class="nb">input</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">flux_est</span><span class="p">)</span>
    <span class="n">comp</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">upfact</span><span class="o">*</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">upfact</span><span class="o">*</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">nb_comp_max</span><span class="p">))</span> <span class="c1"># Main variable</span>
    <span class="n">comp_sp</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">upfact</span><span class="o">*</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">upfact</span><span class="o">*</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">nb_comp_max</span><span class="p">))</span> <span class="c1"># Main variable</span>
    <span class="n">comp_old</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">upfact</span><span class="o">*</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">upfact</span><span class="o">*</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
    <span class="n">z11</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">upfact</span><span class="o">*</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">upfact</span><span class="o">*</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span> <span class="c1"># Positive variable</span>
    <span class="n">z12</span><span class="p">,</span><span class="n">mr_file</span> <span class="o">=</span> <span class="n">isap</span><span class="o">.</span><span class="n">mr_trans</span><span class="p">(</span><span class="n">z11</span><span class="p">,</span><span class="n">opt</span><span class="o">=</span><span class="n">opt</span><span class="p">)</span> <span class="c1"># Sparse variable</span>
    <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">mr_file</span><span class="p">)</span>
    <span class="n">z21</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">upfact</span><span class="o">*</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">upfact</span><span class="o">*</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span> <span class="c1"># Bonding variables</span>
    <span class="n">z22</span><span class="p">,</span><span class="n">mr_file</span> <span class="o">=</span> <span class="n">isap</span><span class="o">.</span><span class="n">mr_trans</span><span class="p">(</span><span class="n">z11</span><span class="p">,</span><span class="n">opt</span><span class="o">=</span><span class="n">opt</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">mr_file</span><span class="p">)</span>
    <span class="n">x2</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">z22</span><span class="p">)</span> <span class="c1"># Main variable second group of components</span>
    <span class="n">compz1</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">upfact</span><span class="o">*</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">upfact</span><span class="o">*</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">nb_comp_max</span><span class="p">))</span> <span class="c1"># Main variable</span>
    <span class="n">compz2</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">upfact</span><span class="o">*</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">upfact</span><span class="o">*</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">nb_comp_max</span><span class="p">))</span> <span class="c1"># Main variable</span>
    <span class="n">w1</span> <span class="o">=</span> <span class="mf">0.5</span>
    <span class="n">w2</span> <span class="o">=</span> <span class="mf">0.5</span>
    <span class="n">w_pos</span> <span class="o">=</span> <span class="mf">0.5</span>
    <span class="n">w_sp</span> <span class="o">=</span> <span class="mi">1</span><span class="o">-</span><span class="n">w_pos</span>
    <span class="n">lambd</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">grad</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">upfact</span><span class="o">*</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">upfact</span><span class="o">*</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
    <span class="n">gradsp_temp</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">upfact</span><span class="o">*</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">upfact</span><span class="o">*</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
    <span class="n">grad_sp</span> <span class="o">=</span> <span class="n">z22</span><span class="o">*</span><span class="mi">0</span>
    <span class="n">u</span><span class="p">,</span><span class="n">mr_file</span> <span class="o">=</span> <span class="n">isap</span><span class="o">.</span><span class="n">mr_trans</span><span class="p">(</span><span class="n">comp</span><span class="p">[:,:,</span><span class="mi">0</span><span class="p">],</span><span class="n">opt</span><span class="o">=</span><span class="n">opt</span><span class="p">)</span>
    <span class="n">shap2</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">weights_sp</span> <span class="o">=</span> <span class="n">ones</span><span class="p">((</span><span class="n">shap2</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">shap2</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">shap2</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">psf_stack</span><span class="p">)</span>

    <span class="n">comp_lr</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">nb_comp_max</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>
    <span class="n">comp_hr_i</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">upfact</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">upfact</span><span class="p">,</span><span class="n">nb_comp_max</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>
    <span class="n">comp_lr_i_stack</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">upfact</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">upfact</span><span class="p">,</span><span class="n">nb_comp_max</span><span class="o">*</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>
    <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">buff</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">nb_subiter_min</span><span class="p">))</span>
    <span class="n">buffsp</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">nb_subiter_min</span><span class="p">))</span>
    <span class="n">nb_iter_noisest</span> <span class="o">=</span> <span class="mi">20</span>
    <span class="n">thresh_type</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">noise_vect_1</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">sig_map</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">cur_res</span><span class="o">=</span><span class="mf">100000000.0</span>
    <span class="n">res_old</span><span class="o">=</span><span class="mf">1000000000.0</span>
    <span class="n">cur_res_comp</span><span class="o">=</span><span class="mf">100000000.0</span>
    <span class="n">res_old_comp</span><span class="o">=</span><span class="mf">1000000000.0</span>
    <span class="n">res_inter_comp</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">(</span><span class="n">nb_comp_max</span><span class="p">)</span>
    <span class="n">weights_init</span><span class="o">=</span><span class="kc">None</span>
    <span class="n">p_smth_mat_inv</span><span class="o">=</span><span class="kc">None</span>
    <span class="n">to</span><span class="o">=</span><span class="kc">None</span>
    <span class="nb">print</span> <span class="s2">&quot; ------ ref energy: &quot;</span><span class="p">,(</span><span class="n">psf_stack</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(),</span><span class="s2">&quot; ------- &quot;</span>
    <span class="n">pows</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">nb_comp_max</span><span class="p">))</span>
    <span class="n">min_val_map</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">ortho_mat</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">while</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">nb_comp_max</span> <span class="p">:</span><span class="c1">#and 100*abs(cur_res_comp-res_old_comp)/cur_res_comp&gt;0.001:</span>
        <span class="k">if</span> <span class="n">i</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
            <span class="n">pows</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">=</span><span class="n">p_min</span> <span class="c1"># =1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">pows</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">=</span> <span class="p">(</span><span class="n">pows</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">p_max</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span>
        <span class="n">dist_weights_in</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">nb_im</span><span class="p">,</span><span class="n">nb_neighs</span><span class="p">,</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">ind</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
            <span class="n">dist_weights_in</span><span class="p">[:,:,</span><span class="n">ind</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">dist_med</span><span class="o">/</span><span class="n">dists</span><span class="p">)</span><span class="o">**</span><span class="n">pows</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span>
            <span class="n">dist_weights_in</span><span class="p">[:,:,</span><span class="n">ind</span><span class="p">]</span> <span class="o">=</span> <span class="n">dist_weights_in</span><span class="p">[:,:,</span><span class="n">ind</span><span class="p">]</span><span class="o">/</span><span class="p">(</span><span class="n">dist_weights_in</span><span class="p">[:,:,</span><span class="n">ind</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span>

        <span class="k">if</span> <span class="n">i</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
            <span class="n">w</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">abs_val_reverting</span><span class="p">(</span><span class="n">weights</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">,:])</span>

        <span class="n">resk</span> <span class="o">=</span> <span class="n">res</span><span class="o">*</span><span class="mi">0</span>
        <span class="n">resk_sp</span> <span class="o">=</span> <span class="n">res</span><span class="o">*</span><span class="mi">0</span>
        <span class="n">weights_sp</span> <span class="o">=</span> <span class="n">ones</span><span class="p">((</span><span class="n">shap2</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">shap2</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">shap2</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>

        <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">weights_init</span><span class="o">=</span><span class="kc">None</span>
        <span class="n">p_smth_mat_inv</span><span class="o">=</span><span class="kc">None</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_iter</span><span class="p">):</span>
            <span class="c1"># Direction initialization</span>
            <span class="k">if</span> <span class="n">k</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">i</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
                    <span class="n">comp</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">pos_proj_mat</span><span class="p">(</span><span class="n">sr_op_trans_stack_pseudo_inv</span><span class="p">(</span><span class="n">res</span><span class="p">,</span><span class="n">shift_ker_stack</span><span class="p">,</span><span class="n">shift_ker_stack_adj</span><span class="p">,</span><span class="n">upfact</span><span class="p">,</span><span class="n">utils</span><span class="o">.</span><span class="n">vect_recond</span><span class="p">(</span><span class="n">w</span><span class="p">,</span><span class="n">cond_fact</span><span class="p">),</span><span class="n">utils</span><span class="o">.</span><span class="n">vect_recond</span><span class="p">(</span><span class="n">sig_est</span><span class="p">,</span><span class="n">cond_fact</span><span class="p">),</span><span class="n">utils</span><span class="o">.</span><span class="n">vect_recond</span><span class="p">(</span><span class="n">flux_est</span><span class="p">,</span><span class="n">cond_fact</span><span class="p">),</span><span class="mi">15</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">comp</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">sr_op_trans_stack_pseudo_inv</span><span class="p">(</span><span class="n">res</span><span class="p">,</span><span class="n">shift_ker_stack</span><span class="p">,</span><span class="n">shift_ker_stack_adj</span><span class="p">,</span><span class="n">upfact</span><span class="p">,</span><span class="n">utils</span><span class="o">.</span><span class="n">vect_recond</span><span class="p">(</span><span class="n">w</span><span class="p">,</span><span class="n">cond_fact</span><span class="p">),</span><span class="n">utils</span><span class="o">.</span><span class="n">vect_recond</span><span class="p">(</span><span class="n">sig_est</span><span class="p">,</span><span class="n">cond_fact</span><span class="p">),</span><span class="n">utils</span><span class="o">.</span><span class="n">vect_recond</span><span class="p">(</span><span class="n">flux_est</span><span class="p">,</span><span class="n">cond_fact</span><span class="p">),</span><span class="mi">15</span><span class="p">)</span>
            <span class="n">t</span><span class="o">=</span><span class="mi">1</span>
            <span class="n">comp</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">comp</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">]</span><span class="o">/</span><span class="n">sqrt</span><span class="p">((</span><span class="n">comp</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span>

            <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
                <span class="n">comp_lr</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">,</span><span class="n">l</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">flux_ref</span><span class="o">/</span><span class="p">(</span><span class="n">sig_est</span><span class="p">[</span><span class="n">l</span><span class="p">]</span><span class="o">*</span><span class="n">flux_est</span><span class="p">[</span><span class="n">l</span><span class="p">]))</span><span class="o">*</span><span class="n">utils</span><span class="o">.</span><span class="n">decim</span><span class="p">(</span><span class="n">scisig</span><span class="o">.</span><span class="n">fftconvolve</span><span class="p">(</span><span class="n">comp</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">],</span><span class="n">shift_ker_stack</span><span class="p">[:,:,</span><span class="n">l</span><span class="p">],</span><span class="n">mode</span><span class="o">=</span><span class="s1">&#39;same&#39;</span><span class="p">),</span><span class="n">upfact</span><span class="p">,</span><span class="n">av_en</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>


            <span class="nb">print</span> <span class="s2">&quot; ------ ref energy: &quot;</span><span class="p">,(</span><span class="n">psf_stack</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(),</span><span class="s2">&quot; ------- &quot;</span>
            <span class="k">if</span> <span class="n">k</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
                <span class="n">weights</span><span class="p">,</span><span class="n">min_val_map</span> <span class="o">=</span> <span class="n">non_unif_smoothing_mult_coeff_pos_cp_2</span><span class="p">(</span><span class="n">psf_stack</span><span class="p">,</span><span class="n">comp_lr</span><span class="p">[:,:,</span><span class="mi">0</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,:],</span><span class="n">comp</span><span class="p">[:,:,</span><span class="mi">0</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">],</span><span class="n">neigh</span><span class="p">,</span><span class="n">dist_weights_in</span><span class="p">,</span><span class="n">p_smth_mat_inv</span><span class="o">=</span><span class="n">p_smth_mat_inv</span><span class="p">,</span><span class="n">to</span><span class="o">=</span><span class="n">to</span><span class="p">,</span><span class="n">nb_iter</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span><span class="n">tol</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">weights</span><span class="p">,</span><span class="n">min_val_map</span> <span class="o">=</span> <span class="n">non_unif_smoothing_mult_coeff_pos_cp_2</span><span class="p">(</span><span class="n">psf_stack</span><span class="p">,</span><span class="n">comp_lr</span><span class="p">[:,:,</span><span class="mi">0</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,:],</span><span class="n">comp</span><span class="p">[:,:,</span><span class="mi">0</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">],</span><span class="n">neigh</span><span class="p">,</span><span class="n">dist_weights_in</span><span class="p">,</span><span class="n">p_smth_mat_inv</span><span class="o">=</span><span class="n">p_smth_mat_inv</span><span class="p">,</span><span class="n">to</span><span class="o">=</span><span class="n">to</span><span class="p">,</span><span class="n">nb_iter</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span><span class="n">tol</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span><span class="n">Ainit</span><span class="o">=</span><span class="n">weights</span><span class="p">)</span>

            <span class="n">w</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">weights</span><span class="p">[</span><span class="n">i</span><span class="p">,:])</span>
            <span class="n">im_hr</span> <span class="o">=</span> <span class="mi">0</span><span class="o">*</span><span class="n">im_hr</span>
            <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
                <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">i</span><span class="p">):</span>
                    <span class="n">im_hr</span><span class="p">[:,:,</span><span class="n">l</span><span class="p">]</span> <span class="o">=</span> <span class="n">im_hr</span><span class="p">[:,:,</span><span class="n">l</span><span class="p">]</span><span class="o">+</span><span class="n">weights</span><span class="p">[</span><span class="n">p</span><span class="p">,</span><span class="n">l</span><span class="p">]</span><span class="o">*</span><span class="n">comp</span><span class="p">[:,:,</span><span class="n">p</span><span class="p">]</span>
                <span class="n">res</span><span class="p">[:,:,</span><span class="n">l</span><span class="p">]</span> <span class="o">=</span> <span class="n">psf_stack</span><span class="p">[:,:,</span><span class="n">l</span><span class="p">]</span><span class="o">-</span><span class="p">(</span><span class="n">flux_ref</span><span class="o">/</span><span class="p">(</span><span class="n">sig_est</span><span class="p">[</span><span class="n">l</span><span class="p">]</span><span class="o">*</span><span class="n">flux_est</span><span class="p">[</span><span class="n">l</span><span class="p">]))</span><span class="o">*</span><span class="n">utils</span><span class="o">.</span><span class="n">decim</span><span class="p">(</span><span class="n">scisig</span><span class="o">.</span><span class="n">fftconvolve</span><span class="p">(</span><span class="n">im_hr</span><span class="p">[:,:,</span><span class="n">l</span><span class="p">],</span><span class="n">shift_ker_stack</span><span class="p">[:,:,</span><span class="n">l</span><span class="p">],</span><span class="n">mode</span><span class="o">=</span><span class="s1">&#39;same&#39;</span><span class="p">),</span><span class="n">upfact</span><span class="p">,</span><span class="n">av_en</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>


            <span class="nb">print</span> <span class="s2">&quot;------------------- Component &quot;</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="s2">&quot; ------------------&quot;</span>
            <span class="nb">print</span> <span class="s2">&quot;weights: &quot;</span><span class="p">,</span><span class="n">w</span>
            <span class="nb">input</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">=</span><span class="n">w</span>
            <span class="c1"># Spectral radius</span>
            <span class="n">eig_max</span><span class="p">,</span><span class="n">spec_rad</span> <span class="o">=</span> <span class="n">pow_meth</span><span class="p">(</span><span class="n">sr_op_trans_stack</span><span class="p">,</span><span class="nb">input</span><span class="p">,</span><span class="n">siz_in</span><span class="p">,</span><span class="n">ainit</span><span class="o">=</span><span class="n">eig_max</span><span class="p">)</span>


            <span class="c1"># ith component estimation</span>
            <span class="n">j</span><span class="o">=</span><span class="mi">0</span>
            <span class="c1">#print &#39;--------------- &#39;,nb_subiter,&#39; ----------------&#39;</span>
            <span class="n">res_old</span> <span class="o">=</span> <span class="n">cur_res</span><span class="o">*</span><span class="mi">2</span>
            <span class="k">while</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">nb_subiter</span> <span class="ow">and</span> <span class="mi">100</span><span class="o">*</span><span class="nb">abs</span><span class="p">(</span><span class="n">cur_res</span><span class="o">-</span><span class="n">res_old</span><span class="p">)</span><span class="o">/</span><span class="n">res_old</span><span class="o">&gt;</span><span class="mf">0.001</span><span class="p">:</span>
                <span class="n">res_old</span> <span class="o">=</span> <span class="n">cur_res</span>
                <span class="c1"># Residual computation</span>
                <span class="n">grad</span> <span class="o">=</span> <span class="n">grad</span><span class="o">*</span><span class="mi">0</span>
                <span class="n">gradsp_temp</span> <span class="o">=</span> <span class="n">gradsp_temp</span><span class="o">*</span><span class="mi">0</span>
                <span class="k">if</span> <span class="n">j</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
                        <span class="n">resk</span><span class="p">[:,:,</span><span class="n">l</span><span class="p">]</span> <span class="o">=</span> <span class="n">res</span><span class="p">[:,:,</span><span class="n">l</span><span class="p">]</span><span class="o">-</span><span class="p">(</span><span class="n">w</span><span class="p">[</span><span class="n">l</span><span class="p">]</span><span class="o">*</span><span class="n">flux_ref</span><span class="o">/</span><span class="p">(</span><span class="n">sig_est</span><span class="p">[</span><span class="n">l</span><span class="p">]</span><span class="o">*</span><span class="n">flux_est</span><span class="p">[</span><span class="n">l</span><span class="p">]))</span><span class="o">*</span><span class="n">utils</span><span class="o">.</span><span class="n">decim</span><span class="p">(</span><span class="n">scisig</span><span class="o">.</span><span class="n">fftconvolve</span><span class="p">(</span><span class="n">comp</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">],</span><span class="n">shift_ker_stack</span><span class="p">[:,:,</span><span class="n">l</span><span class="p">],</span><span class="n">mode</span><span class="o">=</span><span class="s1">&#39;same&#39;</span><span class="p">),</span><span class="n">upfact</span><span class="p">,</span><span class="n">av_en</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                        <span class="n">grad</span> <span class="o">=</span> <span class="n">grad</span><span class="o">-</span><span class="n">w_pos</span><span class="o">*</span><span class="p">(</span><span class="n">w</span><span class="p">[</span><span class="n">l</span><span class="p">]</span><span class="o">*</span><span class="n">flux_ref</span><span class="o">/</span><span class="p">(</span><span class="n">sig_est</span><span class="p">[</span><span class="n">l</span><span class="p">]</span><span class="o">*</span><span class="n">flux_est</span><span class="p">[</span><span class="n">l</span><span class="p">]))</span><span class="o">*</span><span class="n">scisig</span><span class="o">.</span><span class="n">convolve</span><span class="p">(</span><span class="n">utils</span><span class="o">.</span><span class="n">transpose_decim</span><span class="p">(</span><span class="n">resk</span><span class="p">[:,:,</span><span class="n">l</span><span class="p">],</span><span class="n">upfact</span><span class="p">),</span><span class="n">shift_ker_stack_adj</span><span class="p">[:,:,</span><span class="n">l</span><span class="p">],</span><span class="n">mode</span><span class="o">=</span><span class="s1">&#39;same&#39;</span><span class="p">)</span>
                        <span class="n">comp_sp</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">isap</span><span class="o">.</span><span class="n">mr_recons_coeff</span><span class="p">(</span><span class="n">x2</span><span class="p">,</span><span class="n">mr_file</span><span class="p">)</span>
                        <span class="n">resk_sp</span><span class="p">[:,:,</span><span class="n">l</span><span class="p">]</span> <span class="o">=</span> <span class="n">res</span><span class="p">[:,:,</span><span class="n">l</span><span class="p">]</span><span class="o">-</span><span class="p">(</span><span class="n">w</span><span class="p">[</span><span class="n">l</span><span class="p">]</span><span class="o">*</span><span class="n">flux_ref</span><span class="o">/</span><span class="p">(</span><span class="n">sig_est</span><span class="p">[</span><span class="n">l</span><span class="p">]</span><span class="o">*</span><span class="n">flux_est</span><span class="p">[</span><span class="n">l</span><span class="p">]))</span><span class="o">*</span><span class="n">utils</span><span class="o">.</span><span class="n">decim</span><span class="p">(</span><span class="n">scisig</span><span class="o">.</span><span class="n">fftconvolve</span><span class="p">(</span><span class="n">comp_sp</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">],</span><span class="n">shift_ker_stack</span><span class="p">[:,:,</span><span class="n">l</span><span class="p">],</span><span class="n">mode</span><span class="o">=</span><span class="s1">&#39;same&#39;</span><span class="p">),</span><span class="n">upfact</span><span class="p">,</span><span class="n">av_en</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                        <span class="n">gradsp_temp</span> <span class="o">=</span> <span class="n">gradsp_temp</span><span class="o">-</span><span class="n">w_sp</span><span class="o">*</span><span class="p">(</span><span class="n">w</span><span class="p">[</span><span class="n">l</span><span class="p">]</span><span class="o">*</span><span class="n">flux_ref</span><span class="o">/</span><span class="p">(</span><span class="n">sig_est</span><span class="p">[</span><span class="n">l</span><span class="p">]</span><span class="o">*</span><span class="n">flux_est</span><span class="p">[</span><span class="n">l</span><span class="p">]))</span><span class="o">*</span><span class="n">scisig</span><span class="o">.</span><span class="n">convolve</span><span class="p">(</span><span class="n">utils</span><span class="o">.</span><span class="n">transpose_decim</span><span class="p">(</span><span class="n">resk_sp</span><span class="p">[:,:,</span><span class="n">l</span><span class="p">],</span><span class="n">upfact</span><span class="p">),</span><span class="n">shift_ker_stack_adj</span><span class="p">[:,:,</span><span class="n">l</span><span class="p">],</span><span class="n">mode</span><span class="o">=</span><span class="s1">&#39;same&#39;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
                        <span class="n">grad</span> <span class="o">=</span> <span class="n">grad</span><span class="o">-</span><span class="n">w_pos</span><span class="o">*</span><span class="p">(</span><span class="n">w</span><span class="p">[</span><span class="n">l</span><span class="p">]</span><span class="o">*</span><span class="n">flux_ref</span><span class="o">/</span><span class="p">(</span><span class="n">sig_est</span><span class="p">[</span><span class="n">l</span><span class="p">]</span><span class="o">*</span><span class="n">flux_est</span><span class="p">[</span><span class="n">l</span><span class="p">]))</span><span class="o">*</span><span class="n">scisig</span><span class="o">.</span><span class="n">convolve</span><span class="p">(</span><span class="n">utils</span><span class="o">.</span><span class="n">transpose_decim</span><span class="p">(</span><span class="n">resk</span><span class="p">[:,:,</span><span class="n">l</span><span class="p">],</span><span class="n">upfact</span><span class="p">),</span><span class="n">shift_ker_stack_adj</span><span class="p">[:,:,</span><span class="n">l</span><span class="p">],</span><span class="n">mode</span><span class="o">=</span><span class="s1">&#39;same&#39;</span><span class="p">)</span>
                        <span class="n">gradsp_temp</span> <span class="o">=</span> <span class="n">gradsp_temp</span><span class="o">-</span><span class="n">w_sp</span><span class="o">*</span><span class="p">(</span><span class="n">w</span><span class="p">[</span><span class="n">l</span><span class="p">]</span><span class="o">*</span><span class="n">flux_ref</span><span class="o">/</span><span class="p">(</span><span class="n">sig_est</span><span class="p">[</span><span class="n">l</span><span class="p">]</span><span class="o">*</span><span class="n">flux_est</span><span class="p">[</span><span class="n">l</span><span class="p">]))</span><span class="o">*</span><span class="n">scisig</span><span class="o">.</span><span class="n">convolve</span><span class="p">(</span><span class="n">utils</span><span class="o">.</span><span class="n">transpose_decim</span><span class="p">(</span><span class="n">resk_sp</span><span class="p">[:,:,</span><span class="n">l</span><span class="p">],</span><span class="n">upfact</span><span class="p">),</span><span class="n">shift_ker_stack_adj</span><span class="p">[:,:,</span><span class="n">l</span><span class="p">],</span><span class="n">mode</span><span class="o">=</span><span class="s1">&#39;same&#39;</span><span class="p">)</span>
                <span class="n">buff</span><span class="p">[</span><span class="n">j</span><span class="o">%</span><span class="n">nb_subiter_min</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">resk</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">j</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
                    <span class="nb">print</span> <span class="s2">&quot;---- Ref mse ---- &quot;</span><span class="p">,</span><span class="n">buff</span><span class="p">[</span><span class="n">j</span><span class="o">%</span><span class="n">nb_subiter_min</span><span class="p">]</span>

                <span class="k">if</span> <span class="n">j</span><span class="o">&gt;=</span><span class="n">nb_subiter_min</span><span class="p">:</span>
                    <span class="n">cur_res</span> <span class="o">=</span> <span class="n">buff</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">cur_res</span> <span class="o">=</span> <span class="n">buff</span><span class="p">[</span><span class="n">j</span><span class="o">%</span><span class="n">nb_subiter_min</span><span class="p">]</span>
                <span class="c1"># Exact line search</span>
                <span class="n">muj</span> <span class="o">=</span> <span class="n">mu</span><span class="o">/</span><span class="n">spec_rad</span>
                <span class="k">if</span> <span class="n">line_search_en</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
                    <span class="n">c1</span><span class="o">=</span><span class="mi">0</span>
                    <span class="n">c2</span><span class="o">=</span><span class="mi">0</span>
                    <span class="n">c3</span><span class="o">=</span><span class="mi">0</span>
                    <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
                        <span class="n">u1</span> <span class="o">=</span> <span class="n">res</span><span class="p">[:,:,</span><span class="n">l</span><span class="p">]</span><span class="o">-</span><span class="p">(</span><span class="n">w</span><span class="p">[</span><span class="n">l</span><span class="p">]</span><span class="o">*</span><span class="n">flux_ref</span><span class="o">/</span><span class="p">(</span><span class="n">sig_est</span><span class="p">[</span><span class="n">l</span><span class="p">]</span><span class="o">*</span><span class="n">flux_est</span><span class="p">[</span><span class="n">l</span><span class="p">]))</span><span class="o">*</span><span class="n">utils</span><span class="o">.</span><span class="n">decim</span><span class="p">(</span><span class="n">scisig</span><span class="o">.</span><span class="n">fftconvolve</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">comp</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">]</span><span class="o">-</span><span class="n">z1</span><span class="p">,</span><span class="n">shift_ker_stack</span><span class="p">[:,:,</span><span class="n">l</span><span class="p">],</span><span class="n">mode</span><span class="o">=</span><span class="s1">&#39;same&#39;</span><span class="p">),</span><span class="n">upfact</span><span class="p">,</span><span class="n">av_en</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                        <span class="n">u2</span> <span class="o">=</span> <span class="n">res</span><span class="p">[:,:,</span><span class="n">l</span><span class="p">]</span><span class="o">-</span><span class="p">(</span><span class="n">w</span><span class="p">[</span><span class="n">l</span><span class="p">]</span><span class="o">*</span><span class="n">flux_ref</span><span class="o">/</span><span class="p">(</span><span class="n">sig_est</span><span class="p">[</span><span class="n">l</span><span class="p">]</span><span class="o">*</span><span class="n">flux_est</span><span class="p">[</span><span class="n">l</span><span class="p">]))</span><span class="o">*</span><span class="n">utils</span><span class="o">.</span><span class="n">decim</span><span class="p">(</span><span class="n">scisig</span><span class="o">.</span><span class="n">fftconvolve</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">comp</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">]</span><span class="o">-</span><span class="n">z2</span><span class="p">,</span><span class="n">shift_ker_stack</span><span class="p">[:,:,</span><span class="n">l</span><span class="p">],</span><span class="n">mode</span><span class="o">=</span><span class="s1">&#39;same&#39;</span><span class="p">),</span><span class="n">upfact</span><span class="p">,</span><span class="n">av_en</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                        <span class="n">u3</span> <span class="o">=</span> <span class="o">-</span><span class="p">(</span><span class="n">w</span><span class="p">[</span><span class="n">l</span><span class="p">]</span><span class="o">*</span><span class="n">flux_ref</span><span class="o">/</span><span class="p">(</span><span class="n">sig_est</span><span class="p">[</span><span class="n">l</span><span class="p">]</span><span class="o">*</span><span class="n">flux_est</span><span class="p">[</span><span class="n">l</span><span class="p">]))</span><span class="o">*</span><span class="n">utils</span><span class="o">.</span><span class="n">decim</span><span class="p">(</span><span class="n">scisig</span><span class="o">.</span><span class="n">fftconvolve</span><span class="p">(</span><span class="n">grad</span><span class="p">,</span><span class="n">shift_ker_stack</span><span class="p">[:,:,</span><span class="n">l</span><span class="p">],</span><span class="n">mode</span><span class="o">=</span><span class="s1">&#39;same&#39;</span><span class="p">),</span><span class="n">upfact</span><span class="p">,</span><span class="n">av_en</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                        <span class="n">c1</span><span class="o">+=</span> <span class="p">(</span><span class="n">u1</span><span class="o">*</span><span class="n">u3</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
                        <span class="n">c2</span><span class="o">+=</span> <span class="p">(</span><span class="n">u2</span><span class="o">*</span><span class="n">u3</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
                        <span class="n">c3</span><span class="o">+=</span> <span class="p">(</span><span class="n">u3</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
                        <span class="n">muj</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">c1</span><span class="o">/</span><span class="n">c3</span><span class="p">,</span><span class="n">c2</span><span class="o">/</span><span class="n">c3</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">cv_proof_en</span> <span class="o">==</span><span class="mi">1</span><span class="p">:</span>
                    <span class="n">muj</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">muj</span><span class="p">,</span><span class="n">mu</span><span class="o">/</span><span class="n">spec_rad</span><span class="p">)</span>
                    <span class="nb">print</span> <span class="s2">&quot;Optimal step: &quot;</span><span class="p">,</span><span class="n">muj</span><span class="p">,</span><span class="s2">&quot; Max for cv proof: &quot;</span><span class="p">,</span><span class="mi">2</span><span class="o">/</span><span class="n">spec_rad</span>
                <span class="c1"># ---- Analysis constraint ---- #</span>
                <span class="k">if</span> <span class="n">j</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
                    <span class="nb">print</span> <span class="s2">&quot;---- Ref l1 norm ---- &quot;</span><span class="p">,</span><span class="n">buffsp</span><span class="p">[</span><span class="n">j</span><span class="o">%</span><span class="n">nb_subiter_min</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">k</span><span class="o">==</span><span class="mi">0</span> <span class="ow">and</span> <span class="n">j</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
                    <span class="c1"># GFB variables init</span>
                    <span class="n">sig_map</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">res_sig_map</span><span class="p">(</span><span class="n">muj</span><span class="o">*</span><span class="n">grad</span><span class="p">,</span><span class="n">opt</span><span class="o">=</span><span class="n">opt</span><span class="p">)</span>
                    <span class="n">thresh_map</span> <span class="o">=</span> <span class="n">nsig</span><span class="o">*</span><span class="n">sig_map</span>
                    <span class="n">z11</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">comp</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">])</span>
                    <span class="n">z12</span><span class="p">,</span><span class="n">mr_file_temp</span> <span class="o">=</span> <span class="n">isap</span><span class="o">.</span><span class="n">mr_trans</span><span class="p">(</span><span class="n">z11</span><span class="p">,</span><span class="n">opt</span><span class="o">=</span><span class="n">opt</span><span class="p">)</span> <span class="c1"># Sparse variable</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">mr_file_temp</span><span class="p">)</span>
                    <span class="n">z12</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">thresholding</span><span class="p">(</span><span class="n">z12</span><span class="p">,</span><span class="n">thresh_map</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="c1"># 1=&gt; soft thresholding</span>
                    <span class="n">x2</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">z12</span><span class="p">)</span>
                    <span class="n">z21</span><span class="p">,</span><span class="n">z22</span> <span class="o">=</span> <span class="n">proj_dict_equal_wvl</span><span class="p">(</span><span class="n">z11</span><span class="p">,</span><span class="n">z12</span><span class="p">,</span><span class="n">opt</span><span class="p">,</span><span class="n">mr_file</span><span class="p">,</span><span class="n">corr_coeff</span><span class="o">=</span><span class="n">wvl_transp_cor</span><span class="p">)</span>



                <span class="c1"># Sparsity</span>
                <span class="n">t2</span><span class="p">,</span><span class="n">mr_file_temp</span> <span class="o">=</span> <span class="n">isap</span><span class="o">.</span><span class="n">mr_trans</span><span class="p">(</span><span class="n">comp</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">],</span><span class="n">opt</span><span class="o">=</span><span class="n">opt</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">i</span><span class="o">==</span><span class="mi">0</span> <span class="ow">and</span> <span class="n">k</span><span class="o">==</span><span class="mi">0</span> <span class="ow">and</span> <span class="p">(</span><span class="n">comp</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
                    <span class="n">a</span> <span class="o">=</span> <span class="p">(</span><span class="n">comp</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
                    <span class="n">b</span> <span class="o">=</span> <span class="p">(</span><span class="n">t2</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
                    <span class="n">wvl_transp_cor</span> <span class="o">=</span> <span class="n">a</span><span class="o">/</span><span class="n">b</span>
                <span class="n">gradsp_temp</span> <span class="o">=</span> <span class="n">gradsp_temp</span><span class="o">*</span><span class="n">wvl_transp_cor</span>
                <span class="n">gradsp</span><span class="p">,</span><span class="n">mr_file_temp</span> <span class="o">=</span> <span class="n">isap</span><span class="o">.</span><span class="n">mr_trans</span><span class="p">(</span><span class="n">gradsp_temp</span><span class="p">,</span><span class="n">opt</span><span class="o">=</span><span class="n">opt</span><span class="p">)</span>
                <span class="n">temp1</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">x2</span> <span class="o">-</span> <span class="n">z12</span> <span class="o">-</span> <span class="n">muj</span><span class="o">*</span><span class="n">gradsp</span>
                <span class="c1"># Wavelet noise estimation</span>

                <span class="n">sig_map</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">res_sig_map</span><span class="p">(</span><span class="n">muj</span><span class="o">*</span><span class="n">gradsp_temp</span><span class="p">,</span><span class="n">opt</span><span class="o">=</span><span class="n">opt</span><span class="p">)</span>
                <span class="n">thresh_map</span> <span class="o">=</span> <span class="n">nsig</span><span class="o">*</span><span class="n">sig_map</span>
                <span class="n">thresh_map</span> <span class="o">=</span> <span class="n">thresh_map</span><span class="o">*</span><span class="n">weights_sp</span>
                <span class="n">buffsp</span><span class="p">[</span><span class="n">j</span><span class="o">%</span><span class="n">nb_subiter_min</span><span class="p">]</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">x2</span><span class="p">[:,:,</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">thresh_map</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>

                <span class="n">result</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">thresholding_3D</span><span class="p">(</span><span class="n">temp1</span><span class="p">,</span><span class="n">thresh_map</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="c1"># 1=&gt; soft thresholding</span>
                <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">mr_file_temp</span><span class="p">)</span>
                <span class="n">z12</span> <span class="o">=</span> <span class="n">z12</span><span class="o">+</span><span class="n">lambd</span><span class="o">*</span><span class="p">(</span><span class="n">result</span><span class="o">-</span><span class="n">x2</span><span class="p">)</span>

                <span class="c1"># ---- Positivity constraint ---- #</span>
                <span class="n">z11</span> <span class="o">=</span> <span class="n">z11</span><span class="o">+</span><span class="n">lambd</span><span class="o">*</span><span class="p">(</span><span class="n">proj_affine_pos2</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">comp</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">z11</span> <span class="o">-</span> <span class="n">muj</span><span class="o">*</span><span class="n">grad</span><span class="p">,</span><span class="n">w</span><span class="p">,</span><span class="n">im_hr</span><span class="p">,</span><span class="n">min_val_map</span><span class="o">=</span><span class="n">min_val_map</span><span class="p">)</span><span class="o">-</span><span class="n">comp</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">])</span>

                <span class="c1"># ---- Bonding constraint ----- #</span>
                <span class="n">temp1</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">comp</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">z21</span> <span class="o">-</span> <span class="n">muj</span><span class="o">*</span><span class="n">grad</span>
                <span class="n">temp2</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">x2</span> <span class="o">-</span> <span class="n">z22</span> <span class="o">-</span> <span class="n">muj</span><span class="o">*</span><span class="n">gradsp</span>
                <span class="n">proj1</span><span class="p">,</span><span class="n">proj2</span> <span class="o">=</span> <span class="n">proj_dict_equal_wvl</span><span class="p">(</span><span class="n">temp1</span><span class="p">,</span><span class="n">temp2</span><span class="p">,</span><span class="n">opt</span><span class="p">,</span><span class="n">mr_file</span><span class="p">,</span><span class="n">corr_coeff</span><span class="o">=</span><span class="n">wvl_transp_cor</span><span class="p">)</span>
                <span class="n">z21</span> <span class="o">=</span> <span class="n">z21</span><span class="o">+</span><span class="n">lambd</span><span class="o">*</span><span class="p">(</span><span class="n">proj1</span><span class="o">-</span><span class="n">comp</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">])</span>
                <span class="n">z22</span> <span class="o">=</span> <span class="n">z22</span><span class="o">+</span><span class="n">lambd</span><span class="o">*</span><span class="p">(</span><span class="n">proj2</span><span class="o">-</span><span class="n">x2</span><span class="p">)</span>

                <span class="c1"># ---- Main variable update ---- #</span>
                <span class="n">comp</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">w1</span><span class="o">*</span><span class="n">z11</span> <span class="o">+</span> <span class="n">w2</span><span class="o">*</span><span class="n">z21</span>
                <span class="n">x2</span> <span class="o">=</span> <span class="n">w1</span><span class="o">*</span><span class="n">z12</span> <span class="o">+</span> <span class="n">w2</span><span class="o">*</span><span class="n">z22</span>


                <span class="c1"># --- Sanity check --- #</span>
                <span class="n">im_hr</span> <span class="o">=</span> <span class="mi">0</span><span class="o">*</span><span class="n">im_hr</span>
                <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
                    <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
                        <span class="n">im_hr</span><span class="p">[:,:,</span><span class="n">l</span><span class="p">]</span> <span class="o">=</span> <span class="n">im_hr</span><span class="p">[:,:,</span><span class="n">l</span><span class="p">]</span><span class="o">+</span><span class="n">weights</span><span class="p">[</span><span class="n">p</span><span class="p">,</span><span class="n">l</span><span class="p">]</span><span class="o">*</span><span class="n">comp</span><span class="p">[:,:,</span><span class="n">p</span><span class="p">]</span>

                <span class="nb">print</span> <span class="s2">&quot;min val: &quot;</span><span class="p">,</span><span class="n">im_hr</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>

                <span class="n">count</span><span class="o">+=</span><span class="mi">1</span>
                <span class="k">if</span> <span class="n">j</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
                    <span class="nb">print</span> <span class="s2">&quot;Estimated noise at the first scales: &quot;</span><span class="p">,</span><span class="n">sig_map</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,:]</span>

                <span class="n">j</span><span class="o">+=</span><span class="mi">1</span>
                <span class="n">comp_sp</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">isap</span><span class="o">.</span><span class="n">mr_recons_coeff</span><span class="p">(</span><span class="n">x2</span><span class="p">,</span><span class="n">mr_file</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
                    <span class="n">resk</span><span class="p">[:,:,</span><span class="n">l</span><span class="p">]</span> <span class="o">=</span> <span class="n">res</span><span class="p">[:,:,</span><span class="n">l</span><span class="p">]</span><span class="o">-</span><span class="p">(</span><span class="n">w</span><span class="p">[</span><span class="n">l</span><span class="p">]</span><span class="o">*</span><span class="n">flux_ref</span><span class="o">/</span><span class="p">(</span><span class="n">sig_est</span><span class="p">[</span><span class="n">l</span><span class="p">]</span><span class="o">*</span><span class="n">flux_est</span><span class="p">[</span><span class="n">l</span><span class="p">]))</span><span class="o">*</span><span class="n">utils</span><span class="o">.</span><span class="n">decim</span><span class="p">(</span><span class="n">scisig</span><span class="o">.</span><span class="n">fftconvolve</span><span class="p">(</span><span class="n">comp</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">],</span><span class="n">shift_ker_stack</span><span class="p">[:,:,</span><span class="n">l</span><span class="p">],</span><span class="n">mode</span><span class="o">=</span><span class="s1">&#39;same&#39;</span><span class="p">),</span><span class="n">upfact</span><span class="p">,</span><span class="n">av_en</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                    <span class="n">resk_sp</span><span class="p">[:,:,</span><span class="n">l</span><span class="p">]</span> <span class="o">=</span> <span class="n">res</span><span class="p">[:,:,</span><span class="n">l</span><span class="p">]</span><span class="o">-</span><span class="p">(</span><span class="n">w</span><span class="p">[</span><span class="n">l</span><span class="p">]</span><span class="o">*</span><span class="n">flux_ref</span><span class="o">/</span><span class="p">(</span><span class="n">sig_est</span><span class="p">[</span><span class="n">l</span><span class="p">]</span><span class="o">*</span><span class="n">flux_est</span><span class="p">[</span><span class="n">l</span><span class="p">]))</span><span class="o">*</span><span class="n">utils</span><span class="o">.</span><span class="n">decim</span><span class="p">(</span><span class="n">scisig</span><span class="o">.</span><span class="n">fftconvolve</span><span class="p">(</span><span class="n">comp_sp</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">],</span><span class="n">shift_ker_stack</span><span class="p">[:,:,</span><span class="n">l</span><span class="p">],</span><span class="n">mode</span><span class="o">=</span><span class="s1">&#39;same&#39;</span><span class="p">),</span><span class="n">upfact</span><span class="p">,</span><span class="n">av_en</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

                <span class="n">buff</span><span class="p">[</span><span class="n">j</span><span class="o">%</span><span class="n">nb_subiter_min</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">resk</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
                <span class="n">buffsp</span><span class="p">[</span><span class="n">j</span><span class="o">%</span><span class="n">nb_subiter_min</span><span class="p">]</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">x2</span><span class="p">[:,:,</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">thresh_map</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>

                <span class="nb">print</span> <span class="s2">&quot;mse: &quot;</span><span class="p">,</span> <span class="n">buff</span><span class="p">[</span><span class="n">j</span><span class="o">%</span><span class="n">nb_subiter_min</span><span class="p">]</span><span class="c1">#,&quot; sparse term l1 norm: &quot;,buffsp[j%nb_subiter_min],&quot; total cost: &quot;,buff[j%nb_subiter_min]+buffsp[j%nb_subiter_min]</span>
                <span class="k">if</span> <span class="n">j</span><span class="o">&gt;=</span><span class="n">nb_subiter_min</span><span class="p">:</span>
                    <span class="n">cur_res</span> <span class="o">=</span> <span class="n">buff</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="c1">#+buffsp.mean()</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">cur_res</span> <span class="o">=</span> <span class="n">buff</span><span class="p">[</span><span class="n">j</span><span class="o">%</span><span class="n">nb_subiter_min</span><span class="p">]</span><span class="c1">#+buffsp[j%nb_subiter_min]</span>
                <span class="c1"># Sparsity transfer check</span>
                <span class="n">x2est</span><span class="p">,</span><span class="n">mr_file_temp</span> <span class="o">=</span> <span class="n">isap</span><span class="o">.</span><span class="n">mr_trans</span><span class="p">(</span><span class="n">comp</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">],</span><span class="n">opt</span><span class="o">=</span><span class="n">opt</span><span class="p">)</span>
                <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">mr_file_temp</span><span class="p">)</span>
                <span class="n">misfit</span> <span class="o">=</span> <span class="mi">100</span><span class="o">*</span><span class="p">((</span><span class="n">x2est</span><span class="p">[:,:,</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">x2</span><span class="p">[:,:,</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">/</span><span class="p">(</span><span class="n">x2</span><span class="p">[:,:,</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
                <span class="nb">print</span> <span class="n">misfit</span><span class="p">,</span><span class="s2">&quot;</span><span class="si">% o</span><span class="s2">f sparsity not transfered&quot;</span>
            <span class="n">res_inter_comp</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">buff</span><span class="p">[</span><span class="n">j</span><span class="o">%</span><span class="n">nb_subiter_min</span><span class="p">]</span>
            <span class="n">buff</span><span class="o">=</span><span class="n">buff</span><span class="o">*</span><span class="mi">0</span>
            <span class="c1"># Component normalization</span>
            <span class="n">a</span> <span class="o">=</span> <span class="n">sqrt</span><span class="p">((</span><span class="n">comp</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span>
            <span class="n">comp</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">comp</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">]</span><span class="o">/</span><span class="n">a</span>
            <span class="n">weights</span><span class="p">[</span><span class="n">i</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">a</span><span class="o">*</span><span class="n">weights</span><span class="p">[</span><span class="n">i</span><span class="p">,:]</span>
            <span class="c1"># Sparse component update</span>
            <span class="n">comp_sp</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">isap</span><span class="o">.</span><span class="n">mr_recons_coeff</span><span class="p">(</span><span class="n">z12</span><span class="p">,</span><span class="n">mr_file</span><span class="p">)</span>
            <span class="n">comp_sp</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">comp_sp</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">]</span><span class="o">/</span><span class="n">sqrt</span><span class="p">((</span><span class="n">comp_sp</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span>
            <span class="c1"># Reweighting</span>
            <span class="n">coeffx</span><span class="p">,</span><span class="n">mr_file_temp</span> <span class="o">=</span> <span class="n">isap</span><span class="o">.</span><span class="n">mr_trans</span><span class="p">(</span><span class="n">comp</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">],</span><span class="n">opt</span><span class="o">=</span><span class="n">opt</span><span class="p">)</span>
            <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">mr_file_temp</span><span class="p">)</span>
            <span class="n">weights_sp</span>  <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="nb">abs</span><span class="p">(</span><span class="n">coeffx</span><span class="p">[:,:,:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span><span class="o">/</span><span class="p">(</span><span class="n">nsig</span><span class="o">*</span><span class="n">sig_map</span><span class="p">))</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="c1"># Residual update and HR images update</span>
        <span class="n">res_old_comp</span> <span class="o">=</span> <span class="n">cur_res_comp</span>
        <span class="n">cur_res_comp</span> <span class="o">=</span> <span class="n">buff</span><span class="p">[</span><span class="n">j</span><span class="o">%</span><span class="n">nb_subiter_min</span><span class="p">]</span>

        <span class="n">im_hr</span> <span class="o">=</span> <span class="mi">0</span><span class="o">*</span><span class="n">im_hr</span>

        <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
            <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
                <span class="n">im_hr</span><span class="p">[:,:,</span><span class="n">l</span><span class="p">]</span> <span class="o">=</span> <span class="n">im_hr</span><span class="p">[:,:,</span><span class="n">l</span><span class="p">]</span><span class="o">+</span><span class="n">weights</span><span class="p">[</span><span class="n">p</span><span class="p">,</span><span class="n">l</span><span class="p">]</span><span class="o">*</span><span class="n">comp</span><span class="p">[:,:,</span><span class="n">p</span><span class="p">]</span>
            <span class="n">res</span><span class="p">[:,:,</span><span class="n">l</span><span class="p">]</span> <span class="o">=</span> <span class="n">psf_stack</span><span class="p">[:,:,</span><span class="n">l</span><span class="p">]</span><span class="o">-</span><span class="p">(</span><span class="n">flux_ref</span><span class="o">/</span><span class="p">(</span><span class="n">sig_est</span><span class="p">[</span><span class="n">l</span><span class="p">]</span><span class="o">*</span><span class="n">flux_est</span><span class="p">[</span><span class="n">l</span><span class="p">]))</span><span class="o">*</span><span class="n">utils</span><span class="o">.</span><span class="n">decim</span><span class="p">(</span><span class="n">scisig</span><span class="o">.</span><span class="n">fftconvolve</span><span class="p">(</span><span class="n">im_hr</span><span class="p">[:,:,</span><span class="n">l</span><span class="p">],</span><span class="n">shift_ker_stack</span><span class="p">[:,:,</span><span class="n">l</span><span class="p">],</span><span class="n">mode</span><span class="o">=</span><span class="s1">&#39;same&#39;</span><span class="p">),</span><span class="n">upfact</span><span class="p">,</span><span class="n">av_en</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">comp_lr</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">,</span><span class="n">l</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">flux_ref</span><span class="o">/</span><span class="p">(</span><span class="n">sig_est</span><span class="p">[</span><span class="n">l</span><span class="p">]</span><span class="o">*</span><span class="n">flux_est</span><span class="p">[</span><span class="n">l</span><span class="p">]))</span><span class="o">*</span><span class="n">utils</span><span class="o">.</span><span class="n">decim</span><span class="p">(</span><span class="n">scisig</span><span class="o">.</span><span class="n">fftconvolve</span><span class="p">(</span><span class="n">comp</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">],</span><span class="n">shift_ker_stack</span><span class="p">[:,:,</span><span class="n">l</span><span class="p">],</span><span class="n">mode</span><span class="o">=</span><span class="s1">&#39;same&#39;</span><span class="p">),</span><span class="n">upfact</span><span class="p">,</span><span class="n">av_en</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="n">i</span><span class="o">+=</span><span class="mi">1</span>
        <span class="c1"># Optim variables resetting</span>
        <span class="n">z11</span> <span class="o">=</span> <span class="n">z11</span><span class="o">*</span><span class="mi">0</span>
        <span class="n">z12</span> <span class="o">=</span> <span class="n">z12</span><span class="o">*</span><span class="mi">0</span>
        <span class="n">z21</span> <span class="o">=</span> <span class="n">z21</span><span class="o">*</span><span class="mi">0</span>
        <span class="n">z22</span> <span class="o">=</span> <span class="n">z22</span><span class="o">*</span><span class="mi">0</span>
        <span class="n">i1</span><span class="p">,</span><span class="n">i2</span><span class="p">,</span><span class="n">i3</span> <span class="o">=</span> <span class="n">where</span><span class="p">(</span><span class="n">weights_sp</span><span class="o">!=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">weights_sp</span><span class="p">[</span><span class="n">i1</span><span class="p">,</span><span class="n">i2</span><span class="p">,</span><span class="n">i3</span><span class="p">]</span><span class="o">=</span><span class="mi">1</span>
    <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">mr_file</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">nsig</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
        <span class="nb">print</span> <span class="s2">&quot;Warning: no sparsity constraint&quot;</span>
    <span class="k">return</span> <span class="n">im_hr</span><span class="p">,</span><span class="n">comp</span><span class="p">,</span><span class="n">weights</span><span class="p">,</span><span class="n">res</span><span class="p">,</span><span class="n">sig_est</span><span class="o">*</span><span class="n">sig_min</span><span class="p">,</span><span class="n">flux_est</span><span class="p">,</span><span class="n">shifts</span><span class="p">,</span><span class="n">res_inter_comp</span>

<span class="k">def</span> <span class="nf">low_rank_comp_wise_sparse_dist_dyn_coeff_GFB_fast_2</span><span class="p">(</span><span class="n">psf_stack_in</span><span class="p">,</span><span class="n">field_dist</span><span class="p">,</span><span class="n">upfact</span><span class="p">,</span><span class="n">opt</span><span class="p">,</span><span class="n">nsig</span><span class="p">,</span><span class="n">neigh_frac</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span><span class="n">dist_weight_deg</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">shifts</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">opt_shift_est</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">nsig_shift_est</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">sig_est</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">flux_est</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">nb_iter</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span><span class="n">redun_fact</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">nb_subiter</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span><span class="n">nb_subiter_min</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span><span class="n">mu</span><span class="o">=</span><span class="mf">1.5</span><span class="p">,</span><span class="n">nb_comp_max</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span><span class="n">tol</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span><span class="n">wvl_transp_cor</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">cv_proof_en</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">line_search_en</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">cond_fact</span><span class="o">=</span><span class="mf">0.6</span><span class="p">,</span><span class="n">pos_relax</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span> <span class="c1"># Representations coefficietns are updated in all the components loops</span>
    <span class="n">psf_stack</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">psf_stack_in</span><span class="p">)</span>
    <span class="nb">print</span> <span class="s2">&quot;Minimiser: GFB&quot;</span>
    <span class="c1"># Degradation operator parameters estimation</span>
    <span class="k">if</span> <span class="n">shifts</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1">#shifts = utils.shift_est(psf_stack)*upfact</span>
        <span class="n">shifts</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">wvl_shift_est</span><span class="p">(</span><span class="n">psf_stack</span><span class="p">,</span><span class="n">opt_shift_est</span><span class="p">,</span><span class="n">nsig_shift_est</span><span class="p">)</span><span class="o">*</span><span class="n">upfact</span>
    <span class="n">shift_ker_stack</span><span class="p">,</span><span class="n">shift_ker_stack_adj</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">shift_ker_stack</span><span class="p">(</span><span class="n">shifts</span><span class="p">,</span><span class="n">upfact</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">sig_est</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">sig_est</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">im_gauss_nois_est_cube</span><span class="p">(</span><span class="n">psf_stack_in</span><span class="p">,</span><span class="n">opt</span><span class="o">=</span><span class="n">opt_shift_est</span><span class="p">)</span>
    <span class="n">sig_min</span> <span class="o">=</span> <span class="n">sig_est</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
    <span class="n">sig_est</span> <span class="o">=</span> <span class="n">sig_est</span><span class="o">/</span><span class="n">sig_min</span>
    <span class="n">shap</span> <span class="o">=</span> <span class="n">psf_stack</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">nb_im</span> <span class="o">=</span> <span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
        <span class="n">psf_stack</span><span class="p">[:,:,</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">psf_stack</span><span class="p">[:,:,</span><span class="n">k</span><span class="p">]</span><span class="o">/</span><span class="n">sig_est</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
    <span class="nb">print</span> <span class="s2">&quot; ------ ref energy: &quot;</span><span class="p">,(</span><span class="n">psf_stack</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(),</span><span class="s2">&quot; ------- &quot;</span>
    <span class="k">if</span> <span class="n">flux_est</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">flux_est</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">flux_estimate_stack</span><span class="p">(</span><span class="n">psf_stack_in</span><span class="p">,</span><span class="n">rad</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
    <span class="n">flux_ref</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">flux_est</span><span class="p">)</span>
    <span class="n">weights</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">w</span> <span class="o">=</span> <span class="n">ones</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">],))</span>
    <span class="n">im_hr</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">upfact</span><span class="o">*</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">upfact</span><span class="o">*</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>

    <span class="c1"># Distances settings</span>
    <span class="nb">print</span> <span class="s2">&quot;Contructing PSF tree...&quot;</span>
    <span class="n">nb_neighs</span> <span class="o">=</span> <span class="n">redun_fact</span><span class="o">*</span><span class="n">upfact</span><span class="o">**</span><span class="mi">2</span>
    <span class="n">neigh</span><span class="p">,</span><span class="n">dists</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">knn_interf</span><span class="p">(</span><span class="n">field_dist</span><span class="p">,</span><span class="n">nb_neighs</span><span class="p">)</span>
    <span class="n">p_max</span> <span class="o">=</span> <span class="n">pow_law_select</span><span class="p">(</span><span class="n">dists</span><span class="p">,</span><span class="n">nb_neighs</span><span class="p">)</span>
    <span class="nb">print</span> <span class="s2">&quot;power max = &quot;</span><span class="p">,</span><span class="n">p_max</span>
    <span class="n">p_min</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="nb">print</span> <span class="s2">&quot;Done...&quot;</span>
    <span class="n">dists</span> <span class="o">=</span> <span class="n">dists</span>
    <span class="n">dist_med</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">dists</span><span class="p">)</span>
    <span class="n">dist_weights</span> <span class="o">=</span> <span class="p">(</span><span class="n">dist_med</span><span class="o">/</span><span class="n">dists</span><span class="p">)</span><span class="o">**</span><span class="n">dist_weight_deg</span>
    <span class="n">dist_weigths</span> <span class="o">=</span> <span class="n">dist_weights</span><span class="o">/</span><span class="n">dist_weights</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
    <span class="c1"># Spatial smoothing operator gradient lip constant estimation</span>
    <span class="n">spec_rad_smooth</span> <span class="o">=</span> <span class="kc">None</span>


    <span class="n">siz_in</span> <span class="o">=</span> <span class="n">upfact</span><span class="o">*</span><span class="n">array</span><span class="p">(</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">eig_max</span> <span class="o">=</span> <span class="kc">None</span>


    <span class="c1"># GFB variables</span>
    <span class="nb">input</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">upfact</span><span class="o">*</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">upfact</span><span class="o">*</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
    <span class="nb">input</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="nb">input</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">upfact</span><span class="p">)</span>
    <span class="nb">input</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">shift_ker_stack</span><span class="p">)</span>
    <span class="nb">input</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">shift_ker_stack_adj</span><span class="p">)</span>
    <span class="n">w</span> <span class="o">=</span> <span class="n">ones</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">],))</span>
    <span class="n">im_hr</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">upfact</span><span class="o">*</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">upfact</span><span class="o">*</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>
    <span class="nb">input</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">copy</span><span class="p">(</span><span class="n">w</span><span class="p">))</span>
    <span class="nb">input</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sig_est</span><span class="p">)</span>
    <span class="nb">input</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">flux_est</span><span class="p">)</span>
    <span class="n">comp</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">upfact</span><span class="o">*</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">upfact</span><span class="o">*</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">nb_comp_max</span><span class="p">))</span> <span class="c1"># Main variable</span>
    <span class="n">comp_old</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">upfact</span><span class="o">*</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">upfact</span><span class="o">*</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
    <span class="n">z11</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">upfact</span><span class="o">*</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">upfact</span><span class="o">*</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span> <span class="c1"># Positive variable</span>
    <span class="n">z12</span><span class="p">,</span><span class="n">mr_file</span> <span class="o">=</span> <span class="n">isap</span><span class="o">.</span><span class="n">mr_trans</span><span class="p">(</span><span class="n">z11</span><span class="p">,</span><span class="n">opt</span><span class="o">=</span><span class="n">opt</span><span class="p">)</span> <span class="c1"># Sparse variable</span>
    <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">mr_file</span><span class="p">)</span>
    <span class="n">z21</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">upfact</span><span class="o">*</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">upfact</span><span class="o">*</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span> <span class="c1"># Bonding variables</span>
    <span class="n">z22</span><span class="p">,</span><span class="n">mr_file</span> <span class="o">=</span> <span class="n">isap</span><span class="o">.</span><span class="n">mr_trans</span><span class="p">(</span><span class="n">z11</span><span class="p">,</span><span class="n">opt</span><span class="o">=</span><span class="n">opt</span><span class="p">)</span>
    <span class="n">proj1</span><span class="o">=</span><span class="kc">None</span>
    <span class="n">proj2</span><span class="o">=</span><span class="kc">None</span>
    <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">mr_file</span><span class="p">)</span>
    <span class="n">x2</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">z22</span><span class="p">)</span> <span class="c1"># Main variable second group of components</span>
    <span class="n">compz1</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">upfact</span><span class="o">*</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">upfact</span><span class="o">*</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">nb_comp_max</span><span class="p">))</span> <span class="c1"># Main variable</span>
    <span class="n">compz2</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">upfact</span><span class="o">*</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">upfact</span><span class="o">*</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">nb_comp_max</span><span class="p">))</span> <span class="c1"># Main variable</span>
    <span class="n">coeff_init</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">w1</span> <span class="o">=</span> <span class="mf">0.5</span>
    <span class="n">w2</span> <span class="o">=</span> <span class="mf">0.5</span>
    <span class="n">lambd</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">grad</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">upfact</span><span class="o">*</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">upfact</span><span class="o">*</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>

    <span class="n">u</span><span class="p">,</span><span class="n">mr_file</span> <span class="o">=</span> <span class="n">isap</span><span class="o">.</span><span class="n">mr_trans</span><span class="p">(</span><span class="n">comp</span><span class="p">[:,:,</span><span class="mi">0</span><span class="p">],</span><span class="n">opt</span><span class="o">=</span><span class="n">opt</span><span class="p">)</span>
    <span class="n">shap2</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">weights_sp</span> <span class="o">=</span> <span class="n">ones</span><span class="p">((</span><span class="n">shap2</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">shap2</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">shap2</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">psf_stack</span><span class="p">)</span>

    <span class="n">comp_lr</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">nb_comp_max</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>
    <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">buff</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">nb_subiter_min</span><span class="p">))</span>

    <span class="n">nb_iter_noisest</span> <span class="o">=</span> <span class="mi">20</span>
    <span class="n">nb_subiter_prox</span> <span class="o">=</span> <span class="mi">50</span>
    <span class="n">thresh_type</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">noise_vect_1</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">sig_map</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">cur_res</span><span class="o">=</span><span class="mf">100000000.0</span>
    <span class="n">res_old</span><span class="o">=</span><span class="mf">1000000000.0</span>
    <span class="n">cur_res_comp</span><span class="o">=</span><span class="mf">100000000.0</span>
    <span class="n">res_old_comp</span><span class="o">=</span><span class="mf">1000000000.0</span>
    <span class="n">res_inter_comp</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">(</span><span class="n">nb_comp_max</span><span class="p">)</span>
    <span class="nb">print</span> <span class="s2">&quot; -------------------- Debugging warning: sparsity, no coeff smoothing ------------------- &quot;</span>
    <span class="n">weights_init</span><span class="o">=</span><span class="kc">None</span>
    <span class="n">p_smth_mat_inv</span><span class="o">=</span><span class="kc">None</span>
    <span class="n">to</span><span class="o">=</span><span class="kc">None</span>
    <span class="nb">print</span> <span class="s2">&quot; ------ ref energy: &quot;</span><span class="p">,(</span><span class="n">psf_stack</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(),</span><span class="s2">&quot; ------- &quot;</span>
    <span class="n">pows</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">nb_comp_max</span><span class="p">))</span>
    <span class="k">while</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">nb_comp_max</span> <span class="ow">and</span> <span class="mi">100</span><span class="o">*</span><span class="nb">abs</span><span class="p">(</span><span class="n">cur_res_comp</span><span class="o">-</span><span class="n">res_old_comp</span><span class="p">)</span><span class="o">/</span><span class="n">cur_res_comp</span><span class="o">&gt;</span><span class="mf">0.1</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">i</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
            <span class="n">pows</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">=</span><span class="n">p_min</span> <span class="c1"># =1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">pows</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">=</span> <span class="p">(</span><span class="n">pows</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">p_max</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span>
        <span class="n">dist_weights_in</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">nb_im</span><span class="p">,</span><span class="n">nb_neighs</span><span class="p">,</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">ind</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
            <span class="n">dist_weights_in</span><span class="p">[:,:,</span><span class="n">ind</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">dist_med</span><span class="o">/</span><span class="n">dists</span><span class="p">)</span><span class="o">**</span><span class="n">pows</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span>
            <span class="n">dist_weights_in</span><span class="p">[:,:,</span><span class="n">ind</span><span class="p">]</span> <span class="o">=</span> <span class="n">dist_weights_in</span><span class="p">[:,:,</span><span class="n">ind</span><span class="p">]</span><span class="o">/</span><span class="p">(</span><span class="n">dist_weights_in</span><span class="p">[:,:,</span><span class="n">ind</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span>

        <span class="k">if</span> <span class="n">i</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
            <span class="n">w</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">abs_val_reverting</span><span class="p">(</span><span class="n">weights</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">,:])</span>
        <span class="c1">#spec_rad = spec_rad_init</span>
        <span class="c1">#eig = eig_init</span>
        <span class="n">resk</span> <span class="o">=</span> <span class="n">res</span><span class="o">*</span><span class="mi">0</span>
        <span class="n">weights_sp</span> <span class="o">=</span> <span class="n">ones</span><span class="p">((</span><span class="n">shap2</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">shap2</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">shap2</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>
        <span class="sd">&quot;&quot;&quot;spec_rad=0</span>
<span class="sd">            for f in range(0,shap[2]):</span>
<span class="sd">            spec_rad = spec_rad+(w[f]*flux_ref/(sig_est[f]*flux_est[f]))**2*(abs(shift_ker_stack[:,:,f]).sum())**2</span>
<span class="sd">            print &quot;spectral radius: &quot;,spec_rad&quot;&quot;&quot;</span>

        <span class="n">nb_subiter_prox</span> <span class="o">=</span> <span class="mi">60</span>
        <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">weights_init</span><span class="o">=</span><span class="kc">None</span>
        <span class="n">p_smth_mat_inv</span><span class="o">=</span><span class="kc">None</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_iter</span><span class="p">):</span>
            <span class="c1"># Direction initialization</span>
            <span class="k">if</span> <span class="n">k</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">i</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
                    <span class="n">comp</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">pos_proj_mat</span><span class="p">(</span><span class="n">sr_op_trans_stack_pseudo_inv</span><span class="p">(</span><span class="n">res</span><span class="p">,</span><span class="n">shift_ker_stack</span><span class="p">,</span><span class="n">shift_ker_stack_adj</span><span class="p">,</span><span class="n">upfact</span><span class="p">,</span><span class="n">utils</span><span class="o">.</span><span class="n">vect_recond</span><span class="p">(</span><span class="n">w</span><span class="p">,</span><span class="n">cond_fact</span><span class="p">),</span><span class="n">utils</span><span class="o">.</span><span class="n">vect_recond</span><span class="p">(</span><span class="n">sig_est</span><span class="p">,</span><span class="n">cond_fact</span><span class="p">),</span><span class="n">utils</span><span class="o">.</span><span class="n">vect_recond</span><span class="p">(</span><span class="n">flux_est</span><span class="p">,</span><span class="n">cond_fact</span><span class="p">),</span><span class="mi">30</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">comp</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">sr_op_trans_stack_pseudo_inv</span><span class="p">(</span><span class="n">res</span><span class="p">,</span><span class="n">shift_ker_stack</span><span class="p">,</span><span class="n">shift_ker_stack_adj</span><span class="p">,</span><span class="n">upfact</span><span class="p">,</span><span class="n">utils</span><span class="o">.</span><span class="n">vect_recond</span><span class="p">(</span><span class="n">w</span><span class="p">,</span><span class="n">cond_fact</span><span class="p">),</span><span class="n">utils</span><span class="o">.</span><span class="n">vect_recond</span><span class="p">(</span><span class="n">sig_est</span><span class="p">,</span><span class="n">cond_fact</span><span class="p">),</span><span class="n">utils</span><span class="o">.</span><span class="n">vect_recond</span><span class="p">(</span><span class="n">flux_est</span><span class="p">,</span><span class="n">cond_fact</span><span class="p">),</span><span class="mi">30</span><span class="p">)</span>

            <span class="n">t</span><span class="o">=</span><span class="mi">1</span>
            <span class="k">if</span> <span class="n">i</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
                <span class="n">comp</span><span class="p">[:,:,</span><span class="mi">0</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">gram_schmidt_cube</span><span class="p">(</span><span class="n">comp</span><span class="p">[:,:,</span><span class="mi">0</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">])</span>

            <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
                <span class="n">comp_lr</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">,</span><span class="n">l</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">flux_ref</span><span class="o">/</span><span class="p">(</span><span class="n">sig_est</span><span class="p">[</span><span class="n">l</span><span class="p">]</span><span class="o">*</span><span class="n">flux_est</span><span class="p">[</span><span class="n">l</span><span class="p">]))</span><span class="o">*</span><span class="n">utils</span><span class="o">.</span><span class="n">decim</span><span class="p">(</span><span class="n">scisig</span><span class="o">.</span><span class="n">fftconvolve</span><span class="p">(</span><span class="n">comp</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">],</span><span class="n">shift_ker_stack</span><span class="p">[:,:,</span><span class="n">l</span><span class="p">],</span><span class="n">mode</span><span class="o">=</span><span class="s1">&#39;same&#39;</span><span class="p">),</span><span class="n">upfact</span><span class="p">,</span><span class="n">av_en</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

            <span class="c1">#weights,mat = lsq_mult_coeff_stack(psf_stack,comp_lr[:,:,0:i+1,:])</span>
            <span class="nb">print</span> <span class="s2">&quot; ------ ref energy: &quot;</span><span class="p">,(</span><span class="n">psf_stack</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(),</span><span class="s2">&quot; ------- &quot;</span>
            <span class="k">if</span> <span class="n">i</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">k</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
                    <span class="n">weights</span> <span class="o">=</span> <span class="n">non_unif_smoothing_mult_coeff_pos_cp</span><span class="p">(</span><span class="n">psf_stack</span><span class="p">,</span><span class="n">comp_lr</span><span class="p">[:,:,</span><span class="mi">0</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,:],</span><span class="n">neigh</span><span class="p">,</span><span class="n">dist_weights_in</span><span class="p">,</span><span class="n">p_smth_mat_inv</span><span class="o">=</span><span class="n">p_smth_mat_inv</span><span class="p">,</span><span class="n">to</span><span class="o">=</span><span class="n">to</span><span class="p">,</span><span class="n">nb_iter</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span><span class="n">tol</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>
                    <span class="c1">#weights = lsq_mult_coeff_stack_pos_2(psf_stack,comp_lr[:,:,0:i+1,:],nb_iter=30)</span>
                    <span class="c1">#weights = non_unif_smoothing_mult_coeff_pos(psf_stack,comp_lr[:,:,0:i+1,:],neigh,dist_weights,nb_iter=30)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">weights</span> <span class="o">=</span> <span class="n">non_unif_smoothing_mult_coeff_pos_cp</span><span class="p">(</span><span class="n">psf_stack</span><span class="p">,</span><span class="n">comp_lr</span><span class="p">[:,:,</span><span class="mi">0</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,:],</span><span class="n">neigh</span><span class="p">,</span><span class="n">dist_weights_in</span><span class="p">,</span><span class="n">p_smth_mat_inv</span><span class="o">=</span><span class="n">p_smth_mat_inv</span><span class="p">,</span><span class="n">to</span><span class="o">=</span><span class="n">to</span><span class="p">,</span><span class="n">nb_iter</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span><span class="n">tol</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span><span class="n">Ainit</span><span class="o">=</span><span class="n">weights</span><span class="p">)</span>
                    <span class="c1">#weights = non_unif_smoothing_mult_coeff_pos(psf_stack,comp_lr[:,:,0:i+1,:],neigh,dist_weights,Ainit=weights,nb_iter=30)</span>
                    <span class="sd">&quot;&quot;&quot;weights_init=None</span>
<span class="sd">                        if k&gt;0:</span>
<span class="sd">                        weights_init = weights</span>
<span class="sd">                        weights = non_unif_smoothing_mult_coeff(psf_stack,comp_lr[:,:,0:i+1,:],neigh,dist_weights,Ainit=weights_init)</span>
<span class="sd">                        else :</span>
<span class="sd">                        weights,mat = lsq_mult_coeff_stack(psf_stack,comp_lr[:,:,0:i+1,:])</span>
<span class="sd">                        weights_init = zeros((i+1,shap[2]))</span>
<span class="sd">                        weights_init[0:i,:] = weights</span>
<span class="sd">                        weights_init[i,:] = w</span>
<span class="sd">                        weights = non_unif_smoothing_mult_coeff(psf_stack,comp_lr[:,:,0:i+1,:],neigh,dist_weights,Ainit=weights_init)&quot;&quot;&quot;</span>
            <span class="k">else</span><span class="p">:</span>

                <span class="k">if</span> <span class="n">k</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
                    <span class="n">weights</span> <span class="o">=</span> <span class="n">non_unif_smoothing_mult_coeff_pos_dr</span><span class="p">(</span><span class="n">psf_stack</span><span class="p">,</span><span class="n">comp</span><span class="p">[:,:,</span><span class="mi">0</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">],</span><span class="n">comp_lr</span><span class="p">[:,:,</span><span class="mi">0</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,:],</span><span class="n">neigh</span><span class="p">,</span><span class="n">dist_weights_in</span><span class="p">,</span><span class="n">upfact</span><span class="p">,</span><span class="n">shift_ker_stack</span><span class="p">,</span><span class="n">shift_ker_stack_adj</span><span class="p">,</span><span class="n">sig_est</span><span class="p">,</span><span class="n">flux_est</span><span class="p">,</span><span class="n">p_smth_mat_inv</span><span class="o">=</span><span class="n">p_smth_mat_inv</span><span class="p">,</span><span class="n">eps</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span><span class="n">nb_iter</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span><span class="n">tol</span><span class="o">=</span><span class="mf">0.01</span><span class="p">)</span>
                <span class="c1">#weights = lsq_mult_coeff_stack_pos_2(psf_stack,comp_lr[:,:,0:i+1,:],nb_iter=30)</span>
                <span class="c1">#weights = non_unif_smoothing_mult_coeff_pos(psf_stack,comp_lr[:,:,0:i+1,:],neigh,dist_weights,nb_iter=30)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">weights</span> <span class="o">=</span> <span class="n">non_unif_smoothing_mult_coeff_pos_dr</span><span class="p">(</span><span class="n">psf_stack</span><span class="p">,</span><span class="n">comp</span><span class="p">[:,:,</span><span class="mi">0</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">],</span><span class="n">comp_lr</span><span class="p">[:,:,</span><span class="mi">0</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,:],</span><span class="n">neigh</span><span class="p">,</span><span class="n">dist_weights_in</span><span class="p">,</span><span class="n">upfact</span><span class="p">,</span><span class="n">shift_ker_stack</span><span class="p">,</span><span class="n">shift_ker_stack_adj</span><span class="p">,</span><span class="n">sig_est</span><span class="p">,</span><span class="n">flux_est</span><span class="p">,</span><span class="n">p_smth_mat_inv</span><span class="o">=</span><span class="n">p_smth_mat_inv</span><span class="p">,</span><span class="n">eps</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span><span class="n">nb_iter</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span><span class="n">tol</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span><span class="n">Ainit</span><span class="o">=</span><span class="n">weights</span><span class="p">)</span>
                    <span class="c1">#weights = non_unif_smoothing_mult_coeff_pos(psf_stack,comp_lr[:,:,0:i+1,:],neigh,dist_weights,Ainit=weights,nb_iter=30)</span>
                    <span class="sd">&quot;&quot;&quot;weights_init=None</span>
<span class="sd">                        if k&gt;0:</span>
<span class="sd">                        weights_init = weights</span>
<span class="sd">                        weights = non_unif_smoothing_mult_coeff(psf_stack,comp_lr[:,:,0:i+1,:],neigh,dist_weights,Ainit=weights_init)</span>
<span class="sd">                        else :</span>
<span class="sd">                        weights,mat = lsq_mult_coeff_stack(psf_stack,comp_lr[:,:,0:i+1,:])</span>
<span class="sd">                        weights_init = zeros((i+1,shap[2]))</span>
<span class="sd">                        weights_init[0:i,:] = weights</span>
<span class="sd">                        weights_init[i,:] = w</span>
<span class="sd">                        weights = non_unif_smoothing_mult_coeff(psf_stack,comp_lr[:,:,0:i+1,:],neigh,dist_weights,Ainit=weights_init)&quot;&quot;&quot;</span>

            <span class="n">w</span> <span class="o">=</span> <span class="n">weights</span><span class="p">[</span><span class="n">i</span><span class="p">,:]</span>
            <span class="n">im_hr</span> <span class="o">=</span> <span class="mi">0</span><span class="o">*</span><span class="n">im_hr</span>
            <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
                <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">i</span><span class="p">):</span>
                    <span class="n">im_hr</span><span class="p">[:,:,</span><span class="n">l</span><span class="p">]</span> <span class="o">=</span> <span class="n">im_hr</span><span class="p">[:,:,</span><span class="n">l</span><span class="p">]</span><span class="o">+</span><span class="n">weights</span><span class="p">[</span><span class="n">p</span><span class="p">,</span><span class="n">l</span><span class="p">]</span><span class="o">*</span><span class="n">comp</span><span class="p">[:,:,</span><span class="n">p</span><span class="p">]</span>
                <span class="n">res</span><span class="p">[:,:,</span><span class="n">l</span><span class="p">]</span> <span class="o">=</span> <span class="n">psf_stack</span><span class="p">[:,:,</span><span class="n">l</span><span class="p">]</span><span class="o">-</span><span class="p">(</span><span class="n">flux_ref</span><span class="o">/</span><span class="p">(</span><span class="n">sig_est</span><span class="p">[</span><span class="n">l</span><span class="p">]</span><span class="o">*</span><span class="n">flux_est</span><span class="p">[</span><span class="n">l</span><span class="p">]))</span><span class="o">*</span><span class="n">utils</span><span class="o">.</span><span class="n">decim</span><span class="p">(</span><span class="n">scisig</span><span class="o">.</span><span class="n">fftconvolve</span><span class="p">(</span><span class="n">im_hr</span><span class="p">[:,:,</span><span class="n">l</span><span class="p">],</span><span class="n">shift_ker_stack</span><span class="p">[:,:,</span><span class="n">l</span><span class="p">],</span><span class="n">mode</span><span class="o">=</span><span class="s1">&#39;same&#39;</span><span class="p">),</span><span class="n">upfact</span><span class="p">,</span><span class="n">av_en</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="nb">print</span> <span class="s2">&quot;------------------- Component &quot;</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="s2">&quot; ------------------&quot;</span>
            <span class="nb">print</span> <span class="s2">&quot;weights: &quot;</span><span class="p">,</span><span class="n">w</span>
            <span class="nb">input</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">=</span><span class="n">w</span>
            <span class="c1"># Spectral radius</span>
            <span class="n">eig_max</span><span class="p">,</span><span class="n">spec_rad</span> <span class="o">=</span> <span class="n">pow_meth</span><span class="p">(</span><span class="n">sr_op_trans_stack</span><span class="p">,</span><span class="nb">input</span><span class="p">,</span><span class="n">siz_in</span><span class="p">,</span><span class="n">ainit</span><span class="o">=</span><span class="n">eig_max</span><span class="p">)</span>

            <span class="c1"># ith component estimation</span>
            <span class="n">j</span><span class="o">=</span><span class="mi">0</span>
            <span class="c1">#print &#39;--------------- &#39;,nb_subiter,&#39; ----------------&#39;</span>
            <span class="n">res_old</span> <span class="o">=</span> <span class="n">cur_res</span><span class="o">*</span><span class="mi">2</span>
            <span class="k">while</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">nb_subiter</span> <span class="ow">and</span> <span class="mi">100</span><span class="o">*</span><span class="nb">abs</span><span class="p">(</span><span class="n">cur_res</span><span class="o">-</span><span class="n">res_old</span><span class="p">)</span><span class="o">/</span><span class="n">res_old</span><span class="o">&gt;</span><span class="mf">0.001</span><span class="p">:</span>
                <span class="n">res_old</span> <span class="o">=</span> <span class="n">cur_res</span>
                <span class="c1"># Residual computation</span>
                <span class="n">grad</span> <span class="o">=</span> <span class="n">grad</span><span class="o">*</span><span class="mi">0</span>
                <span class="k">if</span> <span class="n">j</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
                        <span class="n">resk</span><span class="p">[:,:,</span><span class="n">l</span><span class="p">]</span> <span class="o">=</span> <span class="n">res</span><span class="p">[:,:,</span><span class="n">l</span><span class="p">]</span><span class="o">-</span><span class="p">(</span><span class="n">w</span><span class="p">[</span><span class="n">l</span><span class="p">]</span><span class="o">*</span><span class="n">flux_ref</span><span class="o">/</span><span class="p">(</span><span class="n">sig_est</span><span class="p">[</span><span class="n">l</span><span class="p">]</span><span class="o">*</span><span class="n">flux_est</span><span class="p">[</span><span class="n">l</span><span class="p">]))</span><span class="o">*</span><span class="n">utils</span><span class="o">.</span><span class="n">decim</span><span class="p">(</span><span class="n">scisig</span><span class="o">.</span><span class="n">fftconvolve</span><span class="p">(</span><span class="n">comp</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">],</span><span class="n">shift_ker_stack</span><span class="p">[:,:,</span><span class="n">l</span><span class="p">],</span><span class="n">mode</span><span class="o">=</span><span class="s1">&#39;same&#39;</span><span class="p">),</span><span class="n">upfact</span><span class="p">,</span><span class="n">av_en</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                    <span class="n">grad</span> <span class="o">=</span> <span class="n">grad</span><span class="o">-</span><span class="p">(</span><span class="n">w</span><span class="p">[</span><span class="n">l</span><span class="p">]</span><span class="o">*</span><span class="n">flux_ref</span><span class="o">/</span><span class="p">(</span><span class="n">sig_est</span><span class="p">[</span><span class="n">l</span><span class="p">]</span><span class="o">*</span><span class="n">flux_est</span><span class="p">[</span><span class="n">l</span><span class="p">]))</span><span class="o">*</span><span class="n">scisig</span><span class="o">.</span><span class="n">convolve</span><span class="p">(</span><span class="n">utils</span><span class="o">.</span><span class="n">transpose_decim</span><span class="p">(</span><span class="n">resk</span><span class="p">[:,:,</span><span class="n">l</span><span class="p">],</span><span class="n">upfact</span><span class="p">),</span><span class="n">shift_ker_stack_adj</span><span class="p">[:,:,</span><span class="n">l</span><span class="p">],</span><span class="n">mode</span><span class="o">=</span><span class="s1">&#39;same&#39;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
                        <span class="n">grad</span> <span class="o">=</span> <span class="n">grad</span><span class="o">-</span><span class="p">(</span><span class="n">w</span><span class="p">[</span><span class="n">l</span><span class="p">]</span><span class="o">*</span><span class="n">flux_ref</span><span class="o">/</span><span class="p">(</span><span class="n">sig_est</span><span class="p">[</span><span class="n">l</span><span class="p">]</span><span class="o">*</span><span class="n">flux_est</span><span class="p">[</span><span class="n">l</span><span class="p">]))</span><span class="o">*</span><span class="n">scisig</span><span class="o">.</span><span class="n">convolve</span><span class="p">(</span><span class="n">utils</span><span class="o">.</span><span class="n">transpose_decim</span><span class="p">(</span><span class="n">resk</span><span class="p">[:,:,</span><span class="n">l</span><span class="p">],</span><span class="n">upfact</span><span class="p">),</span><span class="n">shift_ker_stack_adj</span><span class="p">[:,:,</span><span class="n">l</span><span class="p">],</span><span class="n">mode</span><span class="o">=</span><span class="s1">&#39;same&#39;</span><span class="p">)</span>
                <span class="n">buff</span><span class="p">[</span><span class="n">j</span><span class="o">%</span><span class="n">nb_subiter_min</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">resk</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">j</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
                    <span class="nb">print</span> <span class="s2">&quot;---- Ref mse ---- &quot;</span><span class="p">,</span><span class="n">buff</span><span class="p">[</span><span class="n">j</span><span class="o">%</span><span class="n">nb_subiter_min</span><span class="p">]</span>

                <span class="k">if</span> <span class="n">j</span><span class="o">&gt;=</span><span class="n">nb_subiter_min</span><span class="p">:</span>
                    <span class="n">cur_res</span> <span class="o">=</span> <span class="n">buff</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">cur_res</span> <span class="o">=</span> <span class="n">buff</span><span class="p">[</span><span class="n">j</span><span class="o">%</span><span class="n">nb_subiter_min</span><span class="p">]</span>
                <span class="c1"># Exact line search</span>
                <span class="n">muj</span> <span class="o">=</span> <span class="n">mu</span><span class="o">/</span><span class="n">spec_rad</span>
                <span class="k">if</span> <span class="n">line_search_en</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
                    <span class="n">c1</span><span class="o">=</span><span class="mi">0</span>
                    <span class="n">c2</span><span class="o">=</span><span class="mi">0</span>
                    <span class="n">c3</span><span class="o">=</span><span class="mi">0</span>
                    <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
                        <span class="n">u1</span> <span class="o">=</span> <span class="n">res</span><span class="p">[:,:,</span><span class="n">l</span><span class="p">]</span><span class="o">-</span><span class="p">(</span><span class="n">w</span><span class="p">[</span><span class="n">l</span><span class="p">]</span><span class="o">*</span><span class="n">flux_ref</span><span class="o">/</span><span class="p">(</span><span class="n">sig_est</span><span class="p">[</span><span class="n">l</span><span class="p">]</span><span class="o">*</span><span class="n">flux_est</span><span class="p">[</span><span class="n">l</span><span class="p">]))</span><span class="o">*</span><span class="n">utils</span><span class="o">.</span><span class="n">decim</span><span class="p">(</span><span class="n">scisig</span><span class="o">.</span><span class="n">fftconvolve</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">comp</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">]</span><span class="o">-</span><span class="n">z1</span><span class="p">,</span><span class="n">shift_ker_stack</span><span class="p">[:,:,</span><span class="n">l</span><span class="p">],</span><span class="n">mode</span><span class="o">=</span><span class="s1">&#39;same&#39;</span><span class="p">),</span><span class="n">upfact</span><span class="p">,</span><span class="n">av_en</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                        <span class="n">u2</span> <span class="o">=</span> <span class="n">res</span><span class="p">[:,:,</span><span class="n">l</span><span class="p">]</span><span class="o">-</span><span class="p">(</span><span class="n">w</span><span class="p">[</span><span class="n">l</span><span class="p">]</span><span class="o">*</span><span class="n">flux_ref</span><span class="o">/</span><span class="p">(</span><span class="n">sig_est</span><span class="p">[</span><span class="n">l</span><span class="p">]</span><span class="o">*</span><span class="n">flux_est</span><span class="p">[</span><span class="n">l</span><span class="p">]))</span><span class="o">*</span><span class="n">utils</span><span class="o">.</span><span class="n">decim</span><span class="p">(</span><span class="n">scisig</span><span class="o">.</span><span class="n">fftconvolve</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">comp</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">]</span><span class="o">-</span><span class="n">z2</span><span class="p">,</span><span class="n">shift_ker_stack</span><span class="p">[:,:,</span><span class="n">l</span><span class="p">],</span><span class="n">mode</span><span class="o">=</span><span class="s1">&#39;same&#39;</span><span class="p">),</span><span class="n">upfact</span><span class="p">,</span><span class="n">av_en</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                        <span class="n">u3</span> <span class="o">=</span> <span class="o">-</span><span class="p">(</span><span class="n">w</span><span class="p">[</span><span class="n">l</span><span class="p">]</span><span class="o">*</span><span class="n">flux_ref</span><span class="o">/</span><span class="p">(</span><span class="n">sig_est</span><span class="p">[</span><span class="n">l</span><span class="p">]</span><span class="o">*</span><span class="n">flux_est</span><span class="p">[</span><span class="n">l</span><span class="p">]))</span><span class="o">*</span><span class="n">utils</span><span class="o">.</span><span class="n">decim</span><span class="p">(</span><span class="n">scisig</span><span class="o">.</span><span class="n">fftconvolve</span><span class="p">(</span><span class="n">grad</span><span class="p">,</span><span class="n">shift_ker_stack</span><span class="p">[:,:,</span><span class="n">l</span><span class="p">],</span><span class="n">mode</span><span class="o">=</span><span class="s1">&#39;same&#39;</span><span class="p">),</span><span class="n">upfact</span><span class="p">,</span><span class="n">av_en</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                        <span class="n">c1</span><span class="o">+=</span> <span class="p">(</span><span class="n">u1</span><span class="o">*</span><span class="n">u3</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
                        <span class="n">c2</span><span class="o">+=</span> <span class="p">(</span><span class="n">u2</span><span class="o">*</span><span class="n">u3</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
                        <span class="n">c3</span><span class="o">+=</span> <span class="p">(</span><span class="n">u3</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
                        <span class="n">muj</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">c1</span><span class="o">/</span><span class="n">c3</span><span class="p">,</span><span class="n">c2</span><span class="o">/</span><span class="n">c3</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">cv_proof_en</span> <span class="o">==</span><span class="mi">1</span><span class="p">:</span>
                    <span class="n">muj</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">muj</span><span class="p">,</span><span class="n">mu</span><span class="o">/</span><span class="n">spec_rad</span><span class="p">)</span>
                    <span class="nb">print</span> <span class="s2">&quot;Optimal step: &quot;</span><span class="p">,</span><span class="n">muj</span><span class="p">,</span><span class="s2">&quot; Max for cv proof: &quot;</span><span class="p">,</span><span class="mi">2</span><span class="o">/</span><span class="n">spec_rad</span>
                <span class="c1"># ---- Analysis constraint ---- #</span>
                <span class="c1"># Wavelet noise estimation</span>
                <span class="n">sig_map</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">res_sig_map</span><span class="p">(</span><span class="n">muj</span><span class="o">*</span><span class="n">grad</span><span class="p">,</span><span class="n">opt</span><span class="o">=</span><span class="n">opt</span><span class="p">)</span>
                <span class="n">thresh_map</span> <span class="o">=</span> <span class="n">nsig</span><span class="o">*</span><span class="n">sig_map</span>
                <span class="n">thresh_map</span> <span class="o">=</span> <span class="n">thresh_map</span><span class="o">*</span><span class="n">weights_sp</span>
                <span class="k">if</span> <span class="n">k</span><span class="o">==</span><span class="mi">0</span> <span class="ow">and</span> <span class="n">j</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
                    <span class="c1"># GFB variables init</span>
                    <span class="n">z11</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">comp</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">])</span>
                    <span class="n">z12</span><span class="p">,</span><span class="n">mr_file_temp</span> <span class="o">=</span> <span class="n">isap</span><span class="o">.</span><span class="n">mr_trans</span><span class="p">(</span><span class="n">z11</span><span class="p">,</span><span class="n">opt</span><span class="o">=</span><span class="n">opt</span><span class="p">)</span> <span class="c1"># Sparse variable</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">mr_file_temp</span><span class="p">)</span>
                    <span class="n">z12</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">thresholding</span><span class="p">(</span><span class="n">z12</span><span class="p">,</span><span class="n">thresh_map</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="c1"># 1=&gt; soft thresholding</span>
                    <span class="n">x2</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">z12</span><span class="p">)</span>
                    <span class="n">z21</span><span class="p">,</span><span class="n">z22</span> <span class="o">=</span> <span class="n">proj_dict_equal_wvl</span><span class="p">(</span><span class="n">z11</span><span class="p">,</span><span class="n">z12</span><span class="p">,</span><span class="n">opt</span><span class="p">,</span><span class="n">mr_file</span><span class="p">,</span><span class="n">corr_coeff</span><span class="o">=</span><span class="n">wvl_transp_cor</span><span class="p">)</span>
                <span class="n">temp1</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">x2</span> <span class="o">-</span> <span class="n">z12</span>

                <span class="c1"># Sparsity</span>
                <span class="n">t2</span><span class="p">,</span><span class="n">mr_file_temp</span> <span class="o">=</span> <span class="n">isap</span><span class="o">.</span><span class="n">mr_trans</span><span class="p">(</span><span class="n">comp</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">],</span><span class="n">opt</span><span class="o">=</span><span class="n">opt</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">i</span><span class="o">==</span><span class="mi">0</span> <span class="ow">and</span> <span class="n">k</span><span class="o">==</span><span class="mi">0</span> <span class="ow">and</span> <span class="p">(</span><span class="n">comp</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
                    <span class="n">a</span> <span class="o">=</span> <span class="p">(</span><span class="n">comp</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
                    <span class="n">b</span> <span class="o">=</span> <span class="p">(</span><span class="n">t2</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
                    <span class="n">wvl_transp_cor</span> <span class="o">=</span> <span class="n">a</span><span class="o">/</span><span class="n">b</span>
                <span class="n">result</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">thresholding</span><span class="p">(</span><span class="n">temp1</span><span class="p">,</span><span class="n">thresh_map</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="c1"># 1=&gt; soft thresholding</span>
                <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">mr_file_temp</span><span class="p">)</span>
                <span class="n">z12</span> <span class="o">=</span> <span class="n">z12</span><span class="o">+</span><span class="n">lambd</span><span class="o">*</span><span class="p">(</span><span class="n">result</span><span class="o">-</span><span class="n">x2</span><span class="p">)</span>

                <span class="c1"># ---- Positivity constraint ---- #</span>
                <span class="n">z11</span> <span class="o">=</span> <span class="n">z11</span><span class="o">+</span><span class="n">lambd</span><span class="o">*</span><span class="p">(</span><span class="n">proj_affine_pos2</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">comp</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">z11</span> <span class="o">-</span> <span class="n">muj</span><span class="o">*</span><span class="n">grad</span><span class="p">,</span><span class="n">w</span><span class="p">,</span><span class="n">im_hr</span><span class="p">)</span><span class="o">-</span><span class="n">comp</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">])</span>

                <span class="c1"># ---- Bonding constraint ----- #</span>
                <span class="n">temp1</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">comp</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">z21</span> <span class="o">-</span> <span class="n">muj</span><span class="o">*</span><span class="n">grad</span>
                <span class="n">temp2</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">x2</span> <span class="o">-</span> <span class="n">z22</span>
                <span class="k">if</span> <span class="n">i</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
                    <span class="n">proj1</span><span class="p">,</span><span class="n">proj2</span> <span class="o">=</span> <span class="n">proj_dict_equal_wvl</span><span class="p">(</span><span class="n">temp1</span><span class="p">,</span><span class="n">temp2</span><span class="p">,</span><span class="n">opt</span><span class="p">,</span><span class="n">mr_file</span><span class="p">,</span><span class="n">corr_coeff</span><span class="o">=</span><span class="n">wvl_transp_cor</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">proj1</span><span class="p">,</span><span class="n">proj2</span> <span class="o">=</span> <span class="n">proj_dict_equal_wvl_ortho</span><span class="p">(</span><span class="n">temp1</span><span class="p">,</span><span class="n">temp2</span><span class="p">,</span><span class="n">comp</span><span class="p">[:,:,</span><span class="mi">0</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">],</span><span class="n">opt</span><span class="p">,</span><span class="n">mr_file</span><span class="p">,</span><span class="n">corr_coeff</span><span class="o">=</span><span class="n">wvl_transp_cor</span><span class="p">)</span>
                <span class="n">z21</span> <span class="o">=</span> <span class="n">z21</span><span class="o">+</span><span class="n">lambd</span><span class="o">*</span><span class="p">(</span><span class="n">proj1</span><span class="o">-</span><span class="n">comp</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">])</span>
                <span class="n">z22</span> <span class="o">=</span> <span class="n">z22</span><span class="o">+</span><span class="n">lambd</span><span class="o">*</span><span class="p">(</span><span class="n">proj2</span><span class="o">-</span><span class="n">x2</span><span class="p">)</span>

                <span class="c1"># ---- Main variable update ---- #</span>
                <span class="n">comp</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">w1</span><span class="o">*</span><span class="n">z11</span> <span class="o">+</span> <span class="n">w2</span><span class="o">*</span><span class="n">z21</span>
                <span class="n">x2</span> <span class="o">=</span> <span class="n">w1</span><span class="o">*</span><span class="n">z12</span> <span class="o">+</span> <span class="n">w2</span><span class="o">*</span><span class="n">z22</span>
                <span class="nb">print</span> <span class="s2">&quot;min val: &quot;</span><span class="p">,</span><span class="n">comp</span><span class="p">[:,:,</span><span class="mi">0</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
                <span class="n">count</span><span class="o">+=</span><span class="mi">1</span>
                <span class="c1">#comp[:,:,i] = z1</span>
                <span class="k">if</span> <span class="n">j</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
                    <span class="nb">print</span> <span class="s2">&quot;Estimated noise at the first scales: &quot;</span><span class="p">,</span><span class="n">sig_map</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,:]</span>

                <span class="n">j</span><span class="o">+=</span><span class="mi">1</span>

                <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
                    <span class="n">resk</span><span class="p">[:,:,</span><span class="n">l</span><span class="p">]</span> <span class="o">=</span> <span class="n">res</span><span class="p">[:,:,</span><span class="n">l</span><span class="p">]</span><span class="o">-</span><span class="p">(</span><span class="n">w</span><span class="p">[</span><span class="n">l</span><span class="p">]</span><span class="o">*</span><span class="n">flux_ref</span><span class="o">/</span><span class="p">(</span><span class="n">sig_est</span><span class="p">[</span><span class="n">l</span><span class="p">]</span><span class="o">*</span><span class="n">flux_est</span><span class="p">[</span><span class="n">l</span><span class="p">]))</span><span class="o">*</span><span class="n">utils</span><span class="o">.</span><span class="n">decim</span><span class="p">(</span><span class="n">scisig</span><span class="o">.</span><span class="n">fftconvolve</span><span class="p">(</span><span class="n">comp</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">],</span><span class="n">shift_ker_stack</span><span class="p">[:,:,</span><span class="n">l</span><span class="p">],</span><span class="n">mode</span><span class="o">=</span><span class="s1">&#39;same&#39;</span><span class="p">),</span><span class="n">upfact</span><span class="p">,</span><span class="n">av_en</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                <span class="n">buff</span><span class="p">[</span><span class="n">j</span><span class="o">%</span><span class="n">nb_subiter_min</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">resk</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>

                <span class="nb">print</span> <span class="s2">&quot;mse: &quot;</span><span class="p">,</span> <span class="n">buff</span><span class="p">[</span><span class="n">j</span><span class="o">%</span><span class="n">nb_subiter_min</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">j</span><span class="o">&gt;=</span><span class="n">nb_subiter_min</span><span class="p">:</span>
                    <span class="n">cur_res</span> <span class="o">=</span> <span class="n">buff</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">cur_res</span> <span class="o">=</span> <span class="n">buff</span><span class="p">[</span><span class="n">j</span><span class="o">%</span><span class="n">nb_subiter_min</span><span class="p">]</span>
                <span class="c1"># Sparsity transfer check</span>
                <span class="n">x2est</span><span class="p">,</span><span class="n">mr_file_temp</span> <span class="o">=</span> <span class="n">isap</span><span class="o">.</span><span class="n">mr_trans</span><span class="p">(</span><span class="n">comp</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">],</span><span class="n">opt</span><span class="o">=</span><span class="n">opt</span><span class="p">)</span>
                <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">mr_file_temp</span><span class="p">)</span>
                <span class="n">misfit</span> <span class="o">=</span> <span class="mi">100</span><span class="o">*</span><span class="p">((</span><span class="n">x2est</span><span class="p">[:,:,</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">x2</span><span class="p">[:,:,</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">/</span><span class="p">(</span><span class="n">x2</span><span class="p">[:,:,</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
                <span class="nb">print</span> <span class="n">misfit</span><span class="p">,</span><span class="s2">&quot;</span><span class="si">% o</span><span class="s2">f sparsity not transfered&quot;</span>

            <span class="n">buff</span><span class="o">=</span><span class="n">buff</span><span class="o">*</span><span class="mi">0</span>
            <span class="c1"># Component normalization</span>
            <span class="n">a</span> <span class="o">=</span> <span class="n">sqrt</span><span class="p">((</span><span class="n">comp</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span>
            <span class="n">comp</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">comp</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">]</span><span class="o">/</span><span class="n">a</span>
            <span class="n">weights</span><span class="p">[</span><span class="n">i</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">a</span><span class="o">*</span><span class="n">weights</span><span class="p">[</span><span class="n">i</span><span class="p">,:]</span>
            <span class="c1"># Reweighting</span>
            <span class="n">coeffx</span><span class="p">,</span><span class="n">mr_file_temp</span> <span class="o">=</span> <span class="n">isap</span><span class="o">.</span><span class="n">mr_trans</span><span class="p">(</span><span class="n">comp</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">],</span><span class="n">opt</span><span class="o">=</span><span class="n">opt</span><span class="p">)</span>
            <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">mr_file_temp</span><span class="p">)</span>
            <span class="n">weights_sp</span>  <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="nb">abs</span><span class="p">(</span><span class="n">coeffx</span><span class="p">[:,:,:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span><span class="o">/</span><span class="p">(</span><span class="n">nsig</span><span class="o">*</span><span class="n">sig_map</span><span class="p">))</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="c1"># Residual update and HR images update</span>
        <span class="n">res_old_comp</span> <span class="o">=</span> <span class="n">cur_res_comp</span>
        <span class="n">cur_res_comp</span> <span class="o">=</span> <span class="n">buff</span><span class="p">[</span><span class="n">j</span><span class="o">%</span><span class="n">nb_subiter_min</span><span class="p">]</span>
        <span class="n">res_inter_comp</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">buff</span><span class="p">[</span><span class="n">j</span><span class="o">%</span><span class="n">nb_subiter_min</span><span class="p">]</span>
        <span class="n">im_hr</span> <span class="o">=</span> <span class="mi">0</span><span class="o">*</span><span class="n">im_hr</span>
        <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
            <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
                <span class="n">im_hr</span><span class="p">[:,:,</span><span class="n">l</span><span class="p">]</span> <span class="o">=</span> <span class="n">im_hr</span><span class="p">[:,:,</span><span class="n">l</span><span class="p">]</span><span class="o">+</span><span class="n">weights</span><span class="p">[</span><span class="n">p</span><span class="p">,</span><span class="n">l</span><span class="p">]</span><span class="o">*</span><span class="n">comp</span><span class="p">[:,:,</span><span class="n">p</span><span class="p">]</span>
            <span class="n">res</span><span class="p">[:,:,</span><span class="n">l</span><span class="p">]</span> <span class="o">=</span> <span class="n">psf_stack</span><span class="p">[:,:,</span><span class="n">l</span><span class="p">]</span><span class="o">-</span><span class="p">(</span><span class="n">flux_ref</span><span class="o">/</span><span class="p">(</span><span class="n">sig_est</span><span class="p">[</span><span class="n">l</span><span class="p">]</span><span class="o">*</span><span class="n">flux_est</span><span class="p">[</span><span class="n">l</span><span class="p">]))</span><span class="o">*</span><span class="n">utils</span><span class="o">.</span><span class="n">decim</span><span class="p">(</span><span class="n">scisig</span><span class="o">.</span><span class="n">fftconvolve</span><span class="p">(</span><span class="n">im_hr</span><span class="p">[:,:,</span><span class="n">l</span><span class="p">],</span><span class="n">shift_ker_stack</span><span class="p">[:,:,</span><span class="n">l</span><span class="p">],</span><span class="n">mode</span><span class="o">=</span><span class="s1">&#39;same&#39;</span><span class="p">),</span><span class="n">upfact</span><span class="p">,</span><span class="n">av_en</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">comp_lr</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">,</span><span class="n">l</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">flux_ref</span><span class="o">/</span><span class="p">(</span><span class="n">sig_est</span><span class="p">[</span><span class="n">l</span><span class="p">]</span><span class="o">*</span><span class="n">flux_est</span><span class="p">[</span><span class="n">l</span><span class="p">]))</span><span class="o">*</span><span class="n">utils</span><span class="o">.</span><span class="n">decim</span><span class="p">(</span><span class="n">scisig</span><span class="o">.</span><span class="n">fftconvolve</span><span class="p">(</span><span class="n">comp</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">],</span><span class="n">shift_ker_stack</span><span class="p">[:,:,</span><span class="n">l</span><span class="p">],</span><span class="n">mode</span><span class="o">=</span><span class="s1">&#39;same&#39;</span><span class="p">),</span><span class="n">upfact</span><span class="p">,</span><span class="n">av_en</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">i</span><span class="o">+=</span><span class="mi">1</span>
        <span class="c1"># Optim variables resetting</span>
        <span class="n">z11</span> <span class="o">=</span> <span class="n">z11</span><span class="o">*</span><span class="mi">0</span>
        <span class="n">z12</span> <span class="o">=</span> <span class="n">z12</span><span class="o">*</span><span class="mi">0</span>
        <span class="n">z21</span> <span class="o">=</span> <span class="n">z21</span><span class="o">*</span><span class="mi">0</span>
        <span class="n">z22</span> <span class="o">=</span> <span class="n">z22</span><span class="o">*</span><span class="mi">0</span>
        <span class="n">i1</span><span class="p">,</span><span class="n">i2</span><span class="p">,</span><span class="n">i3</span> <span class="o">=</span> <span class="n">where</span><span class="p">(</span><span class="n">weights_sp</span><span class="o">!=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">weights_sp</span><span class="p">[</span><span class="n">i1</span><span class="p">,</span><span class="n">i2</span><span class="p">,</span><span class="n">i3</span><span class="p">]</span><span class="o">=</span><span class="mi">1</span>
    <span class="c1"># coeff_init = coeff_init*0</span>
    <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">mr_file</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">im_hr</span><span class="p">,</span><span class="n">comp</span><span class="p">,</span><span class="n">weights</span><span class="p">,</span><span class="n">res</span><span class="p">,</span><span class="n">sig_est</span><span class="o">*</span><span class="n">sig_min</span><span class="p">,</span><span class="n">flux_est</span><span class="p">,</span><span class="n">shifts</span><span class="p">,</span><span class="n">res_inter_comp</span>



<span class="k">def</span> <span class="nf">positive_cv_update</span><span class="p">(</span><span class="n">X</span><span class="p">,</span><span class="n">S</span><span class="p">,</span><span class="n">Ainit</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">pseudo_inv</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">nb_iter</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span><span class="n">tol</span><span class="o">=</span><span class="mi">10</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mi">10</span><span class="p">)):</span> <span class="c1"># X and S are assumed to be positive; This routine calculates A so that to minimize KL(SA|X), with the constraint that the sum of A&#39;s rows are 1; the observations are stored in X lines</span>
    <span class="n">Xpos</span> <span class="o">=</span> <span class="n">pos_proj_mat</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
    <span class="n">Spos</span> <span class="o">=</span> <span class="n">pos_proj_mat</span><span class="p">(</span><span class="n">S</span><span class="p">)</span>

    <span class="n">shap</span> <span class="o">=</span> <span class="p">[</span><span class="n">S</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
    <span class="k">if</span> <span class="n">Ainit</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">ones_line</span> <span class="o">=</span> <span class="n">ones</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
        <span class="n">pseudo_inv</span> <span class="o">=</span> <span class="n">LA</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">transpose</span><span class="p">(</span><span class="n">S</span><span class="p">)</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">S</span><span class="p">))</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">transpose</span><span class="p">(</span><span class="n">S</span><span class="p">))</span>
        <span class="n">Alsq</span> <span class="o">=</span> <span class="n">pos_proj_mat</span><span class="p">(</span><span class="n">pseudo_inv</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">X</span><span class="p">))</span>
        <span class="n">Ainit</span> <span class="o">=</span> <span class="n">transpose</span><span class="p">(</span><span class="n">kl_marg_proj</span><span class="p">(</span><span class="n">transpose</span><span class="p">(</span><span class="n">Alsq</span><span class="p">),</span><span class="n">transpose</span><span class="p">(</span><span class="n">ones_line</span><span class="p">)))</span>
    <span class="n">A</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">Ainit</span><span class="p">)</span>
    <span class="n">k</span><span class="o">=</span><span class="mi">0</span>
    <span class="n">Slmarg</span> <span class="o">=</span> <span class="n">Spos</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="nb">id</span> <span class="o">=</span> <span class="n">where</span><span class="p">(</span><span class="n">Slmarg</span><span class="o">==</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">A</span><span class="p">[</span><span class="nb">id</span><span class="p">,:]</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">id1</span><span class="p">,</span><span class="n">id2</span> <span class="o">=</span> <span class="n">where</span><span class="p">(</span><span class="n">Xpos</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">var</span> <span class="o">=</span> <span class="mi">100</span>
    <span class="k">while</span> <span class="n">k</span> <span class="o">&lt;</span> <span class="n">nb_iter</span> <span class="ow">and</span> <span class="n">var</span><span class="o">&gt;</span><span class="n">tol</span> <span class="p">:</span>
        <span class="n">k</span><span class="o">+=</span><span class="mi">1</span>
        <span class="n">Xest</span> <span class="o">=</span> <span class="n">Spos</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">A</span><span class="p">)</span>
        <span class="n">kl_div</span> <span class="o">=</span> <span class="p">(</span><span class="n">Xest</span><span class="p">[</span><span class="n">id1</span><span class="p">,</span><span class="n">id2</span><span class="p">]</span> <span class="o">-</span> <span class="n">Xpos</span><span class="p">[</span><span class="n">id1</span><span class="p">,</span><span class="n">id2</span><span class="p">]</span><span class="o">*</span><span class="n">log</span><span class="p">(</span><span class="n">Xest</span><span class="p">[</span><span class="n">id1</span><span class="p">,</span><span class="n">id2</span><span class="p">]</span><span class="o">/</span><span class="n">Xpos</span><span class="p">[</span><span class="n">id1</span><span class="p">,</span><span class="n">id2</span><span class="p">]))</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="n">lsq</span> <span class="o">=</span> <span class="p">((</span><span class="n">Xest</span><span class="o">-</span><span class="n">Xpos</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="n">Aold</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">A</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
                <span class="k">if</span> <span class="n">Slmarg</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
                    <span class="nb">id</span> <span class="o">=</span> <span class="n">where</span><span class="p">(</span><span class="n">Xest</span><span class="p">[:,</span><span class="n">j</span><span class="p">]</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">)</span>
                    <span class="n">num</span> <span class="o">=</span> <span class="p">(</span><span class="n">Spos</span><span class="p">[</span><span class="nb">id</span><span class="p">,</span><span class="n">i</span><span class="p">]</span><span class="o">*</span><span class="n">Xpos</span><span class="p">[</span><span class="nb">id</span><span class="p">,</span><span class="n">j</span><span class="p">]</span><span class="o">/</span><span class="n">Xest</span><span class="p">[</span><span class="nb">id</span><span class="p">,</span><span class="n">j</span><span class="p">])</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
                    <span class="n">A</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">A</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span><span class="o">*</span><span class="n">num</span><span class="o">/</span><span class="n">Slmarg</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">A</span> <span class="o">=</span> <span class="n">transpose</span><span class="p">(</span><span class="n">kl_marg_proj</span><span class="p">(</span><span class="n">transpose</span><span class="p">(</span><span class="n">A</span><span class="p">),</span><span class="n">transpose</span><span class="p">(</span><span class="n">ones_line</span><span class="p">)))</span>
        <span class="n">var</span> <span class="o">=</span> <span class="mi">100</span><span class="o">*</span><span class="p">((</span><span class="n">A</span><span class="o">-</span><span class="n">Aold</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">/</span><span class="p">(</span><span class="n">Aold</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    <span class="nb">print</span> <span class="s2">&quot;coeff update lsq: &quot;</span><span class="p">,</span><span class="n">lsq</span>
    <span class="k">return</span> <span class="n">A</span>

<span class="c1">#def positive_cv_update_GFB(X,S,Ainit=None,pseudo_inv=None,nb_iter=100,tol=10**(-10)):</span>


<span class="k">def</span> <span class="nf">positive_lsq</span><span class="p">(</span><span class="n">X</span><span class="p">,</span><span class="n">A</span><span class="p">,</span><span class="n">pseudo_inv</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">Sinit</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">nb_iter</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span><span class="n">tol</span><span class="o">=</span><span class="mf">1e-15</span><span class="p">):</span> <span class="c1"># This routine minimizes ||X-SA||_2^2 with S positive; the observations are stored in X colmns</span>
    <span class="k">if</span> <span class="n">Sinit</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">pseudo_inv</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">pseudo_inv</span> <span class="o">=</span> <span class="n">transpose</span><span class="p">(</span><span class="n">A</span><span class="p">)</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">LA</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">A</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">transpose</span><span class="p">(</span><span class="n">A</span><span class="p">))))</span>
        <span class="n">Sinit</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">pseudo_inv</span><span class="p">)</span>
    <span class="n">S</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">Sinit</span><span class="p">)</span>
    <span class="n">T</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">S</span><span class="p">)</span>
    <span class="n">M</span> <span class="o">=</span> <span class="n">A</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">transpose</span><span class="p">(</span><span class="n">A</span><span class="p">))</span>
    <span class="n">U</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">Vt</span> <span class="o">=</span> <span class="n">linalg</span><span class="o">.</span><span class="n">svd</span><span class="p">(</span><span class="n">M</span><span class="p">,</span><span class="n">full_matrices</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">spec_rad</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
    <span class="n">t</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">k</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">var</span> <span class="o">=</span> <span class="mi">100</span>
    <span class="k">while</span> <span class="n">k</span> <span class="o">&lt;</span><span class="n">nb_iter</span> <span class="ow">and</span> <span class="n">var</span><span class="o">&gt;</span><span class="n">tol</span><span class="p">:</span>
        <span class="n">k</span><span class="o">+=</span><span class="mi">1</span>
        <span class="n">grad</span> <span class="o">=</span> <span class="n">S</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">M</span><span class="p">)</span><span class="o">-</span><span class="n">X</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">transpose</span><span class="p">(</span><span class="n">A</span><span class="p">))</span>
        <span class="n">Y</span> <span class="o">=</span> <span class="n">S</span> <span class="o">-</span> <span class="n">grad</span><span class="o">/</span><span class="n">spec_rad</span>
        <span class="n">Told</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">T</span><span class="p">)</span>
        <span class="c1">#T = pos_proj_mat(Y)</span>
        <span class="n">T</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">Y</span><span class="p">)</span>
        <span class="n">told</span> <span class="o">=</span> <span class="n">t</span>
        <span class="n">t</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">4</span><span class="o">*</span><span class="n">t</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span><span class="o">/</span><span class="mi">2</span>
        <span class="n">lambd</span> <span class="o">=</span> <span class="mi">1</span><span class="o">+</span><span class="p">(</span><span class="n">told</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="n">t</span>
        <span class="n">Sold</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">S</span><span class="p">)</span>
        <span class="n">S</span> <span class="o">=</span> <span class="n">Told</span> <span class="o">+</span> <span class="n">lambd</span><span class="o">*</span><span class="p">(</span><span class="n">T</span><span class="o">-</span><span class="n">Told</span><span class="p">)</span>
        <span class="n">var</span> <span class="o">=</span> <span class="mi">100</span><span class="o">*</span><span class="p">((</span><span class="n">S</span><span class="o">-</span><span class="n">Sold</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">/</span><span class="p">(</span><span class="n">Sold</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">X</span><span class="o">-</span><span class="n">S</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">A</span><span class="p">)</span>

    <span class="nb">print</span> <span class="s2">&quot;SOurces update res: &quot;</span><span class="p">,(</span><span class="n">res</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">S</span>

<span class="k">def</span> <span class="nf">pos_convex_hull_est</span><span class="p">(</span><span class="n">X</span><span class="p">,</span><span class="n">nb_points</span><span class="p">,</span><span class="n">nb_iter</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span><span class="n">rand_disp_param</span><span class="o">=</span><span class="mf">0.4</span><span class="p">,</span><span class="n">thresh</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">sparsity_pow</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span><span class="n">hull_tightening</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">Sinit</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">src_ind</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">Ainit</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span> <span class="c1"># The observations are stored in lines</span>
    <span class="n">shap</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">shape</span>
    <span class="k">if</span> <span class="n">src_ind</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">src_ind</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">U</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">Vt</span> <span class="o">=</span> <span class="n">linalg</span><span class="o">.</span><span class="n">svd</span><span class="p">(</span><span class="n">X</span><span class="p">[:,</span><span class="n">src_ind</span><span class="p">],</span><span class="n">full_matrices</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">weights</span> <span class="o">=</span> <span class="n">s</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">nb_points</span><span class="p">]</span>
    <span class="n">basis</span> <span class="o">=</span> <span class="n">transpose</span><span class="p">(</span><span class="n">Vt</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">nb_points</span><span class="p">,:])</span>
    <span class="c1">#Sinit,centroid,label_ind,ret = utils.convex_hull_init(X,nb_points)</span>
    <span class="n">centroid</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">if</span> <span class="n">Sinit</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">tSinit</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">convex_hull_init_3</span><span class="p">(</span><span class="n">X</span><span class="p">,</span><span class="n">nb_points</span><span class="p">,</span><span class="n">nb_frac</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>
        <span class="n">Sinit</span> <span class="o">=</span> <span class="n">transpose</span><span class="p">(</span><span class="n">tSinit</span><span class="p">)</span>
        <span class="c1">#tSinit,centroid = utils.convex_hull_init_2(X,nb_points)</span>


    <span class="n">S</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">Sinit</span><span class="p">)</span>
    <span class="n">Sdisp</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">S</span><span class="p">)</span>
    <span class="n">A</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">Ainit</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">A</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">Ainit</span><span class="p">)</span>
    <span class="n">X2</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">transpose</span><span class="p">(</span><span class="n">X</span><span class="p">))</span>
    <span class="n">U</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">Vt</span> <span class="o">=</span> <span class="n">linalg</span><span class="o">.</span><span class="n">svd</span><span class="p">(</span><span class="n">X2</span><span class="p">,</span><span class="n">full_matrices</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">ref_res</span> <span class="o">=</span> <span class="n">s</span><span class="p">[</span><span class="n">nb_points</span><span class="p">:]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    <span class="n">ones_vect</span> <span class="o">=</span> <span class="n">ones</span><span class="p">((</span><span class="n">nb_points</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">centroid</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">centroid</span> <span class="o">=</span> <span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">/</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">centroidn</span> <span class="o">=</span> <span class="n">ones_vect</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">centroid</span><span class="p">)</span>

    <span class="nb">print</span> <span class="s2">&quot;ref_res: &quot;</span><span class="p">,</span><span class="n">ref_res</span>
    <span class="n">res_in</span><span class="o">=</span><span class="kc">None</span>
    <span class="n">thresh_map</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_iter</span><span class="p">):</span>
        <span class="c1">#A = positive_cv_update(transpose(X),transpose(Sdisp),nb_iter=150)</span>
        <span class="n">A</span> <span class="o">=</span> <span class="n">bar_coord_pb_field</span><span class="p">(</span><span class="n">transpose</span><span class="p">(</span><span class="n">Sdisp</span><span class="p">),</span><span class="n">transpose</span><span class="p">(</span><span class="n">X</span><span class="p">),</span><span class="n">tinit</span><span class="o">=</span><span class="n">A</span><span class="p">,</span><span class="n">nb_iter</span><span class="o">=</span><span class="mi">8000</span><span class="p">,</span><span class="n">tol</span><span class="o">=</span><span class="mf">1e-15</span><span class="p">)</span>
        <span class="c1">#A = sparse_bar_coord_pb_field(transpose(Sdisp),transpose(X),tinit=A,thresh_map=thresh_map,thresh_type=1,nb_iter=8000,tol=1e-15)</span>
        <span class="n">S</span><span class="p">[:,</span><span class="n">src_ind</span><span class="p">]</span> <span class="o">=</span> <span class="n">transpose</span><span class="p">(</span><span class="n">positive_lsq</span><span class="p">(</span><span class="n">transpose</span><span class="p">(</span><span class="n">X</span><span class="p">[:,</span><span class="n">src_ind</span><span class="p">]),</span><span class="n">A</span><span class="p">,</span><span class="n">nb_iter</span><span class="o">=</span><span class="mi">8000</span><span class="p">,</span><span class="n">Sinit</span><span class="o">=</span><span class="n">transpose</span><span class="p">(</span><span class="n">S</span><span class="p">[:,</span><span class="n">src_ind</span><span class="p">])))</span>
        <span class="c1"># Random perturbation</span>
        <span class="n">dist</span> <span class="o">=</span> <span class="n">sqrt</span><span class="p">(((</span><span class="n">S</span><span class="o">-</span><span class="n">centroidn</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
        <span class="nb">print</span> <span class="s2">&quot;mean distance to data set barycenter: &quot;</span><span class="p">,</span><span class="n">mean</span><span class="p">(</span><span class="n">dist</span><span class="p">)</span>
        <span class="n">sig</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="n">nb_points</span><span class="p">)</span><span class="o">*</span><span class="n">dist</span><span class="o">*</span><span class="n">rand_disp_param</span><span class="o">*</span><span class="p">(</span><span class="n">nb_iter</span><span class="o">-</span><span class="mi">1</span><span class="o">-</span><span class="n">k</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">nb_iter</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">Sdisp</span><span class="p">[:,</span><span class="n">src_ind</span><span class="p">]</span> <span class="o">=</span> <span class="n">transpose</span><span class="p">(</span><span class="n">utils</span><span class="o">.</span><span class="n">tg_rand_disp_set</span><span class="p">(</span><span class="n">transpose</span><span class="p">(</span><span class="n">centroid</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">src_ind</span><span class="p">]),</span><span class="n">transpose</span><span class="p">(</span><span class="n">S</span><span class="p">[:,</span><span class="n">src_ind</span><span class="p">]),</span><span class="n">sig</span><span class="p">,</span><span class="n">basis</span><span class="p">,</span><span class="n">weights</span><span class="o">=</span><span class="n">weights</span><span class="p">))</span>

        <span class="n">res</span> <span class="o">=</span> <span class="n">X</span> <span class="o">-</span> <span class="n">transpose</span><span class="p">(</span><span class="n">A</span><span class="p">)</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">S</span><span class="p">)</span>
        <span class="nb">print</span> <span class="s2">&quot;global res: &quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">res</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="n">res_in</span> <span class="o">=</span> <span class="p">((</span><span class="n">X</span> <span class="o">-</span> <span class="n">transpose</span><span class="p">(</span><span class="n">A</span><span class="p">)</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">Sdisp</span><span class="p">))</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    <span class="n">res_in</span> <span class="o">=</span> <span class="p">(</span><span class="n">res</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    <span class="n">Arough</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">A</span><span class="p">)</span>
    <span class="n">Srough</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">S</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">hull_tightening</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_iter</span><span class="p">):</span>
            <span class="c1">#A = positive_cv_update(transpose(X),transpose(Sdisp),nb_iter=150)</span>
            <span class="c1">#A = sparse_bar_coord_pb_field(transpose(Sdisp),transpose(X),tinit=A,thresh_map=thresh_map,thresh_type=1,nb_iter=8000,tol=1e-15)</span>
            <span class="n">thresh_k</span> <span class="o">=</span> <span class="n">double</span><span class="p">(</span><span class="n">thresh</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">double</span><span class="p">(</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="n">nb_iter</span><span class="p">)</span><span class="o">**</span><span class="n">sparsity_pow</span>
            <span class="n">thresh_map</span> <span class="o">=</span> <span class="n">thresh_k</span><span class="o">*</span><span class="p">((</span><span class="n">A</span><span class="o">/</span><span class="n">thresh_k</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">A</span> <span class="o">=</span> <span class="n">sparse_bar_coord_pb_field_cp</span><span class="p">(</span><span class="n">transpose</span><span class="p">(</span><span class="n">S</span><span class="p">),</span><span class="n">transpose</span><span class="p">(</span><span class="n">X</span><span class="p">),</span><span class="n">res_in</span><span class="p">,</span><span class="n">A</span><span class="p">,</span><span class="n">thresh_map</span><span class="p">,</span><span class="n">thresh_type</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">nb_iter</span><span class="o">=</span><span class="mi">10000</span><span class="p">,</span><span class="n">tol</span><span class="o">=</span><span class="mf">1e-15</span><span class="p">,</span><span class="n">eps</span><span class="o">=</span><span class="mf">0.8</span><span class="p">)</span>
            <span class="n">res</span> <span class="o">=</span> <span class="n">X</span> <span class="o">-</span> <span class="n">transpose</span><span class="p">(</span><span class="n">A</span><span class="p">)</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">S</span><span class="p">)</span>
            <span class="k">if</span> <span class="p">((</span><span class="n">res</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">&lt;</span><span class="n">res_in</span><span class="p">):</span>
                <span class="n">res_in</span> <span class="o">=</span> <span class="p">(</span><span class="n">res</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
            <span class="c1">#S = transpose(positive_lsq(transpose(X),A,nb_iter=1000,Sinit=transpose(S)))</span>
            <span class="n">S</span><span class="p">[:,</span><span class="n">src_ind</span><span class="p">]</span> <span class="o">=</span> <span class="n">transpose</span><span class="p">(</span><span class="n">spreading_constraint_src_update_cp</span><span class="p">(</span><span class="n">transpose</span><span class="p">(</span><span class="n">X</span><span class="p">[:,</span><span class="n">src_ind</span><span class="p">]),</span><span class="n">A</span><span class="p">,</span><span class="n">transpose</span><span class="p">(</span><span class="n">centroid</span><span class="p">),</span><span class="n">transpose</span><span class="p">(</span><span class="n">S</span><span class="p">[:,</span><span class="n">src_ind</span><span class="p">]),</span><span class="n">res_in</span><span class="p">,</span><span class="n">tol</span><span class="o">=</span><span class="mf">1e-15</span><span class="p">,</span><span class="n">nb_iter</span><span class="o">=</span><span class="mi">10000</span><span class="p">,</span><span class="n">accel_en</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
            <span class="n">dist</span> <span class="o">=</span> <span class="n">sqrt</span><span class="p">(((</span><span class="n">S</span><span class="o">-</span><span class="n">centroidn</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
            <span class="nb">print</span> <span class="s2">&quot;mean distance to data set barycenter: &quot;</span><span class="p">,</span><span class="n">mean</span><span class="p">(</span><span class="n">dist</span><span class="p">)</span>

            <span class="n">res</span> <span class="o">=</span> <span class="n">X</span> <span class="o">-</span> <span class="n">transpose</span><span class="p">(</span><span class="n">A</span><span class="p">)</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">S</span><span class="p">)</span>
            <span class="k">if</span> <span class="p">((</span><span class="n">res</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">&lt;</span><span class="n">res_in</span><span class="p">):</span>
                <span class="n">res_in</span> <span class="o">=</span> <span class="p">(</span><span class="n">res</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
            <span class="nb">print</span> <span class="s2">&quot;global res: &quot;</span><span class="p">,(</span><span class="n">res</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    <span class="n">A</span> <span class="o">=</span> <span class="n">pos_proj</span><span class="p">(</span><span class="n">A</span><span class="p">)</span>
    <span class="n">one_vect</span> <span class="o">=</span> <span class="n">ones</span><span class="p">((</span><span class="n">nb_points</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>
    <span class="n">A</span> <span class="o">=</span> <span class="n">A</span><span class="o">/</span><span class="p">(</span><span class="n">one_vect</span><span class="o">.</span><span class="n">dot</span><span class="p">((</span><span class="n">A</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">])))</span>

    <span class="k">return</span> <span class="n">A</span><span class="p">,</span><span class="n">S</span><span class="p">,</span><span class="n">Arough</span><span class="p">,</span><span class="n">Srough</span>

<span class="k">def</span> <span class="nf">im_cv_hull_interf</span><span class="p">(</span><span class="n">im_stack</span><span class="p">,</span><span class="n">nb_points</span><span class="p">,</span><span class="n">nb_iter</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span><span class="n">hull_tightening</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="n">X</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">cube_to_mat</span><span class="p">(</span><span class="n">im_stack</span><span class="p">)</span>
    <span class="n">A</span><span class="p">,</span><span class="n">S</span><span class="p">,</span><span class="n">Arough</span><span class="p">,</span><span class="n">Srough</span> <span class="o">=</span> <span class="n">pos_convex_hull_est</span><span class="p">(</span><span class="n">X</span><span class="p">,</span><span class="n">nb_points</span><span class="p">,</span><span class="n">nb_iter</span><span class="o">=</span><span class="n">nb_iter</span><span class="p">,</span><span class="n">hull_tightening</span><span class="o">=</span><span class="n">hull_tightening</span><span class="p">)</span>
    <span class="n">shap</span> <span class="o">=</span> <span class="n">im_stack</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">Sim</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">mat_to_cube</span><span class="p">(</span><span class="n">S</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">A</span><span class="p">,</span><span class="n">Sim</span><span class="p">,</span><span class="n">Arough</span><span class="p">,</span><span class="n">Srough</span>

<span class="k">def</span> <span class="nf">im_cv_hull_interf_2</span><span class="p">(</span><span class="n">im_stack</span><span class="p">,</span><span class="n">nb_points</span><span class="p">,</span><span class="n">coord</span><span class="p">,</span><span class="n">nb_alt</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span><span class="n">nb_iter</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span><span class="n">scaling_fact</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span><span class="n">hull_tightening</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="c1">#X = utils.cube_to_mat(im_stack)</span>
    <span class="n">X</span><span class="p">,</span><span class="n">scal_fact</span> <span class="o">=</span> <span class="n">psf_learning_utils</span><span class="o">.</span><span class="n">data_shaping_2</span><span class="p">(</span><span class="n">im_stack</span><span class="p">,</span><span class="n">coord</span><span class="p">,</span><span class="n">scaling_fact</span><span class="o">=</span><span class="n">scaling_fact</span><span class="p">)</span>
    <span class="n">shap</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">shape</span>

    <span class="n">range_2</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">range_1</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">A</span><span class="o">=</span><span class="kc">None</span>
    <span class="n">S</span><span class="o">=</span><span class="kc">None</span>
    <span class="n">rand_disp_param</span><span class="o">=</span><span class="mf">0.5</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_alt</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">k</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
            <span class="n">rand_disp_param</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">A</span><span class="p">,</span><span class="n">S</span><span class="p">,</span><span class="n">Arough</span><span class="p">,</span><span class="n">Srough</span> <span class="o">=</span> <span class="n">pos_convex_hull_est</span><span class="p">(</span><span class="n">X</span><span class="p">,</span><span class="n">nb_points</span><span class="p">,</span><span class="n">rand_disp_param</span><span class="o">=</span><span class="n">rand_disp_param</span><span class="p">,</span><span class="n">nb_iter</span><span class="o">=</span><span class="n">nb_iter</span><span class="p">,</span><span class="n">hull_tightening</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">src_ind</span><span class="o">=</span><span class="n">range_1</span><span class="p">,</span><span class="n">Sinit</span><span class="o">=</span><span class="n">S</span><span class="p">,</span><span class="n">Ainit</span><span class="o">=</span><span class="n">A</span><span class="p">)</span>
        <span class="n">A</span><span class="p">,</span><span class="n">S</span><span class="p">,</span><span class="n">Arough</span><span class="p">,</span><span class="n">Srough</span> <span class="o">=</span> <span class="n">pos_convex_hull_est</span><span class="p">(</span><span class="n">X</span><span class="p">,</span><span class="n">nb_points</span><span class="p">,</span><span class="n">rand_disp_param</span><span class="o">=</span><span class="n">rand_disp_param</span><span class="p">,</span><span class="n">nb_iter</span><span class="o">=</span><span class="n">nb_iter</span><span class="p">,</span><span class="n">hull_tightening</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">src_ind</span><span class="o">=</span><span class="n">range_2</span><span class="p">,</span><span class="n">Sinit</span><span class="o">=</span><span class="n">S</span><span class="p">,</span><span class="n">Ainit</span><span class="o">=</span><span class="n">A</span><span class="p">)</span>
    <span class="n">A</span><span class="p">,</span><span class="n">S</span><span class="p">,</span><span class="n">Arough</span><span class="p">,</span><span class="n">Srough</span> <span class="o">=</span> <span class="n">pos_convex_hull_est</span><span class="p">(</span><span class="n">X</span><span class="p">,</span><span class="n">nb_points</span><span class="p">,</span><span class="n">rand_disp_param</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_iter</span><span class="o">=</span><span class="n">nb_iter</span><span class="p">,</span><span class="n">hull_tightening</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">src_ind</span><span class="o">=</span><span class="n">range_1</span><span class="p">,</span><span class="n">Sinit</span><span class="o">=</span><span class="n">S</span><span class="p">,</span><span class="n">Ainit</span><span class="o">=</span><span class="n">A</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">hull_tightening</span><span class="p">:</span>
        <span class="n">A</span><span class="p">,</span><span class="n">S</span><span class="p">,</span><span class="n">Arough</span><span class="p">,</span><span class="n">Srough</span> <span class="o">=</span> <span class="n">pos_convex_hull_est</span><span class="p">(</span><span class="n">X</span><span class="p">,</span><span class="n">nb_points</span><span class="p">,</span><span class="n">rand_disp_param</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_iter</span><span class="o">=</span><span class="n">nb_iter</span><span class="p">,</span><span class="n">hull_tightening</span><span class="o">=</span><span class="n">hull_tightening</span><span class="p">,</span><span class="n">src_ind</span><span class="o">=</span><span class="n">range_1</span><span class="p">,</span><span class="n">Sinit</span><span class="o">=</span><span class="n">S</span><span class="p">,</span><span class="n">Ainit</span><span class="o">=</span><span class="n">A</span><span class="p">)</span>
    <span class="n">shap</span> <span class="o">=</span> <span class="n">im_stack</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">Sim</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">mat_to_cube</span><span class="p">(</span><span class="n">S</span><span class="p">[:,</span><span class="mi">0</span><span class="p">:</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">]],</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">coord_src</span> <span class="o">=</span> <span class="n">S</span><span class="p">[:,</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">]:]</span><span class="o">/</span><span class="n">scal_fact</span>
    <span class="k">return</span> <span class="n">A</span><span class="p">,</span><span class="n">Sim</span><span class="p">,</span><span class="n">S</span><span class="p">,</span><span class="n">Arough</span><span class="p">,</span><span class="n">Srough</span><span class="p">,</span><span class="n">coord_src</span>

<span class="k">def</span> <span class="nf">proj_dict_equal_wvl</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">opt</span><span class="p">,</span><span class="n">mr_file</span><span class="p">,</span><span class="n">corr_coeff</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span> <span class="c1"># DTD = corr_coeff*Id; ^D = DT/corr_coeff</span>
    <span class="n">shap</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span>
    <span class="k">if</span> <span class="n">corr_coeff</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">dirac</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">(</span><span class="n">shap</span><span class="p">)</span>
        <span class="n">dirac</span><span class="p">[</span><span class="nb">round</span><span class="p">(</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span><span class="p">),</span><span class="nb">round</span><span class="p">(</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span><span class="p">)]</span><span class="o">=</span><span class="mi">1</span>
        <span class="n">t2</span><span class="p">,</span><span class="n">mr_file_temp</span> <span class="o">=</span> <span class="n">isap</span><span class="o">.</span><span class="n">mr_trans</span><span class="p">(</span><span class="n">dirac</span><span class="p">,</span><span class="n">opt</span><span class="o">=</span><span class="n">opt</span><span class="p">)</span>
        <span class="n">a</span> <span class="o">=</span> <span class="p">(</span><span class="n">dirac</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="n">b</span> <span class="o">=</span> <span class="p">(</span><span class="n">t2</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="n">corr_coeff</span> <span class="o">=</span> <span class="n">a</span><span class="o">/</span><span class="n">b</span>
        <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">mr_file_temp</span><span class="p">)</span>
    <span class="n">x1</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span><span class="o">+</span><span class="n">isap</span><span class="o">.</span><span class="n">mr_recons_coeff</span><span class="p">(</span><span class="n">y</span><span class="p">,</span><span class="n">mr_file</span><span class="p">)</span><span class="o">*</span><span class="n">corr_coeff</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">corr_coeff</span><span class="p">)</span>
    <span class="n">y1</span><span class="p">,</span><span class="n">mr_file_temp</span> <span class="o">=</span> <span class="n">isap</span><span class="o">.</span><span class="n">mr_trans</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span><span class="n">opt</span><span class="o">=</span><span class="n">opt</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">mr_file_temp</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">x1</span><span class="p">,</span><span class="n">y1</span>

<span class="k">def</span> <span class="nf">proj_dict_equal_wvl_ortho</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">S</span><span class="p">,</span><span class="n">opt</span><span class="p">,</span><span class="n">mr_file</span><span class="p">,</span><span class="n">corr_coeff</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span> <span class="c1"># DTD = corr_coeff*Id; ^D = DT/corr_coeff</span>
    <span class="n">shap</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span>
    <span class="k">if</span> <span class="n">corr_coeff</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">dirac</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">(</span><span class="n">shap</span><span class="p">)</span>
        <span class="n">dirac</span><span class="p">[</span><span class="nb">round</span><span class="p">(</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span><span class="p">),</span><span class="nb">round</span><span class="p">(</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span><span class="p">)]</span><span class="o">=</span><span class="mi">1</span>
        <span class="n">t2</span><span class="p">,</span><span class="n">mr_file_temp</span> <span class="o">=</span> <span class="n">isap</span><span class="o">.</span><span class="n">mr_trans</span><span class="p">(</span><span class="n">dirac</span><span class="p">,</span><span class="n">opt</span><span class="o">=</span><span class="n">opt</span><span class="p">)</span>
        <span class="n">a</span> <span class="o">=</span> <span class="p">(</span><span class="n">dirac</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="n">b</span> <span class="o">=</span> <span class="p">(</span><span class="n">t2</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="n">corr_coeff</span> <span class="o">=</span> <span class="n">a</span><span class="o">/</span><span class="n">b</span>
        <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">mr_file_temp</span><span class="p">)</span>
    <span class="n">x1</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span><span class="o">+</span><span class="n">isap</span><span class="o">.</span><span class="n">mr_recons_coeff</span><span class="p">(</span><span class="n">y</span><span class="p">,</span><span class="n">mr_file</span><span class="p">)</span><span class="o">*</span><span class="n">corr_coeff</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">corr_coeff</span><span class="p">)</span>
    <span class="n">x1</span> <span class="o">=</span> <span class="n">x1</span> <span class="o">-</span> <span class="n">utils</span><span class="o">.</span><span class="n">proj_cube</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span><span class="n">S</span><span class="p">,</span><span class="n">ortho</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
    <span class="n">y1</span><span class="p">,</span><span class="n">mr_file_temp</span> <span class="o">=</span> <span class="n">isap</span><span class="o">.</span><span class="n">mr_trans</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span><span class="n">opt</span><span class="o">=</span><span class="n">opt</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">mr_file_temp</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">x1</span><span class="p">,</span><span class="n">y1</span>

<span class="k">def</span> <span class="nf">lin_cons_proj</span><span class="p">(</span><span class="n">A</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">y</span><span class="p">):</span> <span class="c1"># Project y on the constraint Ax = b</span>
    <span class="n">yproj</span> <span class="o">=</span> <span class="n">y</span> <span class="o">-</span> <span class="p">(</span><span class="n">transpose</span><span class="p">(</span><span class="n">A</span><span class="p">)</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">LA</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">A</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">transpose</span><span class="p">(</span><span class="n">A</span><span class="p">)))))</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">A</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">y</span><span class="p">)</span><span class="o">-</span><span class="n">b</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">yproj</span>

<span class="k">def</span> <span class="nf">pos_lin_cons</span><span class="p">(</span><span class="n">A</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">xinit</span><span class="p">,</span><span class="n">nb_iter</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span><span class="n">tol</span><span class="o">=</span><span class="mf">1e-15</span><span class="p">,</span><span class="n">mu</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
    <span class="n">w1</span> <span class="o">=</span> <span class="mf">0.5</span>
    <span class="n">w2</span> <span class="o">=</span> <span class="mi">1</span><span class="o">-</span><span class="n">w1</span>

    <span class="c1"># Initialization</span>
    <span class="n">x</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">xinit</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">xinit</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">y</span><span class="o">*</span><span class="mi">0</span>

    <span class="n">z1</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">z2</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">mse</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">nb_iter</span><span class="p">,))</span>
    <span class="n">lambd</span> <span class="o">=</span> <span class="mf">1.5</span>
    <span class="n">var</span> <span class="o">=</span> <span class="mi">100</span>
    <span class="n">i</span><span class="o">=</span><span class="mi">0</span>
    <span class="k">while</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">nb_iter</span> <span class="ow">and</span> <span class="n">var</span><span class="o">&gt;</span><span class="n">tol</span><span class="p">:</span>

        <span class="n">res</span> <span class="o">=</span> <span class="n">x</span><span class="o">-</span><span class="n">y</span>
        <span class="n">grad</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>
        <span class="n">mse</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">res</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="c1">#print mse[i]</span>
        <span class="n">temp1</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">x</span> <span class="o">-</span> <span class="n">z1</span> <span class="o">-</span> <span class="n">mu</span><span class="o">*</span><span class="n">grad</span>
        <span class="n">z1</span> <span class="o">=</span> <span class="n">z1</span> <span class="o">+</span> <span class="n">lambd</span><span class="o">*</span><span class="p">(</span><span class="n">lin_cons_proj</span><span class="p">(</span><span class="n">A</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">temp1</span><span class="p">)</span><span class="o">-</span><span class="n">x</span><span class="p">)</span>
        <span class="n">temp2</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">x</span> <span class="o">-</span> <span class="n">z2</span> <span class="o">-</span> <span class="n">mu</span><span class="o">*</span><span class="n">grad</span>
        <span class="n">z2</span> <span class="o">=</span> <span class="n">z2</span> <span class="o">+</span> <span class="n">lambd</span><span class="o">*</span><span class="p">(</span><span class="n">pos_proj</span><span class="p">(</span><span class="n">temp2</span><span class="p">)</span><span class="o">-</span><span class="n">x</span><span class="p">)</span>
        <span class="n">xold</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">w1</span><span class="o">*</span><span class="n">z1</span><span class="o">+</span><span class="n">w2</span><span class="o">*</span><span class="n">z2</span>
        <span class="n">var</span>  <span class="o">=</span> <span class="mi">100</span><span class="o">*</span><span class="p">((</span><span class="n">x</span><span class="o">-</span><span class="n">xold</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">/</span><span class="p">(</span><span class="n">xold</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="n">i</span><span class="o">+=</span><span class="mi">1</span>


    <span class="n">x</span> <span class="o">=</span> <span class="n">lin_cons_proj</span><span class="p">(</span><span class="n">A</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">x</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">pos_proj</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">x</span>


<span class="k">def</span> <span class="nf">proj_dict_equal</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">S</span><span class="p">,</span><span class="n">corr_coeff</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span> <span class="c1"># Projects (x,y) onto the constraint y = Mx, knowing that M^TM = Id; this routine assumes that S is given as a stack of image vectors, y is an image and x is a one dimensional array</span>
    <span class="n">shap</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span>
    <span class="k">if</span> <span class="n">corr_coeff</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">d</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
            <span class="n">d</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">S</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="n">corr_coeff</span> <span class="o">=</span> <span class="n">mean</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>
    <span class="n">xout</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">yout</span> <span class="o">=</span> <span class="n">y</span><span class="o">*</span><span class="mi">0</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
        <span class="n">xout</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">+</span><span class="p">(</span><span class="n">y</span><span class="o">*</span><span class="n">S</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">])</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">corr_coeff</span><span class="p">)</span>
        <span class="n">yout</span> <span class="o">+=</span> <span class="n">yout</span> <span class="o">+</span> <span class="n">S</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">]</span><span class="o">*</span><span class="n">xout</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">xout</span><span class="p">,</span><span class="n">yout</span><span class="p">,</span><span class="n">corr_coeff</span>

<span class="k">def</span> <span class="nf">proj_dict_equal_pos_dyks</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">S</span><span class="p">,</span><span class="n">corr_coeff</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">nb_iter</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span><span class="n">tol</span><span class="o">=</span><span class="mi">10</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mi">10</span><span class="p">)):</span>
    <span class="n">lambd</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">cost</span><span class="o">=</span><span class="mi">100</span>
    <span class="n">i</span><span class="o">=</span><span class="mi">0</span>
    <span class="n">xout</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">yout</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
    <span class="n">p1</span><span class="o">=</span><span class="n">x</span><span class="o">*</span><span class="mi">0</span>
    <span class="n">p2</span><span class="o">=</span><span class="n">y</span><span class="o">*</span><span class="mi">0</span>
    <span class="n">q1</span><span class="o">=</span><span class="n">x</span><span class="o">*</span><span class="mi">0</span>
    <span class="n">q2</span><span class="o">=</span><span class="n">y</span><span class="o">*</span><span class="mi">0</span>
    <span class="n">shap</span> <span class="o">=</span> <span class="n">S</span><span class="o">.</span><span class="n">shape</span>
    <span class="k">while</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">nb_iter</span> <span class="ow">and</span> <span class="n">cost</span><span class="o">&gt;</span><span class="n">tol</span><span class="p">:</span>
        <span class="n">i</span><span class="o">+=</span><span class="mi">1</span>
        <span class="n">xtemp</span><span class="p">,</span><span class="n">ytemp</span><span class="p">,</span><span class="n">corr_coeff</span> <span class="o">=</span> <span class="n">proj_dict_equal</span><span class="p">(</span><span class="n">xout</span><span class="o">+</span><span class="n">p1</span><span class="p">,</span><span class="n">yout</span><span class="o">+</span><span class="n">p2</span><span class="p">,</span><span class="n">S</span><span class="p">,</span><span class="n">corr_coeff</span><span class="o">=</span><span class="n">corr_coeff</span><span class="p">)</span>
        <span class="n">p1</span> <span class="o">=</span> <span class="n">xout</span><span class="o">+</span><span class="n">p1</span><span class="o">-</span><span class="n">xtemp</span>
        <span class="n">p2</span> <span class="o">=</span> <span class="n">yout</span><span class="o">+</span><span class="n">p2</span><span class="o">-</span><span class="n">ytemp</span>
        <span class="n">xout</span> <span class="o">=</span> <span class="n">xtemp</span><span class="o">+</span><span class="n">q1</span>
        <span class="n">yout</span> <span class="o">=</span> <span class="n">pos_proj_mat</span><span class="p">(</span><span class="n">ytemp</span><span class="o">+</span><span class="n">q2</span><span class="p">)</span>
        <span class="n">q1</span> <span class="o">=</span> <span class="n">xtemp</span><span class="o">+</span><span class="n">q1</span><span class="o">-</span><span class="n">xout</span>
        <span class="n">q2</span> <span class="o">=</span> <span class="n">ytemp</span><span class="o">+</span><span class="n">q2</span><span class="o">-</span><span class="n">yout</span>
        <span class="n">yapprox</span> <span class="o">=</span> <span class="n">yout</span><span class="o">*</span><span class="mi">0</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
            <span class="n">yapprox</span> <span class="o">+=</span> <span class="n">yapprox</span><span class="o">+</span><span class="n">S</span><span class="p">[:,:,</span><span class="n">k</span><span class="p">]</span><span class="o">*</span><span class="n">xout</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
        <span class="n">cost</span> <span class="o">=</span> <span class="mi">100</span><span class="o">*</span><span class="p">((</span><span class="n">yapprox</span><span class="o">-</span><span class="n">yout</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">/</span><span class="p">(</span><span class="n">yout</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    <span class="nb">print</span> <span class="s2">&quot;Dyks cv: cost = &quot;</span><span class="p">,</span><span class="n">cost</span><span class="p">,</span><span class="s2">&quot; tol = &quot;</span><span class="p">,</span><span class="n">tol</span><span class="p">,</span><span class="s2">&quot; min val: &quot;</span><span class="p">,</span><span class="n">yapprox</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
    <span class="sd">&quot;&quot;&quot;for k in range(0,shap[2]):</span>
<span class="sd">        xout[k] = (S[:,:,k]*yout).sum()/corr_coeff&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">xout</span><span class="p">,</span><span class="n">yout</span><span class="p">,</span><span class="n">corr_coeff</span>

<span class="k">def</span> <span class="nf">proj_dict_equal_pos_dyks_stack</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">S</span><span class="p">,</span><span class="n">corr_coeff</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">nb_iter</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span><span class="n">tol</span><span class="o">=</span><span class="mi">10</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mi">5</span><span class="p">)):</span> <span class="c1"># y is a stack of images and x is matrix, each column corresponding to an image in y</span>
    <span class="n">xout</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">yout</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
    <span class="n">shap</span> <span class="o">=</span> <span class="n">y</span><span class="o">.</span><span class="n">shape</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
        <span class="n">xouti</span><span class="p">,</span><span class="n">youti</span><span class="p">,</span><span class="n">corr_coeff</span> <span class="o">=</span> <span class="n">proj_dict_equal_pos_dyks</span><span class="p">(</span><span class="n">x</span><span class="p">[:,</span><span class="n">i</span><span class="p">],</span><span class="n">y</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">],</span><span class="n">S</span><span class="p">,</span><span class="n">corr_coeff</span><span class="o">=</span><span class="n">corr_coeff</span><span class="p">,</span><span class="n">nb_iter</span><span class="o">=</span><span class="n">nb_iter</span><span class="p">,</span><span class="n">tol</span><span class="o">=</span><span class="n">tol</span><span class="p">)</span>
        <span class="n">xout</span><span class="p">[:,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">xouti</span>
        <span class="n">yout</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">youti</span>
    <span class="k">return</span> <span class="n">xout</span><span class="p">,</span><span class="n">yout</span><span class="p">,</span><span class="n">corr_coeff</span>

<span class="k">def</span> <span class="nf">laguerre_exp_proj_r</span><span class="p">(</span><span class="nb">input</span><span class="p">):</span>
    <span class="n">x</span> <span class="o">=</span> <span class="nb">input</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">output</span> <span class="o">=</span> <span class="n">x</span><span class="o">*</span><span class="mi">0</span>
    <span class="nb">dict</span> <span class="o">=</span> <span class="n">real</span><span class="p">(</span><span class="nb">input</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">shap</span> <span class="o">=</span> <span class="nb">dict</span><span class="o">.</span><span class="n">shape</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">3</span><span class="p">]):</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
            <span class="n">ai</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span><span class="o">*</span><span class="nb">dict</span><span class="p">[:,:,</span><span class="n">j</span><span class="p">,</span><span class="n">i</span><span class="p">])</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
            <span class="n">output</span> <span class="o">=</span> <span class="n">output</span><span class="o">+</span><span class="n">ai</span><span class="o">*</span><span class="nb">dict</span><span class="p">[:,:,</span><span class="n">j</span><span class="p">,</span><span class="n">i</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">output</span>

<span class="k">def</span> <span class="nf">laguerre_exp_proj_r_i</span><span class="p">(</span><span class="nb">input</span><span class="p">):</span> <span class="c1"># Analysis in the imaginary dict, projection on the real dict</span>
    <span class="n">x</span> <span class="o">=</span> <span class="nb">input</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">output</span> <span class="o">=</span> <span class="n">x</span><span class="o">*</span><span class="mi">0</span>
    <span class="n">dict_r</span> <span class="o">=</span> <span class="n">real</span><span class="p">(</span><span class="nb">input</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">dict_i</span> <span class="o">=</span> <span class="n">imag</span><span class="p">(</span><span class="nb">input</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">shap</span> <span class="o">=</span> <span class="n">dict_r</span><span class="o">.</span><span class="n">shape</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">3</span><span class="p">]):</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
            <span class="n">ai</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span><span class="o">*</span><span class="n">dict_i</span><span class="p">[:,:,</span><span class="n">j</span><span class="p">,</span><span class="n">i</span><span class="p">])</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
            <span class="n">output</span> <span class="o">=</span> <span class="n">output</span><span class="o">+</span><span class="n">ai</span><span class="o">*</span><span class="n">dict_r</span><span class="p">[:,:,</span><span class="n">j</span><span class="p">,</span><span class="n">i</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">output</span>

<span class="k">def</span> <span class="nf">laguerre_exp_proj_i</span><span class="p">(</span><span class="nb">input</span><span class="p">):</span>
    <span class="n">x</span> <span class="o">=</span> <span class="nb">input</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">output</span> <span class="o">=</span> <span class="n">x</span><span class="o">*</span><span class="mi">0</span>
    <span class="nb">dict</span> <span class="o">=</span> <span class="n">imag</span><span class="p">(</span><span class="nb">input</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">shap</span> <span class="o">=</span> <span class="nb">dict</span><span class="o">.</span><span class="n">shape</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">3</span><span class="p">]):</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
            <span class="n">ai</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span><span class="o">*</span><span class="nb">dict</span><span class="p">[:,:,</span><span class="n">j</span><span class="p">,</span><span class="n">i</span><span class="p">])</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
            <span class="n">output</span> <span class="o">=</span> <span class="n">output</span><span class="o">+</span><span class="n">ai</span><span class="o">*</span><span class="nb">dict</span><span class="p">[:,:,</span><span class="n">j</span><span class="p">,</span><span class="n">i</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">output</span>

<span class="k">def</span> <span class="nf">laguerre_exp_proj_i_r</span><span class="p">(</span><span class="nb">input</span><span class="p">):</span> <span class="c1"># Analysis in the real dict, projection on the imaginary dict</span>
    <span class="n">x</span> <span class="o">=</span> <span class="nb">input</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">output</span> <span class="o">=</span> <span class="n">x</span><span class="o">*</span><span class="mi">0</span>
    <span class="n">dict_r</span> <span class="o">=</span> <span class="n">real</span><span class="p">(</span><span class="nb">input</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">dict_i</span> <span class="o">=</span> <span class="n">imag</span><span class="p">(</span><span class="nb">input</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">shap</span> <span class="o">=</span> <span class="n">dict_r</span><span class="o">.</span><span class="n">shape</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">3</span><span class="p">]):</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
            <span class="n">ai</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span><span class="o">*</span><span class="n">dict_r</span><span class="p">[:,:,</span><span class="n">j</span><span class="p">,</span><span class="n">i</span><span class="p">])</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
            <span class="n">output</span> <span class="o">=</span> <span class="n">output</span><span class="o">+</span><span class="n">ai</span><span class="o">*</span><span class="n">dict_i</span><span class="p">[:,:,</span><span class="n">j</span><span class="p">,</span><span class="n">i</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">output</span>

<span class="k">def</span> <span class="nf">laguerre_exp_proj_r_r_i</span><span class="p">(</span><span class="nb">input</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">laguerre_exp_proj_r</span><span class="p">(</span><span class="nb">input</span><span class="p">)</span><span class="o">+</span><span class="n">laguerre_exp_proj_r_i</span><span class="p">(</span><span class="nb">input</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">laguerre_exp_proj_i_i_r</span><span class="p">(</span><span class="nb">input</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">laguerre_exp_proj_i</span><span class="p">(</span><span class="nb">input</span><span class="p">)</span><span class="o">+</span><span class="n">laguerre_exp_proj_i_r</span><span class="p">(</span><span class="nb">input</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">laguerre_exp_proj_r_r_i_i</span><span class="p">(</span><span class="nb">input</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">laguerre_exp_proj_r</span><span class="p">(</span><span class="nb">input</span><span class="p">)</span><span class="o">+</span><span class="n">laguerre_exp_proj_i</span><span class="p">(</span><span class="nb">input</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">laguerre_exp_r</span><span class="p">(</span><span class="nb">dict</span><span class="p">,</span><span class="n">alpha</span><span class="p">):</span>
    <span class="n">dict_r</span> <span class="o">=</span> <span class="n">real</span><span class="p">(</span><span class="nb">dict</span><span class="p">)</span>
    <span class="n">shap</span> <span class="o">=</span> <span class="n">dict_r</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">output</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">3</span><span class="p">]):</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
            <span class="n">output</span> <span class="o">=</span> <span class="n">output</span><span class="o">+</span><span class="n">alpha</span><span class="p">[</span><span class="n">j</span><span class="p">,</span><span class="n">i</span><span class="p">]</span><span class="o">*</span><span class="n">dict_r</span><span class="p">[:,:,</span><span class="n">j</span><span class="p">,</span><span class="n">i</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">output</span>

<span class="k">def</span> <span class="nf">laguerre_analys_r</span><span class="p">(</span><span class="nb">dict</span><span class="p">,</span><span class="n">x</span><span class="p">):</span>
    <span class="n">dict_r</span> <span class="o">=</span> <span class="n">real</span><span class="p">(</span><span class="nb">dict</span><span class="p">)</span>
    <span class="n">shap</span> <span class="o">=</span> <span class="n">dict_r</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">alpha</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">shap</span><span class="p">[</span><span class="mi">3</span><span class="p">]))</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">3</span><span class="p">]):</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
            <span class="n">alpha</span><span class="p">[</span><span class="n">j</span><span class="p">,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span><span class="o">*</span><span class="n">dict_r</span><span class="p">[:,:,</span><span class="n">j</span><span class="p">,</span><span class="n">i</span><span class="p">])</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">alpha</span>

<span class="k">def</span> <span class="nf">laguerre_exp_i</span><span class="p">(</span><span class="nb">dict</span><span class="p">,</span><span class="n">beta</span><span class="p">):</span>
    <span class="n">dict_i</span> <span class="o">=</span> <span class="n">imag</span><span class="p">(</span><span class="nb">dict</span><span class="p">)</span>
    <span class="n">shap</span> <span class="o">=</span> <span class="n">dict_i</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">output</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">3</span><span class="p">]):</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
            <span class="n">output</span> <span class="o">=</span> <span class="n">output</span><span class="o">+</span><span class="n">beta</span><span class="p">[</span><span class="n">j</span><span class="p">,</span><span class="n">i</span><span class="p">]</span><span class="o">*</span><span class="n">dict_i</span><span class="p">[:,:,</span><span class="n">j</span><span class="p">,</span><span class="n">i</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">output</span>

<span class="k">def</span> <span class="nf">laguerre_analys_i</span><span class="p">(</span><span class="nb">dict</span><span class="p">,</span><span class="n">x</span><span class="p">):</span>
    <span class="n">dict_i</span> <span class="o">=</span> <span class="n">imag</span><span class="p">(</span><span class="nb">dict</span><span class="p">)</span>
    <span class="n">shap</span> <span class="o">=</span> <span class="n">dict_i</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">beta</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">shap</span><span class="p">[</span><span class="mi">3</span><span class="p">]))</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">3</span><span class="p">]):</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
            <span class="n">beta</span><span class="p">[</span><span class="n">j</span><span class="p">,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span><span class="o">*</span><span class="n">dict_i</span><span class="p">[:,:,</span><span class="n">j</span><span class="p">,</span><span class="n">i</span><span class="p">])</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">beta</span>


<span class="k">def</span> <span class="nf">laguerre_exp_mat_r</span><span class="p">(</span><span class="nb">dict</span><span class="p">):</span>
    <span class="n">dict_r</span> <span class="o">=</span> <span class="n">real</span><span class="p">(</span><span class="nb">dict</span><span class="p">)</span>
    <span class="n">shap</span> <span class="o">=</span> <span class="nb">dict</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">mat</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="n">shap</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="n">shap</span><span class="p">[</span><span class="mi">3</span><span class="p">]))</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="n">shap</span><span class="p">[</span><span class="mi">3</span><span class="p">]):</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="n">shap</span><span class="p">[</span><span class="mi">3</span><span class="p">]):</span>
            <span class="n">i1</span> <span class="o">=</span> <span class="n">i</span><span class="o">%</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
            <span class="n">j1</span> <span class="o">=</span> <span class="n">floor</span><span class="p">(</span><span class="n">i</span><span class="o">/</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
            <span class="n">i2</span> <span class="o">=</span> <span class="n">j</span><span class="o">%</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
            <span class="n">j2</span> <span class="o">=</span> <span class="n">floor</span><span class="p">(</span><span class="n">j</span><span class="o">/</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
            <span class="n">mat</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">dict_r</span><span class="p">[:,:,</span><span class="n">i1</span><span class="p">,</span><span class="n">j1</span><span class="p">]</span><span class="o">*</span><span class="n">dict_r</span><span class="p">[:,:,</span><span class="n">i2</span><span class="p">,</span><span class="n">j2</span><span class="p">])</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    <span class="n">mat</span> <span class="o">=</span> <span class="n">mat</span><span class="o">+</span><span class="n">transpose</span><span class="p">(</span><span class="n">mat</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="n">shap</span><span class="p">[</span><span class="mi">3</span><span class="p">]):</span>
        <span class="n">i1</span> <span class="o">=</span> <span class="n">i</span><span class="o">%</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
        <span class="n">j1</span> <span class="o">=</span> <span class="n">floor</span><span class="p">(</span><span class="n">i</span><span class="o">/</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
        <span class="n">i2</span> <span class="o">=</span> <span class="n">j</span><span class="o">%</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
        <span class="n">j2</span> <span class="o">=</span> <span class="n">floor</span><span class="p">(</span><span class="n">j</span><span class="o">/</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
        <span class="n">mat</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">dict_r</span><span class="p">[:,:,</span><span class="n">i1</span><span class="p">,</span><span class="n">j1</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">mat</span>

<span class="k">def</span> <span class="nf">laguerre_exp_mat_i</span><span class="p">(</span><span class="nb">dict</span><span class="p">):</span>
    <span class="n">dict_i</span> <span class="o">=</span> <span class="n">imag</span><span class="p">(</span><span class="nb">dict</span><span class="p">)</span>
    <span class="n">shap</span> <span class="o">=</span> <span class="nb">dict</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">mat</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="n">shap</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="n">shap</span><span class="p">[</span><span class="mi">3</span><span class="p">]))</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="n">shap</span><span class="p">[</span><span class="mi">3</span><span class="p">]):</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="n">shap</span><span class="p">[</span><span class="mi">3</span><span class="p">]):</span>
            <span class="n">i1</span> <span class="o">=</span> <span class="n">i</span><span class="o">%</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
            <span class="n">j1</span> <span class="o">=</span> <span class="n">floor</span><span class="p">(</span><span class="n">i</span><span class="o">/</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
            <span class="n">i2</span> <span class="o">=</span> <span class="n">j</span><span class="o">%</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
            <span class="n">j2</span> <span class="o">=</span> <span class="n">floor</span><span class="p">(</span><span class="n">j</span><span class="o">/</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
            <span class="n">mat</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">dict_i</span><span class="p">[:,:,</span><span class="n">i1</span><span class="p">,</span><span class="n">j1</span><span class="p">]</span><span class="o">*</span><span class="n">dict_i</span><span class="p">[:,:,</span><span class="n">i2</span><span class="p">,</span><span class="n">j2</span><span class="p">])</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    <span class="n">mat</span> <span class="o">=</span> <span class="n">mat</span><span class="o">+</span><span class="n">transpose</span><span class="p">(</span><span class="n">mat</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="n">shap</span><span class="p">[</span><span class="mi">3</span><span class="p">]):</span>
        <span class="n">i1</span> <span class="o">=</span> <span class="n">i</span><span class="o">%</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
        <span class="n">j1</span> <span class="o">=</span> <span class="n">floor</span><span class="p">(</span><span class="n">i</span><span class="o">/</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
        <span class="n">i2</span> <span class="o">=</span> <span class="n">j</span><span class="o">%</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
        <span class="n">j2</span> <span class="o">=</span> <span class="n">floor</span><span class="p">(</span><span class="n">j</span><span class="o">/</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
        <span class="n">mat</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">dict_i</span><span class="p">[:,:,</span><span class="n">i1</span><span class="p">,</span><span class="n">j1</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">mat</span>

<span class="k">def</span> <span class="nf">laguerre_exp_mat_i_r</span><span class="p">(</span><span class="nb">dict</span><span class="p">):</span>
    <span class="n">dict_i</span> <span class="o">=</span> <span class="n">imag</span><span class="p">(</span><span class="nb">dict</span><span class="p">)</span>
    <span class="n">dict_r</span> <span class="o">=</span> <span class="n">real</span><span class="p">(</span><span class="nb">dict</span><span class="p">)</span>
    <span class="n">shap</span> <span class="o">=</span> <span class="nb">dict</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">mat</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="n">shap</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="n">shap</span><span class="p">[</span><span class="mi">3</span><span class="p">]))</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="n">shap</span><span class="p">[</span><span class="mi">3</span><span class="p">]):</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="n">shap</span><span class="p">[</span><span class="mi">3</span><span class="p">]):</span>
            <span class="n">i1</span> <span class="o">=</span> <span class="n">i</span><span class="o">%</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
            <span class="n">j1</span> <span class="o">=</span> <span class="n">floor</span><span class="p">(</span><span class="n">i</span><span class="o">/</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
            <span class="n">i2</span> <span class="o">=</span> <span class="n">j</span><span class="o">%</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
            <span class="n">j2</span> <span class="o">=</span> <span class="n">floor</span><span class="p">(</span><span class="n">j</span><span class="o">/</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
            <span class="n">mat</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">dict_i</span><span class="p">[:,:,</span><span class="n">i1</span><span class="p">,</span><span class="n">j1</span><span class="p">]</span><span class="o">*</span><span class="n">dict_r</span><span class="p">[:,:,</span><span class="n">i2</span><span class="p">,</span><span class="n">j2</span><span class="p">])</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">mat</span>

<span class="k">def</span> <span class="nf">sparse_laguerre_exp</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="nb">dict</span><span class="p">,</span><span class="n">spec_rad_r</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">spec_rad_i</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">dec_coeff</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">nb_iter</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span><span class="n">mu</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
    <span class="n">siz</span> <span class="o">=</span> <span class="nb">dict</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">input_dict</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
    <span class="n">input_dict</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">copy</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
    <span class="n">input_dict</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">copy</span><span class="p">(</span><span class="nb">dict</span><span class="p">))</span>
    <span class="n">eig_dict_r</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">eig_dict_i</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">spec_rad_r</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">eig_dict_r</span><span class="p">,</span><span class="n">spec_rad_r</span><span class="o">=</span> <span class="n">pow_meth</span><span class="p">(</span><span class="n">laguerre_exp_proj_r</span><span class="p">,</span><span class="n">input_dict</span><span class="p">,[</span><span class="n">siz</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">siz</span><span class="p">[</span><span class="mi">1</span><span class="p">]],</span><span class="n">ainit</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">spec_rad_i</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">eig_dict_i</span><span class="p">,</span><span class="n">spec_rad_i</span><span class="o">=</span> <span class="n">pow_meth</span><span class="p">(</span><span class="n">laguerre_exp_proj_i</span><span class="p">,</span><span class="n">input_dict</span><span class="p">,[</span><span class="n">siz</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">siz</span><span class="p">[</span><span class="mi">1</span><span class="p">]],</span><span class="n">ainit</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>

    <span class="n">thresh_r_max</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">thresh_i_max</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">kappa</span> <span class="o">=</span> <span class="mf">0.8</span>

    <span class="n">alpha_r</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">siz</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">siz</span><span class="p">[</span><span class="mi">3</span><span class="p">]))</span>
    <span class="n">alpha_i</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">siz</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">siz</span><span class="p">[</span><span class="mi">3</span><span class="p">]))</span>

    <span class="n">grad_r</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">siz</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">siz</span><span class="p">[</span><span class="mi">3</span><span class="p">]))</span>
    <span class="n">grad_i</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">siz</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">siz</span><span class="p">[</span><span class="mi">3</span><span class="p">]))</span>
    <span class="n">dict_i</span> <span class="o">=</span> <span class="n">imag</span><span class="p">(</span><span class="nb">dict</span><span class="p">)</span>
    <span class="n">dict_r</span> <span class="o">=</span> <span class="n">real</span><span class="p">(</span><span class="nb">dict</span><span class="p">)</span>

    <span class="n">res_r</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">res_i</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">thresh_type</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">t1</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">t2</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_iter</span><span class="p">):</span>
        <span class="n">t1</span> <span class="o">=</span> <span class="n">x</span> <span class="o">-</span> <span class="n">laguerre_exp_r</span><span class="p">(</span><span class="nb">dict</span><span class="p">,</span><span class="n">alpha_r</span><span class="p">)</span> <span class="o">+</span> <span class="n">laguerre_exp_i</span><span class="p">(</span><span class="nb">dict</span><span class="p">,</span><span class="n">alpha_i</span><span class="p">)</span>
        <span class="n">t2</span> <span class="o">=</span> <span class="n">laguerre_exp_i</span><span class="p">(</span><span class="nb">dict</span><span class="p">,</span><span class="n">alpha_r</span><span class="p">)</span> <span class="o">+</span> <span class="n">laguerre_exp_r</span><span class="p">(</span><span class="nb">dict</span><span class="p">,</span><span class="n">alpha_i</span><span class="p">)</span>
        <span class="n">res_r</span> <span class="o">=</span> <span class="p">(</span><span class="n">t1</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">/</span><span class="p">(</span><span class="n">x</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="n">res_i</span> <span class="o">=</span> <span class="p">(</span><span class="n">t2</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">/</span><span class="p">(</span><span class="n">x</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="nb">print</span> <span class="s2">&quot;Real part residual: &quot;</span><span class="p">,</span><span class="n">res_r</span>
        <span class="n">grad_r</span> <span class="o">=</span> <span class="o">-</span><span class="n">laguerre_analys_r</span><span class="p">(</span><span class="nb">dict</span><span class="p">,</span><span class="n">t1</span><span class="p">)</span><span class="o">+</span><span class="mi">0</span><span class="o">*</span><span class="n">laguerre_analys_i</span><span class="p">(</span><span class="nb">dict</span><span class="p">,</span><span class="n">t2</span><span class="p">)</span>
        <span class="n">grad_i</span> <span class="o">=</span> <span class="n">laguerre_analys_i</span><span class="p">(</span><span class="nb">dict</span><span class="p">,</span><span class="n">t1</span><span class="p">)</span><span class="o">+</span><span class="mi">0</span><span class="o">*</span><span class="n">laguerre_analys_r</span><span class="p">(</span><span class="nb">dict</span><span class="p">,</span><span class="n">t2</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">i</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
            <span class="n">thresh_r_max</span> <span class="o">=</span> <span class="n">kappa</span><span class="o">*</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">grad_r</span><span class="p">)</span><span class="o">.</span><span class="n">max</span><span class="p">())</span>
            <span class="n">thresh_i_max</span> <span class="o">=</span> <span class="n">kappa</span><span class="o">*</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">grad_i</span><span class="p">)</span><span class="o">.</span><span class="n">max</span><span class="p">())</span>
        <span class="n">alpha_r</span> <span class="o">=</span> <span class="n">alpha_r</span> <span class="o">-</span> <span class="n">mu</span><span class="o">*</span><span class="n">grad_r</span><span class="o">/</span><span class="n">spec_rad_r</span>
        <span class="n">alpha_i</span> <span class="o">=</span> <span class="n">alpha_i</span> <span class="o">-</span> <span class="n">mu</span><span class="o">*</span><span class="n">grad_i</span><span class="o">/</span><span class="n">spec_rad_i</span>

        <span class="n">thresh_r_i</span> <span class="o">=</span> <span class="n">ones</span><span class="p">((</span><span class="n">siz</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">siz</span><span class="p">[</span><span class="mi">3</span><span class="p">]))</span><span class="o">*</span><span class="n">thresh_r_max</span><span class="o">*</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">dec_coeff</span><span class="o">*</span><span class="n">i</span><span class="p">)</span><span class="o">/</span><span class="n">spec_rad_r</span>
        <span class="n">thresh_i_i</span> <span class="o">=</span> <span class="n">ones</span><span class="p">((</span><span class="n">siz</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">siz</span><span class="p">[</span><span class="mi">3</span><span class="p">]))</span><span class="o">*</span><span class="n">thresh_i_max</span><span class="o">*</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">dec_coeff</span><span class="o">*</span><span class="n">i</span><span class="p">)</span><span class="o">/</span><span class="n">spec_rad_i</span>

        <span class="n">alpha_r</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">thresholding</span><span class="p">(</span><span class="n">alpha_r</span><span class="p">,</span><span class="n">thresh_r_i</span><span class="p">,</span><span class="n">thresh_type</span><span class="p">)</span>
        <span class="n">alpha_i</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">thresholding</span><span class="p">(</span><span class="n">alpha_i</span><span class="p">,</span><span class="n">thresh_i_i</span><span class="p">,</span><span class="n">thresh_type</span><span class="p">)</span>

    <span class="n">r</span> <span class="o">=</span> <span class="n">sqrt</span><span class="p">(</span><span class="n">alpha_r</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="n">alpha_i</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">theta</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">siz</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">siz</span><span class="p">[</span><span class="mi">3</span><span class="p">]))</span>
    <span class="n">i</span><span class="p">,</span><span class="n">j</span> <span class="o">=</span> <span class="n">where</span><span class="p">(</span><span class="n">alpha_r</span><span class="o">!=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">theta</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arctan</span><span class="p">(</span><span class="n">alpha_i</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span><span class="o">/</span><span class="n">alpha_r</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">])</span>
    <span class="n">i</span><span class="p">,</span><span class="n">j</span> <span class="o">=</span> <span class="n">where</span><span class="p">(</span><span class="n">alpha_r</span><span class="o">!=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">theta</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">sign</span><span class="p">(</span><span class="n">alpha_i</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">])</span><span class="o">*</span><span class="n">pi</span><span class="o">/</span><span class="mi">2</span>

    <span class="k">return</span> <span class="n">alpha_r</span><span class="p">,</span><span class="n">alpha_i</span><span class="p">,</span><span class="n">t1</span><span class="p">,</span><span class="n">t2</span><span class="p">,</span><span class="n">r</span><span class="p">,</span><span class="n">theta</span><span class="p">,</span><span class="n">spec_rad_r</span><span class="p">,</span><span class="n">spec_rad_i</span>


<span class="k">def</span> <span class="nf">optim_poly_fit_2d</span><span class="p">(</span><span class="n">ref_val</span><span class="p">,</span><span class="n">target_val</span><span class="p">,</span><span class="n">deg_min</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">deg_max</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span><span class="n">kmad_min</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">kmad_max</span> <span class="o">=</span> <span class="mi">400</span><span class="p">,</span><span class="n">step_deg</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span><span class="n">step_kmad</span><span class="o">=</span><span class="mi">20</span><span class="p">):</span>
    <span class="kn">from</span> <span class="nn">numpy</span> <span class="k">import</span> <span class="n">linspace</span><span class="p">,</span><span class="n">copy</span>
    <span class="n">deg</span> <span class="o">=</span> <span class="n">linspace</span><span class="p">(</span><span class="n">deg_min</span><span class="p">,</span><span class="n">deg_max</span><span class="p">,</span><span class="n">step_deg</span><span class="p">)</span>
    <span class="n">kmad</span> <span class="o">=</span> <span class="n">linspace</span><span class="p">(</span><span class="n">kmad_min</span><span class="p">,</span><span class="n">kmad_max</span><span class="p">,</span><span class="n">step_kmad</span><span class="p">)</span>

    <span class="n">S</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">w</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">mean_err</span> <span class="o">=</span> <span class="mi">100</span>
    <span class="n">deg_min</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">kmad_min</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">for</span> <span class="n">deg_i</span> <span class="ow">in</span> <span class="n">deg</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">kmad_i</span> <span class="ow">in</span> <span class="n">kmad</span><span class="p">:</span>
            <span class="n">S_i</span><span class="p">,</span><span class="n">mean_err_i</span><span class="p">,</span><span class="n">w_i</span> <span class="o">=</span> <span class="n">poly_fit_2d</span><span class="p">(</span><span class="n">ref_val</span><span class="p">,</span><span class="n">target_val</span><span class="p">,</span><span class="n">deg</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">deg_i</span><span class="p">),</span><span class="n">kmad</span><span class="o">=</span><span class="n">kmad_i</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">mean_err_i</span><span class="o">&lt;</span><span class="n">mean_err</span><span class="p">:</span>
                <span class="n">mean_err</span> <span class="o">=</span> <span class="n">mean_err_i</span>
                <span class="n">S</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">S_i</span><span class="p">)</span>
                <span class="n">w</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">w_i</span><span class="p">)</span>
                <span class="n">deg_min</span> <span class="o">=</span> <span class="n">deg_i</span>
                <span class="n">kmad_min</span> <span class="o">=</span> <span class="n">kmad_i</span>
    <span class="nb">print</span> <span class="s2">&quot;optimal degree :&quot;</span><span class="p">,</span> <span class="n">deg_min</span><span class="p">,</span> <span class="s2">&quot; optimal kmad: &quot;</span><span class="p">,</span><span class="n">kmad_min</span><span class="p">,</span><span class="s2">&quot; modes dimension: &quot;</span><span class="p">,</span><span class="n">S</span><span class="o">.</span><span class="n">shape</span>
    <span class="k">return</span> <span class="n">S</span><span class="p">,</span><span class="n">mean_err</span><span class="p">,</span><span class="n">w</span><span class="p">,</span><span class="nb">int</span><span class="p">(</span><span class="n">deg_min</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">poly_fit_2d</span><span class="p">(</span><span class="n">ref_val</span><span class="p">,</span><span class="n">target_val</span><span class="p">,</span><span class="n">deg</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span><span class="n">kmad</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span> <span class="c1"># The lines represent the samples; this function finds the best fitting S in Y = SA, Y being a matrix of target vamues and A being calculed from the ref values</span>
    <span class="kn">from</span> <span class="nn">utils</span> <span class="k">import</span> <span class="n">poly_val</span><span class="p">,</span><span class="n">mad</span>
    <span class="kn">from</span> <span class="nn">numpy</span> <span class="k">import</span> <span class="n">transpose</span><span class="p">,</span><span class="n">ones</span><span class="p">,</span><span class="n">exp</span><span class="p">,</span><span class="n">diag</span>
    <span class="kn">from</span> <span class="nn">numpy.linalg</span> <span class="k">import</span> <span class="n">pinv</span><span class="p">,</span><span class="n">norm</span>

    <span class="n">nb_monomials</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">shap</span> <span class="o">=</span> <span class="n">ref_val</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">nb_pts</span> <span class="o">=</span> <span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">dim_feat</span> <span class="o">=</span> <span class="n">target_val</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">med_feat</span> <span class="o">=</span> <span class="n">median</span><span class="p">(</span><span class="n">target_val</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">target_val_0</span> <span class="o">=</span> <span class="n">target_val</span> <span class="o">-</span> <span class="n">ones</span><span class="p">((</span><span class="n">nb_pts</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">med_feat</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span><span class="n">dim_feat</span><span class="p">)))</span>
    <span class="n">A</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_pts</span><span class="p">):</span>
        <span class="n">coeff</span><span class="p">,</span><span class="n">nb_monomials</span> <span class="o">=</span> <span class="n">poly_val</span><span class="p">(</span><span class="n">ref_val</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span><span class="n">ref_val</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span><span class="n">deg</span><span class="p">)</span>
        <span class="n">A</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">coeff</span><span class="p">)</span>

    <span class="n">A</span> <span class="o">=</span> <span class="n">transpose</span><span class="p">(</span><span class="n">array</span><span class="p">(</span><span class="n">A</span><span class="p">))</span>

    <span class="c1"># Weights setting</span>

    <span class="n">mads</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">dim_feat</span><span class="p">,))</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">dim_feat</span><span class="p">):</span>
        <span class="n">mads</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">mad</span><span class="p">(</span><span class="n">target_val</span><span class="p">[:,</span><span class="mi">1</span><span class="p">])</span>

    <span class="n">w</span> <span class="o">=</span> <span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="nb">sum</span><span class="p">((</span><span class="n">target_val_0</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">diag</span><span class="p">((</span><span class="n">kmad</span><span class="o">*</span><span class="n">mads</span><span class="p">)</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">))))</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">nb_pts</span><span class="o">&lt;</span><span class="n">nb_monomials</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Warning: the fitting might be inaccurate because of the number of samples.&quot;</span><span class="p">)</span>


    <span class="n">S</span> <span class="o">=</span> <span class="n">transpose</span><span class="p">(</span><span class="n">diag</span><span class="p">(</span><span class="n">w</span><span class="p">)</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">target_val_0</span><span class="p">))</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">transpose</span><span class="p">(</span><span class="n">pinv</span><span class="p">(</span><span class="n">transpose</span><span class="p">(</span><span class="n">A</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">diag</span><span class="p">(</span><span class="n">w</span><span class="p">))))))</span>
    <span class="n">S</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="n">median</span><span class="p">(</span><span class="n">target_val</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>


    <span class="n">mean_err</span> <span class="o">=</span> <span class="mi">100</span><span class="o">*</span><span class="n">norm</span><span class="p">((</span><span class="n">transpose</span><span class="p">(</span><span class="n">target_val</span><span class="p">)</span> <span class="o">-</span> <span class="n">S</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">A</span><span class="p">))</span><span class="o">/</span><span class="n">norm</span><span class="p">(</span><span class="n">target_val</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span><span class="o">/</span><span class="n">nb_pts</span>

    <span class="k">return</span> <span class="n">S</span><span class="p">,</span><span class="n">mean_err</span><span class="p">,</span><span class="n">w</span>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper"><div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../index.html">Documentation overview</a><ul>
  <li><a href="index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2018, Fred Ngolè, Morgan A Schmitz, Rebeca Araripe, Jean-Luc Starck.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 1.7.5</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.7</a>
      
    </div>

    

    
  </body>
</html>