
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>utils &#8212; LambdaRCA 0.0 documentation</title>
    <link rel="stylesheet" href="../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
   
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for utils</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">subprocess</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">random</span>
<span class="kn">import</span> <span class="nn">cv2</span>
<span class="kn">from</span> <span class="nn">numpy</span> <span class="k">import</span> <span class="n">zeros</span><span class="p">,</span><span class="n">size</span><span class="p">,</span><span class="n">where</span><span class="p">,</span><span class="n">ones</span><span class="p">,</span><span class="n">copy</span><span class="p">,</span><span class="n">around</span><span class="p">,</span><span class="n">double</span><span class="p">,</span><span class="n">sinc</span><span class="p">,</span><span class="n">random</span><span class="p">,</span><span class="n">pi</span><span class="p">,</span><span class="n">arange</span><span class="p">,</span><span class="n">cos</span><span class="p">,</span><span class="n">sin</span><span class="p">,</span><span class="n">arccos</span><span class="p">,</span><span class="n">transpose</span><span class="p">,</span><span class="n">diag</span><span class="p">,</span><span class="n">sqrt</span><span class="p">,</span><span class="n">arange</span><span class="p">,</span><span class="n">floor</span><span class="p">,</span><span class="n">exp</span><span class="p">,</span><span class="n">array</span><span class="p">,</span><span class="n">mean</span><span class="p">,</span><span class="n">roots</span><span class="p">,</span><span class="n">float64</span><span class="p">,</span><span class="nb">int</span><span class="p">,</span><span class="n">pi</span><span class="p">,</span><span class="n">median</span><span class="p">,</span><span class="n">rot90</span><span class="p">,</span><span class="n">argsort</span><span class="p">,</span><span class="n">tile</span><span class="p">,</span><span class="n">repeat</span><span class="p">,</span><span class="n">squeeze</span>
<span class="kn">from</span> <span class="nn">numpy.linalg</span> <span class="k">import</span> <span class="n">svd</span><span class="p">,</span><span class="n">norm</span><span class="p">,</span><span class="n">inv</span><span class="p">,</span><span class="n">eigh</span>
<span class="kn">import</span> <span class="nn">numpy.ma</span> <span class="k">as</span> <span class="nn">npma</span>
<span class="kn">from</span> <span class="nn">numpy.random</span> <span class="k">import</span> <span class="n">randn</span><span class="p">,</span><span class="n">choice</span>
<span class="kn">import</span> <span class="nn">scipy.ndimage</span>
<span class="kn">import</span> <span class="nn">scipy</span>
<span class="kn">import</span> <span class="nn">scipy.signal</span> <span class="k">as</span> <span class="nn">scisig</span>
<span class="kn">import</span> <span class="nn">scipy.ndimage.interpolation</span> <span class="k">as</span> <span class="nn">ndii</span>
<span class="kn">import</span> <span class="nn">scipy.fftpack</span> <span class="k">as</span> <span class="nn">scipy_fft</span>
<span class="kn">from</span> <span class="nn">pyflann</span> <span class="k">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">multiprocessing</span> <span class="k">import</span> <span class="n">Process</span><span class="p">,</span> <span class="n">Queue</span>
<span class="kn">from</span> <span class="nn">astropy.io</span> <span class="k">import</span> <span class="n">fits</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;../utilities&#39;</span><span class="p">)</span>
<span class="kn">import</span> <span class="nn">gaussfitter</span>
<span class="c1">#import great3_util</span>
<span class="c1">#import optim_utils</span>
<span class="c1">#import isap</span>
<span class="kn">from</span> <span class="nn">scipy.spatial</span> <span class="k">import</span> <span class="n">ConvexHull</span>
<span class="kn">import</span> <span class="nn">scipy.fftpack</span> <span class="k">as</span> <span class="nn">fftp</span>
<span class="c1">#from astropy.modeling import models#, fitting</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="kn">from</span> <span class="nn">scipy.ndimage.interpolation</span> <span class="k">import</span> <span class="n">zoom</span>
<span class="kn">import</span> <span class="nn">scipy.stats</span> <span class="k">as</span> <span class="nn">scistats</span>
<span class="kn">import</span> <span class="nn">pywt</span>
<span class="kn">import</span> <span class="nn">copy</span> <span class="k">as</span> <span class="nn">cp</span>
<span class="kn">from</span> <span class="nn">matplotlib</span> <span class="k">import</span> <span class="n">pyplot</span> <span class="k">as</span> <span class="n">plt</span><span class="p">,</span><span class="n">animation</span>
<span class="kn">import</span> <span class="nn">datetime</span><span class="o">,</span><span class="nn">time</span>

<span class="kn">from</span> <span class="nn">scipy</span> <span class="k">import</span> <span class="n">interpolate</span>

<span class="kn">import</span> <span class="nn">scipy.linalg</span> <span class="k">as</span> <span class="nn">sci_lin</span>

<div class="viewcode-block" id="diagonally_dominated_mat"><a class="viewcode-back" href="../utils.html#utils.diagonally_dominated_mat">[docs]</a><span class="k">def</span> <span class="nf">diagonally_dominated_mat</span><span class="p">(</span><span class="n">shap</span><span class="p">,</span><span class="n">sig</span><span class="o">=</span><span class="mf">4.</span><span class="p">,</span><span class="n">thresh_en</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">coord_map</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">pol_en</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">pol_mod</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">theta_param</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">cent</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;**[???]**</span>
<span class="sd">    </span>
<span class="sd">    Calls:</span>
<span class="sd">    </span>
<span class="sd">    * :func:`optim_utils.dist_map_2`</span>
<span class="sd">    * :func:`utils.polar_coord_cloud`&quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">optim_utils</span> <span class="k">import</span> <span class="n">dist_map_2</span>
    <span class="kn">from</span> <span class="nn">numpy</span> <span class="k">import</span> <span class="n">sqrt</span> <span class="k">as</span> <span class="n">numsqrt</span>
    <span class="n">coord_cloud</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">coord_map</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">coord_map</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="mi">2</span><span class="p">))</span>
        <span class="n">coord_map</span><span class="p">[:,:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">ones</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">])))</span>
        <span class="n">coord_map</span><span class="p">[:,:,</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">ones</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">])))</span>
        <span class="n">coord_cloud</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
        <span class="n">coord_cloud</span><span class="p">[</span><span class="mi">0</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">coord_map</span><span class="p">[:,:,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">],))</span>
        <span class="n">coord_cloud</span><span class="p">[</span><span class="mi">1</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">coord_map</span><span class="p">[:,:,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">],))</span>
        <span class="k">if</span> <span class="n">pol_en</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">cent</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">cent</span> <span class="o">=</span> <span class="n">array</span><span class="p">([</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span><span class="p">])</span>
            <span class="n">coord_cloud</span> <span class="o">=</span> <span class="n">polar_coord_cloud</span><span class="p">(</span><span class="n">coord_cloud</span><span class="p">,</span><span class="n">cent</span><span class="p">)</span>
            <span class="n">coord_map</span><span class="p">[:,:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">cloud_out</span><span class="p">[</span><span class="mi">0</span><span class="p">,:]</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
            <span class="n">coord_map</span><span class="p">[:,:,</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">theta_param</span><span class="o">*</span><span class="n">cloud_out</span><span class="p">[</span><span class="mi">1</span><span class="p">,:]</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span><span class="o">/</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">pi</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">pol_mod</span><span class="p">:</span>
                <span class="n">coord_map</span><span class="p">[:,:,</span><span class="mi">1</span><span class="p">]</span> <span class="o">*=</span> <span class="n">coord_map</span><span class="p">[:,:,</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">coord_cloud</span><span class="p">[</span><span class="mi">1</span><span class="p">,:]</span> <span class="o">*=</span> <span class="n">coord_cloud</span><span class="p">[</span><span class="mi">0</span><span class="p">,:]</span>
    <span class="n">dist_map</span> <span class="o">=</span> <span class="n">sqrt</span><span class="p">(</span><span class="n">dist_map_2</span><span class="p">(</span><span class="n">coord_cloud</span><span class="p">))</span>
    <span class="n">mat</span> <span class="o">=</span> <span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">dist_map</span><span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="n">sig</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">thresh_en</span><span class="p">:</span>
        <span class="n">i</span><span class="p">,</span><span class="n">j</span> <span class="o">=</span> <span class="n">where</span><span class="p">(</span><span class="n">mat</span><span class="o">&gt;</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mf">1.</span><span class="p">))</span>
        <span class="n">mat</span><span class="o">*=</span><span class="mi">0</span>
        <span class="n">mat</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.</span>
    <span class="n">mat</span><span class="o">/=</span><span class="n">mat</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">mat</span></div>

<div class="viewcode-block" id="diagonally_dominated_mat_stack"><a class="viewcode-back" href="../utils.html#utils.diagonally_dominated_mat_stack">[docs]</a><span class="k">def</span> <span class="nf">diagonally_dominated_mat_stack</span><span class="p">(</span><span class="n">shap</span><span class="p">,</span><span class="n">nb_mat</span><span class="p">,</span><span class="n">sig</span><span class="o">=</span><span class="mf">4.</span><span class="p">,</span><span class="n">thresh_en</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">coord_map</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">pol_en</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>\
    <span class="n">pol_mod</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">theta_param</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">cent</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    
    <span class="sd">&quot;&quot;&quot;Applies whatever :func:`diagonally_dominated_mat` does to a stack.</span>
<span class="sd">    </span>
<span class="sd">    Calls:</span>
<span class="sd">    </span>
<span class="sd">    * :func:`diagonally_dominated_mat`</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">mat_ref</span> <span class="o">=</span> <span class="n">diagonally_dominated_mat</span><span class="p">(</span><span class="n">shap</span><span class="p">,</span><span class="n">sig</span><span class="o">=</span><span class="n">sig</span><span class="p">,</span><span class="n">thresh_en</span><span class="o">=</span><span class="n">thresh_en</span><span class="p">,</span><span class="n">coord_map</span><span class="o">=</span><span class="n">coord_map</span><span class="p">,</span>\
    <span class="n">pol_en</span><span class="o">=</span><span class="n">pol_en</span><span class="p">,</span><span class="n">pol_mod</span><span class="o">=</span><span class="n">pol_mod</span><span class="p">,</span><span class="n">theta_param</span><span class="o">=</span><span class="n">theta_param</span><span class="p">,</span><span class="n">cent</span><span class="o">=</span><span class="n">cent</span><span class="p">)</span>
    <span class="n">mat</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">nb_mat</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_mat</span><span class="p">):</span>
        <span class="n">mat</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">mat_ref</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">mat</span></div>


<span class="k">def</span> <span class="nf">radial_support</span><span class="p">(</span><span class="n">mat</span><span class="p">,</span><span class="n">shap</span><span class="p">,</span><span class="n">cent</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">tol_deg</span><span class="o">=</span><span class="mf">15.</span><span class="p">,</span><span class="n">coord_map</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="n">mat_out</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">mat</span><span class="p">)</span>
    <span class="n">coord_cloud</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">coord_map</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">coord_map</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="mi">2</span><span class="p">))</span>
        <span class="n">coord_map</span><span class="p">[:,:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">ones</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">])))</span>
        <span class="n">coord_map</span><span class="p">[:,:,</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">ones</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">])))</span>
        <span class="n">coord_cloud</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
        <span class="n">coord_cloud</span><span class="p">[</span><span class="mi">0</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">coord_map</span><span class="p">[:,:,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">],))</span>
        <span class="n">coord_cloud</span><span class="p">[</span><span class="mi">1</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">coord_map</span><span class="p">[:,:,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">],))</span>
        <span class="k">if</span> <span class="n">cent</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">cent</span> <span class="o">=</span> <span class="n">array</span><span class="p">([</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span><span class="p">])</span>
        <span class="n">coord_cloud</span> <span class="o">=</span> <span class="n">polar_coord_cloud</span><span class="p">(</span><span class="n">coord_cloud</span><span class="p">,</span><span class="n">cent</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
        <span class="n">j</span> <span class="o">=</span> <span class="n">where</span><span class="p">(</span><span class="n">mat</span><span class="p">[</span><span class="n">i</span><span class="p">,:]</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">j</span><span class="p">[</span><span class="mi">0</span><span class="p">])):</span>
            <span class="k">if</span> <span class="n">coord_cloud</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">j</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">k</span><span class="p">]]</span><span class="o">&lt;</span><span class="n">coord_cloud</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">i</span><span class="p">]</span> <span class="ow">or</span> <span class="nb">abs</span><span class="p">(</span><span class="n">coord_cloud</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">k</span><span class="p">]]</span><span class="o">-</span><span class="n">coord_cloud</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="n">i</span><span class="p">])</span><span class="o">&gt;</span><span class="n">pi</span><span class="o">*</span><span class="n">tol_deg</span><span class="o">/</span><span class="mi">180</span> <span class="p">:</span>
                <span class="n">mat_out</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">k</span><span class="p">]]</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">return</span> <span class="n">mat_out</span>



<span class="k">def</span> <span class="nf">gauss_ker</span><span class="p">(</span><span class="n">shap</span><span class="p">,</span><span class="n">sigx</span><span class="p">,</span><span class="n">sigy</span><span class="p">):</span>
    <span class="n">ker</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">shap</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
            <span class="n">ker</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="p">(</span><span class="n">i</span><span class="o">-</span><span class="n">double</span><span class="p">(</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">sigx</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="p">(</span><span class="n">j</span><span class="o">-</span><span class="n">double</span><span class="p">(</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">sigy</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span>
    <span class="n">ker</span> <span class="o">=</span> <span class="n">ker</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">ker</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span>
    <span class="k">return</span> <span class="n">ker</span>

<span class="k">def</span> <span class="nf">window_ind</span><span class="p">(</span><span class="n">ref_ind</span><span class="p">,</span><span class="n">shap</span><span class="p">,</span><span class="n">rad</span><span class="p">):</span>

    <span class="n">rad</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">rad</span><span class="p">,</span><span class="nb">max</span><span class="p">(</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span><span class="p">))</span>

    <span class="n">ind_out</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">(((</span><span class="mi">2</span><span class="o">*</span><span class="n">rad</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">,))</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="o">*</span><span class="n">rad</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
        <span class="n">pos_refx</span> <span class="o">=</span> <span class="n">ref_ind</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">rad</span><span class="o">+</span><span class="n">i</span>
        <span class="n">pos_refy</span> <span class="o">=</span> <span class="n">ref_ind</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">rad</span>
        <span class="n">ind_lin</span> <span class="o">=</span> <span class="n">pos_refx</span><span class="o">*</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">pos_refy</span>
        <span class="n">ind_out</span><span class="p">[</span><span class="n">i</span><span class="o">*</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">rad</span><span class="o">+</span><span class="mi">1</span><span class="p">):(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">rad</span><span class="o">+</span><span class="mi">1</span><span class="p">)]</span> <span class="o">=</span> <span class="n">arange</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">ind_lin</span><span class="p">),</span><span class="nb">int</span><span class="p">(</span><span class="n">ind_lin</span><span class="p">)</span><span class="o">+</span><span class="mi">2</span><span class="o">*</span><span class="n">rad</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">ind_out</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">knearest</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span><span class="n">pos_set</span><span class="p">,</span><span class="n">k</span><span class="p">):</span>
    <span class="n">shap</span> <span class="o">=</span> <span class="n">pos_set</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">ref_pos</span> <span class="o">=</span> <span class="n">ones</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">pos</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">)))</span>
    <span class="n">dist</span> <span class="o">=</span> <span class="p">((</span><span class="n">ref_pos</span><span class="o">-</span><span class="n">pos_set</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">ind</span> <span class="o">=</span> <span class="n">argsort</span><span class="p">(</span><span class="n">dist</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">ind</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">k</span><span class="p">]</span>

<span class="k">def</span> <span class="nf">saturate</span><span class="p">(</span><span class="n">im</span><span class="p">,</span><span class="n">perc</span><span class="o">=</span><span class="mf">0.5</span><span class="p">):</span> <span class="c1"># perc = percentage of energy represented by the pixels saturated</span>
    <span class="n">en</span> <span class="o">=</span> <span class="p">(</span><span class="n">im</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    <span class="n">max_val</span> <span class="o">=</span> <span class="n">im</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
    <span class="n">im_vect</span> <span class="o">=</span> <span class="n">im</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">size</span><span class="p">(</span><span class="n">im</span><span class="p">),))</span>
    <span class="n">ind</span> <span class="o">=</span> <span class="n">argsort</span><span class="p">(</span><span class="n">im_vect</span><span class="p">)</span>
    <span class="n">acc</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">i</span><span class="o">=-</span><span class="mi">1</span>
    <span class="k">while</span> <span class="n">acc</span> <span class="o">&lt;</span> <span class="n">perc</span><span class="o">*</span><span class="n">en</span><span class="p">:</span>
        <span class="n">acc</span><span class="o">+=</span><span class="p">(</span><span class="n">im_vect</span><span class="p">[</span><span class="n">ind</span><span class="p">[</span><span class="n">i</span><span class="p">]])</span><span class="o">**</span><span class="mi">2</span>
        <span class="n">i</span><span class="o">-=</span><span class="mi">1</span>

    <span class="n">thresh</span> <span class="o">=</span> <span class="n">im_vect</span><span class="p">[</span><span class="n">ind</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span>
    <span class="n">im_out</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">im</span><span class="p">)</span>
    <span class="n">i</span><span class="p">,</span><span class="n">j</span> <span class="o">=</span> <span class="n">where</span><span class="p">(</span><span class="n">im_out</span><span class="o">&gt;</span><span class="n">thresh</span><span class="p">)</span>
    <span class="n">im_out</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">thresh</span>

    <span class="c1">#im_out = im_out*max_val/thresh</span>

    <span class="k">return</span> <span class="n">im_out</span>


<span class="k">def</span> <span class="nf">field_reshape</span><span class="p">(</span><span class="n">data_cube</span><span class="p">,</span><span class="n">field_shap</span><span class="p">):</span>
    <span class="n">shap</span> <span class="o">=</span> <span class="n">data_cube</span><span class="o">.</span><span class="n">shape</span> <span class="c1"># prod(field_shap) = shap[2]</span>
    <span class="n">data_field</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">field_shap</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">field_shap</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
            <span class="n">data_field</span><span class="p">[:,:,</span><span class="n">i</span><span class="o">+</span><span class="n">j</span><span class="o">*</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="n">data_cube</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,:]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">field_shap</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">field_shap</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">data_field</span>


<span class="k">def</span> <span class="nf">field_spectrum</span><span class="p">(</span><span class="n">data_cube</span><span class="p">,</span><span class="n">field_shap</span><span class="p">):</span>
    <span class="n">data_field</span> <span class="o">=</span> <span class="n">field_reshape</span><span class="p">(</span><span class="n">data_cube</span><span class="p">,</span><span class="n">field_shap</span><span class="p">)</span>
    <span class="n">dct_stack</span> <span class="o">=</span> <span class="n">dct_cube</span><span class="p">(</span><span class="n">data_field</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span>
    <span class="n">a</span> <span class="o">=</span> <span class="n">dct_stack</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">spectrum</span> <span class="o">=</span> <span class="n">sqrt</span><span class="p">(</span><span class="n">dct_stack</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">spectrum</span><span class="p">,</span><span class="n">dct_stack</span><span class="p">,</span><span class="n">data_field</span>


<span class="k">def</span> <span class="nf">decim</span><span class="p">(</span><span class="n">im</span><span class="p">,</span><span class="n">d</span><span class="p">,</span><span class="n">av_en</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">fft</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>

    <span class="n">im_filt</span><span class="o">=</span><span class="n">copy</span><span class="p">(</span><span class="n">im</span><span class="p">)</span>
    <span class="n">im_d</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">im</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">d</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">av_en</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">siz</span> <span class="o">=</span> <span class="n">d</span><span class="o">+</span><span class="mi">1</span><span class="o">-</span><span class="p">(</span><span class="n">d</span><span class="o">%</span><span class="mi">2</span><span class="p">)</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="n">ones</span><span class="p">((</span><span class="n">siz</span><span class="p">,</span><span class="n">siz</span><span class="p">))</span><span class="o">/</span><span class="n">siz</span><span class="o">**</span><span class="mi">2</span>
            <span class="k">if</span> <span class="n">fft</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span><span class="n">im_filt</span> <span class="o">=</span> <span class="n">scisig</span><span class="o">.</span><span class="n">fftconvolve</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;same&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span><span class="n">im_filt</span> <span class="o">=</span> <span class="n">scisig</span><span class="o">.</span><span class="n">convolve</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;same&#39;</span><span class="p">)</span>
        <span class="n">n1</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">floor</span><span class="p">(</span><span class="n">im</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="n">d</span><span class="p">))</span>
        <span class="n">n2</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">floor</span><span class="p">(</span><span class="n">im</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="n">d</span><span class="p">))</span>
        <span class="n">im_d</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">n1</span><span class="p">,</span><span class="n">n2</span><span class="p">))</span>
        <span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">n1</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">n2</span><span class="p">):</span>
                <span class="n">im_d</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">im</span><span class="p">[</span><span class="n">i</span><span class="o">*</span><span class="n">d</span><span class="p">,</span><span class="n">j</span><span class="o">*</span><span class="n">d</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">av_en</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">im_filt</span><span class="p">,</span><span class="n">im_d</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">im_d</span>


<span class="k">def</span> <span class="nf">space_dist_filt</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">a</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">exp</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
    <span class="n">filt</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="mi">2</span><span class="o">*</span><span class="n">r</span><span class="o">+</span><span class="mi">1</span><span class="p">,))</span>
    <span class="n">cumul</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">r</span><span class="p">):</span>
        <span class="n">filt</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.0</span><span class="o">/</span><span class="nb">abs</span><span class="p">(</span><span class="n">double</span><span class="p">(</span><span class="n">r</span><span class="o">-</span><span class="n">i</span><span class="p">))</span><span class="o">**</span><span class="n">exp</span>
        <span class="n">cumul</span> <span class="o">+=</span> <span class="n">filt</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">filt</span><span class="p">[</span><span class="mi">2</span><span class="o">*</span><span class="n">r</span><span class="o">-</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">filt</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
    <span class="n">filt</span><span class="p">[</span><span class="n">r</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">a</span><span class="o">*</span><span class="n">cumul</span>
    <span class="n">filt</span> <span class="o">=</span> <span class="n">filt</span><span class="o">/</span><span class="p">(</span><span class="n">sqrt</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="n">filt</span><span class="o">**</span><span class="mi">2</span><span class="p">)))</span>
    <span class="k">return</span> <span class="n">filt</span>

<div class="viewcode-block" id="feat_dist_mat"><a class="viewcode-back" href="../utils.html#utils.feat_dist_mat">[docs]</a><span class="k">def</span> <span class="nf">feat_dist_mat</span><span class="p">(</span><span class="n">feat_mat</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Computes pairwise distances...?</span>
<span class="sd">    </span>
<span class="sd">    #TODO: maybe some redundancy with :func:`optim_utils.dist_map_2` here?&quot;&quot;&quot;</span>
    <span class="n">shap</span> <span class="o">=</span> <span class="n">feat_mat</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">mat_out</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>
    <span class="n">a</span> <span class="o">=</span> <span class="n">array</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
        <span class="n">ind_i</span> <span class="o">=</span> <span class="n">where</span><span class="p">(</span><span class="n">a</span><span class="o">!=</span><span class="n">i</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
            <span class="n">mat_out</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">sqrt</span><span class="p">(</span><span class="nb">sum</span><span class="p">((</span><span class="n">feat_mat</span><span class="p">[</span><span class="n">i</span><span class="p">,:]</span><span class="o">-</span><span class="n">feat_mat</span><span class="p">[</span><span class="n">ind_i</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">k</span><span class="p">],:])</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">mat_out</span></div>

<span class="k">def</span> <span class="nf">transpose_decim</span><span class="p">(</span><span class="n">im</span><span class="p">,</span><span class="n">decim_fact</span><span class="p">,</span><span class="n">av_en</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    <span class="n">shap</span> <span class="o">=</span> <span class="n">im</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">im_out</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">decim_fact</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">decim_fact</span><span class="p">))</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
            <span class="n">im_out</span><span class="p">[</span><span class="n">decim_fact</span><span class="o">*</span><span class="n">i</span><span class="p">,</span><span class="n">decim_fact</span><span class="o">*</span><span class="n">j</span><span class="p">]</span><span class="o">=</span><span class="n">im</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">av_en</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
        <span class="n">siz</span> <span class="o">=</span> <span class="n">decim_fact</span><span class="o">+</span><span class="mi">1</span><span class="o">-</span><span class="p">(</span><span class="n">decim_fact</span><span class="o">%</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="n">ones</span><span class="p">((</span><span class="n">siz</span><span class="p">,</span><span class="n">siz</span><span class="p">))</span><span class="o">/</span><span class="n">siz</span><span class="o">**</span><span class="mi">2</span>
        <span class="n">im_out</span> <span class="o">=</span> <span class="n">scisig</span><span class="o">.</span><span class="n">fftconvolve</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;same&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">im_out</span>

<span class="k">def</span> <span class="nf">decim_arr</span><span class="p">(</span><span class="n">im_arr</span><span class="p">,</span><span class="n">d</span><span class="p">,</span><span class="n">av_en</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">fft</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
    <span class="n">n3</span> <span class="o">=</span> <span class="n">im_arr</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">im_arr_d</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">im_arr</span><span class="p">)</span>
    <span class="n">im_arr_filt</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">im_arr</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">d</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">:</span>
        <span class="n">n1</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">floor</span><span class="p">(</span><span class="n">im_arr</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="n">d</span><span class="p">))</span>
        <span class="n">n2</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">floor</span><span class="p">(</span><span class="n">im_arr</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="n">d</span><span class="p">))</span>
        <span class="n">im_arr_d</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">n1</span><span class="p">,</span><span class="n">n2</span><span class="p">,</span><span class="n">n3</span><span class="p">))</span>
        <span class="n">i</span><span class="o">=</span><span class="mi">0</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">n3</span><span class="p">):</span>
            <span class="n">im_filt</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">im_d</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="n">av_en</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
                <span class="n">im_filt</span><span class="p">,</span><span class="n">im_d</span> <span class="o">=</span> <span class="n">decim</span><span class="p">(</span><span class="n">im_arr</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">],</span><span class="n">d</span><span class="p">,</span><span class="n">av_en</span><span class="o">=</span><span class="n">av_en</span><span class="p">,</span><span class="n">fft</span><span class="o">=</span><span class="n">fft</span><span class="p">)</span>
                <span class="n">im_arr_filt</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">im_filt</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">im_d</span> <span class="o">=</span> <span class="n">decim</span><span class="p">(</span><span class="n">im_arr</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">],</span><span class="n">d</span><span class="p">,</span><span class="n">av_en</span><span class="o">=</span><span class="n">av_en</span><span class="p">,</span><span class="n">fft</span><span class="o">=</span><span class="n">fft</span><span class="p">)</span>
            <span class="n">im_arr_d</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">im_d</span>
    <span class="k">return</span> <span class="n">im_arr_filt</span><span class="p">,</span><span class="n">im_arr_d</span>

<span class="k">def</span> <span class="nf">rect_crop</span><span class="p">(</span><span class="n">im</span><span class="p">,</span><span class="n">n1</span><span class="p">,</span><span class="n">n2</span><span class="p">,</span><span class="n">sigw</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">dx</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">dy</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    <span class="n">nb_im</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">im</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">2</span><span class="p">:</span><span class="n">nb_im</span> <span class="o">=</span> <span class="n">im</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>

    <span class="c1">#cent = [im.shape[0]/2-1,im.shape[1]/2-1]</span>

    <span class="k">if</span> <span class="n">nb_im</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
        <span class="n">i</span><span class="p">,</span><span class="n">j</span> <span class="o">=</span> <span class="n">where</span><span class="p">(</span><span class="n">im</span><span class="o">==</span><span class="n">im</span><span class="o">.</span><span class="n">max</span><span class="p">())</span>
        <span class="n">cent</span> <span class="o">=</span> <span class="n">array</span><span class="p">([</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">])</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">sigw</span><span class="o">!=</span><span class="mi">0</span><span class="p">:</span> <span class="n">cent</span><span class="p">,</span><span class="n">Wc</span> <span class="o">=</span> <span class="n">compute_centroid</span><span class="p">(</span><span class="n">im</span><span class="p">,</span><span class="n">sigw</span><span class="p">)</span>

        <span class="n">im_crop</span> <span class="o">=</span> <span class="n">im</span><span class="p">[</span><span class="n">around</span><span class="p">(</span><span class="n">cent</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">dx</span><span class="o">-</span><span class="n">n1</span><span class="o">/</span><span class="mi">2</span><span class="p">):</span><span class="n">around</span><span class="p">(</span><span class="n">cent</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">dx</span><span class="o">-</span><span class="n">n1</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span><span class="o">+</span><span class="n">n1</span><span class="p">,</span><span class="n">around</span><span class="p">(</span><span class="n">cent</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">dy</span><span class="o">-</span><span class="n">n2</span><span class="o">/</span><span class="mi">2</span><span class="p">):</span><span class="n">around</span><span class="p">(</span><span class="n">cent</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">dy</span><span class="o">-</span><span class="n">n2</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span><span class="o">+</span><span class="n">n2</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">im_crop</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">n1</span><span class="p">,</span><span class="n">n2</span><span class="p">,</span><span class="n">nb_im</span><span class="p">))</span>
        <span class="n">k</span><span class="o">=</span><span class="mi">0</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_im</span><span class="p">):</span>
            <span class="n">imk</span> <span class="o">=</span> <span class="n">im</span><span class="p">[:,:,</span><span class="n">k</span><span class="p">]</span>
            <span class="n">i</span><span class="p">,</span><span class="n">j</span> <span class="o">=</span> <span class="n">where</span><span class="p">(</span><span class="n">imk</span><span class="o">==</span><span class="n">imk</span><span class="o">.</span><span class="n">max</span><span class="p">())</span>
            <span class="n">cent</span> <span class="o">=</span> <span class="n">array</span><span class="p">([</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">sigw</span><span class="o">!=</span><span class="mi">0</span><span class="p">:</span> <span class="n">cent</span><span class="p">,</span><span class="n">Wc</span> <span class="o">=</span> <span class="n">compute_centroid</span><span class="p">(</span><span class="n">imk</span><span class="p">,</span><span class="n">sigw</span><span class="p">)</span>
            <span class="n">im_crop</span><span class="p">[:,:,</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">imk</span><span class="p">[</span><span class="n">around</span><span class="p">(</span><span class="n">cent</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">dx</span><span class="o">-</span><span class="n">n1</span><span class="o">/</span><span class="mi">2</span><span class="p">):</span><span class="n">around</span><span class="p">(</span><span class="n">cent</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">dx</span><span class="o">-</span><span class="n">n1</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span><span class="o">+</span><span class="n">n1</span><span class="p">,</span><span class="n">around</span><span class="p">(</span><span class="n">cent</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">dy</span><span class="o">-</span><span class="n">n2</span><span class="o">/</span><span class="mi">2</span><span class="p">):</span><span class="n">around</span><span class="p">(</span><span class="n">cent</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">dy</span><span class="o">-</span><span class="n">n2</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span><span class="o">+</span><span class="n">n2</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">im_crop</span>

<span class="k">def</span> <span class="nf">stack_err</span><span class="p">(</span><span class="n">stack_ref</span><span class="p">,</span><span class="n">stack_est</span><span class="p">,</span><span class="n">shap</span><span class="p">,</span><span class="n">sigw</span><span class="o">=</span><span class="mi">6</span><span class="p">):</span>
    <span class="n">shap_ref</span> <span class="o">=</span> <span class="n">stack_est</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">error</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">shap_ref</span><span class="p">[</span><span class="mi">4</span><span class="p">],))</span>
    <span class="n">ref_crop</span> <span class="o">=</span> <span class="n">rect_crop</span><span class="p">(</span><span class="n">stack_ref</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">sigw</span><span class="o">=</span><span class="n">sigw</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap_ref</span><span class="p">[</span><span class="mi">4</span><span class="p">]):</span>
        <span class="n">a</span><span class="o">=</span><span class="mi">0</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap_ref</span><span class="p">[</span><span class="mi">3</span><span class="p">]):</span>
            <span class="n">est_crop</span> <span class="o">=</span> <span class="n">rect_crop</span><span class="p">(</span><span class="n">stack_est</span><span class="p">[:,:,:,</span><span class="n">j</span><span class="p">,</span><span class="n">i</span><span class="p">],</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">sigw</span><span class="o">=</span><span class="n">sigw</span><span class="p">)</span>
            <span class="nb">print</span> <span class="s2">&quot;field &quot;</span><span class="p">,</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="s2">&quot;/&quot;</span><span class="p">,</span><span class="n">shap_ref</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span><span class="s2">&quot;realization &quot;</span><span class="p">,</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="s2">&quot;/&quot;</span><span class="p">,</span><span class="n">shap_ref</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap_ref</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
                <span class="n">a</span><span class="o">+=</span> <span class="nb">sum</span><span class="p">((</span><span class="n">est_crop</span><span class="p">[:,:,</span><span class="n">j</span><span class="p">]</span><span class="o">/</span><span class="n">sqrt</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="n">ref_crop</span><span class="p">[:,:,</span><span class="n">j</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span> <span class="o">-</span> <span class="n">ref_crop</span><span class="p">[:,:,</span><span class="n">j</span><span class="p">]</span><span class="o">/</span><span class="n">sqrt</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="n">ref_crop</span><span class="p">[:,:,</span><span class="n">j</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">)))</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">error</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">a</span><span class="o">/</span><span class="p">(</span><span class="n">shap_ref</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="n">shap_ref</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">error</span>

<span class="k">def</span> <span class="nf">rect_crop_c</span><span class="p">(</span><span class="n">im</span><span class="p">,</span><span class="n">n1</span><span class="p">,</span><span class="n">n2</span><span class="p">,</span><span class="n">cent</span><span class="p">,</span><span class="n">dx</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">dy</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    <span class="n">nb_im</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">im</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">2</span><span class="p">:</span><span class="n">nb_im</span> <span class="o">=</span> <span class="n">im</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>

    <span class="c1">#cent = [im.shape[0]/2-1,im.shape[1]/2-1]</span>
    <span class="n">im_crop</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">nb_im</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
        <span class="n">im_crop</span> <span class="o">=</span> <span class="n">im</span><span class="p">[</span><span class="n">around</span><span class="p">(</span><span class="n">cent</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">dx</span><span class="o">-</span><span class="n">n1</span><span class="o">/</span><span class="mi">2</span><span class="p">):</span><span class="n">around</span><span class="p">(</span><span class="n">cent</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">dx</span><span class="o">-</span><span class="n">n1</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span><span class="o">+</span><span class="n">n1</span><span class="p">,</span><span class="n">around</span><span class="p">(</span><span class="n">cent</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">dy</span><span class="o">-</span><span class="n">n2</span><span class="o">/</span><span class="mi">2</span><span class="p">):</span><span class="n">around</span><span class="p">(</span><span class="n">cent</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">dy</span><span class="o">-</span><span class="n">n2</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span><span class="o">+</span><span class="n">n2</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">im_crop</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">n1</span><span class="p">,</span><span class="n">n2</span><span class="p">,</span><span class="n">nb_im</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_im</span><span class="p">):</span>
            <span class="n">imk</span> <span class="o">=</span> <span class="n">im</span><span class="p">[:,:,</span><span class="n">k</span><span class="p">]</span>
            <span class="n">im_crop</span><span class="p">[:,:,</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">imk</span><span class="p">[</span><span class="n">around</span><span class="p">(</span><span class="n">cent</span><span class="p">[</span><span class="n">k</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">dx</span><span class="o">-</span><span class="n">n1</span><span class="o">/</span><span class="mi">2</span><span class="p">):</span><span class="n">around</span><span class="p">(</span><span class="n">cent</span><span class="p">[</span><span class="n">k</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">dx</span><span class="o">-</span><span class="n">n1</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span><span class="o">+</span><span class="n">n1</span><span class="p">,</span><span class="n">around</span><span class="p">(</span><span class="n">cent</span><span class="p">[</span><span class="n">k</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">dy</span><span class="o">-</span><span class="n">n2</span><span class="o">/</span><span class="mi">2</span><span class="p">):</span><span class="n">around</span><span class="p">(</span><span class="n">cent</span><span class="p">[</span><span class="n">k</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">dy</span><span class="o">-</span><span class="n">n2</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span><span class="o">+</span><span class="n">n2</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">im_crop</span>

<span class="k">def</span> <span class="nf">gauss_gen</span><span class="p">(</span><span class="n">sigma_x</span><span class="p">,</span><span class="n">rho</span><span class="p">,</span><span class="n">siz</span><span class="p">):</span>
    <span class="n">gal</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">siz</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">siz</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
    <span class="n">sigma_y</span> <span class="o">=</span> <span class="n">sigma_x</span><span class="o">*</span><span class="n">rho</span>
    <span class="n">i</span><span class="o">=</span><span class="mi">0</span>
    <span class="n">j</span><span class="o">=</span><span class="mi">0</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">siz</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">siz</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
            <span class="n">gal</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span><span class="o">=</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="p">((</span><span class="n">i</span><span class="o">/</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">sigma_x</span><span class="p">))</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="p">(</span><span class="n">j</span><span class="o">/</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">sigma_y</span><span class="p">))</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">gal</span>

<span class="k">def</span> <span class="nf">gauss_gen_2</span><span class="p">(</span><span class="n">sigma_x</span><span class="p">,</span><span class="n">sigma_y</span><span class="p">,</span><span class="n">cent</span><span class="p">,</span><span class="n">theta</span><span class="p">,</span><span class="n">rad</span><span class="p">):</span>

    <span class="n">gauss_map</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="mi">2</span><span class="o">*</span><span class="n">rad</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="o">*</span><span class="n">rad</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>
    <span class="n">i</span><span class="o">=</span><span class="mi">0</span>
    <span class="n">j</span><span class="o">=</span><span class="mi">0</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="o">*</span><span class="n">rad</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="o">*</span><span class="n">rad</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
            <span class="n">gauss_map</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span><span class="o">=</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="p">(((</span><span class="n">cos</span><span class="p">(</span><span class="n">theta</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">i</span><span class="o">-</span><span class="n">cent</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">+</span><span class="n">sin</span><span class="p">(</span><span class="n">theta</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">j</span><span class="o">-</span><span class="n">cent</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span><span class="o">/</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">sigma_x</span><span class="p">))</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="p">((</span><span class="o">-</span><span class="n">sin</span><span class="p">(</span><span class="n">theta</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">i</span><span class="o">-</span><span class="n">cent</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">+</span><span class="n">cos</span><span class="p">(</span><span class="n">theta</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">j</span><span class="o">-</span><span class="n">cent</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span><span class="o">/</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">sigma_y</span><span class="p">))</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">gauss_map</span>


<div class="viewcode-block" id="compute_centroid"><a class="viewcode-back" href="../utils.html#utils.compute_centroid">[docs]</a><span class="k">def</span> <span class="nf">compute_centroid</span><span class="p">(</span><span class="n">im</span><span class="p">,</span><span class="n">sigw</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">nb_iter</span><span class="o">=</span><span class="mi">4</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Computes centroid.</span>
<span class="sd">    </span>
<span class="sd">    #TODO: would be interesting to compare with Sam&#39;s moments based computation</span>
<span class="sd">    </span>
<span class="sd">    Calls:</span>
<span class="sd">    </span>
<span class="sd">    * gaussfitter.gaussfit</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">sigw</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">param</span><span class="o">=</span><span class="n">gaussfitter</span><span class="o">.</span><span class="n">gaussfit</span><span class="p">(</span><span class="n">im</span><span class="p">,</span><span class="n">returnfitimage</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="c1">#print param</span>
        <span class="n">sigw</span> <span class="o">=</span> <span class="p">(</span><span class="n">param</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">+</span><span class="n">param</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span><span class="o">/</span><span class="mi">2</span>
    <span class="n">sigw</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">sigw</span><span class="p">)</span>
    <span class="n">n1</span> <span class="o">=</span> <span class="n">im</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">n2</span> <span class="o">=</span> <span class="n">im</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">rx</span> <span class="o">=</span> <span class="n">array</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">n1</span><span class="p">))</span>
    <span class="n">ry</span> <span class="o">=</span> <span class="n">array</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">n2</span><span class="p">))</span>
    <span class="n">Wc</span> <span class="o">=</span> <span class="n">ones</span><span class="p">((</span><span class="n">n1</span><span class="p">,</span><span class="n">n2</span><span class="p">))</span>
    <span class="n">centroid</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span>
    <span class="c1"># Four iteration loop to compute the centroid</span>
    <span class="n">i</span><span class="o">=</span><span class="mi">0</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_iter</span><span class="p">):</span>

        <span class="n">xx</span> <span class="o">=</span> <span class="n">npma</span><span class="o">.</span><span class="n">outerproduct</span><span class="p">(</span><span class="n">rx</span><span class="o">-</span><span class="n">centroid</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span><span class="n">ones</span><span class="p">(</span><span class="n">n2</span><span class="p">))</span>
        <span class="n">yy</span> <span class="o">=</span> <span class="n">npma</span><span class="o">.</span><span class="n">outerproduct</span><span class="p">(</span><span class="n">ones</span><span class="p">(</span><span class="n">n1</span><span class="p">),</span><span class="n">ry</span><span class="o">-</span><span class="n">centroid</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">W</span> <span class="o">=</span> <span class="n">npma</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="p">(</span><span class="n">xx</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="n">yy</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">sigw</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span>
        <span class="n">centroid</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span>
        <span class="c1"># Estimate Centroid</span>
        <span class="n">Wc</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">W</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span><span class="n">Wc</span> <span class="o">=</span> <span class="n">ones</span><span class="p">((</span><span class="n">n1</span><span class="p">,</span><span class="n">n2</span><span class="p">))</span>
        <span class="n">totx</span><span class="o">=</span><span class="mf">0.0</span>
        <span class="n">toty</span><span class="o">=</span><span class="mf">0.0</span>
        <span class="n">cx</span><span class="o">=</span><span class="mi">0</span>
        <span class="n">cy</span><span class="o">=</span><span class="mi">0</span>

        <span class="k">for</span> <span class="n">cx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">n1</span><span class="p">):</span>
            <span class="n">centroid</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="p">(</span><span class="n">im</span><span class="p">[</span><span class="n">cx</span><span class="p">,:]</span><span class="o">*</span><span class="n">Wc</span><span class="p">[</span><span class="n">cx</span><span class="p">,:])</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">*</span><span class="p">(</span><span class="n">cx</span><span class="p">)</span>
            <span class="n">totx</span> <span class="o">+=</span> <span class="p">(</span><span class="n">im</span><span class="p">[</span><span class="n">cx</span><span class="p">,:]</span><span class="o">*</span><span class="n">Wc</span><span class="p">[</span><span class="n">cx</span><span class="p">,:])</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">cy</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">n2</span><span class="p">):</span>
            <span class="n">centroid</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="p">(</span><span class="n">im</span><span class="p">[:,</span><span class="n">cy</span><span class="p">]</span><span class="o">*</span><span class="n">Wc</span><span class="p">[:,</span><span class="n">cy</span><span class="p">])</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">*</span><span class="p">(</span><span class="n">cy</span><span class="p">)</span>
            <span class="n">toty</span> <span class="o">+=</span> <span class="p">(</span><span class="n">im</span><span class="p">[:,</span><span class="n">cy</span><span class="p">]</span><span class="o">*</span><span class="n">Wc</span><span class="p">[:,</span><span class="n">cy</span><span class="p">])</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="n">centroid</span> <span class="o">=</span> <span class="n">centroid</span><span class="o">*</span><span class="n">array</span><span class="p">([</span><span class="mi">1</span><span class="o">/</span><span class="n">totx</span><span class="p">,</span><span class="mi">1</span><span class="o">/</span><span class="n">toty</span><span class="p">])</span>


    <span class="k">return</span> <span class="p">(</span><span class="n">centroid</span><span class="p">,</span><span class="n">Wc</span><span class="p">)</span></div>

<span class="k">def</span> <span class="nf">compute_centroid_2</span><span class="p">(</span><span class="n">im</span><span class="p">,</span><span class="n">Wc</span><span class="p">):</span>
    <span class="n">n1</span> <span class="o">=</span> <span class="n">im</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">n2</span> <span class="o">=</span> <span class="n">im</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">rx</span> <span class="o">=</span> <span class="n">array</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">n1</span><span class="p">))</span>
    <span class="n">ry</span> <span class="o">=</span> <span class="n">array</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">n2</span><span class="p">))</span>
    <span class="n">centroid</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="mi">2</span><span class="p">,))</span>

    <span class="n">totx</span><span class="o">=</span><span class="mf">0.0</span>
    <span class="n">toty</span><span class="o">=</span><span class="mf">0.0</span>
    <span class="n">cx</span><span class="o">=</span><span class="mi">0</span>
    <span class="n">cy</span><span class="o">=</span><span class="mi">0</span>

    <span class="k">for</span> <span class="n">cx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">n1</span><span class="p">):</span>
        <span class="n">centroid</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="p">(</span><span class="n">im</span><span class="p">[</span><span class="n">cx</span><span class="p">,:]</span><span class="o">*</span><span class="n">Wc</span><span class="p">[</span><span class="n">cx</span><span class="p">,:])</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">*</span><span class="p">(</span><span class="n">cx</span><span class="p">)</span>
        <span class="n">totx</span> <span class="o">+=</span> <span class="p">(</span><span class="n">im</span><span class="p">[</span><span class="n">cx</span><span class="p">,:]</span><span class="o">*</span><span class="n">Wc</span><span class="p">[</span><span class="n">cx</span><span class="p">,:])</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">cy</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">n2</span><span class="p">):</span>
        <span class="n">centroid</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="p">(</span><span class="n">im</span><span class="p">[:,</span><span class="n">cy</span><span class="p">]</span><span class="o">*</span><span class="n">Wc</span><span class="p">[:,</span><span class="n">cy</span><span class="p">])</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">*</span><span class="p">(</span><span class="n">cy</span><span class="p">)</span>
        <span class="n">toty</span> <span class="o">+=</span> <span class="p">(</span><span class="n">im</span><span class="p">[:,</span><span class="n">cy</span><span class="p">]</span><span class="o">*</span><span class="n">Wc</span><span class="p">[:,</span><span class="n">cy</span><span class="p">])</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    <span class="n">centroid</span> <span class="o">=</span> <span class="n">centroid</span><span class="o">*</span><span class="n">array</span><span class="p">([</span><span class="mi">1</span><span class="o">/</span><span class="n">totx</span><span class="p">,</span><span class="mi">1</span><span class="o">/</span><span class="n">toty</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">centroid</span>

<span class="k">def</span> <span class="nf">compute_centroid_arr</span><span class="p">(</span><span class="n">data_cube</span><span class="p">,</span><span class="n">sigw</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">nb_iter</span><span class="o">=</span><span class="mi">4</span><span class="p">):</span>
    <span class="n">nb_psf</span> <span class="o">=</span> <span class="n">data_cube</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">centroid</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">nb_psf</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_psf</span><span class="p">):</span>
        <span class="n">centroid_i</span><span class="p">,</span><span class="n">wc</span> <span class="o">=</span> <span class="n">compute_centroid</span><span class="p">(</span><span class="n">data_cube</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">],</span><span class="n">sigw</span><span class="o">=</span><span class="n">sigw</span><span class="p">,</span><span class="n">nb_iter</span><span class="o">=</span><span class="n">nb_iter</span><span class="p">)</span>
        <span class="n">centroid</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">centroid_i</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">centroid</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">centroid_i</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">centroid</span>

<span class="k">def</span> <span class="nf">mk_ellipticity</span><span class="p">(</span><span class="n">im</span><span class="p">,</span><span class="n">sigw</span><span class="p">,</span><span class="n">niter_cent</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span><span class="n">cent_return</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">get_quad</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="n">q</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span>
    <span class="n">ell</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="mi">2</span><span class="p">,))</span>
    <span class="n">centroid</span><span class="p">,</span><span class="n">Wc</span> <span class="o">=</span> <span class="n">compute_centroid</span><span class="p">(</span><span class="n">im</span><span class="p">,</span><span class="n">sigw</span><span class="p">,</span><span class="n">niter_cent</span><span class="p">)</span>
    <span class="n">n1</span> <span class="o">=</span> <span class="n">im</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">n2</span> <span class="o">=</span> <span class="n">im</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">rx</span> <span class="o">=</span> <span class="n">array</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">n1</span><span class="p">))</span>
    <span class="n">xx</span> <span class="o">=</span> <span class="n">npma</span><span class="o">.</span><span class="n">outerproduct</span><span class="p">(</span><span class="n">rx</span><span class="o">-</span><span class="n">centroid</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span><span class="n">ones</span><span class="p">(</span><span class="n">n2</span><span class="p">))</span>
    <span class="n">ry</span> <span class="o">=</span> <span class="n">array</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">n2</span><span class="p">))</span>
    <span class="n">yy</span> <span class="o">=</span> <span class="n">npma</span><span class="o">.</span><span class="n">outerproduct</span><span class="p">(</span><span class="n">ones</span><span class="p">(</span><span class="n">n1</span><span class="p">),</span><span class="n">ry</span><span class="o">-</span><span class="n">centroid</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">q</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="p">(</span><span class="n">im</span><span class="o">*</span><span class="p">(</span><span class="n">xx</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">Wc</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    <span class="n">q</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">=</span><span class="p">(</span><span class="n">im</span><span class="o">*</span><span class="p">(</span><span class="n">yy</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">Wc</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    <span class="n">q</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">=</span><span class="p">(</span><span class="n">im</span><span class="o">*</span><span class="n">xx</span><span class="o">*</span><span class="n">yy</span><span class="o">*</span><span class="n">Wc</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    <span class="n">q</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="p">(</span><span class="n">transpose</span><span class="p">(</span><span class="n">im</span><span class="p">)</span><span class="o">*</span><span class="n">xx</span><span class="o">*</span><span class="n">yy</span><span class="o">*</span><span class="n">Wc</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    <span class="n">q</span> <span class="o">=</span> <span class="n">q</span><span class="o">/</span><span class="p">((</span><span class="n">im</span><span class="o">*</span><span class="n">Wc</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span>
    <span class="n">ell</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">q</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">q</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">])</span><span class="o">/</span><span class="p">(</span><span class="n">q</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">q</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">ell</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">q</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">q</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span><span class="o">/</span><span class="p">(</span><span class="n">q</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">q</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">])</span>

    <span class="k">if</span> <span class="n">cent_return</span><span class="o">==</span><span class="kc">True</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">ell</span><span class="p">,</span><span class="n">centroid</span>
    <span class="k">elif</span> <span class="n">get_quad</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">ell</span><span class="p">,</span><span class="n">q</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">ell</span>

<span class="k">def</span> <span class="nf">mk_ellipticity_2</span><span class="p">(</span><span class="n">im</span><span class="p">,</span><span class="n">Wc</span><span class="p">):</span>
    <span class="n">q</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span>
    <span class="n">ell</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="mi">2</span><span class="p">,))</span>
    <span class="n">centroid</span> <span class="o">=</span> <span class="n">compute_centroid_2</span><span class="p">(</span><span class="n">im</span><span class="p">,</span><span class="n">Wc</span><span class="p">)</span>
    <span class="n">n1</span> <span class="o">=</span> <span class="n">im</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">n2</span> <span class="o">=</span> <span class="n">im</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">rx</span> <span class="o">=</span> <span class="n">array</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">n1</span><span class="p">))</span>
    <span class="n">xx</span> <span class="o">=</span> <span class="n">npma</span><span class="o">.</span><span class="n">outerproduct</span><span class="p">(</span><span class="n">rx</span><span class="o">-</span><span class="n">centroid</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">ones</span><span class="p">(</span><span class="n">n2</span><span class="p">))</span>
    <span class="n">ry</span> <span class="o">=</span> <span class="n">array</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">n2</span><span class="p">))</span>
    <span class="n">yy</span> <span class="o">=</span> <span class="n">npma</span><span class="o">.</span><span class="n">outerproduct</span><span class="p">(</span><span class="n">ones</span><span class="p">(</span><span class="n">n1</span><span class="p">),</span><span class="n">ry</span><span class="o">-</span><span class="n">centroid</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">q</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="p">(</span><span class="n">im</span><span class="o">*</span><span class="p">(</span><span class="n">xx</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">Wc</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    <span class="n">q</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">=</span><span class="p">(</span><span class="n">im</span><span class="o">*</span><span class="p">(</span><span class="n">yy</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">Wc</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    <span class="n">q</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">=</span><span class="p">(</span><span class="n">im</span><span class="o">*</span><span class="n">xx</span><span class="o">*</span><span class="n">yy</span><span class="o">*</span><span class="n">Wc</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    <span class="n">q</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="p">(</span><span class="n">transpose</span><span class="p">(</span><span class="n">im</span><span class="p">)</span><span class="o">*</span><span class="n">xx</span><span class="o">*</span><span class="n">yy</span><span class="o">*</span><span class="n">Wc</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    <span class="n">q</span> <span class="o">=</span> <span class="n">q</span><span class="o">/</span><span class="p">((</span><span class="n">im</span><span class="o">*</span><span class="n">Wc</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span>
    <span class="n">ell</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">q</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">q</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">])</span><span class="o">/</span><span class="p">(</span><span class="n">q</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">q</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">ell</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">q</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">q</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span><span class="o">/</span><span class="p">(</span><span class="n">q</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">q</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">fwhm</span><span class="o">=</span><span class="mi">0</span>
    <span class="k">if</span> <span class="n">q</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">q</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
        <span class="n">fwhm</span> <span class="o">=</span> <span class="n">sqrt</span><span class="p">(</span><span class="n">q</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">q</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">ell</span><span class="p">,</span><span class="n">centroid</span><span class="p">,</span><span class="n">fwhm</span>

<span class="k">def</span> <span class="nf">mk_elliticity_2_arr</span><span class="p">(</span><span class="n">cube</span><span class="p">,</span><span class="n">Wc</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">get_quad</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="n">shap</span> <span class="o">=</span> <span class="n">cube</span><span class="o">.</span><span class="n">shape</span>
    <span class="k">if</span> <span class="n">Wc</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">Wc</span> <span class="o">=</span> <span class="n">ones</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>

    <span class="n">ell_out</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="mi">2</span><span class="p">))</span>
    <span class="n">fwhm</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">],))</span>
    <span class="n">q</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
        <span class="n">ell_out</span><span class="p">[</span><span class="n">i</span><span class="p">,:],</span><span class="n">q</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">mk_ellipticity</span><span class="p">(</span><span class="n">cube</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">],</span><span class="mf">10.0</span><span class="o">**</span><span class="p">(</span><span class="mi">10</span><span class="p">),</span><span class="n">cent_return</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">get_quad</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">q</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">i</span><span class="p">]</span><span class="o">+</span><span class="n">q</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">i</span><span class="p">]</span><span class="o">&gt;=</span><span class="mi">0</span><span class="p">:</span>
            <span class="n">fwhm</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">sqrt</span><span class="p">(</span><span class="n">q</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">i</span><span class="p">]</span><span class="o">+</span><span class="n">q</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">i</span><span class="p">])</span>

    <span class="k">if</span> <span class="n">get_quad</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">ell_out</span><span class="p">,</span><span class="n">fwhm</span><span class="p">,</span><span class="n">q</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">ell_out</span><span class="p">,</span><span class="n">fwhm</span>

<span class="k">def</span> <span class="nf">mk_ellipticity_error</span><span class="p">(</span><span class="n">ref_ell</span><span class="p">,</span><span class="n">ref_fwhm</span><span class="p">,</span><span class="n">cube</span><span class="p">,</span><span class="n">Wc</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="n">ell</span><span class="p">,</span><span class="n">fwhm</span> <span class="o">=</span> <span class="n">mk_elliticity_2_arr</span><span class="p">(</span><span class="n">cube</span><span class="p">,</span><span class="n">Wc</span><span class="o">=</span><span class="n">Wc</span><span class="p">)</span>
    <span class="n">err</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">ref_ell</span><span class="o">-</span><span class="n">ell</span><span class="p">)</span>
    <span class="n">mean_err</span> <span class="o">=</span> <span class="n">sqrt</span><span class="p">(</span><span class="nb">sum</span><span class="p">((</span><span class="n">ref_ell</span><span class="o">-</span><span class="n">ell</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
    <span class="n">std_err</span> <span class="o">=</span> <span class="n">err</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">mean_err</span><span class="p">,</span><span class="n">std_err</span><span class="p">,</span><span class="n">ell</span><span class="p">,</span><span class="n">err</span>

<span class="k">def</span> <span class="nf">mk_ellipticity_error_m</span><span class="p">(</span><span class="n">ref_ell</span><span class="p">,</span><span class="n">cube_m</span><span class="p">,</span><span class="n">Wc</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="n">shap</span> <span class="o">=</span> <span class="n">cube_m</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">mean_err</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span><span class="mi">2</span><span class="p">))</span>
    <span class="n">std_err</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span><span class="mi">2</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">3</span><span class="p">]):</span>
        <span class="n">mean_erri</span><span class="p">,</span><span class="n">std_erri</span><span class="p">,</span><span class="n">elli</span><span class="p">,</span><span class="n">erri</span> <span class="o">=</span> <span class="n">mk_ellipticity_error</span><span class="p">(</span><span class="n">ref_ell</span><span class="p">,</span><span class="n">cube_m</span><span class="p">[:,:,:,</span><span class="n">i</span><span class="p">],</span><span class="n">Wc</span><span class="o">=</span><span class="n">Wc</span><span class="p">)</span>
        <span class="n">mean_err</span><span class="p">[</span><span class="n">i</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">mean_erri</span>
        <span class="n">std_err</span><span class="p">[</span><span class="n">i</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">std_erri</span>
    <span class="k">return</span> <span class="n">mean_err</span><span class="p">,</span><span class="n">std_err</span>

<span class="k">def</span> <span class="nf">moffat_fitting_2d</span><span class="p">(</span><span class="n">im</span><span class="p">,</span><span class="n">width</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span><span class="n">exp</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
    <span class="n">shap</span> <span class="o">=</span> <span class="n">im</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">y</span><span class="p">,</span> <span class="n">x</span> <span class="o">=</span> <span class="n">mgrid</span><span class="p">[:</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="p">:</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
    <span class="n">z</span> <span class="o">=</span> <span class="n">im</span>

    <span class="c1"># Fit the data using astropy.modeling</span>
    <span class="n">amplitude</span> <span class="o">=</span> <span class="n">im</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
    <span class="n">x_0</span><span class="p">,</span><span class="n">y_0</span> <span class="o">=</span> <span class="n">where</span><span class="p">(</span><span class="n">im</span><span class="o">==</span><span class="n">amplitude</span><span class="p">)</span>
    <span class="n">p_init</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">Moffat2D</span><span class="p">(</span><span class="n">amplitude</span><span class="o">=</span><span class="n">im</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span><span class="n">x_0</span> <span class="o">=</span> <span class="n">x_0</span><span class="p">,</span><span class="n">y_0</span> <span class="o">=</span> <span class="n">y_0</span><span class="p">,</span><span class="n">gamma</span><span class="o">=</span><span class="n">width</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="n">exp</span><span class="p">)</span>
    <span class="n">fit_p</span> <span class="o">=</span> <span class="n">fitting</span><span class="o">.</span><span class="n">LevMarLSQFitter</span><span class="p">()</span>

    <span class="k">with</span> <span class="n">warnings</span><span class="o">.</span><span class="n">catch_warnings</span><span class="p">():</span>
        <span class="c1"># Ignore model linearity warning from the fitter</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">simplefilter</span><span class="p">(</span><span class="s1">&#39;ignore&#39;</span><span class="p">)</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">fit_p</span><span class="p">(</span><span class="n">p_init</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">)</span>
    <span class="n">alpha</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">alpha</span><span class="o">.</span><span class="n">value</span>
    <span class="n">gamma</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">gamma</span><span class="o">.</span><span class="n">value</span>
    <span class="n">fwhm</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">alpha</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">fwhm</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">fwhm</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">gamma</span><span class="o">*</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="o">**</span><span class="p">(</span><span class="mf">1.0</span><span class="o">/</span><span class="n">alpha</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">fit_mod</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
            <span class="n">fit_mod</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">p</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">p</span><span class="p">,</span><span class="n">fwhm</span><span class="p">,</span><span class="n">fit_mod</span>

<span class="k">def</span> <span class="nf">mk_ellipticity_arr</span><span class="p">(</span><span class="n">im_arr</span><span class="p">,</span><span class="n">sigw</span><span class="p">,</span><span class="n">niter_cent</span><span class="o">=</span><span class="mi">4</span><span class="p">):</span>
    <span class="n">n3</span> <span class="o">=</span> <span class="n">im_arr</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">ell_arr</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">n3</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span>
    <span class="n">theta</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">n3</span><span class="p">,))</span>
    <span class="n">i</span><span class="o">=</span><span class="mi">0</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">n3</span><span class="p">):</span>
        <span class="n">ell</span> <span class="o">=</span> <span class="n">mk_ellipticity</span><span class="p">(</span><span class="n">im_arr</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">],</span><span class="n">sigw</span><span class="p">,</span><span class="n">niter_cent</span><span class="o">=</span><span class="n">niter_cent</span><span class="p">)</span>
        <span class="n">ell_arr</span><span class="p">[</span><span class="n">i</span><span class="p">,:]</span><span class="o">=</span><span class="n">ell</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">sqrt</span><span class="p">(</span><span class="n">ell</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="n">ell</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">cos_om</span> <span class="o">=</span> <span class="n">ell</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="n">r</span>
        <span class="n">om</span> <span class="o">=</span> <span class="n">arccos</span><span class="p">(</span><span class="n">cos_om</span><span class="p">)</span>
        <span class="n">theta</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">om</span><span class="o">/</span><span class="mi">2</span>
    <span class="k">return</span> <span class="n">ell_arr</span><span class="p">,</span><span class="n">theta</span>

<span class="k">def</span> <span class="nf">psf_shape</span><span class="p">(</span><span class="n">im</span><span class="p">,</span><span class="n">width</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span><span class="n">exp</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">weighting</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="n">fit_mod</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">fwhm</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">ell</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="c1">#p,fwhm,fit_mod = moffat_fitting_2d(im,width=width,exp=exp)</span>
    <span class="k">if</span> <span class="n">weighting</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
        <span class="n">shap</span> <span class="o">=</span> <span class="n">im</span><span class="o">.</span><span class="n">shape</span>
        <span class="n">fit_mod</span> <span class="o">=</span> <span class="n">ones</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
        <span class="n">ell</span><span class="p">,</span><span class="n">centroid</span><span class="p">,</span><span class="n">fwhm</span> <span class="o">=</span> <span class="n">mk_ellipticity_2</span><span class="p">(</span><span class="n">im</span><span class="p">,</span><span class="n">fit_mod</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">p</span><span class="p">,</span><span class="n">fwhmk</span><span class="p">,</span><span class="n">fit_mod</span> <span class="o">=</span> <span class="n">moffat_fitting_2d</span><span class="p">(</span><span class="n">im</span><span class="p">,</span><span class="n">width</span><span class="o">=</span><span class="n">width</span><span class="p">,</span><span class="n">exp</span><span class="o">=</span><span class="n">exp</span><span class="p">)</span>
        <span class="n">ell</span><span class="p">,</span><span class="n">centroid</span><span class="p">,</span><span class="n">fwhm</span> <span class="o">=</span> <span class="n">mk_ellipticity_2</span><span class="p">(</span><span class="n">im</span><span class="p">,</span><span class="n">fit_mod</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">ell</span><span class="p">,</span><span class="n">fwhm</span><span class="p">,</span><span class="n">centroid</span>

<span class="k">def</span> <span class="nf">psf_shape_arr</span><span class="p">(</span><span class="n">psf_cube</span><span class="p">,</span><span class="n">width</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span><span class="n">exp</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">weighting</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="n">shap</span> <span class="o">=</span> <span class="n">psf_cube</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">fwhm</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">],))</span>
    <span class="n">ell</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="mi">2</span><span class="p">))</span>
    <span class="n">centroid</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="mi">2</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
        <span class="c1">#print i+1,&quot;/&quot;,shap[2]</span>
        <span class="n">ell_i</span><span class="p">,</span><span class="n">fwhm_i</span><span class="p">,</span><span class="n">centroid_i</span> <span class="o">=</span> <span class="n">psf_shape</span><span class="p">(</span><span class="n">psf_cube</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">],</span><span class="n">width</span><span class="o">=</span><span class="n">width</span><span class="p">,</span><span class="n">exp</span><span class="o">=</span><span class="n">exp</span><span class="p">,</span><span class="n">weighting</span><span class="o">=</span><span class="n">weighting</span><span class="p">)</span>
        <span class="n">ell</span><span class="p">[</span><span class="n">i</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">ell_i</span>
        <span class="n">centroid</span><span class="p">[</span><span class="n">i</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">centroid_i</span>
        <span class="n">fwhm</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">fwhm_i</span>

    <span class="k">return</span> <span class="n">ell</span><span class="p">,</span><span class="n">centroid</span><span class="p">,</span><span class="n">fwhm</span>

<span class="k">def</span> <span class="nf">psf_shape_eucl</span><span class="p">(</span><span class="n">im</span><span class="p">,</span><span class="n">sigw</span><span class="o">=</span><span class="mi">10000000000</span><span class="p">):</span>
    <span class="n">ell</span><span class="p">,</span><span class="n">q</span> <span class="o">=</span> <span class="n">mk_ellipticity</span><span class="p">(</span><span class="n">im</span><span class="p">,</span><span class="n">sigw</span><span class="p">,</span><span class="n">cent_return</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">get_quad</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">R</span> <span class="o">=</span> <span class="n">q</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">q</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">q</span><span class="p">,</span><span class="n">R</span>

<span class="k">def</span> <span class="nf">psf_shape_eucl_arr</span><span class="p">(</span><span class="n">psf</span><span class="p">,</span><span class="n">sigw</span><span class="o">=</span><span class="mi">10000000000</span><span class="p">):</span>

    <span class="n">nb_psfs</span> <span class="o">=</span> <span class="n">psf</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">q_out</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="n">nb_psfs</span><span class="p">))</span>
    <span class="n">R</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">nb_psfs</span><span class="p">,))</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_psfs</span><span class="p">):</span>
        <span class="n">q_out</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">],</span><span class="n">R</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">psf_shape_eucl</span><span class="p">(</span><span class="n">psf</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">],</span><span class="n">sigw</span><span class="o">=</span><span class="n">sigw</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">q_out</span><span class="p">,</span><span class="n">R</span>

<span class="k">def</span> <span class="nf">moments_err</span><span class="p">(</span><span class="n">res</span><span class="p">,</span><span class="n">R</span><span class="p">,</span><span class="n">sigw</span><span class="o">=</span><span class="mi">10000000000</span><span class="p">):</span>
    <span class="n">q_res</span><span class="p">,</span><span class="n">R_res</span> <span class="o">=</span> <span class="n">psf_shape_eucl_arr</span><span class="p">(</span><span class="n">res</span><span class="p">,</span><span class="n">sigw</span><span class="o">=</span><span class="n">sigw</span><span class="p">)</span>
    <span class="n">rms00</span> <span class="o">=</span> <span class="p">(</span><span class="n">q_res</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,:]</span><span class="o">/</span><span class="n">R</span><span class="p">)</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>
    <span class="n">rms01</span> <span class="o">=</span> <span class="p">(</span><span class="n">q_res</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,:]</span><span class="o">/</span><span class="n">R</span><span class="p">)</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>
    <span class="n">rms10</span> <span class="o">=</span> <span class="p">(</span><span class="n">q_res</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,:]</span><span class="o">/</span><span class="n">R</span><span class="p">)</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>
    <span class="n">rms11</span> <span class="o">=</span> <span class="p">(</span><span class="n">q_res</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,:]</span><span class="o">/</span><span class="n">R</span><span class="p">)</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">rms00</span><span class="p">,</span><span class="n">rms01</span><span class="p">,</span><span class="n">rms10</span><span class="p">,</span><span class="n">rms11</span>

<span class="k">def</span> <span class="nf">moments_err_2</span><span class="p">(</span><span class="n">psf_est</span><span class="p">,</span><span class="n">psf_ref</span><span class="p">,</span><span class="n">sigw</span><span class="o">=</span><span class="mi">10000000000</span><span class="p">):</span>
    <span class="n">q</span><span class="p">,</span><span class="n">R</span> <span class="o">=</span> <span class="n">psf_shape_eucl_arr</span><span class="p">(</span><span class="n">psf_ref</span><span class="p">,</span><span class="n">sigw</span><span class="o">=</span><span class="n">sigw</span><span class="p">)</span>
    <span class="n">nb_real</span> <span class="o">=</span> <span class="n">psf_est</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>

    <span class="n">rms_out</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">nb_real</span><span class="p">,</span><span class="mi">4</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_real</span><span class="p">):</span>
        <span class="n">rms_out</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span><span class="n">rms_out</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span><span class="n">rms_out</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">2</span><span class="p">],</span><span class="n">rms_out</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">moments_err</span><span class="p">(</span><span class="n">psf_est</span><span class="p">[:,:,:,</span><span class="n">i</span><span class="p">]</span><span class="o">-</span><span class="n">psf_ref</span><span class="p">,</span><span class="n">R</span><span class="p">,</span><span class="n">sigw</span><span class="o">=</span><span class="n">sigw</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">rms_out</span><span class="p">,</span><span class="n">R</span>




<span class="k">def</span> <span class="nf">psf_err_bias</span><span class="p">(</span><span class="n">psf_ref</span><span class="p">,</span><span class="n">psf_est_list</span><span class="p">):</span>
    <span class="n">nb_real</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">psf_est_list</span><span class="p">)</span>
    <span class="n">q_mean_1</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="n">nb_real</span><span class="p">))</span>
    <span class="n">q_mean_2</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="n">nb_real</span><span class="p">))</span>
    <span class="n">ell_out</span><span class="p">,</span><span class="n">fwhm</span><span class="p">,</span><span class="n">q1</span> <span class="o">=</span> <span class="n">mk_elliticity_2_arr</span><span class="p">(</span><span class="n">psf_ref</span><span class="p">,</span><span class="n">Wc</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">get_quad</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_real</span><span class="p">):</span>
        <span class="n">ell_out</span><span class="p">,</span><span class="n">fwhm</span><span class="p">,</span><span class="n">qi</span> <span class="o">=</span> <span class="n">mk_elliticity_2_arr</span><span class="p">(</span><span class="n">psf_est_list</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">Wc</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">get_quad</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">q</span> <span class="o">=</span> <span class="n">qi</span><span class="o">/</span><span class="p">(</span><span class="n">qi</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,:]</span><span class="o">+</span><span class="n">qi</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,:])</span> <span class="o">-</span> <span class="n">q1</span><span class="o">/</span><span class="p">(</span><span class="n">q1</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,:]</span><span class="o">+</span><span class="n">q1</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,:])</span>
        <span class="n">q_mean_1</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">sqrt</span><span class="p">((</span><span class="n">q</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">))</span>
        <span class="n">mean_res</span> <span class="o">=</span> <span class="p">(</span><span class="n">psf_ref</span><span class="o">-</span><span class="n">psf_est_list</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">ell</span><span class="p">,</span><span class="n">q_mean_2</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">mk_ellipticity</span><span class="p">(</span><span class="n">mean_res</span><span class="p">,</span><span class="mf">10.0</span><span class="o">**</span><span class="p">(</span><span class="mi">10</span><span class="p">),</span><span class="n">niter_cent</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span><span class="n">cent_return</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">get_quad</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>


    <span class="k">return</span> <span class="n">q_mean_1</span><span class="p">,</span><span class="n">q_mean_2</span>


<span class="k">def</span> <span class="nf">psf_shape_list</span><span class="p">(</span><span class="n">psf_cube</span><span class="p">,</span><span class="n">width</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span><span class="n">exp</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">weighting</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="n">nb_r</span>  <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">psf_cube</span><span class="p">)</span>
    <span class="n">list_ell</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
    <span class="n">list_fwhm</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_r</span><span class="p">):</span>
        <span class="n">ell</span><span class="p">,</span><span class="n">centroid</span><span class="p">,</span><span class="n">fwhm</span> <span class="o">=</span> <span class="n">psf_shape_arr</span><span class="p">(</span><span class="n">psf_cube</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">width</span><span class="o">=</span><span class="n">width</span><span class="p">,</span><span class="n">exp</span><span class="o">=</span><span class="n">exp</span><span class="p">,</span><span class="n">weighting</span><span class="o">=</span><span class="n">weighting</span><span class="p">)</span>
        <span class="n">list_ell</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ell</span><span class="p">)</span>
        <span class="n">list_fwhm</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fwhm</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">list_ell</span><span class="p">,</span><span class="n">list_fwhm</span>

<span class="k">def</span> <span class="nf">im_shape</span><span class="p">(</span><span class="n">im</span><span class="p">,</span><span class="n">scale</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">scale</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">scale</span> <span class="o">=</span> <span class="n">im</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
    <span class="n">shap</span> <span class="o">=</span> <span class="n">im</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">cent</span> <span class="o">=</span> <span class="n">compute_centroid_2</span><span class="p">(</span><span class="n">im</span><span class="p">,</span><span class="n">ones</span><span class="p">(</span><span class="n">shap</span><span class="p">))</span>
    <span class="n">data_matrix</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
            <span class="n">lin_ind</span> <span class="o">=</span> <span class="n">i</span><span class="o">+</span><span class="n">j</span><span class="o">*</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">data_matrix</span><span class="p">[:,</span><span class="n">lin_ind</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">array</span><span class="p">([</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">])</span><span class="o">-</span><span class="n">cent</span><span class="p">)</span><span class="o">*</span><span class="n">im</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span><span class="o">/</span><span class="n">scale</span> <span class="o">+</span> <span class="n">cent</span>
    <span class="n">m</span> <span class="o">=</span> <span class="n">data_matrix</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">m</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>
    <span class="n">ones_v</span> <span class="o">=</span> <span class="n">ones</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
    <span class="n">U</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">Vt</span> <span class="o">=</span> <span class="n">linalg</span><span class="o">.</span><span class="n">svd</span><span class="p">(</span><span class="n">data_matrix</span><span class="o">-</span><span class="n">m</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">ones_v</span><span class="p">),</span><span class="n">full_matrices</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">U</span><span class="p">,</span><span class="n">s</span><span class="p">,</span><span class="n">data_matrix</span>

<span class="k">def</span> <span class="nf">cloud_shape</span><span class="p">(</span><span class="n">cloud_pos</span><span class="p">,</span><span class="n">weights</span><span class="p">,</span><span class="n">scale</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>

    <span class="k">if</span> <span class="n">scale</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">scale</span> <span class="o">=</span> <span class="n">weights</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
    <span class="n">nb_points</span> <span class="o">=</span> <span class="n">cloud_pos</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">cent</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="mi">2</span><span class="p">,))</span>
    <span class="n">cent</span> <span class="o">=</span> <span class="n">cloud_centroid</span><span class="p">(</span><span class="n">cloud_pos</span><span class="p">,</span><span class="n">weights</span><span class="p">)</span>

    <span class="n">data_matrix</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span><span class="n">nb_points</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_points</span><span class="p">):</span>
        <span class="n">data_matrix</span><span class="p">[:,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">cloud_pos</span><span class="p">[</span><span class="n">i</span><span class="p">,:]</span><span class="o">-</span><span class="n">cent</span><span class="p">)</span><span class="o">*</span><span class="n">weights</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">/</span><span class="n">scale</span> <span class="o">+</span> <span class="n">cent</span>
    <span class="n">m</span> <span class="o">=</span> <span class="n">data_matrix</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">m</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>
    <span class="n">ones_v</span> <span class="o">=</span> <span class="n">ones</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span><span class="n">nb_points</span><span class="p">))</span>
    <span class="n">U</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">Vt</span> <span class="o">=</span> <span class="n">linalg</span><span class="o">.</span><span class="n">svd</span><span class="p">(</span><span class="n">data_matrix</span><span class="o">-</span><span class="n">m</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">ones_v</span><span class="p">),</span><span class="n">full_matrices</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">U</span><span class="p">,</span><span class="n">s</span><span class="p">,</span><span class="n">data_matrix</span>


<span class="k">def</span> <span class="nf">cloud_centroid</span><span class="p">(</span><span class="n">cloud_pos</span><span class="p">,</span><span class="n">weights</span><span class="p">):</span>
    <span class="n">nb_points</span> <span class="o">=</span> <span class="n">cloud_pos</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">cent</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="mi">2</span><span class="p">,))</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_points</span><span class="p">):</span>
        <span class="n">cent</span><span class="o">+=</span><span class="n">weights</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">*</span><span class="n">cloud_pos</span><span class="p">[</span><span class="n">i</span><span class="p">,:]</span>
    <span class="n">cent</span><span class="o">/=</span><span class="nb">sum</span><span class="p">(</span><span class="n">weights</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">cent</span>

<span class="k">def</span> <span class="nf">shape_error</span><span class="p">(</span><span class="n">ell_ref</span><span class="p">,</span><span class="n">fwhm_ref</span><span class="p">,</span><span class="n">data</span><span class="p">,</span><span class="n">width</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span><span class="n">exp</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">weighting</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>

    <span class="n">shap</span> <span class="o">=</span> <span class="n">ell_ref</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">shap2</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">shap2</span><span class="p">)</span><span class="o">==</span><span class="mi">3</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">shap2</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">shap2</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">shap2</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">shap2</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">ell_err</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">shap2</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="n">shap2</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span><span class="mi">2</span><span class="p">))</span>
    <span class="n">fwhm_err</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">shap2</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="n">shap2</span><span class="p">[</span><span class="mi">3</span><span class="p">],))</span>
    <span class="n">fwhm</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">shap2</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="n">shap2</span><span class="p">[</span><span class="mi">3</span><span class="p">],))</span>


    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap2</span><span class="p">[</span><span class="mi">3</span><span class="p">]):</span>
        <span class="n">ell</span><span class="p">,</span><span class="n">centroid</span><span class="p">,</span><span class="n">fwhm_i</span> <span class="o">=</span> <span class="n">psf_shape_arr</span><span class="p">(</span><span class="n">data</span><span class="p">[:,:,:,</span><span class="n">i</span><span class="p">],</span><span class="n">width</span><span class="o">=</span><span class="n">width</span><span class="p">,</span><span class="n">exp</span><span class="o">=</span><span class="n">exp</span><span class="p">,</span><span class="n">weighting</span><span class="o">=</span><span class="n">weighting</span><span class="p">)</span>
        <span class="n">ell_err</span><span class="p">[</span><span class="n">i</span><span class="o">*</span><span class="n">shap2</span><span class="p">[</span><span class="mi">2</span><span class="p">]:(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">shap2</span><span class="p">[</span><span class="mi">2</span><span class="p">],:]</span> <span class="o">=</span> <span class="n">ell</span><span class="o">-</span><span class="n">ell_ref</span>
        <span class="n">fwhm_err</span><span class="p">[</span><span class="n">i</span><span class="o">*</span><span class="n">shap2</span><span class="p">[</span><span class="mi">2</span><span class="p">]:(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">shap2</span><span class="p">[</span><span class="mi">2</span><span class="p">]]</span> <span class="o">=</span> <span class="n">fwhm_i</span> <span class="o">-</span> <span class="n">fwhm_ref</span>
        <span class="n">fwhm</span><span class="p">[</span><span class="n">i</span><span class="o">*</span><span class="n">shap2</span><span class="p">[</span><span class="mi">2</span><span class="p">]:(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">shap2</span><span class="p">[</span><span class="mi">2</span><span class="p">]]</span> <span class="o">=</span> <span class="n">fwhm_i</span>

    <span class="n">mean_err_ell</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">ell_err</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">std_err_ell</span> <span class="o">=</span> <span class="n">ell_err</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>


    <span class="n">mean_err_fwhm</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">fwhm_err</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
    <span class="n">std_err_fwhm</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">fwhm_err</span><span class="p">)</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">mean_err_ell</span><span class="p">,</span><span class="n">std_err_ell</span><span class="p">,</span><span class="n">mean_err_fwhm</span><span class="p">,</span><span class="n">std_err_fwhm</span><span class="p">,</span><span class="n">ell_err</span><span class="p">,</span><span class="n">fwhm_err</span>

<span class="k">def</span> <span class="nf">error_list</span><span class="p">(</span><span class="n">data_ref</span><span class="p">,</span><span class="n">data</span><span class="p">,</span><span class="n">width</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span><span class="n">exp</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">weighting</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="kn">from</span> <span class="nn">numpy</span> <span class="k">import</span> <span class="n">zeros</span>
    <span class="kn">from</span> <span class="nn">numpy.linalg</span> <span class="k">import</span> <span class="n">norm</span>
    <span class="n">nb_real</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="n">ell_ref</span><span class="p">,</span><span class="n">centroid_ref</span><span class="p">,</span><span class="n">fwhm_ref</span> <span class="o">=</span> <span class="n">psf_shape_arr</span><span class="p">(</span><span class="n">data_ref</span><span class="p">,</span><span class="n">width</span><span class="o">=</span><span class="n">width</span><span class="p">,</span><span class="n">exp</span><span class="o">=</span><span class="n">exp</span><span class="p">,</span><span class="n">weighting</span><span class="o">=</span><span class="n">weighting</span><span class="p">)</span>
    <span class="n">mse</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">nb_real</span><span class="p">,))</span>
    <span class="n">ell_err</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">nb_real</span><span class="p">,))</span>
    <span class="n">fwhm_err</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">nb_real</span><span class="p">,))</span>
    <span class="n">norm_data</span> <span class="o">=</span> <span class="n">norm</span><span class="p">(</span><span class="n">data_ref</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>
    <span class="n">norm_ell</span> <span class="o">=</span> <span class="n">norm</span><span class="p">(</span><span class="n">ell_ref</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_real</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">3</span><span class="p">]):</span>
            <span class="n">ell_j</span><span class="p">,</span><span class="n">centroid_j</span><span class="p">,</span><span class="n">fwhm_j</span> <span class="o">=</span> <span class="n">psf_shape_arr</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">][:,:,:,</span><span class="n">j</span><span class="p">],</span><span class="n">width</span><span class="o">=</span><span class="n">width</span><span class="p">,</span><span class="n">exp</span><span class="o">=</span><span class="n">exp</span><span class="p">,</span><span class="n">weighting</span><span class="o">=</span><span class="n">weighting</span><span class="p">)</span>
            <span class="n">mse</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">+=</span><span class="n">mean</span><span class="p">(</span><span class="n">norm</span><span class="p">(</span><span class="n">data_ref</span><span class="o">-</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">][:,:,:,</span><span class="n">j</span><span class="p">],</span><span class="n">axis</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span><span class="o">/</span><span class="n">norm_data</span><span class="p">)</span>
            <span class="n">ell_err</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">+=</span><span class="n">mean</span><span class="p">(</span><span class="n">norm</span><span class="p">(</span><span class="n">ell_ref</span><span class="o">-</span><span class="n">ell_j</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="n">norm_ell</span><span class="p">)</span>
            <span class="n">fwhm_err</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">+=</span><span class="n">mean</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">fwhm_ref</span><span class="o">-</span><span class="n">fwhm_j</span><span class="p">))</span>
        <span class="n">mse</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">/=</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
        <span class="n">ell_err</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">/=</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
        <span class="n">fwhm_err</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">/=</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">mse</span><span class="p">,</span><span class="n">fwhm_err</span><span class="p">,</span><span class="n">ell_err</span>

<span class="k">def</span> <span class="nf">shape_error_m2</span><span class="p">(</span><span class="n">ell_ref</span><span class="p">,</span><span class="n">fwhm_ref</span><span class="p">,</span><span class="n">data_list</span><span class="p">,</span><span class="n">width</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span><span class="n">exp</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">weighting</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>

    <span class="n">nb_real</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">data_list</span><span class="p">)</span>
    <span class="n">mean_err_ell</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">nb_real</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span>
    <span class="n">std_err_ell</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">nb_real</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span>
    <span class="n">mean_err_fwhm</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">nb_real</span><span class="p">,))</span>
    <span class="n">std_err_fwhm</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">nb_real</span><span class="p">,))</span>
    <span class="n">err_ell</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
    <span class="n">err_fwhm</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_real</span><span class="p">):</span>
        <span class="n">mean_err_ell</span><span class="p">[</span><span class="n">i</span><span class="p">,:],</span><span class="n">std_err_ell</span><span class="p">[</span><span class="n">i</span><span class="p">,:],</span><span class="n">mean_err_fwhm</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">std_err_fwhm</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">ell_err_i</span><span class="p">,</span><span class="n">fwhm_err_i</span> <span class="o">=</span> <span class="n">shape_error</span><span class="p">(</span><span class="n">ell_ref</span><span class="p">,</span><span class="n">fwhm_ref</span><span class="p">,</span><span class="n">data_list</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">width</span><span class="o">=</span><span class="n">width</span><span class="p">,</span><span class="n">exp</span><span class="o">=</span><span class="n">exp</span><span class="p">,</span><span class="n">weighting</span><span class="o">=</span><span class="n">weighting</span><span class="p">)</span>
        <span class="n">err_ell</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ell_err_i</span><span class="p">)</span>
        <span class="n">err_fwhm</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fwhm_err_i</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">mean_err_ell</span><span class="p">,</span><span class="n">std_err_ell</span><span class="p">,</span><span class="n">mean_err_fwhm</span><span class="p">,</span><span class="n">std_err_fwhm</span><span class="p">,</span><span class="n">err_ell</span><span class="p">,</span><span class="n">err_fwhm</span>

<span class="k">def</span> <span class="nf">mean_squared_error</span><span class="p">(</span><span class="n">data_ref</span><span class="p">,</span><span class="n">est_list</span><span class="p">):</span>
    <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">est_list</span><span class="p">)</span>
    <span class="n">err</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">n</span><span class="p">,))</span>
    <span class="n">err_raw</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
    <span class="n">shap</span> <span class="o">=</span> <span class="n">data_ref</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">norms</span> <span class="o">=</span> <span class="n">norm</span><span class="p">(</span><span class="n">data_ref</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">])),</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">n</span><span class="p">):</span>
        <span class="n">err_raw</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mean</span><span class="p">(((</span><span class="n">data_ref</span><span class="o">-</span><span class="n">est_list</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="o">/</span><span class="n">norms</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">)))</span>
        <span class="n">err</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">mean</span><span class="p">(</span><span class="n">err_raw</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">err</span><span class="p">,</span><span class="n">err_raw</span>

<span class="k">def</span> <span class="nf">shape_error_m</span><span class="p">(</span><span class="n">ell_ref</span><span class="p">,</span><span class="n">fwhm_ref</span><span class="p">,</span><span class="n">data</span><span class="p">,</span><span class="n">width</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span><span class="n">exp</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">weighting</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="n">nb_fields</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
    <span class="n">nb_samp</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">mean_err_ell</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">nb_fields</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span>
    <span class="n">std_err_ell</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">nb_fields</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span>
    <span class="n">mean_err_fwhm</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">nb_fields</span><span class="p">,))</span>
    <span class="n">std_err_fwhm</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">nb_fields</span><span class="p">,))</span>
    <span class="n">err_ell</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">nb_samp</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="n">nb_fields</span><span class="p">))</span>
    <span class="n">err_fwhm</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">nb_samp</span><span class="p">,</span><span class="n">nb_fields</span><span class="p">))</span>


    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_fields</span><span class="p">):</span>
        <span class="nb">print</span> <span class="s2">&quot;field &quot;</span><span class="p">,</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="s2">&quot;/&quot;</span><span class="p">,</span><span class="n">nb_fields</span>
        <span class="n">mean_err_ell_i</span><span class="p">,</span><span class="n">std_err_ell_i</span><span class="p">,</span><span class="n">mean_err_fwhm_i</span><span class="p">,</span><span class="n">std_err_fwhm_i</span><span class="p">,</span><span class="n">ell_err_i</span><span class="p">,</span><span class="n">fwhm_err_i</span> <span class="o">=</span> <span class="n">shape_error</span><span class="p">(</span><span class="n">ell_ref</span><span class="p">,</span><span class="n">fwhm_ref</span><span class="p">,</span><span class="n">data</span><span class="p">[:,:,:,</span><span class="n">i</span><span class="p">],</span><span class="n">width</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span><span class="n">exp</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">weighting</span><span class="o">=</span><span class="n">weighting</span><span class="p">)</span>
        <span class="n">mean_err_ell</span><span class="p">[</span><span class="n">i</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">mean_err_ell_i</span>
        <span class="n">std_err_ell</span><span class="p">[</span><span class="n">i</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">std_err_ell_i</span>
        <span class="n">mean_err_fwhm</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">mean_err_fwhm_i</span>
        <span class="n">std_err_fwhm</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">std_err_fwhm_i</span>
        <span class="n">err_ell</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">ell_err_i</span>
        <span class="n">err_fwhm</span><span class="p">[:,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">fwhm_err_i</span>

    <span class="k">return</span> <span class="n">mean_err_ell</span><span class="p">,</span><span class="n">std_err_ell</span><span class="p">,</span><span class="n">mean_err_fwhm</span><span class="p">,</span><span class="n">std_err_fwhm</span><span class="p">,</span><span class="n">err_ell</span><span class="p">,</span><span class="n">err_fwhm</span>

<span class="k">def</span> <span class="nf">shape_error_list</span><span class="p">(</span><span class="n">data_ref</span><span class="p">,</span><span class="n">ell_ref</span><span class="p">,</span><span class="n">fwhm_ref</span><span class="p">,</span><span class="n">data</span><span class="p">,</span><span class="n">width</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span><span class="n">exp</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">weighting</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>

    <span class="n">nb_fields</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">ell_ref</span><span class="p">)</span>
    <span class="n">mean_err_fwhm</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">nb_fields</span><span class="p">,))</span>
    <span class="n">std_err_fwhm</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">nb_fields</span><span class="p">,))</span>
    <span class="n">err_ell</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
    <span class="n">err_fwhm</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
    <span class="n">mean_err_ell</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">nb_fields</span><span class="p">,))</span>
    <span class="n">std_err_ell</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">nb_fields</span><span class="p">,))</span>
    <span class="n">mean_lsq</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">nb_fields</span><span class="p">,))</span>


    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_fields</span><span class="p">):</span>
        <span class="n">mean_err_ell_i</span><span class="p">,</span><span class="n">std_err_ell_i</span><span class="p">,</span><span class="n">mean_err_fwhm_i</span><span class="p">,</span><span class="n">std_err_fwhm_i</span><span class="p">,</span><span class="n">ell_err_i</span><span class="p">,</span><span class="n">fwhm_err_i</span> <span class="o">=</span> <span class="n">shape_error</span><span class="p">(</span><span class="n">ell_ref</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">fwhm_ref</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">width</span><span class="o">=</span><span class="n">width</span><span class="p">,</span><span class="n">exp</span><span class="o">=</span><span class="n">exp</span><span class="p">,</span><span class="n">weighting</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">mean_err_fwhm</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">mean_err_fwhm_i</span>
        <span class="n">std_err_fwhm</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">std_err_fwhm_i</span>
        <span class="n">err_ell</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ell_err_i</span><span class="p">)</span>
        <span class="n">err_fwhm</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fwhm_err_i</span><span class="p">)</span>
        <span class="n">mean_err_ell</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">mean</span><span class="p">(</span><span class="n">sqrt</span><span class="p">((</span><span class="n">ell_err_i</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)))</span>
        <span class="n">std_err_ell</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">vect_error_disp</span><span class="p">(</span><span class="n">ell_err_i</span><span class="p">)</span>
        <span class="n">mean_lsq</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="n">data_ref</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">/</span><span class="n">data_ref</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">mean_err_fwhm</span><span class="p">,</span><span class="n">std_err_fwhm</span><span class="p">,</span><span class="n">err_ell</span><span class="p">,</span><span class="n">err_fwhm</span><span class="p">,</span><span class="n">mean_err_ell</span><span class="p">,</span><span class="n">std_err_ell</span><span class="p">,</span><span class="n">mean_lsq</span>

<span class="k">def</span> <span class="nf">vect_error_disp</span><span class="p">(</span><span class="n">err_mat</span><span class="p">):</span> <span class="c1"># Each line is an error vector</span>
    <span class="n">shap</span> <span class="o">=</span> <span class="n">err_mat</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">mean_err</span> <span class="o">=</span> <span class="n">err_mat</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">mean_err</span> <span class="o">=</span> <span class="n">mean_err</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>
    <span class="n">mat_cent</span> <span class="o">=</span> <span class="n">transpose</span><span class="p">(</span><span class="n">err_mat</span><span class="p">)</span> <span class="o">-</span> <span class="n">mean_err</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">ones</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">])))</span>
    <span class="n">svecl</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">svecr</span> <span class="o">=</span> <span class="n">linalg</span><span class="o">.</span><span class="n">svd</span><span class="p">(</span><span class="n">mat_cent</span><span class="p">,</span><span class="n">full_matrices</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">nuc_norm</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">nuc_norm</span>

<span class="k">def</span> <span class="nf">vect_error_disp_stack</span><span class="p">(</span><span class="n">err_mat</span><span class="p">):</span>
    <span class="n">shap</span> <span class="o">=</span> <span class="n">err_mat</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">nuc_norms</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">],))</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
        <span class="n">nuc_norms</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">vect_error_disp</span><span class="p">(</span><span class="n">err_mat</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">])</span>

    <span class="k">return</span> <span class="n">nuc_norms</span>

<span class="k">def</span> <span class="nf">proj_mat_2</span><span class="p">(</span><span class="n">siz</span><span class="p">,</span><span class="n">offset</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    <span class="n">n1</span><span class="p">,</span><span class="n">n2</span><span class="o">=</span> <span class="n">siz</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">siz</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">mat_proj</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="mi">6</span><span class="p">,</span><span class="n">n1</span><span class="o">*</span><span class="n">n2</span><span class="p">))</span>
    <span class="n">mat_proj_temp</span><span class="p">,</span><span class="n">normv</span><span class="o">=</span><span class="n">proj_mat</span><span class="p">(</span><span class="n">siz</span><span class="p">,</span><span class="n">offset</span><span class="p">)</span>
    <span class="n">i</span><span class="o">=</span><span class="mi">0</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">6</span><span class="p">):</span><span class="n">mat_proj</span><span class="p">[</span><span class="n">i</span><span class="p">,:]</span> <span class="o">=</span> <span class="p">(</span><span class="n">mat_proj_temp</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">])</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">n1</span><span class="o">*</span><span class="n">n2</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">mat_proj</span>

<span class="k">def</span> <span class="nf">proj_mat</span><span class="p">(</span><span class="n">siz</span><span class="p">,</span><span class="n">offset</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    <span class="n">n1</span><span class="p">,</span><span class="n">n2</span><span class="o">=</span> <span class="n">siz</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">siz</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">mat_proj</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">n1</span><span class="p">,</span><span class="n">n2</span><span class="p">,</span><span class="mi">6</span><span class="p">))</span>
    <span class="n">normv</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="mi">6</span><span class="p">,))</span>
    <span class="n">rx</span> <span class="o">=</span> <span class="n">array</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">n1</span><span class="p">))</span>
    <span class="n">mat_proj</span><span class="p">[:,:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">npma</span><span class="o">.</span><span class="n">outerproduct</span><span class="p">(</span><span class="n">rx</span><span class="o">+</span><span class="n">offset</span><span class="p">,</span><span class="n">ones</span><span class="p">(</span><span class="n">n2</span><span class="p">))</span>
    <span class="n">normv</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">sqrt</span><span class="p">((</span><span class="n">mat_proj</span><span class="p">[:,:,</span><span class="mi">0</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span>
    <span class="n">ry</span> <span class="o">=</span> <span class="n">array</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">n2</span><span class="p">))</span>
    <span class="n">mat_proj</span><span class="p">[:,:,</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">npma</span><span class="o">.</span><span class="n">outerproduct</span><span class="p">(</span><span class="n">ones</span><span class="p">(</span><span class="n">n1</span><span class="p">),</span><span class="n">ry</span><span class="o">+</span><span class="n">offset</span><span class="p">)</span>
    <span class="n">normv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">sqrt</span><span class="p">((</span><span class="n">mat_proj</span><span class="p">[:,:,</span><span class="mi">1</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span>
    <span class="n">mat_proj</span><span class="p">[:,:,</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">ones</span><span class="p">((</span><span class="n">n1</span><span class="p">,</span><span class="n">n2</span><span class="p">))</span>
    <span class="n">normv</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">sqrt</span><span class="p">((</span><span class="n">mat_proj</span><span class="p">[:,:,</span><span class="mi">2</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span>
    <span class="n">mat_proj</span><span class="p">[:,:,</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">mat_proj</span><span class="p">[:,:,</span><span class="mi">0</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">mat_proj</span><span class="p">[:,:,</span><span class="mi">1</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span>
    <span class="n">normv</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">sqrt</span><span class="p">((</span><span class="n">mat_proj</span><span class="p">[:,:,</span><span class="mi">3</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span>
    <span class="n">mat_proj</span><span class="p">[:,:,</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">mat_proj</span><span class="p">[:,:,</span><span class="mi">0</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span> <span class="o">-</span> <span class="n">mat_proj</span><span class="p">[:,:,</span><span class="mi">1</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span>
    <span class="n">normv</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">sqrt</span><span class="p">((</span><span class="n">mat_proj</span><span class="p">[:,:,</span><span class="mi">4</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span>
    <span class="n">mat_proj</span><span class="p">[:,:,</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="n">mat_proj</span><span class="p">[:,:,</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">mat_proj</span><span class="p">[:,:,</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">normv</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="n">sqrt</span><span class="p">((</span><span class="n">mat_proj</span><span class="p">[:,:,</span><span class="mi">5</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span>
    <span class="k">return</span> <span class="n">mat_proj</span><span class="p">,</span><span class="n">normv</span>


<span class="k">def</span> <span class="nf">shape_energy</span><span class="p">(</span><span class="n">shape_comp</span><span class="p">,</span><span class="n">coeff</span><span class="p">,</span><span class="n">principal_comp</span><span class="p">):</span>
    <span class="n">nb_comp</span> <span class="o">=</span> <span class="n">coeff</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">comp_shape_en</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">nb_comp</span><span class="p">,))</span>
    <span class="n">data_shape_en</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">nb_comp</span><span class="p">,))</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_comp</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shape_comp</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
            <span class="n">comp_shape_en</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+=</span> <span class="p">((</span><span class="n">principal_comp</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">]</span><span class="o">*</span><span class="n">shape_comp</span><span class="p">[:,:,</span><span class="n">j</span><span class="p">])</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span><span class="o">**</span><span class="mi">2</span>
        <span class="n">data_shape_en</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">comp_shape_en</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="n">coeff</span><span class="p">[</span><span class="n">i</span><span class="p">,:]</span><span class="o">.</span><span class="n">std</span><span class="p">())</span><span class="o">**</span><span class="mi">2</span>

    <span class="k">return</span> <span class="n">comp_shape_en</span><span class="p">,</span><span class="n">data_shape_en</span>

<span class="c1">#def shape_analysis(coeff,cube_comp,):</span>

<span class="k">def</span> <span class="nf">mk_ellipticity_atoms</span><span class="p">(</span><span class="n">im</span><span class="p">,</span><span class="n">offset</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">sigw</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">sigw</span> <span class="o">!=</span><span class="mi">0</span> <span class="p">:</span>
        <span class="n">centroid</span><span class="p">,</span><span class="n">Wc</span> <span class="o">=</span> <span class="n">compute_centroid</span><span class="p">(</span><span class="n">im</span><span class="p">,</span><span class="n">sigw</span><span class="p">)</span>
        <span class="n">im</span> <span class="o">=</span> <span class="n">im</span><span class="o">*</span><span class="n">Wc</span>
    <span class="n">mat_proj</span><span class="p">,</span><span class="n">normv</span> <span class="o">=</span> <span class="n">proj_mat</span><span class="p">(</span><span class="n">im</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span><span class="n">offset</span><span class="p">)</span>
    <span class="n">U</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="mi">6</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>
    <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">6</span><span class="p">):</span><span class="n">U</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">im</span><span class="o">*</span><span class="n">mat_proj</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">])</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>

    <span class="n">e1</span> <span class="o">=</span> <span class="n">U</span><span class="p">[</span><span class="mi">4</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">U</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">U</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="n">U</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span>
    <span class="n">e2</span> <span class="o">=</span> <span class="n">U</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">U</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">U</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="o">-</span><span class="n">U</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span>
    <span class="n">e3</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="n">U</span><span class="p">[</span><span class="mi">5</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">U</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">U</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">U</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">ell</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span>
    <span class="n">ell</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">e1</span><span class="o">/</span><span class="n">e2</span>
    <span class="n">ell</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">e3</span><span class="o">/</span><span class="n">e2</span>
    <span class="n">centroid</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span>
    <span class="n">centroid</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">im</span><span class="o">*</span><span class="n">mat_proj</span><span class="p">[:,:,</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">/</span><span class="p">(</span><span class="n">im</span><span class="o">*</span><span class="n">mat_proj</span><span class="p">[:,:,</span><span class="mi">2</span><span class="p">])</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    <span class="n">centroid</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">im</span><span class="o">*</span><span class="n">mat_proj</span><span class="p">[:,:,</span><span class="mi">1</span><span class="p">])</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">/</span><span class="p">(</span><span class="n">im</span><span class="o">*</span><span class="n">mat_proj</span><span class="p">[:,:,</span><span class="mi">2</span><span class="p">])</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">centroid</span><span class="p">,</span><span class="n">U</span><span class="p">,</span><span class="n">ell</span>

<span class="k">def</span> <span class="nf">mk_ellipticity_atoms_basic</span><span class="p">(</span><span class="n">U</span><span class="p">):</span>
    <span class="n">e1</span> <span class="o">=</span> <span class="n">U</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">*</span><span class="n">U</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">-</span><span class="n">U</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="n">U</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span>
    <span class="n">e2</span> <span class="o">=</span> <span class="n">U</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">*</span><span class="n">U</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">-</span><span class="n">U</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="o">-</span><span class="n">U</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span>
    <span class="n">e3</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="n">U</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span><span class="o">*</span><span class="n">U</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">-</span><span class="n">U</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">U</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">ell</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span>
    <span class="n">ell</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">e1</span><span class="o">/</span><span class="n">e2</span>
    <span class="n">ell</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">e3</span><span class="o">/</span><span class="n">e2</span>
    <span class="k">return</span> <span class="n">ell</span>

<span class="k">def</span> <span class="nf">ellipticity_basics_grad</span><span class="p">(</span><span class="n">U</span><span class="p">):</span>
    <span class="n">den</span> <span class="o">=</span> <span class="p">(</span><span class="n">U</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">*</span><span class="n">U</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">-</span><span class="n">U</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="o">-</span><span class="n">U</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span>
    <span class="n">grad_comp_1</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="mi">5</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>
    <span class="n">grad_comp_2</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="mi">5</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>
    <span class="n">grad_comp_1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">U</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="p">((</span><span class="n">U</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">-</span><span class="n">U</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span><span class="o">*</span><span class="n">U</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">U</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="n">den</span>
    <span class="n">grad_comp_1</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">U</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="p">((</span><span class="n">U</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">+</span><span class="n">U</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span><span class="o">*</span><span class="n">U</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">U</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="n">den</span>
    <span class="n">grad_comp_1</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="n">U</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">-</span><span class="n">U</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span><span class="o">*</span><span class="n">U</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="o">-</span><span class="p">(</span><span class="n">U</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">+</span><span class="n">U</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span><span class="o">*</span><span class="n">U</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="n">den</span>
    <span class="n">grad_comp_1</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">U</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="n">U</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">*</span><span class="n">U</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">-</span><span class="n">U</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="n">U</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="n">den</span>
    <span class="n">grad_comp_1</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">U</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="n">U</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">*</span><span class="n">U</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">-</span><span class="n">U</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="o">-</span><span class="n">U</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="n">den</span>

    <span class="n">grad_comp_2</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">U</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">U</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="n">U</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">+</span><span class="mi">4</span><span class="o">*</span><span class="n">U</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">U</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="n">U</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span><span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">U</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">U</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="mi">2</span><span class="o">*</span><span class="n">U</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">**</span><span class="mi">3</span><span class="p">)</span><span class="o">/</span><span class="n">den</span>
    <span class="n">grad_comp_2</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">U</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">U</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="n">U</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">+</span><span class="mi">4</span><span class="o">*</span><span class="n">U</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">U</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="n">U</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span><span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">U</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">U</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="mi">2</span><span class="o">*</span><span class="n">U</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">**</span><span class="mi">3</span><span class="p">)</span><span class="o">/</span><span class="n">den</span>
    <span class="n">grad_comp_2</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">U</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="n">U</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="n">U</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="mi">2</span><span class="o">*</span><span class="n">U</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">U</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">U</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span><span class="o">/</span><span class="n">den</span>
    <span class="n">grad_comp_2</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">U</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="n">U</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span><span class="o">*</span><span class="n">U</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">-</span><span class="n">U</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">U</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">/</span><span class="n">den</span>
    <span class="n">grad_comp_2</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">U</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="n">U</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">*</span><span class="n">U</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">-</span><span class="n">U</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="o">-</span><span class="n">U</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="n">den</span>

    <span class="k">return</span> <span class="n">grad_comp_1</span><span class="p">,</span><span class="n">grad_comp_2</span>

<span class="k">def</span> <span class="nf">ellipticity_grad</span><span class="p">(</span><span class="n">im</span><span class="p">):</span>
    <span class="n">mat_proj</span><span class="p">,</span><span class="n">normv</span> <span class="o">=</span> <span class="n">proj_mat</span><span class="p">(</span><span class="n">im</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>

    <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">6</span><span class="p">):</span><span class="n">U</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">im</span><span class="o">*</span><span class="n">mat_proj</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">])</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    <span class="n">centroid</span><span class="p">,</span><span class="n">U</span><span class="p">,</span><span class="n">ell</span> <span class="o">=</span> <span class="n">mk_ellipticity_atoms</span><span class="p">(</span><span class="n">im</span><span class="p">)</span>
    <span class="n">c</span> <span class="o">=</span> <span class="n">U</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">*</span><span class="n">U</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">-</span><span class="n">U</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="o">-</span><span class="n">U</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span>
    <span class="n">grad1</span> <span class="o">=</span> <span class="n">U</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="n">mat_proj</span><span class="p">[:,:,</span><span class="mi">4</span><span class="p">]</span> <span class="o">-</span> <span class="n">ell</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">U</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="n">mat_proj</span><span class="p">[:,:,</span><span class="mi">3</span><span class="p">]</span> <span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">ell</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span><span class="o">*</span><span class="n">U</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">mat_proj</span><span class="p">[:,:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">ell</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span><span class="o">*</span><span class="n">U</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">mat_proj</span><span class="p">[:,:,</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="p">(</span><span class="n">U</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">-</span><span class="n">ell</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">U</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span><span class="o">*</span><span class="n">mat_proj</span><span class="p">[:,:,</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">grad1</span> <span class="o">=</span> <span class="n">grad1</span><span class="o">/</span><span class="n">c</span>

    <span class="n">grad2</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">U</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="n">mat_proj</span><span class="p">[:,:,</span><span class="mi">5</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">U</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span><span class="o">-</span><span class="n">ell</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">U</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span><span class="o">*</span><span class="n">mat_proj</span><span class="p">[:,:,</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="n">ell</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">U</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">U</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">*</span><span class="n">mat_proj</span><span class="p">[:,:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="n">ell</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">U</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">U</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">*</span><span class="n">mat_proj</span><span class="p">[:,:,</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">ell</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">U</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="n">mat_proj</span><span class="p">[:,:,</span><span class="mi">3</span><span class="p">]</span>
    <span class="n">grad2</span> <span class="o">=</span> <span class="n">grad2</span><span class="o">/</span><span class="n">c</span>
    <span class="k">return</span> <span class="n">grad1</span><span class="p">,</span><span class="n">grad2</span>

<span class="k">def</span> <span class="nf">ellipticity_gradt</span><span class="p">(</span><span class="n">im</span><span class="p">,</span><span class="n">u</span><span class="p">,</span><span class="n">t</span><span class="p">):</span>
    <span class="n">mat_proj</span><span class="p">,</span><span class="n">normv</span> <span class="o">=</span> <span class="n">proj_mat</span><span class="p">(</span><span class="n">im</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">Uu</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="mi">6</span><span class="p">,))</span>
    <span class="n">Ug</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="mi">6</span><span class="p">,))</span>
    <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">6</span><span class="p">):</span>
        <span class="n">Uu</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">im</span><span class="o">*</span><span class="n">mat_proj</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">])</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="n">Ug</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u</span><span class="o">*</span><span class="n">mat_proj</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">])</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>

    <span class="n">centroid</span><span class="p">,</span><span class="n">Ut</span><span class="p">,</span><span class="n">ellt</span> <span class="o">=</span> <span class="n">mk_ellipticity_atoms</span><span class="p">(</span><span class="n">im</span><span class="o">+</span><span class="n">t</span><span class="o">*</span><span class="n">u</span><span class="p">)</span>
    <span class="n">c</span> <span class="o">=</span> <span class="n">Ut</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">*</span><span class="n">Ut</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">-</span><span class="n">Ut</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="o">-</span><span class="n">Ut</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span>
    <span class="n">a1</span> <span class="o">=</span> <span class="n">Uu</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">*</span><span class="n">Ug</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">+</span><span class="n">Ug</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">*</span><span class="n">Uu</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="n">Uu</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">Ug</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">Uu</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">Ug</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">a2</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="n">Uu</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">*</span><span class="n">Uu</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">-</span><span class="n">Uu</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="n">Uu</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">d1</span> <span class="o">=</span> <span class="n">Uu</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">*</span><span class="n">Ug</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">+</span><span class="n">Ug</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">*</span><span class="n">Uu</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="n">Uu</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">Ug</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">Uu</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">Ug</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">d2</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="n">Uu</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">*</span><span class="n">Uu</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">-</span><span class="n">Uu</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="o">-</span><span class="n">Uu</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>

    <span class="n">b1</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="n">Uu</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span><span class="o">*</span><span class="n">Ug</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">+</span><span class="n">Ug</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span><span class="o">*</span><span class="n">Uu</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">-</span><span class="n">Uu</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">Ug</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">Ug</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">Uu</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">b2</span> <span class="o">=</span> <span class="mi">4</span><span class="o">*</span><span class="p">(</span><span class="n">Uu</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span><span class="o">*</span><span class="n">Uu</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">-</span><span class="n">Uu</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">Uu</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

    <span class="n">der1</span> <span class="o">=</span> <span class="p">(</span><span class="n">a1</span><span class="o">+</span><span class="n">a2</span><span class="o">*</span><span class="n">t</span><span class="p">)</span><span class="o">/</span><span class="n">c</span> <span class="o">-</span> <span class="n">ellt</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="n">d1</span><span class="o">+</span><span class="n">d2</span><span class="o">*</span><span class="n">t</span><span class="p">)</span><span class="o">/</span><span class="n">c</span>
    <span class="n">der2</span> <span class="o">=</span> <span class="p">(</span><span class="n">b1</span><span class="o">+</span><span class="n">b2</span><span class="o">*</span><span class="n">t</span><span class="p">)</span><span class="o">/</span><span class="n">c</span> <span class="o">-</span> <span class="n">ellt</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="n">d1</span><span class="o">+</span><span class="n">d2</span><span class="o">*</span><span class="n">t</span><span class="p">)</span><span class="o">/</span><span class="n">c</span>

    <span class="k">return</span> <span class="n">der1</span><span class="p">,</span><span class="n">der2</span><span class="p">,</span><span class="n">ellt</span>

<span class="k">def</span> <span class="nf">field_comp_wise_ell_grad</span><span class="p">(</span><span class="n">stack</span><span class="p">,</span><span class="n">comp</span><span class="p">,</span><span class="n">coeff</span><span class="p">):</span>
    <span class="n">nb_im</span> <span class="o">=</span> <span class="n">stack</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">nb_comp</span> <span class="o">=</span> <span class="n">comp</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>

    <span class="n">ell_map</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">nb_im</span><span class="p">,</span><span class="n">nb_comp</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span>
    <span class="n">grad_map</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">nb_im</span><span class="p">,</span><span class="n">nb_comp</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_im</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_comp</span><span class="p">):</span>
            <span class="n">grad_map</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span><span class="n">grad_map</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span><span class="n">ell_map</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">ellipticity_gradt</span><span class="p">(</span><span class="n">stack</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">],</span><span class="n">comp</span><span class="p">[:,:,</span><span class="n">j</span><span class="p">],</span><span class="mi">0</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">ell_map</span><span class="p">,</span><span class="n">grad_map</span>

<span class="k">def</span> <span class="nf">field_comp_wise_ell_taylor_approx</span><span class="p">(</span><span class="n">coeff</span><span class="p">,</span><span class="n">ell_map</span><span class="p">,</span><span class="n">grad_map</span><span class="p">,</span><span class="n">pos_field</span><span class="p">):</span><span class="c1">#,pos_ref=None):</span>
    <span class="n">knn</span> <span class="o">=</span> <span class="n">FLANN</span><span class="p">()</span>

    <span class="n">params</span> <span class="o">=</span> <span class="n">knn</span><span class="o">.</span><span class="n">build_index</span><span class="p">(</span><span class="n">array</span><span class="p">(</span><span class="n">pos_field</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">float64</span><span class="p">))</span>
    <span class="n">result</span><span class="p">,</span> <span class="n">dists</span> <span class="o">=</span> <span class="n">knn</span><span class="o">.</span><span class="n">nn_index</span><span class="p">(</span><span class="n">pos_field</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">shap</span> <span class="o">=</span> <span class="n">ell_map</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">ell_est</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">pos_field</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="mi">2</span><span class="p">))</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">pos_field</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
        <span class="n">ell_est</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">ell_map</span><span class="p">[</span><span class="n">result</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span> <span class="nb">sum</span><span class="p">((</span><span class="n">coeff</span><span class="p">[:,</span><span class="n">i</span><span class="p">]</span><span class="o">-</span><span class="n">coeff</span><span class="p">[:,</span><span class="n">result</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">]])</span><span class="o">*</span><span class="n">grad_map</span><span class="p">[</span><span class="n">result</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">],:,</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">ell_est</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">ell_map</span><span class="p">[</span><span class="n">result</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span> <span class="nb">sum</span><span class="p">((</span><span class="n">coeff</span><span class="p">[:,</span><span class="n">i</span><span class="p">]</span><span class="o">-</span><span class="n">coeff</span><span class="p">[:,</span><span class="n">result</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">]])</span><span class="o">*</span><span class="n">grad_map</span><span class="p">[</span><span class="n">result</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">],:,</span><span class="mi">1</span><span class="p">])</span>

    <span class="n">err_out</span> <span class="o">=</span> <span class="mi">100</span><span class="o">*</span><span class="n">norm</span><span class="p">(</span><span class="n">ell_est</span><span class="o">-</span><span class="n">ell_map</span><span class="p">[:,</span><span class="mi">0</span><span class="p">,:],</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="n">norm</span><span class="p">(</span><span class="n">ell_map</span><span class="p">[:,</span><span class="mi">0</span><span class="p">,:],</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">ell_est</span><span class="p">,</span><span class="n">err_out</span>


<span class="k">def</span> <span class="nf">ellt_zeros</span><span class="p">(</span><span class="n">im</span><span class="p">,</span><span class="n">u</span><span class="p">):</span>
    <span class="n">mat_proj</span><span class="p">,</span><span class="n">normv</span> <span class="o">=</span> <span class="n">proj_mat</span><span class="p">(</span><span class="n">im</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">Uu</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="mi">6</span><span class="p">,))</span>
    <span class="n">Ug</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="mi">6</span><span class="p">,))</span>
    <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">6</span><span class="p">):</span>
        <span class="n">Uu</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">im</span><span class="o">*</span><span class="n">mat_proj</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">])</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="n">Ug</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u</span><span class="o">*</span><span class="n">mat_proj</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">])</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    <span class="n">a1</span> <span class="o">=</span> <span class="n">Ug</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">*</span><span class="n">Ug</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">-</span><span class="n">Ug</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="n">Ug</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span>
    <span class="n">a2</span> <span class="o">=</span> <span class="n">Uu</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">*</span><span class="n">Ug</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">+</span><span class="n">Uu</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="n">Ug</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">Ug</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">Uu</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="mi">2</span><span class="o">*</span><span class="n">Ug</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">Uu</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">a3</span> <span class="o">=</span> <span class="n">Uu</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">*</span><span class="n">Uu</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">-</span><span class="n">Uu</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="n">Uu</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span>

    <span class="n">b1</span> <span class="o">=</span> <span class="n">Ug</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">*</span><span class="n">Ug</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">-</span><span class="n">Ug</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="o">-</span><span class="n">Ug</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span>
    <span class="n">b2</span> <span class="o">=</span> <span class="n">Uu</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">*</span><span class="n">Ug</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">+</span><span class="n">Uu</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="n">Ug</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">Ug</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">Uu</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">Ug</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">Uu</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">b3</span> <span class="o">=</span> <span class="n">Uu</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">*</span><span class="n">Uu</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">-</span><span class="n">Uu</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="o">-</span><span class="n">Uu</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span>

    <span class="n">d1</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="n">Ug</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span><span class="o">*</span><span class="n">Ug</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">-</span><span class="n">Ug</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">Ug</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">d2</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="n">Uu</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span><span class="o">*</span><span class="n">Ug</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">+</span><span class="n">Uu</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="n">Ug</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span><span class="o">-</span><span class="n">Uu</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">Ug</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">Uu</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">Ug</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">d3</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="n">Uu</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span><span class="o">*</span><span class="n">Uu</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">-</span><span class="n">Uu</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">Uu</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

    <span class="n">A</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="mi">3</span><span class="p">,))</span>
    <span class="n">A</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">a3</span>
    <span class="n">A</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">a2</span>
    <span class="n">A</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">a1</span>

    <span class="n">B</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="mi">3</span><span class="p">,))</span>
    <span class="n">B</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">b3</span>
    <span class="n">B</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">b2</span>
    <span class="n">B</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">b1</span>

    <span class="n">A1</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="mi">3</span><span class="p">,))</span>
    <span class="n">A1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">a3</span><span class="o">*</span><span class="n">b2</span> <span class="o">-</span> <span class="n">a2</span><span class="o">*</span><span class="n">b3</span>
    <span class="n">A1</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="n">b1</span><span class="o">*</span><span class="n">a3</span><span class="o">-</span><span class="n">b3</span><span class="o">*</span><span class="n">a1</span><span class="p">)</span>
    <span class="n">A1</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">a2</span><span class="o">*</span><span class="n">b1</span><span class="o">-</span><span class="n">a1</span><span class="o">*</span><span class="n">b2</span>

    <span class="n">B1</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="mi">3</span><span class="p">,))</span>
    <span class="n">B1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">d3</span><span class="o">*</span><span class="n">b2</span> <span class="o">-</span> <span class="n">d2</span><span class="o">*</span><span class="n">b3</span>
    <span class="n">B1</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="n">b1</span><span class="o">*</span><span class="n">d3</span><span class="o">-</span><span class="n">b3</span><span class="o">*</span><span class="n">d1</span><span class="p">)</span>
    <span class="n">B1</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">d2</span><span class="o">*</span><span class="n">b1</span><span class="o">-</span><span class="n">d1</span><span class="o">*</span><span class="n">b2</span>

    <span class="n">root_ell1</span><span class="o">=</span><span class="n">roots</span><span class="p">(</span><span class="n">A</span><span class="p">)</span>
    <span class="n">root_ell2</span><span class="o">=</span><span class="n">roots</span><span class="p">(</span><span class="n">B</span><span class="p">)</span>
    <span class="n">root_ell3</span><span class="o">=</span><span class="n">roots</span><span class="p">(</span><span class="n">A1</span><span class="p">)</span>
    <span class="n">root_ell4</span><span class="o">=</span><span class="n">roots</span><span class="p">(</span><span class="n">B1</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">root_ell1</span><span class="p">,</span><span class="n">root_ell2</span><span class="p">,</span><span class="n">root_ell3</span><span class="p">,</span><span class="n">root_ell4</span>


<span class="k">def</span> <span class="nf">check_grad_ellipticity</span><span class="p">(</span><span class="n">im</span><span class="p">,</span><span class="n">h_max</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span><span class="n">nb_points</span><span class="o">=</span><span class="mi">100</span><span class="p">):</span>
    <span class="kn">from</span> <span class="nn">numpy.random</span> <span class="k">import</span> <span class="n">randn</span>
    <span class="n">shap</span> <span class="o">=</span> <span class="n">im</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">t</span> <span class="o">=</span> <span class="n">randn</span><span class="p">(</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">t</span> <span class="o">=</span> <span class="n">t</span><span class="o">/</span><span class="n">sqrt</span><span class="p">((</span><span class="n">t</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span>
    <span class="n">a</span> <span class="o">=</span> <span class="n">array</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">nb_points</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span><span class="o">*</span><span class="n">sqrt</span><span class="p">((</span><span class="n">im</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span><span class="o">*</span><span class="n">h_max</span><span class="o">/</span><span class="n">nb_points</span>
    <span class="n">i</span><span class="o">=</span><span class="mi">0</span>
    <span class="n">ell_err</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span><span class="n">nb_points</span><span class="p">))</span>
    <span class="n">grad_proj</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span><span class="n">nb_points</span><span class="p">))</span>
    <span class="n">centroid</span><span class="p">,</span><span class="n">U</span><span class="p">,</span><span class="n">ell_ref</span> <span class="o">=</span> <span class="n">mk_ellipticity_atoms</span><span class="p">(</span><span class="n">im</span><span class="p">)</span>
    <span class="n">grad1</span><span class="p">,</span><span class="n">grad2</span> <span class="o">=</span> <span class="n">ellipticity_grad</span><span class="p">(</span><span class="n">im</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_points</span><span class="p">):</span>
        <span class="n">im_i</span> <span class="o">=</span> <span class="n">im</span> <span class="o">+</span> <span class="n">a</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">*</span><span class="n">t</span>
        <span class="n">centroid</span><span class="p">,</span><span class="n">U</span><span class="p">,</span><span class="n">elli</span> <span class="o">=</span> <span class="n">mk_ellipticity_atoms</span><span class="p">(</span><span class="n">im_i</span><span class="p">)</span>
        <span class="n">ell_err</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">elli</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">ell_ref</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">ell_err</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">elli</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">ell_ref</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">grad_proj</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">((</span><span class="n">grad1</span><span class="o">*</span><span class="p">(</span><span class="n">im_i</span><span class="o">-</span><span class="n">im</span><span class="p">))</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span>
        <span class="n">grad_proj</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">((</span><span class="n">grad2</span><span class="o">*</span><span class="p">(</span><span class="n">im_i</span><span class="o">-</span><span class="n">im</span><span class="p">))</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span>

    <span class="k">return</span> <span class="n">ell_err</span><span class="p">,</span><span class="n">grad_proj</span>

<span class="k">def</span> <span class="nf">nul_ell_proj</span><span class="p">(</span><span class="n">im</span><span class="p">,</span><span class="n">mean_sub</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="n">mat_proj</span><span class="p">,</span><span class="n">normv</span> <span class="o">=</span> <span class="n">proj_mat</span><span class="p">(</span><span class="n">im</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">shap</span> <span class="o">=</span> <span class="n">im</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">mat_proj1</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="mi">2</span><span class="p">))</span>
    <span class="n">mat_proj2</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="mi">3</span><span class="p">))</span>
    <span class="n">mat_proj3</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="mi">4</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">mean_sub</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">mat_proj1</span><span class="p">[:,:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">mat_proj</span><span class="p">[:,:,</span><span class="mi">2</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">mat_proj1</span><span class="p">[:,:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">mat_proj</span><span class="p">[:,:,</span><span class="mi">4</span><span class="p">]</span>
    <span class="n">mat_proj1</span><span class="p">[:,:,</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">mat_proj</span><span class="p">[:,:,</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">mat_proj</span><span class="p">[:,:,</span><span class="mi">1</span><span class="p">]</span>

    <span class="n">mat_proj2</span><span class="p">[:,:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">mat_proj</span><span class="p">[:,:,</span><span class="mi">5</span><span class="p">]</span>
    <span class="n">mat_proj2</span><span class="p">[:,:,</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">mat_proj</span><span class="p">[:,:,</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">mat_proj2</span><span class="p">[:,:,</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">mat_proj</span><span class="p">[:,:,</span><span class="mi">1</span><span class="p">]</span>

    <span class="n">mat_proj3</span><span class="p">[:,:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">mat_proj</span><span class="p">[:,:,</span><span class="mi">5</span><span class="p">]</span>
    <span class="n">mat_proj3</span><span class="p">[:,:,</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">mat_proj</span><span class="p">[:,:,</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">mat_proj3</span><span class="p">[:,:,</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">mat_proj</span><span class="p">[:,:,</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">mat_proj3</span><span class="p">[:,:,</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">mat_proj</span><span class="p">[:,:,</span><span class="mi">4</span><span class="p">]</span>

    <span class="n">proj1</span> <span class="o">=</span> <span class="n">im</span><span class="o">-</span><span class="n">proj_cube</span><span class="p">(</span><span class="n">im</span><span class="p">,</span><span class="n">mat_proj1</span><span class="p">,</span><span class="n">ortho</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">proj2</span> <span class="o">=</span> <span class="n">im</span><span class="o">-</span><span class="n">proj_cube</span><span class="p">(</span><span class="n">im</span><span class="p">,</span><span class="n">mat_proj2</span><span class="p">,</span><span class="n">ortho</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">proj3</span> <span class="o">=</span> <span class="n">im</span><span class="o">-</span><span class="n">proj_cube</span><span class="p">(</span><span class="n">im</span><span class="p">,</span><span class="n">mat_proj3</span><span class="p">,</span><span class="n">ortho</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="n">centroid</span><span class="p">,</span><span class="n">U</span><span class="p">,</span><span class="n">ell1</span> <span class="o">=</span> <span class="n">mk_ellipticity_atoms</span><span class="p">(</span><span class="n">proj1</span><span class="p">)</span>
    <span class="n">centroid</span><span class="p">,</span><span class="n">U</span><span class="p">,</span><span class="n">ell2</span> <span class="o">=</span> <span class="n">mk_ellipticity_atoms</span><span class="p">(</span><span class="n">proj2</span><span class="p">)</span>
    <span class="n">centroid</span><span class="p">,</span><span class="n">U</span><span class="p">,</span><span class="n">ell3</span> <span class="o">=</span> <span class="n">mk_ellipticity_atoms</span><span class="p">(</span><span class="n">proj3</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">proj1</span><span class="p">,</span><span class="n">proj2</span><span class="p">,</span><span class="n">proj3</span><span class="p">,</span><span class="n">ell1</span><span class="p">,</span><span class="n">ell2</span><span class="p">,</span><span class="n">ell3</span>




<span class="k">def</span> <span class="nf">mk_ellipticity_atoms_basic_arr</span><span class="p">(</span><span class="n">U</span><span class="p">):</span>
    <span class="n">shap</span> <span class="o">=</span> <span class="n">U</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">ell_arr</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="mi">2</span><span class="p">))</span>
    <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
        <span class="n">ell_i</span> <span class="o">=</span> <span class="n">mk_ellipticity_atoms_basic</span><span class="p">(</span><span class="n">U</span><span class="p">[</span><span class="n">i</span><span class="p">,:])</span>
        <span class="n">ell_arr</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">ell_i</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">ell_arr</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">ell_i</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">ell_arr</span>

<span class="k">def</span> <span class="nf">mat_mm_ell</span><span class="p">(</span><span class="n">im</span><span class="p">,</span><span class="n">offset</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">sigw</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">path</span><span class="o">=</span><span class="s1">&#39;../../&#39;</span><span class="p">):</span>
    <span class="kn">import</span> <span class="nn">scipy.signal</span> <span class="k">as</span> <span class="nn">scisig</span>
    <span class="k">if</span> <span class="n">sigw</span> <span class="o">!=</span><span class="mi">0</span> <span class="p">:</span>
        <span class="n">centroid</span><span class="p">,</span><span class="n">Wc</span> <span class="o">=</span> <span class="n">compute_centroid</span><span class="p">(</span><span class="n">im</span><span class="p">,</span><span class="n">sigw</span><span class="p">)</span>
        <span class="n">im</span> <span class="o">=</span> <span class="n">im</span><span class="o">*</span><span class="n">Wc</span>
    <span class="n">mat_proj</span><span class="p">,</span><span class="n">normv</span> <span class="o">=</span> <span class="n">proj_mat</span><span class="p">(</span><span class="n">im</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span><span class="n">offset</span><span class="p">)</span>
    <span class="n">mat_ell</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="mi">6</span><span class="p">,</span><span class="n">im</span><span class="o">.</span><span class="n">size</span><span class="p">))</span>
    <span class="n">i</span><span class="o">=</span><span class="mi">0</span>
    <span class="n">Li</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">im</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">6</span><span class="p">):</span>
        <span class="n">Ui</span> <span class="o">=</span> <span class="n">mat_proj</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">]</span>
        <span class="c1">#Li = scisig.correlate(im,Ui,mode=&#39;same&#39;)</span>
        <span class="n">Li</span> <span class="o">=</span> <span class="n">correl_c</span><span class="p">(</span><span class="n">im</span><span class="p">,</span><span class="n">Ui</span><span class="p">,</span><span class="n">path</span><span class="o">=</span><span class="n">path</span><span class="p">)</span>
        <span class="n">mat_ell</span><span class="p">[</span><span class="n">i</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">Li</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">im</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">im</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">mat_ell</span>

<span class="k">def</span> <span class="nf">corr_coeff</span><span class="p">(</span><span class="n">im1</span><span class="p">,</span><span class="n">im2</span><span class="p">):</span>
    <span class="n">corr</span> <span class="o">=</span> <span class="n">scisig</span><span class="o">.</span><span class="n">correlate</span><span class="p">(</span><span class="n">im1</span><span class="p">,</span><span class="n">im2</span><span class="p">,</span><span class="n">mode</span><span class="o">=</span><span class="s1">&#39;same&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">/</span><span class="p">(</span><span class="n">sqrt</span><span class="p">((</span><span class="n">im1</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span><span class="o">*</span><span class="n">sqrt</span><span class="p">((</span><span class="n">im2</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()))</span>
    <span class="k">return</span> <span class="n">corr</span>

<span class="k">def</span> <span class="nf">stack_corr_coeff</span><span class="p">(</span><span class="n">cube_1</span><span class="p">,</span><span class="n">cube_2</span><span class="p">):</span>
    <span class="n">nb_im</span> <span class="o">=</span> <span class="n">cube_1</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">corr_out</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">nb_im</span><span class="p">,))</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_im</span><span class="p">):</span>
        <span class="n">corr_out</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">corr_coeff</span><span class="p">(</span><span class="n">cube_1</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">],</span><span class="n">cube_2</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">corr_out</span>

<span class="k">def</span> <span class="nf">stack_corr_coeff_m</span><span class="p">(</span><span class="n">cube_1m</span><span class="p">,</span><span class="n">cube_2</span><span class="p">):</span>
    <span class="n">nb_eval</span> <span class="o">=</span> <span class="n">cube_1m</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
    <span class="n">mean_corr</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">nb_eval</span><span class="p">,))</span>
    <span class="n">std_corr</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">nb_eval</span><span class="p">,))</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_eval</span><span class="p">):</span>
        <span class="n">corr</span> <span class="o">=</span> <span class="n">stack_corr_coeff</span><span class="p">(</span><span class="n">cube_1m</span><span class="p">[:,:,:,</span><span class="n">i</span><span class="p">],</span><span class="n">cube_2</span><span class="p">)</span>
        <span class="n">mean_corr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">corr</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="n">std_corr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">corr</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">mean_corr</span><span class="p">,</span><span class="n">std_corr</span>

<span class="k">def</span> <span class="nf">transpose_mat_ell</span><span class="p">(</span><span class="n">mat_in</span><span class="p">,</span><span class="n">shap</span><span class="p">,</span><span class="n">offset</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">sigw</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">path</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">):</span>
    <span class="kn">import</span> <span class="nn">scipy.signal</span> <span class="k">as</span> <span class="nn">scisig</span>
    <span class="n">mat_proj</span><span class="p">,</span><span class="n">normv</span> <span class="o">=</span> <span class="n">proj_mat</span><span class="p">(</span><span class="n">shap</span><span class="p">,</span><span class="n">offset</span><span class="p">)</span>
    <span class="n">im</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
    <span class="n">i</span><span class="o">=</span><span class="mi">0</span>
    <span class="n">imi</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">im</span><span class="p">)</span>
    <span class="n">Ui</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">im</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">6</span><span class="p">):</span>
        <span class="n">mat_proj_i</span> <span class="o">=</span> <span class="n">mat_proj</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">]</span>
        <span class="n">Ui</span> <span class="o">=</span> <span class="n">rot180</span><span class="p">(</span><span class="n">mat_proj_i</span><span class="p">)</span>
        <span class="c1">#Li = scisig.correlate(im,Ui,mode=&#39;same&#39;)</span>
        <span class="n">imi</span> <span class="o">=</span> <span class="n">mat_in</span><span class="p">[</span><span class="n">i</span><span class="p">,:]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">Li</span> <span class="o">=</span> <span class="n">correl_c</span><span class="p">(</span><span class="n">imi</span><span class="p">,</span><span class="n">Ui</span><span class="p">,</span><span class="n">path</span><span class="o">=</span><span class="n">path</span><span class="p">)</span>
        <span class="n">im</span> <span class="o">=</span> <span class="n">im</span> <span class="o">+</span> <span class="n">Li</span>
    <span class="k">return</span> <span class="n">im</span>

<span class="k">def</span> <span class="nf">cube_mean_norm</span><span class="p">(</span><span class="n">X</span><span class="p">):</span>
    <span class="n">shap</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">out</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">],))</span>
    <span class="n">norm_out</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>
    <span class="n">bias_out</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">],))</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
        <span class="n">norm_out</span><span class="p">[:,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">sqrt</span><span class="p">((</span><span class="n">X</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
        <span class="n">out</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">mean</span><span class="p">(</span><span class="n">norm_out</span><span class="p">[:,</span><span class="n">i</span><span class="p">])</span>
        <span class="n">bias_out</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">sqrt</span><span class="p">((</span><span class="n">X</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">out</span><span class="p">,</span><span class="n">norm_out</span><span class="p">,</span><span class="n">bias_out</span>




<span class="k">def</span> <span class="nf">cube_mm_ell</span><span class="p">(</span><span class="n">im</span><span class="p">,</span><span class="n">offset</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">sigw</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">path</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">):</span>
    <span class="kn">import</span> <span class="nn">scipy.signal</span> <span class="k">as</span> <span class="nn">scisig</span>
    <span class="k">if</span> <span class="n">sigw</span> <span class="o">!=</span><span class="mi">0</span> <span class="p">:</span>
        <span class="n">centroid</span><span class="p">,</span><span class="n">Wc</span> <span class="o">=</span> <span class="n">compute_centroid</span><span class="p">(</span><span class="n">im</span><span class="p">,</span><span class="n">sigw</span><span class="p">)</span>
        <span class="n">im</span> <span class="o">=</span> <span class="n">im</span><span class="o">*</span><span class="n">Wc</span>
    <span class="n">mat_proj</span><span class="p">,</span><span class="n">normv</span> <span class="o">=</span> <span class="n">proj_mat</span><span class="p">(</span><span class="n">im</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span><span class="n">offset</span><span class="p">)</span>
    <span class="n">cube_ell</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">im</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">im</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="mi">6</span><span class="p">))</span>
    <span class="n">i</span><span class="o">=</span><span class="mi">0</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">6</span><span class="p">):</span>
        <span class="n">Ui</span> <span class="o">=</span> <span class="n">mat_proj</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">]</span>
        <span class="c1">#Li = scisig.correlate(im,Ui,mode=&#39;same&#39;)</span>
        <span class="n">cube_ell</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">correl_c</span><span class="p">(</span><span class="n">im</span><span class="p">,</span><span class="n">Ui</span><span class="p">,</span><span class="n">path</span><span class="o">=</span><span class="n">path</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">cube_ell</span>

<span class="k">def</span> <span class="nf">mat_mm_ell_fft</span><span class="p">(</span><span class="n">im</span><span class="p">,</span><span class="n">offset</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">sigw</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">sigw</span> <span class="o">!=</span><span class="mi">0</span> <span class="p">:</span>
        <span class="n">centroid</span><span class="p">,</span><span class="n">Wc</span> <span class="o">=</span> <span class="n">compute_centroid</span><span class="p">(</span><span class="n">im</span><span class="p">,</span><span class="n">sigw</span><span class="p">)</span>
        <span class="n">im</span> <span class="o">=</span> <span class="n">im</span><span class="o">*</span><span class="n">Wc</span>
    <span class="n">mat_proj</span><span class="p">,</span><span class="n">normv</span> <span class="o">=</span> <span class="n">proj_mat</span><span class="p">(</span><span class="n">im</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span><span class="n">offset</span><span class="p">)</span>
    <span class="n">mat_ell</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="mi">6</span><span class="p">,</span><span class="n">im</span><span class="o">.</span><span class="n">size</span><span class="p">))</span>
    <span class="n">siz</span><span class="o">=</span><span class="n">im</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">padd_width</span> <span class="o">=</span> <span class="n">siz</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="mi">0</span>
    <span class="n">im_padd</span> <span class="o">=</span> <span class="n">padding</span><span class="p">(</span><span class="n">im</span><span class="p">,</span><span class="n">padd_width</span><span class="p">)</span>
    <span class="n">i</span><span class="o">=</span><span class="mi">0</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">6</span><span class="p">):</span>
        <span class="n">Ui</span> <span class="o">=</span> <span class="n">mat_proj</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">]</span>
        <span class="n">Ui_padd</span> <span class="o">=</span> <span class="n">padding</span><span class="p">(</span><span class="n">Ui</span><span class="p">,</span><span class="n">padd_width</span><span class="p">)</span>
        <span class="n">Li_padd</span> <span class="o">=</span> <span class="n">scisig</span><span class="o">.</span><span class="n">fftconvolve</span><span class="p">(</span><span class="n">im_padd</span><span class="p">,</span><span class="n">Ui_padd</span><span class="p">,</span><span class="n">mode</span><span class="o">=</span><span class="s1">&#39;same&#39;</span><span class="p">)</span>
        <span class="n">Li</span> <span class="o">=</span> <span class="n">Li_padd</span><span class="p">[</span><span class="n">padd_width</span><span class="p">:</span><span class="n">siz</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">padd_width</span><span class="p">,</span><span class="n">padd_width</span><span class="p">:</span><span class="n">siz</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">padd_width</span><span class="p">]</span>
        <span class="n">mat_ell</span><span class="p">[</span><span class="n">i</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">Li</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">im</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">im</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">mat_ell</span>

<span class="k">def</span> <span class="nf">padding</span><span class="p">(</span><span class="n">im</span><span class="p">,</span><span class="n">padding_width</span><span class="p">,</span><span class="n">val</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>

    <span class="n">siz</span> <span class="o">=</span> <span class="n">im</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">im_out</span> <span class="o">=</span> <span class="n">ones</span><span class="p">((</span><span class="n">siz</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="mi">2</span><span class="o">*</span><span class="n">padding_width</span><span class="p">,</span><span class="n">siz</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="mi">2</span><span class="o">*</span><span class="n">padding_width</span><span class="p">))</span><span class="o">*</span><span class="n">val</span>
    <span class="n">im_out</span><span class="p">[</span><span class="n">padding_width</span><span class="p">:</span><span class="n">siz</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">padding_width</span><span class="p">,</span><span class="n">padding_width</span><span class="p">:</span><span class="n">siz</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">padding_width</span><span class="p">]</span><span class="o">=</span><span class="n">im</span>
    <span class="k">return</span> <span class="n">im_out</span>

<span class="k">def</span> <span class="nf">fista_ell</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">h</span><span class="p">,</span><span class="n">mu</span><span class="p">,</span><span class="n">mat_init</span><span class="p">,</span><span class="n">mat_cor</span><span class="p">,</span><span class="n">thresh</span><span class="p">,</span><span class="n">thresh_type</span><span class="p">,</span><span class="n">im_size</span><span class="p">,</span><span class="n">gradx_ker</span><span class="p">,</span><span class="n">grady_ker</span><span class="p">,</span><span class="n">lambda_grad</span><span class="p">,</span><span class="n">nb_iter</span><span class="o">=</span><span class="mi">200</span><span class="p">):</span> <span class="c1"># The code assumes columns vectors</span>
    <span class="n">U</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">mat_init</span><span class="p">)</span>
    <span class="n">n1</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">n2</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">h</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">vect</span> <span class="o">=</span> <span class="n">ones</span><span class="p">((</span><span class="n">n2</span><span class="p">,))</span>
    <span class="n">mse</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">nb_iter</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>
    <span class="n">mat</span><span class="p">,</span><span class="n">normv</span> <span class="o">=</span> <span class="n">proj_mat</span><span class="p">(</span><span class="n">im_size</span><span class="p">)</span>
    <span class="n">invmat_cor</span> <span class="o">=</span> <span class="n">inv</span><span class="p">(</span><span class="n">mat_cor</span><span class="p">)</span>
    <span class="n">w</span><span class="p">,</span><span class="n">v</span> <span class="o">=</span> <span class="n">eigh</span><span class="p">(</span><span class="n">invmat_cor</span><span class="p">)</span>
    <span class="n">V</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">n1</span><span class="p">,</span><span class="n">n2</span><span class="p">))</span>
    <span class="n">V_old</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">V</span><span class="p">)</span>
    <span class="c1">#lip = h.sum()*abs(w).max()+((abs(gradx_ker).sum())**2+(abs(grady_ker).sum())**2)*lambda_grad</span>
    <span class="n">lip</span> <span class="o">=</span> <span class="n">h</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">*</span><span class="nb">abs</span><span class="p">(</span><span class="n">w</span><span class="p">)</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
    <span class="c1">#print lip,(h**2).sum(),(abs(gradx_ker).sum())**2,(abs(grady_ker).sum())**2,lambda_grad*max((normv[3]/normv)**2)</span>
    <span class="n">t</span><span class="o">=</span><span class="mi">1</span>
    <span class="n">told</span><span class="o">=</span><span class="n">t</span>
    <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">s</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span><span class="mi">6</span><span class="p">))</span>

    <span class="n">tikhx_mat</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="mi">6</span><span class="p">,</span><span class="n">im_size</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">im_size</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
    <span class="n">tikhy_mat</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="mi">6</span><span class="p">,</span><span class="n">im_size</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">im_size</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_iter</span><span class="p">):</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">x</span> <span class="o">-</span> <span class="n">U</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">h</span><span class="p">)</span>
        <span class="n">mse</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">**</span><span class="mi">2</span>

        <span class="c1">#svecl, s, svecr = linalg.svd(Yi,full_matrices=False)</span>
        <span class="c1">#s_thresh = thresholding(s,thresh,thresh_type) # Low rank reg</span>
        <span class="c1">#V = svecl.dot(diag(s_thresh).dot(svecr))</span>
        <span class="n">k</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">6</span><span class="p">):</span>
            <span class="n">compvk</span> <span class="o">=</span> <span class="n">U</span><span class="p">[</span><span class="n">k</span><span class="p">,:]</span>
            <span class="n">compk</span> <span class="o">=</span> <span class="n">compvk</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">im_size</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">im_size</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">gradx</span><span class="p">,</span><span class="n">grady</span> <span class="o">=</span> <span class="n">grad2d</span><span class="p">(</span><span class="n">compk</span><span class="p">,</span><span class="n">gradx_ker</span><span class="p">,</span><span class="n">grady_ker</span><span class="p">)</span>
            <span class="n">tgradx</span><span class="p">,</span><span class="n">tgrady</span> <span class="o">=</span> <span class="n">transp_grad2d</span><span class="p">(</span><span class="n">gradx</span><span class="p">,</span><span class="n">grady</span><span class="p">,</span><span class="n">gradx_ker</span><span class="p">,</span><span class="n">grady_ker</span><span class="p">)</span>
            <span class="n">tikhx_mat</span><span class="p">[</span><span class="n">k</span><span class="p">,:]</span> <span class="o">=</span> <span class="p">(</span><span class="n">tgradx</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">im_size</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">im_size</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
            <span class="n">tikhy_mat</span><span class="p">[</span><span class="n">k</span><span class="p">,:]</span> <span class="o">=</span> <span class="p">(</span><span class="n">tgrady</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">im_size</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">im_size</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>

        <span class="c1">#V = U + (mu/lip)*(npma.outer(res,h) - lambda_grad*(tikhx_mat+tikhy_mat)) # Tikhonov reg</span>
        <span class="n">V</span> <span class="o">=</span> <span class="n">U</span> <span class="o">+</span> <span class="p">(</span><span class="n">mu</span><span class="o">/</span><span class="n">lip</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">npma</span><span class="o">.</span><span class="n">outer</span><span class="p">(</span><span class="n">invmat_cor</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">res</span><span class="p">),</span><span class="n">vect</span><span class="p">))</span>
        <span class="n">t</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">4</span><span class="o">*</span><span class="n">told</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span><span class="o">/</span><span class="mi">2</span>
        <span class="n">lamb</span> <span class="o">=</span> <span class="mi">1</span><span class="o">+</span><span class="p">(</span><span class="n">told</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="n">t</span>
        <span class="n">told</span> <span class="o">=</span> <span class="n">t</span>
        <span class="n">U</span> <span class="o">=</span> <span class="n">V_old</span> <span class="o">+</span> <span class="n">lamb</span><span class="o">*</span><span class="p">(</span><span class="n">V</span><span class="o">-</span><span class="n">V_old</span><span class="p">)</span>
        <span class="n">V_old</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">V</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">mse</span><span class="p">,</span><span class="n">s</span><span class="p">,</span><span class="n">U</span>


<span class="k">def</span> <span class="nf">fista_ell_2</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">h</span><span class="p">,</span><span class="n">mu</span><span class="p">,</span><span class="n">mat_init</span><span class="p">,</span><span class="n">mat_cor</span><span class="p">,</span><span class="n">thresh</span><span class="p">,</span><span class="n">thresh_type</span><span class="p">,</span><span class="n">im_size</span><span class="p">,</span><span class="n">gradx_ker</span><span class="p">,</span><span class="n">grady_ker</span><span class="p">,</span><span class="n">lambda_grad</span><span class="p">,</span><span class="n">nb_iter</span><span class="o">=</span><span class="mi">200</span><span class="p">):</span> <span class="c1"># The code assumes columns vectors; the optimization variable is incov*M</span>

    <span class="n">n1</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">n2</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">h</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">vect</span> <span class="o">=</span> <span class="n">ones</span><span class="p">((</span><span class="n">n2</span><span class="p">,))</span>
    <span class="n">mse</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">nb_iter</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>
    <span class="n">mat</span><span class="p">,</span><span class="n">normv</span> <span class="o">=</span> <span class="n">proj_mat</span><span class="p">(</span><span class="n">im_size</span><span class="p">)</span>
    <span class="n">invmat_cor</span> <span class="o">=</span> <span class="n">inv</span><span class="p">(</span><span class="n">mat_cor</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">invmat_cor</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">U</span> <span class="o">=</span> <span class="n">invmat_cor</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">mat_init</span><span class="p">)</span>
    <span class="n">w</span><span class="p">,</span><span class="n">v</span> <span class="o">=</span> <span class="n">eigh</span><span class="p">(</span><span class="n">invmat_cor</span><span class="p">)</span>
    <span class="n">w2</span><span class="p">,</span><span class="n">v</span> <span class="o">=</span> <span class="n">eigh</span><span class="p">(</span><span class="n">mat_cor</span><span class="p">)</span>
    <span class="n">V</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">n1</span><span class="p">,</span><span class="n">n2</span><span class="p">))</span>
    <span class="n">V_old</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">V</span><span class="p">)</span>
    <span class="n">lip</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="n">h</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">+</span><span class="p">((</span><span class="nb">abs</span><span class="p">(</span><span class="n">gradx_ker</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">grady_ker</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">lambda_grad</span><span class="o">*</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">w2</span><span class="p">)</span><span class="o">.</span><span class="n">max</span><span class="p">())</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
    <span class="c1">#lip = h.sum()</span>
    <span class="c1">#print lip,(h**2).sum(),(abs(gradx_ker).sum())**2,(abs(grady_ker).sum())**2,lambda_grad*max((normv[3]/normv)**2)</span>
    <span class="n">t</span><span class="o">=</span><span class="mi">1</span>
    <span class="n">told</span><span class="o">=</span><span class="n">t</span>
    <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">s</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span><span class="mi">6</span><span class="p">))</span>

    <span class="n">tikhx_mat</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="mi">6</span><span class="p">,</span><span class="n">im_size</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">im_size</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
    <span class="n">tikhy_mat</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="mi">6</span><span class="p">,</span><span class="n">im_size</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">im_size</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_iter</span><span class="p">):</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">x</span> <span class="o">-</span> <span class="n">U</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">h</span><span class="p">)</span>
        <span class="n">mse</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">**</span><span class="mi">2</span>

        <span class="c1">#svecl, s, svecr = linalg.svd(Yi,full_matrices=False)</span>
        <span class="c1">#s_thresh = thresholding(s,thresh,thresh_type) # Low rank reg</span>
        <span class="c1">#V = svecl.dot(diag(s_thresh).dot(svecr))</span>
        <span class="n">k</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">6</span><span class="p">):</span>
            <span class="n">compvk</span> <span class="o">=</span> <span class="n">U</span><span class="p">[</span><span class="n">k</span><span class="p">,:]</span>
            <span class="n">compk</span> <span class="o">=</span> <span class="n">compvk</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">im_size</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">im_size</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">gradx</span><span class="p">,</span><span class="n">grady</span> <span class="o">=</span> <span class="n">grad2d</span><span class="p">(</span><span class="n">compk</span><span class="p">,</span><span class="n">gradx_ker</span><span class="p">,</span><span class="n">grady_ker</span><span class="p">)</span>
            <span class="n">tgradx</span><span class="p">,</span><span class="n">tgrady</span> <span class="o">=</span> <span class="n">transp_grad2d</span><span class="p">(</span><span class="n">gradx</span><span class="p">,</span><span class="n">grady</span><span class="p">,</span><span class="n">gradx_ker</span><span class="p">,</span><span class="n">grady_ker</span><span class="p">)</span>
            <span class="n">tikhx_mat</span><span class="p">[</span><span class="n">k</span><span class="p">,:]</span> <span class="o">=</span> <span class="p">(</span><span class="n">tgradx</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">im_size</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">im_size</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
            <span class="n">tikhy_mat</span><span class="p">[</span><span class="n">k</span><span class="p">,:]</span> <span class="o">=</span> <span class="p">(</span><span class="n">tgrady</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">im_size</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">im_size</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
        <span class="n">tikhx_mat</span> <span class="o">=</span> <span class="n">mat_cor</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">mat_cor</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">tikhx_mat</span><span class="p">))</span>
        <span class="n">tikhy_mat</span> <span class="o">=</span> <span class="n">mat_cor</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">mat_cor</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">tikhy_mat</span><span class="p">))</span>
        <span class="n">V</span> <span class="o">=</span> <span class="n">U</span> <span class="o">+</span> <span class="p">(</span><span class="n">mu</span><span class="o">/</span><span class="n">lip</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">npma</span><span class="o">.</span><span class="n">outer</span><span class="p">(</span><span class="n">res</span><span class="p">,</span><span class="n">vect</span><span class="p">)</span> <span class="o">-</span> <span class="n">lambda_grad</span><span class="o">*</span><span class="p">(</span><span class="n">tikhx_mat</span><span class="o">+</span><span class="n">tikhy_mat</span><span class="p">))</span> <span class="c1"># Tikhonov reg</span>
        <span class="c1">#V = U + (mu/lip)*(npma.outer(res,vect))</span>
        <span class="n">t</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">4</span><span class="o">*</span><span class="n">told</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span><span class="o">/</span><span class="mi">2</span>
        <span class="n">lamb</span> <span class="o">=</span> <span class="mi">1</span><span class="o">+</span><span class="p">(</span><span class="n">told</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="n">t</span>
        <span class="n">told</span> <span class="o">=</span> <span class="n">t</span>
        <span class="n">U</span> <span class="o">=</span> <span class="n">V_old</span> <span class="o">+</span> <span class="n">lamb</span><span class="o">*</span><span class="p">(</span><span class="n">V</span><span class="o">-</span><span class="n">V_old</span><span class="p">)</span>
        <span class="n">V_old</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">V</span><span class="p">)</span>
    <span class="n">U</span> <span class="o">=</span> <span class="n">mat_cor</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">U</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">mse</span><span class="p">,</span><span class="n">s</span><span class="p">,</span><span class="n">U</span>

<span class="k">def</span> <span class="nf">const_mat_gen</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">h</span><span class="p">,</span><span class="n">mat_cor</span><span class="p">,</span><span class="n">mat_dict</span><span class="p">):</span>

    <span class="n">invmat_cor</span> <span class="o">=</span> <span class="n">LA</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">mat_cor</span><span class="p">)</span>
    <span class="n">siz</span> <span class="o">=</span> <span class="n">mat_dict</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">i</span><span class="p">,</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span><span class="mi">0</span>
    <span class="n">Mhs</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">siz</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">siz</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>
    <span class="n">Mxs</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">siz</span><span class="p">[</span><span class="mi">2</span><span class="p">],))</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">siz</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
        <span class="n">Mi</span> <span class="o">=</span> <span class="n">mat_dict</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">]</span>
        <span class="n">ai</span> <span class="o">=</span> <span class="n">invmat_cor</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">Mi</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">h</span><span class="p">))</span>
        <span class="n">Mxs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">transpose</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">ai</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">siz</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
            <span class="n">Mj</span> <span class="o">=</span> <span class="n">mat_dict</span><span class="p">[:,:,</span><span class="n">j</span><span class="p">]</span>
            <span class="n">Mhs</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">transpose</span><span class="p">(</span><span class="n">h</span><span class="p">)</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">transpose</span><span class="p">(</span><span class="n">Mj</span><span class="p">)</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">ai</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">Mhs</span><span class="p">,</span><span class="n">Mxs</span>

<span class="k">def</span> <span class="nf">const_mat_gen_2</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">h</span><span class="p">,</span><span class="n">mat_cor</span><span class="p">,</span><span class="n">mat_dict</span><span class="p">,</span><span class="n">coeff_dict</span><span class="p">):</span>

    <span class="n">invmat_cor</span> <span class="o">=</span> <span class="n">LA</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">mat_cor</span><span class="p">)</span>
    <span class="n">siz</span> <span class="o">=</span> <span class="n">coeff_dict</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">i</span><span class="p">,</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span><span class="mi">0</span>
    <span class="n">Mhs</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">siz</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">siz</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
    <span class="n">Mxs</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">siz</span><span class="p">[</span><span class="mi">1</span><span class="p">],))</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">siz</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
        <span class="n">Mi</span> <span class="o">=</span> <span class="n">mat_dict</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">]</span>
        <span class="n">ai</span> <span class="o">=</span> <span class="n">invmat_cor</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">Mi</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">h</span><span class="p">))</span>
        <span class="n">li</span> <span class="o">=</span> <span class="n">array</span><span class="p">(</span><span class="n">coeff_dict</span><span class="p">[</span><span class="n">i</span><span class="p">,:])</span>
        <span class="n">Mxs</span> <span class="o">=</span> <span class="n">Mxs</span><span class="o">+</span><span class="n">transpose</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">ai</span><span class="p">)</span><span class="o">*</span><span class="n">transpose</span><span class="p">(</span><span class="n">li</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">siz</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
            <span class="n">Mj</span> <span class="o">=</span> <span class="n">mat_dict</span><span class="p">[:,:,</span><span class="n">j</span><span class="p">]</span>
            <span class="n">lj</span> <span class="o">=</span> <span class="n">array</span><span class="p">(</span><span class="n">coeff_dict</span><span class="p">[</span><span class="n">j</span><span class="p">,:])</span>
            <span class="n">Mhs</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">transpose</span><span class="p">(</span><span class="n">h</span><span class="p">)</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">transpose</span><span class="p">(</span><span class="n">Mj</span><span class="p">)</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">ai</span><span class="p">))</span><span class="o">*</span><span class="p">(</span><span class="n">li</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">transpose</span><span class="p">(</span><span class="n">lj</span><span class="p">)))</span>
    <span class="k">return</span> <span class="n">Mhs</span><span class="p">,</span><span class="n">Mxs</span>

<span class="k">def</span> <span class="nf">fista_ell_3</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">h</span><span class="p">,</span><span class="n">mu</span><span class="p">,</span><span class="n">mat_cor</span><span class="p">,</span><span class="n">mat_dict</span><span class="p">,</span><span class="n">pca_eig_val</span><span class="p">,</span><span class="n">tol</span><span class="p">,</span><span class="n">nb_iter</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span><span class="n">mean_comp</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">xinit</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span> <span class="c1"># The code assumes columns vectors; synthesis scheme; a dictionary should be provided</span>

    <span class="n">mat_dict_in</span>  <span class="o">=</span><span class="kc">None</span>
    <span class="k">if</span> <span class="n">mean_comp</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">mean_mat</span> <span class="o">=</span> <span class="n">mat_dict</span><span class="p">[:,:,</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">xmean</span> <span class="o">=</span> <span class="n">mean_mat</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">h</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span><span class="n">x</span><span class="o">-</span><span class="n">xmean</span>
        <span class="n">mat_dict_in</span> <span class="o">=</span> <span class="n">mat_dict</span><span class="p">[:,:,</span><span class="mi">1</span><span class="p">:]</span>
    <span class="k">else</span><span class="p">:</span> <span class="n">mat_dict_in</span> <span class="o">=</span> <span class="n">mat_dict</span>
    <span class="n">Mhs</span><span class="p">,</span><span class="n">Mxs</span> <span class="o">=</span> <span class="n">const_mat_gen</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">h</span><span class="p">,</span><span class="n">mat_cor</span><span class="p">,</span><span class="n">mat_dict_in</span><span class="p">)</span>
    <span class="n">siz</span> <span class="o">=</span> <span class="n">mat_dict_in</span><span class="o">.</span><span class="n">shape</span>
    <span class="k">if</span> <span class="n">xinit</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span><span class="n">xinit</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">siz</span><span class="p">[</span><span class="mi">2</span><span class="p">],))</span>
    <span class="n">proj_thresh</span> <span class="o">=</span> <span class="n">sqrt</span><span class="p">(</span><span class="n">pca_eig_val</span><span class="p">)</span><span class="o">*</span><span class="n">tol</span>
    <span class="n">mse</span><span class="p">,</span><span class="n">U</span> <span class="o">=</span> <span class="n">fista_bas</span><span class="p">(</span><span class="n">Mxs</span><span class="p">,</span><span class="n">xinit</span><span class="p">,</span><span class="n">Mhs</span><span class="p">,</span><span class="n">mu</span><span class="p">,</span><span class="n">proj_cons</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">proj_thresh</span><span class="o">=</span><span class="n">proj_thresh</span><span class="p">,</span><span class="n">nb_iter</span><span class="o">=</span><span class="n">nb_iter</span><span class="p">)</span>
    <span class="n">output</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">siz</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">siz</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
    <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">siz</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
        <span class="n">output</span> <span class="o">=</span> <span class="n">output</span> <span class="o">+</span> <span class="n">U</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">*</span><span class="n">mat_dict_in</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">mean_comp</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span><span class="n">output</span> <span class="o">=</span> <span class="n">output</span><span class="o">+</span><span class="n">mean_mat</span>
    <span class="k">return</span> <span class="n">U</span><span class="p">,</span><span class="n">mse</span><span class="p">,</span><span class="n">output</span>

<span class="k">def</span> <span class="nf">fista_ell_4</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">h</span><span class="p">,</span><span class="n">mu</span><span class="p">,</span><span class="n">mat_cor</span><span class="p">,</span><span class="n">mat_dict</span><span class="p">,</span><span class="n">thresholds</span><span class="p">,</span><span class="n">max_1st_comp</span><span class="p">,</span><span class="n">mean_1st_comp</span><span class="p">,</span><span class="n">nb_iter</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span><span class="n">mean_comp</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">xinit</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>

    <span class="n">mat_dict_in</span>  <span class="o">=</span><span class="kc">None</span>
    <span class="k">if</span> <span class="n">mean_comp</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">mean_mat</span> <span class="o">=</span> <span class="n">mat_dict</span><span class="p">[:,:,</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">xmean</span> <span class="o">=</span> <span class="n">mean_mat</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">h</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span><span class="n">x</span><span class="o">-</span><span class="n">xmean</span>
        <span class="n">mat_dict_in</span> <span class="o">=</span> <span class="n">mat_dict</span><span class="p">[:,:,</span><span class="mi">1</span><span class="p">:]</span>
    <span class="k">else</span><span class="p">:</span> <span class="n">mat_dict_in</span> <span class="o">=</span> <span class="n">mat_dict</span>
    <span class="n">Mhs</span><span class="p">,</span><span class="n">Mxs</span> <span class="o">=</span> <span class="n">const_mat_gen</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">h</span><span class="p">,</span><span class="n">mat_cor</span><span class="p">,</span><span class="n">mat_dict_in</span><span class="p">)</span>
    <span class="n">siz</span> <span class="o">=</span> <span class="n">mat_dict_in</span><span class="o">.</span><span class="n">shape</span>
    <span class="k">if</span> <span class="n">xinit</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span><span class="n">xinit</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">siz</span><span class="p">[</span><span class="mi">2</span><span class="p">],))</span>
    <span class="n">w1</span><span class="o">=</span><span class="mf">0.8</span>
    <span class="n">w2</span><span class="o">=</span><span class="mi">1</span><span class="o">-</span><span class="n">w1</span>
    <span class="n">w</span><span class="p">,</span><span class="n">v</span> <span class="o">=</span> <span class="n">LA</span><span class="o">.</span><span class="n">eigh</span><span class="p">(</span><span class="n">Mhs</span><span class="p">)</span>
    <span class="n">lip</span> <span class="o">=</span> <span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">w</span><span class="p">)</span><span class="o">.</span><span class="n">max</span><span class="p">())</span>
    <span class="n">lamb</span> <span class="o">=</span> <span class="mf">1.5</span>
    <span class="n">z1</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">xinit</span><span class="p">)</span>
    <span class="n">z2</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">xinit</span><span class="p">)</span>
    <span class="n">U</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">xinit</span><span class="p">)</span>
    <span class="n">i</span><span class="o">=</span><span class="mi">0</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_iter</span><span class="p">):</span>
        <span class="n">z1_temp</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">U</span><span class="o">-</span><span class="n">z1</span><span class="o">-</span><span class="p">(</span><span class="n">Mhs</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">U</span><span class="p">)</span><span class="o">-</span><span class="n">Mxs</span><span class="p">)</span><span class="o">/</span><span class="n">lip</span>
        <span class="n">z1_temp</span><span class="p">[</span><span class="n">siz</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">=</span><span class="n">z1_temp</span><span class="p">[</span><span class="n">siz</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">mean_1st_comp</span>
        <span class="n">z1_temp</span> <span class="o">=</span> <span class="n">thresholding</span><span class="p">(</span><span class="n">z1_temp</span><span class="p">,</span><span class="n">thresholds</span><span class="o">/</span><span class="n">w1</span><span class="p">,</span><span class="n">thresh_type</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">z1_temp</span><span class="p">[</span><span class="n">siz</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">=</span><span class="n">z1_temp</span><span class="p">[</span><span class="n">siz</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">mean_1st_comp</span>
        <span class="n">z1</span> <span class="o">=</span> <span class="n">z1</span> <span class="o">+</span> <span class="n">lamb</span><span class="o">*</span><span class="p">(</span><span class="n">z1_temp</span><span class="o">-</span><span class="n">U</span><span class="p">)</span>
        <span class="n">z2_temp</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">U</span><span class="o">-</span><span class="n">z2</span><span class="o">-</span><span class="p">(</span><span class="n">Mhs</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">U</span><span class="p">)</span><span class="o">-</span><span class="n">Mxs</span><span class="p">)</span><span class="o">/</span><span class="n">lip</span>
        <span class="n">z2_temp</span><span class="p">[</span><span class="n">siz</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">=</span><span class="n">z2_temp</span><span class="p">[</span><span class="n">siz</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">thresholding</span><span class="p">(</span><span class="n">z2_temp</span><span class="p">[</span><span class="n">siz</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span><span class="n">max_1st_comp</span><span class="p">,</span><span class="n">thresh_type</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">z2</span> <span class="o">=</span> <span class="n">z2</span> <span class="o">+</span> <span class="n">lamb</span><span class="o">*</span><span class="p">(</span><span class="n">z2_temp</span><span class="o">-</span><span class="n">U</span><span class="p">)</span>
        <span class="n">U</span> <span class="o">=</span> <span class="n">w1</span><span class="o">*</span><span class="n">z1</span><span class="o">+</span><span class="n">w2</span><span class="o">*</span><span class="n">z2</span>
    <span class="n">output</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">siz</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">siz</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
    <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">siz</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
        <span class="n">output</span> <span class="o">=</span> <span class="n">output</span> <span class="o">+</span> <span class="n">U</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">*</span><span class="n">mat_dict_in</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">mean_comp</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span><span class="n">output</span> <span class="o">=</span> <span class="n">output</span><span class="o">+</span><span class="n">mean_mat</span>
    <span class="k">return</span> <span class="n">U</span><span class="p">,</span><span class="n">output</span>

<span class="k">def</span> <span class="nf">fista_ell_5</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">h</span><span class="p">,</span><span class="n">mu</span><span class="p">,</span><span class="n">mat_cor</span><span class="p">,</span><span class="n">mat_dict</span><span class="p">,</span><span class="n">coeff_dict</span><span class="p">,</span><span class="n">thresh</span><span class="p">,</span><span class="n">nb_iter</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span><span class="n">nb_reweighting</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">mean_comp</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">xinit</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span> <span class="c1"># The code assumes columns vectors; synthesis scheme; a dictionary should be provided</span>

    <span class="n">mat_dict_in</span>  <span class="o">=</span><span class="kc">None</span>
    <span class="k">if</span> <span class="n">mean_comp</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">mean_mat</span> <span class="o">=</span> <span class="n">mat_dict</span><span class="p">[:,:,</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">xmean</span> <span class="o">=</span> <span class="n">mean_mat</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">h</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span><span class="n">x</span><span class="o">-</span><span class="n">xmean</span>
        <span class="n">mat_dict_in</span> <span class="o">=</span> <span class="n">mat_dict</span><span class="p">[:,:,</span><span class="mi">1</span><span class="p">:]</span>
    <span class="k">else</span><span class="p">:</span> <span class="n">mat_dict_in</span> <span class="o">=</span> <span class="n">mat_dict</span>
    <span class="n">Mhs</span><span class="p">,</span><span class="n">Mxs</span> <span class="o">=</span> <span class="n">const_mat_gen_2</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">h</span><span class="p">,</span><span class="n">mat_cor</span><span class="p">,</span><span class="n">mat_dict_in</span><span class="p">,</span><span class="n">coeff_dict</span><span class="p">)</span>
    <span class="n">siz</span> <span class="o">=</span> <span class="n">mat_dict_in</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">siz_2</span> <span class="o">=</span> <span class="n">coeff_dict</span><span class="o">.</span><span class="n">shape</span>
    <span class="k">if</span> <span class="n">xinit</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span><span class="n">xinit</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">siz_2</span><span class="p">[</span><span class="mi">0</span><span class="p">],))</span>
    <span class="n">weights</span> <span class="o">=</span> <span class="n">ones</span><span class="p">((</span><span class="n">siz_2</span><span class="p">[</span><span class="mi">0</span><span class="p">],))</span>
    <span class="n">k</span><span class="o">=</span><span class="mi">0</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_reweighting</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
        <span class="n">mse</span><span class="p">,</span><span class="n">alpha</span> <span class="o">=</span> <span class="n">fista_bas</span><span class="p">(</span><span class="n">Mxs</span><span class="p">,</span><span class="n">xinit</span><span class="p">,</span><span class="n">Mhs</span><span class="p">,</span><span class="n">mu</span><span class="p">,</span><span class="n">nb_iter</span><span class="o">=</span><span class="n">nb_iter</span><span class="p">,</span><span class="n">thresh_cons</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">thresh</span><span class="o">=</span><span class="n">thresh</span><span class="o">*</span><span class="n">weights</span><span class="p">)</span>
        <span class="n">weights</span> <span class="o">=</span> <span class="n">ones</span><span class="p">((</span><span class="n">siz_2</span><span class="p">[</span><span class="mi">0</span><span class="p">],))</span><span class="o">/</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">alpha</span><span class="p">)</span><span class="o">/</span><span class="n">thresh</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">U</span> <span class="o">=</span> <span class="n">coeff_dict</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">alpha</span><span class="p">)</span>
    <span class="n">output</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">siz</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">siz</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
    <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">siz</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
        <span class="n">output</span> <span class="o">=</span> <span class="n">output</span> <span class="o">+</span> <span class="n">U</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">*</span><span class="n">mat_dict_in</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">mean_comp</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span><span class="n">output</span> <span class="o">=</span> <span class="n">output</span><span class="o">+</span><span class="n">mean_mat</span>
    <span class="k">return</span> <span class="n">U</span><span class="p">,</span><span class="n">alpha</span><span class="p">,</span><span class="n">mse</span><span class="p">,</span><span class="n">output</span>


<span class="k">def</span> <span class="nf">fista_ell_6</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">h</span><span class="p">,</span><span class="n">mu</span><span class="p">,</span><span class="n">mat_cor</span><span class="p">,</span><span class="n">mat_dict</span><span class="p">,</span><span class="n">coeff_dict</span><span class="p">,</span><span class="n">cells_means</span><span class="p">,</span><span class="n">nb_cells</span><span class="p">):</span>

    <span class="n">siz1</span> <span class="o">=</span> <span class="n">cells_means</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">nb_cells_tot</span> <span class="o">=</span> <span class="n">siz1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">nb_cells_tot</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>
    <span class="n">scal</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">nb_cells_tot</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>
    <span class="n">mean_mat</span> <span class="o">=</span> <span class="n">mat_dict</span><span class="p">[:,:,</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">xmean</span> <span class="o">=</span> <span class="n">mean_mat</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">h</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span><span class="n">x</span><span class="o">-</span><span class="n">xmean</span>
    <span class="n">mat_dict_in</span> <span class="o">=</span> <span class="n">mat_dict</span><span class="p">[:,:,</span><span class="mi">1</span><span class="p">:]</span>
    <span class="n">Mhs0</span><span class="p">,</span><span class="n">Mxs0</span> <span class="o">=</span> <span class="n">const_mat_gen</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">h</span><span class="p">,</span><span class="n">mat_cor</span><span class="p">,</span><span class="n">mat_dict_in</span><span class="p">)</span>
    <span class="n">i</span><span class="o">=</span><span class="mi">0</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_cells_tot</span><span class="p">):</span>
        <span class="n">x0</span> <span class="o">=</span> <span class="n">Mhs0</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">transpose</span><span class="p">(</span><span class="n">cells_means</span><span class="p">[</span><span class="n">i</span><span class="p">,:]))</span>
        <span class="n">a</span> <span class="o">=</span> <span class="n">transpose</span><span class="p">(</span><span class="n">Mxs0</span><span class="p">)</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">x0</span><span class="p">)</span>
        <span class="n">b</span> <span class="o">=</span> <span class="n">transpose</span><span class="p">(</span><span class="n">x0</span><span class="p">)</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">x0</span><span class="p">)</span>
        <span class="c1">#opt = a/b</span>
        <span class="n">opt</span><span class="o">=</span><span class="mi">1</span>
        <span class="n">res</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">transpose</span><span class="p">(</span><span class="n">Mxs0</span> <span class="o">-</span> <span class="n">opt</span><span class="o">*</span><span class="n">x0</span><span class="p">)</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">Mxs0</span> <span class="o">-</span> <span class="n">opt</span><span class="o">*</span><span class="n">x0</span><span class="p">)</span>
        <span class="n">scal</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">=</span><span class="n">opt</span>
    <span class="n">ind</span> <span class="o">=</span> <span class="n">argsort</span><span class="p">(</span><span class="n">squeeze</span><span class="p">(</span><span class="n">res</span><span class="p">))</span>
    <span class="n">siz2</span> <span class="o">=</span> <span class="n">coeff_dict</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">siz3</span> <span class="o">=</span> <span class="n">mat_dict_in</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">mean_mat_2</span> <span class="o">=</span> <span class="n">mean_mat</span><span class="o">*</span><span class="mi">0</span>

    <span class="n">res_opt</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">nb_cells</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>
    <span class="n">opt_candidate</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">siz2</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">nb_cells</span><span class="p">))</span> <span class="c1"># siz2[1] = sparsity level</span>
    <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_cells</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">siz3</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
            <span class="n">mean_mat_2</span><span class="o">=</span><span class="n">mean_mat_2</span><span class="o">+</span> <span class="n">mat_dict_in</span><span class="p">[:,:,</span><span class="n">j</span><span class="p">]</span><span class="o">*</span><span class="n">scal</span><span class="p">[</span><span class="n">ind</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span><span class="o">*</span><span class="n">cells_means</span><span class="p">[</span><span class="n">ind</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">j</span><span class="p">]</span>
        <span class="n">xtemp</span> <span class="o">=</span> <span class="n">x</span> <span class="o">-</span> <span class="n">mean_mat_2</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">h</span><span class="p">)</span>
        <span class="n">Mhs</span><span class="p">,</span><span class="n">Mxs</span> <span class="o">=</span> <span class="n">const_mat_gen_2</span><span class="p">(</span><span class="n">xtemp</span><span class="p">,</span><span class="n">h</span><span class="p">,</span><span class="n">mat_cor</span><span class="p">,</span><span class="n">mat_dict_in</span><span class="p">,</span><span class="n">squeeze</span><span class="p">(</span><span class="n">coeff_dict</span><span class="p">[:,:,</span><span class="n">ind</span><span class="p">[</span><span class="n">i</span><span class="p">]]))</span>
        <span class="n">Mxs</span> <span class="o">=</span> <span class="n">squeeze</span><span class="p">(</span><span class="n">transpose</span><span class="p">(</span><span class="n">Mxs</span><span class="p">))</span>
        <span class="c1">#M0 = transpose(Mhs).dot(Mhs)</span>
        <span class="n">w</span><span class="p">,</span><span class="n">v</span> <span class="o">=</span> <span class="n">LA</span><span class="o">.</span><span class="n">eigh</span><span class="p">(</span><span class="n">M0</span><span class="p">)</span>
        <span class="n">mu</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">mse</span><span class="p">,</span><span class="n">U</span> <span class="o">=</span> <span class="n">fista_bas</span><span class="p">(</span><span class="n">y</span><span class="p">,</span><span class="n">x_init</span><span class="p">,</span><span class="n">M</span><span class="p">,</span><span class="n">mu</span><span class="p">,</span><span class="n">nb_iter</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
        <span class="c1">#opt_candidate[:,i] = LA.inv(M0).dot(transpose(Mhs)).dot(Mxs)</span>
        <span class="n">opt_candidate</span><span class="p">[:,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">U</span>
        <span class="c1">#res_opt[i] = transpose(Mxs - Mhs.dot(opt_candidate[:,i])).dot(Mxs - Mhs.dot(opt_candidate[:,i]))</span>
        <span class="n">res_opt</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">mse</span><span class="p">[</span><span class="mi">900</span><span class="p">]</span>
    <span class="nb">print</span> <span class="n">res_opt</span>
    <span class="n">ind2</span> <span class="o">=</span> <span class="n">argsort</span><span class="p">(</span><span class="n">squeeze</span><span class="p">(</span><span class="n">res_opt</span><span class="p">))</span>
    <span class="n">alpha</span> <span class="o">=</span> <span class="n">transpose</span><span class="p">(</span><span class="n">cells_means</span><span class="p">[</span><span class="n">ind</span><span class="p">[</span><span class="n">ind2</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span><span class="n">j</span><span class="p">])</span><span class="o">*</span><span class="n">scal</span><span class="p">[</span><span class="n">ind</span><span class="p">[</span><span class="n">ind2</span><span class="p">[</span><span class="mi">0</span><span class="p">]]]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">siz2</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
        <span class="n">alpha</span> <span class="o">=</span> <span class="n">alpha</span> <span class="o">+</span> <span class="n">coeff_dict</span><span class="p">[:,:,</span><span class="n">ind</span><span class="p">[</span><span class="n">ind2</span><span class="p">[</span><span class="mi">0</span><span class="p">]]]</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">opt_candidate</span><span class="p">[:,</span><span class="n">ind2</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span>
    <span class="n">output</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">siz3</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">siz3</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
    <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">siz3</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
        <span class="n">output</span> <span class="o">=</span> <span class="n">output</span> <span class="o">+</span> <span class="n">alpha</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">*</span><span class="n">mat_dict_in</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">]</span>
    <span class="n">output</span> <span class="o">=</span> <span class="n">output</span><span class="o">+</span><span class="n">mean_mat</span>
    <span class="k">return</span> <span class="n">alpha</span><span class="p">,</span><span class="n">alpha</span><span class="p">,</span><span class="n">output</span>


<span class="k">def</span> <span class="nf">fista_ell_7</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">h</span><span class="p">,</span><span class="n">mu</span><span class="p">,</span><span class="n">mat_cor</span><span class="p">,</span><span class="n">mat_dict</span><span class="p">,</span><span class="n">cells_means</span><span class="p">,</span><span class="n">nb_cells</span><span class="p">,</span><span class="n">iter_en</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_iter</span><span class="o">=</span><span class="mi">50</span><span class="p">):</span>
    <span class="n">siz1</span> <span class="o">=</span> <span class="n">cells_means</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">siz2</span> <span class="o">=</span> <span class="n">mat_dict</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">nb_cells_tot</span> <span class="o">=</span> <span class="n">siz1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="c1">#nb_cells=nb_cells_tot ## Warnign, debugg</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">nb_cells_tot</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>
    <span class="n">scal</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">nb_cells_tot</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>
    <span class="n">mean_mat</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="mi">6</span><span class="p">,</span><span class="n">siz1</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="mi">6</span><span class="p">,</span><span class="n">nb_cells_tot</span><span class="p">))</span>
    <span class="n">mat_dict_mat</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="mi">6</span><span class="p">,</span><span class="n">siz1</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="mi">6</span><span class="p">,</span><span class="n">siz2</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">nb_cells</span><span class="p">))</span>
    <span class="n">i</span><span class="o">=</span><span class="mi">0</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_cells_tot</span><span class="p">):</span>
        <span class="n">mean_mat_vect</span> <span class="o">=</span> <span class="n">cells_means</span><span class="p">[</span><span class="n">i</span><span class="p">,:]</span>
        <span class="n">mean_mati</span> <span class="o">=</span> <span class="n">mean_mat_vect</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="n">siz1</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="mi">6</span><span class="p">)</span>
        <span class="n">xmean</span> <span class="o">=</span> <span class="n">mean_mati</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">h</span><span class="p">)</span>
        <span class="n">res</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">transpose</span><span class="p">(</span><span class="n">x</span><span class="o">-</span><span class="n">xmean</span><span class="p">)</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">x</span><span class="o">-</span><span class="n">xmean</span><span class="p">)</span>
        <span class="n">mean_mat</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">]</span><span class="o">=</span><span class="n">mean_mati</span>
    <span class="n">ind</span> <span class="o">=</span> <span class="n">argsort</span><span class="p">(</span><span class="n">squeeze</span><span class="p">(</span><span class="n">res</span><span class="p">))</span>

    <span class="n">res_opt</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">nb_cells</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>
    <span class="n">opt_candidate</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">siz2</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">nb_cells</span><span class="p">))</span> <span class="c1"># siz2[1] = sparsity level</span>
    <span class="n">xinit</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">siz2</span><span class="p">[</span><span class="mi">1</span><span class="p">],))</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_cells</span><span class="p">):</span>
        <span class="n">mean_mati</span> <span class="o">=</span> <span class="n">array</span><span class="p">(</span><span class="n">mean_mat</span><span class="p">[:,:,</span><span class="n">ind</span><span class="p">[</span><span class="n">i</span><span class="p">]])</span>
        <span class="n">xtemp</span> <span class="o">=</span> <span class="n">x</span> <span class="o">-</span> <span class="n">mean_mati</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">h</span><span class="p">)</span>
        <span class="n">mat_dicti</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="mi">6</span><span class="p">,</span><span class="n">siz1</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="mi">6</span><span class="p">,</span><span class="n">siz2</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
        <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">siz2</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
            <span class="n">mat_dict_vectij</span> <span class="o">=</span> <span class="n">mat_dict</span><span class="p">[:,</span><span class="n">j</span><span class="p">,</span><span class="n">ind</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span>
            <span class="n">mat_dicti</span><span class="p">[:,:,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">mat_dict_vectij</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="n">siz1</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="mi">6</span><span class="p">)</span>
        <span class="n">mat_dict_mat</span><span class="p">[:,:,:,</span><span class="n">i</span><span class="p">]</span><span class="o">=</span><span class="n">mat_dicti</span>
        <span class="n">Mhs</span><span class="p">,</span><span class="n">Mxs</span> <span class="o">=</span> <span class="n">const_mat_gen</span><span class="p">(</span><span class="n">xtemp</span><span class="p">,</span><span class="n">h</span><span class="p">,</span><span class="n">mat_cor</span><span class="p">,</span><span class="n">mat_dicti</span><span class="p">)</span>
        <span class="n">Mxs</span> <span class="o">=</span> <span class="n">squeeze</span><span class="p">(</span><span class="n">transpose</span><span class="p">(</span><span class="n">Mxs</span><span class="p">))</span>
        <span class="c1">#M0 = transpose(Mhs).dot(Mhs)</span>
        <span class="n">w</span><span class="p">,</span><span class="n">v</span> <span class="o">=</span> <span class="n">LA</span><span class="o">.</span><span class="n">eigh</span><span class="p">(</span><span class="n">Mhs</span><span class="p">)</span>
        <span class="nb">print</span> <span class="s1">&#39;eigen_val: &#39;</span><span class="p">,</span> <span class="n">w</span>
        <span class="n">U</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">siz2</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="mi">1</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">iter_en</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">mu</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">mse</span><span class="p">,</span><span class="n">U</span> <span class="o">=</span> <span class="n">fista_bas</span><span class="p">(</span><span class="n">Mxs</span><span class="p">,</span><span class="n">xinit</span><span class="p">,</span><span class="n">Mhs</span><span class="p">,</span><span class="n">mu</span><span class="p">,</span><span class="n">nb_iter</span><span class="o">=</span><span class="n">nb_iter</span><span class="p">)</span>
            <span class="c1">#</span>
            <span class="n">opt_candidate</span><span class="p">[:,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">U</span>
            <span class="c1">#res_opt[i] = transpose(Mxs - Mhs.dot(opt_candidate[:,i])).dot(Mxs - Mhs.dot(opt_candidate[:,i]))</span>
            <span class="n">res_opt</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">mse</span><span class="p">[</span><span class="n">nb_iter</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">opt_candidate</span><span class="p">[:,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">LA</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">Mhs</span><span class="p">)</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">Mxs</span><span class="p">)</span>
            <span class="n">res_opt</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">transpose</span><span class="p">(</span><span class="n">Mxs</span> <span class="o">-</span> <span class="n">Mhs</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">opt_candidate</span><span class="p">[:,</span><span class="n">i</span><span class="p">]))</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">Mxs</span> <span class="o">-</span> <span class="n">Mhs</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">opt_candidate</span><span class="p">[:,</span><span class="n">i</span><span class="p">]))</span>

<span class="c1">#print res_opt</span>
    <span class="n">ind2</span> <span class="o">=</span> <span class="n">argsort</span><span class="p">(</span><span class="n">squeeze</span><span class="p">(</span><span class="n">res_opt</span><span class="p">))</span>
    <span class="n">output</span> <span class="o">=</span> <span class="n">mean_mat</span><span class="p">[:,:,</span><span class="n">ind</span><span class="p">[</span><span class="n">ind2</span><span class="p">[</span><span class="mi">0</span><span class="p">]]]</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">siz2</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
        <span class="n">output</span> <span class="o">=</span> <span class="n">output</span> <span class="o">+</span> <span class="n">opt_candidate</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">ind2</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">*</span><span class="n">mat_dict_mat</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">,</span><span class="n">ind2</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
    <span class="k">return</span> <span class="n">output</span><span class="p">,</span><span class="n">ind</span><span class="p">,</span><span class="n">ind2</span><span class="p">,</span><span class="n">res_opt</span><span class="p">,</span><span class="n">opt_candidate</span>



<span class="k">def</span> <span class="nf">fista_bas</span><span class="p">(</span><span class="n">y</span><span class="p">,</span><span class="n">x_init</span><span class="p">,</span><span class="n">M</span><span class="p">,</span><span class="n">mu</span><span class="p">,</span><span class="n">proj_cons</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">proj_thresh</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">nb_iter</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span><span class="n">thresh_cons</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">thresh</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span> <span class="c1"># Minimizes : J(X) = X^T*M*X - y^T*X + C, M being symetric positive</span>
    <span class="kn">import</span> <span class="nn">numpy.ma</span> <span class="k">as</span> <span class="nn">npma</span>
    <span class="kn">from</span> <span class="nn">numpy</span> <span class="k">import</span> <span class="o">*</span>
    <span class="kn">import</span> <span class="nn">numpy.linalg</span> <span class="k">as</span> <span class="nn">LA</span>
    <span class="n">siz</span> <span class="o">=</span> <span class="n">M</span><span class="o">.</span><span class="n">shape</span>
    <span class="sd">&quot;&quot;&quot;a=1</span>
<span class="sd">        M = M + a*eye(siz[0])&quot;&quot;&quot;</span>
    <span class="n">n1</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">x_init</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">mse</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">nb_iter</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>
    <span class="n">U</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">x_init</span><span class="p">)</span>
    <span class="n">V</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">n1</span><span class="p">,))</span>
    <span class="n">V_old</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">V</span><span class="p">)</span>
    <span class="n">w</span><span class="p">,</span><span class="n">v</span> <span class="o">=</span> <span class="n">LA</span><span class="o">.</span><span class="n">eigh</span><span class="p">(</span><span class="n">M</span><span class="p">)</span>
    <span class="n">lip</span> <span class="o">=</span> <span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">w</span><span class="p">)</span><span class="o">.</span><span class="n">max</span><span class="p">())</span>

    <span class="c1">#lip = h.sum()</span>
    <span class="c1">#print lip,(h**2).sum(),(abs(gradx_ker).sum())**2,(abs(grady_ker).sum())**2,lambda_grad*max((normv[3]/normv)**2)</span>
    <span class="n">t</span><span class="o">=</span><span class="mi">1</span>
    <span class="n">told</span><span class="o">=</span><span class="n">t</span>
    <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_iter</span><span class="p">):</span>

        <span class="n">res</span> <span class="o">=</span> <span class="n">y</span> <span class="o">-</span> <span class="n">M</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">U</span><span class="p">)</span>
        <span class="n">mse</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">**</span><span class="mi">2</span>
        <span class="n">V</span> <span class="o">=</span> <span class="n">U</span> <span class="o">+</span> <span class="p">(</span><span class="n">mu</span><span class="o">/</span><span class="n">lip</span><span class="p">)</span><span class="o">*</span><span class="n">res</span>
        <span class="c1">#U = U + (mu/lip)*(transpose(M)).dot(res)</span>
        <span class="n">k</span><span class="o">=</span><span class="mi">0</span>
        <span class="k">if</span> <span class="n">proj_cons</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">n1</span><span class="p">):</span>
                <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">V</span><span class="p">[</span><span class="n">k</span><span class="p">])</span><span class="o">&gt;</span><span class="n">proj_thresh</span><span class="p">[</span><span class="n">k</span><span class="p">]:</span>
                    <span class="n">V</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">V</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">/</span><span class="nb">abs</span><span class="p">(</span><span class="n">V</span><span class="p">[</span><span class="n">k</span><span class="p">]))</span><span class="o">*</span><span class="n">proj_thresh</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">thresh_cons</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">thresh_type</span><span class="o">=</span><span class="mi">1</span>
            <span class="n">V</span> <span class="o">=</span> <span class="n">thresholding</span><span class="p">(</span><span class="n">V</span><span class="p">,</span><span class="n">thresh</span><span class="p">,</span><span class="n">thresh_type</span><span class="p">)</span>
        <span class="n">t</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">4</span><span class="o">*</span><span class="n">told</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span><span class="o">/</span><span class="mi">2</span>
        <span class="n">lamb</span> <span class="o">=</span> <span class="mi">1</span><span class="o">+</span><span class="p">(</span><span class="n">told</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="n">t</span>
        <span class="n">told</span> <span class="o">=</span> <span class="n">t</span>
        <span class="n">U</span> <span class="o">=</span> <span class="n">V_old</span> <span class="o">+</span> <span class="n">lamb</span><span class="o">*</span><span class="p">(</span><span class="n">V</span><span class="o">-</span><span class="n">V_old</span><span class="p">)</span>
        <span class="n">V_old</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">V</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">mse</span><span class="p">,</span><span class="n">U</span>


<span class="k">def</span> <span class="nf">sig_sparsity_analysis</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">nb_points</span><span class="p">):</span>
    <span class="n">pts</span> <span class="o">=</span> <span class="mi">100</span><span class="o">*</span><span class="n">double</span><span class="p">(</span><span class="n">array</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">nb_points</span><span class="o">+</span><span class="mi">1</span><span class="p">)))</span><span class="o">/</span><span class="n">nb_points</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">size</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
    <span class="n">ind_sort</span> <span class="o">=</span> <span class="n">argsort</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>

    <span class="n">energy</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">x</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">en_perc</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">nb_points</span><span class="p">,))</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_points</span><span class="p">):</span>
        <span class="n">en_perc</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">100</span><span class="o">*</span><span class="nb">sum</span><span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="n">ind_sort</span><span class="p">[</span><span class="o">-</span><span class="nb">int</span><span class="p">(</span><span class="n">pts</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">*</span><span class="n">size</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">/</span><span class="mi">100</span><span class="p">):]]</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="n">energy</span>

    <span class="k">return</span> <span class="n">en_perc</span><span class="p">,</span><span class="n">pts</span>

<span class="k">def</span> <span class="nf">sig_sparsity_analysis_m</span><span class="p">(</span><span class="n">cube</span><span class="p">,</span><span class="n">nb_points</span><span class="p">):</span>
    <span class="n">out</span>  <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">cube</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">nb_points</span><span class="p">))</span>
    <span class="n">pts</span><span class="o">=</span><span class="kc">None</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">cube</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
        <span class="n">en_perc_i</span><span class="p">,</span><span class="n">pts</span> <span class="o">=</span><span class="n">sig_sparsity_analysis</span><span class="p">(</span><span class="n">cube</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">],</span><span class="n">nb_points</span><span class="p">)</span>
        <span class="n">out</span><span class="p">[</span><span class="n">i</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">en_perc_i</span>

    <span class="k">return</span> <span class="n">out</span><span class="p">,</span><span class="n">pts</span>



<div class="viewcode-block" id="thresholding"><a class="viewcode-back" href="../utils.html#utils.thresholding">[docs]</a><span class="k">def</span> <span class="nf">thresholding</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">thresh</span><span class="p">,</span><span class="n">thresh_type</span><span class="p">):</span> 
    <span class="sd">&quot;&quot;&quot; Performs either soft- (``thresh_type=1``) or hard-thresholding (``thresh_type=0``). Input can be 1D or 2D array.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">xthresh</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">n</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">n</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
        <span class="n">n1</span> <span class="o">=</span> <span class="n">n</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">n1</span><span class="o">=</span><span class="mi">1</span>
    <span class="n">n2</span><span class="o">=</span><span class="mi">1</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">n</span><span class="p">)</span><span class="o">==</span><span class="mi">2</span><span class="p">:</span><span class="n">n2</span> <span class="o">=</span><span class="n">n</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">i</span><span class="p">,</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span><span class="mi">0</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">n</span><span class="p">)</span><span class="o">==</span><span class="mi">2</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">n1</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">n2</span><span class="p">):</span>
                <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">xthresh</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">])</span><span class="o">&lt;</span><span class="n">thresh</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]:</span><span class="n">xthresh</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span><span class="o">=</span><span class="mi">0</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">xthresh</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span><span class="o">!=</span><span class="mi">0</span><span class="p">:</span><span class="n">xthresh</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span><span class="o">=</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">xthresh</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">])</span><span class="o">/</span><span class="n">xthresh</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">])</span><span class="o">*</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">xthresh</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">])</span><span class="o">-</span><span class="n">thresh_type</span><span class="o">*</span><span class="n">thresh</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">])</span>

    <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">n</span><span class="p">)</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">n1</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">xthresh</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="o">&lt;</span><span class="n">thresh</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span><span class="n">xthresh</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">=</span><span class="mi">0</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">xthresh</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">!=</span><span class="mi">0</span><span class="p">:</span><span class="n">xthresh</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">=</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">xthresh</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="o">/</span><span class="n">xthresh</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="o">*</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">xthresh</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="o">-</span><span class="n">thresh_type</span><span class="o">*</span><span class="n">thresh</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
    <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">n</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">xthresh</span><span class="p">)</span><span class="o">&lt;</span><span class="n">thresh</span><span class="p">:</span><span class="n">xthresh</span><span class="o">=</span><span class="mi">0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">xthresh</span><span class="o">!=</span><span class="mi">0</span><span class="p">:</span><span class="n">xthresh</span><span class="o">=</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">xthresh</span><span class="p">)</span><span class="o">/</span><span class="n">xthresh</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">xthresh</span><span class="p">)</span><span class="o">-</span><span class="n">thresh_type</span><span class="o">*</span><span class="n">thresh</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">xthresh</span></div>

<span class="k">def</span> <span class="nf">thresholding_perc</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">perc</span><span class="p">,</span><span class="n">thresh_type</span><span class="p">):</span>
    <span class="n">shap</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">thres_map</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">thresh</span> <span class="o">=</span><span class="kc">None</span>
    <span class="n">thresh_map</span> <span class="o">=</span> <span class="n">ones</span><span class="p">(</span><span class="n">shap</span><span class="p">)</span>
    <span class="n">xthresh</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">shap</span><span class="p">)</span><span class="o">&lt;</span><span class="mi">3</span><span class="p">:</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">size</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
        <span class="n">ind_sort</span> <span class="o">=</span> <span class="n">argsort</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">y</span><span class="p">))</span>
        <span class="n">thresh</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">y</span><span class="p">)[</span><span class="n">ind_sort</span><span class="p">[</span><span class="o">-</span><span class="nb">int</span><span class="p">(</span><span class="n">perc</span><span class="o">*</span><span class="n">size</span><span class="p">(</span><span class="n">x</span><span class="p">))]]</span>
        <span class="n">thresh_map</span> <span class="o">=</span> <span class="n">ones</span><span class="p">(</span><span class="n">shap</span><span class="p">)</span><span class="o">*</span><span class="n">thresh</span>
        <span class="n">xthresh</span> <span class="o">=</span> <span class="n">thresholding</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">thresh_map</span><span class="p">,</span><span class="n">thresh_type</span><span class="p">)</span>
    <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">shap</span><span class="p">)</span><span class="o">==</span><span class="mi">3</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
            <span class="n">y</span> <span class="o">=</span> <span class="n">x</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">size</span><span class="p">(</span><span class="n">x</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">]))</span>
            <span class="n">ind_sort</span> <span class="o">=</span> <span class="n">argsort</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">y</span><span class="p">))</span>
            <span class="n">thresh</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">y</span><span class="p">)[</span><span class="n">ind_sort</span><span class="p">[</span><span class="o">-</span><span class="nb">int</span><span class="p">(</span><span class="n">perc</span><span class="o">*</span><span class="n">size</span><span class="p">(</span><span class="n">x</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">]))]]</span>
            <span class="n">thresh_map</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">]</span> <span class="o">*=</span> <span class="n">thresh</span>
        <span class="n">xthresh</span> <span class="o">=</span> <span class="n">thresholding_3D</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">thresh_map</span><span class="p">,</span><span class="n">thresh_type</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">xthresh</span><span class="p">,</span><span class="n">thresh_map</span>

<span class="k">def</span> <span class="nf">threshold_perc</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">perc</span><span class="o">=</span><span class="mf">0.99</span><span class="p">):</span>
    <span class="n">E</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">x</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">i</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
    <span class="n">res</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">v</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">size</span><span class="p">(</span><span class="n">x</span><span class="p">),))</span>
    <span class="k">while</span><span class="p">(</span><span class="n">res</span><span class="o">&lt;</span><span class="n">perc</span><span class="o">*</span><span class="n">E</span><span class="p">):</span>
        <span class="n">res</span><span class="o">+=</span><span class="n">v</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span>
        <span class="n">i</span><span class="o">-=</span><span class="mi">1</span>
    <span class="k">return</span> <span class="n">v</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>


<span class="k">def</span> <span class="nf">kthresholding</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">k</span><span class="p">):</span>
    <span class="n">k</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">k</span><span class="o">&lt;</span><span class="mi">1</span><span class="p">:</span>
        <span class="nb">print</span> <span class="s2">&quot;Warning: wrong k value for k-thresholding&quot;</span>
        <span class="n">k</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">if</span> <span class="n">k</span><span class="o">&gt;</span><span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">x</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">xout</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">*</span><span class="mi">0</span>
        <span class="n">ind</span> <span class="o">=</span> <span class="n">argsort</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
        <span class="n">xout</span><span class="p">[</span><span class="n">ind</span><span class="p">[</span><span class="o">-</span><span class="n">k</span><span class="p">:]]</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="n">ind</span><span class="p">[</span><span class="o">-</span><span class="n">k</span><span class="p">:]]</span>
        <span class="k">return</span> <span class="n">xout</span>

<span class="k">def</span> <span class="nf">kthresholding_im</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="n">thresh_type</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">k</span><span class="o">&lt;</span><span class="mi">1</span><span class="p">:</span>
        <span class="nb">print</span> <span class="s2">&quot;Warning: wrong k value for k-thresholding&quot;</span>
        <span class="n">k</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">shap</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">xv</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">],)))</span>
    <span class="n">ind</span> <span class="o">=</span> <span class="n">argsort</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">xv</span><span class="p">))</span>
    <span class="n">thresh_map</span> <span class="o">=</span> <span class="n">ones</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span><span class="o">*</span><span class="n">xv</span><span class="p">[</span><span class="n">ind</span><span class="p">[</span><span class="o">-</span><span class="n">k</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span>
<span class="c1">#print xv[ind[-k-1]], ind[-k:]</span>
    <span class="n">xthresh</span> <span class="o">=</span> <span class="n">thresholding</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">thresh_map</span><span class="p">,</span><span class="n">thresh_type</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">xthresh</span>

<span class="k">def</span> <span class="nf">khighest</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">k</span><span class="p">):</span>
    <span class="n">shap</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">xv</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">],)))</span>
    <span class="n">ind</span> <span class="o">=</span> <span class="n">argsort</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">xv</span><span class="p">))</span>
    <span class="n">thresh</span> <span class="o">=</span> <span class="n">xv</span><span class="p">[</span><span class="n">ind</span><span class="p">[</span><span class="o">-</span><span class="n">k</span><span class="o">-</span><span class="mi">2</span><span class="p">]]</span>
    <span class="n">i</span><span class="p">,</span><span class="n">j</span> <span class="o">=</span> <span class="n">where</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">&gt;=</span><span class="n">thresh</span><span class="p">)</span>
    <span class="nb">map</span> <span class="o">=</span> <span class="n">x</span><span class="o">*</span><span class="mi">0</span>
    <span class="nb">map</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="k">return</span> <span class="nb">map</span>


<span class="k">def</span> <span class="nf">lineskthresholding</span><span class="p">(</span><span class="n">mat</span><span class="p">,</span><span class="n">k</span><span class="p">):</span>
    <span class="n">mat_out</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">mat</span><span class="p">)</span>
    <span class="n">shap</span> <span class="o">=</span> <span class="n">mat</span><span class="o">.</span><span class="n">shape</span>
    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
        <span class="n">mat_out</span><span class="p">[</span><span class="n">j</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">kthresholding</span><span class="p">(</span><span class="n">mat</span><span class="p">[</span><span class="n">j</span><span class="p">,:],</span><span class="n">k</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">mat_out</span>


<span class="k">def</span> <span class="nf">l_inf_ball_proj</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">thresh</span><span class="p">,</span><span class="n">thresh_type</span><span class="p">,</span><span class="n">cent</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="n">xthresh</span><span class="o">=</span><span class="kc">None</span>
    <span class="k">if</span> <span class="n">cent</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">xthresh</span> <span class="o">=</span> <span class="n">x</span> <span class="o">-</span> <span class="n">thresholding</span><span class="p">(</span><span class="n">x</span><span class="o">-</span><span class="n">cent</span><span class="p">,</span><span class="n">thresh</span><span class="p">,</span><span class="n">thresh_type</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">xthresh</span> <span class="o">=</span> <span class="n">x</span> <span class="o">-</span> <span class="n">thresholding</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">thresh</span><span class="p">,</span><span class="n">thresh_type</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">xthresh</span>

<div class="viewcode-block" id="thresholding_3D"><a class="viewcode-back" href="../utils.html#utils.thresholding_3D">[docs]</a><span class="k">def</span> <span class="nf">thresholding_3D</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">thresh</span><span class="p">,</span><span class="n">thresh_type</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Apply thresholding to a set of images (or transport plans I guess).</span>
<span class="sd">    </span>
<span class="sd">    Calls:</span>
<span class="sd">    </span>
<span class="sd">    * :func:`utils.thresholding`</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">numpy</span> <span class="k">import</span> <span class="n">copy</span>
    <span class="n">shap</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">nb_plan</span> <span class="o">=</span> <span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">k</span><span class="o">=</span><span class="mi">0</span>
    <span class="n">xthresh</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_plan</span><span class="p">):</span>
        <span class="n">xthresh</span><span class="p">[:,:,</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">thresholding</span><span class="p">(</span><span class="n">copy</span><span class="p">(</span><span class="n">x</span><span class="p">[:,:,</span><span class="n">k</span><span class="p">]),</span><span class="n">thresh</span><span class="p">[:,:,</span><span class="n">k</span><span class="p">],</span><span class="n">thresh_type</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">xthresh</span></div>

<span class="k">def</span> <span class="nf">orth_comple</span><span class="p">(</span><span class="n">A</span><span class="p">,</span><span class="n">tol</span><span class="o">=</span><span class="mf">99.999</span><span class="p">):</span> <span class="c1"># This function computes an orthogonal basis of the orthogonal complement of A columns space</span>
    <span class="n">shap</span> <span class="o">=</span> <span class="n">A</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">U</span><span class="p">,</span> <span class="n">s1</span><span class="p">,</span> <span class="n">Vt</span> <span class="o">=</span> <span class="n">linalg</span><span class="o">.</span><span class="n">svd</span><span class="p">(</span><span class="n">A</span><span class="p">,</span><span class="n">full_matrices</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">rank</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">i</span><span class="o">=</span><span class="mi">1</span>
    <span class="n">acc</span> <span class="o">=</span> <span class="mi">100</span><span class="o">*</span><span class="nb">sum</span><span class="p">(</span><span class="n">s1</span><span class="p">[:</span><span class="n">i</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="nb">sum</span><span class="p">(</span><span class="n">s1</span><span class="p">[:]</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
    <span class="k">while</span> <span class="n">acc</span><span class="o">&lt;</span><span class="n">tol</span><span class="p">:</span>
        <span class="n">i</span><span class="o">+=</span><span class="mi">1</span>
        <span class="n">acc</span> <span class="o">=</span> <span class="mi">100</span><span class="o">*</span><span class="nb">sum</span><span class="p">(</span><span class="n">s1</span><span class="p">[:</span><span class="n">i</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="nb">sum</span><span class="p">(</span><span class="n">s1</span><span class="p">[:]</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">rank</span> <span class="o">=</span> <span class="n">i</span>
    <span class="n">A_ortho</span> <span class="o">=</span> <span class="n">U</span><span class="p">[:,:</span><span class="n">rank</span><span class="p">]</span>
    <span class="n">B</span> <span class="o">=</span> <span class="n">eye</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span> <span class="o">-</span> <span class="n">A_ortho</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">transpose</span><span class="p">(</span><span class="n">A_ortho</span><span class="p">))</span>
    <span class="n">U</span><span class="p">,</span><span class="n">s2</span><span class="p">,</span> <span class="n">Vt</span> <span class="o">=</span> <span class="n">linalg</span><span class="o">.</span><span class="n">svd</span><span class="p">(</span><span class="n">B</span><span class="p">,</span><span class="n">full_matrices</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">comple_ortho</span> <span class="o">=</span> <span class="n">U</span><span class="p">[:,:</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">rank</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">comple_ortho</span><span class="p">,</span><span class="n">s2</span><span class="p">,</span><span class="n">rank</span>

<div class="viewcode-block" id="kernel_ext"><a class="viewcode-back" href="../utils.html#utils.kernel_ext">[docs]</a><span class="k">def</span> <span class="nf">kernel_ext</span><span class="p">(</span><span class="n">mat</span><span class="p">,</span><span class="n">tol</span> <span class="o">=</span> <span class="mf">0.01</span><span class="p">):</span> 
    <span class="sd">&quot;&quot;&quot; Computes input matrix&#39;s kernel, defined as the vector space spanned by the eigenvectors corresponding </span>
<span class="sd">    to 1% of the sum of the squared singular values.</span>
<span class="sd">    </span>
<span class="sd">    #TODO: this is basically just the SVD, all lines between that and the ``return`` are useless.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">numpy.linalg</span> <span class="k">import</span> <span class="n">svd</span>
    <span class="n">U</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">Vt</span> <span class="o">=</span> <span class="n">svd</span><span class="p">(</span><span class="n">mat</span><span class="p">,</span><span class="n">full_matrices</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">e</span> <span class="o">=</span> <span class="p">(</span><span class="n">s</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    <span class="n">eker</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">while</span> <span class="n">eker</span><span class="o">&lt;</span><span class="n">e</span><span class="o">*</span><span class="n">tol</span><span class="p">:</span>
        <span class="n">count</span><span class="o">+=</span><span class="mi">1</span>
        <span class="n">eker</span><span class="o">+=</span><span class="n">s</span><span class="p">[</span><span class="o">-</span><span class="n">count</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span>
    <span class="n">count</span> <span class="o">-=</span><span class="mi">1</span>
    <span class="c1">#ker = Vt[-count:,:]</span>
    <span class="n">ker</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">Vt</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">ker</span></div>


<span class="k">def</span> <span class="nf">kernel_test</span><span class="p">(</span><span class="n">mat</span><span class="p">,</span><span class="n">vect_test</span><span class="p">,</span><span class="n">tol</span><span class="o">=</span><span class="mf">0.01</span><span class="p">):</span>
    <span class="n">ker</span> <span class="o">=</span> <span class="n">kernel_ext</span><span class="p">(</span><span class="n">mat</span><span class="p">,</span><span class="n">tol</span> <span class="o">=</span> <span class="n">tol</span><span class="p">)</span>
    <span class="n">proj_coeff</span> <span class="o">=</span> <span class="n">ker</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">vect_test</span><span class="p">)</span>

    <span class="n">loss</span> <span class="o">=</span> <span class="mi">100</span><span class="o">*</span><span class="p">(</span><span class="n">proj_coeff</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">/</span><span class="p">(</span><span class="n">vect_test</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">loss</span>


<span class="k">def</span> <span class="nf">kernel_mat_test</span><span class="p">(</span><span class="n">mat</span><span class="p">,</span><span class="n">mat_test</span><span class="p">,</span><span class="n">tol</span><span class="o">=</span><span class="mf">0.01</span><span class="p">):</span>
    <span class="n">ker</span> <span class="o">=</span> <span class="n">kernel_ext</span><span class="p">(</span><span class="n">mat</span><span class="p">,</span><span class="n">tol</span> <span class="o">=</span> <span class="n">tol</span><span class="p">)</span>
    <span class="n">loss</span> <span class="o">=</span> <span class="mi">100</span><span class="o">*</span><span class="p">((</span><span class="n">mat_test</span> <span class="o">-</span> <span class="n">transpose</span><span class="p">(</span><span class="n">ker</span><span class="p">)</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">ker</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">mat_test</span><span class="p">)))</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">/</span><span class="p">((</span><span class="n">mat_test</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span>

    <span class="k">return</span> <span class="n">loss</span>

<div class="viewcode-block" id="kernel_mat_test_unit"><a class="viewcode-back" href="../utils.html#utils.kernel_mat_test_unit">[docs]</a><span class="k">def</span> <span class="nf">kernel_mat_test_unit</span><span class="p">(</span><span class="n">mat</span><span class="p">,</span><span class="n">mat_test</span><span class="p">,</span><span class="n">tol</span><span class="o">=</span><span class="mf">0.01</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;**[???]**</span>
<span class="sd">    </span>
<span class="sd">    Calls:</span>
<span class="sd">    </span>
<span class="sd">    * :func:`utils.kernel_ext`</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">ker</span> <span class="o">=</span> <span class="n">kernel_ext</span><span class="p">(</span><span class="n">mat</span><span class="p">,</span><span class="n">tol</span> <span class="o">=</span> <span class="n">tol</span><span class="p">)</span>

    <span class="n">shap</span> <span class="o">=</span> <span class="n">ker</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">nb_vect</span> <span class="o">=</span> <span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="c1">#print &quot;Null space size: &quot;,nb_vect</span>
    <span class="n">loss</span> <span class="o">=</span> <span class="p">(</span><span class="n">mat_test</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    <span class="n">select_ind</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
    <span class="n">u</span><span class="o">=</span> <span class="kc">None</span>
    <span class="n">uout</span><span class="o">=</span><span class="kc">None</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_vect</span><span class="p">):</span>
        <span class="n">u</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">ker</span><span class="p">[</span><span class="n">i</span><span class="p">,:])</span>
        <span class="n">u</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
        <span class="n">err</span> <span class="o">=</span> <span class="p">((</span><span class="n">mat_test</span> <span class="o">-</span> <span class="n">transpose</span><span class="p">(</span><span class="n">u</span><span class="p">)</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">mat_test</span><span class="p">)))</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">err</span> <span class="o">&lt;</span><span class="n">loss</span><span class="p">:</span>
            <span class="n">select_ind</span> <span class="o">=</span> <span class="n">i</span>
            <span class="n">loss</span> <span class="o">=</span> <span class="n">err</span>
            <span class="n">uout</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">u</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">loss</span><span class="p">,</span><span class="n">uout</span><span class="p">,</span><span class="n">ker</span><span class="p">,</span><span class="n">select_ind</span></div>

<div class="viewcode-block" id="kernel_mat_stack_test_unit"><a class="viewcode-back" href="../utils.html#utils.kernel_mat_stack_test_unit">[docs]</a><span class="k">def</span> <span class="nf">kernel_mat_stack_test_unit</span><span class="p">(</span><span class="n">mat_stack</span><span class="p">,</span><span class="n">mat_test</span><span class="p">,</span><span class="n">tol</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Computes whatever graph constraint-related quantity :func:`utils.kernel_mat_test_unit` computes</span>
<span class="sd">    for a set of matrices.</span>
<span class="sd">    </span>
<span class="sd">    Calls:</span>
<span class="sd">    </span>
<span class="sd">    * :func:`utils.kernel_mat_test_unit`</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">shap</span> <span class="o">=</span> <span class="n">mat_stack</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">nb_mat</span> <span class="o">=</span> <span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">loss</span> <span class="o">=</span> <span class="p">(</span><span class="n">mat_test</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    <span class="c1">#print &quot;========== Ref Loss =============&quot;,loss</span>
    <span class="n">select_ind</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">vect_out</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">ker_out</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">select_ind_2</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_mat</span><span class="p">):</span>
        <span class="n">lossi</span><span class="p">,</span><span class="n">ui</span><span class="p">,</span><span class="n">keri</span><span class="p">,</span><span class="n">indi</span> <span class="o">=</span> <span class="n">kernel_mat_test_unit</span><span class="p">(</span><span class="n">mat_stack</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">],</span><span class="n">mat_test</span><span class="p">,</span><span class="n">tol</span><span class="o">=</span><span class="n">tol</span><span class="p">)</span>
        <span class="c1">#print &quot;========== ith =============&quot;,lossi</span>
        <span class="k">if</span> <span class="n">lossi</span><span class="o">&lt;</span><span class="n">loss</span><span class="p">:</span>
            <span class="n">loss</span> <span class="o">=</span> <span class="n">lossi</span>
            <span class="n">vect_out</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">ui</span><span class="p">)</span>
            <span class="n">select_ind</span> <span class="o">=</span> <span class="n">i</span>
            <span class="n">select_ind_2</span> <span class="o">=</span> <span class="n">indi</span>
            <span class="n">ker_out</span> <span class="o">=</span> <span class="n">keri</span>
    <span class="k">return</span> <span class="n">vect_out</span><span class="p">,</span><span class="n">select_ind</span><span class="p">,</span><span class="n">loss</span><span class="p">,</span><span class="n">ker_out</span><span class="p">,</span><span class="n">select_ind_2</span></div>

<span class="k">def</span> <span class="nf">kernel_test_stack</span><span class="p">(</span><span class="n">mat</span><span class="p">,</span><span class="n">vect_test</span><span class="p">,</span><span class="n">tol</span><span class="o">=</span><span class="mf">0.01</span><span class="p">):</span>
    <span class="n">nb_mat</span> <span class="o">=</span> <span class="n">mat</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">loss</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">nb_mat</span><span class="p">,))</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_mat</span><span class="p">):</span>
        <span class="n">loss</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">kernel_test</span><span class="p">(</span><span class="n">mat</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">],</span><span class="n">vect_test</span><span class="p">,</span><span class="n">tol</span><span class="o">=</span><span class="n">tol</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">loss</span>

<span class="k">def</span> <span class="nf">kernel_testmat_stack</span><span class="p">(</span><span class="n">mat</span><span class="p">,</span><span class="n">mat_test</span><span class="p">,</span><span class="n">tol</span><span class="o">=</span><span class="mf">0.01</span><span class="p">):</span>
    <span class="n">nb_mat</span> <span class="o">=</span> <span class="n">mat</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">loss</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">nb_mat</span><span class="p">,))</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_mat</span><span class="p">):</span>
        <span class="n">loss</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">kernel_mat_test</span><span class="p">(</span><span class="n">mat</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">],</span><span class="n">mat_test</span><span class="p">,</span><span class="n">tol</span><span class="o">=</span><span class="n">tol</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">loss</span>






<div class="viewcode-block" id="log_sampling"><a class="viewcode-back" href="../utils.html#utils.log_sampling">[docs]</a><span class="k">def</span> <span class="nf">log_sampling</span><span class="p">(</span><span class="n">val_min</span><span class="p">,</span><span class="n">val_max</span><span class="p">,</span><span class="n">nb_samp</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Literally ``np.logspace`` I think.</span>
<span class="sd">    </span>
<span class="sd">    #TODO: you know.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span>  <span class="nn">numpy</span> <span class="k">import</span> <span class="n">log</span><span class="p">,</span><span class="n">double</span><span class="p">,</span><span class="n">array</span><span class="p">,</span><span class="n">exp</span>
    <span class="n">lval_min</span> <span class="o">=</span> <span class="n">log</span><span class="p">(</span><span class="n">val_min</span><span class="p">)</span>
    <span class="n">lval_max</span> <span class="o">=</span> <span class="n">log</span><span class="p">(</span><span class="n">val_max</span><span class="p">)</span>
    <span class="n">a</span> <span class="o">=</span> <span class="n">double</span><span class="p">(</span><span class="n">array</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_samp</span><span class="p">)))</span><span class="o">/</span><span class="p">(</span><span class="n">nb_samp</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">a</span> <span class="o">=</span> <span class="n">a</span><span class="o">*</span><span class="p">(</span><span class="n">lval_max</span><span class="o">-</span><span class="n">lval_min</span><span class="p">)</span> <span class="o">+</span> <span class="n">lval_min</span>
    <span class="n">a</span> <span class="o">=</span> <span class="n">exp</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">a</span></div>

<span class="k">def</span> <span class="nf">lin_sampling</span><span class="p">(</span><span class="n">val_min</span><span class="p">,</span><span class="n">val_max</span><span class="p">,</span><span class="n">nb_samp</span><span class="p">):</span>
    <span class="n">a</span> <span class="o">=</span> <span class="n">double</span><span class="p">(</span><span class="n">array</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_samp</span><span class="p">)))</span><span class="o">/</span><span class="p">(</span><span class="n">nb_samp</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">a</span> <span class="o">=</span> <span class="n">a</span><span class="o">*</span><span class="p">(</span><span class="n">val_max</span><span class="o">-</span><span class="n">val_min</span><span class="p">)</span> <span class="o">+</span><span class="n">val_min</span>
    <span class="k">return</span> <span class="n">a</span>

<span class="k">def</span> <span class="nf">l_inf_ball_proj_3D</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">thresh</span><span class="p">,</span><span class="n">thresh_type</span><span class="p">):</span>
    <span class="n">xthresh</span> <span class="o">=</span> <span class="n">x</span> <span class="o">-</span> <span class="n">thresholding_3D</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">thresh</span><span class="p">,</span><span class="n">thresh_type</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">xthresh</span>

<span class="k">def</span> <span class="nf">low_rank_approx</span><span class="p">(</span><span class="n">mat_ell</span><span class="p">,</span><span class="n">thresh</span><span class="p">,</span><span class="n">thresh_type</span><span class="p">,</span><span class="n">mu</span><span class="p">,</span><span class="n">nb_iter</span><span class="o">=</span><span class="mi">100</span><span class="p">):</span>
    <span class="kn">import</span> <span class="nn">numpy.ma</span> <span class="k">as</span> <span class="nn">npma</span>
    <span class="kn">from</span> <span class="nn">numpy</span> <span class="k">import</span> <span class="o">*</span>
    <span class="n">U</span> <span class="o">=</span> <span class="n">mat_ell</span>
    <span class="n">n1</span> <span class="o">=</span> <span class="n">mat_ell</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">n2</span> <span class="o">=</span> <span class="n">mat_ell</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">mse</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">nb_iter</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>
    <span class="n">V</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">n1</span><span class="p">,</span><span class="n">n2</span><span class="p">))</span>
    <span class="n">V_old</span> <span class="o">=</span> <span class="n">V</span>
    <span class="n">t</span><span class="o">=</span><span class="mi">1</span>
    <span class="n">told</span><span class="o">=</span><span class="n">t</span>
    <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">s</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span><span class="mi">6</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_iter</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">mat_ell</span> <span class="o">-</span> <span class="n">U</span>
        <span class="n">mse</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">**</span><span class="mi">2</span>
        <span class="n">Yi</span> <span class="o">=</span> <span class="n">U</span> <span class="o">+</span> <span class="n">mu</span><span class="o">*</span><span class="n">res</span>
        <span class="n">svecl</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">svecr</span> <span class="o">=</span> <span class="n">linalg</span><span class="o">.</span><span class="n">svd</span><span class="p">(</span><span class="n">Yi</span><span class="p">,</span><span class="n">full_matrices</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">s_thresh</span> <span class="o">=</span> <span class="n">thresholding</span><span class="p">(</span><span class="n">array</span><span class="p">(</span><span class="n">s</span><span class="p">),</span><span class="n">thresh</span><span class="p">,</span><span class="n">thresh_type</span><span class="p">)</span> <span class="c1"># Low rank reg</span>
        <span class="n">V</span> <span class="o">=</span> <span class="n">svecl</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">diag</span><span class="p">(</span><span class="n">s_thresh</span><span class="p">)</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">svecr</span><span class="p">))</span>
        <span class="n">t</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">4</span><span class="o">*</span><span class="n">told</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span><span class="o">/</span><span class="mi">2</span>
        <span class="n">lamb</span> <span class="o">=</span> <span class="mi">1</span><span class="o">+</span><span class="p">(</span><span class="n">told</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="n">t</span>
        <span class="n">told</span> <span class="o">=</span> <span class="n">t</span>
        <span class="n">U</span> <span class="o">=</span> <span class="n">V_old</span> <span class="o">+</span> <span class="n">lamb</span><span class="o">*</span><span class="p">(</span><span class="n">V</span><span class="o">-</span><span class="n">V_old</span><span class="p">)</span>
        <span class="n">V_old</span> <span class="o">=</span> <span class="n">V</span>
    <span class="k">return</span> <span class="n">mse</span><span class="p">,</span><span class="n">s_thresh</span><span class="p">,</span><span class="n">U</span>


<span class="k">def</span> <span class="nf">gal_psnr</span><span class="p">(</span><span class="n">gal</span><span class="p">,</span><span class="n">patch_size</span><span class="p">):</span>
    <span class="kn">from</span> <span class="nn">numpy</span> <span class="k">import</span> <span class="o">*</span>
    <span class="n">n1</span> <span class="o">=</span> <span class="n">gal</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">n2</span> <span class="o">=</span> <span class="n">gal</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">noise_samp</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="mi">2</span><span class="o">*</span><span class="n">patch_size</span><span class="p">,</span><span class="mi">2</span><span class="o">*</span><span class="n">patch_size</span><span class="p">))</span>
    <span class="n">noise_samp</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">patch_size</span><span class="p">,</span><span class="mi">0</span><span class="p">:</span><span class="n">patch_size</span><span class="p">]</span> <span class="o">=</span> <span class="n">gal</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">patch_size</span><span class="p">,</span><span class="mi">0</span><span class="p">:</span><span class="n">patch_size</span><span class="p">]</span>
    <span class="n">noise_samp</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">patch_size</span><span class="p">,</span><span class="n">patch_size</span><span class="p">:</span><span class="mi">2</span><span class="o">*</span><span class="n">patch_size</span><span class="p">]</span> <span class="o">=</span> <span class="n">gal</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">patch_size</span><span class="p">,</span><span class="n">n2</span><span class="o">-</span><span class="n">patch_size</span><span class="p">:</span><span class="n">n2</span><span class="p">]</span>
    <span class="n">noise_samp</span><span class="p">[</span><span class="n">patch_size</span><span class="p">:</span><span class="mi">2</span><span class="o">*</span><span class="n">patch_size</span><span class="p">,</span><span class="mi">0</span><span class="p">:</span><span class="n">patch_size</span><span class="p">]</span> <span class="o">=</span> <span class="n">gal</span><span class="p">[</span><span class="n">n1</span><span class="o">-</span><span class="n">patch_size</span><span class="p">:</span><span class="n">n1</span><span class="p">,</span><span class="mi">0</span><span class="p">:</span><span class="n">patch_size</span><span class="p">]</span>
    <span class="n">noise_samp</span><span class="p">[</span><span class="n">patch_size</span><span class="p">:</span><span class="mi">2</span><span class="o">*</span><span class="n">patch_size</span><span class="p">,</span><span class="n">patch_size</span><span class="p">:</span><span class="mi">2</span><span class="o">*</span><span class="n">patch_size</span><span class="p">]</span> <span class="o">=</span> <span class="n">gal</span><span class="p">[</span><span class="n">n1</span><span class="o">-</span><span class="n">patch_size</span><span class="p">:</span><span class="n">n1</span><span class="p">,</span><span class="n">n2</span><span class="o">-</span><span class="n">patch_size</span><span class="p">:</span><span class="n">n2</span><span class="p">]</span>
    <span class="n">noise_std</span> <span class="o">=</span> <span class="n">nanstd</span><span class="p">(</span><span class="n">noise_samp</span><span class="p">)</span>
    <span class="n">psnr</span> <span class="o">=</span> <span class="n">gal</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">/</span><span class="n">noise_std</span>
    <span class="k">return</span> <span class="n">psnr</span><span class="p">,</span><span class="n">noise_samp</span>

<span class="k">def</span> <span class="nf">gal_selector</span><span class="p">(</span><span class="n">gal_cube</span><span class="p">,</span><span class="n">nb_gal</span><span class="p">,</span><span class="n">patch_size</span><span class="p">,</span><span class="n">min_psnr</span><span class="p">,</span><span class="n">p</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
    <span class="kn">from</span> <span class="nn">numpy</span> <span class="k">import</span> <span class="o">*</span>
    <span class="n">n1</span> <span class="o">=</span> <span class="n">gal_cube</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">n2</span> <span class="o">=</span> <span class="n">gal_cube</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">n3</span> <span class="o">=</span> <span class="n">gal_cube</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">index</span> <span class="o">=</span> <span class="n">ones</span><span class="p">((</span><span class="n">nb_gal</span><span class="p">,))</span><span class="o">*-</span><span class="mi">1</span>
    <span class="n">psnr_select</span> <span class="o">=</span> <span class="n">ones</span><span class="p">((</span><span class="n">nb_gal</span><span class="p">,))</span><span class="o">*-</span><span class="mi">1</span>
    <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">if</span> <span class="n">nb_gal</span><span class="o">&lt;</span><span class="n">n3</span><span class="o">/</span><span class="mi">2</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_gal</span><span class="p">):</span>
            <span class="n">a</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">while</span> <span class="p">(</span><span class="n">a</span> <span class="o">==</span> <span class="kc">False</span> <span class="ow">and</span> <span class="n">count</span> <span class="o">&lt;</span> <span class="n">n3</span><span class="o">*</span><span class="n">p</span> <span class="p">):</span>
                <span class="n">ind</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">n3</span><span class="p">)</span>
                <span class="n">psnr</span><span class="p">,</span><span class="n">noise_stamp</span> <span class="o">=</span> <span class="n">gal_psnr</span><span class="p">(</span><span class="n">gal_cube</span><span class="p">[:,:,</span><span class="n">ind</span><span class="p">],</span><span class="n">patch_size</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">psnr</span><span class="o">&gt;</span><span class="n">min_psnr</span> <span class="ow">and</span> <span class="nb">abs</span><span class="p">(</span><span class="n">index</span><span class="o">-</span><span class="n">ind</span><span class="p">)</span><span class="o">.</span><span class="n">min</span><span class="p">()</span><span class="o">&gt;</span><span class="mi">0</span> <span class="p">:</span>
                    <span class="n">a</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="n">index</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">=</span><span class="n">ind</span>
                    <span class="n">psnr_select</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">psnr</span>
                <span class="n">count</span><span class="o">+=</span><span class="mi">1</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span> <span class="s1">&#39;SNR argument ignored, too much images asked&#39;</span>
        <span class="n">index</span> <span class="o">=</span> <span class="n">array</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_gal</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">index</span>

<span class="k">def</span> <span class="nf">grad2d</span><span class="p">(</span><span class="n">im</span><span class="p">,</span><span class="n">maskx</span><span class="p">,</span><span class="n">masky</span><span class="p">):</span>
    <span class="kn">import</span> <span class="nn">scipy.signal</span> <span class="k">as</span> <span class="nn">scisig</span>
    <span class="kn">from</span> <span class="nn">numpy</span> <span class="k">import</span> <span class="o">*</span>
    <span class="n">gradx</span> <span class="o">=</span> <span class="n">scisig</span><span class="o">.</span><span class="n">fftconvolve</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">maskx</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;same&#39;</span><span class="p">)</span>
    <span class="n">grady</span> <span class="o">=</span> <span class="n">scisig</span><span class="o">.</span><span class="n">fftconvolve</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">masky</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;same&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">gradx</span><span class="p">,</span><span class="n">grady</span>

<span class="k">def</span> <span class="nf">transp_grad2d</span><span class="p">(</span><span class="n">imx</span><span class="p">,</span><span class="n">imy</span><span class="p">,</span><span class="n">maskx</span><span class="p">,</span><span class="n">masky</span><span class="p">):</span>
    <span class="kn">import</span> <span class="nn">scipy.signal</span> <span class="k">as</span> <span class="nn">scisig</span>
    <span class="kn">from</span> <span class="nn">numpy</span> <span class="k">import</span> <span class="o">*</span>
    <span class="n">tgradx</span> <span class="o">=</span> <span class="n">scisig</span><span class="o">.</span><span class="n">fftconvolve</span><span class="p">(</span><span class="n">imx</span><span class="p">,</span> <span class="n">rot90</span><span class="p">(</span><span class="n">rot90</span><span class="p">(</span><span class="n">maskx</span><span class="p">)),</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;same&#39;</span><span class="p">)</span>
    <span class="n">tgrady</span> <span class="o">=</span> <span class="n">scisig</span><span class="o">.</span><span class="n">fftconvolve</span><span class="p">(</span><span class="n">imy</span><span class="p">,</span> <span class="n">rot90</span><span class="p">(</span><span class="n">rot90</span><span class="p">(</span><span class="n">masky</span><span class="p">)),</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;same&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">tgradx</span><span class="p">,</span><span class="n">tgrady</span>

<span class="k">def</span> <span class="nf">factorielle</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">x</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
        <span class="k">return</span> <span class="mi">1</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">x</span> <span class="o">*</span> <span class="n">factorielle</span><span class="p">(</span><span class="n">x</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">anscomb</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="kn">from</span> <span class="nn">numpy</span> <span class="k">import</span> <span class="o">*</span>
    <span class="n">x_stab</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">sqrt</span><span class="p">(</span><span class="n">x</span><span class="o">+</span><span class="p">(</span><span class="mi">3</span><span class="o">/</span><span class="mi">8</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">x_stab</span>

<span class="k">def</span> <span class="nf">inv_anscomb_nv</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="kn">from</span> <span class="nn">numpy</span> <span class="k">import</span> <span class="o">*</span>
    <span class="n">xinv</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">-</span> <span class="p">(</span><span class="mi">3</span><span class="o">/</span><span class="mi">8</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">xinv</span>


<span class="k">def</span> <span class="nf">inv_anscomb</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">n</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    <span class="kn">from</span> <span class="nn">numpy</span> <span class="k">import</span> <span class="o">*</span>
    <span class="n">i</span><span class="o">=</span><span class="mi">0</span>
    <span class="n">xinv</span> <span class="o">=</span> <span class="n">x</span><span class="o">*</span><span class="mi">0</span>
    <span class="k">if</span> <span class="n">n</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
        <span class="n">xinv</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="mi">4</span> <span class="o">+</span> <span class="p">(</span><span class="n">double</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">**-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">3</span><span class="o">/</span><span class="mi">32</span><span class="p">)</span> <span class="o">-</span> <span class="mi">11</span><span class="o">*</span><span class="p">(</span><span class="n">double</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">**-</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">double</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">**-</span><span class="mi">3</span><span class="p">)</span><span class="o">*</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">75</span><span class="o">/</span><span class="mi">128</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="o">/</span><span class="mi">8</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">n</span><span class="p">):</span>
            <span class="n">xinv</span> <span class="o">=</span> <span class="n">xinv</span> <span class="o">+</span> <span class="mi">2</span><span class="o">*</span><span class="n">sqrt</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">3</span><span class="o">/</span><span class="mi">8</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">x</span><span class="o">**</span><span class="n">i</span><span class="p">)</span><span class="o">*</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">x</span><span class="p">)</span><span class="o">/</span><span class="n">factorielle</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">xinv</span>

<span class="k">def</span> <span class="nf">compact_spike1d</span><span class="p">(</span><span class="n">rad</span><span class="p">,</span><span class="n">w</span><span class="p">,</span><span class="n">deg</span><span class="p">):</span>
    <span class="kn">from</span> <span class="nn">numpy</span> <span class="k">import</span> <span class="o">*</span>
    <span class="n">spike</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="mi">2</span><span class="o">*</span><span class="n">rad</span><span class="o">+</span><span class="mi">1</span><span class="p">,))</span>
    <span class="n">i</span><span class="o">=</span><span class="mi">0</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="o">*</span><span class="n">rad</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span><span class="n">spike</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">=</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="nb">abs</span><span class="p">((</span><span class="n">double</span><span class="p">(</span><span class="n">i</span><span class="o">-</span><span class="n">rad</span><span class="p">)</span><span class="o">/</span><span class="n">w</span><span class="p">))</span><span class="o">**</span><span class="p">(</span><span class="n">double</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="n">deg</span><span class="p">))</span><span class="o">*</span><span class="n">sinc</span><span class="p">(</span><span class="n">double</span><span class="p">(</span><span class="n">i</span><span class="o">-</span><span class="n">rad</span><span class="p">)</span><span class="o">/</span><span class="n">rad</span><span class="p">)</span>
    <span class="n">spike</span> <span class="o">=</span> <span class="n">spike</span><span class="o">/</span><span class="n">sqrt</span><span class="p">((</span><span class="n">spike</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span>
    <span class="k">return</span> <span class="n">spike</span>


<span class="k">def</span> <span class="nf">spike_transform</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">rad</span><span class="p">,</span><span class="n">nb_deg</span><span class="p">,</span><span class="n">nb_width</span><span class="p">,</span><span class="n">deg_min</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">deg_max</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span><span class="n">width_min</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span><span class="n">width_max</span><span class="o">=</span><span class="mi">20</span><span class="p">):</span>
    <span class="kn">import</span> <span class="nn">scipy.signal</span> <span class="k">as</span> <span class="nn">scisig</span>
    <span class="kn">from</span> <span class="nn">numpy</span> <span class="k">import</span> <span class="o">*</span>
    <span class="n">l</span> <span class="o">=</span> <span class="n">size</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">step_deg</span> <span class="o">=</span> <span class="n">double</span><span class="p">(</span><span class="n">deg_max</span><span class="o">-</span><span class="n">deg_min</span><span class="p">)</span><span class="o">/</span><span class="n">nb_deg</span>
    <span class="n">step_width</span> <span class="o">=</span> <span class="n">double</span><span class="p">(</span><span class="n">width_max</span><span class="o">-</span><span class="n">width_min</span><span class="p">)</span><span class="o">/</span><span class="n">nb_width</span>
    <span class="n">spike_coeff</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">l</span><span class="p">,</span><span class="n">nb_deg</span><span class="o">*</span><span class="n">nb_width</span><span class="p">))</span>
    <span class="n">i</span><span class="p">,</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span><span class="mi">0</span>
    <span class="n">spec_rad_approx</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_deg</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_width</span><span class="p">):</span>
            <span class="n">spike_ij</span> <span class="o">=</span> <span class="n">compact_spike1d</span><span class="p">(</span><span class="n">rad</span><span class="p">,</span><span class="n">double</span><span class="p">(</span><span class="n">rad</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">width_min</span><span class="o">+</span><span class="n">j</span><span class="o">*</span><span class="n">step_width</span><span class="p">),</span><span class="n">deg_min</span><span class="o">+</span><span class="n">i</span><span class="o">*</span><span class="n">step_deg</span><span class="p">)</span>
            <span class="n">spec_rad_approx</span> <span class="o">=</span> <span class="n">spec_rad_approx</span> <span class="o">+</span> <span class="p">(</span><span class="n">spike_ij</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span><span class="o">**</span><span class="mi">2</span>
            <span class="n">spike_coeff</span><span class="p">[:,</span><span class="n">j</span><span class="o">+</span><span class="n">i</span><span class="o">*</span><span class="n">nb_width</span><span class="p">]</span><span class="o">=</span> <span class="n">scisig</span><span class="o">.</span><span class="n">fftconvolve</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">spike_ij</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;same&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">spike_coeff</span><span class="p">,</span><span class="n">spec_rad_approx</span>


<span class="k">def</span> <span class="nf">spike_transform_transp</span><span class="p">(</span><span class="n">spike_coeff</span><span class="p">,</span><span class="n">rad</span><span class="p">,</span><span class="n">nb_deg</span><span class="p">,</span><span class="n">nb_width</span><span class="p">,</span><span class="n">deg_min</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">deg_max</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span><span class="n">width_min</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span><span class="n">width_max</span><span class="o">=</span><span class="mi">20</span><span class="p">):</span>
    <span class="kn">import</span> <span class="nn">scipy.signal</span> <span class="k">as</span> <span class="nn">scisig</span>
    <span class="kn">from</span> <span class="nn">numpy</span> <span class="k">import</span> <span class="o">*</span>
    <span class="n">step_deg</span> <span class="o">=</span> <span class="n">double</span><span class="p">(</span><span class="n">deg_max</span><span class="o">-</span><span class="n">deg_min</span><span class="p">)</span><span class="o">/</span><span class="n">nb_deg</span>
    <span class="n">step_width</span> <span class="o">=</span> <span class="n">double</span><span class="p">(</span><span class="n">width_max</span><span class="o">-</span><span class="n">width_min</span><span class="p">)</span><span class="o">/</span><span class="n">nb_width</span>
    <span class="n">l</span> <span class="o">=</span> <span class="n">spike_coeff</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">spike</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">l</span><span class="p">,))</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_deg</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_width</span><span class="p">):</span>
            <span class="n">spike_ij</span> <span class="o">=</span> <span class="n">compact_spike1d</span><span class="p">(</span><span class="n">rad</span><span class="p">,</span><span class="n">double</span><span class="p">(</span><span class="n">rad</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">width_min</span><span class="o">+</span><span class="n">j</span><span class="o">*</span><span class="n">step_width</span><span class="p">),</span><span class="n">deg_min</span><span class="o">+</span><span class="n">i</span><span class="o">*</span><span class="n">step_deg</span><span class="p">)</span>
            <span class="n">spike</span> <span class="o">=</span> <span class="n">spike</span><span class="o">+</span><span class="n">scisig</span><span class="o">.</span><span class="n">fftconvolve</span><span class="p">(</span><span class="n">spike_coeff</span><span class="p">[:,</span><span class="n">j</span><span class="o">+</span><span class="n">i</span><span class="o">*</span><span class="n">nb_width</span><span class="p">],</span> <span class="n">spike_ij</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;same&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">spike</span>


<span class="k">def</span> <span class="nf">noise_sim_spike</span><span class="p">(</span><span class="n">sig</span><span class="p">,</span><span class="nb">len</span><span class="p">,</span><span class="n">nb_mont</span><span class="p">,</span><span class="n">rad</span><span class="p">,</span><span class="n">nb_deg</span><span class="p">,</span><span class="n">nb_width</span><span class="p">,</span><span class="n">deg_min</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">deg_max</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span><span class="n">width_min</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span><span class="n">width_max</span><span class="o">=</span><span class="mi">20</span><span class="p">):</span>
    <span class="kn">from</span> <span class="nn">numpy</span> <span class="k">import</span> <span class="o">*</span>
    <span class="kn">from</span> <span class="nn">numpy.matlib</span> <span class="k">import</span> <span class="o">*</span>

    <span class="n">noise_vec</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">,</span><span class="n">nb_deg</span><span class="o">*</span><span class="n">nb_width</span><span class="p">))</span>
    <span class="n">sample</span> <span class="o">=</span> <span class="n">ndarray</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="nb">len</span><span class="p">,</span><span class="n">nb_deg</span><span class="o">*</span><span class="n">nb_width</span><span class="p">,</span><span class="n">nb_mont</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
    <span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="n">z</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_mont</span><span class="p">):</span>
        <span class="n">noise</span> <span class="o">=</span> <span class="n">sig</span><span class="o">*</span><span class="n">randn</span><span class="p">((</span><span class="nb">len</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>
        <span class="n">sample</span><span class="p">[:,:,</span><span class="n">k</span><span class="p">]</span><span class="o">=</span><span class="n">spike_transform</span><span class="p">(</span><span class="n">noise</span><span class="p">,</span><span class="n">rad</span><span class="p">,</span><span class="n">nb_deg</span><span class="p">,</span><span class="n">nb_width</span><span class="p">,</span><span class="n">deg_min</span><span class="p">,</span><span class="n">deg_max</span><span class="p">,</span><span class="n">width_min</span><span class="p">,</span><span class="n">width_max</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">z</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">len</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_deg</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_width</span><span class="p">):</span> <span class="n">noise_vec</span><span class="p">[</span><span class="n">z</span><span class="p">,</span><span class="n">j</span><span class="o">+</span><span class="n">i</span><span class="o">*</span><span class="n">nb_width</span><span class="p">]</span><span class="o">=</span><span class="n">std</span><span class="p">(</span><span class="n">sample</span><span class="p">[</span><span class="n">z</span><span class="p">,</span><span class="n">j</span><span class="o">+</span><span class="n">i</span><span class="o">*</span><span class="n">nb_width</span><span class="p">,:])</span>

    <span class="k">return</span> <span class="n">noise_vec</span>



<span class="k">def</span> <span class="nf">spike_analysis</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">rad</span><span class="p">,</span><span class="n">nb_deg</span><span class="p">,</span><span class="n">nb_width</span><span class="p">,</span><span class="n">mu</span><span class="p">,</span><span class="n">nb_iter</span><span class="p">,</span><span class="n">nsigma</span><span class="p">,</span><span class="n">sigma</span><span class="p">,</span><span class="n">thresh_type</span><span class="p">,</span><span class="n">nb_mont</span><span class="p">,</span><span class="n">pos_cons</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">deg_min</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">deg_max</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span><span class="n">width_min</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span><span class="n">width_max</span><span class="o">=</span><span class="mi">20</span><span class="p">):</span>
    <span class="n">U</span><span class="p">,</span><span class="n">spec_rad</span> <span class="o">=</span> <span class="n">spike_transform</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">rad</span><span class="p">,</span><span class="n">nb_deg</span><span class="p">,</span><span class="n">nb_width</span><span class="p">,</span><span class="n">deg_min</span><span class="p">,</span><span class="n">deg_max</span><span class="p">,</span><span class="n">width_min</span><span class="p">,</span><span class="n">width_max</span><span class="p">)</span>
    <span class="n">Urec</span> <span class="o">=</span> <span class="n">spike_transform_transp</span><span class="p">(</span><span class="n">U</span><span class="p">,</span><span class="n">rad</span><span class="p">,</span><span class="n">nb_deg</span><span class="p">,</span><span class="n">nb_width</span><span class="p">,</span><span class="n">deg_min</span><span class="p">,</span><span class="n">deg_max</span><span class="p">,</span><span class="n">width_min</span><span class="p">,</span><span class="n">width_max</span><span class="p">)</span>
    <span class="n">a</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span><span class="o">*</span><span class="n">Urec</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">/</span><span class="p">(</span><span class="n">Urec</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    <span class="n">U</span> <span class="o">=</span> <span class="n">a</span><span class="o">*</span><span class="n">U</span>
    <span class="c1">#U = U*0</span>
    <span class="kn">from</span> <span class="nn">numpy</span> <span class="k">import</span> <span class="o">*</span>
    <span class="n">n1</span> <span class="o">=</span> <span class="n">size</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">mse</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">nb_iter</span><span class="p">,))</span>
    <span class="n">V</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">n1</span><span class="p">,</span><span class="n">nb_deg</span><span class="o">*</span><span class="n">nb_width</span><span class="p">))</span>

    <span class="n">V_old</span> <span class="o">=</span> <span class="n">V</span>
    <span class="n">t</span><span class="o">=</span><span class="mi">1</span>
    <span class="n">told</span><span class="o">=</span><span class="n">t</span>
    <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">Urec</span> <span class="o">=</span> <span class="n">x</span><span class="o">*</span><span class="mi">0</span>
    <span class="c1">#noise_std = noise_sim_spike(sigma,n1,nb_mont,rad,nb_deg,nb_width,deg_min,deg_max,width_min,width_max)</span>
    <span class="c1">#noise_std = mu*noise_std/spec_rad</span>
    <span class="c1">#print noise_std</span>
    <span class="c1">#thresh = nsigma*noise_std</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_iter</span><span class="p">):</span>
        <span class="nb">print</span> <span class="n">i</span>
        <span class="n">Urec</span> <span class="o">=</span> <span class="n">spike_transform_transp</span><span class="p">(</span><span class="n">U</span><span class="p">,</span><span class="n">rad</span><span class="p">,</span><span class="n">nb_deg</span><span class="p">,</span><span class="n">nb_width</span><span class="p">,</span><span class="n">deg_min</span><span class="p">,</span><span class="n">deg_max</span><span class="p">,</span><span class="n">width_min</span><span class="p">,</span><span class="n">width_max</span><span class="p">)</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">x</span> <span class="o">-</span> <span class="n">Urec</span>
        <span class="n">mse</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">**</span><span class="mi">2</span>
        <span class="n">res_coeff</span><span class="p">,</span><span class="n">spec_rad</span> <span class="o">=</span> <span class="n">spike_transform</span><span class="p">(</span><span class="n">res</span><span class="p">,</span><span class="n">rad</span><span class="p">,</span><span class="n">nb_deg</span><span class="p">,</span><span class="n">nb_width</span><span class="p">,</span><span class="n">deg_min</span><span class="p">,</span><span class="n">deg_max</span><span class="p">,</span><span class="n">width_min</span><span class="p">,</span><span class="n">width_max</span><span class="p">)</span>
        <span class="n">grad</span> <span class="o">=</span> <span class="n">mu</span><span class="o">*</span><span class="n">res_coeff</span><span class="o">/</span><span class="n">spec_rad</span>
        <span class="n">Yi</span> <span class="o">=</span> <span class="n">U</span> <span class="o">+</span> <span class="n">grad</span>
        <span class="n">thresh</span> <span class="o">=</span> <span class="n">nsigma</span><span class="o">*</span><span class="n">mu</span><span class="o">*</span><span class="n">ones</span><span class="p">((</span><span class="n">n1</span><span class="p">,</span><span class="n">nb_deg</span><span class="o">*</span><span class="n">nb_width</span><span class="p">))</span><span class="o">/</span><span class="n">spec_rad</span>
        <span class="sd">&quot;&quot;&quot;ki,kj = 0,0</span>
<span class="sd">            for ki in range(0,nb_deg):</span>
<span class="sd">            for kj in range(0,nb_width):</span>
<span class="sd">            sigma = 1.4826*mad(grad[:,kj+ki*nb_width])</span>
<span class="sd">            print sigma</span>
<span class="sd">            thresh[:,kj+ki*nb_width] = nsigma*sigma*thresh[:,kj+ki*nb_width]&quot;&quot;&quot;</span>
        <span class="n">V</span> <span class="o">=</span> <span class="n">thresholding</span><span class="p">(</span><span class="n">Yi</span><span class="p">,</span><span class="n">thresh</span><span class="p">,</span><span class="n">thresh_type</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">pos_cons</span><span class="o">==</span><span class="kc">True</span><span class="p">:</span>
            <span class="n">ind</span> <span class="o">=</span> <span class="n">where</span><span class="p">(</span><span class="n">V</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">V</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span><span class="o">=</span><span class="mi">0</span>
        <span class="n">t</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">4</span><span class="o">*</span><span class="n">told</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span><span class="o">/</span><span class="mi">2</span>
        <span class="n">lamb</span> <span class="o">=</span> <span class="mi">1</span><span class="o">+</span><span class="p">(</span><span class="n">told</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="n">t</span>
        <span class="n">told</span> <span class="o">=</span> <span class="n">t</span>
        <span class="n">U</span> <span class="o">=</span> <span class="n">V_old</span> <span class="o">+</span> <span class="n">lamb</span><span class="o">*</span><span class="p">(</span><span class="n">V</span><span class="o">-</span><span class="n">V_old</span><span class="p">)</span>
        <span class="n">V_old</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">V</span><span class="p">)</span>
    <span class="n">Urec</span> <span class="o">=</span> <span class="n">spike_transform_transp</span><span class="p">(</span><span class="n">U</span><span class="p">,</span><span class="n">rad</span><span class="p">,</span><span class="n">nb_deg</span><span class="p">,</span><span class="n">nb_width</span><span class="p">,</span><span class="n">deg_min</span><span class="p">,</span><span class="n">deg_max</span><span class="p">,</span><span class="n">width_min</span><span class="p">,</span><span class="n">width_max</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">Urec</span><span class="p">,</span><span class="n">mse</span>

<div class="viewcode-block" id="mad"><a class="viewcode-back" href="../utils.html#utils.mad">[docs]</a><span class="k">def</span> <span class="nf">mad</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Computes MAD.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">numpy</span> <span class="k">import</span> <span class="o">*</span>
    <span class="k">return</span> <span class="n">median</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">x</span><span class="o">-</span><span class="n">median</span><span class="p">(</span><span class="n">x</span><span class="p">)))</span></div>

<div class="viewcode-block" id="cartesian_product"><a class="viewcode-back" href="../utils.html#utils.cartesian_product">[docs]</a><span class="k">def</span> <span class="nf">cartesian_product</span><span class="p">(</span><span class="n">arrays</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;**[???]***&quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">numpy</span>
    <span class="n">broadcastable</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ix_</span><span class="p">(</span><span class="o">*</span><span class="n">arrays</span><span class="p">)</span>
    <span class="n">broadcasted</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">broadcast_arrays</span><span class="p">(</span><span class="o">*</span><span class="n">broadcastable</span><span class="p">)</span>
    <span class="n">rows</span><span class="p">,</span> <span class="n">cols</span> <span class="o">=</span> <span class="n">reduce</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">multiply</span><span class="p">,</span> <span class="n">broadcasted</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">broadcasted</span><span class="p">)</span>
    <span class="n">out</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">rows</span> <span class="o">*</span> <span class="n">cols</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">broadcasted</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
    <span class="n">start</span><span class="p">,</span> <span class="n">end</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">rows</span>
    <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">broadcasted</span><span class="p">:</span>
        <span class="n">out</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">end</span><span class="p">]</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">start</span><span class="p">,</span> <span class="n">end</span> <span class="o">=</span> <span class="n">end</span><span class="p">,</span> <span class="n">end</span> <span class="o">+</span> <span class="n">rows</span>
    <span class="k">return</span> <span class="n">out</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">cols</span><span class="p">,</span> <span class="n">rows</span><span class="p">)</span><span class="o">.</span><span class="n">T</span></div>

<div class="viewcode-block" id="get_noise"><a class="viewcode-back" href="../utils.html#utils.get_noise">[docs]</a><span class="k">def</span> <span class="nf">get_noise</span><span class="p">(</span><span class="n">im</span><span class="p">,</span><span class="n">nb_iter</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span><span class="n">k</span><span class="o">=</span><span class="mi">3</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Estimate noise level for one given image through one soft thresholding iterations.</span>
<span class="sd">    See SPRITE paper, appendix... I want to say A.</span>
<span class="sd">    </span>
<span class="sd">    Calls:</span>
<span class="sd">    </span>
<span class="sd">    * :func:`utils.mad`</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">sig</span> <span class="o">=</span> <span class="mf">1.4826</span><span class="o">*</span><span class="n">mad</span><span class="p">(</span><span class="n">im</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_iter</span><span class="p">):</span>
        <span class="n">im_thresh</span> <span class="o">=</span> <span class="n">im</span><span class="o">*</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">im</span><span class="p">)</span><span class="o">&gt;</span><span class="n">k</span><span class="o">*</span><span class="n">sig</span><span class="p">)</span>
        <span class="n">sig</span> <span class="o">=</span> <span class="mf">1.4826</span><span class="o">*</span><span class="n">mad</span><span class="p">(</span><span class="n">im</span><span class="o">-</span><span class="n">im_thresh</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">sig</span></div>

<div class="viewcode-block" id="get_noise_arr"><a class="viewcode-back" href="../utils.html#utils.get_noise_arr">[docs]</a><span class="k">def</span> <span class="nf">get_noise_arr</span><span class="p">(</span><span class="n">arr</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Estimate noise for each of a set of image.</span>
<span class="sd">    </span>
<span class="sd">    Calls:</span>

<span class="sd">    * :func:`utils.cartesian_product`</span>
<span class="sd">    * :func:`utils.get_noise`</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">shap</span> <span class="o">=</span> <span class="n">arr</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">ind</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">:]:</span>
        <span class="n">ind</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">i</span><span class="p">))</span>
    <span class="n">coord</span> <span class="o">=</span> <span class="n">cartesian_product</span><span class="p">(</span><span class="n">ind</span><span class="p">)</span>
    <span class="n">noise_map</span> <span class="o">=</span> <span class="n">ones</span><span class="p">(</span><span class="n">arr</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
    <span class="n">s</span> <span class="o">=</span> <span class="nb">slice</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span> <span class="c1"># equivalent to &#39;:</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">coord</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
        <span class="n">sig</span> <span class="o">=</span> <span class="n">get_noise</span><span class="p">(</span><span class="n">arr</span><span class="p">[(</span><span class="n">s</span><span class="p">,</span><span class="n">s</span><span class="p">)</span><span class="o">+</span><span class="nb">tuple</span><span class="p">(</span><span class="n">coord</span><span class="p">[</span><span class="n">i</span><span class="p">,:])])</span>
        <span class="n">noise_map</span><span class="p">[(</span><span class="n">s</span><span class="p">,</span><span class="n">s</span><span class="p">)</span><span class="o">+</span><span class="nb">tuple</span><span class="p">(</span><span class="n">coord</span><span class="p">[</span><span class="n">i</span><span class="p">,:])]</span><span class="o">*=</span><span class="n">sig</span>

    <span class="k">return</span> <span class="n">noise_map</span></div>

<span class="k">def</span> <span class="nf">PCA</span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="n">nb_comp</span><span class="p">,</span><span class="n">mean_sub</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span> <span class="c1"># Rows represent obsrvations and columns represent the variables</span>
    <span class="kn">import</span> <span class="nn">numpy.ma</span> <span class="k">as</span> <span class="nn">npma</span>
    <span class="kn">from</span> <span class="nn">numpy</span> <span class="k">import</span> <span class="o">*</span>
    <span class="kn">import</span> <span class="nn">scipy.linalg</span> <span class="k">as</span> <span class="nn">LA</span>
    <span class="n">siz</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">mean_data</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span><span class="n">siz</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
    <span class="k">if</span> <span class="n">mean_sub</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">k</span><span class="o">=</span><span class="mi">0</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">siz</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
            <span class="n">mean_data</span> <span class="o">=</span> <span class="n">mean_data</span> <span class="o">+</span> <span class="n">data</span><span class="p">[</span><span class="n">k</span><span class="p">,:]</span>
        <span class="n">mean_data</span> <span class="o">=</span> <span class="n">mean_data</span><span class="o">/</span><span class="n">siz</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">data_cp</span> <span class="o">=</span> <span class="n">data</span> <span class="o">-</span> <span class="n">npma</span><span class="o">.</span><span class="n">outerproduct</span><span class="p">(</span><span class="n">ones</span><span class="p">((</span><span class="n">siz</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="mi">1</span><span class="p">)),</span><span class="n">mean_data</span><span class="p">)</span>
    <span class="n">cov_mat</span> <span class="o">=</span> <span class="n">transpose</span><span class="p">(</span><span class="n">data_cp</span><span class="p">)</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">data_cp</span><span class="p">)</span><span class="o">/</span><span class="n">siz</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="c1">#print &#39;PCA start&#39;</span>
    <span class="n">w</span><span class="p">,</span><span class="n">v</span> <span class="o">=</span> <span class="n">LA</span><span class="o">.</span><span class="n">eigh</span><span class="p">(</span><span class="n">cov_mat</span><span class="p">,</span><span class="n">eigvals</span><span class="o">=</span><span class="p">(</span><span class="n">siz</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">nb_comp</span><span class="p">,</span><span class="n">siz</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>
    <span class="n">coeff</span> <span class="o">=</span> <span class="n">data_cp</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
    <span class="c1">#print &#39;PCA done&#39;</span>
    <span class="k">return</span> <span class="n">w</span><span class="p">,</span><span class="n">v</span><span class="p">,</span><span class="n">coeff</span><span class="p">,</span><span class="n">mean_data</span>

<span class="k">def</span> <span class="nf">SVD_interf</span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="n">nb_comp</span><span class="p">,</span><span class="n">mean_sub</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">coeff_comp</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span> <span class="c1"># Rows represent obsrvations and columns represent the variables</span>
    <span class="kn">import</span> <span class="nn">numpy.ma</span> <span class="k">as</span> <span class="nn">npma</span>
    <span class="n">siz</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">mean_data</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span><span class="n">siz</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
    <span class="n">data_cp</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">mean_sub</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">k</span><span class="o">=</span><span class="mi">0</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">siz</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
            <span class="n">mean_data</span> <span class="o">=</span> <span class="n">mean_data</span> <span class="o">+</span> <span class="n">data</span><span class="p">[</span><span class="n">k</span><span class="p">,:]</span>
        <span class="n">mean_data</span> <span class="o">=</span> <span class="n">mean_data</span><span class="o">/</span><span class="n">siz</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">data_cp</span> <span class="o">=</span> <span class="n">data</span> <span class="o">-</span> <span class="n">npma</span><span class="o">.</span><span class="n">outerproduct</span><span class="p">(</span><span class="n">ones</span><span class="p">((</span><span class="n">siz</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="mi">1</span><span class="p">)),</span><span class="n">mean_data</span><span class="p">)</span>
    <span class="n">U</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">Vt</span> <span class="o">=</span> <span class="n">linalg</span><span class="o">.</span><span class="n">svd</span><span class="p">(</span><span class="n">data_cp</span><span class="p">,</span><span class="n">full_matrices</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">eig_vect</span> <span class="o">=</span> <span class="n">transpose</span><span class="p">(</span><span class="n">Vt</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">nb_comp</span><span class="p">,:])</span>
    <span class="n">w</span> <span class="o">=</span> <span class="n">s</span><span class="o">**</span><span class="mi">2</span>
    <span class="n">coeff</span><span class="o">=</span><span class="kc">None</span>
    <span class="k">if</span> <span class="n">coeff_comp</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">coeff</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">eig_vect</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">w</span><span class="p">,</span><span class="n">eig_vect</span><span class="p">,</span><span class="n">coeff</span><span class="p">,</span><span class="n">mean_data</span>

<div class="viewcode-block" id="cube_svd"><a class="viewcode-back" href="../utils.html#utils.cube_svd">[docs]</a><span class="k">def</span> <span class="nf">cube_svd</span><span class="p">(</span><span class="n">cube</span><span class="p">,</span><span class="n">nb_comp</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">ind</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">mean_sub</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Performs PCA as initialization.</span>
<span class="sd">    </span>
<span class="sd">    #TODO: replace with Scikit Learn version? Pretty sure this is where RCA crashes with</span>
<span class="sd">    too many inputs</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">shap</span> <span class="o">=</span> <span class="n">cube</span><span class="o">.</span><span class="n">shape</span>
    <span class="k">if</span> <span class="n">nb_comp</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">nb_comp</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
    <span class="n">mat</span> <span class="o">=</span> <span class="n">cube</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>
    <span class="n">data_mean</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">centered_data</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">ind</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">ind</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
    <span class="k">if</span> <span class="n">mean_sub</span><span class="p">:</span>
        <span class="n">data_mean</span> <span class="o">=</span> <span class="n">cube</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">mat</span> <span class="o">-=</span> <span class="n">data_mean</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">ones</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">])))</span>
        <span class="n">centered_data</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">cube</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
            <span class="n">centered_data</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">]</span><span class="o">-=</span><span class="n">data_mean</span>
    <span class="n">U</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">Vt</span> <span class="o">=</span> <span class="n">svd</span><span class="p">(</span><span class="n">mat</span><span class="p">[:,</span><span class="n">ind</span><span class="p">],</span><span class="n">full_matrices</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">shap_u</span> <span class="o">=</span> <span class="n">U</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">coeff</span> <span class="o">=</span> <span class="n">transpose</span><span class="p">(</span><span class="n">U</span><span class="p">[:,</span><span class="mi">0</span><span class="p">:</span><span class="n">nb_comp</span><span class="p">])</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">mat</span><span class="p">)</span>
    <span class="n">approx</span> <span class="o">=</span> <span class="n">U</span><span class="p">[:,</span><span class="mi">0</span><span class="p">:</span><span class="n">nb_comp</span><span class="p">]</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">coeff</span><span class="p">)</span>
    <span class="n">comp_cube</span> <span class="o">=</span> <span class="n">U</span><span class="p">[:,</span><span class="mi">0</span><span class="p">:</span><span class="n">nb_comp</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="nb">min</span><span class="p">(</span><span class="n">nb_comp</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">])))</span>
    <span class="n">approx_cube</span> <span class="o">=</span>  <span class="n">approx</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>
    <span class="k">if</span> <span class="n">mean_sub</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">coeff</span><span class="p">,</span><span class="n">comp_cube</span><span class="p">,</span><span class="n">approx_cube</span><span class="p">,</span><span class="n">data_mean</span><span class="p">,</span><span class="n">centered_data</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">coeff</span><span class="p">,</span><span class="n">comp_cube</span><span class="p">,</span><span class="n">approx_cube</span></div>

<span class="k">def</span> <span class="nf">cube_svd_m</span><span class="p">(</span><span class="n">cube</span><span class="p">,</span><span class="n">nb_comp</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="n">shap</span> <span class="o">=</span> <span class="n">cube</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">est</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">cube</span><span class="p">)</span><span class="o">*</span><span class="mi">0</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">4</span><span class="p">]):</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">3</span><span class="p">]):</span>
            <span class="nb">print</span> <span class="s2">&quot;==============================================&quot;</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="s2">&quot;/&quot;</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span><span class="s2">&quot;=======================================================&quot;</span>
            <span class="n">coeff</span><span class="p">,</span><span class="n">comp_cube</span><span class="p">,</span><span class="n">approx_cube</span> <span class="o">=</span> <span class="n">cube_svd</span><span class="p">(</span><span class="n">cube</span><span class="p">[:,:,:,</span><span class="n">j</span><span class="p">,</span><span class="n">i</span><span class="p">],</span><span class="n">nb_comp</span><span class="o">=</span><span class="n">nb_comp</span><span class="p">)</span>
            <span class="n">est</span><span class="p">[:,:,:,</span><span class="n">j</span><span class="p">,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">approx_cube</span>
    <span class="k">return</span> <span class="n">est</span>

<span class="sd">&quot;&quot;&quot;def psf_interp(psf,data_pos,method=&quot;spline&quot;,nb_comp=20):</span>
<span class="sd">    coeff,comp_cube,approx_cube = cube_svd(psf,nb_comp=nb_comp)</span>
<span class="sd">    interpolator  = list()</span>
<span class="sd">    x =</span>
<span class="sd">    for i in range(0,nb_comp):&quot;&quot;&quot;</span>





<span class="k">def</span> <span class="nf">shape_dict_coeff</span><span class="p">(</span><span class="n">im</span><span class="p">,</span><span class="nb">dict</span><span class="p">,</span><span class="n">mean_sub</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span> <span class="c1"># We assume that the dictionary columns represent the atoms</span>
    <span class="kn">from</span> <span class="nn">numpy</span> <span class="k">import</span> <span class="o">*</span>
    <span class="n">n</span> <span class="o">=</span> <span class="n">im</span><span class="o">.</span><span class="n">size</span>
    <span class="n">data_mat_shape</span> <span class="o">=</span> <span class="n">mat_mm_ell</span><span class="p">(</span><span class="n">im</span><span class="p">)</span>
    <span class="n">data_mat_vec</span> <span class="o">=</span> <span class="n">data_mat_shape</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">6</span><span class="o">*</span><span class="n">n</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">mean_sub</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="n">data_mat_vec</span> <span class="o">=</span> <span class="n">data_mat_vec</span><span class="o">-</span><span class="n">transpose</span><span class="p">(</span><span class="nb">dict</span><span class="p">[:,</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">coeff_temp</span> <span class="o">=</span> <span class="n">data_mat_vec</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="nb">dict</span><span class="p">)</span>
    <span class="n">coeff</span> <span class="o">=</span> <span class="n">coeff_temp</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">:]</span>
    <span class="k">return</span> <span class="n">coeff</span>

<span class="k">def</span> <span class="nf">err_ell_trunc</span><span class="p">(</span><span class="n">im</span><span class="p">,</span><span class="nb">dict</span><span class="p">,</span><span class="n">nb_comp</span><span class="p">,</span><span class="n">mean_sub</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="kn">from</span> <span class="nn">numpy</span> <span class="k">import</span> <span class="o">*</span>
    <span class="n">coeff</span> <span class="o">=</span> <span class="n">shape_dict_coeff</span><span class="p">(</span><span class="n">im</span><span class="p">,</span><span class="nb">dict</span><span class="p">,</span><span class="n">mean_sub</span><span class="o">=</span><span class="n">mean_sub</span><span class="p">)</span>

    <span class="n">n</span> <span class="o">=</span> <span class="n">im</span><span class="o">.</span><span class="n">size</span>
    <span class="n">l</span> <span class="o">=</span> <span class="n">coeff</span><span class="o">.</span><span class="n">size</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">l</span><span class="o">-</span><span class="n">nb_comp</span><span class="p">):</span>
        <span class="n">coeff</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">=</span><span class="mi">0</span>
    <span class="n">mat_shape_approx_vec</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">mean_sub</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">mat_shape_approx_vec</span> <span class="o">=</span> <span class="n">coeff</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">transpose</span><span class="p">(</span><span class="nb">dict</span><span class="p">[:,</span><span class="mi">1</span><span class="p">:]))</span>
        <span class="n">mat_shape_approx_vec</span> <span class="o">=</span> <span class="n">mat_shape_approx_vec</span><span class="o">+</span><span class="n">transpose</span><span class="p">(</span><span class="nb">dict</span><span class="p">[:,</span><span class="mi">0</span><span class="p">])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">mat_shape_approx_vec</span> <span class="o">=</span> <span class="n">coeff</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">transpose</span><span class="p">(</span><span class="nb">dict</span><span class="p">))</span>
    <span class="n">mat_shape_approx</span> <span class="o">=</span> <span class="n">mat_shape_approx_vec</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="n">n</span><span class="p">)</span>
    <span class="n">centroid</span><span class="p">,</span><span class="n">U</span><span class="p">,</span><span class="n">ell</span><span class="o">=</span> <span class="n">mk_ellipticity_atoms</span><span class="p">(</span><span class="n">im</span><span class="p">)</span>
    <span class="n">ell_approx</span> <span class="o">=</span> <span class="n">mk_ellipticity_atoms_basic</span><span class="p">(</span><span class="n">mat_shape_approx</span><span class="p">[:,(</span><span class="n">n</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">])</span>
    <span class="n">err</span> <span class="o">=</span> <span class="mi">100</span><span class="o">*</span><span class="p">(</span><span class="n">ell</span><span class="o">-</span><span class="n">ell_approx</span><span class="p">)</span><span class="o">/</span><span class="n">ell</span>
    <span class="k">return</span> <span class="n">ell</span><span class="p">,</span><span class="n">ell_approx</span><span class="p">,</span><span class="n">err</span>

<span class="k">def</span> <span class="nf">laplace_gal_PCA_coeff_fitting</span><span class="p">(</span><span class="n">coeff</span><span class="p">):</span>
    <span class="kn">from</span> <span class="nn">numpy</span> <span class="k">import</span> <span class="o">*</span>
    <span class="kn">import</span> <span class="nn">scipy.stats</span> <span class="k">as</span> <span class="nn">scisig_stat</span>
    <span class="n">siz</span> <span class="o">=</span> <span class="n">coeff</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">scale_vect</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">siz</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="mi">1</span><span class="p">))</span>
    <span class="n">i</span><span class="o">=</span><span class="mi">0</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">siz</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
        <span class="n">loc</span><span class="p">,</span><span class="n">scale</span> <span class="o">=</span> <span class="n">scisig_stat</span><span class="o">.</span><span class="n">laplace</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">coeff</span><span class="p">[:,</span><span class="n">i</span><span class="p">])</span>
        <span class="nb">print</span> <span class="n">scale</span>
        <span class="n">scale_vect</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">=</span><span class="n">scale</span>
    <span class="n">hist</span><span class="p">,</span><span class="n">edges</span> <span class="o">=</span> <span class="n">histogram</span><span class="p">(</span><span class="n">coeff</span><span class="p">[:,</span><span class="n">siz</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">bins</span><span class="o">=</span><span class="n">siz</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="mi">100</span><span class="p">)</span>
    <span class="n">i</span> <span class="o">=</span> <span class="n">where</span><span class="p">(</span><span class="n">hist</span><span class="o">==</span><span class="nb">max</span><span class="p">(</span><span class="n">hist</span><span class="p">))</span>
    <span class="n">j</span> <span class="o">=</span> <span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">cent</span> <span class="o">=</span> <span class="p">(</span><span class="n">edges</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">+</span><span class="n">edges</span><span class="p">[</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">])</span><span class="o">/</span><span class="mi">2</span>
    <span class="n">siz_2</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">hist</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    <span class="n">coeff_sym</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">siz_2</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>
    <span class="n">k</span><span class="o">=</span><span class="mi">0</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">siz_2</span><span class="o">/</span><span class="mi">2</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">coeff</span><span class="p">[</span><span class="n">k</span><span class="p">,</span><span class="n">siz</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">cent</span><span class="p">:</span>
            <span class="n">coeff_sym</span><span class="p">[</span><span class="mi">2</span><span class="o">*</span><span class="n">k</span><span class="p">]</span><span class="o">=</span> <span class="n">coeff</span><span class="p">[</span><span class="n">k</span><span class="p">,</span><span class="n">siz</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">coeff_sym</span><span class="p">[</span><span class="mi">2</span><span class="o">*</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">=</span> <span class="o">-</span><span class="n">coeff</span><span class="p">[</span><span class="n">k</span><span class="p">,</span><span class="n">siz</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">loc</span><span class="p">,</span><span class="n">scale</span> <span class="o">=</span> <span class="n">scisig_stat</span><span class="o">.</span><span class="n">laplace</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">coeff_sym</span><span class="p">,</span><span class="n">loc</span><span class="o">=</span><span class="n">cent</span><span class="p">,</span><span class="n">scale</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">scale_vect</span><span class="p">[</span><span class="n">siz</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">=</span><span class="n">scale</span>
    <span class="n">max_1st_comp</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">coeff</span><span class="p">[:,</span><span class="n">siz</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">mean_1st_comp</span><span class="o">=</span><span class="n">cent</span>
    <span class="k">return</span> <span class="n">scale_vect</span><span class="p">,</span><span class="n">max_1st_comp</span><span class="p">,</span><span class="n">mean_1st_comp</span>

<span class="k">def</span> <span class="nf">sarah_poisson_filt</span><span class="p">(</span><span class="n">signal</span><span class="p">,</span><span class="n">nb_iter</span><span class="p">,</span><span class="n">thresh</span><span class="p">,</span><span class="n">thresh_type</span><span class="p">,</span><span class="n">pos_cons</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">mu</span><span class="o">=</span><span class="mf">0.9</span><span class="p">):</span>
    <span class="kn">from</span> <span class="nn">numpy</span> <span class="k">import</span> <span class="o">*</span>
    <span class="c1"># Anscombe transform</span>
    <span class="n">sig_stab</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">sqrt</span><span class="p">(</span><span class="n">signal</span><span class="o">+</span><span class="p">(</span><span class="mi">3</span><span class="o">/</span><span class="mi">8</span><span class="p">))</span>
    <span class="c1"># Offset removing</span>
    <span class="n">off</span> <span class="o">=</span> <span class="n">median</span><span class="p">(</span><span class="n">sig_stab</span><span class="p">)</span>
    <span class="n">sig_stab</span> <span class="o">=</span> <span class="n">sig_stab</span> <span class="o">-</span> <span class="n">off</span>
    <span class="c1"># Transformed signal filtering</span>
    <span class="n">i</span><span class="o">=</span><span class="mi">0</span>
    <span class="n">mse</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">nb_iter</span><span class="p">,))</span>
    <span class="n">filt_sig</span> <span class="o">=</span> <span class="n">sig_stab</span>
    <span class="c1"># Signal restoration</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_iter</span><span class="p">):</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">sig_stab</span> <span class="o">-</span> <span class="n">filt_sig</span>
        <span class="n">mse</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">res</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="n">filt_sig</span> <span class="o">=</span> <span class="n">filt_sig</span> <span class="o">+</span> <span class="n">mu</span><span class="o">*</span><span class="n">res</span>
        <span class="c1"># Sparsity constraint</span>
        <span class="n">filt_sig</span> <span class="o">=</span> <span class="n">thresholding</span><span class="p">(</span><span class="n">filt_sig</span><span class="p">,</span><span class="n">thresh</span><span class="p">,</span><span class="n">thresh_type</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">pos_cons</span><span class="o">==</span><span class="kc">True</span><span class="p">:</span>
            <span class="n">ind</span> <span class="o">=</span> <span class="n">where</span><span class="p">(</span><span class="n">filt_sig</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">filt_sig</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span><span class="o">=</span><span class="mi">0</span>
    <span class="n">sig_stab</span> <span class="o">=</span> <span class="n">filt_sig</span><span class="o">+</span><span class="n">off</span>
    <span class="n">signal_filt</span> <span class="o">=</span> <span class="p">(</span><span class="n">sig_stab</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">-</span> <span class="mi">3</span><span class="o">/</span><span class="mi">8</span>
    <span class="k">return</span> <span class="n">signal_filt</span><span class="p">,</span><span class="n">mse</span>

<span class="k">def</span> <span class="nf">sarah_poisson_filt_2</span><span class="p">(</span><span class="n">signal</span><span class="p">,</span><span class="n">nb_iter</span><span class="p">,</span><span class="n">pos_cons</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">mu</span><span class="o">=</span><span class="mf">0.9</span><span class="p">,</span><span class="n">opt</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="kn">from</span> <span class="nn">numpy</span> <span class="k">import</span> <span class="o">*</span>
    <span class="c1"># Anscombe transform</span>
    <span class="n">sig_stab</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">sqrt</span><span class="p">(</span><span class="n">signal</span><span class="o">+</span><span class="p">(</span><span class="mi">3</span><span class="o">/</span><span class="mi">8</span><span class="p">))</span>
    <span class="c1"># Offset removing</span>
    <span class="n">off</span> <span class="o">=</span> <span class="n">median</span><span class="p">(</span><span class="n">sig_stab</span><span class="p">)</span>
    <span class="n">sig_stab</span> <span class="o">=</span> <span class="n">sig_stab</span> <span class="o">-</span> <span class="n">off</span>
    <span class="c1"># Transformed signal filtering</span>
    <span class="n">i</span><span class="o">=</span><span class="mi">0</span>
    <span class="n">mse</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">nb_iter</span><span class="p">,))</span>
    <span class="n">filt_sig</span> <span class="o">=</span> <span class="n">sig_stab</span>
    <span class="c1"># Signal restoration</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">pos_cons</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">opt</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">mu</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_iter</span><span class="p">):</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">sig_stab</span> <span class="o">-</span> <span class="n">filt_sig</span>
        <span class="n">mse</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">res</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="n">filt_sig</span> <span class="o">=</span> <span class="n">filt_sig</span> <span class="o">+</span> <span class="n">mu</span><span class="o">*</span><span class="n">res</span>
        <span class="c1"># Sparsity constraint</span>
        <span class="n">filt_sig</span> <span class="o">=</span> <span class="n">isap</span><span class="o">.</span><span class="n">mr1d_filter</span><span class="p">(</span><span class="n">filt_sig</span><span class="p">,</span> <span class="n">opt</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">pos_cons</span><span class="o">==</span><span class="kc">True</span><span class="p">:</span>
            <span class="n">ind</span> <span class="o">=</span> <span class="n">where</span><span class="p">(</span><span class="n">filt_sig</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">filt_sig</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span><span class="o">=</span><span class="mi">0</span>
    <span class="n">sig_stab</span> <span class="o">=</span> <span class="n">filt_sig</span><span class="o">+</span><span class="n">off</span>
    <span class="n">signal_filt</span> <span class="o">=</span> <span class="p">(</span><span class="n">sig_stab</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">-</span> <span class="mi">3</span><span class="o">/</span><span class="mi">8</span>
    <span class="k">return</span> <span class="n">signal_filt</span><span class="p">,</span><span class="n">mse</span>


<span class="k">def</span> <span class="nf">sarah_poisson_filt_3</span><span class="p">(</span><span class="n">signal</span><span class="p">,</span><span class="n">nb_iter</span><span class="p">,</span><span class="n">nsigma</span><span class="p">,</span><span class="n">thresh_type</span><span class="p">,</span><span class="n">pos_cons</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">mu</span><span class="o">=</span><span class="mf">0.9</span><span class="p">,</span><span class="n">opt</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="kn">from</span> <span class="nn">numpy</span> <span class="k">import</span> <span class="o">*</span>
    <span class="c1"># Anscombe transform</span>
    <span class="n">sig_stab</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">sqrt</span><span class="p">(</span><span class="n">signal</span><span class="o">+</span><span class="p">(</span><span class="mi">3</span><span class="o">/</span><span class="mi">8</span><span class="p">))</span>
    <span class="c1"># Offset removing</span>
    <span class="n">off</span> <span class="o">=</span> <span class="n">median</span><span class="p">(</span><span class="n">sig_stab</span><span class="p">)</span>
    <span class="n">sig_stab</span> <span class="o">=</span> <span class="n">sig_stab</span> <span class="o">-</span> <span class="n">off</span>
    <span class="c1"># Transformed signal filtering</span>
    <span class="n">i</span><span class="o">=</span><span class="mi">0</span>
    <span class="n">mse</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">nb_iter</span><span class="p">,))</span>
    <span class="n">filt_sig</span> <span class="o">=</span> <span class="n">sig_stab</span>
    <span class="c1"># Signal restoration</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">pos_cons</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">opt</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">mu</span><span class="p">)</span>
    <span class="n">info_filename</span> <span class="o">=</span> <span class="s2">&quot;temp_info.mr&quot;</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_iter</span><span class="p">):</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">sig_stab</span> <span class="o">-</span> <span class="n">filt_sig</span>
        <span class="n">mse</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">res</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="n">filt_sig</span> <span class="o">=</span> <span class="n">filt_sig</span> <span class="o">+</span> <span class="n">mu</span><span class="o">*</span><span class="n">res</span>
        <span class="c1"># Sparsity constraint</span>
        <span class="n">filt_sig</span> <span class="o">=</span> <span class="n">isap</span><span class="o">.</span><span class="n">mr1d_filter_beta</span><span class="p">(</span><span class="n">filt_sig</span><span class="p">,</span> <span class="n">info_filename</span><span class="p">,</span><span class="n">nsigma</span><span class="p">,</span><span class="n">thresh_type</span><span class="p">,</span><span class="n">opt</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">pos_cons</span><span class="o">==</span><span class="kc">True</span><span class="p">:</span>
            <span class="n">ind</span> <span class="o">=</span> <span class="n">where</span><span class="p">(</span><span class="n">filt_sig</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">filt_sig</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span><span class="o">=</span><span class="mi">0</span>
    <span class="n">sig_stab</span> <span class="o">=</span> <span class="n">filt_sig</span><span class="o">+</span><span class="n">off</span>
    <span class="n">signal_filt</span> <span class="o">=</span> <span class="p">(</span><span class="n">sig_stab</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">-</span> <span class="mi">3</span><span class="o">/</span><span class="mi">8</span>
    <span class="k">return</span> <span class="n">signal_filt</span><span class="p">,</span><span class="n">mse</span>



<span class="k">def</span> <span class="nf">convol_check</span><span class="p">(</span><span class="n">im1</span><span class="p">,</span><span class="n">im2</span><span class="p">):</span>
    <span class="kn">from</span> <span class="nn">numpy</span> <span class="k">import</span> <span class="o">*</span>
    <span class="n">n1</span> <span class="o">=</span> <span class="n">im1</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">n2</span> <span class="o">=</span> <span class="n">im1</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">out</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">n1</span><span class="p">,</span><span class="n">n2</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">n1</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">n2</span><span class="p">):</span>
            <span class="n">bi</span> <span class="o">=</span> <span class="n">array</span><span class="p">([</span><span class="o">-</span><span class="n">i</span><span class="p">,</span><span class="o">-</span><span class="p">(</span><span class="n">n1</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">])</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
            <span class="n">bj</span> <span class="o">=</span> <span class="n">array</span><span class="p">([</span><span class="o">-</span><span class="n">j</span><span class="p">,</span><span class="o">-</span><span class="p">(</span><span class="n">n2</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">])</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
            <span class="n">ej</span> <span class="o">=</span> <span class="n">array</span><span class="p">([</span><span class="n">n2</span><span class="o">-</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">,(</span><span class="n">n2</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">])</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
            <span class="n">ei</span> <span class="o">=</span> <span class="n">array</span><span class="p">([</span><span class="n">n1</span><span class="o">-</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">,(</span><span class="n">n1</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">])</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">bi</span><span class="p">,</span><span class="n">ei</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">bj</span><span class="p">,</span><span class="n">ej</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
                    <span class="n">out</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">out</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span><span class="o">+</span><span class="n">im1</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="n">k</span><span class="p">,</span><span class="n">j</span><span class="o">+</span><span class="n">l</span><span class="p">]</span><span class="o">*</span><span class="n">im2</span><span class="p">[</span><span class="o">-</span><span class="n">k</span><span class="o">+</span><span class="p">(</span><span class="n">n1</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span><span class="o">-</span><span class="n">l</span><span class="o">+</span><span class="p">(</span><span class="n">n2</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">out</span>


<span class="k">def</span> <span class="nf">correl_check</span><span class="p">(</span><span class="n">im1</span><span class="p">,</span><span class="n">im2</span><span class="p">):</span>
    <span class="kn">from</span> <span class="nn">numpy</span> <span class="k">import</span> <span class="o">*</span>
    <span class="n">n1</span> <span class="o">=</span> <span class="n">im1</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">n2</span> <span class="o">=</span> <span class="n">im1</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">out</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">n1</span><span class="p">,</span><span class="n">n2</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">n1</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">n2</span><span class="p">):</span>
            <span class="n">bi</span> <span class="o">=</span> <span class="n">array</span><span class="p">([</span><span class="o">-</span><span class="n">i</span><span class="p">,</span><span class="o">-</span><span class="p">(</span><span class="n">n1</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">])</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
            <span class="n">bj</span> <span class="o">=</span> <span class="n">array</span><span class="p">([</span><span class="o">-</span><span class="n">j</span><span class="p">,</span><span class="o">-</span><span class="p">(</span><span class="n">n2</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">])</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
            <span class="n">ej</span> <span class="o">=</span> <span class="n">array</span><span class="p">([</span><span class="n">n2</span><span class="o">-</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">,(</span><span class="n">n2</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">])</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
            <span class="n">ei</span> <span class="o">=</span> <span class="n">array</span><span class="p">([</span><span class="n">n1</span><span class="o">-</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">,(</span><span class="n">n1</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">])</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">bi</span><span class="p">,</span><span class="n">ei</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">bj</span><span class="p">,</span><span class="n">ej</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
                    <span class="n">out</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">out</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span><span class="o">+</span><span class="n">im1</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="n">k</span><span class="p">,</span><span class="n">j</span><span class="o">+</span><span class="n">l</span><span class="p">]</span><span class="o">*</span><span class="n">im2</span><span class="p">[</span><span class="n">k</span><span class="o">+</span><span class="p">(</span><span class="n">n1</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span><span class="n">l</span><span class="o">+</span><span class="p">(</span><span class="n">n2</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">out</span>

<span class="k">def</span> <span class="nf">correl_c</span><span class="p">(</span><span class="n">im1</span><span class="p">,</span><span class="n">im2</span><span class="p">,</span><span class="n">path</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">):</span>

    <span class="n">name1</span> <span class="o">=</span> <span class="n">path</span><span class="o">+</span><span class="n">rand_file_name</span><span class="p">(</span><span class="s1">&#39;.fits&#39;</span><span class="p">)</span>
    <span class="n">name2</span> <span class="o">=</span> <span class="n">path</span><span class="o">+</span><span class="n">rand_file_name</span><span class="p">(</span><span class="s1">&#39;.fits&#39;</span><span class="p">)</span>
    <span class="n">name3</span> <span class="o">=</span> <span class="n">path</span><span class="o">+</span><span class="n">rand_file_name</span><span class="p">(</span><span class="s1">&#39;.fits&#39;</span><span class="p">)</span>

    <span class="n">fits</span><span class="o">.</span><span class="n">writeto</span><span class="p">(</span><span class="n">name1</span><span class="p">,</span><span class="n">im1</span><span class="p">)</span>
    <span class="n">fits</span><span class="o">.</span><span class="n">writeto</span><span class="p">(</span><span class="n">name2</span><span class="p">,</span><span class="n">im2</span><span class="p">)</span>
    <span class="n">exe</span> <span class="o">=</span> <span class="n">path</span><span class="o">+</span><span class="s1">&#39;CPP/sprite/bin/pxi_correl&#39;</span>
    <span class="n">subprocess</span><span class="o">.</span><span class="n">call</span><span class="p">([</span><span class="n">exe</span><span class="p">,</span> <span class="n">name1</span><span class="p">,</span> <span class="n">name2</span><span class="p">,</span> <span class="n">name3</span><span class="p">])</span>
    <span class="n">im3</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">getdata</span><span class="p">(</span><span class="n">name3</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">name1</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">name2</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">name3</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">im3</span>


<span class="k">def</span> <span class="nf">rot180</span><span class="p">(</span><span class="n">im1</span><span class="p">):</span>

    <span class="n">n1</span> <span class="o">=</span> <span class="n">im1</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">n2</span> <span class="o">=</span> <span class="n">im1</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">out</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">n1</span><span class="p">,</span><span class="n">n2</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">n1</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">n2</span><span class="p">):</span>
            <span class="n">out</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">im1</span><span class="p">[</span><span class="n">n1</span><span class="o">-</span><span class="mi">1</span><span class="o">-</span><span class="n">i</span><span class="p">,</span><span class="n">n2</span><span class="o">-</span><span class="mi">1</span><span class="o">-</span><span class="n">j</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">out</span>

<span class="k">def</span> <span class="nf">rot180_stack</span><span class="p">(</span><span class="n">cube</span><span class="p">):</span>
    <span class="n">shap</span> <span class="o">=</span> <span class="n">cube</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">cube_out</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">cube</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
        <span class="n">cube_out</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">rot180</span><span class="p">(</span><span class="n">cube</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">])</span>

    <span class="k">return</span> <span class="n">cube_out</span>

<span class="k">def</span> <span class="nf">rot90_stack</span><span class="p">(</span><span class="n">cube</span><span class="p">):</span>
    <span class="n">shap</span> <span class="o">=</span> <span class="n">cube</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">cube_out</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">cube</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
        <span class="n">cube_out</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">rot90</span><span class="p">(</span><span class="n">cube</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">],</span><span class="mi">2</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">cube_out</span>


<span class="k">def</span> <span class="nf">dot_check</span><span class="p">(</span><span class="n">im1</span><span class="p">,</span><span class="n">im2</span><span class="p">):</span>
    <span class="kn">from</span> <span class="nn">numpy</span> <span class="k">import</span> <span class="o">*</span>
    <span class="n">n1</span> <span class="o">=</span> <span class="n">im1</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">n2</span> <span class="o">=</span> <span class="n">im1</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">a</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">n1</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">n2</span><span class="p">):</span>
            <span class="n">a</span> <span class="o">=</span> <span class="n">a</span><span class="o">+</span><span class="n">im1</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span><span class="o">*</span><span class="n">im2</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">a</span>

<span class="sd">&quot;&quot;&quot;def dot_conv_check(im1,im2,im3):&quot;&quot;&quot;</span>


<span class="k">def</span> <span class="nf">correl_comp</span><span class="p">(</span><span class="n">coeff_data_pca</span><span class="p">,</span><span class="n">w</span><span class="p">):</span> <span class="c1"># The data are assume to be centered, the variance sorted in ascending order and columns represent the variables</span>
    <span class="kn">from</span> <span class="nn">numpy</span> <span class="k">import</span> <span class="o">*</span>
    <span class="kn">import</span> <span class="nn">numpy.ma</span> <span class="k">as</span> <span class="nn">npma</span>

    <span class="n">siz</span> <span class="o">=</span> <span class="n">coeff_data_pca</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">mat</span> <span class="o">=</span> <span class="n">ones</span><span class="p">(</span><span class="n">siz</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">wmat</span> <span class="o">=</span> <span class="n">npma</span><span class="o">.</span><span class="n">outerproduct</span><span class="p">(</span><span class="n">mat</span><span class="p">,</span><span class="n">w</span><span class="p">)</span>
    <span class="n">coeff_data_pca_norm</span> <span class="o">=</span> <span class="n">coeff_data_pca</span><span class="o">/</span><span class="n">sqrt</span><span class="p">(</span><span class="n">wmat</span><span class="p">)</span>
    <span class="n">corr_mat</span> <span class="o">=</span> <span class="p">(</span><span class="n">transpose</span><span class="p">(</span><span class="n">coeff_data_pca_norm</span><span class="p">[:,</span><span class="mi">0</span><span class="p">:</span><span class="n">siz</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="mi">2</span><span class="p">]))</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">coeff_data_pca_norm</span><span class="p">[:,</span><span class="mi">0</span><span class="p">:</span><span class="n">siz</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="mi">2</span><span class="p">])</span><span class="o">/</span><span class="n">siz</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="c1"># The higher component is excluded</span>
    <span class="k">return</span> <span class="n">corr_mat</span>


<span class="k">def</span> <span class="nf">cumul</span><span class="p">(</span><span class="n">vect</span><span class="p">):</span>
    <span class="kn">from</span> <span class="nn">numpy</span> <span class="k">import</span> <span class="o">*</span>
    <span class="n">l</span> <span class="o">=</span> <span class="n">vect</span><span class="o">.</span><span class="n">size</span>
    <span class="n">vect_cumul</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">(</span><span class="n">l</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">l</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
            <span class="n">vect_cumul</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">vect_cumul</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">vect</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">vect_cumul</span>

<span class="k">def</span> <span class="nf">sym_histo</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">bin_w</span><span class="p">):</span>
    <span class="kn">from</span> <span class="nn">numpy</span> <span class="k">import</span> <span class="o">*</span>
    <span class="n">hist</span><span class="p">,</span><span class="n">edges</span> <span class="o">=</span> <span class="n">histogram</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="n">bin_w</span><span class="p">)</span>
    <span class="n">max_val_ind</span> <span class="o">=</span> <span class="n">where</span><span class="p">(</span><span class="n">hist</span><span class="o">==</span><span class="nb">max</span><span class="p">(</span><span class="n">hist</span><span class="p">))</span>
    <span class="n">ind</span> <span class="o">=</span> <span class="n">max_val_ind</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">max_val</span> <span class="o">=</span> <span class="n">double</span><span class="p">(</span><span class="n">edges</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span><span class="o">+</span><span class="n">edges</span><span class="p">[</span><span class="n">ind</span><span class="o">+</span><span class="mi">1</span><span class="p">])</span><span class="o">/</span><span class="mi">2</span> <span class="c1"># We assume it&#39;s positive</span>
    <span class="n">small_val_ind</span> <span class="o">=</span> <span class="n">where</span><span class="p">(</span><span class="n">x</span><span class="o">&lt;=</span><span class="n">max_val</span><span class="p">)</span>
    <span class="n">l</span> <span class="o">=</span> <span class="n">array</span><span class="p">(</span><span class="n">small_val_ind</span><span class="p">)</span><span class="o">.</span><span class="n">size</span>
    <span class="n">new_set</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">l</span><span class="p">)</span>
    <span class="n">L</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">size</span>
    <span class="n">j</span><span class="o">=</span><span class="mi">0</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">L</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">&lt;=</span><span class="n">max_val</span><span class="p">:</span>
            <span class="n">new_set</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">=</span><span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">new_set</span><span class="p">[</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">=</span><span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">+</span><span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="n">max_val</span><span class="o">-</span><span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
            <span class="n">j</span><span class="o">=</span><span class="n">j</span><span class="o">+</span><span class="mi">2</span>

    <span class="n">hist_sim</span><span class="p">,</span><span class="n">edges_new_set</span> <span class="o">=</span> <span class="n">histogram</span><span class="p">(</span><span class="n">new_set</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="n">bin_w</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">hist_sim</span><span class="p">,</span><span class="n">edges_new_set</span><span class="p">,</span><span class="n">new_set</span><span class="p">,</span><span class="n">max_val</span>

<span class="k">def</span> <span class="nf">rand_file_name</span><span class="p">(</span><span class="n">ext</span><span class="p">):</span>
    <span class="n">current_time</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="k">return</span> <span class="s1">&#39;file&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">clock</span><span class="p">())</span><span class="o">+</span><span class="n">ext</span>


<span class="k">def</span> <span class="nf">dictionary_learning</span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="n">data_init</span><span class="p">,</span><span class="n">sparsity</span><span class="p">,</span><span class="n">nb_iter</span><span class="p">,</span><span class="n">dictionary_size</span><span class="p">,</span><span class="n">dict_file</span><span class="p">,</span><span class="n">coeff_file</span><span class="p">):</span>
    <span class="n">opt</span> <span class="o">=</span> <span class="s1">&#39;-v -S &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">sparsity</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39; -I &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">nb_iter</span><span class="p">)</span>
    <span class="n">opt0</span> <span class="o">=</span> <span class="s1">&#39;-v -S &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">sparsity</span><span class="p">)</span>
    <span class="n">subprocess</span><span class="o">.</span><span class="n">call</span><span class="p">([</span><span class="s1">&#39;dl_dl1d&#39;</span><span class="p">,</span> <span class="n">opt</span><span class="p">,</span> <span class="n">data_init</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">dict_file</span><span class="p">])</span>
    <span class="n">subprocess</span><span class="o">.</span><span class="n">call</span><span class="p">([</span><span class="s1">&#39;dl_omp&#39;</span><span class="p">,</span> <span class="n">opt0</span><span class="p">,</span> <span class="n">dict_file</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">coeff_file</span><span class="p">])</span>
    <span class="k">return</span> <span class="mi">0</span>

<span class="k">def</span> <span class="nf">tree_approx_test</span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="n">tree</span><span class="p">,</span><span class="n">dictionary</span><span class="p">,</span><span class="n">tol</span><span class="p">,</span><span class="n">cells_means</span><span class="p">,</span><span class="n">list_split</span><span class="p">,</span><span class="n">rel_en</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span> <span class="c1"># Data are arranged in lines</span>
    <span class="kn">from</span> <span class="nn">numpy</span> <span class="k">import</span> <span class="o">*</span>
    <span class="n">a</span><span class="o">=</span><span class="mi">0</span>
    <span class="n">err_tot</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">tree_siz</span> <span class="o">=</span> <span class="n">shape</span><span class="p">(</span><span class="n">tree</span><span class="p">)</span>
    <span class="n">new_list_split</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">list_split</span><span class="p">)</span>
    <span class="n">i</span><span class="o">=</span><span class="mi">0</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">tree_siz</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
        <span class="k">if</span> <span class="n">list_split</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">siz</span> <span class="o">=</span> <span class="n">size</span><span class="p">(</span><span class="n">tree</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
            <span class="n">datai</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">array</span><span class="p">(</span><span class="n">tree</span><span class="p">[</span><span class="n">i</span><span class="p">]),:]</span> <span class="o">-</span> <span class="n">ones</span><span class="p">((</span><span class="n">siz</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span><span class="o">*</span><span class="n">cells_means</span><span class="p">[</span><span class="n">i</span><span class="p">,:]</span>
            <span class="n">dict_i</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">dictionary</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">])</span>
            <span class="n">err_i</span><span class="p">,</span><span class="n">err_pos</span> <span class="o">=</span> <span class="n">proj_err</span><span class="p">(</span><span class="n">datai</span><span class="p">,</span><span class="n">dict_i</span><span class="p">)</span>
            <span class="n">thresh</span> <span class="o">=</span> <span class="n">tol</span><span class="o">*</span><span class="p">(</span><span class="n">datai</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">rel_en</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">True</span><span class="p">:</span>
                <span class="n">thresh</span> <span class="o">=</span> <span class="n">tol</span><span class="o">*</span><span class="n">siz</span>
            <span class="k">if</span> <span class="n">err_i</span> <span class="o">&lt;=</span> <span class="n">thresh</span><span class="p">:</span>
                <span class="n">new_list_split</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="mi">0</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">a</span><span class="o">=</span><span class="mi">1</span>
    <span class="k">return</span> <span class="n">a</span><span class="p">,</span><span class="n">new_list_split</span>

<span class="k">def</span> <span class="nf">tree_approx_test_2</span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="n">tree</span><span class="p">,</span><span class="n">dictionary</span><span class="p">,</span><span class="n">tol_pix</span><span class="p">,</span><span class="n">tol_pos</span><span class="p">,</span><span class="n">cells_means</span><span class="p">,</span><span class="n">list_split</span><span class="p">):</span> <span class="c1"># Data are arranged in lines</span>
    <span class="kn">from</span> <span class="nn">numpy</span> <span class="k">import</span> <span class="o">*</span>
    <span class="n">a</span><span class="o">=</span><span class="mi">0</span>
    <span class="n">err_tot</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">tree_siz</span> <span class="o">=</span> <span class="n">shape</span><span class="p">(</span><span class="n">tree</span><span class="p">)</span>
    <span class="n">new_list_split</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">list_split</span><span class="p">)</span>
    <span class="n">i</span><span class="o">=</span><span class="mi">0</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">tree_siz</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
        <span class="k">if</span> <span class="n">list_split</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">siz</span> <span class="o">=</span> <span class="n">size</span><span class="p">(</span><span class="n">tree</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
            <span class="n">datai</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">array</span><span class="p">(</span><span class="n">tree</span><span class="p">[</span><span class="n">i</span><span class="p">]),:]</span> <span class="o">-</span> <span class="n">ones</span><span class="p">((</span><span class="n">siz</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span><span class="o">*</span><span class="n">cells_means</span><span class="p">[</span><span class="n">i</span><span class="p">,:]</span>
            <span class="n">dict_i</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">dictionary</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">])</span>
            <span class="n">err_i_pix</span><span class="p">,</span><span class="n">err_i_pos</span> <span class="o">=</span> <span class="n">proj_err</span><span class="p">(</span><span class="n">datai</span><span class="p">,</span><span class="n">dict_i</span><span class="p">)</span>
            <span class="nb">print</span> <span class="n">err_i_pix</span><span class="p">,</span><span class="n">tol_pix</span><span class="o">*</span><span class="p">(</span><span class="n">datai</span><span class="p">[:,:</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(),</span><span class="n">sqrt</span><span class="p">(</span><span class="n">err_i_pos</span><span class="p">),</span><span class="n">tol_pos</span>
            <span class="k">if</span> <span class="n">err_i_pix</span> <span class="o">&lt;=</span> <span class="n">tol_pix</span><span class="o">*</span><span class="p">(</span><span class="n">datai</span><span class="p">[:,:</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="ow">and</span> <span class="n">sqrt</span><span class="p">(</span><span class="n">err_i_pos</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">tol_pos</span><span class="p">:</span>
                <span class="n">new_list_split</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="mi">0</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">a</span><span class="o">=</span><span class="mi">1</span>
    <span class="k">return</span> <span class="n">a</span><span class="p">,</span><span class="n">new_list_split</span>


<span class="k">def</span> <span class="nf">tree_PCA</span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="n">tree</span><span class="p">,</span><span class="n">sparsity_lev</span><span class="p">,</span><span class="n">list_split</span><span class="p">,</span><span class="n">old_dictionary</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">old_cells_means</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="kn">from</span> <span class="nn">numpy</span> <span class="k">import</span> <span class="o">*</span>
    <span class="kn">import</span> <span class="nn">copy</span>
    <span class="n">tree_size</span> <span class="o">=</span> <span class="n">shape</span><span class="p">(</span><span class="n">tree</span><span class="p">)</span>
    <span class="n">data_size</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">dictionary</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">data_size</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">sparsity_lev</span><span class="p">,</span><span class="n">tree_size</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
    <span class="n">cells_means</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">tree_size</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">data_size</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
    <span class="n">coeff_tree</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">tree</span><span class="p">)</span>
    <span class="n">i</span><span class="o">=</span><span class="mi">0</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">tree_size</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
        <span class="c1">#print tree[i]</span>
        <span class="k">if</span> <span class="n">list_split</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">datai</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">array</span><span class="p">(</span><span class="n">tree</span><span class="p">[</span><span class="n">i</span><span class="p">]),:]</span>
            <span class="n">wi</span><span class="p">,</span><span class="n">vi</span><span class="p">,</span><span class="n">coeffi</span><span class="p">,</span><span class="n">mean_datai</span> <span class="o">=</span> <span class="n">PCA</span><span class="p">(</span><span class="n">datai</span><span class="p">,</span><span class="n">sparsity_lev</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">mean_sub</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">dictionary</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">]</span><span class="o">=</span><span class="n">vi</span><span class="p">[:,</span><span class="mi">1</span><span class="p">:]</span>
            <span class="n">siz</span> <span class="o">=</span> <span class="n">shape</span><span class="p">(</span><span class="n">datai</span><span class="p">)</span>
            <span class="n">cells_means</span><span class="p">[</span><span class="n">i</span><span class="p">,:]</span><span class="o">=</span> <span class="n">mean_datai</span>
            <span class="n">l</span> <span class="o">=</span> <span class="n">size</span><span class="p">(</span><span class="n">tree</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
            <span class="n">k</span><span class="o">=</span><span class="mi">0</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">l</span><span class="p">):</span>
                <span class="n">coeff_tree</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">coeffi</span><span class="p">[</span><span class="n">k</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">dictionary</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">old_dictionary</span><span class="p">[:,:,</span><span class="n">list_split</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]]</span>
            <span class="n">cells_means</span><span class="p">[</span><span class="n">i</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">old_cells_means</span><span class="p">[</span><span class="n">list_split</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">],:]</span>
    <span class="k">return</span> <span class="n">dictionary</span><span class="p">,</span><span class="n">cells_means</span><span class="p">,</span><span class="n">coeff_tree</span>

<span class="k">def</span> <span class="nf">tree_SVD</span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="n">tree</span><span class="p">,</span><span class="n">sparsity_lev</span><span class="p">,</span><span class="n">list_split</span><span class="p">,</span><span class="n">old_dictionary</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">old_cells_means</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">coeff_comp</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="kn">from</span> <span class="nn">numpy</span> <span class="k">import</span> <span class="o">*</span>
    <span class="kn">import</span> <span class="nn">copy</span>
    <span class="n">tree_size</span> <span class="o">=</span> <span class="n">shape</span><span class="p">(</span><span class="n">tree</span><span class="p">)</span>
    <span class="n">data_size</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">dictionary</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">data_size</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">sparsity_lev</span><span class="p">,</span><span class="n">tree_size</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
    <span class="n">cells_means</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">tree_size</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">data_size</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
    <span class="n">coeff_tree</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">tree</span><span class="p">)</span>
    <span class="n">i</span><span class="o">=</span><span class="mi">0</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">tree_size</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
        <span class="c1">#print tree[i]</span>
        <span class="k">if</span> <span class="n">list_split</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">datai</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">array</span><span class="p">(</span><span class="n">tree</span><span class="p">[</span><span class="n">i</span><span class="p">]),:]</span>
            <span class="n">wi</span><span class="p">,</span><span class="n">vi</span><span class="p">,</span><span class="n">coeffi</span><span class="p">,</span><span class="n">mean_datai</span> <span class="o">=</span> <span class="n">SVD_interf</span><span class="p">(</span><span class="n">datai</span><span class="p">,</span><span class="n">sparsity_lev</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">mean_sub</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">coeff_comp</span><span class="o">=</span><span class="n">coeff_comp</span><span class="p">)</span>
            <span class="n">dictionary</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">]</span><span class="o">=</span><span class="n">vi</span><span class="p">[:,</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">siz</span> <span class="o">=</span> <span class="n">shape</span><span class="p">(</span><span class="n">datai</span><span class="p">)</span>
            <span class="n">cells_means</span><span class="p">[</span><span class="n">i</span><span class="p">,:]</span><span class="o">=</span> <span class="n">mean_datai</span>
            <span class="n">l</span> <span class="o">=</span> <span class="n">size</span><span class="p">(</span><span class="n">tree</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
            <span class="n">k</span><span class="o">=</span><span class="mi">0</span>
            <span class="k">if</span> <span class="n">coeff_comp</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="p">:</span>
                <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">l</span><span class="p">):</span>
                    <span class="n">coeff_tree</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">coeffi</span><span class="p">[</span><span class="n">k</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">dictionary</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">old_dictionary</span><span class="p">[:,:,</span><span class="n">list_split</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]]</span>
            <span class="n">cells_means</span><span class="p">[</span><span class="n">i</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">old_cells_means</span><span class="p">[</span><span class="n">list_split</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">],:]</span>
    <span class="k">return</span> <span class="n">dictionary</span><span class="p">,</span><span class="n">cells_means</span><span class="p">,</span><span class="n">coeff_tree</span>

<span class="k">def</span> <span class="nf">tree_PCA_pos</span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="n">tree</span><span class="p">,</span><span class="n">sparsity_lev</span><span class="p">,</span><span class="n">list_split</span><span class="p">,</span><span class="n">old_dictionary</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">old_cells_means</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="kn">from</span> <span class="nn">numpy</span> <span class="k">import</span> <span class="o">*</span>
    <span class="kn">import</span> <span class="nn">copy</span>
    <span class="n">tree_size</span> <span class="o">=</span> <span class="n">shape</span><span class="p">(</span><span class="n">tree</span><span class="p">)</span>
    <span class="n">data_size</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">dictionary</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">data_size</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">sparsity_lev</span><span class="p">,</span><span class="n">tree_size</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
    <span class="n">cells_means</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">tree_size</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">data_size</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
    <span class="n">i</span><span class="o">=</span><span class="mi">0</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">tree_size</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
        <span class="c1">#print tree[i]</span>
        <span class="k">if</span> <span class="n">list_split</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">datai</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">array</span><span class="p">(</span><span class="n">tree</span><span class="p">[</span><span class="n">i</span><span class="p">]),:]</span>
            <span class="n">wi</span><span class="p">,</span><span class="n">vi</span><span class="p">,</span><span class="n">coeffi</span><span class="p">,</span><span class="n">mean_datai</span> <span class="o">=</span> <span class="n">PCA</span><span class="p">(</span><span class="n">datai</span><span class="p">,</span><span class="n">sparsity_lev</span><span class="p">,</span><span class="n">mean_sub</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">dictionary</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">]</span><span class="o">=</span><span class="n">vi</span>
            <span class="n">siz</span> <span class="o">=</span> <span class="n">shape</span><span class="p">(</span><span class="n">datai</span><span class="p">)</span>
            <span class="n">cells_means</span><span class="p">[</span><span class="n">i</span><span class="p">,:]</span><span class="o">=</span> <span class="n">mean_datai</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">dictionary</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">old_dictionary</span><span class="p">[:,:,</span><span class="n">list_split</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]]</span>
            <span class="n">cells_means</span><span class="p">[</span><span class="n">i</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">old_cells_means</span><span class="p">[</span><span class="n">list_split</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">],:]</span>
    <span class="k">return</span> <span class="n">dictionary</span><span class="p">,</span><span class="n">cells_means</span>

<span class="k">def</span> <span class="nf">tree_svd_pos</span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="n">tree</span><span class="p">,</span><span class="n">sparsity_lev</span><span class="p">,</span><span class="n">list_split</span><span class="p">,</span><span class="n">old_dictionary</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">old_cells_means</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">coeff_comp</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="kn">from</span> <span class="nn">numpy</span> <span class="k">import</span> <span class="o">*</span>
    <span class="kn">import</span> <span class="nn">copy</span>
    <span class="n">tree_size</span> <span class="o">=</span> <span class="n">shape</span><span class="p">(</span><span class="n">tree</span><span class="p">)</span>
    <span class="n">data_size</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">dictionary</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">data_size</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">sparsity_lev</span><span class="p">,</span><span class="n">tree_size</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
    <span class="n">cells_means</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">tree_size</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">data_size</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
    <span class="n">i</span><span class="o">=</span><span class="mi">0</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">tree_size</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
        <span class="c1">#print tree[i]</span>
        <span class="k">if</span> <span class="n">list_split</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">datai</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">array</span><span class="p">(</span><span class="n">tree</span><span class="p">[</span><span class="n">i</span><span class="p">]),:]</span>
            <span class="n">wi</span><span class="p">,</span><span class="n">vi</span><span class="p">,</span><span class="n">coeffi</span><span class="p">,</span><span class="n">mean_datai</span> <span class="o">=</span> <span class="n">SVD_interf</span><span class="p">(</span><span class="n">datai</span><span class="p">,</span><span class="n">sparsity_lev</span><span class="p">,</span><span class="n">mean_sub</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">coeff_comp</span><span class="o">=</span><span class="n">coeff_comp</span><span class="p">)</span>
            <span class="n">dictionary</span><span class="p">[:,:</span> <span class="n">vi</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">i</span><span class="p">]</span><span class="o">=</span><span class="n">vi</span>
            <span class="n">siz</span> <span class="o">=</span> <span class="n">shape</span><span class="p">(</span><span class="n">datai</span><span class="p">)</span>
            <span class="n">cells_means</span><span class="p">[</span><span class="n">i</span><span class="p">,:]</span><span class="o">=</span> <span class="n">mean_datai</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">dictionary</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">old_dictionary</span><span class="p">[:,:,</span><span class="n">list_split</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]]</span>
            <span class="n">cells_means</span><span class="p">[</span><span class="n">i</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">old_cells_means</span><span class="p">[</span><span class="n">list_split</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">],:]</span>
    <span class="k">return</span> <span class="n">dictionary</span><span class="p">,</span><span class="n">cells_means</span>


<span class="k">def</span> <span class="nf">tree_split</span><span class="p">(</span><span class="n">tree</span><span class="p">,</span><span class="n">coeff_tree</span><span class="p">,</span><span class="n">list_split</span><span class="p">,</span><span class="n">sparsity_level</span><span class="p">):</span>
    <span class="kn">from</span> <span class="nn">numpy</span> <span class="k">import</span> <span class="o">*</span>
    <span class="n">new_tree</span>  <span class="o">=</span><span class="nb">list</span><span class="p">([])</span>
    <span class="n">new_list_split</span> <span class="o">=</span> <span class="nb">list</span><span class="p">([])</span>
    <span class="n">tree_size</span> <span class="o">=</span> <span class="n">shape</span><span class="p">(</span><span class="n">tree</span><span class="p">)</span>
    <span class="n">i</span><span class="o">=</span><span class="mi">0</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">tree_size</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
        <span class="n">l</span> <span class="o">=</span> <span class="n">size</span><span class="p">(</span><span class="n">tree</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">list_split</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">==</span><span class="mi">1</span> <span class="ow">and</span> <span class="n">l</span> <span class="o">&gt;</span> <span class="n">sparsity_level</span> <span class="p">:</span>
            <span class="n">pos_ind</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">neg_ind</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">l</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">coeff_tree</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">k</span><span class="p">]</span> <span class="o">&gt;=</span><span class="mi">0</span><span class="p">:</span>
                    <span class="n">pos_ind</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tree</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">k</span><span class="p">])</span>
                <span class="k">if</span> <span class="n">coeff_tree</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">k</span><span class="p">]</span> <span class="o">&lt;=</span><span class="mi">0</span><span class="p">:</span>
                    <span class="n">neg_ind</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tree</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">k</span><span class="p">])</span>
            <span class="n">new_tree</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">neg_ind</span><span class="p">)</span>
            <span class="n">new_tree</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pos_ind</span><span class="p">)</span>
            <span class="n">new_list_split</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">new_list_split</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">new_tree</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tree</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
            <span class="n">new_list_split</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="n">i</span><span class="p">])</span> <span class="c1"># we save the index in the old tree</span>
    <span class="k">return</span> <span class="n">new_tree</span><span class="p">,</span><span class="n">new_list_split</span>


<span class="k">def</span> <span class="nf">tree_split_pos</span><span class="p">(</span><span class="n">tree</span><span class="p">,</span><span class="n">list_split</span><span class="p">,</span><span class="n">sparsity_level</span><span class="p">,</span><span class="n">data</span><span class="p">):</span>
    <span class="kn">from</span> <span class="nn">numpy</span> <span class="k">import</span> <span class="o">*</span>
    <span class="n">new_tree</span>  <span class="o">=</span><span class="nb">list</span><span class="p">([])</span>
    <span class="n">new_list_split</span> <span class="o">=</span> <span class="nb">list</span><span class="p">([])</span>
    <span class="n">tree_size</span> <span class="o">=</span> <span class="n">shape</span><span class="p">(</span><span class="n">tree</span><span class="p">)</span>
    <span class="n">i</span><span class="o">=</span><span class="mi">0</span>
    <span class="n">shape_dat</span> <span class="o">=</span> <span class="n">shape</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">tree_size</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
        <span class="n">l</span> <span class="o">=</span> <span class="n">size</span><span class="p">(</span><span class="n">tree</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">list_split</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">==</span><span class="mi">1</span> <span class="ow">and</span> <span class="n">l</span> <span class="o">&gt;</span> <span class="n">sparsity_level</span> <span class="p">:</span>
            <span class="n">pos_ind</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">neg_ind</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">coord_i</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">tree</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">shape_dat</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="mi">2</span><span class="p">:</span><span class="n">shape_dat</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
            <span class="n">stdx</span> <span class="o">=</span> <span class="n">std</span><span class="p">(</span><span class="n">coord_i</span><span class="p">[:,</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">stdy</span> <span class="o">=</span> <span class="n">std</span><span class="p">(</span><span class="n">coord_i</span><span class="p">[:,</span><span class="mi">1</span><span class="p">])</span>
            <span class="nb">id</span><span class="o">=</span><span class="mi">0</span>
            <span class="k">if</span> <span class="n">stdy</span> <span class="o">&gt;</span> <span class="n">stdx</span><span class="p">:</span>
                <span class="nb">id</span><span class="o">=</span><span class="mi">1</span>
            <span class="n">mean_id</span> <span class="o">=</span> <span class="n">mean</span><span class="p">(</span><span class="n">coord_i</span><span class="p">[:,</span><span class="nb">id</span><span class="p">])</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">l</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">data</span><span class="p">[</span><span class="n">tree</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">k</span><span class="p">],</span><span class="n">shape_dat</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="mi">2</span><span class="o">+</span><span class="nb">id</span><span class="p">]</span> <span class="o">&gt;=</span><span class="n">mean_id</span><span class="p">:</span>
                    <span class="n">pos_ind</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tree</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">k</span><span class="p">])</span>
                <span class="k">if</span> <span class="n">data</span><span class="p">[</span><span class="n">tree</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">k</span><span class="p">],</span><span class="n">shape_dat</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="mi">2</span><span class="o">+</span><span class="nb">id</span><span class="p">]</span><span class="o">&lt;=</span><span class="n">mean_id</span><span class="p">:</span>
                    <span class="n">neg_ind</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tree</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">k</span><span class="p">])</span>
            <span class="n">new_tree</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">neg_ind</span><span class="p">)</span>
            <span class="n">new_tree</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pos_ind</span><span class="p">)</span>
            <span class="n">new_list_split</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">new_list_split</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">new_tree</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tree</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
            <span class="n">new_list_split</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="n">i</span><span class="p">])</span> <span class="c1"># we save the index in the old tree</span>
    <span class="k">return</span> <span class="n">new_tree</span><span class="p">,</span><span class="n">new_list_split</span>




<span class="k">def</span> <span class="nf">proj_err</span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="n">dictionary</span><span class="p">):</span> <span class="c1"># Data in lines, dictionary vector in columns</span>
    <span class="kn">from</span> <span class="nn">numpy</span> <span class="k">import</span> <span class="o">*</span>
    <span class="n">coeff</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">dictionary</span><span class="p">)</span>
    <span class="n">approx</span> <span class="o">=</span> <span class="n">coeff</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">transpose</span><span class="p">(</span><span class="n">dictionary</span><span class="p">))</span>
    <span class="n">err</span> <span class="o">=</span> <span class="p">((</span><span class="n">data</span><span class="o">-</span><span class="n">approx</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">err_pix</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">err</span><span class="p">[:</span><span class="o">-</span><span class="mi">2</span><span class="p">])</span>
    <span class="n">err_pos</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">err</span><span class="p">)</span><span class="o">-</span><span class="n">err_pix</span>
    <span class="k">return</span> <span class="n">err_pix</span><span class="p">,</span><span class="n">err_pos</span>

<span class="k">def</span> <span class="nf">geometric_dictionary_learning</span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="n">sparsity_lev</span><span class="p">,</span><span class="n">tol</span><span class="p">):</span> <span class="c1"># Tol = pourcentage in terms of quadratic error</span>
    <span class="kn">from</span> <span class="nn">numpy</span> <span class="k">import</span> <span class="o">*</span>
    <span class="c1">#tol_abs = tol*(data**2).sum()</span>
    <span class="n">split_en</span><span class="o">=</span><span class="mi">1</span>
    <span class="n">tree_init</span> <span class="o">=</span> <span class="nb">list</span><span class="p">([])</span>
    <span class="n">siz_data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">tree_init</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">siz_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
    <span class="n">tree</span> <span class="o">=</span> <span class="n">tree_init</span>
    <span class="n">list_split</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">list_split</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">dictionary</span><span class="p">,</span><span class="n">cells_means</span><span class="p">,</span><span class="n">coeff_tree</span><span class="o">=</span><span class="n">tree_PCA</span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="n">tree_init</span><span class="p">,</span><span class="n">sparsity_lev</span><span class="p">,</span><span class="n">list_split</span><span class="p">)</span>
    <span class="n">nb_sc</span><span class="o">=</span><span class="mi">0</span>
    <span class="k">while</span> <span class="p">(</span><span class="n">split_en</span> <span class="o">==</span> <span class="mi">1</span><span class="p">):</span>
        <span class="nb">print</span> <span class="s1">&#39;tree splitting&#39;</span>
        <span class="n">tree</span><span class="p">,</span><span class="n">list_split</span><span class="o">=</span><span class="n">tree_split</span><span class="p">(</span><span class="n">tree</span><span class="p">,</span><span class="n">coeff_tree</span><span class="p">,</span><span class="n">list_split</span><span class="p">,</span><span class="n">sparsity_lev</span><span class="p">)</span>
        <span class="nb">print</span> <span class="s1">&#39;iteratice PCA&#39;</span>
        <span class="n">dictionary</span><span class="p">,</span><span class="n">cells_means</span><span class="p">,</span><span class="n">coeff_tree</span><span class="o">=</span><span class="n">tree_PCA</span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="n">tree</span><span class="p">,</span><span class="n">sparsity_lev</span><span class="p">,</span><span class="n">list_split</span><span class="p">,</span><span class="n">dictionary</span><span class="p">,</span><span class="n">cells_means</span><span class="p">)</span>
        <span class="nb">print</span> <span class="s1">&#39;projection error&#39;</span>
        <span class="n">split_en</span><span class="p">,</span><span class="n">list_split</span> <span class="o">=</span> <span class="n">tree_approx_test</span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="n">tree</span><span class="p">,</span><span class="n">dictionary</span><span class="p">,</span><span class="n">tol</span><span class="p">,</span><span class="n">cells_means</span><span class="p">,</span><span class="n">list_split</span><span class="p">)</span>
        <span class="n">nb_sc</span><span class="o">=</span><span class="n">nb_sc</span><span class="o">+</span><span class="mi">1</span>
        <span class="nb">print</span> <span class="s1">&#39;scale &#39;</span><span class="p">,</span><span class="n">nb_sc</span>
        <span class="nb">print</span> <span class="s1">&#39;number of cells:&#39;</span><span class="p">,</span> <span class="n">shape</span><span class="p">(</span><span class="n">tree</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">tree</span><span class="p">,</span><span class="n">dictionary</span><span class="p">,</span><span class="n">cells_means</span><span class="p">,</span><span class="n">nb_sc</span>

<span class="k">def</span> <span class="nf">geometric_dictionary_learning_field</span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="n">sparsity_lev</span><span class="p">,</span><span class="n">tol</span><span class="p">):</span> <span class="c1"># Tol = pourcentage in terms of quadratic error</span>
    <span class="kn">from</span> <span class="nn">numpy</span> <span class="k">import</span> <span class="o">*</span>
    <span class="c1">#tol_abs = tol*(data**2).sum()</span>
    <span class="n">split_en</span><span class="o">=</span><span class="mi">1</span>
    <span class="n">tree_init</span> <span class="o">=</span> <span class="nb">list</span><span class="p">([])</span>
    <span class="n">siz_data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">tree_init</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">siz_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
    <span class="n">tree</span> <span class="o">=</span> <span class="n">tree_init</span>
    <span class="n">list_split</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">list_split</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">dictionary</span><span class="p">,</span><span class="n">cells_means</span><span class="o">=</span><span class="n">tree_PCA_pos</span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="n">tree_init</span><span class="p">,</span><span class="n">sparsity_lev</span><span class="p">,</span><span class="n">list_split</span><span class="p">)</span>
    <span class="n">nb_sc</span><span class="o">=</span><span class="mi">0</span>
    <span class="k">while</span> <span class="p">(</span><span class="n">split_en</span> <span class="o">==</span> <span class="mi">1</span><span class="p">):</span>
        <span class="nb">print</span> <span class="s1">&#39;tree splitting&#39;</span>
        <span class="n">tree</span><span class="p">,</span><span class="n">list_split</span><span class="o">=</span><span class="n">tree_split_pos</span><span class="p">(</span><span class="n">tree</span><span class="p">,</span><span class="n">list_split</span><span class="p">,</span><span class="n">sparsity_lev</span><span class="p">,</span><span class="n">data</span><span class="p">)</span>
        <span class="nb">print</span> <span class="n">tree</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="nb">print</span> <span class="s1">&#39;iteratice PCA&#39;</span>
        <span class="n">dictionary</span><span class="p">,</span><span class="n">cells_means</span><span class="o">=</span><span class="n">tree_PCA_pos</span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="n">tree</span><span class="p">,</span><span class="n">sparsity_lev</span><span class="p">,</span><span class="n">list_split</span><span class="p">,</span><span class="n">dictionary</span><span class="p">,</span><span class="n">cells_means</span><span class="p">)</span>
        <span class="nb">print</span> <span class="s1">&#39;projection error&#39;</span>
        <span class="n">split_en</span><span class="p">,</span><span class="n">list_split</span> <span class="o">=</span> <span class="n">tree_approx_test</span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="n">tree</span><span class="p">,</span><span class="n">dictionary</span><span class="p">,</span><span class="n">tol</span><span class="p">,</span><span class="n">cells_means</span><span class="p">,</span><span class="n">list_split</span><span class="p">)</span>
        <span class="n">nb_sc</span><span class="o">=</span><span class="n">nb_sc</span><span class="o">+</span><span class="mi">1</span>
        <span class="nb">print</span> <span class="s1">&#39;scale &#39;</span><span class="p">,</span><span class="n">nb_sc</span>
        <span class="nb">print</span> <span class="s1">&#39;number of cells:&#39;</span><span class="p">,</span> <span class="n">shape</span><span class="p">(</span><span class="n">tree</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">tree</span><span class="p">,</span><span class="n">dictionary</span><span class="p">,</span><span class="n">cells_means</span><span class="p">,</span><span class="n">nb_sc</span>

<span class="k">def</span> <span class="nf">geometric_dictionary_learning_field_2</span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="n">sparsity_lev</span><span class="p">,</span><span class="n">tol1</span><span class="o">=</span><span class="mf">0.00001</span><span class="p">,</span><span class="n">tol2</span><span class="o">=</span><span class="mf">0.1</span><span class="o">/</span><span class="mi">3600</span><span class="p">):</span> <span class="c1"># Tol1 = pourcentage in terms of quadratic error on the pixels intensities : tol2 error on the position in deg (euclid pixel size)</span>
    <span class="kn">from</span> <span class="nn">numpy</span> <span class="k">import</span> <span class="o">*</span>
    <span class="c1">#tol_abs = tol*(data**2).sum()</span>
    <span class="n">split_en</span><span class="o">=</span><span class="mi">1</span>
    <span class="n">tree_init</span> <span class="o">=</span> <span class="nb">list</span><span class="p">([])</span>
    <span class="n">siz_data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">tree_init</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">siz_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
    <span class="n">tree</span> <span class="o">=</span> <span class="n">tree_init</span>
    <span class="n">list_split</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">list_split</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
    <span class="c1">#dictionary,cells_means=tree_PCA_pos(data,tree_init,sparsity_lev,list_split)</span>
    <span class="n">dictionary</span><span class="p">,</span><span class="n">cells_means</span><span class="o">=</span><span class="n">tree_svd_pos</span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="n">tree_init</span><span class="p">,</span><span class="n">sparsity_lev</span><span class="p">,</span><span class="n">list_split</span><span class="p">)</span>
    <span class="n">nb_sc</span><span class="o">=</span><span class="mi">0</span>
    <span class="k">while</span> <span class="p">(</span><span class="n">split_en</span> <span class="o">==</span> <span class="mi">1</span><span class="p">):</span>
        <span class="nb">print</span> <span class="s1">&#39;tree splitting&#39;</span>
        <span class="n">tree</span><span class="p">,</span><span class="n">list_split</span><span class="o">=</span><span class="n">tree_split_pos</span><span class="p">(</span><span class="n">tree</span><span class="p">,</span><span class="n">list_split</span><span class="p">,</span><span class="n">sparsity_lev</span><span class="p">,</span><span class="n">data</span><span class="p">)</span>
        <span class="c1">#print tree</span>
        <span class="nb">print</span> <span class="s1">&#39;iteratice PCA&#39;</span>
        <span class="n">dictionary</span><span class="p">,</span><span class="n">cells_means</span><span class="o">=</span><span class="n">tree_svd_pos</span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="n">tree</span><span class="p">,</span><span class="n">sparsity_lev</span><span class="p">,</span><span class="n">list_split</span><span class="p">,</span><span class="n">dictionary</span><span class="p">,</span><span class="n">cells_means</span><span class="p">)</span>
        <span class="nb">print</span> <span class="s1">&#39;projection error&#39;</span>
        <span class="n">split_en</span><span class="p">,</span><span class="n">list_split</span> <span class="o">=</span> <span class="n">tree_approx_test_2</span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="n">tree</span><span class="p">,</span><span class="n">dictionary</span><span class="p">,</span><span class="n">tol1</span><span class="p">,</span><span class="n">tol2</span><span class="p">,</span><span class="n">cells_means</span><span class="p">,</span><span class="n">list_split</span><span class="p">)</span>
        <span class="n">nb_sc</span><span class="o">=</span><span class="n">nb_sc</span><span class="o">+</span><span class="mi">1</span>
        <span class="nb">print</span> <span class="s1">&#39;scale &#39;</span><span class="p">,</span><span class="n">nb_sc</span>
        <span class="nb">print</span> <span class="s1">&#39;number of cells:&#39;</span><span class="p">,</span> <span class="n">shape</span><span class="p">(</span><span class="n">tree</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">tree</span><span class="p">,</span><span class="n">dictionary</span><span class="p">,</span><span class="n">cells_means</span><span class="p">,</span><span class="n">nb_sc</span>


<span class="k">def</span> <span class="nf">geometric_dictionary_denoising</span><span class="p">(</span><span class="n">galaxy</span><span class="p">,</span><span class="n">dictionary</span><span class="p">,</span><span class="n">cells_means</span><span class="p">):</span>
    <span class="kn">from</span> <span class="nn">numpy</span> <span class="k">import</span> <span class="o">*</span>
    <span class="n">siz</span> <span class="o">=</span> <span class="n">galaxy</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">galaxy</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">siz</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">siz</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">dist</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">cells_means</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="mi">1</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">cells_means</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
        <span class="n">dist</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span><span class="o">-</span><span class="n">cells_means</span><span class="p">[</span><span class="n">i</span><span class="p">,:])</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">transpose</span><span class="p">(</span><span class="n">x</span><span class="o">-</span><span class="n">cells_means</span><span class="p">[</span><span class="n">i</span><span class="p">,:]))</span>
    <span class="n">ind</span> <span class="o">=</span> <span class="n">argsort</span><span class="p">(</span><span class="n">squeeze</span><span class="p">(</span><span class="n">dist</span><span class="p">))</span>
    <span class="n">i0</span><span class="o">=</span><span class="mi">0</span>
    <span class="n">coeffx</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span><span class="o">-</span><span class="n">cells_means</span><span class="p">[</span><span class="n">ind</span><span class="p">[</span><span class="n">i0</span><span class="p">],:])</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">dictionary</span><span class="p">[:,:,</span><span class="n">ind</span><span class="p">[</span><span class="n">i0</span><span class="p">]])</span>
    <span class="n">xapprox</span> <span class="o">=</span> <span class="n">coeffx</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">transpose</span><span class="p">(</span><span class="n">dictionary</span><span class="p">[:,:,</span><span class="n">ind</span><span class="p">[</span><span class="n">i0</span><span class="p">]]))</span> <span class="o">+</span> <span class="n">cells_means</span><span class="p">[</span><span class="n">ind</span><span class="p">[</span><span class="n">i0</span><span class="p">],:]</span>
    <span class="n">galaxy_denoised</span> <span class="o">=</span> <span class="n">xapprox</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">siz</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">siz</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">galaxy_denoised</span>



<span class="k">def</span> <span class="nf">affine_surf_eval</span><span class="p">(</span><span class="n">O</span><span class="p">,</span><span class="n">n1</span><span class="p">,</span><span class="n">n2</span><span class="p">,</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">):</span> <span class="c1"># {O, n1, n2} is an affine plan in R^n; this function computes a vector of this plan so that his last compnents are equal to x and y respectively</span>
    <span class="kn">from</span> <span class="nn">numpy</span> <span class="k">import</span> <span class="o">*</span>
    <span class="kn">import</span> <span class="nn">numpy.linalg</span> <span class="k">as</span> <span class="nn">npl</span>
    <span class="n">u</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>
    <span class="n">M</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span>
    <span class="n">n</span> <span class="o">=</span> <span class="n">O</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">M</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">n1</span><span class="p">[</span><span class="n">n</span><span class="o">-</span><span class="mi">2</span><span class="p">:</span><span class="n">n</span><span class="p">]</span>
    <span class="n">M</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">n2</span><span class="p">[</span><span class="n">n</span><span class="o">-</span><span class="mi">2</span><span class="p">:</span><span class="n">n</span><span class="p">]</span>
    <span class="n">u</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="n">x</span><span class="o">-</span><span class="n">O</span><span class="p">[</span><span class="n">n</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">u</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">=</span><span class="n">y</span><span class="o">-</span><span class="n">O</span><span class="p">[</span><span class="n">n</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">sol</span> <span class="o">=</span> <span class="n">npl</span><span class="o">.</span><span class="n">lstsq</span><span class="p">(</span><span class="n">M</span><span class="p">,</span><span class="n">u</span><span class="p">)</span>
    <span class="n">coeff</span> <span class="o">=</span> <span class="n">sol</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">output</span> <span class="o">=</span> <span class="n">O</span><span class="o">+</span><span class="n">coeff</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">n1</span><span class="o">+</span><span class="n">coeff</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">n2</span>
    <span class="k">return</span> <span class="n">output</span>



<span class="k">def</span> <span class="nf">psf_gauss</span><span class="p">(</span><span class="n">psf</span><span class="p">,</span><span class="n">fwhmx</span><span class="p">):</span>
    <span class="kn">from</span> <span class="nn">numpy</span> <span class="k">import</span> <span class="o">*</span>
    <span class="n">ell</span> <span class="o">=</span> <span class="n">mk_ellipticity</span><span class="p">(</span><span class="n">psf</span><span class="p">,</span><span class="mf">1e10</span><span class="p">,</span><span class="n">niter_cent</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">sqrt</span><span class="p">(</span><span class="n">ell</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="n">ell</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">cos_om</span> <span class="o">=</span> <span class="n">ell</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="n">r</span>
    <span class="n">om</span> <span class="o">=</span> <span class="n">arccos</span><span class="p">(</span><span class="n">cos_om</span><span class="p">)</span>
    <span class="n">theta</span> <span class="o">=</span> <span class="n">om</span><span class="o">/</span><span class="mi">2</span>
    <span class="n">fwhmy</span> <span class="o">=</span> <span class="n">sqrt</span><span class="p">((</span><span class="mi">1</span><span class="o">-</span><span class="n">r</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">r</span><span class="p">))</span><span class="o">*</span><span class="n">fwhmx</span>
    <span class="n">sigx</span> <span class="o">=</span> <span class="n">fwhmx</span><span class="o">/</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">log</span><span class="p">(</span><span class="mi">2</span><span class="p">)))</span>
    <span class="n">sigy</span> <span class="o">=</span> <span class="n">fwhmy</span><span class="o">/</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">log</span><span class="p">(</span><span class="mi">2</span><span class="p">)))</span>
    <span class="n">cent</span><span class="p">,</span><span class="n">wc</span> <span class="o">=</span> <span class="n">compute_centroid</span><span class="p">(</span><span class="n">psf</span><span class="p">,</span><span class="mf">1e10</span><span class="p">,</span><span class="n">nb_iter</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">rad</span> <span class="o">=</span> <span class="p">(</span><span class="n">psf</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span>
    <span class="n">ell1</span> <span class="o">=</span> <span class="p">(</span><span class="n">sigx</span><span class="o">**</span><span class="mi">2</span> <span class="o">-</span> <span class="n">sigy</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">sigx</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">sigy</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">cos</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">theta</span><span class="p">)</span>
    <span class="n">ell2</span> <span class="o">=</span> <span class="p">(</span><span class="n">sigx</span><span class="o">**</span><span class="mi">2</span> <span class="o">-</span> <span class="n">sigy</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">sigx</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">sigy</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">sin</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">theta</span><span class="p">)</span>
    <span class="n">gauss_map</span> <span class="o">=</span> <span class="n">gauss_gen_2</span><span class="p">(</span><span class="n">sigx</span><span class="p">,</span><span class="n">sigy</span><span class="p">,</span><span class="n">cent</span><span class="p">,</span><span class="n">theta</span><span class="p">,</span><span class="n">rad</span><span class="p">)</span>
    <span class="n">gauss_map</span> <span class="o">=</span> <span class="n">gauss_map</span><span class="o">*</span><span class="n">psf</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
    <span class="n">ell_fit</span> <span class="o">=</span> <span class="n">mk_ellipticity</span><span class="p">(</span><span class="n">gauss_map</span><span class="p">,</span><span class="mf">1e10</span><span class="p">,</span><span class="n">niter_cent</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">ell_error</span> <span class="o">=</span> <span class="n">ell</span> <span class="o">-</span> <span class="n">ell_fit</span>
    <span class="k">return</span> <span class="n">gauss_map</span><span class="p">,</span><span class="n">ell</span><span class="p">,</span><span class="n">ell_error</span><span class="p">,</span><span class="n">theta</span>


<span class="k">def</span> <span class="nf">psf_gauss_field</span><span class="p">(</span><span class="n">psf_field</span><span class="p">,</span><span class="n">fwhmx</span><span class="p">):</span>
    <span class="kn">from</span> <span class="nn">numpy</span> <span class="k">import</span> <span class="o">*</span>
    <span class="n">n1</span> <span class="o">=</span> <span class="n">psf_field</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">n2</span> <span class="o">=</span> <span class="n">psf_field</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">nb_psf</span> <span class="o">=</span> <span class="n">psf_field</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">ell_theta</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">nb_psf</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span>
    <span class="n">gauss_field</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">n1</span><span class="p">,</span><span class="n">n2</span><span class="p">,</span><span class="n">nb_psf</span><span class="p">))</span>
    <span class="n">i</span><span class="o">=</span><span class="mi">0</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_psf</span><span class="p">):</span>
        <span class="n">gauss_map</span><span class="p">,</span><span class="n">ell</span><span class="p">,</span><span class="n">ell_error</span><span class="p">,</span><span class="n">theta</span> <span class="o">=</span> <span class="n">psf_gauss</span><span class="p">(</span><span class="n">psf_field</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">],</span><span class="n">fwhmx</span><span class="p">)</span>
        <span class="n">gauss_field</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">]</span><span class="o">=</span><span class="n">gauss_map</span>
        <span class="n">ell_theta</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">ell</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">ell_theta</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">ell</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">ell_theta</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">theta</span>
    <span class="k">return</span> <span class="n">gauss_field</span><span class="p">,</span><span class="n">ell_theta</span>


<span class="k">def</span> <span class="nf">rand_diff_integ</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">n</span><span class="p">):</span> <span class="c1"># This function returns n different integers sorted in ascending order</span>
    <span class="kn">from</span> <span class="nn">numpy</span> <span class="k">import</span> <span class="o">*</span>
    <span class="n">out</span> <span class="o">=</span> <span class="n">array</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">n</span><span class="p">))</span>
    <span class="n">i</span><span class="o">=</span><span class="mi">0</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">n</span><span class="p">):</span>
        <span class="nb">bool</span><span class="o">=</span><span class="mi">0</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&gt;</span><span class="mi">0</span><span class="p">):</span>
            <span class="k">while</span> <span class="p">(</span><span class="nb">bool</span><span class="o">==</span><span class="mi">0</span><span class="p">):</span>
                <span class="n">ind</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>
                <span class="n">temp</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">out</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">i</span><span class="p">]</span><span class="o">-</span><span class="n">ind</span><span class="p">)</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">temp</span><span class="o">.</span><span class="n">min</span><span class="p">()</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">):</span>
                    <span class="n">out</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">=</span><span class="n">ind</span>
                    <span class="nb">bool</span><span class="o">=</span><span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ind</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>
            <span class="n">out</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">=</span><span class="n">ind</span>
    <span class="n">out</span> <span class="o">=</span> <span class="n">sort</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">out</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">rand_diff_integ_pair</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">n</span><span class="p">):</span>
    <span class="kn">from</span> <span class="nn">numpy</span> <span class="k">import</span> <span class="n">zeros</span><span class="p">,</span><span class="n">ones</span>
    <span class="n">ind_out</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">n</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span>
    <span class="n">ind_out</span> <span class="o">=</span> <span class="n">ind_out</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
    <span class="n">ind_arr</span> <span class="o">=</span> <span class="n">arange</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span>

    <span class="n">ind0</span> <span class="o">=</span> <span class="n">rand_diff_integ</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">b</span><span class="o">-</span><span class="n">a</span><span class="p">,</span><span class="n">n</span><span class="p">)</span>

    <span class="n">ind_out</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">ind_arr</span><span class="p">[</span><span class="n">ind0</span><span class="p">]</span>
    <span class="n">ind_arr</span><span class="p">[</span><span class="n">ind0</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
    <span class="n">ind_arr2</span> <span class="o">=</span> <span class="n">where</span><span class="p">(</span><span class="n">ind_arr</span><span class="o">&gt;=</span><span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">ind1</span> <span class="o">=</span> <span class="n">rand_diff_integ</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">b</span><span class="o">-</span><span class="n">a</span><span class="o">-</span><span class="n">n</span><span class="p">,</span><span class="n">n</span><span class="p">)</span>
    <span class="n">ind_out</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">ind_arr2</span><span class="p">[</span><span class="n">ind1</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">ind_out</span>

<span class="k">def</span> <span class="nf">plot_circles</span><span class="p">(</span><span class="n">target</span><span class="p">,</span><span class="n">points</span><span class="p">,</span><span class="n">nb_samp</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span><span class="n">p</span><span class="o">=</span><span class="mi">2</span><span class="p">):</span>
    <span class="kn">from</span> <span class="nn">pylab</span> <span class="k">import</span> <span class="n">figure</span><span class="p">,</span> <span class="n">show</span><span class="p">,</span> <span class="n">plot</span>

    <span class="n">angles</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">pi</span><span class="o">*</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_samp</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">nb_samp</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">figure</span><span class="p">()</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">norm</span><span class="p">(</span><span class="n">target</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">ones</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span><span class="n">points</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])))</span><span class="o">-</span><span class="n">points</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="c1">#for i in range(0,points.shape[1]):</span>

    <span class="n">plot</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">*</span><span class="n">cos</span><span class="p">(</span><span class="n">angles</span><span class="p">)</span><span class="o">+</span><span class="n">target</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">r</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">*</span><span class="n">sin</span><span class="p">(</span><span class="n">angles</span><span class="p">)</span><span class="o">+</span><span class="n">target</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="s1">&#39;r--&#39;</span><span class="p">)</span>
    <span class="n">plot</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">min</span><span class="p">()</span><span class="o">*</span><span class="n">cos</span><span class="p">(</span><span class="n">angles</span><span class="p">)</span><span class="o">+</span><span class="n">target</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">r</span><span class="o">.</span><span class="n">min</span><span class="p">()</span><span class="o">*</span><span class="n">sin</span><span class="p">(</span><span class="n">angles</span><span class="p">)</span><span class="o">+</span><span class="n">target</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="s1">&#39;r--&#39;</span><span class="p">)</span>
    <span class="n">plot</span><span class="p">(</span><span class="n">median</span><span class="p">(</span><span class="n">r</span><span class="p">)</span><span class="o">*</span><span class="n">cos</span><span class="p">(</span><span class="n">angles</span><span class="p">)</span><span class="o">+</span><span class="n">target</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">median</span><span class="p">(</span><span class="n">r</span><span class="p">)</span><span class="o">*</span><span class="n">sin</span><span class="p">(</span><span class="n">angles</span><span class="p">)</span><span class="o">+</span><span class="n">target</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="s1">&#39;r--&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="kc">None</span>


<span class="k">def</span> <span class="nf">rand_in</span><span class="p">(</span><span class="n">shap</span><span class="p">,</span><span class="n">slice_x</span><span class="p">,</span><span class="n">slice_y</span><span class="p">,</span><span class="n">mean</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">sig</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
    <span class="n">rand_out</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
            <span class="n">rand_out</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">sig</span><span class="o">*</span><span class="n">random</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">+</span><span class="n">mean</span>

    <span class="k">return</span> <span class="n">rand_out</span>

<span class="k">def</span> <span class="nf">cube_sampling</span><span class="p">(</span><span class="n">cube</span><span class="p">,</span><span class="n">n</span><span class="p">):</span> <span class="c1"># Extracts randomly n slice from the input data cube</span>

    <span class="n">n1</span> <span class="o">=</span> <span class="n">cube</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">n2</span> <span class="o">=</span> <span class="n">cube</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">n3</span> <span class="o">=</span> <span class="n">cube</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

    <span class="n">ind_rm</span> <span class="o">=</span> <span class="n">rand_diff_integ</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">n1</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">n1</span><span class="o">-</span><span class="n">n</span><span class="p">)</span>
    <span class="n">a</span> <span class="o">=</span> <span class="n">ones</span><span class="p">((</span><span class="n">n1</span><span class="p">,))</span>
    <span class="n">a</span><span class="p">[</span><span class="n">ind_rm</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">i</span> <span class="o">=</span> <span class="n">where</span><span class="p">(</span><span class="n">a</span><span class="o">==</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">ind_kpt</span> <span class="o">=</span> <span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">cube_out</span> <span class="o">=</span> <span class="n">cube</span><span class="p">[:,:,</span><span class="n">ind_kpt</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">cube_out</span><span class="p">,</span><span class="n">ind_rm</span><span class="p">,</span><span class="n">ind_kpt</span>

<span class="k">def</span> <span class="nf">geo_data_sampling</span><span class="p">(</span><span class="n">cube</span><span class="p">,</span><span class="n">frac_obs</span><span class="p">,</span><span class="n">frac_valid</span><span class="p">,</span><span class="n">pos_data</span><span class="p">):</span>
    <span class="kn">from</span> <span class="nn">numpy</span> <span class="k">import</span> <span class="nb">int</span>
    <span class="n">shap</span> <span class="o">=</span> <span class="n">cube</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">nb_data</span>  <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="n">frac_obs</span><span class="p">))</span>
    <span class="n">cube_1</span><span class="p">,</span><span class="n">ind_rm</span><span class="p">,</span><span class="n">ind_kpt</span> <span class="o">=</span> <span class="n">cube_sampling</span><span class="p">(</span><span class="n">cube</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">-</span><span class="n">nb_data</span><span class="p">)</span>
    <span class="n">pos_1</span> <span class="o">=</span> <span class="n">pos_data</span><span class="p">[</span><span class="n">ind_kpt</span><span class="p">,:]</span>

    <span class="n">nb_valid</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">frac_valid</span><span class="o">*</span><span class="n">nb_data</span><span class="p">))</span>
    <span class="nb">print</span> <span class="n">nb_valid</span><span class="p">,</span><span class="n">nb_data</span><span class="p">,</span><span class="n">cube_1</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">cube_obs</span><span class="p">,</span><span class="n">ind_valid</span><span class="p">,</span><span class="n">ind_kpt</span> <span class="o">=</span> <span class="n">cube_sampling</span><span class="p">(</span><span class="n">cube_1</span><span class="p">,</span><span class="n">nb_valid</span><span class="p">)</span>
    <span class="n">cube_valid</span> <span class="o">=</span> <span class="n">cube_1</span><span class="p">[:,:,</span><span class="n">ind_valid</span><span class="p">]</span>
    <span class="n">pos_obs</span> <span class="o">=</span> <span class="n">pos_1</span><span class="p">[</span><span class="n">ind_kpt</span><span class="p">,:]</span>
    <span class="n">pos_valid</span> <span class="o">=</span> <span class="n">pos_1</span><span class="p">[</span><span class="n">ind_valid</span><span class="p">,:]</span>

    <span class="k">return</span> <span class="n">cube_obs</span><span class="p">,</span><span class="n">pos_obs</span><span class="p">,</span><span class="n">cube_valid</span><span class="p">,</span><span class="n">pos_valid</span>

<span class="k">def</span> <span class="nf">geo_data_samplingm</span><span class="p">(</span><span class="n">cube</span><span class="p">,</span><span class="n">frac_obs</span><span class="p">,</span><span class="n">frac_valid</span><span class="p">,</span><span class="n">pos_data</span><span class="p">):</span>
    <span class="n">nb_r</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">frac_obs</span><span class="p">)</span>
    <span class="n">list_cube_obs</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
    <span class="n">list_pos_obs</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
    <span class="n">list_cube_valid</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
    <span class="n">list_pos_valid</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_r</span><span class="p">):</span>
        <span class="n">cube_obs</span><span class="p">,</span><span class="n">pos_obs</span><span class="p">,</span><span class="n">cube_valid</span><span class="p">,</span><span class="n">pos_valid</span>  <span class="o">=</span> <span class="n">geo_data_sampling</span><span class="p">(</span><span class="n">cube</span><span class="p">,</span><span class="n">frac_obs</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">frac_valid</span><span class="p">,</span><span class="n">pos_data</span><span class="p">)</span>
        <span class="n">list_cube_obs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cube_obs</span><span class="p">)</span>
        <span class="n">list_pos_obs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pos_obs</span><span class="p">)</span>
        <span class="n">list_cube_valid</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cube_valid</span><span class="p">)</span>
        <span class="n">list_pos_valid</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pos_valid</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">list_cube_obs</span><span class="p">,</span><span class="n">list_pos_obs</span><span class="p">,</span><span class="n">list_cube_valid</span><span class="p">,</span><span class="n">list_pos_valid</span>

<span class="k">def</span> <span class="nf">cube_sampling_interior</span><span class="p">(</span><span class="n">cube</span><span class="p">,</span><span class="n">n</span><span class="p">,</span><span class="n">pos</span><span class="p">):</span>
    <span class="kn">from</span> <span class="nn">numpy</span> <span class="k">import</span> <span class="o">*</span>
    <span class="n">n1</span> <span class="o">=</span> <span class="n">cube</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">n2</span> <span class="o">=</span> <span class="n">cube</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">n3</span> <span class="o">=</span> <span class="n">cube</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">hull</span> <span class="o">=</span> <span class="n">ConvexHull</span><span class="p">(</span><span class="n">pos</span><span class="p">)</span>
    <span class="n">hull_ind</span> <span class="o">=</span> <span class="n">hull</span><span class="o">.</span><span class="n">vertices</span>
    <span class="n">ind_ref</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">n1</span><span class="p">)</span>
    <span class="n">c</span> <span class="o">=</span> <span class="n">in1d</span><span class="p">(</span><span class="n">ind_ref</span><span class="p">,</span><span class="n">hull_ind</span><span class="p">)</span>
    <span class="n">ind_interior</span> <span class="o">=</span> <span class="n">where</span><span class="p">(</span><span class="n">c</span><span class="o">==</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">ind_rm</span> <span class="o">=</span> <span class="n">rand_diff_integ</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">ind_interior</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">n</span><span class="p">)</span>
    <span class="n">ind_rm</span> <span class="o">=</span> <span class="n">ind_interior</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">ind_rm</span><span class="p">]</span>
    <span class="n">ind_kpt</span> <span class="o">=</span> <span class="n">array</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">n1</span><span class="o">-</span><span class="n">n</span><span class="p">))</span>
    <span class="n">cube_out</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">n2</span><span class="p">,</span><span class="n">n3</span><span class="p">,</span><span class="n">n1</span><span class="o">-</span><span class="n">n</span><span class="p">))</span>
    <span class="n">count</span><span class="o">=</span><span class="mi">0</span>
    <span class="n">count2</span><span class="o">=</span><span class="mi">0</span>
    <span class="n">i</span> <span class="o">=</span><span class="mi">0</span>
    <span class="c1">#while (count &lt; n1-n):</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">n1</span><span class="p">):</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">!=</span> <span class="n">ind_rm</span><span class="p">[</span><span class="n">count2</span><span class="p">]):</span>
            <span class="n">cube_out</span><span class="p">[:,:,</span><span class="n">count</span><span class="p">]</span> <span class="o">=</span> <span class="n">cube</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">]</span>
            <span class="n">ind_kpt</span><span class="p">[</span><span class="n">count</span><span class="p">]</span><span class="o">=</span><span class="n">i</span>
            <span class="n">count</span> <span class="o">=</span> <span class="n">count</span><span class="o">+</span><span class="mi">1</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">i</span><span class="o">==</span><span class="n">ind_rm</span><span class="p">[</span><span class="n">count2</span><span class="p">]</span> <span class="ow">and</span> <span class="n">count2</span><span class="o">&lt;</span><span class="n">n</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
            <span class="n">count2</span><span class="o">=</span><span class="n">count2</span><span class="o">+</span><span class="mi">1</span>
    <span class="k">return</span> <span class="n">cube_out</span><span class="p">,</span><span class="n">ind_rm</span><span class="p">,</span><span class="n">ind_kpt</span><span class="p">,</span><span class="n">hull_ind</span>


<span class="k">def</span> <span class="nf">ind_cv</span><span class="p">(</span><span class="n">mat_ind</span><span class="p">,</span><span class="n">list_ind</span><span class="p">):</span> <span class="c1"># Remap the integers in mat_ind into [| 0,size(list_ind) |]</span>
    <span class="n">l</span> <span class="o">=</span> <span class="n">size</span><span class="p">(</span><span class="n">list_ind</span><span class="p">)</span>
    <span class="n">mat_ind_cv</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">mat_ind</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">l</span><span class="p">):</span>
        <span class="n">i</span><span class="p">,</span><span class="n">j</span> <span class="o">=</span> <span class="n">where</span><span class="p">(</span><span class="n">mat_ind</span><span class="o">==</span><span class="n">list_ind</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>
        <span class="n">mat_ind_cv</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">k</span>
    <span class="k">return</span> <span class="n">mat_ind_cv</span>

<span class="k">def</span> <span class="nf">aa_shaping</span><span class="p">(</span><span class="n">cube</span><span class="p">):</span>
    <span class="kn">from</span> <span class="nn">numpy</span> <span class="k">import</span> <span class="o">*</span>
    <span class="n">n1</span> <span class="o">=</span> <span class="n">cube</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">n2</span> <span class="o">=</span> <span class="n">cube</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">nb_data</span> <span class="o">=</span> <span class="n">cube</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">mat</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">nb_data</span><span class="p">,</span><span class="n">n1</span><span class="o">*</span><span class="n">n2</span><span class="p">))</span>
    <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_data</span><span class="p">):</span>
        <span class="n">cube_i</span> <span class="o">=</span> <span class="n">cube</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">]</span>
        <span class="n">mat</span><span class="p">[</span><span class="n">i</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">cube_i</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">n1</span><span class="o">*</span><span class="n">n2</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">mat</span>

<span class="k">def</span> <span class="nf">vid</span><span class="p">(</span><span class="n">cube</span><span class="p">,</span><span class="n">filename</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
    <span class="n">shap</span> <span class="o">=</span> <span class="n">cube</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">back</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">zeros</span><span class="p">(</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">]),</span><span class="n">cmap</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">get_cmap</span><span class="p">(</span><span class="s1">&#39;gist_stern&#39;</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">init</span><span class="p">():</span>
        <span class="n">back</span><span class="o">.</span><span class="n">set_data</span><span class="p">(</span><span class="n">zeros</span><span class="p">(</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">]))</span>
        <span class="k">return</span> <span class="n">back</span>

    <span class="k">def</span> <span class="nf">animate</span><span class="p">(</span><span class="n">i</span><span class="p">):</span>
        <span class="n">back</span><span class="o">.</span><span class="n">set_data</span><span class="p">(</span><span class="n">cube</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">back</span>

    <span class="n">anim</span> <span class="o">=</span> <span class="n">animation</span><span class="o">.</span><span class="n">FuncAnimation</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="n">animate</span><span class="p">,</span> <span class="n">init_func</span><span class="o">=</span><span class="n">init</span><span class="p">,</span>
                               <span class="n">frames</span><span class="o">=</span><span class="n">cube</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">blit</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">interval</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">filename</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="n">rand_file_name</span><span class="p">(</span><span class="s1">&#39;.mp4&#39;</span><span class="p">)</span>

    <span class="n">anim</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">fps</span><span class="o">=</span><span class="mi">30</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">anim</span>

<span class="k">def</span> <span class="nf">vect</span><span class="p">(</span><span class="n">u</span><span class="p">):</span>
    <span class="n">v</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">u</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">size</span><span class="p">(</span><span class="n">u</span><span class="p">),</span><span class="mi">1</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">v</span>

<span class="k">def</span> <span class="nf">gram_schmidt</span><span class="p">(</span><span class="n">U</span><span class="p">):</span> <span class="c1"># This function orthonormalizes the set of columns of U</span>
    <span class="kn">from</span> <span class="nn">numpy</span> <span class="k">import</span> <span class="o">*</span>
    <span class="n">V</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">U</span><span class="p">)</span>
    <span class="n">V</span> <span class="o">=</span> <span class="n">V</span><span class="o">*</span><span class="mi">0</span>
    <span class="n">nb_vect</span> <span class="o">=</span> <span class="n">U</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">V</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="n">U</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="n">sqrt</span><span class="p">((</span><span class="n">U</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span>
    <span class="n">weight_mat</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">nb_vect</span><span class="p">,</span><span class="n">nb_vect</span><span class="p">))</span>
    <span class="n">weight_mat</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span><span class="o">/</span><span class="n">sqrt</span><span class="p">((</span><span class="n">U</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">nb_vect</span><span class="p">):</span>
        <span class="n">V</span><span class="p">[:,</span><span class="n">i</span><span class="p">]</span><span class="o">=</span><span class="n">U</span><span class="p">[:,</span><span class="n">i</span><span class="p">]</span>
        <span class="n">j</span><span class="o">=</span><span class="mi">0</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">i</span><span class="p">):</span>
            <span class="n">V</span><span class="p">[:,</span><span class="n">i</span><span class="p">]</span><span class="o">=</span><span class="n">V</span><span class="p">[:,</span><span class="n">i</span><span class="p">]</span><span class="o">-</span><span class="p">(</span><span class="n">transpose</span><span class="p">(</span><span class="n">V</span><span class="p">[:,</span><span class="n">j</span><span class="p">])</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">U</span><span class="p">[:,</span><span class="n">i</span><span class="p">]))</span><span class="o">*</span><span class="n">V</span><span class="p">[:,</span><span class="n">j</span><span class="p">]</span>
        <span class="n">V</span><span class="p">[:,</span><span class="n">i</span><span class="p">]</span><span class="o">=</span><span class="n">V</span><span class="p">[:,</span><span class="n">i</span><span class="p">]</span><span class="o">/</span><span class="n">sqrt</span><span class="p">((</span><span class="n">V</span><span class="p">[:,</span><span class="n">i</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span>
    <span class="k">return</span> <span class="n">V</span>

<span class="k">def</span> <span class="nf">random_orth_basis</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
    <span class="n">U</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="n">n</span><span class="p">,</span><span class="n">n</span><span class="p">)</span>
    <span class="n">V</span> <span class="o">=</span> <span class="n">gram_schmidt</span><span class="p">(</span><span class="n">U</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">V</span>

<span class="k">def</span> <span class="nf">random_orth_basis_cat</span><span class="p">(</span><span class="n">n</span><span class="p">,</span><span class="n">nb_real</span><span class="o">=</span><span class="mi">3</span><span class="p">):</span>
    <span class="kn">from</span> <span class="nn">numpy</span> <span class="k">import</span> <span class="n">zeros</span>
    <span class="n">basis_out</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">n</span><span class="p">,</span><span class="n">n</span><span class="o">*</span><span class="n">nb_real</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_real</span><span class="p">):</span>
        <span class="n">basis_out</span><span class="p">[:,</span><span class="n">i</span><span class="o">*</span><span class="n">n</span><span class="p">:(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="n">random_orth_basis</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">basis_out</span>

<span class="k">def</span> <span class="nf">adapted_positive_basis</span><span class="p">(</span><span class="n">F</span><span class="p">,</span><span class="n">centering_en</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="n">shap</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">nz</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
    <span class="n">nb_nz</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
        <span class="n">thresh</span> <span class="o">=</span> <span class="n">threshold_perc</span><span class="p">(</span><span class="n">F</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,:,</span><span class="n">i</span><span class="p">],</span><span class="n">perc</span><span class="o">=</span><span class="mf">0.99</span><span class="p">)</span>
        <span class="nb">id</span> <span class="o">=</span> <span class="n">where</span><span class="p">((</span><span class="n">F</span><span class="p">[</span><span class="mi">0</span><span class="p">,:,</span><span class="n">i</span><span class="p">]</span><span class="o">&gt;</span><span class="n">thresh</span><span class="p">))</span>
        <span class="n">nb_nz</span><span class="o">+=</span><span class="n">size</span><span class="p">(</span><span class="nb">id</span><span class="p">)</span>
        <span class="n">nz</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">id</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">nb_nz</span><span class="p">))</span>
    <span class="n">l</span><span class="o">=</span><span class="mi">0</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
        <span class="n">data</span><span class="p">[:,</span><span class="n">l</span><span class="p">:</span><span class="n">l</span><span class="o">+</span><span class="n">size</span><span class="p">(</span><span class="n">nz</span><span class="p">[</span><span class="n">i</span><span class="p">])]</span> <span class="o">=</span> <span class="n">F</span><span class="p">[:,</span><span class="n">nz</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">i</span><span class="p">]</span>
        <span class="n">l</span><span class="o">+=</span><span class="n">size</span><span class="p">(</span><span class="n">nz</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
    <span class="k">if</span> <span class="n">centering_en</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">-=</span> <span class="n">data</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">ones</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span><span class="n">nb_nz</span><span class="p">)))</span>
    <span class="n">basis</span><span class="p">,</span><span class="n">s</span><span class="p">,</span><span class="n">v</span> <span class="o">=</span> <span class="n">svd</span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="n">full_matrices</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">s</span><span class="o">=</span><span class="n">s</span><span class="o">/</span><span class="n">sqrt</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="n">s</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span>
    <span class="c1">#s=s/s[0]</span>
    <span class="n">basis</span> <span class="o">=</span> <span class="n">basis</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">diag</span><span class="p">(</span><span class="n">s</span><span class="p">))</span>

    <span class="c1">#print &quot;Basis: &quot;,basis,&quot;; weighting: &quot;,s</span>
    <span class="k">return</span> <span class="n">basis</span><span class="p">,</span><span class="n">s</span>

<span class="k">def</span> <span class="nf">sphere_vect</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>

    <span class="n">theta</span> <span class="o">=</span> <span class="n">pi</span><span class="o">*</span><span class="n">arange</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span><span class="n">n</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">n</span><span class="p">)</span>
    <span class="n">phi</span> <span class="o">=</span> <span class="n">pi</span><span class="o">*</span><span class="n">arange</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span><span class="n">n</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">n</span><span class="p">)</span>
    <span class="n">mat_vect</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span><span class="n">n</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span>
    <span class="n">vect1</span> <span class="o">=</span> <span class="n">cos</span><span class="p">(</span><span class="n">theta</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">n</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>
    <span class="n">vect2</span> <span class="o">=</span> <span class="n">sin</span><span class="p">(</span><span class="n">theta</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">n</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>
    <span class="n">vect3</span> <span class="o">=</span> <span class="n">cos</span><span class="p">(</span><span class="n">phi</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">n</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>
    <span class="n">vect4</span> <span class="o">=</span> <span class="n">sin</span><span class="p">(</span><span class="n">phi</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">n</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>
    <span class="n">ones_vect</span> <span class="o">=</span> <span class="n">ones</span><span class="p">((</span><span class="n">n</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>
    <span class="n">mat_vect</span><span class="p">[</span><span class="mi">0</span><span class="p">,:]</span> <span class="o">=</span> <span class="p">(</span><span class="n">vect3</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">transpose</span><span class="p">(</span><span class="n">vect1</span><span class="p">)))</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">n</span><span class="o">**</span><span class="mi">2</span><span class="p">,))</span>
    <span class="n">mat_vect</span><span class="p">[</span><span class="mi">1</span><span class="p">,:]</span> <span class="o">=</span> <span class="p">(</span><span class="n">vect3</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">transpose</span><span class="p">(</span><span class="n">vect2</span><span class="p">)))</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">n</span><span class="o">**</span><span class="mi">2</span><span class="p">,))</span>
    <span class="n">mat_vect</span><span class="p">[</span><span class="mi">2</span><span class="p">,:]</span> <span class="o">=</span> <span class="p">(</span><span class="n">vect4</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">transpose</span><span class="p">(</span><span class="n">ones_vect</span><span class="p">)))</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">n</span><span class="o">**</span><span class="mi">2</span><span class="p">,))</span>

    <span class="k">return</span> <span class="n">mat_vect</span>

<span class="k">def</span> <span class="nf">sphere_vect_w</span><span class="p">(</span><span class="n">n</span><span class="p">,</span><span class="n">data</span><span class="p">,</span><span class="n">centering_en</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="n">mat_vect</span> <span class="o">=</span> <span class="n">sphere_vect</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
    <span class="n">basis</span><span class="p">,</span><span class="n">s</span> <span class="o">=</span> <span class="n">adapted_positive_basis</span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="n">centering_en</span><span class="o">=</span><span class="n">centering_en</span><span class="p">)</span>
    <span class="n">weights</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">n</span><span class="o">**</span><span class="mi">2</span><span class="p">,))</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">n</span><span class="o">**</span><span class="mi">2</span><span class="p">):</span>
        <span class="n">a</span> <span class="o">=</span> <span class="n">transpose</span><span class="p">(</span><span class="n">basis</span><span class="p">)</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">mat_vect</span><span class="p">[:,</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">)))</span>
        <span class="n">weights</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">norm</span><span class="p">(</span><span class="n">diag</span><span class="p">(</span><span class="n">s</span><span class="p">)</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">a</span><span class="p">),</span><span class="mi">2</span><span class="p">)</span>

    <span class="n">weights</span> <span class="o">=</span> <span class="n">weights</span><span class="o">/</span><span class="n">norm</span><span class="p">(</span><span class="n">weights</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">w_mat_vect</span> <span class="o">=</span> <span class="n">mat_vect</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">diag</span><span class="p">(</span><span class="n">weights</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">mat_vect</span>


<span class="k">def</span> <span class="nf">circle_vect</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
    <span class="kn">from</span> <span class="nn">numpy</span> <span class="k">import</span> <span class="n">cos</span><span class="p">,</span><span class="n">sin</span>
    <span class="n">theta</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">pi</span><span class="o">*</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">n</span><span class="p">)</span><span class="o">/</span><span class="n">n</span>
    <span class="n">mat_vect</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span><span class="n">n</span><span class="p">))</span>
    <span class="n">mat_vect</span><span class="p">[</span><span class="mi">0</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">cos</span><span class="p">(</span><span class="n">theta</span><span class="p">)</span>
    <span class="n">mat_vect</span><span class="p">[</span><span class="mi">1</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">sin</span><span class="p">(</span><span class="n">theta</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">mat_vect</span>


<span class="sd">&quot;&quot;&quot;def random_rot(M,a=1):</span>
<span class="sd">    theta = 2*pi*numpy.random.rand(1)*a</span>
<span class="sd">    phi = pi*numpy.random.rand(1)*a</span>
<span class="sd">    M = zeros(())&quot;&quot;&quot;</span>

<span class="k">def</span> <span class="nf">gram_schmidt_cube</span><span class="p">(</span><span class="n">V</span><span class="p">):</span>
    <span class="n">shap</span> <span class="o">=</span> <span class="n">V</span><span class="o">.</span><span class="n">shape</span>
    <span class="nb">dict</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>
    <span class="n">k</span><span class="o">=</span><span class="mi">0</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
        <span class="nb">dict</span><span class="p">[:,</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">V</span><span class="p">[:,:,</span><span class="n">k</span><span class="p">])</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">],))</span>
    <span class="n">dict_ortho</span> <span class="o">=</span> <span class="n">gram_schmidt</span><span class="p">(</span><span class="nb">dict</span><span class="p">)</span>
    <span class="n">Vorth</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">V</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
        <span class="n">Vorth</span><span class="p">[:,:,</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">dict_ortho</span><span class="p">[:,</span><span class="n">k</span><span class="p">])</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
    <span class="k">return</span> <span class="n">Vorth</span>

<span class="k">def</span> <span class="nf">proj_vect</span><span class="p">(</span><span class="n">v</span><span class="p">,</span><span class="n">mat</span><span class="p">,</span><span class="n">ortho_en</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span> <span class="c1"># Compute the orthogonal projection of v onto mat column space</span>
    <span class="n">mat_ortho</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">mat</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">ortho_en</span><span class="p">:</span>
        <span class="n">mat_ortho</span> <span class="o">=</span> <span class="n">gram_schmidt</span><span class="p">(</span><span class="n">mat</span><span class="p">)</span>
    <span class="n">u</span> <span class="o">=</span> <span class="n">mat_ortho</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">transpose</span><span class="p">(</span><span class="n">mat_ortho</span><span class="p">)</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">v</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">ortho_en</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">u</span><span class="p">,</span><span class="n">mat_ortho</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">u</span>

<span class="k">def</span> <span class="nf">proj_cube</span><span class="p">(</span><span class="n">im</span><span class="p">,</span><span class="n">cube</span><span class="p">,</span><span class="n">ortho</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="n">cube_proj</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">cube</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">ortho</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">cube_proj</span> <span class="o">=</span> <span class="n">gram_schmidt_cube</span><span class="p">(</span><span class="n">cube</span><span class="p">)</span>

    <span class="n">shap</span> <span class="o">=</span> <span class="n">cube</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">im_proj</span> <span class="o">=</span> <span class="n">im</span><span class="o">*</span><span class="mi">0</span>
    <span class="n">k</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">if</span> <span class="n">size</span><span class="p">(</span><span class="n">shap</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
            <span class="n">im_proj</span> <span class="o">=</span> <span class="n">im_proj</span><span class="o">+</span><span class="p">((</span><span class="n">im</span><span class="o">*</span><span class="n">cube_proj</span><span class="p">[:,:,</span><span class="n">k</span><span class="p">])</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span><span class="o">*</span><span class="n">cube_proj</span><span class="p">[:,:,</span><span class="n">k</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">im_proj</span> <span class="o">=</span> <span class="n">im_proj</span><span class="o">+</span><span class="p">((</span><span class="n">im</span><span class="o">*</span><span class="n">cube_proj</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span><span class="o">*</span><span class="n">cube_proj</span>
    <span class="k">return</span> <span class="n">im_proj</span>

<span class="k">def</span> <span class="nf">shape_projector</span><span class="p">(</span><span class="n">im</span><span class="p">,</span><span class="n">cent_shape</span><span class="p">,</span><span class="n">shape_ortho_basis</span><span class="p">,</span><span class="n">mu</span><span class="p">,</span><span class="n">niter</span><span class="o">=</span><span class="mi">50</span><span class="p">):</span>
    <span class="kn">from</span> <span class="nn">numpy</span> <span class="k">import</span> <span class="o">*</span>
    <span class="n">mse</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">niter</span><span class="p">,))</span>
    <span class="n">n1</span> <span class="o">=</span> <span class="n">im</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">n2</span> <span class="o">=</span> <span class="n">im</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">dim_shape</span> <span class="o">=</span> <span class="n">n1</span><span class="o">*</span><span class="n">n2</span><span class="o">*</span><span class="mi">6</span>
    <span class="n">U</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">dim_shape</span><span class="p">,))</span>
    <span class="n">V</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">dim_shape</span><span class="p">,))</span>
    <span class="n">V_old</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">V</span><span class="p">)</span>
    <span class="n">i</span><span class="o">=</span><span class="mi">0</span>
    <span class="n">t</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">told</span> <span class="o">=</span> <span class="n">t</span>
    <span class="n">shap</span> <span class="o">=</span> <span class="n">im</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">im_shape_mat</span> <span class="o">=</span> <span class="n">mat_mm_ell</span><span class="p">(</span><span class="n">im</span><span class="p">)</span>
    <span class="n">delta</span>  <span class="o">=</span> <span class="n">im_shape_mat</span><span class="o">-</span><span class="n">cent_shape</span>
    <span class="n">delta_vec</span> <span class="o">=</span> <span class="n">delta</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">dim_shape</span><span class="p">,))</span>
    <span class="n">proj_offset</span> <span class="o">=</span> <span class="n">delta_vec</span> <span class="o">-</span> <span class="n">shape_ortho_basis</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">transpose</span><span class="p">(</span><span class="n">shape_ortho_basis</span><span class="p">)</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">delta_vec</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">niter</span><span class="p">):</span>
        <span class="n">temp_proj</span> <span class="o">=</span> <span class="n">U</span> <span class="o">-</span> <span class="n">shape_ortho_basis</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">transpose</span><span class="p">(</span><span class="n">shape_ortho_basis</span><span class="p">)</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">U</span><span class="p">))</span>
        <span class="n">mat_temp_proj</span> <span class="o">=</span> <span class="n">temp_proj</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="n">n1</span><span class="o">*</span><span class="n">n2</span><span class="p">)</span>
        <span class="n">bck_proj_temp</span> <span class="o">=</span> <span class="n">transpose_mat_ell</span><span class="p">(</span><span class="n">mat_temp_proj</span><span class="p">,</span><span class="n">shap</span><span class="p">)</span>
        <span class="n">mat_bck_proj_temp</span> <span class="o">=</span> <span class="n">mat_mm_ell</span><span class="p">(</span><span class="n">bck_proj_temp</span><span class="p">)</span>
        <span class="n">mat_bck_proj_temp_vec</span> <span class="o">=</span> <span class="n">mat_bck_proj_temp</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">dim_shape</span><span class="p">,))</span>
        <span class="n">grad</span> <span class="o">=</span> <span class="o">-</span><span class="n">proj_offset</span><span class="o">+</span><span class="p">(</span><span class="n">mat_bck_proj_temp_vec</span> <span class="o">-</span> <span class="n">shape_ortho_basis</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">transpose</span><span class="p">(</span><span class="n">shape_ortho_basis</span><span class="p">)</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">mat_bck_proj_temp_vec</span><span class="p">)))</span>
        <span class="n">mse</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">grad</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="nb">print</span> <span class="n">mse</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">V</span> <span class="o">=</span> <span class="n">U</span> <span class="o">-</span> <span class="n">mu</span><span class="o">*</span><span class="n">grad</span>
        <span class="n">t</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">4</span><span class="o">*</span><span class="n">told</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span><span class="o">/</span><span class="mi">2</span>
        <span class="n">lamb</span> <span class="o">=</span> <span class="mi">1</span><span class="o">+</span><span class="p">(</span><span class="n">told</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="n">t</span>
        <span class="n">told</span> <span class="o">=</span> <span class="n">t</span>
        <span class="n">U</span> <span class="o">=</span> <span class="n">V_old</span> <span class="o">+</span> <span class="n">lamb</span><span class="o">*</span><span class="p">(</span><span class="n">V</span><span class="o">-</span><span class="n">V_old</span><span class="p">)</span>
        <span class="n">V_old</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">V</span><span class="p">)</span>
    <span class="n">temp_proj</span> <span class="o">=</span> <span class="n">U</span> <span class="o">-</span> <span class="n">shape_ortho_basis</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">transpose</span><span class="p">(</span><span class="n">shape_ortho_basis</span><span class="p">)</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">U</span><span class="p">))</span>
    <span class="n">mat_temp_proj</span> <span class="o">=</span> <span class="n">temp_proj</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="n">n1</span><span class="o">*</span><span class="n">n2</span><span class="p">)</span>
    <span class="n">bck_proj_temp</span> <span class="o">=</span> <span class="n">transpose_mat_ell</span><span class="p">(</span><span class="n">mat_temp_proj</span><span class="p">,</span><span class="n">shap</span><span class="p">)</span>
    <span class="n">proj_im</span> <span class="o">=</span> <span class="n">im</span> <span class="o">-</span> <span class="n">bck_proj_temp</span>

    <span class="n">mat_proj_im</span> <span class="o">=</span> <span class="n">mat_mm_ell</span><span class="p">(</span><span class="n">proj_im</span><span class="p">)</span>
    <span class="n">delta</span>  <span class="o">=</span> <span class="n">mat_proj_im</span><span class="o">-</span><span class="n">cent_shape</span>
    <span class="n">delta_vec</span> <span class="o">=</span> <span class="n">delta</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">dim_shape</span><span class="p">,))</span>
    <span class="n">proj_offset</span> <span class="o">=</span> <span class="n">delta_vec</span> <span class="o">-</span> <span class="n">shape_ortho_basis</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">transpose</span><span class="p">(</span><span class="n">shape_ortho_basis</span><span class="p">)</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">delta_vec</span><span class="p">))</span>
    <span class="n">mat_proj_offset</span> <span class="o">=</span> <span class="n">proj_offset</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="n">n1</span><span class="p">,</span><span class="n">n2</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">mse</span><span class="p">,</span><span class="n">proj_im</span><span class="p">,</span><span class="n">proj_offset</span><span class="p">,</span><span class="n">delta</span>


<span class="k">def</span> <span class="nf">shape_projector_opt_step</span><span class="p">(</span><span class="n">im</span><span class="p">,</span><span class="n">cent_shape</span><span class="p">,</span><span class="n">back_cent_shape</span><span class="p">,</span><span class="n">shape_ortho_basis</span><span class="p">,</span><span class="n">mu</span><span class="p">,</span><span class="n">niter</span><span class="o">=</span><span class="mi">50</span><span class="p">):</span>
    <span class="kn">from</span> <span class="nn">numpy</span> <span class="k">import</span> <span class="o">*</span>
    <span class="n">mse</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">niter</span><span class="p">,))</span>
    <span class="n">n1</span> <span class="o">=</span> <span class="n">im</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">n2</span> <span class="o">=</span> <span class="n">im</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">dim_shape</span> <span class="o">=</span> <span class="n">n1</span><span class="o">*</span><span class="n">n2</span><span class="o">*</span><span class="mi">6</span>
    <span class="n">U</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">dim_shape</span><span class="p">,))</span>
    <span class="n">V</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">dim_shape</span><span class="p">,))</span>
    <span class="n">V_old</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">V</span><span class="p">)</span>
    <span class="n">i</span><span class="o">=</span><span class="mi">0</span>
    <span class="n">t</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">told</span> <span class="o">=</span> <span class="n">t</span>
    <span class="n">shap</span> <span class="o">=</span> <span class="n">im</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">im_shape_mat</span> <span class="o">=</span> <span class="n">mat_mm_ell</span><span class="p">(</span><span class="n">im</span><span class="p">)</span>
    <span class="n">delta</span>  <span class="o">=</span> <span class="n">im_shape_mat</span><span class="o">-</span><span class="n">cent_shape</span>
    <span class="n">im_delta</span> <span class="o">=</span> <span class="n">im</span> <span class="o">-</span> <span class="n">back_cent_shape</span>
    <span class="n">delta_vec</span> <span class="o">=</span> <span class="n">delta</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">dim_shape</span><span class="p">,))</span>
    <span class="n">proj_offset</span> <span class="o">=</span> <span class="n">delta_vec</span> <span class="o">-</span> <span class="n">shape_ortho_basis</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">transpose</span><span class="p">(</span><span class="n">shape_ortho_basis</span><span class="p">)</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">delta_vec</span><span class="p">))</span>
    <span class="n">step</span> <span class="o">=</span> <span class="o">-</span><span class="n">mu</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">niter</span><span class="p">):</span>
        <span class="n">temp_proj</span> <span class="o">=</span> <span class="n">U</span> <span class="o">-</span> <span class="n">shape_ortho_basis</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">transpose</span><span class="p">(</span><span class="n">shape_ortho_basis</span><span class="p">)</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">U</span><span class="p">))</span>
        <span class="n">mat_temp_proj</span> <span class="o">=</span> <span class="n">temp_proj</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="n">n1</span><span class="o">*</span><span class="n">n2</span><span class="p">)</span>
        <span class="n">bck_proj_temp</span> <span class="o">=</span> <span class="n">transpose_mat_ell</span><span class="p">(</span><span class="n">mat_temp_proj</span><span class="p">,</span><span class="n">shap</span><span class="p">)</span>
        <span class="n">mat_bck_proj_temp</span> <span class="o">=</span> <span class="n">mat_mm_ell</span><span class="p">(</span><span class="n">bck_proj_temp</span><span class="p">)</span>
        <span class="n">mat_bck_proj_temp_vec</span> <span class="o">=</span> <span class="n">mat_bck_proj_temp</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">dim_shape</span><span class="p">,))</span>
        <span class="n">grad</span> <span class="o">=</span> <span class="o">-</span><span class="n">proj_offset</span><span class="o">+</span><span class="p">(</span><span class="n">mat_bck_proj_temp_vec</span> <span class="o">-</span> <span class="n">shape_ortho_basis</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">transpose</span><span class="p">(</span><span class="n">shape_ortho_basis</span><span class="p">)</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">mat_bck_proj_temp_vec</span><span class="p">)))</span>

        <span class="n">temp_proj_2</span> <span class="o">=</span> <span class="n">grad</span> <span class="o">-</span> <span class="n">shape_ortho_basis</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">transpose</span><span class="p">(</span><span class="n">shape_ortho_basis</span><span class="p">)</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">grad</span><span class="p">))</span>
        <span class="n">mat_temp_proj_2</span> <span class="o">=</span> <span class="n">temp_proj_2</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="n">n1</span><span class="o">*</span><span class="n">n2</span><span class="p">)</span>
        <span class="n">bck_proj_temp_2</span> <span class="o">=</span> <span class="n">transpose_mat_ell</span><span class="p">(</span><span class="n">mat_temp_proj_2</span><span class="p">,</span><span class="n">shap</span><span class="p">)</span>
        <span class="n">a1</span> <span class="o">=</span> <span class="p">((</span><span class="n">im_delta</span> <span class="o">-</span> <span class="n">bck_proj_temp</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="n">a2</span> <span class="o">=</span> <span class="p">((</span><span class="n">im_delta</span> <span class="o">-</span> <span class="n">bck_proj_temp</span><span class="p">)</span><span class="o">*</span><span class="n">bck_proj_temp_2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="nb">print</span> <span class="s1">&#39;step_size = &#39;</span><span class="p">,</span><span class="n">step</span>
        <span class="n">step</span> <span class="o">=</span> <span class="n">a1</span><span class="o">/</span><span class="n">a2</span>
        <span class="n">mse</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">grad</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="nb">print</span> <span class="s1">&#39;err = &#39;</span><span class="p">,</span><span class="n">mse</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">U</span> <span class="o">=</span> <span class="n">U</span><span class="o">+</span><span class="n">step</span><span class="o">*</span><span class="n">grad</span>
    <span class="n">temp_proj</span> <span class="o">=</span> <span class="n">U</span> <span class="o">-</span> <span class="n">shape_ortho_basis</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">transpose</span><span class="p">(</span><span class="n">shape_ortho_basis</span><span class="p">)</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">U</span><span class="p">))</span>
    <span class="n">mat_temp_proj</span> <span class="o">=</span> <span class="n">temp_proj</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="n">n1</span><span class="o">*</span><span class="n">n2</span><span class="p">)</span>
    <span class="n">bck_proj_temp</span> <span class="o">=</span> <span class="n">transpose_mat_ell</span><span class="p">(</span><span class="n">mat_temp_proj</span><span class="p">,</span><span class="n">shap</span><span class="p">)</span>
    <span class="n">proj_im</span> <span class="o">=</span> <span class="n">im</span> <span class="o">-</span> <span class="n">bck_proj_temp</span>

    <span class="n">mat_proj_im</span> <span class="o">=</span> <span class="n">mat_mm_ell</span><span class="p">(</span><span class="n">proj_im</span><span class="p">)</span>
    <span class="n">delta</span>  <span class="o">=</span> <span class="n">mat_proj_im</span><span class="o">-</span><span class="n">cent_shape</span>
    <span class="n">delta_vec</span> <span class="o">=</span> <span class="n">delta</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">dim_shape</span><span class="p">,))</span>
    <span class="n">proj_offset</span> <span class="o">=</span> <span class="n">delta_vec</span> <span class="o">-</span> <span class="n">shape_ortho_basis</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">transpose</span><span class="p">(</span><span class="n">shape_ortho_basis</span><span class="p">)</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">delta_vec</span><span class="p">))</span>
    <span class="n">mat_proj_offset</span> <span class="o">=</span> <span class="n">proj_offset</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="n">n1</span><span class="p">,</span><span class="n">n2</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">mse</span><span class="p">,</span><span class="n">proj_im</span><span class="p">,</span><span class="n">proj_offset</span><span class="p">,</span><span class="n">delta</span>


<div class="viewcode-block" id="lanczos"><a class="viewcode-back" href="../utils.html#utils.lanczos">[docs]</a><span class="k">def</span> <span class="nf">lanczos</span><span class="p">(</span><span class="n">U</span><span class="p">,</span><span class="n">n</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span><span class="n">n2</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Generate Lanczos kernel for a given shift.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">n2</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">n2</span> <span class="o">=</span> <span class="n">n</span>
    <span class="n">siz</span> <span class="o">=</span> <span class="n">size</span><span class="p">(</span><span class="n">U</span><span class="p">)</span>
    <span class="n">H</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">siz</span> <span class="o">==</span> <span class="mi">2</span><span class="p">):</span>
        <span class="n">U_in</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">U</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">U</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">U_in</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span>
            <span class="n">U_in</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="n">U</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">U_in</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">=</span><span class="n">U</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">H</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="mi">2</span><span class="o">*</span><span class="n">n</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="o">*</span><span class="n">n2</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">U_in</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">U_in</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
            <span class="n">H</span><span class="p">[</span><span class="n">n</span><span class="p">,</span><span class="n">n2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">i</span><span class="o">=</span><span class="mi">0</span>
            <span class="n">j</span><span class="o">=</span><span class="mi">0</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="o">*</span><span class="n">n</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="o">*</span><span class="n">n2</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
                    <span class="n">H</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">sinc</span><span class="p">(</span><span class="n">U_in</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="p">(</span><span class="n">i</span><span class="o">-</span><span class="n">n</span><span class="p">))</span><span class="o">*</span><span class="n">sinc</span><span class="p">((</span><span class="n">U_in</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="p">(</span><span class="n">i</span><span class="o">-</span><span class="n">n</span><span class="p">))</span><span class="o">/</span><span class="n">n</span><span class="p">)</span><span class="o">*</span><span class="n">sinc</span><span class="p">(</span><span class="n">U_in</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="p">(</span><span class="n">j</span><span class="o">-</span><span class="n">n</span><span class="p">))</span><span class="o">*</span><span class="n">sinc</span><span class="p">((</span><span class="n">U_in</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="p">(</span><span class="n">j</span><span class="o">-</span><span class="n">n</span><span class="p">))</span><span class="o">/</span><span class="n">n</span><span class="p">)</span>

    <span class="k">else</span> <span class="p">:</span>
        <span class="n">H</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="mi">2</span><span class="o">*</span><span class="n">n</span><span class="o">+</span><span class="mi">1</span><span class="p">,))</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="o">*</span><span class="n">n</span><span class="p">):</span>
            <span class="n">H</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">sinc</span><span class="p">(</span><span class="n">pi</span><span class="o">*</span><span class="p">(</span><span class="n">U</span><span class="o">-</span><span class="p">(</span><span class="n">i</span><span class="o">-</span><span class="n">n</span><span class="p">)))</span><span class="o">*</span><span class="n">sinc</span><span class="p">(</span><span class="n">pi</span><span class="o">*</span><span class="p">(</span><span class="n">U</span><span class="o">-</span><span class="p">(</span><span class="n">i</span><span class="o">-</span><span class="n">n</span><span class="p">))</span><span class="o">/</span><span class="n">n</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">H</span></div>

<span class="k">def</span> <span class="nf">shift</span><span class="p">(</span><span class="n">im</span><span class="p">,</span><span class="n">U</span><span class="p">,</span><span class="n">n</span><span class="o">=</span><span class="mi">5</span><span class="p">):</span>
    <span class="n">shap</span> <span class="o">=</span> <span class="n">im</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">M</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">n</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">M</span> <span class="o">=</span> <span class="n">lanczos</span><span class="p">(</span><span class="n">U</span><span class="p">,</span><span class="n">n</span><span class="o">=</span><span class="nb">int</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">),</span><span class="n">n2</span><span class="o">=</span><span class="nb">int</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">M</span> <span class="o">=</span> <span class="n">lanczos</span><span class="p">(</span><span class="n">U</span><span class="p">,</span><span class="n">n</span><span class="o">=</span><span class="n">n</span><span class="p">,</span><span class="n">n2</span><span class="o">=</span><span class="n">n</span><span class="p">)</span>
    <span class="n">im_out</span> <span class="o">=</span> <span class="n">scisig</span><span class="o">.</span><span class="n">fftconvolve</span><span class="p">(</span><span class="n">im</span><span class="p">,</span><span class="n">M</span><span class="p">,</span><span class="n">mode</span><span class="o">=</span><span class="s1">&#39;same&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">im_out</span>

<span class="k">def</span> <span class="nf">shift_stack</span><span class="p">(</span><span class="n">im_stack</span><span class="p">,</span><span class="n">U</span><span class="p">,</span><span class="n">n</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="n">im_out</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">im_stack</span><span class="p">)</span>
    <span class="n">nb_psf</span> <span class="o">=</span> <span class="n">im_stack</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_psf</span><span class="p">):</span>
        <span class="n">im_out</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">shift</span><span class="p">(</span><span class="n">im_stack</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">],</span><span class="n">U</span><span class="p">[</span><span class="n">i</span><span class="p">,:],</span><span class="n">n</span><span class="o">=</span><span class="n">n</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">im_out</span>

<span class="k">def</span> <span class="nf">stack_norm</span><span class="p">(</span><span class="n">im_stack</span><span class="p">,</span><span class="n">norm</span><span class="o">=</span><span class="mi">2</span><span class="p">):</span>
    <span class="n">im_out</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">im_stack</span><span class="p">)</span>
    <span class="n">nb_psf</span> <span class="o">=</span> <span class="n">im_stack</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_psf</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">norm</span><span class="o">==</span><span class="mi">2</span><span class="p">:</span>
            <span class="n">im_out</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">im_out</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">]</span><span class="o">/</span><span class="n">sqrt</span><span class="p">((</span><span class="n">im_out</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span>
        <span class="k">elif</span> <span class="n">norm</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">im_out</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">im_out</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">]</span><span class="o">/</span><span class="p">(</span><span class="n">im_out</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span>
    <span class="k">return</span> <span class="n">im_out</span>

<span class="k">def</span> <span class="nf">stack_regist</span><span class="p">(</span><span class="n">im_stack</span><span class="p">,</span><span class="n">n</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="n">U</span> <span class="o">=</span> <span class="n">int_grid_shift</span><span class="p">(</span><span class="n">im_stack</span><span class="p">)</span>
    <span class="n">im_reg</span> <span class="o">=</span> <span class="n">shift_stack</span><span class="p">(</span><span class="n">im_stack</span><span class="p">,</span><span class="o">-</span><span class="n">U</span><span class="p">,</span><span class="n">n</span><span class="o">=</span><span class="n">n</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">im_reg</span>

<span class="k">def</span> <span class="nf">corr_shift_est</span><span class="p">(</span><span class="n">im1</span><span class="p">,</span><span class="n">im2</span><span class="p">,</span><span class="n">upfact</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>


    <span class="n">im_1_in</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">im1</span><span class="p">)</span>
    <span class="n">im_2_in</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">im2</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">upfact</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">:</span>
        <span class="n">im_1_in</span> <span class="o">=</span> <span class="n">zoom</span><span class="p">(</span><span class="n">im1</span><span class="p">,</span> <span class="n">upfact</span><span class="p">,</span><span class="n">order</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;constant&#39;</span><span class="p">,</span> <span class="n">cval</span><span class="o">=</span><span class="mf">0.0</span><span class="p">)</span>
        <span class="n">im_2_in</span> <span class="o">=</span> <span class="n">zoom</span><span class="p">(</span><span class="n">im2</span><span class="p">,</span> <span class="n">upfact</span><span class="p">,</span><span class="n">order</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;constant&#39;</span><span class="p">,</span> <span class="n">cval</span><span class="o">=</span><span class="mf">0.0</span><span class="p">)</span>
    <span class="n">shap</span> <span class="o">=</span> <span class="n">im_1_in</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">di</span> <span class="o">=</span> <span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">%</span><span class="mi">2</span>
    <span class="n">dj</span> <span class="o">=</span> <span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">%</span><span class="mi">2</span>
    <span class="n">pos_ref</span> <span class="o">=</span> <span class="p">[</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span> <span class="o">+</span><span class="n">di</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span> <span class="o">+</span><span class="n">dj</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">cross_corr</span> <span class="o">=</span> <span class="n">scisig</span><span class="o">.</span><span class="n">correlate2d</span><span class="p">(</span><span class="n">im_1_in</span><span class="p">,</span> <span class="n">im_2_in</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;same&#39;</span><span class="p">,</span> <span class="n">boundary</span><span class="o">=</span><span class="s1">&#39;fill&#39;</span><span class="p">,</span> <span class="n">fillvalue</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">i</span><span class="p">,</span><span class="n">j</span> <span class="o">=</span> <span class="n">where</span><span class="p">(</span><span class="n">cross_corr</span><span class="o">==</span><span class="n">cross_corr</span><span class="o">.</span><span class="n">max</span><span class="p">())</span>

    <span class="n">shifts</span> <span class="o">=</span> <span class="n">double</span><span class="p">([</span><span class="n">pos_ref</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">pos_ref</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">j</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span><span class="o">/</span><span class="n">upfact</span>

    <span class="k">return</span> <span class="n">cross_corr</span><span class="p">,</span><span class="n">shifts</span>

<span class="k">def</span> <span class="nf">corr_shift_est_stack</span><span class="p">(</span><span class="n">im_stack</span><span class="p">,</span><span class="n">upfact</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
    <span class="n">shap</span> <span class="o">=</span> <span class="n">im_stack</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">shifts_est</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="mi">2</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
        <span class="n">cross_corr</span><span class="p">,</span><span class="n">shifts</span> <span class="o">=</span> <span class="n">corr_shift_est</span><span class="p">(</span><span class="n">im_stack</span><span class="p">[:,:,</span><span class="mi">0</span><span class="p">],</span><span class="n">im_stack</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">],</span><span class="n">upfact</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">shifts_est</span><span class="p">[</span><span class="n">i</span><span class="p">,:]</span><span class="o">=</span><span class="n">array</span><span class="p">(</span><span class="n">shifts</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">shifts_est</span>


<span class="k">def</span> <span class="nf">shift_transpose</span><span class="p">(</span><span class="n">im</span><span class="p">,</span><span class="n">U</span><span class="p">,</span><span class="n">n</span><span class="o">=</span><span class="mi">10</span><span class="p">):</span>
    <span class="n">shap</span> <span class="o">=</span> <span class="n">im</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">M</span> <span class="o">=</span> <span class="n">lanczos</span><span class="p">(</span><span class="n">U</span><span class="p">,</span><span class="n">n</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
    <span class="n">im_out</span> <span class="o">=</span> <span class="n">scisig</span><span class="o">.</span><span class="n">fftconvolve</span><span class="p">(</span><span class="n">im</span><span class="p">,</span><span class="n">rot90</span><span class="p">(</span><span class="n">M</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span><span class="n">mode</span><span class="o">=</span><span class="s1">&#39;same&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">im_out</span>

<span class="k">def</span> <span class="nf">lanczos_rot</span><span class="p">(</span><span class="n">img</span><span class="p">,</span><span class="n">theta</span><span class="p">,</span><span class="n">lanczos_rad</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span><span class="n">marg</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    <span class="nb">print</span> <span class="s1">&#39;theta = &#39;</span><span class="p">,</span><span class="n">theta</span>
    <span class="n">img_rot</span> <span class="o">=</span> <span class="mi">0</span><span class="o">*</span><span class="n">padding</span><span class="p">(</span><span class="n">img</span><span class="p">,</span><span class="n">marg</span><span class="p">)</span>
    <span class="n">shap</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">diag_l</span> <span class="o">=</span> <span class="n">sqrt</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="mi">2</span><span class="o">*</span><span class="n">marg</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="p">(</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="mi">2</span><span class="o">*</span><span class="n">marg</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">padding_band</span> <span class="o">=</span> <span class="nb">round</span><span class="p">((</span><span class="n">diag_l</span> <span class="o">-</span> <span class="nb">min</span><span class="p">(</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span><span class="o">/</span><span class="mi">2</span><span class="o">+</span><span class="n">lanczos_rad</span><span class="p">)</span>
    <span class="n">img_padd</span> <span class="o">=</span> <span class="n">padding</span><span class="p">(</span><span class="n">img</span><span class="p">,</span><span class="n">padding_band</span><span class="p">)</span>
    <span class="n">i</span><span class="o">=</span><span class="mi">0</span>
    <span class="n">j</span><span class="o">=</span><span class="mi">0</span>
    <span class="n">Mrot</span> <span class="o">=</span> <span class="n">array</span><span class="p">([[</span><span class="n">cos</span><span class="p">(</span><span class="n">theta</span><span class="p">),</span><span class="n">sin</span><span class="p">(</span><span class="n">theta</span><span class="p">)],[</span><span class="o">-</span><span class="n">sin</span><span class="p">(</span><span class="n">theta</span><span class="p">),</span><span class="n">cos</span><span class="p">(</span><span class="n">theta</span><span class="p">)]])</span>

    <span class="n">O1</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>
    <span class="n">O1</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="p">(</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span> <span class="o">+</span> <span class="n">marg</span>
    <span class="n">O1</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="p">(</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span> <span class="o">+</span> <span class="n">marg</span>
    <span class="n">O2</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>
    <span class="n">O2</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="p">(</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="o">+</span><span class="n">padding_band</span>
    <span class="n">O2</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="p">(</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="o">+</span><span class="n">padding_band</span>

    <span class="n">Y</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="mi">2</span><span class="o">*</span><span class="n">marg</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="mi">2</span><span class="o">*</span><span class="n">marg</span><span class="p">):</span>
            <span class="n">Y</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span>
            <span class="n">Y</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">j</span>
            <span class="n">X1</span> <span class="o">=</span> <span class="n">Mrot</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">Y</span><span class="o">-</span><span class="n">O1</span><span class="p">)</span>
            <span class="n">X2</span> <span class="o">=</span> <span class="n">X1</span><span class="o">+</span><span class="n">O2</span>
            <span class="n">X2_int</span> <span class="o">=</span> <span class="n">floor</span><span class="p">(</span><span class="n">X2</span><span class="p">)</span>
            <span class="n">delta</span> <span class="o">=</span> <span class="n">X2</span><span class="o">-</span><span class="n">X2_int</span>

            <span class="n">mask_lanc</span> <span class="o">=</span> <span class="n">lanczos</span><span class="p">(</span><span class="n">delta</span><span class="p">)</span>
            <span class="n">l</span><span class="o">=</span><span class="mi">0</span>
            <span class="n">m</span><span class="o">=</span><span class="mi">0</span>
            <span class="n">valij</span><span class="o">=</span><span class="mi">0</span>
            <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="o">*</span><span class="n">lanczos_rad</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="o">*</span><span class="n">lanczos_rad</span><span class="p">):</span>
                    <span class="n">valij</span> <span class="o">=</span> <span class="n">valij</span><span class="o">+</span><span class="n">mask_lanc</span><span class="p">[</span><span class="n">l</span><span class="p">,</span><span class="n">m</span><span class="p">]</span><span class="o">*</span><span class="n">img_padd</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">X2_int</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span><span class="o">-</span><span class="n">lanczos_rad</span><span class="o">+</span><span class="n">l</span><span class="p">,</span><span class="nb">int</span><span class="p">(</span><span class="n">X2_int</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span><span class="o">-</span><span class="n">lanczos_rad</span><span class="o">+</span><span class="n">m</span><span class="p">]</span>
            <span class="n">img_rot</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span><span class="o">=</span><span class="n">valij</span>
    <span class="k">return</span> <span class="n">img_rot</span>

<span class="k">def</span> <span class="nf">transpose_lanczos_rot</span><span class="p">(</span><span class="n">img</span><span class="p">,</span><span class="n">theta</span><span class="p">,</span><span class="n">lanczos_rad</span><span class="o">=</span><span class="mi">10</span><span class="p">):</span>
    <span class="n">im_out</span> <span class="o">=</span> <span class="mi">0</span><span class="o">*</span><span class="n">img</span>
    <span class="n">shap</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">i</span><span class="o">=</span><span class="mi">0</span>
    <span class="n">j</span><span class="o">=</span><span class="mi">0</span>
    <span class="n">O1</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>
    <span class="n">O1</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="p">(</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span>
    <span class="n">O1</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="p">(</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span>
    <span class="n">Mrot1</span> <span class="o">=</span> <span class="n">array</span><span class="p">([[</span><span class="n">cos</span><span class="p">(</span><span class="n">theta</span><span class="p">),</span><span class="o">-</span><span class="n">sin</span><span class="p">(</span><span class="n">theta</span><span class="p">)],[</span><span class="n">sin</span><span class="p">(</span><span class="n">theta</span><span class="p">),</span><span class="n">cos</span><span class="p">(</span><span class="n">theta</span><span class="p">)]])</span>
    <span class="n">Mrot2</span> <span class="o">=</span> <span class="n">array</span><span class="p">([[</span><span class="n">cos</span><span class="p">(</span><span class="n">theta</span><span class="p">),</span><span class="n">sin</span><span class="p">(</span><span class="n">theta</span><span class="p">)],[</span><span class="o">-</span><span class="n">sin</span><span class="p">(</span><span class="n">theta</span><span class="p">),</span><span class="n">cos</span><span class="p">(</span><span class="n">theta</span><span class="p">)]])</span>
    <span class="n">diag_lanc_rad</span> <span class="o">=</span> <span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">lanczos_rad</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span>
    <span class="n">Y</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>
    <span class="n">Y1</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>
    <span class="n">Lc</span> <span class="o">=</span> <span class="n">ones</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span><span class="o">*</span><span class="n">lanczos_rad</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
            <span class="n">Y</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span>
            <span class="n">Y</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">j</span>
            <span class="n">X1</span>  <span class="o">=</span> <span class="n">Mrot1</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">Y</span><span class="o">-</span><span class="n">O1</span><span class="p">)</span><span class="o">+</span><span class="n">O1</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">floor</span><span class="p">(</span><span class="n">X1</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">&lt;</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="ow">and</span> <span class="p">(</span><span class="n">floor</span><span class="p">(</span><span class="n">X1</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">&gt;-</span><span class="mi">1</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">floor</span><span class="p">(</span><span class="n">X1</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">&lt;</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="ow">and</span> <span class="p">(</span><span class="n">floor</span><span class="p">(</span><span class="n">X1</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">&gt;-</span><span class="mi">1</span><span class="p">):</span>
                <span class="n">i1</span><span class="o">=</span><span class="mi">0</span>
                <span class="n">j1</span><span class="o">=</span><span class="mi">0</span>
                <span class="n">valij</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">for</span> <span class="n">i1</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">floor</span><span class="p">(</span><span class="n">X1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">diag_lanc_rad</span><span class="p">)),</span><span class="nb">min</span><span class="p">(</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">floor</span><span class="p">(</span><span class="n">X1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">diag_lanc_rad</span><span class="p">))):</span>
                    <span class="k">for</span> <span class="n">j1</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">floor</span><span class="p">(</span><span class="n">X1</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">diag_lanc_rad</span><span class="p">)),</span><span class="nb">min</span><span class="p">(</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">floor</span><span class="p">(</span><span class="n">X1</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">diag_lanc_rad</span><span class="p">))):</span>
                        <span class="n">Y1</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="n">i1</span>
                        <span class="n">Y1</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="n">j1</span>
                        <span class="n">Y2</span> <span class="o">=</span> <span class="n">Mrot2</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">Y1</span><span class="o">-</span><span class="n">O1</span><span class="p">)</span><span class="o">+</span><span class="n">O1</span>
                        <span class="n">Y2_int</span> <span class="o">=</span> <span class="n">floor</span><span class="p">(</span><span class="n">Y2</span><span class="p">)</span>
                        <span class="n">delta</span> <span class="o">=</span> <span class="n">Y2</span><span class="o">-</span><span class="n">Y2_int</span>
                        <span class="n">mask_lanc</span> <span class="o">=</span> <span class="n">lanczos</span><span class="p">(</span><span class="n">delta</span><span class="p">)</span>
                        <span class="n">pos_mask</span> <span class="o">=</span> <span class="n">Y</span><span class="o">-</span><span class="n">Y2_int</span><span class="o">+</span><span class="n">Lc</span>
                        <span class="k">if</span> <span class="p">(</span><span class="n">pos_mask</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">&lt;</span><span class="mi">2</span><span class="o">*</span><span class="n">lanczos_rad</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">pos_mask</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">&gt;-</span><span class="mi">1</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">pos_mask</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">&lt;</span><span class="mi">2</span><span class="o">*</span><span class="n">lanczos_rad</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">pos_mask</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">&gt;-</span><span class="mi">1</span><span class="p">):</span>
                            <span class="n">valij</span> <span class="o">=</span> <span class="n">valij</span> <span class="o">+</span> <span class="n">img</span><span class="p">[</span><span class="n">i1</span><span class="p">,</span><span class="n">j1</span><span class="p">]</span><span class="o">*</span><span class="n">mask_lanc</span><span class="p">[</span><span class="n">pos_mask</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span><span class="n">pos_mask</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]]</span>
                <span class="n">im_out</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span><span class="o">=</span><span class="n">valij</span>
    <span class="k">return</span> <span class="n">im_out</span>




<span class="k">def</span> <span class="nf">rotate_positions_field</span><span class="p">(</span><span class="nb">map</span><span class="p">,</span><span class="n">theta</span><span class="p">):</span>
    <span class="n">shap</span> <span class="o">=</span> <span class="nb">map</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">O</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>
    <span class="n">Y</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>
    <span class="n">O</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="nb">map</span><span class="p">[(</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">,(</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">O</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="nb">map</span><span class="p">[(</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">,(</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">rot_mat</span> <span class="o">=</span> <span class="n">array</span><span class="p">([[</span><span class="n">cos</span><span class="p">(</span><span class="n">theta</span><span class="p">),</span><span class="o">-</span><span class="n">sin</span><span class="p">(</span><span class="n">theta</span><span class="p">)],[</span><span class="n">sin</span><span class="p">(</span><span class="n">theta</span><span class="p">),</span><span class="n">cos</span><span class="p">(</span><span class="n">theta</span><span class="p">)]])</span>
    <span class="n">rot_map</span> <span class="o">=</span> <span class="mi">0</span><span class="o">*</span><span class="nb">map</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
            <span class="n">Y</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="nb">map</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">Y</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="nb">map</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">Yrot</span> <span class="o">=</span> <span class="n">rot_mat</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">Y</span><span class="o">-</span><span class="n">O</span><span class="p">)</span><span class="o">+</span><span class="n">O</span>
            <span class="n">rot_map</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">Yrot</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">rot_map</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">Yrot</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">rot_map</span>

<span class="k">def</span> <span class="nf">angle_est</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>

    <span class="n">theta</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span><span class="o">==</span><span class="mi">2</span><span class="p">:</span>
        <span class="n">param</span><span class="p">,</span><span class="n">fit</span><span class="o">=</span><span class="n">gaussfitter</span><span class="o">.</span><span class="n">gaussfit</span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="n">returnfitimage</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">theta</span> <span class="o">=</span> <span class="n">param</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span><span class="o">*</span><span class="n">pi</span><span class="o">/</span><span class="mi">180</span>
        <span class="k">if</span> <span class="n">param</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span><span class="o">&gt;</span><span class="n">param</span><span class="p">[</span><span class="mi">4</span><span class="p">]:</span>
            <span class="n">theta</span> <span class="o">=</span> <span class="o">-</span><span class="n">theta</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">theta</span> <span class="o">=</span> <span class="n">pi</span><span class="o">/</span><span class="mi">2</span><span class="o">-</span><span class="n">theta</span>
    <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span><span class="o">==</span><span class="mi">3</span><span class="p">:</span>
        <span class="n">theta</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">],))</span>
        <span class="n">i</span><span class="o">=</span><span class="mi">0</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
            <span class="n">param</span><span class="p">,</span><span class="n">fit</span><span class="o">=</span><span class="n">gaussfitter</span><span class="o">.</span><span class="n">gaussfit</span><span class="p">(</span><span class="n">data</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">],</span><span class="n">returnfitimage</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">param</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span><span class="o">&gt;</span><span class="n">param</span><span class="p">[</span><span class="mi">4</span><span class="p">]:</span>
                <span class="n">theta</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">param</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span><span class="o">*</span><span class="n">pi</span><span class="o">/</span><span class="mi">180</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">theta</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">pi</span><span class="o">/</span><span class="mi">2</span><span class="o">-</span><span class="n">param</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span><span class="o">*</span><span class="n">pi</span><span class="o">/</span><span class="mi">180</span>

    <span class="k">return</span> <span class="n">theta</span>

<span class="k">def</span> <span class="nf">rot_registration</span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="n">theta</span><span class="p">):</span>
    <span class="n">data_rot</span><span class="p">,</span><span class="n">cent</span> <span class="o">=</span> <span class="n">opencv_rot_interf</span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="n">theta</span><span class="p">)</span>
    <span class="c1">#lanczos_rot(data,-theta)</span>
    <span class="k">return</span> <span class="n">data_rot</span>


<span class="k">def</span> <span class="nf">rot_registration_cube</span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="n">theta</span><span class="p">,</span><span class="n">ib</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">ie</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="n">shap</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">k</span><span class="o">=</span><span class="mi">0</span>
    <span class="n">data_rot</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">ie</span><span class="o">-</span><span class="n">ib</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">ib</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">ib</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">if</span> <span class="n">ie</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">ie</span> <span class="o">=</span> <span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ib</span><span class="p">,</span><span class="n">ie</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
        <span class="nb">print</span> <span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="o">-</span><span class="n">ib</span><span class="p">,</span><span class="s1">&#39;/&#39;</span><span class="p">,</span><span class="n">ie</span><span class="o">-</span><span class="n">ib</span><span class="o">+</span><span class="mi">1</span>
        <span class="n">data_rot_k</span><span class="o">=</span><span class="n">rot_registration</span><span class="p">(</span><span class="n">data</span><span class="p">[:,:,</span><span class="n">k</span><span class="p">],</span><span class="n">theta</span><span class="p">[</span><span class="n">k</span><span class="o">-</span><span class="n">ib</span><span class="p">])</span>
        <span class="n">data_rot</span><span class="p">[:,:,</span><span class="n">k</span><span class="o">-</span><span class="n">ib</span><span class="p">]</span><span class="o">=</span><span class="n">data_rot_k</span>
    <span class="k">return</span> <span class="n">data_rot</span>

<span class="k">def</span> <span class="nf">mp_rand_rot</span><span class="p">(</span><span class="n">im_cube</span><span class="p">,</span><span class="n">nb_proc</span><span class="o">=</span><span class="mi">5</span><span class="p">):</span>
    <span class="n">shap</span> <span class="o">=</span> <span class="n">im_cube</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">nb_gal</span> <span class="o">=</span> <span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">cube_rot</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">im_cube</span><span class="p">)</span>
    <span class="n">theta</span> <span class="o">=</span> <span class="n">double</span><span class="p">(</span><span class="n">rand_diff_integ</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="mi">10</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span><span class="o">*</span><span class="p">(</span><span class="mf">360.0</span><span class="o">/</span><span class="p">(</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="mi">10</span><span class="p">))</span>
    <span class="nb">print</span> <span class="n">theta</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
    <span class="nb">slice</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">nb_gal</span><span class="o">/</span><span class="n">nb_proc</span><span class="p">)</span>

    <span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
        <span class="n">q</span> <span class="o">=</span> <span class="n">Queue</span><span class="p">()</span>
        <span class="n">jobs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_proc</span><span class="p">):</span>
            <span class="n">ib</span> <span class="o">=</span> <span class="n">i</span><span class="o">*</span><span class="nb">slice</span>
            <span class="n">ie</span> <span class="o">=</span> <span class="n">ib</span><span class="o">+</span><span class="nb">slice</span><span class="o">-</span><span class="mi">1</span>
            <span class="n">p</span> <span class="o">=</span> <span class="n">Process</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">mp_rot_cube</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">gal_test</span><span class="p">,</span><span class="n">theta</span><span class="p">[</span><span class="n">ib</span><span class="p">,</span><span class="n">ie</span><span class="o">+</span><span class="mi">1</span><span class="p">],</span><span class="n">ib</span><span class="p">,</span><span class="n">ie</span><span class="p">,</span><span class="n">q</span><span class="p">))</span>
            <span class="n">p</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
            <span class="n">jobs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_proc</span><span class="p">):</span>
            <span class="n">a</span> <span class="o">=</span> <span class="n">q</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
            <span class="n">cube_rot</span><span class="p">[:,:,</span><span class="n">a</span><span class="p">[</span><span class="mi">2</span><span class="p">]:</span><span class="n">a</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">cube_rot</span><span class="p">,</span><span class="n">theta</span>




<span class="k">def</span> <span class="nf">mp_rot_cube</span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="n">theta</span><span class="p">,</span><span class="n">ib</span><span class="p">,</span><span class="n">ie</span><span class="p">,</span><span class="n">q</span><span class="p">):</span>
    <span class="n">data_rot</span> <span class="o">=</span> <span class="n">rot_registration_cube</span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="n">theta</span><span class="p">,</span><span class="n">ib</span><span class="o">=</span><span class="n">ib</span><span class="p">,</span><span class="n">ie</span><span class="o">=</span><span class="n">ie</span><span class="p">)</span>
    <span class="n">q</span><span class="o">.</span><span class="n">put</span><span class="p">([</span><span class="n">data_rot</span><span class="p">,</span><span class="n">theta</span><span class="p">,</span><span class="n">ib</span><span class="p">,</span><span class="n">ie</span><span class="p">])</span>
    <span class="nb">print</span> <span class="s1">&#39;Data &#39;</span><span class="p">,</span><span class="n">ib</span><span class="p">,</span><span class="s1">&#39; --&gt; &#39;</span><span class="p">,</span><span class="n">ie</span><span class="p">;</span><span class="s1">&#39; processed&#39;</span>

<span class="k">def</span> <span class="nf">mp_rot_registration_cube</span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="n">ib</span><span class="p">,</span><span class="n">ie</span><span class="p">,</span><span class="n">q</span><span class="p">):</span>
    <span class="n">theta</span> <span class="o">=</span> <span class="n">angle_est</span><span class="p">(</span><span class="n">data</span><span class="p">[:,:,</span><span class="n">ib</span><span class="p">:</span><span class="n">ie</span><span class="o">+</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">data_rot</span> <span class="o">=</span> <span class="n">rot_registration_cube</span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="o">-</span><span class="n">theta</span><span class="o">*</span><span class="mi">180</span><span class="o">/</span><span class="n">pi</span><span class="p">,</span><span class="n">ib</span><span class="o">=</span><span class="n">ib</span><span class="p">,</span><span class="n">ie</span><span class="o">=</span><span class="n">ie</span><span class="p">)</span>
    <span class="n">q</span><span class="o">.</span><span class="n">put</span><span class="p">([</span><span class="n">data_rot</span><span class="p">,</span><span class="n">theta</span><span class="p">,</span><span class="n">ib</span><span class="p">,</span><span class="n">ie</span><span class="p">])</span>
    <span class="nb">print</span> <span class="s1">&#39;Data &#39;</span><span class="p">,</span><span class="n">ib</span><span class="p">,</span><span class="s1">&#39; --&gt; &#39;</span><span class="p">,</span><span class="n">ie</span><span class="p">;</span><span class="s1">&#39; processed&#39;</span>



<span class="k">def</span> <span class="nf">cube_to_mat</span><span class="p">(</span><span class="n">cube</span><span class="p">):</span>
    <span class="n">shap</span> <span class="o">=</span> <span class="n">cube</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">mat</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
    <span class="n">k</span><span class="o">=</span><span class="mi">0</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
        <span class="n">mat</span><span class="p">[</span><span class="n">k</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">cube</span><span class="p">[:,:,</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">mat</span>


<div class="viewcode-block" id="mat_to_cube"><a class="viewcode-back" href="../utils.html#utils.mat_to_cube">[docs]</a><span class="k">def</span> <span class="nf">mat_to_cube</span><span class="p">(</span><span class="n">mat</span><span class="p">,</span><span class="n">n1</span><span class="p">,</span><span class="n">n2</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Literally ``np.swapaxes`` I think.</span>
<span class="sd">    </span>
<span class="sd">    #TODO</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">shap</span> <span class="o">=</span> <span class="n">mat</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">cube</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">n1</span><span class="p">,</span><span class="n">n2</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
    <span class="n">k</span><span class="o">=</span><span class="mi">0</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
        <span class="n">cube</span><span class="p">[:,:,</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">mat</span><span class="p">[</span><span class="n">k</span><span class="p">,:]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">n1</span><span class="p">,</span><span class="n">n2</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">cube</span></div>

<span class="k">def</span> <span class="nf">cube_to_map</span><span class="p">(</span><span class="n">cube</span><span class="p">):</span>
    <span class="n">shap</span> <span class="o">=</span> <span class="n">cube</span><span class="o">.</span><span class="n">shape</span>
    <span class="nb">map</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
        <span class="nb">map</span><span class="p">[:,</span><span class="n">k</span><span class="o">*</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">]:(</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="n">cube</span><span class="p">[:,:,</span><span class="n">k</span><span class="p">]</span>
    <span class="k">return</span> <span class="nb">map</span>

<span class="k">def</span> <span class="nf">cube_to_map2</span><span class="p">(</span><span class="n">cube</span><span class="p">,</span><span class="n">n1</span><span class="p">,</span><span class="n">n2</span><span class="p">):</span>
    <span class="n">shap</span> <span class="o">=</span> <span class="n">cube</span><span class="o">.</span><span class="n">shape</span>
    <span class="nb">map</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">n1</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">/</span><span class="n">n1</span><span class="p">)))</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">n1</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">n2</span><span class="p">):</span>
            <span class="nb">map</span><span class="p">[</span><span class="n">i</span><span class="o">*</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]:(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">j</span><span class="o">*</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">]:(</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="n">cube</span><span class="p">[:,:,</span><span class="n">i</span><span class="o">+</span><span class="n">j</span><span class="o">*</span><span class="n">n1</span><span class="p">]</span>
    <span class="k">return</span> <span class="nb">map</span>


<span class="k">def</span> <span class="nf">map_to_cube</span><span class="p">(</span><span class="nb">map</span><span class="p">,</span><span class="n">n1</span><span class="p">,</span><span class="n">n2</span><span class="p">):</span>
    <span class="n">shap</span> <span class="o">=</span> <span class="nb">map</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">ax1</span> <span class="o">=</span> <span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="n">n1</span>
    <span class="n">ax2</span> <span class="o">=</span> <span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="n">n2</span>
    <span class="n">nb_slice</span> <span class="o">=</span> <span class="n">ax1</span><span class="o">*</span><span class="n">ax2</span>
    <span class="n">cube</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">n1</span><span class="p">,</span><span class="n">n2</span><span class="p">,</span><span class="n">nb_slice</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">ax1</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">ax2</span><span class="p">):</span>
            <span class="n">cube</span><span class="p">[:,:,</span><span class="n">i</span><span class="o">+</span><span class="n">j</span><span class="o">*</span><span class="n">ax1</span><span class="p">]</span> <span class="o">=</span> <span class="nb">map</span><span class="p">[</span><span class="n">n1</span><span class="o">*</span><span class="n">i</span><span class="p">:</span><span class="n">n1</span><span class="o">*</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span><span class="n">n2</span><span class="o">*</span><span class="n">j</span><span class="p">:</span><span class="n">n2</span><span class="o">*</span><span class="p">(</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">)]</span>
    <span class="k">return</span> <span class="n">cube</span>


<span class="k">def</span> <span class="nf">cube_gram_mat</span><span class="p">(</span><span class="n">cube</span><span class="p">):</span>
    <span class="n">shap</span> <span class="o">=</span> <span class="n">cube</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">mat</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
            <span class="n">mat</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">cube</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">]</span><span class="o">*</span><span class="n">cube</span><span class="p">[:,:,</span><span class="n">j</span><span class="p">])</span>
    <span class="n">mat</span> <span class="o">=</span> <span class="n">mat</span> <span class="o">+</span> <span class="n">transpose</span><span class="p">(</span><span class="n">mat</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
        <span class="n">mat</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">cube</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">mat</span>

<span class="k">def</span> <span class="nf">surf_interface</span><span class="p">(</span><span class="n">im</span><span class="p">,</span><span class="n">hess_thresh</span><span class="p">,</span><span class="n">max_iter</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">):</span>

    <span class="n">des</span><span class="o">=</span><span class="kc">None</span>
    <span class="n">a1</span><span class="o">=</span><span class="kc">False</span>
    <span class="n">a2</span><span class="o">=</span><span class="kc">False</span>
    <span class="n">a3</span><span class="o">=</span><span class="kc">False</span>
    <span class="n">im_in</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">im</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">im</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="mi">1</span><span class="p">),</span> <span class="n">uint8</span><span class="p">)</span>
    <span class="n">im_in</span><span class="p">[:,:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">255</span><span class="o">*</span><span class="p">(</span><span class="n">im</span><span class="o">-</span><span class="n">im</span><span class="o">.</span><span class="n">min</span><span class="p">())</span><span class="o">/</span><span class="p">(</span><span class="n">im</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">-</span><span class="n">im</span><span class="o">.</span><span class="n">min</span><span class="p">())</span>
    <span class="n">thresh_up</span><span class="o">=</span><span class="n">hess_thresh</span>
    <span class="n">thresh_down</span><span class="o">=</span><span class="n">hess_thresh</span>
    <span class="n">des_out</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span><span class="mi">128</span><span class="p">))</span>

    <span class="k">while</span> <span class="p">(</span><span class="n">a1</span><span class="o">==</span><span class="kc">False</span><span class="p">):</span>
        <span class="n">surf</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">SURF</span><span class="p">(</span><span class="n">thresh_up</span><span class="p">)</span>
        <span class="n">kp</span><span class="p">,</span> <span class="n">des_temp</span> <span class="o">=</span> <span class="n">surf</span><span class="o">.</span><span class="n">detectAndCompute</span><span class="p">(</span><span class="n">im_in</span><span class="p">,</span><span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">kp</span><span class="p">)</span> <span class="o">==</span><span class="mi">1</span><span class="p">):</span>
            <span class="n">a3</span><span class="o">=</span><span class="kc">True</span>
            <span class="n">a1</span><span class="o">=</span><span class="kc">True</span>
            <span class="n">des</span> <span class="o">=</span> <span class="n">des_temp</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">kp</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span><span class="p">):</span>
                <span class="n">a1</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">thresh_up</span> <span class="o">=</span> <span class="n">thresh_up</span><span class="o">*</span><span class="mi">2</span>
    <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">while</span> <span class="p">(</span><span class="n">a2</span><span class="o">==</span><span class="kc">False</span> <span class="ow">and</span> <span class="n">count</span><span class="o">&lt;</span><span class="n">max_iter</span><span class="p">):</span>
        <span class="n">surf</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">SURF</span><span class="p">(</span><span class="n">thresh_down</span><span class="p">)</span>
        <span class="n">kp</span><span class="p">,</span> <span class="n">des_temp</span> <span class="o">=</span> <span class="n">surf</span><span class="o">.</span><span class="n">detectAndCompute</span><span class="p">(</span><span class="n">im_in</span><span class="p">,</span><span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">kp</span><span class="p">)</span> <span class="o">==</span><span class="mi">1</span><span class="p">):</span>
            <span class="n">a3</span><span class="o">=</span><span class="kc">True</span>
            <span class="n">a2</span><span class="o">=</span><span class="kc">True</span>
            <span class="n">des</span> <span class="o">=</span> <span class="n">des_temp</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">kp</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">):</span>
                <span class="n">a2</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">thresh_down</span> <span class="o">=</span> <span class="n">thresh_down</span><span class="o">/</span><span class="mi">2</span>
    <span class="c1">#count +=1</span>
    <span class="k">if</span> <span class="n">count</span><span class="o">==</span><span class="n">max_iter</span><span class="p">:</span>
        <span class="nb">print</span> <span class="s1">&#39;max reached&#39;</span>
    <span class="n">a3</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">while</span> <span class="p">(</span><span class="n">a3</span><span class="o">==</span><span class="kc">False</span> <span class="ow">and</span> <span class="n">count</span><span class="o">&lt;</span><span class="n">max_iter</span><span class="p">):</span>
        <span class="n">thresh</span> <span class="o">=</span>  <span class="p">(</span><span class="n">thresh_up</span><span class="o">+</span><span class="n">thresh_down</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span>
        <span class="n">surf</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">SURF</span><span class="p">(</span><span class="n">thresh</span><span class="p">)</span>
        <span class="n">kp</span><span class="p">,</span> <span class="n">des_temp</span> <span class="o">=</span> <span class="n">surf</span><span class="o">.</span><span class="n">detectAndCompute</span><span class="p">(</span><span class="n">im_in</span><span class="p">,</span><span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">kp</span><span class="p">)</span> <span class="o">==</span><span class="mi">1</span><span class="p">):</span>
            <span class="n">a3</span><span class="o">=</span><span class="kc">True</span>
            <span class="c1">#print des_temp</span>
            <span class="n">des_out</span> <span class="o">=</span> <span class="n">des_temp</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">kp</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span><span class="p">):</span>
                <span class="n">thresh_up</span> <span class="o">=</span> <span class="n">thresh</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">thresh_down</span> <span class="o">=</span> <span class="n">thresh</span>
        <span class="n">count</span><span class="o">+=</span><span class="mi">1</span>
        <span class="k">if</span> <span class="n">count</span><span class="o">==</span><span class="n">max_iter</span><span class="p">:</span>
            <span class="n">des_out</span> <span class="o">=</span> <span class="n">des_temp</span><span class="p">[</span><span class="mi">0</span><span class="p">,:]</span>


    <span class="k">return</span> <span class="n">des_out</span>

<span class="k">def</span> <span class="nf">surf_interface_2</span><span class="p">(</span><span class="n">im</span><span class="p">,</span><span class="n">hess_thresh</span><span class="p">,</span><span class="n">max_iter</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">):</span>
    <span class="n">des</span><span class="o">=</span><span class="kc">None</span>
    <span class="n">a</span><span class="o">=</span><span class="kc">False</span>
    <span class="n">des_out</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span><span class="mi">128</span><span class="p">))</span>
    <span class="n">count</span><span class="o">=</span><span class="mi">0</span>
    <span class="n">im_in</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">im</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">im</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="mi">1</span><span class="p">),</span> <span class="n">uint8</span><span class="p">)</span>
    <span class="n">im_in</span><span class="p">[:,:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">255</span><span class="o">*</span><span class="p">(</span><span class="n">im</span><span class="o">-</span><span class="n">im</span><span class="o">.</span><span class="n">min</span><span class="p">())</span><span class="o">/</span><span class="p">(</span><span class="n">im</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">-</span><span class="n">im</span><span class="o">.</span><span class="n">min</span><span class="p">())</span>
    <span class="k">while</span> <span class="p">(</span><span class="n">a</span><span class="o">==</span><span class="kc">False</span> <span class="ow">and</span> <span class="n">count</span><span class="o">&lt;</span><span class="n">max_iter</span><span class="p">):</span>
        <span class="n">surf</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">SURF</span><span class="p">(</span><span class="n">hess_thresh</span><span class="p">)</span>
        <span class="n">kp</span><span class="p">,</span> <span class="n">des_temp</span> <span class="o">=</span> <span class="n">surf</span><span class="o">.</span><span class="n">detectAndCompute</span><span class="p">(</span><span class="n">im_in</span><span class="p">,</span><span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">kp</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">):</span>
            <span class="n">a</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">des_out</span> <span class="o">=</span> <span class="n">des_temp</span><span class="p">[</span><span class="mi">0</span><span class="p">,:]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">hess_thresh</span> <span class="o">=</span> <span class="n">hess_thresh</span><span class="o">/</span><span class="mi">2</span>
        <span class="n">count</span><span class="o">+=</span><span class="mi">1</span>
    <span class="k">return</span> <span class="n">des_out</span>


<span class="k">def</span> <span class="nf">surf_data_cube</span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="n">hess_thresh</span><span class="p">):</span>
    <span class="n">shap</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">k</span><span class="o">=</span><span class="mi">0</span>
    <span class="n">des</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="mi">128</span><span class="p">))</span>
    <span class="n">good_im</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
    <span class="n">bad_im</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
        <span class="n">imk</span> <span class="o">=</span> <span class="n">data</span><span class="p">[:,:,</span><span class="n">k</span><span class="p">]</span>
        <span class="n">desk</span> <span class="o">=</span> <span class="n">surf_interface_2</span><span class="p">(</span><span class="n">imk</span><span class="p">,</span><span class="n">hess_thresh</span><span class="p">)</span>
        <span class="n">des</span><span class="p">[</span><span class="n">k</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">desk</span>
        <span class="c1">#print &#39;Gal &#39;,k</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">desk</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
            <span class="nb">print</span> <span class="s1">&#39;Bad im &#39;</span><span class="p">,</span><span class="n">desk</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">desk</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
            <span class="n">bad_im</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">good_im</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">des</span><span class="p">,</span><span class="n">asarray</span><span class="p">(</span><span class="n">bad_im</span><span class="p">),</span><span class="n">asarray</span><span class="p">(</span><span class="n">good_im</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">kmeans_interface</span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="n">nb_cluster</span><span class="p">,</span><span class="n">good_im_ind</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">nb_iter</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span><span class="n">eps</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span><span class="n">nb_attempts</span><span class="o">=</span><span class="mi">5</span><span class="p">):</span>
    <span class="n">data_in</span> <span class="o">=</span> <span class="n">float32</span><span class="p">(</span><span class="n">copy</span><span class="p">(</span><span class="n">data</span><span class="p">))</span>
    <span class="n">criteria</span> <span class="o">=</span> <span class="p">(</span><span class="n">cv2</span><span class="o">.</span><span class="n">TERM_CRITERIA_EPS</span> <span class="o">+</span> <span class="n">cv2</span><span class="o">.</span><span class="n">TERM_CRITERIA_MAX_ITER</span><span class="p">,</span> <span class="n">nb_iter</span><span class="p">,</span> <span class="n">eps</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">good_im_ind</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">good_im_ind</span> <span class="o">=</span> <span class="n">array</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
    <span class="n">label</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">data_in</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
    <span class="n">ret</span><span class="p">,</span><span class="n">label</span><span class="p">,</span><span class="n">center</span><span class="o">=</span><span class="n">cv2</span><span class="o">.</span><span class="n">kmeans</span><span class="p">(</span><span class="n">data_in</span><span class="p">[</span><span class="n">good_im_ind</span><span class="p">,:],</span> <span class="n">nb_cluster</span><span class="p">,</span> <span class="n">label</span><span class="p">,</span><span class="n">criteria</span><span class="p">,</span> <span class="n">nb_attempts</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">KMEANS_PP_CENTERS</span><span class="p">)</span>
    <span class="n">label_ind</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
    <span class="n">i</span><span class="o">=</span><span class="mi">0</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_cluster</span><span class="p">):</span>
        <span class="n">ind</span> <span class="o">=</span> <span class="n">where</span><span class="p">(</span><span class="n">label</span><span class="o">==</span><span class="n">i</span><span class="p">)</span>
        <span class="n">label_ind</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">good_im_ind</span><span class="p">[</span><span class="n">ind</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span>

    <span class="k">return</span> <span class="n">ret</span><span class="p">,</span><span class="n">label_ind</span><span class="p">,</span><span class="n">label</span><span class="p">,</span><span class="n">center</span>



<span class="k">def</span> <span class="nf">kmeans_preproc</span><span class="p">(</span><span class="n">im</span><span class="p">,</span><span class="n">opt</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">filters</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="n">coeff</span><span class="p">,</span><span class="n">filters</span> <span class="o">=</span> <span class="n">isap</span><span class="o">.</span><span class="n">mr_trans_2</span><span class="p">(</span><span class="n">im</span><span class="p">,</span><span class="n">filters</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">opt</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
    <span class="n">shap</span> <span class="o">=</span> <span class="n">im</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">N1</span> <span class="o">=</span> <span class="n">array</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
    <span class="n">N1</span> <span class="o">=</span> <span class="n">N1</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
    <span class="n">N2</span> <span class="o">=</span> <span class="n">array</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
    <span class="n">N2</span> <span class="o">=</span> <span class="n">N2</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="mi">1</span><span class="p">))</span>
    <span class="n">ones1</span> <span class="o">=</span> <span class="n">ones</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="mi">1</span><span class="p">))</span>
    <span class="n">ones2</span> <span class="o">=</span> <span class="n">ones</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
    <span class="n">Xs</span> <span class="o">=</span> <span class="n">ones1</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">N1</span><span class="p">)</span>
    <span class="n">Ys</span> <span class="o">=</span> <span class="n">N2</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">ones2</span><span class="p">)</span>
    <span class="n">pos_map</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="mi">2</span><span class="p">))</span>
    <span class="n">pos_map</span><span class="p">[:,:,</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="n">Xs</span>
    <span class="n">pos_map</span><span class="p">[:,:,</span><span class="mi">1</span><span class="p">]</span><span class="o">=</span><span class="n">Ys</span>
    <span class="n">shap_coeff</span> <span class="o">=</span> <span class="n">coeff</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">stack_feat</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">shap_coeff</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">+</span><span class="mi">2</span><span class="p">))</span>
    <span class="n">stack_feat</span><span class="p">[:,:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">im</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">shap_coeff</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">+</span><span class="mi">2</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">shap_coeff</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">stack_feat</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">copy</span><span class="p">(</span><span class="n">coeff</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">])</span><span class="o">-</span><span class="n">mean</span><span class="p">(</span><span class="n">coeff</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">])</span><span class="o">*</span><span class="n">ones</span><span class="p">(</span><span class="n">shap</span><span class="p">))</span><span class="o">/</span><span class="n">coeff</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">stack_feat</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">copy</span><span class="p">(</span><span class="n">pos_map</span><span class="p">[:,:,</span><span class="n">shap_coeff</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">-</span><span class="n">i</span><span class="p">])</span><span class="o">-</span><span class="n">mean</span><span class="p">(</span><span class="n">pos_map</span><span class="p">[:,:,</span><span class="n">shap_coeff</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">-</span><span class="n">i</span><span class="p">])</span><span class="o">*</span><span class="n">ones</span><span class="p">(</span><span class="n">shap</span><span class="p">))</span><span class="o">/</span><span class="n">pos_map</span><span class="p">[:,:,</span><span class="n">shap_coeff</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">-</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>

    <span class="n">mat_out</span> <span class="o">=</span> <span class="n">transpose</span><span class="p">(</span><span class="n">cube_to_mat</span><span class="p">(</span><span class="n">stack_feat</span><span class="p">))</span>
    <span class="n">i</span> <span class="o">=</span> <span class="n">where</span><span class="p">(</span><span class="n">mat_out</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">)</span>

    <span class="c1">#mat_out = mat_out[i[0],:]</span>
    <span class="k">return</span> <span class="n">mat_out</span><span class="p">,</span><span class="n">filters</span><span class="p">,</span><span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>



<span class="k">def</span> <span class="nf">clusters_analysis</span><span class="p">(</span><span class="n">label_ind</span><span class="p">,</span><span class="n">im</span><span class="p">):</span>
    <span class="kn">from</span> <span class="nn">numpy</span> <span class="k">import</span> <span class="nb">int</span>
    <span class="n">nb_clusters</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">label_ind</span><span class="p">)</span>
    <span class="n">weights</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">nb_clusters</span><span class="p">,))</span>
    <span class="n">shap</span> <span class="o">=</span> <span class="n">im</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">pos_cluster</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">nb_clusters</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span>
    <span class="n">im_clusters</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">nb_clusters</span><span class="p">))</span>
    <span class="n">ind_coord</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_clusters</span><span class="p">):</span>
        <span class="n">nb_pts</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">label_ind</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        <span class="n">ind_coord_i</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">nb_pts</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_pts</span><span class="p">):</span>
            <span class="n">il</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">label_ind</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">k</span><span class="p">]</span><span class="o">/</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">ic</span> <span class="o">=</span> <span class="n">label_ind</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">k</span><span class="p">]</span><span class="o">%</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">weights</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">+=</span><span class="n">im</span><span class="p">[</span><span class="n">il</span><span class="p">,</span><span class="n">ic</span><span class="p">]</span>
            <span class="n">ind_coord_i</span><span class="p">[</span><span class="n">k</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">array</span><span class="p">([</span><span class="n">il</span><span class="p">,</span><span class="n">ic</span><span class="p">])</span>
            <span class="n">pos_cluster</span><span class="p">[</span><span class="n">i</span><span class="p">,:]</span> <span class="o">+=</span> <span class="n">array</span><span class="p">([</span><span class="n">il</span><span class="p">,</span><span class="n">ic</span><span class="p">])</span>
            <span class="n">im_clusters</span><span class="p">[</span><span class="n">il</span><span class="p">,</span><span class="n">ic</span><span class="p">,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">im</span><span class="p">[</span><span class="n">il</span><span class="p">,</span><span class="n">ic</span><span class="p">]</span>
        <span class="n">pos_cluster</span><span class="p">[</span><span class="n">i</span><span class="p">,:]</span> <span class="o">/=</span> <span class="n">nb_pts</span>
        <span class="n">ind_coord</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ind_coord_i</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">im_clusters</span><span class="p">,</span><span class="n">weights</span><span class="p">,</span><span class="n">pos_cluster</span><span class="p">,</span><span class="n">ind_coord</span>


<span class="k">def</span> <span class="nf">clusters_matching</span><span class="p">(</span><span class="n">label_ind1</span><span class="p">,</span><span class="n">label_ind2</span><span class="p">,</span><span class="n">P</span><span class="p">,</span><span class="n">tol</span><span class="o">=</span><span class="mf">0.001</span><span class="p">):</span>

    <span class="n">shap</span> <span class="o">=</span> <span class="n">P</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">err</span> <span class="o">=</span> <span class="n">tol</span><span class="o">*</span><span class="n">P</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    <span class="c1"># Setting threshold</span>
    <span class="n">P_cpy</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">P</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">],))</span>
    <span class="n">ind</span> <span class="o">=</span> <span class="n">argsort</span><span class="p">(</span><span class="n">P_cpy</span><span class="p">)</span>
    <span class="n">cm</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">while</span> <span class="n">cm</span><span class="o">&lt;</span><span class="n">err</span><span class="p">:</span>
        <span class="n">cm</span> <span class="o">+=</span> <span class="n">P_cpy</span><span class="p">[</span><span class="n">ind</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span>
        <span class="n">P_cpy</span><span class="p">[</span><span class="n">ind</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">i</span><span class="o">+=</span><span class="mi">1</span>

    <span class="n">P_thresh</span> <span class="o">=</span> <span class="n">P_cpy</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
    <span class="n">i</span><span class="p">,</span><span class="n">j</span> <span class="o">=</span> <span class="n">where</span><span class="p">(</span><span class="n">P_thresh</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">nb_prod</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>

    <span class="n">weights</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">nb_prod</span><span class="p">,))</span>
    <span class="n">cart_prods</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_prod</span><span class="p">):</span>
        <span class="n">l1</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">label_ind2</span><span class="p">[</span><span class="n">i</span><span class="p">[</span><span class="n">k</span><span class="p">]])</span>
        <span class="n">l2</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">label_ind1</span><span class="p">[</span><span class="n">j</span><span class="p">[</span><span class="n">k</span><span class="p">]])</span>
        <span class="n">ind</span> <span class="o">=</span> <span class="n">ones</span><span class="p">((</span><span class="n">l1</span><span class="o">*</span><span class="n">l2</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">l1</span><span class="p">):</span>
            <span class="n">ind</span><span class="p">[</span><span class="n">m</span><span class="o">*</span><span class="n">l2</span><span class="p">:(</span><span class="n">m</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">l2</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">*=</span> <span class="n">label_ind2</span><span class="p">[</span><span class="n">i</span><span class="p">[</span><span class="n">k</span><span class="p">]][</span><span class="n">m</span><span class="p">]</span>
            <span class="n">ind</span><span class="p">[</span><span class="n">m</span><span class="o">*</span><span class="n">l2</span><span class="p">:(</span><span class="n">m</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">l2</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">label_ind1</span><span class="p">[</span><span class="n">j</span><span class="p">[</span><span class="n">k</span><span class="p">]])</span>
        <span class="n">ind</span> <span class="o">=</span> <span class="n">ind</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
        <span class="n">cart_prods</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ind</span><span class="p">)</span>
        <span class="n">weights</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">P</span><span class="p">[</span><span class="n">i</span><span class="p">[</span><span class="n">k</span><span class="p">],</span><span class="n">j</span><span class="p">[</span><span class="n">k</span><span class="p">]]</span>

    <span class="k">return</span> <span class="n">cart_prods</span><span class="p">,</span><span class="n">weights</span>

<span class="k">def</span> <span class="nf">mds_clustering</span><span class="p">(</span><span class="n">sim_matrix</span><span class="p">,</span><span class="n">nb_clusters</span><span class="p">,</span><span class="n">tol</span><span class="o">=</span><span class="mf">0.99</span><span class="p">):</span> <span class="c1"># tol = percentage of the energy kept</span>
    <span class="n">U</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">Vt</span> <span class="o">=</span> <span class="n">linalg</span><span class="o">.</span><span class="n">svd</span><span class="p">(</span><span class="n">sim_matrix</span><span class="p">,</span><span class="n">full_matrices</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">t</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
    <span class="n">nb_comp</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">while</span> <span class="nb">sum</span><span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">nb_comp</span><span class="p">])</span><span class="o">&lt;</span><span class="n">tol</span><span class="o">*</span><span class="n">t</span><span class="p">:</span>
        <span class="n">nb_comp</span><span class="o">+=</span><span class="mi">1</span>
    <span class="nb">print</span> <span class="n">nb_comp</span>
    <span class="n">w</span> <span class="o">=</span> <span class="n">diag</span><span class="p">(</span><span class="n">sqrt</span><span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">nb_comp</span><span class="p">]))</span>

    <span class="n">embedding</span> <span class="o">=</span> <span class="n">transpose</span><span class="p">(</span><span class="n">w</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">Vt</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">nb_comp</span><span class="p">,:]))</span>
    <span class="n">ret</span><span class="p">,</span><span class="n">label_ind</span><span class="p">,</span><span class="n">label</span><span class="p">,</span><span class="n">center</span> <span class="o">=</span> <span class="n">kmeans_interface</span><span class="p">(</span><span class="n">embedding</span><span class="p">,</span><span class="n">nb_clusters</span><span class="p">,</span><span class="n">nb_iter</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span><span class="n">eps</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span><span class="n">nb_attempts</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">embedding</span><span class="p">,</span><span class="n">label_ind</span><span class="p">,</span><span class="n">center</span><span class="p">,</span><span class="n">ret</span>

<span class="k">def</span> <span class="nf">centering_mat</span><span class="p">(</span><span class="n">M</span><span class="p">):</span>
    <span class="n">Mout</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">M</span><span class="p">)</span>
    <span class="n">shap</span> <span class="o">=</span> <span class="n">M</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">ones_vect</span> <span class="o">=</span> <span class="n">ones</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="mi">1</span><span class="p">))</span>
    <span class="n">Mout</span> <span class="o">=</span> <span class="n">Mout</span> <span class="o">-</span> <span class="n">ones_vect</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">transpose</span><span class="p">(</span><span class="n">ones_vect</span><span class="p">)</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">M</span><span class="p">))</span><span class="o">/</span><span class="n">M</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">Mout</span>

<span class="k">def</span> <span class="nf">gram_convert</span><span class="p">(</span><span class="n">M</span><span class="p">):</span>
    <span class="n">M1</span> <span class="o">=</span> <span class="n">centering_mat</span><span class="p">(</span><span class="n">M</span><span class="p">)</span>
    <span class="n">Mout</span> <span class="o">=</span> <span class="o">-</span><span class="n">transpose</span><span class="p">(</span><span class="n">centering_mat</span><span class="p">(</span><span class="n">transpose</span><span class="p">(</span><span class="n">M1</span><span class="p">)))</span><span class="o">/</span><span class="mi">2</span>
    <span class="k">return</span> <span class="n">Mout</span>

<span class="k">def</span> <span class="nf">gal_kmeans</span><span class="p">(</span><span class="n">gal_cube</span><span class="p">,</span><span class="n">nb_cluster</span><span class="p">,</span><span class="n">hess_thresh</span><span class="o">=</span><span class="mi">250</span><span class="p">):</span>
    <span class="n">des</span><span class="p">,</span><span class="n">bad_im</span><span class="p">,</span><span class="n">good_im</span> <span class="o">=</span> <span class="n">surf_data_cube</span><span class="p">(</span><span class="n">gal_cube</span><span class="p">,</span><span class="n">hess_thresh</span><span class="p">)</span>
    <span class="n">ret</span><span class="p">,</span><span class="n">label_ind</span><span class="p">,</span><span class="n">label</span><span class="p">,</span><span class="n">center</span> <span class="o">=</span> <span class="n">kmeans_interface</span><span class="p">(</span><span class="n">des</span><span class="p">,</span><span class="n">good_im</span><span class="p">,</span><span class="n">nb_cluster</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">size</span><span class="p">(</span><span class="n">bad_im</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
        <span class="n">label_ind</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">bad_im</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">ret</span><span class="p">,</span><span class="n">label_ind</span><span class="p">,</span><span class="n">center</span>

<span class="k">def</span> <span class="nf">knn_bar</span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="n">weights</span><span class="p">):</span> <span class="c1"># data is a 3D cube; the third dimension corresponds to the observables; each slice is a point cloud and the first dimension corresponds to the points coordinates</span>
    <span class="kn">from</span> <span class="nn">pyflann</span> <span class="k">import</span> <span class="n">FLANN</span>
    <span class="kn">from</span> <span class="nn">numpy</span> <span class="k">import</span> <span class="n">argsort</span><span class="p">,</span><span class="n">ones</span><span class="p">,</span><span class="n">array</span><span class="p">,</span><span class="n">zeros</span><span class="p">,</span><span class="n">where</span><span class="p">,</span><span class="n">diag</span><span class="p">,</span><span class="n">size</span><span class="p">,</span><span class="n">float64</span>
    <span class="n">shap</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">ind</span> <span class="o">=</span> <span class="n">argsort</span><span class="p">(</span><span class="n">weights</span><span class="p">)</span>
    <span class="n">flann</span> <span class="o">=</span> <span class="n">FLANN</span><span class="p">()</span>
    <span class="n">weights_cp</span> <span class="o">=</span> <span class="n">ones</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">weights</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">])))</span>
    <span class="n">data_cp</span> <span class="o">=</span> <span class="n">array</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">float64</span><span class="p">)</span>
    <span class="n">params</span> <span class="o">=</span> <span class="n">flann</span><span class="o">.</span><span class="n">build_index</span><span class="p">(</span><span class="n">data</span><span class="p">[:,:,</span><span class="n">ind</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]])</span>
    <span class="n">bar_out</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
        <span class="n">result_temp</span><span class="p">,</span> <span class="n">dists_temp</span> <span class="o">=</span> <span class="n">flann</span><span class="o">.</span><span class="n">nn_index</span><span class="p">(</span><span class="n">data</span><span class="p">[:,:,</span><span class="n">ind</span><span class="p">[</span><span class="n">i</span><span class="p">]],</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
            <span class="n">nn</span> <span class="o">=</span> <span class="n">where</span><span class="p">(</span><span class="n">result_temp</span><span class="o">==</span><span class="n">j</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">size</span><span class="p">(</span><span class="n">nn</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
                <span class="n">bar_out</span><span class="p">[</span><span class="n">j</span><span class="p">,:]</span><span class="o">+=</span> <span class="n">data</span><span class="p">[</span><span class="n">nn</span><span class="p">[</span><span class="mi">0</span><span class="p">],:,</span><span class="n">ind</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">*</span><span class="n">weights</span><span class="p">[</span><span class="n">ind</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span><span class="o">/</span><span class="n">size</span><span class="p">(</span><span class="n">nn</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="n">weights_cp</span><span class="p">[</span><span class="n">j</span><span class="p">,</span><span class="n">ind</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="n">bar_out</span><span class="o">+=</span><span class="n">diag</span><span class="p">(</span><span class="n">weights_cp</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">data</span><span class="p">[:,:,</span><span class="n">ind</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]])</span>

    <span class="k">return</span> <span class="n">bar_out</span>

<span class="k">def</span> <span class="nf">lin_bar</span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="n">weights</span><span class="p">):</span>
    <span class="n">shap</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">bar_out</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
        <span class="n">bar_out</span><span class="o">+=</span><span class="n">weights</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">*</span><span class="n">data</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">bar_out</span>


<div class="viewcode-block" id="knn_interf"><a class="viewcode-back" href="../utils.html#utils.knn_interf">[docs]</a><span class="k">def</span> <span class="nf">knn_interf</span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="n">nb_neigh</span><span class="p">,</span><span class="n">return_index</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Computes closest neighbors. </span>
<span class="sd">    </span>
<span class="sd">    #TODO: Probably some costly redundancy with :func:`full_displacement` here. Also is it me or is ``params`` not used?</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">numpy</span> <span class="k">import</span> <span class="n">array</span><span class="p">,</span><span class="n">float64</span>
    <span class="n">flann</span> <span class="o">=</span> <span class="n">FLANN</span><span class="p">()</span>
    <span class="n">data_cp</span> <span class="o">=</span> <span class="n">array</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">float64</span><span class="p">)</span>
    <span class="n">params</span> <span class="o">=</span> <span class="n">flann</span><span class="o">.</span><span class="n">build_index</span><span class="p">(</span><span class="n">data_cp</span><span class="p">)</span>
    <span class="n">result_temp</span><span class="p">,</span> <span class="n">dists_temp</span> <span class="o">=</span> <span class="n">flann</span><span class="o">.</span><span class="n">nn_index</span><span class="p">(</span><span class="n">data_cp</span><span class="p">,</span> <span class="n">nb_neigh</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">dists</span> <span class="o">=</span> <span class="n">dists_temp</span><span class="p">[:,</span><span class="mi">1</span><span class="p">:</span><span class="n">nb_neigh</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">result_temp</span><span class="p">[:,</span><span class="mi">1</span><span class="p">:</span><span class="n">nb_neigh</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">return_index</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">result</span><span class="p">,</span><span class="n">dists</span><span class="p">,</span><span class="n">flann</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">result</span><span class="p">,</span><span class="n">dists</span></div>

<span class="k">def</span> <span class="nf">knn_splitting</span><span class="p">(</span><span class="n">data_pos</span><span class="p">,</span><span class="n">weights</span><span class="p">):</span>
    <span class="n">nb_data</span> <span class="o">=</span> <span class="n">data_pos</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">results</span><span class="p">,</span><span class="n">dists</span> <span class="o">=</span> <span class="n">knn_interf</span><span class="p">(</span><span class="n">data_pos</span><span class="p">,</span><span class="n">nb_data</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">i</span><span class="p">,</span><span class="n">j</span> <span class="o">=</span> <span class="n">where</span><span class="p">(</span><span class="n">dists</span><span class="o">==</span><span class="n">dists</span><span class="o">.</span><span class="n">max</span><span class="p">())</span>
    <span class="n">weights_max</span> <span class="o">=</span> <span class="n">weights</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">/</span><span class="mi">2</span>
    <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">ind</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">while</span> <span class="n">count</span> <span class="o">&lt;</span><span class="n">weights_max</span><span class="p">:</span>
        <span class="n">count</span><span class="o">+=</span><span class="n">weights</span><span class="p">[</span><span class="n">results</span><span class="p">[</span><span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">ind</span><span class="p">]]</span>
        <span class="n">ind</span><span class="o">+=</span><span class="mi">1</span>

    <span class="n">ind1</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">ind</span><span class="p">,))</span>
    <span class="n">ind1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">ind1</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">=</span> <span class="n">results</span><span class="p">[</span><span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="mi">0</span><span class="p">:</span><span class="n">ind</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">ind2</span> <span class="o">=</span> <span class="n">results</span><span class="p">[</span><span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">ind</span><span class="o">-</span><span class="mi">1</span><span class="p">:]</span>
    <span class="n">ind1</span> <span class="o">=</span> <span class="n">ind1</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
    <span class="n">ind2</span> <span class="o">=</span> <span class="n">ind2</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">ind1</span><span class="p">,</span><span class="n">ind2</span>

<span class="k">def</span> <span class="nf">knn_splitting_eq</span><span class="p">(</span><span class="n">data_pos</span><span class="p">,</span><span class="n">weights</span><span class="p">):</span>
    <span class="n">nb_data</span> <span class="o">=</span> <span class="n">data_pos</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">results</span><span class="p">,</span><span class="n">dists</span> <span class="o">=</span> <span class="n">knn_interf</span><span class="p">(</span><span class="n">data_pos</span><span class="p">,</span><span class="n">nb_data</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">i</span><span class="p">,</span><span class="n">j</span> <span class="o">=</span> <span class="n">where</span><span class="p">(</span><span class="n">dists</span><span class="o">==</span><span class="n">dists</span><span class="o">.</span><span class="n">max</span><span class="p">())</span>
    <span class="n">weights_max</span> <span class="o">=</span> <span class="n">weights</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">/</span><span class="mi">2</span>
    <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">ind</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">while</span> <span class="n">count</span> <span class="o">&lt;</span><span class="n">weights_max</span><span class="p">:</span>
        <span class="n">count</span><span class="o">+=</span><span class="n">weights</span><span class="p">[</span><span class="n">results</span><span class="p">[</span><span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">ind</span><span class="p">]]</span>
        <span class="n">ind</span><span class="o">+=</span><span class="mi">1</span>

    <span class="n">ind1</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">ind</span><span class="p">,))</span>
    <span class="n">ind1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">ind1</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">=</span> <span class="n">results</span><span class="p">[</span><span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="mi">0</span><span class="p">:</span><span class="n">ind</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">ind2</span> <span class="o">=</span> <span class="n">results</span><span class="p">[</span><span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">ind</span><span class="o">-</span><span class="mi">1</span><span class="p">:]</span>
    <span class="n">ind1</span> <span class="o">=</span> <span class="n">ind1</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
    <span class="n">ind2</span> <span class="o">=</span> <span class="n">ind2</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">ind1</span><span class="p">,</span><span class="n">ind2</span>

<span class="k">def</span> <span class="nf">knn_splitting_preproc</span><span class="p">(</span><span class="n">im</span><span class="p">):</span>
    <span class="n">i</span><span class="p">,</span><span class="n">j</span> <span class="o">=</span> <span class="n">where</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">im</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">ind_lin</span> <span class="o">=</span> <span class="n">where</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">im</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">size</span><span class="p">(</span><span class="n">im</span><span class="p">),))</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">nb_data</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
    <span class="n">weights</span> <span class="o">=</span> <span class="n">im</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span>
    <span class="n">pos</span> <span class="o">=</span> <span class="n">ones</span><span class="p">((</span><span class="n">nb_data</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span>
    <span class="n">pos</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span>
    <span class="n">pos</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">j</span>
    <span class="k">return</span> <span class="n">pos</span><span class="p">,</span><span class="n">weights</span><span class="p">,</span><span class="n">ind_lin</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>


<span class="k">def</span> <span class="nf">knn_pos</span><span class="p">(</span><span class="n">ref_pos</span><span class="p">,</span><span class="n">data_pos</span><span class="p">,</span><span class="n">k</span><span class="p">):</span>
    <span class="n">nb_data</span> <span class="o">=</span> <span class="n">data_pos</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">ones_vect</span> <span class="o">=</span> <span class="n">ones</span><span class="p">((</span><span class="n">nb_data</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>
    <span class="n">sq_dist</span> <span class="o">=</span> <span class="p">((</span><span class="n">data_pos</span> <span class="o">-</span> <span class="n">ones_vect</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">transpose</span><span class="p">(</span><span class="n">vect</span><span class="p">(</span><span class="n">ref_pos</span><span class="p">))))</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">ind</span> <span class="o">=</span> <span class="n">argsort</span><span class="p">(</span><span class="n">sq_dist</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">ind</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">k</span><span class="p">]</span>

<span class="k">def</span> <span class="nf">mutli_scale_splitting</span><span class="p">(</span><span class="n">data_pos</span><span class="p">,</span><span class="n">weights</span><span class="p">,</span><span class="n">nb_split</span><span class="p">,</span><span class="n">ind_lin</span><span class="p">):</span>
    <span class="n">nb_data</span> <span class="o">=</span> <span class="n">data_pos</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">ind_init</span> <span class="o">=</span> <span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_data</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
    <span class="n">tree_loc</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
    <span class="n">tree_loc</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">copy</span><span class="p">(</span><span class="n">ind_init</span><span class="p">))</span>
    <span class="n">tree</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_split</span><span class="p">):</span>
        <span class="n">nb_cells</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">tree_loc</span><span class="p">)</span>
        <span class="n">tree_cp</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">tree_loc</span><span class="p">)</span>
        <span class="n">tree</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="n">tree_loc</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_cells</span><span class="p">):</span>
            <span class="n">ind1</span><span class="p">,</span><span class="n">ind2</span> <span class="o">=</span> <span class="n">knn_splitting</span><span class="p">(</span><span class="n">data_pos</span><span class="p">[</span><span class="n">tree_cp</span><span class="p">[</span><span class="n">k</span><span class="p">],:],</span><span class="n">weights</span><span class="p">[</span><span class="n">tree_cp</span><span class="p">[</span><span class="n">k</span><span class="p">]])</span>
            <span class="n">tree</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ind_lin</span><span class="p">[</span><span class="n">tree_cp</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="n">ind1</span><span class="p">]])</span>
            <span class="n">tree</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ind_lin</span><span class="p">[</span><span class="n">tree_cp</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="n">ind2</span><span class="p">]])</span>
            <span class="n">tree_loc</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tree_cp</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="n">ind1</span><span class="p">])</span>
            <span class="n">tree_loc</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tree_cp</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="n">ind2</span><span class="p">])</span>


    <span class="k">return</span> <span class="n">tree</span>


<span class="k">def</span> <span class="nf">vector_field_corr</span><span class="p">(</span><span class="n">mat</span><span class="p">,</span><span class="n">pos_field</span><span class="p">,</span><span class="n">nb_bin</span><span class="o">=</span><span class="mi">20</span><span class="p">):</span>
    <span class="n">shap</span> <span class="o">=</span> <span class="n">mat</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">nb_neigh</span> <span class="o">=</span> <span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span>
    <span class="n">result</span><span class="p">,</span><span class="n">dists</span> <span class="o">=</span> <span class="n">knn_interf</span><span class="p">(</span><span class="n">pos_field</span><span class="p">,</span><span class="n">nb_neigh</span><span class="p">)</span>
    <span class="n">step</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">dists</span><span class="p">[:,</span><span class="n">nb_neigh</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span><span class="o">/</span><span class="n">nb_bin</span>
    <span class="n">correl</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">nb_bin</span><span class="o">+</span><span class="mi">1</span><span class="p">,))</span>
    <span class="n">correl</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_bin</span><span class="p">):</span>
        <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
            <span class="n">ind</span> <span class="o">=</span> <span class="n">where</span><span class="p">(</span><span class="n">dists</span><span class="p">[</span><span class="n">j</span><span class="p">,:]</span><span class="o">&gt;</span><span class="n">i</span><span class="o">*</span><span class="n">step</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">size</span><span class="p">(</span><span class="n">ind</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
                <span class="n">ind</span> <span class="o">=</span> <span class="n">ind</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">dist</span> <span class="o">=</span> <span class="n">dists</span><span class="p">[</span><span class="n">j</span><span class="p">,</span><span class="n">ind</span><span class="p">]</span>

                <span class="k">while</span> <span class="n">dist</span><span class="o">&lt;</span><span class="n">step</span><span class="o">*</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="ow">and</span> <span class="n">dist</span> <span class="o">&gt;</span> <span class="n">i</span><span class="o">*</span><span class="n">step</span> <span class="ow">and</span> <span class="n">ind</span><span class="o">&lt;</span><span class="n">nb_neigh</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                    <span class="n">count</span><span class="o">+=</span><span class="mi">1</span>
                    <span class="c1">#print i</span>
                    <span class="n">correl</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">+=</span><span class="p">(</span><span class="n">mat</span><span class="p">[</span><span class="n">j</span><span class="p">,:]</span><span class="o">*</span><span class="n">mat</span><span class="p">[</span><span class="n">result</span><span class="p">[</span><span class="n">j</span><span class="p">,</span><span class="n">ind</span><span class="p">],:])</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">/</span><span class="p">(</span><span class="n">sqrt</span><span class="p">((</span><span class="n">mat</span><span class="p">[</span><span class="n">j</span><span class="p">,:]</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span><span class="o">*</span><span class="n">sqrt</span><span class="p">((</span><span class="n">mat</span><span class="p">[</span><span class="n">result</span><span class="p">[</span><span class="n">j</span><span class="p">,</span><span class="n">ind</span><span class="p">],:]</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()))</span>
                    <span class="n">ind</span><span class="o">+=</span><span class="mi">1</span>
                    <span class="n">dist</span> <span class="o">=</span> <span class="n">dists</span><span class="p">[</span><span class="n">j</span><span class="p">,</span><span class="n">ind</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">count</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>

            <span class="n">correl</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">/=</span><span class="n">count</span>

    <span class="k">return</span> <span class="n">correl</span>

<span class="k">def</span> <span class="nf">diffusion_graph</span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="n">nb_neigh</span><span class="p">,</span><span class="n">min_val</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">max_val</span><span class="o">=</span><span class="mi">100000</span><span class="p">):</span> <span class="c1"># Samples are stored in the lines</span>

    <span class="n">flann</span> <span class="o">=</span> <span class="n">FLANN</span><span class="p">()</span>
    <span class="n">data_cp</span> <span class="o">=</span> <span class="n">array</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">float64</span><span class="p">)</span>
    <span class="n">result_temp</span><span class="p">,</span> <span class="n">dists_temp</span> <span class="o">=</span> <span class="n">flann</span><span class="o">.</span><span class="n">nn</span><span class="p">(</span><span class="n">data_cp</span><span class="p">,</span> <span class="n">data_cp</span><span class="p">,</span> <span class="n">nb_neigh</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">dists</span> <span class="o">=</span> <span class="n">dists_temp</span><span class="p">[:,</span><span class="mi">1</span><span class="p">:</span><span class="n">nb_neigh</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">result_temp</span><span class="p">[:,</span><span class="mi">1</span><span class="p">:</span><span class="n">nb_neigh</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>

    <span class="n">dists_weighted</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">dists</span><span class="p">)</span>
    <span class="n">k</span><span class="p">,</span><span class="n">l</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span>
    <span class="n">shap</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
        <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_neigh</span><span class="p">):</span>
            <span class="n">dists_weighted</span><span class="p">[</span><span class="n">k</span><span class="p">,</span><span class="n">l</span><span class="p">]</span> <span class="o">=</span> <span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="p">(</span><span class="n">dists</span><span class="p">[</span><span class="n">k</span><span class="p">,</span><span class="n">l</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">dists</span><span class="p">[</span><span class="n">k</span><span class="p">,</span><span class="nb">round</span><span class="p">(</span><span class="n">nb_neigh</span><span class="o">/</span><span class="mi">2</span><span class="p">)]</span><span class="o">*</span><span class="n">dists</span><span class="p">[</span><span class="n">result</span><span class="p">[</span><span class="n">k</span><span class="p">,</span><span class="n">l</span><span class="p">],</span><span class="nb">round</span><span class="p">(</span><span class="n">nb_neigh</span><span class="o">/</span><span class="mi">2</span><span class="p">)]))</span>
    <span class="n">shap</span> <span class="o">=</span> <span class="n">dists</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">ones_mat</span> <span class="o">=</span> <span class="n">ones</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
    <span class="n">dists_weighted</span> <span class="o">=</span> <span class="p">((</span><span class="n">max_val</span><span class="o">-</span><span class="n">min_val</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">dists_weighted</span><span class="o">-</span><span class="n">dists_weighted</span><span class="o">.</span><span class="n">min</span><span class="p">()</span><span class="o">*</span><span class="n">ones_mat</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">dists_weighted</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">-</span><span class="n">dists_weighted</span><span class="o">.</span><span class="n">min</span><span class="p">())</span> <span class="o">+</span> <span class="n">min_val</span><span class="o">*</span><span class="n">ones_mat</span><span class="p">)</span>
    <span class="n">dists_weighted</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
    <span class="nb">print</span> <span class="s1">&#39;------------ &#39;</span><span class="p">,</span><span class="n">dists_weighted</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span><span class="s1">&#39; --------------&#39;</span>
    <span class="nb">print</span> <span class="s1">&#39;------------ &#39;</span><span class="p">,</span><span class="n">dists</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span><span class="s1">&#39; --------------&#39;</span>
    <span class="n">result_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
    <span class="n">dist_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
    <span class="n">dist_weighted_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
        <span class="n">result_list</span><span class="o">.</span><span class="n">append</span><span class="p">([])</span>
        <span class="n">dist_list</span><span class="o">.</span><span class="n">append</span><span class="p">([])</span>
        <span class="n">dist_weighted_list</span><span class="o">.</span><span class="n">append</span><span class="p">([])</span>

    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
        <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_neigh</span><span class="p">):</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="n">k</span><span class="p">,</span><span class="n">l</span><span class="p">]</span> <span class="ow">in</span> <span class="n">result_list</span><span class="p">[</span><span class="n">k</span><span class="p">])</span><span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
                <span class="n">result_list</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="n">k</span><span class="p">,</span><span class="n">l</span><span class="p">])</span>
                <span class="n">dist_list</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dists</span><span class="p">[</span><span class="n">k</span><span class="p">,</span><span class="n">l</span><span class="p">])</span>
                <span class="n">dist_weighted_list</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dists_weighted</span><span class="p">[</span><span class="n">k</span><span class="p">,</span><span class="n">l</span><span class="p">])</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">k</span> <span class="ow">in</span> <span class="n">result_list</span><span class="p">[</span><span class="n">result</span><span class="p">[</span><span class="n">k</span><span class="p">,</span><span class="n">l</span><span class="p">]])</span><span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
                <span class="n">result_list</span><span class="p">[</span><span class="n">result</span><span class="p">[</span><span class="n">k</span><span class="p">,</span><span class="n">l</span><span class="p">]]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
                <span class="n">dist_list</span><span class="p">[</span><span class="n">result</span><span class="p">[</span><span class="n">k</span><span class="p">,</span><span class="n">l</span><span class="p">]]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dists</span><span class="p">[</span><span class="n">k</span><span class="p">,</span><span class="n">l</span><span class="p">])</span>
                <span class="n">dist_weighted_list</span><span class="p">[</span><span class="n">result</span><span class="p">[</span><span class="n">k</span><span class="p">,</span><span class="n">l</span><span class="p">]]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dists_weighted</span><span class="p">[</span><span class="n">k</span><span class="p">,</span><span class="n">l</span><span class="p">])</span>


    <span class="k">return</span> <span class="n">result_list</span><span class="p">,</span><span class="n">dist_list</span><span class="p">,</span><span class="n">dist_weighted_list</span>

<span class="k">def</span> <span class="nf">manifold_partionning_graph</span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="n">nb_neigh_frac</span><span class="p">,</span><span class="n">max_val</span><span class="o">=</span><span class="mi">100000</span><span class="p">):</span>
    <span class="n">nb_points</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">geod_dist_mat</span><span class="p">,</span><span class="n">next_mat</span><span class="p">,</span><span class="n">nb_neigh</span><span class="p">,</span><span class="n">min_mat</span><span class="p">,</span><span class="n">dist_mat</span> <span class="o">=</span> <span class="n">geodesic_distances</span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="n">nb_neigh</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span><span class="n">prim_en</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">i</span><span class="p">,</span><span class="n">j</span> <span class="o">=</span> <span class="n">where</span><span class="p">(</span><span class="n">geod_dist_mat</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">min_dist</span> <span class="o">=</span> <span class="n">geod_dist_mat</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
    <span class="n">max_dist</span> <span class="o">=</span> <span class="n">geod_dist_mat</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
    <span class="n">ones_mat</span> <span class="o">=</span> <span class="n">ones</span><span class="p">((</span><span class="n">nb_points</span><span class="p">,</span><span class="n">nb_points</span><span class="p">))</span>
    <span class="n">geod_dist_mat_int</span> <span class="o">=</span> <span class="n">max_val</span><span class="o">*</span><span class="n">geod_dist_mat</span><span class="o">/</span><span class="n">max_dist</span>
    <span class="n">geod_dist_mat_int</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
    <span class="n">result_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
    <span class="n">dist_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_points</span><span class="p">):</span>
        <span class="n">result_list</span><span class="o">.</span><span class="n">append</span><span class="p">([])</span>
        <span class="n">dist_list</span><span class="o">.</span><span class="n">append</span><span class="p">([])</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_points</span><span class="p">):</span>
        <span class="n">ind</span> <span class="o">=</span> <span class="n">argsort</span><span class="p">(</span><span class="n">geod_dist_mat_int</span><span class="p">[</span><span class="n">k</span><span class="p">,:])</span>
        <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">int</span><span class="p">(</span><span class="n">nb_neigh_frac</span><span class="o">*</span><span class="n">nb_points</span><span class="p">)):</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">ind</span><span class="p">[</span><span class="n">l</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="ow">in</span> <span class="n">result_list</span><span class="p">[</span><span class="n">k</span><span class="p">])</span><span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
                <span class="n">result_list</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ind</span><span class="p">[</span><span class="n">l</span><span class="o">+</span><span class="mi">1</span><span class="p">])</span>
                <span class="n">dist_list</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">geod_dist_mat_int</span><span class="p">[</span><span class="n">k</span><span class="p">,</span><span class="n">ind</span><span class="p">[</span><span class="n">l</span><span class="o">+</span><span class="mi">1</span><span class="p">]])</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">k</span> <span class="ow">in</span> <span class="n">result_list</span><span class="p">[</span><span class="n">ind</span><span class="p">[</span><span class="n">l</span><span class="o">+</span><span class="mi">1</span><span class="p">]])</span><span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
                <span class="n">result_list</span><span class="p">[</span><span class="n">ind</span><span class="p">[</span><span class="n">l</span><span class="o">+</span><span class="mi">1</span><span class="p">]]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
                <span class="n">dist_list</span><span class="p">[</span><span class="n">ind</span><span class="p">[</span><span class="n">l</span><span class="o">+</span><span class="mi">1</span><span class="p">]]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">geod_dist_mat_int</span><span class="p">[</span><span class="n">k</span><span class="p">,</span><span class="n">ind</span><span class="p">[</span><span class="n">l</span><span class="o">+</span><span class="mi">1</span><span class="p">]])</span>
    <span class="k">return</span> <span class="n">result_list</span><span class="p">,</span><span class="n">dist_list</span><span class="p">,</span><span class="n">geod_dist_mat</span><span class="p">,</span><span class="n">next_mat</span><span class="p">,</span><span class="n">dist_mat</span>

<span class="k">def</span> <span class="nf">manifold_partionning</span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="n">nb_parts</span><span class="p">,</span><span class="n">nb_neigh_frac</span><span class="o">=</span><span class="mf">1.0</span><span class="o">/</span><span class="mi">3</span><span class="p">):</span>
    <span class="n">edges</span><span class="p">,</span><span class="n">dists</span><span class="p">,</span><span class="n">geod_dist_mat</span><span class="p">,</span><span class="n">next_mat</span><span class="p">,</span><span class="n">dist_mat</span> <span class="o">=</span> <span class="n">manifold_partionning_graph</span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="n">nb_neigh_frac</span><span class="p">)</span>
    <span class="n">part_ind</span> <span class="o">=</span> <span class="n">metis_wrp</span><span class="p">(</span><span class="n">edges</span><span class="p">,</span><span class="n">dists</span><span class="p">,</span><span class="n">nb_parts</span><span class="p">,</span><span class="n">opt</span><span class="o">=</span><span class="s2">&quot;-ptype=rb&quot;</span><span class="p">,</span><span class="n">del_file</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">part_ind</span><span class="p">,</span><span class="n">geod_dist_mat</span><span class="p">,</span><span class="n">next_mat</span><span class="p">,</span><span class="n">dist_mat</span>

<span class="k">def</span> <span class="nf">compute_nb_edges</span><span class="p">(</span><span class="n">edges</span><span class="p">):</span> <span class="c1"># All vertices have the same number of edges; the edges indices start at 0.</span>
    <span class="n">shap0</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">edges</span><span class="p">)</span>

    <span class="n">k</span><span class="p">,</span><span class="n">l</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span>
    <span class="n">nb_edges</span><span class="o">=</span><span class="mi">0</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap0</span><span class="p">):</span>
        <span class="n">shap1</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">edges</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>
        <span class="k">for</span>  <span class="n">l</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap1</span><span class="p">):</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">edges</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="n">l</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">k</span><span class="p">):</span>
                <span class="n">nb_edges</span><span class="o">+=</span><span class="mi">1</span>
            <span class="k">if</span>  <span class="p">(</span><span class="n">edges</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="n">l</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">k</span><span class="p">):</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">k</span> <span class="ow">in</span> <span class="n">edges</span><span class="p">[</span><span class="n">edges</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="n">l</span><span class="p">]])</span><span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
                    <span class="nb">print</span> <span class="s2">&quot;Warning: unproprer vertex&quot;</span>
    <span class="k">return</span> <span class="n">nb_edges</span>

<span class="k">def</span> <span class="nf">write_graph</span><span class="p">(</span><span class="n">edges</span><span class="p">,</span><span class="n">weights</span><span class="p">,</span><span class="n">graph_filename</span><span class="p">):</span> <span class="c1"># The weights should be integer</span>
    <span class="n">shap0</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">edges</span><span class="p">)</span>
    <span class="n">nb_edges</span> <span class="o">=</span> <span class="n">compute_nb_edges</span><span class="p">(</span><span class="n">edges</span><span class="p">)</span>
    <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">graph_filename</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span>
    <span class="c1"># Header writing</span>
    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">shap0</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39; &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">nb_edges</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39; &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">k</span><span class="p">,</span><span class="n">l</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span><span class="mi">0</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap0</span><span class="p">):</span>
        <span class="n">shap1</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">edges</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap1</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">edges</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="n">l</span><span class="p">])</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39; &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">weights</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="n">l</span><span class="p">]))</span><span class="o">+</span><span class="s1">&#39; &#39;</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">edges</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="n">shap1</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span><span class="o">+</span><span class="s1">&#39; &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">weights</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="n">shap1</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span><span class="o">+</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">f</span><span class="o">.</span><span class="n">close</span>
    <span class="k">return</span> <span class="kc">None</span>

<span class="k">def</span> <span class="nf">read_graph_part</span><span class="p">(</span><span class="n">part_filename</span><span class="p">,</span><span class="n">nb_edges</span><span class="p">):</span>
    <span class="n">labels</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">nb_edges</span><span class="p">,))</span>
    <span class="n">k</span><span class="o">=</span><span class="mi">0</span>
    <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">part_filename</span><span class="p">,</span><span class="s1">&#39;r&#39;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_edges</span><span class="p">):</span>
        <span class="n">labels</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">readline</span><span class="p">())</span>
    <span class="k">return</span> <span class="n">labels</span>

<span class="k">def</span> <span class="nf">randfilename</span><span class="p">(</span><span class="n">ext</span><span class="o">=</span><span class="s1">&#39;.txt&#39;</span><span class="p">):</span>
    <span class="n">filename</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1000000</span><span class="p">))</span><span class="o">+</span><span class="n">ext</span>
    <span class="k">return</span> <span class="n">filename</span>

<span class="k">def</span> <span class="nf">metis_wrp</span><span class="p">(</span><span class="n">edges</span><span class="p">,</span><span class="n">weights</span><span class="p">,</span><span class="n">nb_parts</span><span class="p">,</span><span class="n">opt</span><span class="o">=</span><span class="s2">&quot;-ptype=rb&quot;</span><span class="p">,</span><span class="n">del_file</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="n">filename</span> <span class="o">=</span> <span class="n">randfilename</span><span class="p">()</span>
    <span class="n">write_graph</span><span class="p">(</span><span class="n">edges</span><span class="p">,</span><span class="n">weights</span><span class="p">,</span><span class="n">filename</span><span class="p">)</span>
    <span class="n">subprocess</span><span class="o">.</span><span class="n">call</span><span class="p">([</span><span class="s2">&quot;gpmetis&quot;</span><span class="p">,</span><span class="n">opt</span><span class="p">,</span><span class="n">filename</span><span class="p">,</span><span class="nb">str</span><span class="p">(</span><span class="n">nb_parts</span><span class="p">)])</span>
    <span class="n">part_filename</span> <span class="o">=</span> <span class="n">filename</span><span class="o">+</span><span class="s2">&quot;.part.&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">nb_parts</span><span class="p">)</span>
    <span class="n">shap0</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">edges</span><span class="p">)</span>
    <span class="n">labels</span> <span class="o">=</span> <span class="n">read_graph_part</span><span class="p">(</span><span class="n">part_filename</span><span class="p">,</span><span class="n">shap0</span><span class="p">)</span>
    <span class="n">part_ind</span> <span class="o">=</span> <span class="nb">list</span><span class="p">([])</span>
    <span class="n">l</span><span class="o">=</span><span class="mi">0</span>
    <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_parts</span><span class="p">):</span>
        <span class="n">ind</span>  <span class="o">=</span> <span class="n">where</span><span class="p">(</span><span class="n">labels</span><span class="o">==</span><span class="n">l</span><span class="p">)</span>
        <span class="n">part_ind</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ind</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

    <span class="k">if</span> <span class="n">del_file</span><span class="o">==</span><span class="kc">True</span><span class="p">:</span>
        <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">part_filename</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">part_ind</span>

<span class="k">def</span> <span class="nf">diffusion_partionning</span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="n">nb_parts</span><span class="p">,</span><span class="n">nb_neigh</span><span class="o">=</span><span class="mi">15</span><span class="p">):</span>
    <span class="n">edges</span><span class="p">,</span><span class="n">dists</span><span class="p">,</span><span class="n">dists_weighted</span> <span class="o">=</span> <span class="n">diffusion_graph</span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="n">nb_neigh</span><span class="p">)</span>
    <span class="n">part_ind</span> <span class="o">=</span> <span class="n">metis_wrp</span><span class="p">(</span><span class="n">edges</span><span class="p">,</span><span class="n">dists_weighted</span><span class="p">,</span><span class="n">nb_parts</span><span class="p">,</span><span class="n">opt</span><span class="o">=</span><span class="s2">&quot;-ptype=rb&quot;</span><span class="p">,</span><span class="n">del_file</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">part_ind</span>

<span class="k">def</span> <span class="nf">tree_split_2</span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="n">tree</span><span class="p">,</span><span class="n">sparsity_level</span><span class="p">,</span><span class="n">list_split</span><span class="p">,</span><span class="n">nb_neigh</span><span class="o">=</span><span class="mi">15</span><span class="p">):</span>
    <span class="kn">from</span> <span class="nn">numpy</span> <span class="k">import</span> <span class="o">*</span>
    <span class="n">new_tree</span>  <span class="o">=</span><span class="nb">list</span><span class="p">([])</span>
    <span class="n">new_list_split</span> <span class="o">=</span> <span class="nb">list</span><span class="p">([])</span>
    <span class="n">tree_size</span> <span class="o">=</span> <span class="n">shape</span><span class="p">(</span><span class="n">tree</span><span class="p">)</span>
    <span class="n">i</span><span class="o">=</span><span class="mi">0</span>
    <span class="n">shape_dat</span> <span class="o">=</span> <span class="n">shape</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">tree_size</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
        <span class="n">l</span> <span class="o">=</span> <span class="n">size</span><span class="p">(</span><span class="n">tree</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>

        <span class="k">if</span> <span class="n">list_split</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">==</span><span class="mi">1</span> <span class="ow">and</span> <span class="n">l</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="o">*</span><span class="n">sparsity_level</span><span class="o">+</span><span class="mi">2</span> <span class="p">:</span>
            <span class="n">data_i</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">tree</span><span class="p">[</span><span class="n">i</span><span class="p">],:]</span>
            <span class="n">nb_neigh_in</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">nb_neigh</span><span class="p">,</span><span class="nb">int</span><span class="p">(</span><span class="n">l</span><span class="o">/</span><span class="mi">2</span><span class="p">))</span>
            <span class="n">part_ind</span> <span class="o">=</span> <span class="n">diffusion_partionning</span><span class="p">(</span><span class="n">data_i</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="n">nb_neigh</span><span class="o">=</span><span class="n">nb_neigh_in</span><span class="p">)</span>
            <span class="n">tree_ind_1</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
            <span class="n">tree_ind_2</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
            <span class="n">l1</span> <span class="o">=</span> <span class="n">size</span><span class="p">(</span><span class="n">part_ind</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">l2</span> <span class="o">=</span> <span class="n">size</span><span class="p">(</span><span class="n">part_ind</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">l1</span><span class="o">&lt;=</span><span class="n">sparsity_level</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">l2</span><span class="o">&lt;=</span><span class="n">sparsity_level</span><span class="p">):</span>
                <span class="n">new_tree</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tree</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                <span class="n">new_list_split</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="n">i</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">i1</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">l1</span><span class="p">):</span>
                    <span class="n">tree_ind_1</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tree</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">part_ind</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">i1</span><span class="p">]])</span>
                <span class="k">for</span> <span class="n">i2</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">l2</span><span class="p">):</span>
                    <span class="n">tree_ind_2</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tree</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">part_ind</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">i2</span><span class="p">]])</span>

                <span class="n">new_tree</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tree_ind_1</span><span class="p">)</span>
                <span class="n">new_tree</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tree_ind_2</span><span class="p">)</span>
                <span class="n">new_list_split</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
                <span class="n">new_list_split</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">new_tree</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tree</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
            <span class="n">new_list_split</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="n">i</span><span class="p">])</span> <span class="c1"># we save the index in the old tree</span>
    <span class="k">return</span> <span class="n">new_tree</span><span class="p">,</span><span class="n">new_list_split</span>

<span class="k">def</span> <span class="nf">tree_split_shap</span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="n">tree</span><span class="p">,</span><span class="n">sparsity_level</span><span class="p">,</span><span class="n">list_split</span><span class="p">,</span><span class="n">nb_neigh</span><span class="o">=</span><span class="mi">15</span><span class="p">):</span>
    <span class="kn">from</span> <span class="nn">numpy</span> <span class="k">import</span> <span class="o">*</span>
    <span class="n">new_tree</span>  <span class="o">=</span><span class="nb">list</span><span class="p">([])</span>
    <span class="n">new_list_split</span> <span class="o">=</span> <span class="nb">list</span><span class="p">([])</span>
    <span class="n">tree_size</span> <span class="o">=</span> <span class="n">shape</span><span class="p">(</span><span class="n">tree</span><span class="p">)</span>
    <span class="n">i</span><span class="o">=</span><span class="mi">0</span>
    <span class="n">shape_dat</span> <span class="o">=</span> <span class="n">shape</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">tree_size</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
        <span class="n">l</span> <span class="o">=</span> <span class="n">size</span><span class="p">(</span><span class="n">tree</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>

        <span class="k">if</span> <span class="n">list_split</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">==</span><span class="mi">1</span> <span class="ow">and</span> <span class="n">l</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="o">*</span><span class="n">sparsity_level</span><span class="o">+</span><span class="mi">2</span> <span class="p">:</span>
            <span class="n">data_i</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">tree</span><span class="p">[</span><span class="n">i</span><span class="p">],:]</span>
            <span class="n">u</span> <span class="o">=</span> <span class="n">array</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">6</span><span class="p">))</span>
            <span class="n">shap</span> <span class="o">=</span> <span class="n">data_i</span><span class="o">.</span><span class="n">shape</span>
            <span class="n">lx</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="mi">6</span><span class="p">)</span>
            <span class="nb">id</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="n">lx</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span>
            <span class="n">data_shap_i</span> <span class="o">=</span> <span class="n">data_i</span><span class="p">[:,</span><span class="nb">id</span><span class="o">+</span><span class="n">lx</span><span class="o">*</span><span class="n">u</span><span class="p">]</span>
            <span class="n">nb_neigh_in</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">nb_neigh</span><span class="p">,</span><span class="nb">int</span><span class="p">(</span><span class="n">l</span><span class="o">/</span><span class="mi">2</span><span class="p">))</span>
            <span class="n">part_ind</span> <span class="o">=</span> <span class="n">diffusion_partionning</span><span class="p">(</span><span class="n">data_shap_i</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="n">nb_neigh</span><span class="o">=</span><span class="n">nb_neigh_in</span><span class="p">)</span>
            <span class="n">tree_ind_1</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
            <span class="n">tree_ind_2</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
            <span class="n">l1</span> <span class="o">=</span> <span class="n">size</span><span class="p">(</span><span class="n">part_ind</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">l2</span> <span class="o">=</span> <span class="n">size</span><span class="p">(</span><span class="n">part_ind</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">l1</span><span class="o">&lt;=</span><span class="n">sparsity_level</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">l2</span><span class="o">&lt;=</span><span class="n">sparsity_level</span><span class="p">):</span>
                <span class="n">new_tree</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tree</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                <span class="n">new_list_split</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="n">i</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">i1</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">l1</span><span class="p">):</span>
                    <span class="n">tree_ind_1</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tree</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">part_ind</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">i1</span><span class="p">]])</span>
                <span class="k">for</span> <span class="n">i2</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">l2</span><span class="p">):</span>
                    <span class="n">tree_ind_2</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tree</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">part_ind</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">i2</span><span class="p">]])</span>

                <span class="n">new_tree</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tree_ind_1</span><span class="p">)</span>
                <span class="n">new_tree</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tree_ind_2</span><span class="p">)</span>
                <span class="n">new_list_split</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
                <span class="n">new_list_split</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">new_tree</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tree</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
            <span class="n">new_list_split</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="n">i</span><span class="p">])</span> <span class="c1"># we save the index in the old tree</span>
    <span class="k">return</span> <span class="n">new_tree</span><span class="p">,</span><span class="n">new_list_split</span>


<span class="k">def</span> <span class="nf">tree_split_shap_2</span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="n">tree</span><span class="p">,</span><span class="n">sparsity_level</span><span class="p">,</span><span class="n">list_split</span><span class="p">,</span><span class="n">nb_neigh</span><span class="o">=</span><span class="mi">15</span><span class="p">):</span>
    <span class="kn">from</span> <span class="nn">numpy</span> <span class="k">import</span> <span class="o">*</span>
    <span class="n">new_tree</span>  <span class="o">=</span><span class="nb">list</span><span class="p">([])</span>
    <span class="n">new_list_split</span> <span class="o">=</span> <span class="nb">list</span><span class="p">([])</span>
    <span class="n">tree_size</span> <span class="o">=</span> <span class="n">shape</span><span class="p">(</span><span class="n">tree</span><span class="p">)</span>
    <span class="n">i</span><span class="o">=</span><span class="mi">0</span>
    <span class="n">shape_dat</span> <span class="o">=</span> <span class="n">shape</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">tree_size</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
        <span class="n">l</span> <span class="o">=</span> <span class="n">size</span><span class="p">(</span><span class="n">tree</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>

        <span class="k">if</span> <span class="n">list_split</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">==</span><span class="mi">1</span> <span class="ow">and</span> <span class="n">l</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="o">*</span><span class="n">sparsity_level</span><span class="o">+</span><span class="mi">2</span> <span class="p">:</span>
            <span class="n">data_i</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">tree</span><span class="p">[</span><span class="n">i</span><span class="p">],:]</span>
            <span class="n">u</span> <span class="o">=</span> <span class="n">array</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">6</span><span class="p">))</span>
            <span class="n">shap</span> <span class="o">=</span> <span class="n">data_i</span><span class="o">.</span><span class="n">shape</span>
            <span class="n">lx</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="mi">6</span><span class="p">)</span>
            <span class="nb">id</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="n">lx</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span>
            <span class="n">data_shap_i</span> <span class="o">=</span> <span class="n">data_i</span><span class="p">[:,</span><span class="nb">id</span><span class="o">+</span><span class="n">lx</span><span class="o">*</span><span class="n">u</span><span class="p">]</span>
            <span class="n">data_shap_i_2</span> <span class="o">=</span> <span class="n">mk_ellipticity_atoms_basic_arr</span><span class="p">(</span><span class="n">data_shap_i</span><span class="p">)</span>
            <span class="n">nb_neigh_in</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">nb_neigh</span><span class="p">,</span><span class="nb">int</span><span class="p">(</span><span class="n">l</span><span class="o">/</span><span class="mi">2</span><span class="p">))</span>
            <span class="n">part_ind</span> <span class="o">=</span> <span class="n">diffusion_partionning</span><span class="p">(</span><span class="n">data_shap_i_2</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="n">nb_neigh</span><span class="o">=</span><span class="n">nb_neigh_in</span><span class="p">)</span>
            <span class="n">tree_ind_1</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
            <span class="n">tree_ind_2</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
            <span class="n">l1</span> <span class="o">=</span> <span class="n">size</span><span class="p">(</span><span class="n">part_ind</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">l2</span> <span class="o">=</span> <span class="n">size</span><span class="p">(</span><span class="n">part_ind</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">l1</span><span class="o">&lt;=</span><span class="n">sparsity_level</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">l2</span><span class="o">&lt;=</span><span class="n">sparsity_level</span><span class="p">):</span>
                <span class="n">new_tree</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tree</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                <span class="n">new_list_split</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="n">i</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">i1</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">l1</span><span class="p">):</span>
                    <span class="n">tree_ind_1</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tree</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">part_ind</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">i1</span><span class="p">]])</span>
                <span class="k">for</span> <span class="n">i2</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">l2</span><span class="p">):</span>
                    <span class="n">tree_ind_2</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tree</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">part_ind</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">i2</span><span class="p">]])</span>

                <span class="n">new_tree</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tree_ind_1</span><span class="p">)</span>
                <span class="n">new_tree</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tree_ind_2</span><span class="p">)</span>
                <span class="n">new_list_split</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
                <span class="n">new_list_split</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">new_tree</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tree</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
            <span class="n">new_list_split</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="n">i</span><span class="p">])</span> <span class="c1"># we save the index in the old tree</span>
    <span class="k">return</span> <span class="n">new_tree</span><span class="p">,</span><span class="n">new_list_split</span>


<span class="k">def</span> <span class="nf">geometric_dictionary_learning_2</span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="n">sparsity_lev</span><span class="p">,</span><span class="n">tol</span><span class="p">,</span><span class="n">nb_neigh</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span><span class="n">rel_en</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span> <span class="c1"># Tol = pourcentage in terms of quadratic error</span>
    <span class="kn">from</span> <span class="nn">numpy</span> <span class="k">import</span> <span class="o">*</span>
    <span class="c1">#tol_abs = tol*(data**2).sum()</span>
    <span class="n">split_en</span><span class="o">=</span><span class="mi">1</span>
    <span class="n">tree_init</span> <span class="o">=</span> <span class="nb">list</span><span class="p">([])</span>
    <span class="n">siz_data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">tree_init</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">siz_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
    <span class="n">tree</span> <span class="o">=</span> <span class="n">tree_init</span>
    <span class="n">list_split</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">list_split</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">dictionary</span><span class="p">,</span><span class="n">cells_means</span><span class="p">,</span><span class="n">coeff_tree</span><span class="o">=</span><span class="n">tree_SVD</span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="n">tree_init</span><span class="p">,</span><span class="n">sparsity_lev</span><span class="p">,</span><span class="n">list_split</span><span class="p">)</span>
    <span class="n">nb_sc</span><span class="o">=</span><span class="mi">0</span>
    <span class="k">while</span> <span class="p">(</span><span class="n">split_en</span> <span class="o">==</span> <span class="mi">1</span><span class="p">):</span>
        <span class="nb">print</span> <span class="s1">&#39;tree splitting&#39;</span>
        <span class="n">tree</span><span class="p">,</span><span class="n">list_split</span><span class="o">=</span><span class="n">tree_split_2</span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="n">tree</span><span class="p">,</span><span class="n">sparsity_lev</span><span class="p">,</span><span class="n">list_split</span><span class="p">,</span><span class="n">nb_neigh</span><span class="o">=</span><span class="n">nb_neigh</span><span class="p">)</span>
        <span class="nb">print</span> <span class="s1">&#39;iteratice SVD&#39;</span>
        <span class="n">dictionary</span><span class="p">,</span><span class="n">cells_means</span><span class="p">,</span><span class="n">coeff_tree</span><span class="o">=</span><span class="n">tree_SVD</span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="n">tree</span><span class="p">,</span><span class="n">sparsity_lev</span><span class="p">,</span><span class="n">list_split</span><span class="p">,</span><span class="n">old_dictionary</span><span class="o">=</span><span class="n">dictionary</span><span class="p">,</span><span class="n">old_cells_means</span><span class="o">=</span><span class="n">cells_means</span><span class="p">,</span><span class="n">coeff_comp</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
        <span class="nb">print</span> <span class="s1">&#39;projection error&#39;</span>
        <span class="n">split_en</span><span class="p">,</span><span class="n">list_split</span> <span class="o">=</span> <span class="n">tree_approx_test</span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="n">tree</span><span class="p">,</span><span class="n">dictionary</span><span class="p">,</span><span class="n">tol</span><span class="p">,</span><span class="n">cells_means</span><span class="p">,</span><span class="n">list_split</span><span class="p">,</span><span class="n">rel_en</span><span class="o">=</span><span class="n">rel_en</span><span class="p">)</span>
        <span class="n">nb_sc</span><span class="o">=</span><span class="n">nb_sc</span><span class="o">+</span><span class="mi">1</span>
        <span class="nb">print</span> <span class="s1">&#39;scale &#39;</span><span class="p">,</span><span class="n">nb_sc</span>
        <span class="nb">print</span> <span class="s1">&#39;number of cells:&#39;</span><span class="p">,</span> <span class="n">shape</span><span class="p">(</span><span class="n">tree</span><span class="p">)</span>

    <span class="n">data_est</span> <span class="o">=</span> <span class="n">data</span><span class="o">*</span><span class="mi">0</span>
    <span class="n">nb_cells</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">tree</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_cells</span><span class="p">):</span>
        <span class="n">nb_memb</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">tree</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        <span class="n">proji</span> <span class="o">=</span> <span class="n">dictionary</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">transpose</span><span class="p">(</span><span class="n">dictionary</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">]))</span>
        <span class="n">centi</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">cells_means</span><span class="p">[</span><span class="n">i</span><span class="p">,:])</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">siz_data</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="mi">1</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_memb</span><span class="p">):</span>
            <span class="n">dij</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">tree</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">],:])</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">siz_data</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="mi">1</span><span class="p">))</span>
            <span class="n">estij</span> <span class="o">=</span> <span class="n">proji</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">dij</span><span class="o">-</span><span class="n">centi</span><span class="p">)</span> <span class="o">+</span> <span class="n">centi</span>
            <span class="n">data_est</span><span class="p">[</span><span class="n">tree</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]]</span> <span class="o">=</span> <span class="n">estij</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">siz_data</span><span class="p">[</span><span class="mi">1</span><span class="p">],))</span>

    <span class="k">return</span> <span class="n">tree</span><span class="p">,</span><span class="n">dictionary</span><span class="p">,</span><span class="n">cells_means</span><span class="p">,</span><span class="n">nb_sc</span><span class="p">,</span><span class="n">data_est</span>

<span class="k">def</span> <span class="nf">geometric_dictionary_learning_cube_2</span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="n">sparsity_lev</span><span class="p">,</span><span class="n">tol</span><span class="p">,</span><span class="n">nb_neigh</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span><span class="n">rel_en</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="n">shap</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">data_in</span> <span class="o">=</span> <span class="n">cube_to_mat</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="n">tree</span><span class="p">,</span><span class="n">dictionary</span><span class="p">,</span><span class="n">cells_means</span><span class="p">,</span><span class="n">nb_sc</span><span class="p">,</span><span class="n">data_est</span> <span class="o">=</span> <span class="n">geometric_dictionary_learning_2</span><span class="p">(</span><span class="n">data_in</span><span class="p">,</span><span class="n">sparsity_lev</span><span class="p">,</span><span class="n">tol</span><span class="p">,</span><span class="n">nb_neigh</span><span class="o">=</span><span class="n">nb_neigh</span><span class="p">,</span><span class="n">rel_en</span><span class="o">=</span><span class="n">rel_en</span><span class="p">)</span>
    <span class="n">data_est_out</span> <span class="o">=</span> <span class="n">mat_to_cube</span><span class="p">(</span><span class="n">data_est</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">cells_means_out</span> <span class="o">=</span> <span class="n">mat_to_cube</span><span class="p">(</span><span class="n">cells_means</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">dictionnary_out</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
    <span class="n">nb_cells</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">tree</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_cells</span><span class="p">):</span>
        <span class="n">dictionnary_out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mat_to_cube</span><span class="p">(</span><span class="n">transpose</span><span class="p">(</span><span class="n">dictionary</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">]),</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
    <span class="k">return</span> <span class="n">tree</span><span class="p">,</span><span class="n">dictionnary_out</span><span class="p">,</span><span class="n">cells_means_out</span><span class="p">,</span><span class="n">nb_sc</span><span class="p">,</span><span class="n">data_est_out</span>

<span class="k">def</span> <span class="nf">geometric_dictionary_learning_cube_2_m</span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="n">sparsity_lev</span><span class="p">,</span><span class="n">tol</span><span class="p">,</span><span class="n">nb_neigh</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span><span class="n">rel_en</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="n">shap</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">est</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">data</span><span class="p">)</span><span class="o">*</span><span class="mi">0</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">3</span><span class="p">]):</span>
        <span class="nb">print</span> <span class="s2">&quot;==============================================&quot;</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="s2">&quot;/&quot;</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span><span class="s2">&quot;=======================================================&quot;</span>
        <span class="n">tree</span><span class="p">,</span><span class="n">dictionnary_out</span><span class="p">,</span><span class="n">cells_means_out</span><span class="p">,</span><span class="n">nb_sc</span><span class="p">,</span><span class="n">data_est_out</span> <span class="o">=</span> <span class="n">geometric_dictionary_learning_cube_2</span><span class="p">(</span><span class="n">data</span><span class="p">[:,:,:,</span><span class="n">i</span><span class="p">],</span><span class="n">sparsity_lev</span><span class="p">,</span><span class="n">tol</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">nb_neigh</span><span class="o">=</span><span class="n">nb_neigh</span><span class="p">,</span><span class="n">rel_en</span><span class="o">=</span><span class="n">rel_en</span><span class="p">)</span>
        <span class="n">est</span><span class="p">[:,:,:,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">data_est_out</span>
    <span class="k">return</span> <span class="n">est</span>


<span class="k">def</span> <span class="nf">shap_geometric_dictionary_learning_2</span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="n">sparsity_lev</span><span class="p">,</span><span class="n">tol_ell</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span><span class="n">tol_init</span><span class="o">=</span><span class="mf">0.0001</span><span class="p">,</span><span class="n">nb_neigh</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span><span class="n">iter_max</span><span class="o">=</span><span class="mi">5</span><span class="p">):</span>
    <span class="n">count</span><span class="o">=</span><span class="mi">0</span>
    <span class="n">stop</span><span class="o">=</span><span class="kc">False</span>
    <span class="n">tree</span><span class="o">=</span><span class="kc">None</span>
    <span class="n">dictionary</span><span class="o">=</span><span class="kc">None</span>
    <span class="n">cells_means</span><span class="o">=</span><span class="kc">None</span>
    <span class="n">nb_sc</span><span class="o">=</span><span class="kc">None</span>
    <span class="n">tol</span><span class="o">=</span><span class="n">tol_init</span>
    <span class="k">while</span> <span class="p">(</span><span class="n">stop</span><span class="o">==</span><span class="kc">False</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">count</span><span class="o">&lt;</span><span class="mi">1</span><span class="p">):</span>
        <span class="n">tree</span><span class="p">,</span><span class="n">dictionary</span><span class="p">,</span><span class="n">cells_means</span><span class="p">,</span><span class="n">nb_sc</span> <span class="o">=</span> <span class="n">geometric_dictionary_learning_2</span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="n">sparsity_lev</span><span class="p">,</span><span class="n">tol</span><span class="p">,</span><span class="n">nb_neigh</span><span class="o">=</span><span class="n">nb_neigh</span><span class="p">)</span>
        <span class="n">mell1_err</span><span class="p">,</span><span class="n">mell2_err</span><span class="p">,</span><span class="n">medell1_err</span><span class="p">,</span><span class="n">medell2_err</span><span class="p">,</span><span class="n">stdell1_err</span><span class="p">,</span><span class="n">stdell2_err</span> <span class="o">=</span> <span class="n">shap_dictionary_accuracy</span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="n">dictionary</span><span class="p">,</span><span class="n">cells_means</span><span class="p">,</span><span class="n">tree</span><span class="p">)</span>
        <span class="n">l</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">tree</span><span class="p">)</span>
        <span class="n">k</span><span class="o">=</span><span class="mi">0</span>
        <span class="n">acc_reached</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">while</span> <span class="p">(</span><span class="n">acc_reached</span><span class="o">==</span><span class="kc">True</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">k</span><span class="o">&lt;</span><span class="n">l</span><span class="p">):</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">medell1_err</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">&gt;</span><span class="n">tol_ell</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">medell2_err</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">&gt;</span><span class="n">tol_ell</span><span class="p">):</span>
                <span class="n">acc_reached</span><span class="o">=</span><span class="kc">False</span>
                <span class="n">tol</span> <span class="o">=</span> <span class="n">tol</span><span class="o">/</span><span class="mi">2</span>
                <span class="nb">print</span> <span class="s1">&#39;max(mell1_err),min(mell1_err),max(mell2_err),min(mell2_err) : &#39;</span><span class="p">,</span><span class="nb">max</span><span class="p">(</span><span class="n">mell1_err</span><span class="p">),</span><span class="nb">min</span><span class="p">(</span><span class="n">mell1_err</span><span class="p">),</span><span class="nb">max</span><span class="p">(</span><span class="n">mell2_err</span><span class="p">),</span><span class="nb">min</span><span class="p">(</span><span class="n">mell2_err</span><span class="p">)</span>
                <span class="nb">print</span> <span class="s1">&#39;medell1_err,medell2_err: &#39;</span><span class="p">,</span><span class="n">medell1_err</span><span class="p">,</span><span class="n">medell2_err</span>
                <span class="nb">print</span> <span class="s1">&#39;reducing square error tolerance&#39;</span>

            <span class="n">k</span><span class="o">+=</span><span class="mi">1</span>
        <span class="n">count</span><span class="o">+=</span><span class="mi">1</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">acc_reached</span><span class="o">==</span><span class="kc">True</span><span class="p">):</span>
            <span class="n">stop</span><span class="o">=</span><span class="kc">True</span>
    <span class="k">return</span> <span class="n">tree</span><span class="p">,</span><span class="n">dictionary</span><span class="p">,</span><span class="n">cells_means</span><span class="p">,</span><span class="n">nb_sc</span><span class="p">,</span><span class="n">tol</span><span class="p">,</span><span class="n">mell1_err</span><span class="p">,</span><span class="n">mell2_err</span><span class="p">,</span><span class="n">medell1_err</span><span class="p">,</span><span class="n">medell2_err</span><span class="p">,</span><span class="n">stdell1_err</span><span class="p">,</span><span class="n">stdell2_err</span>



<span class="k">def</span> <span class="nf">shap_tg_space_accuracy</span><span class="p">(</span><span class="n">shap_data</span><span class="p">,</span><span class="n">tg_mat</span><span class="p">,</span><span class="n">cell_mean</span><span class="p">):</span>
    <span class="n">shap</span> <span class="o">=</span> <span class="n">shap_data</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">ell1_err</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">],))</span>
    <span class="n">ell2_err</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">],))</span>
    <span class="n">i</span><span class="o">=</span><span class="mi">0</span>
    <span class="n">shap_data_approx</span> <span class="o">=</span> <span class="p">((</span><span class="n">shap_data</span><span class="o">-</span><span class="n">ones</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="mi">1</span><span class="p">))</span><span class="o">*</span><span class="n">cell_mean</span><span class="p">)</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">tg_mat</span><span class="p">))</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">transpose</span><span class="p">(</span><span class="n">tg_mat</span><span class="p">))</span><span class="o">+</span><span class="n">ones</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="mi">1</span><span class="p">))</span><span class="o">*</span><span class="n">cell_mean</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
        <span class="n">shap_mati</span> <span class="o">=</span> <span class="n">shap_data</span><span class="p">[</span><span class="n">i</span><span class="p">,:]</span>
        <span class="n">shap_mati</span> <span class="o">=</span> <span class="n">shap_mati</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">6</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="mi">6</span><span class="p">))</span>
        <span class="n">shap_mat_approxi</span> <span class="o">=</span> <span class="n">shap_data_approx</span><span class="p">[</span><span class="n">i</span><span class="p">,:]</span>
        <span class="n">shap_mat_approxi</span> <span class="o">=</span> <span class="n">shap_mat_approxi</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">6</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="mi">6</span><span class="p">))</span>
        <span class="n">li</span> <span class="o">=</span> <span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="mi">6</span>
        <span class="n">Ui</span> <span class="o">=</span> <span class="n">shap_mati</span><span class="p">[:,(</span><span class="n">li</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">]</span>
        <span class="n">U_approxi</span> <span class="o">=</span> <span class="n">shap_mat_approxi</span><span class="p">[:,(</span><span class="n">li</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">]</span>
        <span class="n">elli</span> <span class="o">=</span> <span class="n">mk_ellipticity_atoms_basic</span><span class="p">(</span><span class="n">Ui</span><span class="p">)</span>
        <span class="n">ell_approxi</span> <span class="o">=</span> <span class="n">mk_ellipticity_atoms_basic</span><span class="p">(</span><span class="n">U_approxi</span><span class="p">)</span>
        <span class="n">ell1_err</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">100</span><span class="o">*</span><span class="nb">abs</span><span class="p">(</span><span class="n">elli</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">ell_approxi</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span><span class="o">/</span><span class="nb">abs</span><span class="p">(</span><span class="n">elli</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">ell2_err</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">100</span><span class="o">*</span><span class="nb">abs</span><span class="p">(</span><span class="n">elli</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">ell_approxi</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">])</span><span class="o">/</span><span class="nb">abs</span><span class="p">(</span><span class="n">elli</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">])</span>

    <span class="n">mell_err1</span> <span class="o">=</span> <span class="n">mean</span><span class="p">(</span><span class="n">ell1_err</span><span class="p">)</span>
    <span class="n">mell_err2</span> <span class="o">=</span> <span class="n">mean</span><span class="p">(</span><span class="n">ell2_err</span><span class="p">)</span>
    <span class="n">medell_err1</span> <span class="o">=</span> <span class="n">median</span><span class="p">(</span><span class="n">ell1_err</span><span class="p">)</span>
    <span class="n">medell_err2</span> <span class="o">=</span> <span class="n">median</span><span class="p">(</span><span class="n">ell2_err</span><span class="p">)</span>
    <span class="n">stdell_err1</span> <span class="o">=</span> <span class="n">std</span><span class="p">(</span><span class="n">ell1_err</span><span class="p">)</span>
    <span class="n">stdell_err2</span> <span class="o">=</span> <span class="n">std</span><span class="p">(</span><span class="n">ell2_err</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">mell_err1</span><span class="p">,</span><span class="n">mell_err2</span><span class="p">,</span><span class="n">medell_err1</span><span class="p">,</span><span class="n">medell_err2</span><span class="p">,</span><span class="n">stdell_err1</span><span class="p">,</span><span class="n">stdell_err2</span>

<span class="k">def</span> <span class="nf">shap_dictionary_accuracy</span><span class="p">(</span><span class="n">shap_data</span><span class="p">,</span><span class="n">dictionary</span><span class="p">,</span><span class="n">cells_means</span><span class="p">,</span><span class="n">tree</span><span class="p">):</span>
    <span class="n">l</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">tree</span><span class="p">)</span>
    <span class="n">k</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">mell1_err</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">l</span><span class="p">,))</span>
    <span class="n">mell2_err</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">l</span><span class="p">,))</span>
    <span class="n">medell1_err</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">l</span><span class="p">,))</span>
    <span class="n">medell2_err</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">l</span><span class="p">,))</span>
    <span class="n">stdell1_err</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">l</span><span class="p">,))</span>
    <span class="n">stdell2_err</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">l</span><span class="p">,))</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">l</span><span class="p">):</span>
        <span class="n">shap_data_k</span> <span class="o">=</span> <span class="n">shap_data</span><span class="p">[</span><span class="n">tree</span><span class="p">[</span><span class="n">k</span><span class="p">],:]</span>
        <span class="n">tg_mat</span> <span class="o">=</span> <span class="n">dictionary</span><span class="p">[:,:,</span><span class="n">k</span><span class="p">]</span>
        <span class="n">cell_mean</span> <span class="o">=</span> <span class="n">cells_means</span><span class="p">[</span><span class="n">k</span><span class="p">,:]</span>
        <span class="n">mell1_errk</span><span class="p">,</span><span class="n">mell2_errk</span><span class="p">,</span><span class="n">medell1_errk</span><span class="p">,</span><span class="n">medell2_errk</span><span class="p">,</span><span class="n">stdell1_errk</span><span class="p">,</span><span class="n">stdell2_errk</span> <span class="o">=</span> <span class="n">shap_tg_space_accuracy</span><span class="p">(</span><span class="n">shap_data_k</span><span class="p">,</span><span class="n">tg_mat</span><span class="p">,</span><span class="n">cell_mean</span><span class="p">)</span>
        <span class="n">mell1_err</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">mell1_errk</span>
        <span class="n">mell2_err</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">mell2_errk</span>
        <span class="n">medell1_err</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">medell1_errk</span>
        <span class="n">medell2_err</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">medell2_errk</span>
        <span class="n">stdell1_err</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">stdell1_errk</span>
        <span class="n">stdell2_err</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">stdell2_errk</span>
    <span class="k">return</span> <span class="n">mell1_err</span><span class="p">,</span><span class="n">mell2_err</span><span class="p">,</span><span class="n">medell1_err</span><span class="p">,</span><span class="n">medell2_err</span><span class="p">,</span><span class="n">stdell1_err</span><span class="p">,</span><span class="n">stdell2_err</span>

<span class="k">def</span> <span class="nf">gal_shape_dic_learning</span><span class="p">(</span><span class="n">mat</span><span class="p">,</span><span class="n">sparsity_lev</span><span class="p">,</span><span class="n">tol</span><span class="p">,</span><span class="n">nb_neigh</span><span class="o">=</span><span class="mi">15</span><span class="p">):</span>
    <span class="kn">from</span> <span class="nn">numpy</span> <span class="k">import</span> <span class="o">*</span>
    <span class="n">tree</span><span class="p">,</span><span class="n">dictionary</span><span class="p">,</span><span class="n">cells_means</span><span class="p">,</span><span class="n">nb_sc</span> <span class="o">=</span> <span class="n">geometric_dictionary_learning_2</span><span class="p">(</span><span class="n">mat</span><span class="p">,</span><span class="n">sparsity_lev</span><span class="p">,</span><span class="n">tol</span><span class="p">,</span><span class="n">nb_neigh</span><span class="o">=</span><span class="n">nb_neigh</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">tree</span><span class="p">,</span><span class="n">dictionary</span><span class="p">,</span><span class="n">cells_means</span><span class="p">,</span><span class="n">nb_sc</span>

<span class="k">def</span> <span class="nf">gnd_tp_data_saving</span><span class="p">(</span><span class="n">pos_map</span><span class="p">,</span><span class="n">weights</span><span class="p">,</span><span class="n">pos_map_file</span><span class="p">,</span><span class="n">weights_file</span><span class="p">):</span> <span class="c1"># Data are saved in lines order</span>
    <span class="n">f1</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">pos_map_file</span><span class="p">,</span><span class="s1">&#39;w&#39;</span><span class="p">)</span>
    <span class="n">f2</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">weights_file</span><span class="p">,</span><span class="s1">&#39;w&#39;</span><span class="p">)</span>
    <span class="n">shap</span> <span class="o">=</span> <span class="n">pos_map</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
            <span class="n">f1</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%f</span><span class="s2"> </span><span class="si">%f</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">pos_map</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span><span class="n">pos_map</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="mi">1</span><span class="p">]))</span>
            <span class="n">f2</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%f</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">weights</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]))</span>
    <span class="n">f1</span><span class="o">.</span><span class="n">close</span>
    <span class="n">f2</span><span class="o">.</span><span class="n">close</span>
    <span class="k">return</span> <span class="mi">0</span>

<span class="k">def</span> <span class="nf">read_opt_map</span><span class="p">(</span><span class="n">mapping_file</span><span class="p">,</span><span class="n">len_flow</span><span class="p">):</span>
    <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">mapping_file</span><span class="p">,</span><span class="s1">&#39;r&#39;</span><span class="p">)</span>
    <span class="n">k</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">mapping</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">len_flow</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">fromfile</span><span class="p">(</span><span class="n">mapping_file</span><span class="p">,</span><span class="n">sep</span><span class="o">=</span><span class="s2">&quot; &quot;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">len_flow</span><span class="p">):</span>
        <span class="n">mapping</span><span class="p">[</span><span class="n">k</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">k</span><span class="o">*</span><span class="mi">3</span><span class="p">]</span>   <span class="c1"># Origin</span>
        <span class="n">mapping</span><span class="p">[</span><span class="n">k</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">k</span><span class="o">*</span><span class="mi">3</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="c1"># Destination</span>
        <span class="n">mapping</span><span class="p">[</span><span class="n">k</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">k</span><span class="o">*</span><span class="mi">3</span><span class="o">+</span><span class="mi">2</span><span class="p">]</span> <span class="c1"># Mass moved</span>
    <span class="k">return</span> <span class="n">mapping</span>

<span class="k">def</span> <span class="nf">gnd_tp_solver_wrp</span><span class="p">(</span><span class="n">distrib_1</span><span class="p">,</span><span class="n">distrib_2</span><span class="p">,</span><span class="n">pos_map_1</span><span class="p">,</span><span class="n">pos_map_2</span><span class="p">,</span><span class="n">exe_path</span><span class="o">=</span><span class="s2">&quot;../../CPP/NOT/build/gnd_tp_solve&quot;</span><span class="p">,</span><span class="n">del_file</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>

    <span class="n">pos_map_file_1</span> <span class="o">=</span> <span class="n">randfilename</span><span class="p">()</span>
    <span class="n">pos_map_file_2</span> <span class="o">=</span> <span class="n">randfilename</span><span class="p">()</span>
    <span class="n">weights_file_1</span> <span class="o">=</span> <span class="n">randfilename</span><span class="p">()</span>
    <span class="n">weights_file_2</span> <span class="o">=</span> <span class="n">randfilename</span><span class="p">()</span>
    <span class="n">mapping_file</span> <span class="o">=</span> <span class="n">randfilename</span><span class="p">()</span>
    <span class="nb">print</span> <span class="n">pos_map_file_1</span><span class="p">,</span><span class="n">pos_map_file_2</span><span class="p">,</span><span class="n">weights_file_1</span><span class="p">,</span><span class="n">weights_file_2</span><span class="p">,</span><span class="n">mapping_file</span>
    <span class="n">gnd_tp_data_saving</span><span class="p">(</span><span class="n">pos_map_1</span><span class="p">,</span><span class="n">distrib_1</span><span class="p">,</span><span class="n">pos_map_file_1</span><span class="p">,</span><span class="n">weights_file_1</span><span class="p">)</span>
    <span class="n">gnd_tp_data_saving</span><span class="p">(</span><span class="n">pos_map_2</span><span class="p">,</span><span class="n">distrib_2</span><span class="p">,</span><span class="n">pos_map_file_2</span><span class="p">,</span><span class="n">weights_file_2</span><span class="p">)</span>
    <span class="n">shap1</span> <span class="o">=</span> <span class="n">distrib_1</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">shap2</span> <span class="o">=</span> <span class="n">distrib_2</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">subprocess</span><span class="o">.</span><span class="n">call</span><span class="p">([</span><span class="n">exe_path</span><span class="p">,</span><span class="n">pos_map_file_1</span><span class="p">,</span><span class="n">weights_file_1</span><span class="p">,</span><span class="n">pos_map_file_2</span><span class="p">,</span><span class="n">weights_file_2</span><span class="p">,</span><span class="nb">str</span><span class="p">(</span><span class="n">shap1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">shap1</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span><span class="nb">str</span><span class="p">(</span><span class="n">shap2</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">shap2</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span><span class="n">mapping_file</span><span class="p">])</span>
    <span class="n">len_flow</span> <span class="o">=</span> <span class="n">shap1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">shap1</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">shap2</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">shap2</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span>
    <span class="n">mapping</span> <span class="o">=</span> <span class="n">read_opt_map</span><span class="p">(</span><span class="n">mapping_file</span><span class="p">,</span><span class="n">len_flow</span><span class="p">)</span> <span class="c1"># The 1st and 2nd columns contains linear indexes with the convention floor(ind/line_length) = line index; mod(ind,line_length) = column index</span>

    <span class="k">if</span> <span class="n">del_file</span><span class="o">==</span><span class="kc">True</span><span class="p">:</span>
        <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">pos_map_file_1</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">pos_map_file_2</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">weights_file_1</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">weights_file_2</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">mapping_file</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">mapping</span>


<span class="k">def</span> <span class="nf">space_var_conv_mat_feat</span><span class="p">(</span><span class="n">target_siz</span><span class="p">,</span><span class="n">samples_coord</span><span class="p">,</span><span class="n">lanczos_rad</span><span class="o">=</span><span class="mi">4</span><span class="p">):</span> <span class="c1"># This function returns a matrix which performs a lanczos interpolation from a regular grid to a set arbitrary position; the non-zeros entries of the matrix are also provided.</span>
    <span class="n">nb_data</span> <span class="o">=</span> <span class="n">samples_coord</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">k</span><span class="o">=</span><span class="mi">0</span>
    <span class="n">nb_pix</span> <span class="o">=</span> <span class="n">target_siz</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">target_siz</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">mat</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">nb_data</span><span class="p">,</span><span class="n">nb_pix</span><span class="p">))</span>
    <span class="n">supp_cols</span> <span class="o">=</span> <span class="nb">list</span><span class="p">({})</span>
    <span class="n">supp_lines</span> <span class="o">=</span> <span class="nb">list</span><span class="p">({})</span>

    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_pix</span><span class="p">):</span>
        <span class="n">supp_cols</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">list</span><span class="p">({}))</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_data</span><span class="p">):</span>
        <span class="n">supp_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">list</span><span class="p">({}))</span>
    <span class="n">lip</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_data</span><span class="p">):</span>
        <span class="n">pos</span>  <span class="o">=</span> <span class="n">floor</span><span class="p">(</span><span class="n">samples_coord</span><span class="p">[</span><span class="n">k</span><span class="p">,:])</span>
        <span class="n">delta</span> <span class="o">=</span> <span class="n">samples_coord</span><span class="p">[</span><span class="n">k</span><span class="p">,:]</span> <span class="o">-</span> <span class="n">pos</span>
        <span class="n">kernel</span> <span class="o">=</span> <span class="n">lanczos</span><span class="p">(</span><span class="n">transpose</span><span class="p">(</span><span class="o">-</span><span class="n">delta</span><span class="p">),</span><span class="n">n</span><span class="o">=</span><span class="n">lanczos_rad</span><span class="p">)</span>
        <span class="n">norm_ker</span> <span class="o">=</span> <span class="n">sqrt</span><span class="p">((</span><span class="n">kernel</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span>
        <span class="k">if</span> <span class="n">norm_ker</span><span class="o">*</span><span class="n">nb_data</span> <span class="o">&gt;</span> <span class="n">lip</span><span class="p">:</span>
            <span class="n">lip</span> <span class="o">=</span> <span class="n">norm_ker</span><span class="o">*</span><span class="n">nb_data</span>
        <span class="n">m</span><span class="p">,</span><span class="n">l</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span>
        <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="o">*</span><span class="n">lanczos_rad</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="o">*</span><span class="n">lanczos_rad</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
                <span class="n">id_line</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">pos</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">*</span><span class="n">target_siz</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="nb">int</span><span class="p">(</span><span class="n">pos</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">+</span><span class="n">l</span><span class="o">-</span><span class="n">lanczos_rad</span><span class="o">+</span><span class="p">(</span><span class="n">m</span><span class="o">-</span><span class="n">lanczos_rad</span><span class="p">)</span><span class="o">*</span><span class="n">target_siz</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">id_line</span><span class="o">&gt;=</span><span class="mi">0</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">id_line</span><span class="o">&lt;</span><span class="n">nb_pix</span><span class="p">):</span>
                    <span class="n">mat</span><span class="p">[</span><span class="n">k</span><span class="p">,</span><span class="n">id_line</span><span class="p">]</span> <span class="o">=</span> <span class="n">kernel</span><span class="p">[</span><span class="n">m</span><span class="p">,</span><span class="n">l</span><span class="p">]</span>
                    <span class="n">supp_lines</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">id_line</span><span class="p">)</span>

                    <span class="n">supp_cols</span><span class="p">[</span><span class="n">id_line</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">mat</span><span class="p">,</span><span class="n">supp_cols</span><span class="p">,</span><span class="n">supp_lines</span><span class="p">,</span><span class="n">lip</span>

<span class="k">def</span> <span class="nf">space_var_conv_mat</span><span class="p">(</span><span class="n">mat</span><span class="p">,</span><span class="n">X</span><span class="p">,</span><span class="n">supp_lines</span><span class="p">):</span>

    <span class="n">n</span><span class="o">=</span><span class="mi">0</span>
    <span class="n">shap</span> <span class="o">=</span> <span class="n">mat</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">Y</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">],))</span>
    <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
        <span class="k">if</span> <span class="n">supp_lines</span><span class="p">[</span><span class="n">n</span><span class="p">]:</span>
            <span class="n">ind</span> <span class="o">=</span> <span class="n">array</span><span class="p">(</span><span class="n">supp_lines</span><span class="p">[</span><span class="n">n</span><span class="p">])</span>
            <span class="n">Y</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="n">mat</span><span class="p">[</span><span class="n">n</span><span class="p">,</span><span class="n">ind</span><span class="p">]</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">X</span><span class="p">[</span><span class="n">ind</span><span class="p">])</span>

    <span class="k">return</span> <span class="n">Y</span>

<span class="k">def</span> <span class="nf">space_var_conv_transpose_mat</span><span class="p">(</span><span class="n">mat</span><span class="p">,</span><span class="n">Y</span><span class="p">,</span><span class="n">supp_cols</span><span class="p">):</span>
    <span class="n">n</span><span class="o">=</span><span class="mi">0</span>
    <span class="n">shap</span> <span class="o">=</span> <span class="n">mat</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">X</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">],))</span>
    <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
        <span class="k">if</span> <span class="n">supp_cols</span><span class="p">[</span><span class="n">n</span><span class="p">]:</span>
            <span class="n">ind</span> <span class="o">=</span> <span class="n">array</span><span class="p">(</span><span class="n">supp_cols</span><span class="p">[</span><span class="n">n</span><span class="p">])</span>
            <span class="n">X</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="n">transpose</span><span class="p">(</span><span class="n">mat</span><span class="p">[</span><span class="n">ind</span><span class="p">,</span><span class="n">n</span><span class="p">])</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">Y</span><span class="p">[</span><span class="n">ind</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">X</span>

<span class="k">def</span> <span class="nf">get_euclid_psf</span><span class="p">(</span><span class="n">nb_psf</span><span class="p">,</span><span class="n">shap</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">wvlgth</span><span class="o">=</span><span class="mi">725</span><span class="p">,</span><span class="n">data_path</span><span class="o">=</span><span class="s1">&#39;../../../Data/psf_euclid/&#39;</span><span class="p">,</span><span class="n">central</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="nb">id</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span> <span class="c1"># wavlgt = wavelength in nanometers</span>

    <span class="n">path</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
    <span class="n">nb_psf_in</span> <span class="o">=</span> <span class="n">nb_psf</span>
    <span class="n">wvlgth_min</span> <span class="o">=</span> <span class="mi">475</span>
    <span class="n">wvlgth_max</span> <span class="o">=</span> <span class="mi">970</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">wvlgth</span> <span class="o">&gt;</span> <span class="n">wvlgth_max</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">wvlgth</span> <span class="o">&lt;</span> <span class="n">wvlgth_min</span><span class="p">):</span>
        <span class="nb">print</span> <span class="s1">&#39;The specfied wavelength should be taken within [475,970]. Wavelength setr to 725nm&#39;</span>
        <span class="n">wvlgth</span> <span class="o">=</span> <span class="mi">725</span>
    <span class="n">wvl_id</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mi">99</span><span class="o">*</span><span class="p">(</span><span class="n">wvlgth</span> <span class="o">-</span> <span class="n">wvlgth_min</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">wvlgth_max</span> <span class="o">-</span> <span class="n">wvlgth_min</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>

    <span class="n">crop_en</span><span class="o">=</span><span class="kc">True</span>
    <span class="k">if</span> <span class="n">central</span><span class="o">==</span><span class="kc">True</span><span class="p">:</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">data_path</span><span class="o">+</span><span class="s1">&#39;central4CCDs/&#39;</span>
        <span class="k">if</span> <span class="n">nb_psf</span><span class="o">+</span><span class="nb">id</span><span class="o">&gt;</span><span class="mi">599</span><span class="p">:</span>
            <span class="nb">print</span> <span class="s1">&#39;Warning: only 599 central PSF available&#39;</span>
            <span class="n">nb_psf_in</span> <span class="o">=</span> <span class="mi">599</span><span class="o">-</span><span class="nb">id</span>
        <span class="k">if</span> <span class="n">shap</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">psf_test</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">getdata</span><span class="p">(</span><span class="n">path</span><span class="o">+</span><span class="s1">&#39;PSF_MC_T0072.ZMX__Npup_4096x4096_lbda_0.800um_central4ccds.cat_0001.fits&#39;</span><span class="p">,</span><span class="n">wvl_id</span><span class="p">)</span>
            <span class="n">shap</span> <span class="o">=</span> <span class="n">psf_test</span><span class="o">.</span><span class="n">shape</span>
            <span class="n">crop_en</span><span class="o">=</span><span class="kc">False</span>
    <span class="k">if</span> <span class="n">central</span><span class="o">==</span><span class="kc">False</span><span class="p">:</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">data_path</span><span class="o">+</span><span class="s1">&#39;corner36pos/&#39;</span>
        <span class="k">if</span> <span class="n">nb_psf</span><span class="o">&gt;</span><span class="mi">36</span><span class="p">:</span>
            <span class="nb">print</span> <span class="s1">&#39;Warning: only 599 central PSF available&#39;</span>
            <span class="n">nb_psf_in</span> <span class="o">=</span> <span class="mi">36</span><span class="o">-</span><span class="nb">id</span>
        <span class="k">if</span> <span class="n">shap</span><span class="o">==</span><span class="kc">None</span><span class="p">:</span>
            <span class="n">psf_test</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">getdata</span><span class="p">(</span><span class="n">path</span><span class="o">+</span><span class="s1">&#39;PSF_MC_T0072.ZMX__Npup_4096x4096_lbda_0.800um_bords_guillard.cat_0001.fits&#39;</span><span class="p">,</span><span class="n">wvl_id</span><span class="p">)</span>
            <span class="n">shap</span> <span class="o">=</span> <span class="n">psf_test</span><span class="o">.</span><span class="n">shape</span>
            <span class="n">crop_en</span><span class="o">=</span><span class="kc">False</span>

    <span class="n">field_pos_vect</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">nb_psf_in</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span>
    <span class="n">psf_cube</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">nb_psf_in</span><span class="p">))</span>
    <span class="n">psf</span><span class="o">=</span><span class="kc">None</span>
    <span class="n">psf_file</span><span class="o">=</span><span class="kc">None</span>
    <span class="n">k</span><span class="o">=</span><span class="mi">0</span>
    <span class="n">psf_ind</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">central</span><span class="o">==</span><span class="kc">True</span><span class="p">:</span>
        <span class="n">psf_ind</span> <span class="o">=</span> <span class="n">rand_diff_integ</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">599</span><span class="p">,</span><span class="n">nb_psf_in</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">psf_ind</span> <span class="o">=</span> <span class="n">rand_diff_integ</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">35</span><span class="p">,</span><span class="n">nb_psf_in</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_psf_in</span><span class="p">):</span>
        <span class="n">psf_id</span> <span class="o">=</span> <span class="n">psf_ind</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">+</span><span class="nb">id</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">central</span><span class="o">==</span><span class="kc">True</span><span class="p">):</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">psf_id</span><span class="o">&lt;</span><span class="mi">10</span><span class="p">):</span>
                <span class="n">psf_file</span> <span class="o">=</span> <span class="n">path</span><span class="o">+</span><span class="s1">&#39;PSF_MC_T0072.ZMX__Npup_4096x4096_lbda_0.800um_central4ccds.cat_000&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">psf_id</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;.fits&#39;</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">psf_id</span><span class="o">&lt;</span><span class="mi">100</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">psf_id</span><span class="o">&gt;</span><span class="mi">9</span><span class="p">):</span>
                <span class="n">psf_file</span> <span class="o">=</span> <span class="n">path</span><span class="o">+</span><span class="s1">&#39;PSF_MC_T0072.ZMX__Npup_4096x4096_lbda_0.800um_central4ccds.cat_00&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">psf_id</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;.fits&#39;</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">psf_id</span><span class="o">&gt;</span><span class="mi">99</span><span class="p">):</span>
                <span class="n">psf_file</span> <span class="o">=</span> <span class="n">path</span><span class="o">+</span><span class="s1">&#39;PSF_MC_T0072.ZMX__Npup_4096x4096_lbda_0.800um_central4ccds.cat_0&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">psf_id</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;.fits&#39;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">central</span><span class="o">==</span><span class="kc">False</span><span class="p">):</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">psf_id</span><span class="o">&lt;</span><span class="mi">10</span><span class="p">):</span>
                <span class="n">psf_file</span> <span class="o">=</span> <span class="n">path</span><span class="o">+</span><span class="s1">&#39;PSF_MC_T0072.ZMX__Npup_4096x4096_lbda_0.800um_bords_guillard.cat_000&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">psf_id</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;.fits&#39;</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">psf_id</span><span class="o">&gt;</span><span class="mi">9</span><span class="p">):</span>
                <span class="n">psf_file</span> <span class="o">=</span> <span class="n">path</span><span class="o">+</span><span class="s1">&#39;PSF_MC_T0072.ZMX__Npup_4096x4096_lbda_0.800um_bords_guillard.cat_00&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">psf_id</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;.fits&#39;</span>
        <span class="nb">print</span> <span class="n">psf_file</span>
        <span class="n">psf</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">getdata</span><span class="p">(</span><span class="n">psf_file</span><span class="p">,</span><span class="n">wvl_id</span><span class="p">)</span>
        <span class="n">field_pos_vect</span><span class="p">[</span><span class="n">k</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">getval</span><span class="p">(</span><span class="n">psf_file</span><span class="p">,</span><span class="s1">&#39;XFIELD&#39;</span><span class="p">,</span><span class="n">wvl_id</span><span class="p">)</span>
        <span class="n">field_pos_vect</span><span class="p">[</span><span class="n">k</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">getval</span><span class="p">(</span><span class="n">psf_file</span><span class="p">,</span><span class="s1">&#39;YFIELD&#39;</span><span class="p">,</span><span class="n">wvl_id</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">crop_en</span><span class="p">:</span>
            <span class="n">psf_cube</span><span class="p">[:,:,</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">rect_crop</span><span class="p">(</span><span class="n">psf</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">sigw</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">psf_cube</span><span class="p">[:,:,</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">psf</span>

    <span class="k">return</span> <span class="n">psf_cube</span><span class="p">,</span><span class="n">field_pos_vect</span>

<span class="k">def</span> <span class="nf">arcsec2pix_euclid</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">res_fact</span><span class="p">):</span>

    <span class="n">b</span> <span class="o">=</span> <span class="n">a</span><span class="o">*</span><span class="mf">12.0</span><span class="o">/</span><span class="p">(</span><span class="mf">0.101</span><span class="o">*</span><span class="n">res_fact</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">b</span>

<span class="k">def</span> <span class="nf">argsort2D</span><span class="p">(</span><span class="n">arr</span><span class="p">):</span>
    <span class="n">shap</span> <span class="o">=</span> <span class="n">arr</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">arr_in</span> <span class="o">=</span> <span class="n">reshape</span><span class="p">(</span><span class="n">arr</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">ind</span> <span class="o">=</span> <span class="n">argsort</span><span class="p">(</span><span class="n">arr_in</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">ind</span>

<span class="k">def</span> <span class="nf">randwalk</span><span class="p">(</span><span class="n">rad</span><span class="o">=</span><span class="mi">60</span><span class="p">,</span><span class="n">res_fact</span><span class="o">=</span><span class="mi">6</span><span class="p">,</span><span class="n">nb_steps</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span><span class="n">amp</span><span class="o">=</span><span class="mf">0.1</span><span class="p">):</span>
    <span class="n">ker</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="mi">2</span><span class="o">*</span><span class="n">rad</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="o">*</span><span class="n">rad</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>
    <span class="n">ker</span><span class="p">[</span><span class="n">rad</span><span class="p">,</span><span class="n">rad</span><span class="p">]</span><span class="o">=</span><span class="mi">1</span>
    <span class="n">pos_init</span> <span class="o">=</span> <span class="n">array</span><span class="p">([</span><span class="n">rad</span><span class="p">,</span><span class="n">rad</span><span class="p">])</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_steps</span><span class="p">):</span>
        <span class="n">pos_init</span> <span class="o">=</span> <span class="n">pos_init</span> <span class="o">+</span> <span class="n">amp</span><span class="o">*</span><span class="p">(</span><span class="mf">12.0</span><span class="o">/</span><span class="n">res_fact</span><span class="p">)</span><span class="o">*</span><span class="n">randn</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
        <span class="nb">print</span> <span class="n">pos_init</span>
        <span class="n">ind</span> <span class="o">=</span> <span class="n">array</span><span class="p">([</span><span class="nb">int</span><span class="p">(</span><span class="n">pos_init</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span><span class="nb">int</span><span class="p">(</span><span class="n">pos_init</span><span class="p">[</span><span class="mi">1</span><span class="p">])])</span>
        <span class="n">ind</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">rad</span><span class="p">,</span><span class="n">ind</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">ind</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">rad</span><span class="p">,</span><span class="n">ind</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span><span class="mi">0</span><span class="p">)</span>
        <span class="nb">print</span> <span class="n">ind</span>
        <span class="n">ker</span><span class="p">[</span><span class="n">ind</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">ind</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span><span class="o">=</span><span class="mi">1</span>
    <span class="k">return</span> <span class="n">ker</span>

<span class="k">def</span> <span class="nf">randwalk_pol</span><span class="p">(</span><span class="n">rad</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span><span class="n">nb_steps</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span><span class="n">ampr</span><span class="o">=</span><span class="mf">0.6</span><span class="p">,</span><span class="n">amp_deg</span> <span class="o">=</span> <span class="mi">15</span><span class="p">):</span>
    <span class="n">ker</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="mi">2</span><span class="o">*</span><span class="n">rad</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="o">*</span><span class="n">rad</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>
    <span class="n">ker</span><span class="p">[</span><span class="n">rad</span><span class="p">,</span><span class="n">rad</span><span class="p">]</span><span class="o">=</span><span class="mi">1</span>
    <span class="n">pos_init</span> <span class="o">=</span> <span class="n">array</span><span class="p">([</span><span class="n">rad</span><span class="p">,</span><span class="n">rad</span><span class="p">])</span>
    <span class="n">cent</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">pos_init</span><span class="p">)</span>
    <span class="n">r</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">theta</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_steps</span><span class="p">):</span>
        <span class="n">r</span> <span class="o">+=</span> <span class="n">ampr</span><span class="o">*</span><span class="n">randn</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">theta</span> <span class="o">+=</span> <span class="nb">abs</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">pi</span><span class="o">*</span><span class="n">amp_deg</span><span class="o">*</span><span class="n">randn</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="mi">180</span><span class="p">)</span>
        <span class="n">pos_init</span> <span class="o">=</span> <span class="n">array</span><span class="p">([</span><span class="n">r</span><span class="o">*</span><span class="n">cos</span><span class="p">(</span><span class="n">theta</span><span class="p">)</span><span class="o">+</span><span class="n">rad</span><span class="p">,</span><span class="n">r</span><span class="o">*</span><span class="n">sin</span><span class="p">(</span><span class="n">theta</span><span class="p">)</span><span class="o">+</span><span class="n">rad</span><span class="p">])</span>
        <span class="c1">#print pos_init</span>
        <span class="n">ind</span> <span class="o">=</span> <span class="n">array</span><span class="p">([</span><span class="nb">int</span><span class="p">(</span><span class="n">pos_init</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span><span class="nb">int</span><span class="p">(</span><span class="n">pos_init</span><span class="p">[</span><span class="mi">1</span><span class="p">])])</span>
        <span class="n">ind</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">rad</span><span class="p">,</span><span class="n">ind</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">ind</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">rad</span><span class="p">,</span><span class="n">ind</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span><span class="mi">0</span><span class="p">)</span>
        <span class="c1">#print ind</span>
        <span class="n">ker</span><span class="p">[</span><span class="n">ind</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">ind</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span><span class="o">+=</span><span class="mi">1</span>
    <span class="k">return</span> <span class="n">ker</span>


<span class="k">def</span> <span class="nf">get_euclid_psf_2</span><span class="p">(</span><span class="n">nb_psf</span><span class="p">,</span><span class="n">shap</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">wvlgth</span><span class="o">=</span><span class="mi">730</span><span class="p">,</span><span class="n">data_path</span><span class="o">=</span><span class="s1">&#39;../../../Data/psf_euclid_2/&#39;</span><span class="p">,</span><span class="n">rand_en</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">centering_en</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span> <span class="c1"># wavlgt = wavelength in nanometers</span>

    <span class="n">psf_names</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">data_path</span><span class="p">)</span>
    <span class="n">htest</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">data_path</span><span class="o">+</span><span class="n">psf_names</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">psf_test</span> <span class="o">=</span> <span class="n">htest</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>
    <span class="n">nb_wav</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">htest</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span>

    <span class="n">wvlgth_min</span> <span class="o">=</span> <span class="n">htest</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;WLGTH0&#39;</span><span class="p">]</span><span class="o">*</span><span class="mi">1000</span>
    <span class="n">wvlgth_max</span> <span class="o">=</span> <span class="n">htest</span><span class="p">[</span><span class="n">nb_wav</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;WLGTH0&#39;</span><span class="p">]</span><span class="o">*</span><span class="mi">1000</span>
    <span class="n">wvl_mean</span> <span class="o">=</span> <span class="p">(</span><span class="n">wvlgth_min</span><span class="o">+</span><span class="n">wvlgth_max</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">wvlgth</span> <span class="o">&gt;</span> <span class="n">wvlgth_max</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">wvlgth</span> <span class="o">&lt;</span> <span class="n">wvlgth_min</span><span class="p">):</span>
        <span class="nb">print</span> <span class="s1">&#39;The specfied wavelength should be taken within [&#39;</span><span class="p">,</span><span class="n">wvlgth_min</span><span class="p">,</span><span class="s1">&#39;,&#39;</span><span class="p">,</span><span class="n">wvlgth_max</span><span class="p">,</span><span class="s1">&#39;]. Wavelength set to &#39;</span><span class="p">,</span><span class="n">wvl_mean</span>
        <span class="n">wvlgth</span> <span class="o">=</span> <span class="n">wvl_mean</span>
    <span class="n">wvl_id</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="n">nb_wav</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">wvlgth</span> <span class="o">-</span> <span class="n">wvlgth_min</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">wvlgth_max</span> <span class="o">-</span> <span class="n">wvlgth_min</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">nb_max</span> <span class="o">=</span> <span class="n">size</span><span class="p">(</span><span class="n">psf_names</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">nb_psf</span> <span class="o">&gt;</span> <span class="n">nb_max</span><span class="p">:</span>
        <span class="nb">print</span> <span class="s1">&#39;Too many PSF requested. Returning the max.&#39;</span>
        <span class="n">nb_psf</span> <span class="o">=</span> <span class="n">nb_max</span>
    <span class="n">psf_ind</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">nb_psf</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">rand_en</span> <span class="ow">and</span> <span class="n">nb_psf</span><span class="o">&lt;</span><span class="n">nb_max</span><span class="p">:</span>
        <span class="n">psf_ind</span> <span class="o">=</span> <span class="n">rand_diff_integ</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">nb_max</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">nb_psf</span><span class="p">)</span>
    <span class="nb">print</span> <span class="s2">&quot;PSF ind: &quot;</span><span class="p">,</span><span class="n">psf_ind</span>

    <span class="n">crop_en</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">if</span> <span class="n">shap</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">shap</span> <span class="o">=</span> <span class="n">psf_test</span><span class="o">.</span><span class="n">shape</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">crop_en</span><span class="o">=</span><span class="mi">1</span>
    <span class="n">htest</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="n">psf_cube</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">nb_psf</span><span class="p">))</span>
    <span class="n">field_pos_vect</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">nb_psf</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span>
    <span class="n">outliers</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_psf</span><span class="p">):</span>
        <span class="nb">print</span> <span class="n">psf_ind</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="nb">print</span> <span class="n">data_path</span><span class="o">+</span><span class="n">psf_names</span><span class="p">[</span><span class="n">psf_ind</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span>
        <span class="n">hdu</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">data_path</span><span class="o">+</span><span class="n">psf_names</span><span class="p">[</span><span class="n">psf_ind</span><span class="p">[</span><span class="n">i</span><span class="p">]])</span>
        <span class="n">wvl_id_loc</span> <span class="o">=</span> <span class="n">wvl_id</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">hdu</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span> <span class="o">&lt;</span> <span class="n">wvl_id_loc</span><span class="p">:</span>
            <span class="nb">print</span> <span class="s1">&#39;Warning outlier wavelenght&#39;</span>
            <span class="n">outliers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">psf_ind</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
            <span class="n">wvl_id_loc</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">crop_en</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
            <span class="n">psf_cube</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">hdu</span><span class="p">[</span><span class="n">wvl_id_loc</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">psf_cube</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">rect_crop</span><span class="p">(</span><span class="n">hdu</span><span class="p">[</span><span class="n">wvl_id_loc</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">sigw</span><span class="o">=</span><span class="mi">1000</span><span class="p">)</span>
        <span class="n">field_pos_vect</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">hdu</span><span class="p">[</span><span class="n">wvl_id_loc</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;XFIELD&#39;</span><span class="p">]</span>
        <span class="n">field_pos_vect</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">hdu</span><span class="p">[</span><span class="n">wvl_id_loc</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;YFIELD&#39;</span><span class="p">]</span>
        <span class="n">hdu</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">centering_en</span><span class="p">:</span>
        <span class="n">psf_cube</span> <span class="o">=</span> <span class="n">stack_regist</span><span class="p">(</span><span class="n">psf_cube</span><span class="p">,</span><span class="n">n</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">psf_cube</span><span class="p">,</span><span class="n">field_pos_vect</span><span class="p">,</span><span class="n">psf_names</span><span class="p">,</span><span class="n">outliers</span>


<span class="k">def</span> <span class="nf">get_euclid_psf_wvl</span><span class="p">(</span><span class="n">shap</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">data_path</span><span class="o">=</span><span class="s1">&#39;../../../Data/psf_euclid/central4CCDs/&#39;</span><span class="p">,</span><span class="n">ind</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">centering_en</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">norm_en</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span> <span class="c1"># wavlgt = wavelength in nanometers</span>

    <span class="n">psf_names</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">data_path</span><span class="p">)</span>
    <span class="n">htest</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">data_path</span><span class="o">+</span><span class="n">psf_names</span><span class="p">[</span><span class="n">ind</span><span class="o">+</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">l</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">htest</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span>
    <span class="n">shaptemp</span> <span class="o">=</span> <span class="n">htest</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">psf_test</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">shaptemp</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">shaptemp</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">l</span><span class="p">))</span>
    <span class="n">wvl</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">l</span><span class="p">,))</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">l</span><span class="p">):</span>
        <span class="n">psf_test</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">htest</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
        <span class="n">wvl</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">htest</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;WLGTH0&#39;</span><span class="p">]</span><span class="o">*</span><span class="mi">1000</span>
    <span class="k">if</span> <span class="n">shap</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">psf_test</span> <span class="o">=</span> <span class="n">rect_crop</span><span class="p">(</span><span class="n">psf_test</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">sigw</span><span class="o">=</span><span class="mi">1000</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">centering_en</span><span class="p">:</span>
        <span class="n">psf_test</span> <span class="o">=</span> <span class="n">stack_regist</span><span class="p">(</span><span class="n">psf_test</span><span class="p">,</span><span class="n">n</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">norm_en</span><span class="p">:</span>
        <span class="n">psf_test</span> <span class="o">=</span> <span class="n">stack_norm</span><span class="p">(</span><span class="n">psf_test</span><span class="p">,</span><span class="n">norm</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">psf_test</span><span class="p">,</span><span class="n">wvl</span>

<span class="k">def</span> <span class="nf">get_euclid_psf_wvl_field</span><span class="p">(</span><span class="n">shap</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">data_path</span><span class="o">=</span><span class="s1">&#39;../../../Data/psf_euclid/central4CCDs/&#39;</span><span class="p">,</span><span class="n">nb_psfs</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span><span class="n">nb_max</span> <span class="o">=</span> <span class="mi">599</span><span class="p">,</span><span class="n">centering_en</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">norm_en</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span> <span class="c1"># wavlgt = wavelength in nanometers</span>

    <span class="n">psf_names</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">data_path</span><span class="p">)</span>
    <span class="n">htest</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">data_path</span><span class="o">+</span><span class="n">psf_names</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">nb_bands</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">htest</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span>
    <span class="n">wvl</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">nb_bands</span><span class="p">,))</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_bands</span><span class="p">):</span>
        <span class="n">wvl</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">htest</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;WLGTH0&#39;</span><span class="p">]</span><span class="o">*</span><span class="mi">1000</span>
    <span class="n">shaptemp</span> <span class="o">=</span> <span class="n">htest</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span>

    <span class="n">id_ref</span> <span class="o">=</span> <span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">nb_max</span><span class="p">)</span>
    <span class="n">samp</span> <span class="o">=</span> <span class="n">choice</span><span class="p">(</span><span class="n">id_ref</span><span class="p">,</span><span class="n">size</span><span class="o">=</span><span class="n">nb_psfs</span><span class="p">,</span><span class="n">replace</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">psfs</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
    <span class="n">field_pos_vect</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">nb_psfs</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_psfs</span><span class="p">):</span>
        <span class="nb">print</span> <span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="s2">&quot;/&quot;</span><span class="p">,</span><span class="n">nb_psfs</span>
        <span class="n">htest</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">data_path</span><span class="o">+</span><span class="n">psf_names</span><span class="p">[</span><span class="n">id_ref</span><span class="p">[</span><span class="n">i</span><span class="p">]])</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">htest</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="o">==</span><span class="n">nb_bands</span><span class="p">:</span>
            <span class="n">psf_test</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">shaptemp</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">shaptemp</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">nb_bands</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_bands</span><span class="p">):</span>
                <span class="n">psf_test</span><span class="p">[:,:,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">htest</span><span class="p">[</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">shap</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">psf_test</span> <span class="o">=</span> <span class="n">rect_crop</span><span class="p">(</span><span class="n">psf_test</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">sigw</span><span class="o">=</span><span class="mi">1000</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">centering_en</span><span class="p">:</span>
                <span class="n">psf_test</span> <span class="o">=</span> <span class="n">stack_regist</span><span class="p">(</span><span class="n">psf_test</span><span class="p">,</span><span class="n">n</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">norm_en</span><span class="p">:</span>
                <span class="n">psf_test</span> <span class="o">=</span> <span class="n">stack_norm</span><span class="p">(</span><span class="n">psf_test</span><span class="p">,</span><span class="n">norm</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">psfs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">psf_test</span><span class="p">)</span>
            <span class="n">field_pos_vect</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">htest</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;XFIELD&#39;</span><span class="p">]</span>
            <span class="n">field_pos_vect</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">htest</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;YFIELD&#39;</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">psfs</span><span class="p">,</span><span class="n">wvl</span><span class="p">,</span><span class="n">field_pos_vect</span>



<span class="k">def</span> <span class="nf">get_euclid_mix</span><span class="p">(</span><span class="n">nb_cent</span><span class="o">=</span><span class="mi">600</span><span class="p">,</span><span class="n">nb_corn</span><span class="o">=</span><span class="mi">36</span><span class="p">,</span><span class="n">nb_loc</span><span class="o">=</span><span class="mi">400</span><span class="p">,</span><span class="n">shap</span><span class="o">=</span><span class="p">[</span><span class="mi">512</span><span class="p">,</span><span class="mi">512</span><span class="p">],</span><span class="n">wvlgth</span><span class="o">=</span><span class="mi">730</span><span class="p">,</span><span class="n">rand_en</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">centering_en</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="n">nb_psf</span> <span class="o">=</span> <span class="n">nb_cent</span> <span class="o">+</span> <span class="n">nb_corn</span> <span class="o">+</span> <span class="n">nb_loc</span>
    <span class="n">psf_cube</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">nb_psf</span><span class="p">))</span>
    <span class="n">field_pos_vect</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">nb_psf</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span>
    <span class="n">central_psf</span> <span class="o">=</span> <span class="s1">&#39;../../../Data/psf_euclid/central4CCDs/&#39;</span>
    <span class="n">corner_psf</span> <span class="o">=</span> <span class="s1">&#39;../../../Data/psf_euclid/corner36pos/&#39;</span>
    <span class="n">loc_psf</span> <span class="o">=</span> <span class="s1">&#39;../../../Data/psf_euclid_2/&#39;</span>

    <span class="n">psf_cube_1</span><span class="p">,</span><span class="n">field_pos_vect_1</span><span class="p">,</span><span class="n">psf_names</span><span class="p">,</span><span class="n">outliers_1</span> <span class="o">=</span> <span class="n">get_euclid_psf_2</span><span class="p">(</span><span class="n">nb_cent</span><span class="p">,</span><span class="n">shap</span><span class="o">=</span><span class="n">shap</span><span class="p">,</span><span class="n">wvlgth</span><span class="o">=</span><span class="n">wvlgth</span><span class="p">,</span><span class="n">data_path</span><span class="o">=</span><span class="n">central_psf</span><span class="p">,</span><span class="n">rand_en</span><span class="o">=</span><span class="n">rand_en</span><span class="p">,</span><span class="n">centering_en</span><span class="o">=</span><span class="n">centering_en</span><span class="p">)</span>
    <span class="n">psf_cube_2</span><span class="p">,</span><span class="n">field_pos_vect_2</span><span class="p">,</span><span class="n">psf_names</span><span class="p">,</span><span class="n">outliers_2</span> <span class="o">=</span> <span class="n">get_euclid_psf_2</span><span class="p">(</span><span class="n">nb_corn</span><span class="p">,</span><span class="n">shap</span><span class="o">=</span><span class="n">shap</span><span class="p">,</span><span class="n">wvlgth</span><span class="o">=</span><span class="n">wvlgth</span><span class="p">,</span><span class="n">data_path</span><span class="o">=</span><span class="n">corner_psf</span><span class="p">,</span><span class="n">rand_en</span><span class="o">=</span><span class="n">rand_en</span><span class="p">,</span><span class="n">centering_en</span><span class="o">=</span><span class="n">centering_en</span><span class="p">)</span>
    <span class="n">psf_cube_3</span><span class="p">,</span><span class="n">field_pos_vect_3</span><span class="p">,</span><span class="n">psf_names</span><span class="p">,</span><span class="n">outliers_3</span> <span class="o">=</span> <span class="n">get_euclid_psf_2</span><span class="p">(</span><span class="n">nb_loc</span><span class="p">,</span><span class="n">shap</span><span class="o">=</span><span class="n">shap</span><span class="p">,</span><span class="n">wvlgth</span><span class="o">=</span><span class="n">wvlgth</span><span class="p">,</span><span class="n">data_path</span><span class="o">=</span><span class="n">loc_psf</span><span class="p">,</span><span class="n">rand_en</span><span class="o">=</span><span class="n">rand_en</span><span class="p">,</span><span class="n">centering_en</span><span class="o">=</span><span class="n">centering_en</span><span class="p">)</span>
    <span class="n">psf_cube</span><span class="p">[:,:,</span><span class="mi">0</span><span class="p">:</span><span class="n">nb_cent</span><span class="p">]</span> <span class="o">=</span> <span class="n">psf_cube_1</span>
    <span class="n">psf_cube</span><span class="p">[:,:,</span><span class="n">nb_cent</span><span class="p">:</span><span class="n">nb_cent</span><span class="o">+</span><span class="n">nb_corn</span><span class="p">]</span> <span class="o">=</span> <span class="n">psf_cube_2</span>
    <span class="n">psf_cube</span><span class="p">[:,:,</span><span class="n">nb_cent</span><span class="o">+</span><span class="n">nb_corn</span><span class="p">:</span><span class="n">nb_psf</span><span class="p">]</span> <span class="o">=</span> <span class="n">psf_cube_3</span>
    <span class="n">nb_outliers</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">outliers_1</span><span class="p">)</span><span class="o">+</span><span class="nb">len</span><span class="p">(</span><span class="n">outliers_2</span><span class="p">)</span><span class="o">+</span><span class="nb">len</span><span class="p">(</span><span class="n">outliers_3</span><span class="p">)</span>
    <span class="n">outliers</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">nb_outliers</span><span class="p">,))</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_outliers</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span><span class="nb">len</span><span class="p">(</span><span class="n">outliers_1</span><span class="p">):</span>
            <span class="n">outliers</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">outliers_1</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">i</span><span class="o">&lt;</span><span class="nb">len</span><span class="p">(</span><span class="n">outliers_1</span><span class="p">)</span><span class="o">+</span><span class="nb">len</span><span class="p">(</span><span class="n">outliers_2</span><span class="p">):</span>
                <span class="n">outliers</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">outliers_1</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">outliers_1</span><span class="p">)]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">outliers</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">outliers_1</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">outliers_1</span><span class="p">)</span><span class="o">+</span><span class="nb">len</span><span class="p">(</span><span class="n">outliers_2</span><span class="p">))]</span>


    <span class="n">field_pos_vect</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">nb_cent</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">field_pos_vect_1</span>
    <span class="n">field_pos_vect</span><span class="p">[</span><span class="n">nb_cent</span><span class="p">:</span><span class="n">nb_cent</span><span class="o">+</span><span class="n">nb_corn</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">field_pos_vect_2</span>
    <span class="n">field_pos_vect</span><span class="p">[</span><span class="n">nb_cent</span><span class="o">+</span><span class="n">nb_corn</span><span class="p">:</span><span class="n">nb_psf</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">field_pos_vect_3</span>

    <span class="k">return</span> <span class="n">psf_cube</span><span class="p">,</span><span class="n">field_pos_vect</span><span class="p">,</span><span class="n">outliers</span>



<span class="k">def</span> <span class="nf">compact_sub_samp_extract</span><span class="p">(</span><span class="n">psf_cube</span><span class="p">,</span><span class="n">field_pos_vect</span><span class="p">,</span><span class="n">nb_psf</span><span class="p">):</span>
    <span class="n">ind</span> <span class="o">=</span> <span class="n">distance_graph_sorting</span><span class="p">(</span><span class="n">field_pos_vect</span><span class="p">,</span><span class="n">nb_max</span><span class="o">=</span><span class="n">nb_psf</span><span class="p">)</span>
    <span class="n">cube_out</span> <span class="o">=</span> <span class="n">psf_cube</span><span class="p">[:,:,</span><span class="n">ind</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">cube_out</span><span class="p">,</span><span class="n">field_pos_vect</span><span class="p">[</span><span class="n">ind</span><span class="p">,:]</span>


<span class="k">def</span> <span class="nf">psf_rot_regist</span><span class="p">(</span><span class="n">psf</span><span class="p">,</span><span class="n">sig</span><span class="p">,</span><span class="n">diagn</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="n">ell</span><span class="p">,</span><span class="n">cent</span> <span class="o">=</span> <span class="n">mk_ellipticity</span><span class="p">(</span><span class="n">psf</span><span class="p">,</span><span class="n">sig</span><span class="p">,</span><span class="n">niter_cent</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span><span class="n">cent_return</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">sqrt</span><span class="p">(</span><span class="n">ell</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="n">ell</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">cos_om</span> <span class="o">=</span> <span class="n">ell</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="n">r</span>
    <span class="n">om</span> <span class="o">=</span> <span class="n">arccos</span><span class="p">(</span><span class="n">cos_om</span><span class="p">)</span>
    <span class="n">theta</span> <span class="o">=</span> <span class="n">om</span><span class="o">/</span><span class="mi">2</span>
    <span class="n">M</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">getRotationMatrix2D</span><span class="p">((</span><span class="n">cent</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span><span class="n">cent</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]),</span><span class="o">-</span><span class="n">theta</span><span class="o">*</span><span class="mi">180</span><span class="o">/</span><span class="n">pi</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">psf_rot</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">warpAffine</span><span class="p">(</span><span class="n">psf</span><span class="p">,</span><span class="n">M</span><span class="p">,(</span><span class="n">psf</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">psf</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
    <span class="k">if</span> <span class="n">diagn</span><span class="p">:</span>
        <span class="n">ell_rot</span> <span class="o">=</span> <span class="n">mk_ellipticity</span><span class="p">(</span><span class="n">psf_rot</span><span class="p">,</span><span class="n">sig</span><span class="p">,</span><span class="n">niter_cent</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">sqrt</span><span class="p">(</span><span class="n">ell_rot</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="n">ell_rot</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">cos_om</span> <span class="o">=</span> <span class="n">ell_rot</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="n">r</span>
        <span class="n">om</span> <span class="o">=</span> <span class="n">arccos</span><span class="p">(</span><span class="n">cos_om</span><span class="p">)</span>
        <span class="n">theta_rot</span> <span class="o">=</span> <span class="n">om</span><span class="o">/</span><span class="mi">2</span>
        <span class="k">return</span> <span class="n">psf_rot</span><span class="p">,</span><span class="n">theta</span><span class="p">,</span><span class="n">ell</span><span class="p">,</span><span class="n">theta_rot</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">psf_rot</span><span class="p">,</span><span class="n">theta</span><span class="p">,</span><span class="n">ell</span>

<span class="k">def</span> <span class="nf">opencv_rot_interf</span><span class="p">(</span><span class="n">im</span><span class="p">,</span><span class="n">theta</span><span class="p">,</span><span class="n">shap</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">cent</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">sig</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span> <span class="c1"># Theta in degrees</span>
    <span class="k">if</span> <span class="n">shap</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">shap</span> <span class="o">=</span> <span class="n">im</span><span class="o">.</span><span class="n">shape</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">sig</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">cent</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
        <span class="n">cent</span><span class="p">,</span><span class="n">Wc</span> <span class="o">=</span> <span class="n">compute_centroid</span><span class="p">(</span><span class="n">im</span><span class="p">,</span><span class="n">sig</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">cent</span> <span class="o">=</span> <span class="n">array</span><span class="p">(((</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">,(</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">))</span>
        <span class="n">cent</span> <span class="o">=</span> <span class="n">cent</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span>
    <span class="n">M</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">getRotationMatrix2D</span><span class="p">((</span><span class="n">cent</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span><span class="n">cent</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]),</span><span class="n">theta</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">im_rot</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">warpAffine</span><span class="p">(</span><span class="n">im</span><span class="p">,</span><span class="n">M</span><span class="p">,(</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
    <span class="k">return</span> <span class="n">im_rot</span><span class="p">,</span><span class="n">cent</span>




<span class="k">def</span> <span class="nf">logpolar</span><span class="p">(</span><span class="nb">input</span><span class="p">,</span><span class="n">cent</span><span class="p">):</span>
    <span class="kn">from</span> <span class="nn">numpy</span> <span class="k">import</span> <span class="n">mgrid</span>
    <span class="c1"># This takes a numpy array and returns it in Log-Polar coordinates.</span>

    <span class="n">coordinates</span> <span class="o">=</span> <span class="n">mgrid</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="nb">max</span><span class="p">(</span><span class="nb">input</span><span class="o">.</span><span class="n">shape</span><span class="p">[:])</span><span class="o">*</span><span class="mi">2</span><span class="p">,</span><span class="mi">0</span><span class="p">:</span><span class="mi">360</span><span class="p">]</span> <span class="c1"># We create a cartesian array which will be used to compute log-polar coordinates.</span>
    <span class="n">log_r</span> <span class="o">=</span> <span class="mi">10</span><span class="o">**</span><span class="p">(</span><span class="n">coordinates</span><span class="p">[</span><span class="mi">0</span><span class="p">,:]</span><span class="o">/</span><span class="p">(</span><span class="nb">input</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="mf">2.</span><span class="p">)</span><span class="o">*</span><span class="n">log10</span><span class="p">(</span><span class="nb">input</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span> <span class="c1"># This contains a normalized logarithmic gradient</span>
    <span class="n">angle</span> <span class="o">=</span> <span class="mf">2.</span><span class="o">*</span><span class="n">pi</span><span class="o">*</span><span class="p">(</span><span class="n">coordinates</span><span class="p">[</span><span class="mi">1</span><span class="p">,:]</span><span class="o">/</span><span class="mf">360.</span><span class="p">)</span> <span class="c1"># This is a linear gradient going from 0 to 2*Pi</span>

    <span class="c1"># Using scipy&#39;s map_coordinates(), we map the input array on the log-polar coordinate. Do not forget to center the coordinates!</span>
    <span class="n">lpinput</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">ndimage</span><span class="o">.</span><span class="n">interpolation</span><span class="o">.</span><span class="n">map_coordinates</span><span class="p">(</span><span class="nb">input</span><span class="p">,(</span><span class="n">log_r</span><span class="o">*</span><span class="n">cos</span><span class="p">(</span><span class="n">angle</span><span class="p">)</span><span class="o">+</span><span class="n">cent</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span><span class="n">log_r</span><span class="o">*</span><span class="n">sin</span><span class="p">(</span><span class="n">angle</span><span class="p">)</span><span class="o">+</span><span class="n">cent</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]),</span><span class="n">order</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span><span class="n">mode</span><span class="o">=</span><span class="s1">&#39;constant&#39;</span><span class="p">)</span>

    <span class="c1"># Returning log-normal...</span>
    <span class="k">return</span> <span class="n">lpinput</span>



<span class="k">def</span> <span class="nf">polar</span><span class="p">(</span><span class="n">image</span><span class="p">,</span><span class="n">center</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">angles</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">radii</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span> <span class="c1"># No scale invariance</span>
    <span class="kn">from</span> <span class="nn">numpy</span> <span class="k">import</span> <span class="n">pi</span><span class="p">,</span><span class="n">sqrt</span><span class="p">,</span><span class="n">linspace</span><span class="p">,</span><span class="n">zeros</span><span class="p">,</span><span class="n">ones</span><span class="p">,</span><span class="n">copy</span><span class="p">,</span><span class="n">arange</span><span class="p">,</span><span class="n">sin</span> <span class="k">as</span> <span class="n">sinnp</span><span class="p">,</span><span class="n">cos</span> <span class="k">as</span> <span class="n">cosnp</span><span class="p">,</span><span class="n">empty_like</span><span class="p">,</span><span class="n">array</span>
    <span class="sd">&quot;&quot;&quot;Return log-polar transformed image and log base.&quot;&quot;&quot;</span>
    <span class="n">shap</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">shape</span>
    <span class="k">if</span> <span class="n">center</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">center</span> <span class="o">=</span> <span class="n">where</span><span class="p">(</span><span class="n">image</span><span class="o">==</span><span class="n">image</span><span class="o">.</span><span class="n">max</span><span class="p">())</span>
    <span class="k">if</span> <span class="n">angles</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">angles</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">pi</span><span class="o">*</span><span class="nb">min</span><span class="p">(</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
    <span class="k">if</span> <span class="n">radii</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">radii</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">sqrt</span><span class="p">(</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span>

    <span class="n">theta</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">angles</span><span class="p">,</span><span class="n">radii</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">float64</span><span class="p">)</span>
    <span class="n">theta</span><span class="o">.</span><span class="n">T</span><span class="p">[:]</span> <span class="o">=</span> <span class="o">-</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="o">*</span><span class="n">pi</span><span class="p">,</span> <span class="n">angles</span><span class="p">,</span> <span class="n">endpoint</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">b</span> <span class="o">=</span> <span class="n">sinnp</span><span class="p">(</span><span class="n">theta</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>
    <span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span>

    <span class="c1">#d = hypot(shape[0]-center[0], shape[1]-center[1])</span>
    <span class="c1">#log_base = 10.0 ** (math.log10(d) / (radii))</span>
    <span class="n">radius</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">theta</span><span class="p">)</span>
    <span class="n">radius</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">array</span><span class="p">(</span><span class="n">arange</span><span class="p">(</span><span class="n">radii</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="n">float64</span><span class="p">))</span>

    <span class="n">x</span> <span class="o">=</span> <span class="n">radius</span><span class="o">*</span><span class="n">sinnp</span><span class="p">(</span><span class="n">theta</span><span class="p">)</span>  <span class="o">+</span> <span class="n">ones</span><span class="p">((</span><span class="n">angles</span><span class="p">,</span><span class="n">radii</span><span class="p">))</span><span class="o">*</span><span class="n">center</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">radius</span><span class="o">*</span><span class="n">cosnp</span><span class="p">(</span><span class="n">theta</span><span class="p">)</span>  <span class="o">+</span> <span class="n">ones</span><span class="p">((</span><span class="n">angles</span><span class="p">,</span><span class="n">radii</span><span class="p">))</span><span class="o">*</span><span class="n">center</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">output</span> <span class="o">=</span> <span class="n">empty_like</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">ndii</span><span class="o">.</span><span class="n">map_coordinates</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="p">[</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">],</span> <span class="n">output</span><span class="o">=</span><span class="n">output</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">output</span>





<span class="k">def</span> <span class="nf">auto_correl_map</span><span class="p">(</span><span class="n">im</span><span class="p">,</span><span class="n">winds</span><span class="p">):</span>
    <span class="n">shap</span> <span class="o">=</span> <span class="n">im</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span>
    <span class="nb">map</span> <span class="o">=</span> <span class="n">im</span><span class="o">*</span><span class="mi">0</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
            <span class="n">i1</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">i</span><span class="o">-</span><span class="p">(</span><span class="n">winds</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">i2</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="p">(</span><span class="n">winds</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">j1</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">j</span><span class="o">-</span><span class="p">(</span><span class="n">winds</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">j2</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">j</span><span class="o">+</span><span class="p">(</span><span class="n">winds</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">wind</span> <span class="o">=</span> <span class="n">im</span><span class="p">[</span><span class="n">i1</span><span class="p">:</span><span class="n">i2</span><span class="p">,</span><span class="n">j1</span><span class="p">:</span><span class="n">j2</span><span class="p">]</span>
            <span class="n">wind_fft</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">scipy_fft</span><span class="o">.</span><span class="n">fft2</span><span class="p">(</span><span class="n">wind</span><span class="p">))</span>
            <span class="nb">map</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">sqrt</span><span class="p">((</span><span class="nb">abs</span><span class="p">(</span><span class="n">wind_fft</span><span class="p">)</span><span class="o">**</span><span class="mi">4</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span>

    <span class="nb">map</span> <span class="o">=</span> <span class="nb">map</span><span class="o">/</span><span class="nb">map</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
    <span class="k">return</span> <span class="nb">map</span>

<span class="k">def</span> <span class="nf">struct_res_support</span><span class="p">(</span><span class="n">cube</span><span class="p">,</span><span class="n">thresh</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span><span class="n">wind</span><span class="o">=</span><span class="mi">10</span><span class="p">):</span>
    <span class="n">shap</span> <span class="o">=</span> <span class="n">cube</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">k</span><span class="o">=</span><span class="mi">0</span>
    <span class="n">supp</span> <span class="o">=</span> <span class="n">cube</span><span class="o">*</span><span class="mi">0</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
        <span class="nb">map</span> <span class="o">=</span> <span class="n">auto_correl_map</span><span class="p">(</span><span class="n">cube</span><span class="p">[:,:,</span><span class="n">k</span><span class="p">],</span><span class="n">wind</span><span class="p">)</span>
        <span class="n">md</span> <span class="o">=</span> <span class="n">mad</span><span class="p">(</span><span class="nb">map</span><span class="p">)</span>
        <span class="n">supp</span><span class="p">[:,:,</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="nb">map</span><span class="o">&gt;</span><span class="n">thresh</span><span class="o">*</span><span class="n">md</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">supp</span>

<span class="k">def</span> <span class="nf">sum_prod_gauss</span><span class="p">(</span><span class="n">means1</span><span class="p">,</span><span class="n">means2</span><span class="p">,</span><span class="n">sigs1</span><span class="p">,</span><span class="n">sigs2</span><span class="p">):</span> <span class="c1"># Calculates the mean and the product of the sum of products of gaussian distributions</span>
    <span class="n">m</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">means1</span><span class="o">*</span><span class="n">means2</span><span class="p">)</span>
    <span class="n">sig</span> <span class="o">=</span> <span class="n">sqrt</span><span class="p">(</span><span class="nb">sum</span><span class="p">((</span><span class="n">means2</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">sigs1</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">+</span><span class="p">(</span><span class="n">means1</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">sigs2</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">+</span><span class="p">(</span><span class="n">sigs2</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">sigs1</span><span class="o">**</span><span class="mi">2</span><span class="p">)))</span>
    <span class="k">return</span> <span class="n">m</span><span class="p">,</span><span class="n">sig</span>

<span class="k">def</span> <span class="nf">autocorrel_detection</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">p_val</span><span class="o">=</span><span class="mf">0.99</span><span class="p">,</span><span class="n">k</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span><span class="n">sig</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">detect_rad</span><span class="o">=</span><span class="mi">3</span><span class="p">):</span>

    <span class="k">if</span> <span class="n">sig</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">sig</span> <span class="o">=</span> <span class="n">im_gauss_nois_est_cube</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">shap</span> <span class="o">=</span> <span class="n">array</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">%</span><span class="mi">2</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
        <span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-=</span><span class="mi">1</span>
    <span class="k">if</span> <span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">%</span><span class="mi">2</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
        <span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-=</span><span class="mi">1</span>
    <span class="n">autocorr</span> <span class="o">=</span> <span class="n">scipy_fft</span><span class="o">.</span><span class="n">ifft2</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">scipy_fft</span><span class="o">.</span><span class="n">fft2</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="mi">0</span><span class="p">:</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">]]))</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">interv_1</span> <span class="o">=</span> <span class="n">scistats</span><span class="o">.</span><span class="n">chi2</span><span class="o">.</span><span class="n">interval</span><span class="p">(</span><span class="n">p_val</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">scale</span><span class="o">=</span><span class="n">sig</span><span class="p">)</span>
    <span class="n">means</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
    <span class="n">sigs</span> <span class="o">=</span> <span class="n">ones</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span><span class="o">*</span><span class="n">sig</span>
    <span class="n">mcross</span><span class="p">,</span><span class="n">sig_cross</span> <span class="o">=</span> <span class="n">sum_prod_gauss</span><span class="p">(</span><span class="n">means</span><span class="p">,</span><span class="n">means</span><span class="p">,</span><span class="n">sigs</span><span class="p">,</span><span class="n">sigs</span><span class="p">)</span>
    <span class="n">interv_2</span> <span class="o">=</span> <span class="p">[</span><span class="n">mcross</span><span class="o">-</span><span class="n">k</span><span class="o">*</span><span class="n">sig_cross</span><span class="p">,</span><span class="n">mcross</span><span class="o">+</span><span class="n">k</span><span class="o">*</span><span class="n">sig_cross</span><span class="p">]</span>
    <span class="n">ic</span> <span class="o">=</span> <span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span>
    <span class="n">jc</span> <span class="o">=</span> <span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span>
    <span class="n">detect</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">if</span> <span class="n">autocorr</span><span class="p">[</span><span class="n">ic</span><span class="p">,</span><span class="n">jc</span><span class="p">]</span><span class="o">&gt;</span><span class="n">interv_1</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">or</span> <span class="n">autocorr</span><span class="p">[</span><span class="n">ic</span><span class="p">,</span><span class="n">jc</span><span class="p">]</span><span class="o">&lt;</span><span class="n">interv_1</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
        <span class="n">detect</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">if</span> <span class="n">detect</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
        <span class="n">nb_tests</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">while</span> <span class="n">detect</span> <span class="ow">is</span> <span class="kc">False</span> <span class="ow">and</span> <span class="n">nb_tests</span> <span class="o">&lt;</span> <span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">detect_rad</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">:</span>
            <span class="n">i1</span> <span class="o">=</span> <span class="n">nb_tests</span><span class="o">%</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">detect_rad</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">-</span><span class="n">rad</span>
            <span class="n">i2</span> <span class="o">=</span> <span class="n">nb_tests</span><span class="o">/</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">detect_rad</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">-</span><span class="n">rad</span>
            <span class="k">if</span> <span class="n">i1</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="n">i2</span><span class="o">**</span><span class="mi">2</span> <span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">autocorr</span><span class="p">[</span><span class="n">i1</span><span class="o">+</span><span class="n">ic</span><span class="p">,</span><span class="n">i2</span><span class="o">+</span><span class="n">jc</span><span class="p">]</span><span class="o">&gt;</span><span class="n">interv_2</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">or</span> <span class="n">autocorr</span><span class="p">[</span><span class="n">i1</span><span class="o">+</span><span class="n">ic</span><span class="p">,</span><span class="n">i2</span><span class="o">+</span><span class="n">jc</span><span class="p">]</span><span class="o">&lt;</span><span class="n">interv_2</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                    <span class="n">detect</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">nb_ests</span><span class="o">+=</span><span class="mi">1</span>
    <span class="k">return</span> <span class="n">detect</span><span class="p">,</span><span class="n">autocorr</span>

<span class="k">def</span> <span class="nf">autocorrel_detection_stack</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">p_val</span><span class="o">=</span><span class="mf">0.99</span><span class="p">,</span><span class="n">k</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span><span class="n">sig</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">detect_rad</span><span class="o">=</span><span class="mi">4</span><span class="p">):</span>
    <span class="n">shap</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">nb_im</span> <span class="o">=</span> <span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">detect_flag</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_im</span><span class="p">):</span>
        <span class="n">detect</span><span class="p">,</span><span class="n">autocorr</span> <span class="o">=</span> <span class="n">autocorrel_detection</span><span class="p">(</span><span class="n">x</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">],</span><span class="n">p_val</span><span class="o">=</span><span class="n">p_val</span><span class="p">,</span><span class="n">k</span><span class="o">=</span><span class="n">k</span><span class="p">,</span><span class="n">sig</span><span class="o">=</span><span class="n">sig</span><span class="p">,</span><span class="n">detect_rad</span><span class="o">=</span><span class="n">detect_rad</span><span class="p">)</span>
        <span class="n">detect_flag</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">detect</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">detect</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">count</span><span class="o">+=</span><span class="mi">1</span>

    <span class="n">score</span> <span class="o">=</span> <span class="mi">100</span><span class="o">*</span><span class="n">double</span><span class="p">(</span><span class="n">count</span><span class="p">)</span><span class="o">/</span><span class="n">nb_im</span>
    <span class="k">return</span> <span class="n">detect_flag</span><span class="p">,</span><span class="n">score</span>

<span class="k">def</span> <span class="nf">mp_struct_res_support_slice</span><span class="p">(</span><span class="n">cube</span><span class="p">,</span><span class="n">nb</span><span class="p">,</span><span class="n">ne</span><span class="p">,</span><span class="n">q</span><span class="p">,</span><span class="n">thresh</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span><span class="n">wind</span><span class="o">=</span><span class="mi">10</span><span class="p">):</span>
    <span class="nb">slice</span> <span class="o">=</span> <span class="n">cube</span><span class="p">[:,:,</span><span class="n">nb</span><span class="p">:</span><span class="n">ne</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">supp_k</span> <span class="o">=</span> <span class="n">struct_res_support</span><span class="p">(</span><span class="nb">slice</span><span class="p">,</span><span class="n">thresh</span><span class="o">=</span><span class="n">thresh</span><span class="p">,</span><span class="n">wind</span><span class="o">=</span><span class="n">wind</span><span class="p">)</span>
    <span class="n">q</span><span class="o">.</span><span class="n">put</span><span class="p">([</span><span class="n">supp_k</span><span class="p">,</span><span class="n">nb</span><span class="p">,</span><span class="n">ne</span><span class="p">])</span>

<span class="k">def</span> <span class="nf">mp_struct_res_support</span><span class="p">(</span><span class="n">cube</span><span class="p">,</span><span class="n">nb_proc</span><span class="p">,</span><span class="n">thresh</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span><span class="n">wind</span><span class="o">=</span><span class="mi">10</span><span class="p">):</span>
    <span class="n">supp</span> <span class="o">=</span> <span class="n">cube</span><span class="o">*</span><span class="mi">0</span>
    <span class="n">nb_proc</span> <span class="o">=</span> <span class="mi">5</span>
    <span class="n">supp</span> <span class="o">=</span> <span class="mi">0</span><span class="o">*</span><span class="n">cube</span>
    <span class="n">nb_gal</span> <span class="o">=</span> <span class="n">cube</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="nb">slice</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">nb_gal</span><span class="o">/</span><span class="n">nb_proc</span><span class="p">)</span>
    <span class="c1">#if __name__ == &#39;__main__&#39;:</span>
    <span class="n">q</span> <span class="o">=</span> <span class="n">Queue</span><span class="p">()</span>
    <span class="n">jobs</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_proc</span><span class="p">):</span>
        <span class="n">ib</span> <span class="o">=</span> <span class="n">i</span><span class="o">*</span><span class="nb">slice</span>
        <span class="n">ie</span> <span class="o">=</span> <span class="n">ib</span><span class="o">+</span><span class="nb">slice</span><span class="o">-</span><span class="mi">1</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">Process</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">mp_struct_res_support_slice</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">cube</span><span class="p">,</span><span class="n">ib</span><span class="p">,</span><span class="n">ie</span><span class="p">,</span><span class="n">q</span><span class="p">,</span><span class="n">thresh</span><span class="p">,</span><span class="n">wind</span><span class="p">))</span>
        <span class="n">p</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
        <span class="n">jobs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_proc</span><span class="p">):</span>
        <span class="n">a</span> <span class="o">=</span> <span class="n">q</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
        <span class="n">supp</span><span class="p">[:,:,</span><span class="n">a</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span><span class="n">a</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">supp</span>


<span class="k">def</span> <span class="nf">wien_filt</span><span class="p">(</span><span class="n">im</span><span class="p">):</span>
    <span class="n">snr_map</span> <span class="o">=</span> <span class="n">snr_map_gauss</span><span class="p">(</span><span class="n">im</span><span class="p">)</span>
    <span class="n">w</span> <span class="o">=</span> <span class="n">snr_map</span><span class="o">/</span><span class="p">(</span><span class="n">snr_map</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
    <span class="nb">print</span> <span class="n">w</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
    <span class="nb">print</span> <span class="n">w</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
    <span class="n">imdft</span> <span class="o">=</span> <span class="n">scipy_fft</span><span class="o">.</span><span class="n">fft2</span><span class="p">(</span><span class="n">im</span><span class="p">)</span>
    <span class="n">imfilt</span> <span class="o">=</span> <span class="n">scipy_fft</span><span class="o">.</span><span class="n">ifft2</span><span class="p">(</span><span class="n">imdft</span><span class="o">*</span><span class="n">w</span><span class="p">)</span>
    <span class="n">res_imag</span> <span class="o">=</span> <span class="n">imag</span><span class="p">(</span><span class="n">imfilt</span><span class="p">)</span>
    <span class="n">leak</span> <span class="o">=</span> <span class="n">sqrt</span><span class="p">((</span><span class="n">real</span><span class="p">(</span><span class="n">imfilt</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span><span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="p">(</span><span class="n">res_imag</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">real</span><span class="p">(</span><span class="n">imfilt</span><span class="p">),</span><span class="n">leak</span>


<span class="k">def</span> <span class="nf">snr_map_gauss</span><span class="p">(</span><span class="n">im</span><span class="p">):</span>
    <span class="n">shap</span> <span class="o">=</span> <span class="n">im</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">onesmat</span> <span class="o">=</span> <span class="n">ones</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
    <span class="n">sig</span> <span class="o">=</span> <span class="mf">1.4826</span><span class="o">*</span><span class="n">mad</span><span class="p">(</span><span class="n">im</span><span class="p">)</span>
    <span class="n">imdft</span> <span class="o">=</span> <span class="n">scipy_fft</span><span class="o">.</span><span class="n">fft2</span><span class="p">(</span><span class="n">im</span><span class="p">)</span>
    <span class="n">snr_map</span> <span class="o">=</span> <span class="n">sqrt</span><span class="p">((</span><span class="nb">abs</span><span class="p">(</span><span class="n">imdft</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="n">sig</span><span class="o">**</span><span class="mi">2</span><span class="o">-</span><span class="n">onesmat</span><span class="p">)</span><span class="o">*</span><span class="n">double</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">imdft</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="n">sig</span><span class="o">**</span><span class="mi">2</span><span class="o">&gt;=</span><span class="n">onesmat</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">snr_map</span>

<span class="k">def</span> <span class="nf">shap_mat_learning_data_pipe</span><span class="p">(</span><span class="n">gal</span><span class="p">,</span><span class="n">nb_clusters</span><span class="p">,</span><span class="n">stamp_rad</span><span class="p">,</span><span class="n">filename</span><span class="p">):</span>
    <span class="c1"># Denoising</span>
    <span class="n">cube_den</span><span class="p">,</span><span class="n">Om</span><span class="p">,</span><span class="n">res</span> <span class="o">=</span> <span class="n">optim_utils</span><span class="o">.</span><span class="n">spca_interf</span><span class="p">(</span><span class="n">gal</span><span class="p">)</span>
    <span class="c1"># Clustering</span>
    <span class="n">ret</span><span class="p">,</span><span class="n">label_ind</span><span class="p">,</span><span class="n">center</span>  <span class="o">=</span> <span class="n">gal_kmeans</span><span class="p">(</span><span class="n">cube_den</span><span class="p">,</span><span class="n">nb_clusters</span><span class="p">)</span>
    <span class="c1"># Savings and outputs</span>
    <span class="n">gal_clusters</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
    <span class="n">shap_clusters</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
    <span class="n">k</span><span class="o">=</span><span class="mi">0</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_clusters</span><span class="p">):</span>
        <span class="n">cube_k</span><span class="p">,</span><span class="n">theta</span> <span class="o">=</span> <span class="n">mp_rand_rot</span><span class="p">(</span><span class="n">cube_den</span><span class="p">[:,:,</span><span class="n">label_ind</span><span class="p">[</span><span class="n">k</span><span class="p">]])</span>
        <span class="n">gal_clusters</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cube_k</span><span class="p">)</span>
        <span class="n">fits</span><span class="o">.</span><span class="n">writeto</span><span class="p">(</span><span class="s1">&#39;../data/&#39;</span><span class="o">+</span><span class="n">filename</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">k</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;gal.fits&#39;</span><span class="p">,</span><span class="n">cube_to_mat</span><span class="p">(</span><span class="n">cube_k</span><span class="p">))</span>
        <span class="n">matk</span> <span class="o">=</span> <span class="n">great3_util</span><span class="o">.</span><span class="n">data_mat_shapes</span><span class="p">(</span><span class="n">cube_k</span><span class="p">,</span><span class="n">stamp_rad</span><span class="p">)</span>
        <span class="n">shap_clusters</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">matk</span><span class="p">)</span>
        <span class="n">fits</span><span class="o">.</span><span class="n">writeto</span><span class="p">(</span><span class="s1">&#39;../data/&#39;</span><span class="o">+</span><span class="n">filename</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">k</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;shap_mat.fits&#39;</span><span class="p">,</span><span class="n">matk</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">gal_clusters</span><span class="p">,</span><span class="n">shap_clusters</span>


<span class="k">def</span> <span class="nf">wvl_norm</span><span class="p">(</span><span class="n">siz</span><span class="p">,</span><span class="n">opt</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;-t2&#39;</span><span class="p">,</span><span class="s1">&#39;-n1&#39;</span><span class="p">]):</span>
    <span class="n">dirac</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">(</span><span class="n">siz</span><span class="p">)</span>
    <span class="n">dirac</span><span class="p">[(</span><span class="n">siz</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">,(</span><span class="n">siz</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">]</span><span class="o">=</span><span class="mi">1</span>
    <span class="n">Result</span><span class="p">,</span><span class="n">mr_file</span> <span class="o">=</span> <span class="n">isap</span><span class="o">.</span><span class="n">mr_trans</span><span class="p">(</span><span class="n">dirac</span><span class="p">,</span><span class="n">opt</span><span class="o">=</span><span class="n">opt</span><span class="p">)</span>
    <span class="n">shap</span> <span class="o">=</span> <span class="n">Result</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">norm_vect</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">],))</span>
    <span class="n">k</span><span class="o">=</span><span class="mi">0</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
        <span class="n">norm_vect</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">sqrt</span><span class="p">((</span><span class="n">Result</span><span class="p">[:,:,</span><span class="n">k</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span>
    <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">mr_file</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">Result</span><span class="p">,</span><span class="n">norm_vect</span>

<span class="k">def</span> <span class="nf">correlated_noise_est</span><span class="p">(</span><span class="n">u</span><span class="p">,</span><span class="n">nb_iter</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span><span class="n">k</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span><span class="n">tol</span><span class="o">=</span><span class="mf">1.</span><span class="p">):</span>

    <span class="n">sig</span> <span class="o">=</span> <span class="mf">1.4826</span><span class="o">*</span><span class="n">mad</span><span class="p">(</span><span class="n">u</span><span class="p">)</span>
    <span class="n">i</span><span class="o">=</span><span class="mi">0</span>
    <span class="n">var</span> <span class="o">=</span> <span class="mi">100</span>
    <span class="n">ones_vec</span> <span class="o">=</span> <span class="n">ones</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
    <span class="k">while</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">nb_iter</span> <span class="ow">and</span> <span class="n">var</span><span class="o">&gt;</span><span class="mi">100</span><span class="o">*</span><span class="n">tol</span><span class="p">:</span>
        <span class="n">sig_old</span> <span class="o">=</span> <span class="n">sig</span>
        <span class="n">sig</span> <span class="o">=</span> <span class="mf">1.4826</span><span class="o">*</span><span class="n">mad</span><span class="p">(</span><span class="n">u</span><span class="o">-</span><span class="n">thresholding</span><span class="p">(</span><span class="n">u</span><span class="p">,</span><span class="n">sig</span><span class="o">*</span><span class="n">ones_vec</span><span class="p">,</span><span class="n">thresh_type</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
        <span class="n">var</span> <span class="o">=</span> <span class="mi">100</span><span class="o">*</span><span class="nb">abs</span><span class="p">(</span><span class="n">sig</span><span class="o">-</span><span class="n">sig_old</span><span class="p">)</span><span class="o">/</span><span class="n">sig_old</span>
        <span class="n">i</span><span class="o">+=</span><span class="mi">1</span>

    <span class="k">return</span> <span class="n">sig</span>


<div class="viewcode-block" id="im_gauss_nois_est"><a class="viewcode-back" href="../utils.html#utils.im_gauss_nois_est">[docs]</a><span class="k">def</span> <span class="nf">im_gauss_nois_est</span><span class="p">(</span><span class="n">im</span><span class="p">,</span><span class="n">opt</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;-t2&#39;</span><span class="p">,</span><span class="s1">&#39;-n2&#39;</span><span class="p">],</span><span class="n">filters</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Compute sigma mad for... What appears to be the first wavelet scale only?</span>
<span class="sd">    </span>
<span class="sd">    Calls:</span>
<span class="sd">    </span>
<span class="sd">    * isap.mr_trans_2</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">isap</span> <span class="k">import</span> <span class="n">mr_trans_2</span>
    <span class="n">Result</span><span class="p">,</span><span class="n">filters</span> <span class="o">=</span> <span class="n">mr_trans_2</span><span class="p">(</span><span class="n">im</span><span class="p">,</span><span class="n">filters</span><span class="o">=</span><span class="n">filters</span><span class="p">,</span><span class="n">opt</span><span class="o">=</span><span class="n">opt</span><span class="p">)</span>
    <span class="n">siz</span> <span class="o">=</span> <span class="n">im</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">norm_wav</span> <span class="o">=</span> <span class="n">norm</span><span class="p">(</span><span class="n">filters</span><span class="p">[:,:,</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">sigma</span> <span class="o">=</span> <span class="mf">1.4826</span><span class="o">*</span><span class="n">mad</span><span class="p">(</span><span class="n">Result</span><span class="p">[:,:,</span><span class="mi">0</span><span class="p">])</span><span class="o">/</span><span class="n">norm_wav</span>

    <span class="k">return</span> <span class="n">sigma</span><span class="p">,</span><span class="n">filters</span></div>

<div class="viewcode-block" id="im_gauss_nois_est_cube"><a class="viewcode-back" href="../utils.html#utils.im_gauss_nois_est_cube">[docs]</a><span class="k">def</span> <span class="nf">im_gauss_nois_est_cube</span><span class="p">(</span><span class="n">cube</span><span class="p">,</span><span class="n">opt</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">filters</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">return_map</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Estimate sigma mad for a set of images.</span>
<span class="sd">    </span>
<span class="sd">    #TODO: Note there is clearly something wrong with ``return_map`` since it fills in a ``map`` but </span>
<span class="sd">    does not return it (just the boolean saying it was filled).</span>
<span class="sd">    </span>
<span class="sd">    Calls:</span>
<span class="sd">    </span>
<span class="sd">    * :func:`utils.im_gauss_nois_est`</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">shap</span> <span class="o">=</span> <span class="n">cube</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">sig</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">],))</span>
    <span class="nb">map</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">return_map</span><span class="p">:</span>
        <span class="nb">map</span> <span class="o">=</span><span class="n">ones</span><span class="p">(</span><span class="n">shap</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
        <span class="n">sig_i</span><span class="p">,</span><span class="n">filters</span> <span class="o">=</span> <span class="n">im_gauss_nois_est</span><span class="p">(</span><span class="n">cube</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">],</span><span class="n">opt</span><span class="o">=</span><span class="n">opt</span><span class="p">,</span><span class="n">filters</span><span class="o">=</span><span class="n">filters</span><span class="p">)</span>
        <span class="n">sig</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">sig_i</span>
        <span class="k">if</span> <span class="n">return_map</span><span class="p">:</span>
            <span class="nb">map</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">]</span> <span class="o">*=</span> <span class="n">sig</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">return_map</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">sig</span><span class="p">,</span><span class="n">filters</span><span class="p">,</span><span class="n">return_map</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">sig</span><span class="p">,</span><span class="n">filters</span></div>

<span class="k">def</span> <span class="nf">im_thresh_map</span><span class="p">(</span><span class="n">im</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="n">opt</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="n">sig</span><span class="p">,</span><span class="n">filters</span> <span class="o">=</span> <span class="n">im_gauss_nois_est</span><span class="p">(</span><span class="n">im</span><span class="p">,</span><span class="n">opt</span><span class="p">)</span>
    <span class="n">siz</span> <span class="o">=</span> <span class="n">im</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">Result</span><span class="p">,</span><span class="n">norm_vect</span> <span class="o">=</span> <span class="n">wvl_norm</span><span class="p">(</span><span class="n">siz</span><span class="p">,</span><span class="n">opt</span><span class="o">=</span><span class="n">opt</span><span class="p">)</span>
    <span class="n">shap</span> <span class="o">=</span> <span class="n">Result</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">thresh_map</span> <span class="o">=</span> <span class="n">ones</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>
    <span class="n">i</span><span class="o">=</span><span class="mi">0</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
        <span class="n">thresh_map</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">thresh_map</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">]</span><span class="o">*</span><span class="n">k</span><span class="o">*</span><span class="n">sig</span><span class="o">*</span><span class="n">norm_vect</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">thresh_map</span>

<span class="k">def</span> <span class="nf">res_sig_map</span><span class="p">(</span><span class="n">res</span><span class="p">,</span><span class="n">opt</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>

    <span class="n">wvl_res</span><span class="p">,</span><span class="n">mr_file</span> <span class="o">=</span> <span class="n">isap</span><span class="o">.</span><span class="n">mr_trans</span><span class="p">(</span><span class="n">res</span><span class="p">,</span><span class="n">opt</span><span class="o">=</span><span class="n">opt</span><span class="p">)</span>
    <span class="n">shap</span> <span class="o">=</span> <span class="n">wvl_res</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">sig_map</span> <span class="o">=</span> <span class="n">ones</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>
    <span class="n">k</span><span class="o">=</span><span class="mi">0</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
        <span class="n">sigk</span> <span class="o">=</span> <span class="mf">1.4826</span><span class="o">*</span><span class="n">mad</span><span class="p">(</span><span class="n">wvl_res</span><span class="p">[:,:,</span><span class="n">k</span><span class="p">])</span>
        <span class="n">sig_map</span><span class="p">[:,:,</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">sig_map</span><span class="p">[:,:,</span><span class="n">k</span><span class="p">]</span><span class="o">*</span><span class="n">sigk</span>
    <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">mr_file</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">sig_map</span>

<span class="k">def</span> <span class="nf">sig_map</span><span class="p">(</span><span class="n">res</span><span class="p">):</span>
    <span class="n">shap</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">shape</span>
    <span class="nb">map</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">shap</span><span class="p">)</span><span class="o">==</span><span class="mi">2</span><span class="p">:</span>
        <span class="nb">map</span> <span class="o">=</span> <span class="mf">1.4826</span><span class="o">*</span><span class="n">ones</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span><span class="o">*</span><span class="n">mad</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>
    <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">shap</span><span class="p">)</span><span class="o">==</span><span class="mi">3</span><span class="p">:</span>
        <span class="nb">map</span> <span class="o">=</span> <span class="n">ones</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
            <span class="nb">map</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">]</span> <span class="o">*=</span> <span class="n">im_gauss_nois_est</span><span class="p">(</span><span class="n">res</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">])</span>
    <span class="k">return</span> <span class="nb">map</span>

<span class="k">def</span> <span class="nf">acc_sig_map</span><span class="p">(</span><span class="n">shap_im</span><span class="p">,</span><span class="n">ker_stack</span><span class="p">,</span><span class="n">sig_est</span><span class="p">,</span><span class="n">flux_est</span><span class="p">,</span><span class="n">flux_ref</span><span class="p">,</span><span class="n">upfact</span><span class="p">,</span><span class="n">w</span><span class="p">,</span><span class="n">sig_data</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="n">shap</span> <span class="o">=</span> <span class="n">ker_stack</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">nb_im</span> <span class="o">=</span> <span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">sig_data</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">sig_data</span> <span class="o">=</span> <span class="n">ones</span><span class="p">((</span><span class="n">nb_im</span><span class="p">,))</span>
    <span class="n">var_stack</span> <span class="o">=</span> <span class="n">ones</span><span class="p">((</span><span class="n">shap_im</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">shap_im</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">nb_im</span><span class="p">))</span>
    <span class="n">map2</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">shap_im</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">upfact</span><span class="p">,</span><span class="n">shap_im</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">upfact</span><span class="p">))</span>
    <span class="n">ker_stack_in</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">ker_stack</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span>
    <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
        <span class="n">var_stack</span><span class="p">[:,:,</span><span class="n">l</span><span class="p">]</span><span class="o">*=</span><span class="n">sig_data</span><span class="p">[</span><span class="n">l</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span>
        <span class="c1">#print &quot;Noise estimation parameters: sigma data&quot;,sig_data[l]**2,&quot; sigma est: &quot;,sig_est[l]**2,&quot; shift ker norm &quot;,sum(ker_stack_in[:,:,l]**2)</span>
        <span class="n">map2</span> <span class="o">+=</span> <span class="p">((</span><span class="n">w</span><span class="p">[</span><span class="n">l</span><span class="p">]</span><span class="o">*</span><span class="n">flux_est</span><span class="p">[</span><span class="n">l</span><span class="p">]</span><span class="o">/</span><span class="p">(</span><span class="n">sig_est</span><span class="p">[</span><span class="n">l</span><span class="p">]</span><span class="o">*</span><span class="n">flux_ref</span><span class="p">))</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">scisig</span><span class="o">.</span><span class="n">convolve</span><span class="p">(</span><span class="n">transpose_decim</span><span class="p">(</span><span class="n">var_stack</span><span class="p">[:,:,</span><span class="n">l</span><span class="p">],</span><span class="n">upfact</span><span class="p">),</span><span class="n">ker_stack_in</span><span class="p">[:,:,</span><span class="n">l</span><span class="p">],</span><span class="n">mode</span><span class="o">=</span><span class="s1">&#39;same&#39;</span><span class="p">)</span>
    <span class="nb">map</span> <span class="o">=</span>  <span class="n">sqrt</span><span class="p">(</span><span class="n">map2</span><span class="p">)</span>
    <span class="k">return</span> <span class="nb">map</span>

<span class="k">def</span> <span class="nf">acc_sig_maps</span><span class="p">(</span><span class="n">shap_im</span><span class="p">,</span><span class="n">ker_stack</span><span class="p">,</span><span class="n">sig_est</span><span class="p">,</span><span class="n">flux_est</span><span class="p">,</span><span class="n">flux_ref</span><span class="p">,</span><span class="n">upfact</span><span class="p">,</span><span class="n">w</span><span class="p">,</span><span class="n">sig_data</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="n">shap</span> <span class="o">=</span> <span class="n">w</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">map_out</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">shap_im</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">upfact</span><span class="p">,</span><span class="n">shap_im</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">upfact</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
        <span class="n">map_out</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">acc_sig_map</span><span class="p">(</span><span class="n">shap_im</span><span class="p">,</span><span class="n">ker_stack</span><span class="p">,</span><span class="n">sig_est</span><span class="p">,</span><span class="n">flux_est</span><span class="p">,</span><span class="n">flux_ref</span><span class="p">,</span><span class="n">upfact</span><span class="p">,</span><span class="n">w</span><span class="p">[</span><span class="n">i</span><span class="p">,:],</span><span class="n">sig_data</span><span class="o">=</span><span class="n">sig_data</span><span class="p">)</span>
        <span class="c1">#print &quot;Noise estimation, weights norm: &quot;,sum(w[i,:]**2)</span>

    <span class="k">return</span> <span class="n">map_out</span>


<span class="k">def</span> <span class="nf">stack_convolve</span><span class="p">(</span><span class="n">cube_im</span><span class="p">,</span><span class="n">cube_psf</span><span class="p">):</span>
    <span class="n">shap</span> <span class="o">=</span> <span class="n">cube_im</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">cube_out</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">cube_im</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
        <span class="n">cube_out</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">scisig</span><span class="o">.</span><span class="n">convolve</span><span class="p">(</span><span class="n">cube_im</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">],</span><span class="n">cube_psf</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">],</span><span class="n">mode</span><span class="o">=</span><span class="s1">&#39;same&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">cube_out</span>

<span class="k">def</span> <span class="nf">stack_fft_deconv</span><span class="p">(</span><span class="n">cube_im</span><span class="p">,</span><span class="n">cube_psf</span><span class="p">,</span><span class="n">nb_iter</span><span class="o">=</span><span class="mi">100</span><span class="p">):</span>
    <span class="n">shap</span> <span class="o">=</span> <span class="n">cube_im</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">cube_out</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">cube_im</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
        <span class="c1">#cube_out[:,:,i] =  scipy_fft.ifft2(scipy_fft.fft2(cube_im[:,:,i])/scipy_fft.fft2(cube_psf[:,:,i]))</span>
        <span class="nb">print</span> <span class="s2">&quot;=========&quot;</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="s2">&quot;/&quot;</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="s2">&quot;============&quot;</span>
        <span class="n">cube_out</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">optim_utils</span><span class="o">.</span><span class="n">deconvol</span><span class="p">(</span><span class="n">cube_im</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">],</span><span class="n">cube_psf</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">],</span><span class="n">mu</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">nb_iter</span><span class="o">=</span><span class="n">nb_iter</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">cube_out</span>

<span class="k">def</span> <span class="nf">stack_fft_deconv_m</span><span class="p">(</span><span class="n">cube_im</span><span class="p">,</span><span class="n">cube_psf_m</span><span class="p">):</span>
    <span class="n">shap</span> <span class="o">=</span> <span class="n">cube_psf_m</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">shap2</span> <span class="o">=</span> <span class="n">cube_im</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">cube_out</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">shap2</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">shap2</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">shap2</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">shap</span><span class="p">[</span><span class="mi">3</span><span class="p">]))</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">3</span><span class="p">]):</span>
        <span class="nb">print</span> <span class="s2">&quot;=========&quot;</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="s2">&quot;/&quot;</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span><span class="s2">&quot;============&quot;</span>
        <span class="n">cube_out</span><span class="p">[:,:,:,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">stack_fft_deconv</span><span class="p">(</span><span class="n">cube_im</span><span class="p">,</span><span class="n">cube_psf_m</span><span class="p">[:,:,:,</span><span class="n">i</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">cube_out</span>

<span class="k">def</span> <span class="nf">min_pt</span><span class="p">(</span><span class="n">im1</span><span class="p">,</span><span class="n">im2</span><span class="p">):</span>
    <span class="n">im_min</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">im1</span><span class="p">)</span>
    <span class="n">shap</span> <span class="o">=</span> <span class="n">im1</span><span class="o">.</span><span class="n">shape</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
            <span class="n">im_min</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">im1</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">],</span><span class="n">im2</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">im_min</span>


<span class="k">def</span> <span class="nf">max_pt</span><span class="p">(</span><span class="n">im1</span><span class="p">,</span><span class="n">im2</span><span class="p">):</span>
    <span class="n">im_max</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">im1</span><span class="p">)</span>
    <span class="n">shap</span> <span class="o">=</span> <span class="n">im1</span><span class="o">.</span><span class="n">shape</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
            <span class="n">im_max</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">im1</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">],</span><span class="n">im2</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">im_max</span>


<span class="k">def</span> <span class="nf">hyp_point</span><span class="p">(</span><span class="n">u</span><span class="p">,</span><span class="n">b</span><span class="p">):</span> <span class="c1"># Returns a point of the hyperplane defined by &lt;u,x&gt;=b; this routine assumes that u is a 2D array</span>
    <span class="n">ind1</span><span class="p">,</span><span class="n">ind2</span> <span class="o">=</span> <span class="n">where</span><span class="p">(</span><span class="n">u</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">n</span> <span class="o">=</span> <span class="n">size</span><span class="p">(</span><span class="n">ind1</span><span class="p">)</span>
    <span class="n">shap</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">(</span><span class="n">shap</span><span class="p">)</span>
    <span class="n">x</span><span class="p">[</span><span class="n">ind1</span><span class="p">,</span><span class="n">ind2</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u</span><span class="p">[</span><span class="n">ind1</span><span class="p">,</span><span class="n">ind2</span><span class="p">])</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="o">*</span><span class="n">b</span><span class="o">/</span><span class="n">n</span>
    <span class="k">return</span> <span class="n">x</span>

<span class="k">def</span> <span class="nf">hyp_2_point</span><span class="p">(</span><span class="n">u1</span><span class="p">,</span><span class="n">c1</span><span class="p">,</span><span class="n">u2</span><span class="p">,</span><span class="n">c2</span><span class="p">):</span> <span class="c1"># Returns a point in the intersection (supposed to exist) of the hyperplanes &lt;u1,x&gt;=c1, &lt;u2,x&gt;=c2</span>
    <span class="n">n1</span> <span class="o">=</span> <span class="p">(</span><span class="n">u2</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    <span class="n">a1</span> <span class="o">=</span> <span class="p">(</span><span class="n">u1</span><span class="o">*</span><span class="n">u2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">/</span><span class="n">n1</span>
    <span class="n">v0</span> <span class="o">=</span> <span class="n">u1</span> <span class="o">-</span> <span class="n">a1</span><span class="o">*</span><span class="n">u2</span>
    <span class="n">b1</span> <span class="o">=</span> <span class="n">sqrt</span><span class="p">((</span><span class="n">v0</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span>
    <span class="n">v</span> <span class="o">=</span> <span class="n">v0</span><span class="o">/</span><span class="n">b1</span>
    <span class="n">a</span> <span class="o">=</span> <span class="n">c2</span><span class="o">/</span><span class="n">n1</span>
    <span class="n">b</span> <span class="o">=</span> <span class="p">(</span><span class="n">c1</span><span class="o">-</span><span class="n">a1</span><span class="o">*</span><span class="n">c2</span><span class="p">)</span><span class="o">/</span><span class="n">b1</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">a</span><span class="o">*</span><span class="n">u2</span><span class="o">+</span><span class="n">b</span><span class="o">*</span><span class="n">v</span>
    <span class="k">return</span> <span class="n">x</span>

<span class="k">def</span> <span class="nf">proj_hyp</span><span class="p">(</span><span class="n">u</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">y</span><span class="p">):</span> <span class="c1"># Projects the point y on the hyperplane defined by &lt;u,x&gt;=b</span>
    <span class="n">n</span> <span class="o">=</span> <span class="n">u</span><span class="o">/</span><span class="n">sqrt</span><span class="p">((</span><span class="n">u</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span>
    <span class="n">o</span> <span class="o">=</span> <span class="n">hyp_point</span><span class="p">(</span><span class="n">u</span><span class="p">,</span><span class="n">b</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">y</span> <span class="o">-</span> <span class="p">((</span><span class="n">y</span><span class="o">-</span><span class="n">o</span><span class="p">)</span><span class="o">*</span><span class="n">n</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">*</span><span class="n">n</span>
    <span class="k">return</span> <span class="n">x</span>

<span class="k">def</span> <span class="nf">proj_2_hyp</span><span class="p">(</span><span class="n">u1</span><span class="p">,</span><span class="n">b1</span><span class="p">,</span><span class="n">u2</span><span class="p">,</span><span class="n">b2</span><span class="p">,</span><span class="n">y</span><span class="p">):</span> <span class="c1"># Projects y on the intersection (supposed to exist) of the hyperplanes &lt;u1,x&gt;=b1, &lt;u2,x&gt;=b2</span>
    <span class="n">o</span> <span class="o">=</span> <span class="n">hyp_2_point</span><span class="p">(</span><span class="n">u1</span><span class="p">,</span><span class="n">b1</span><span class="p">,</span><span class="n">u2</span><span class="p">,</span><span class="n">b2</span><span class="p">)</span>
    <span class="n">shap</span> <span class="o">=</span> <span class="n">u1</span><span class="o">.</span><span class="n">shape</span>
    <span class="nb">dict</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="mi">2</span><span class="p">))</span>
    <span class="nb">dict</span><span class="p">[:,:,</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="n">u1</span>
    <span class="nb">dict</span><span class="p">[:,:,</span><span class="mi">1</span><span class="p">]</span><span class="o">=</span><span class="n">u2</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">y</span><span class="o">-</span><span class="n">proj_cube</span><span class="p">(</span><span class="n">y</span><span class="o">-</span><span class="n">o</span><span class="p">,</span><span class="nb">dict</span><span class="p">,</span><span class="n">ortho</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">x</span>

<span class="k">def</span> <span class="nf">rand_lin_comb</span><span class="p">(</span><span class="n">u1</span><span class="p">,</span><span class="n">u2</span><span class="p">,</span><span class="n">u3</span><span class="p">,</span><span class="n">nb_vect</span><span class="p">):</span>
    <span class="kn">from</span> <span class="nn">numpy.random</span> <span class="k">import</span> <span class="n">rand</span>
    <span class="n">shap</span> <span class="o">=</span> <span class="n">u1</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">com_stack</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">nb_vect</span><span class="p">))</span>
    <span class="n">coeff</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">nb_vect</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_vect</span><span class="p">):</span>
        <span class="n">a1</span> <span class="o">=</span> <span class="n">rand</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">a2</span> <span class="o">=</span> <span class="n">rand</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">a1</span><span class="p">)</span>
        <span class="n">a3</span> <span class="o">=</span> <span class="mi">1</span><span class="o">-</span><span class="n">a1</span><span class="o">-</span><span class="n">a2</span>
        <span class="n">coeff</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">a1</span>
        <span class="n">coeff</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">a2</span>
        <span class="n">coeff</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">a3</span>
        <span class="n">com_stack</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">a1</span><span class="o">*</span><span class="n">u1</span><span class="o">+</span><span class="n">a2</span><span class="o">*</span><span class="n">u2</span><span class="o">+</span><span class="n">a3</span><span class="o">*</span><span class="n">u3</span>
        <span class="n">com_stack</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">com_stack</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">]</span><span class="o">/</span><span class="n">sqrt</span><span class="p">(((</span><span class="n">com_stack</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span>
    <span class="k">return</span> <span class="n">com_stack</span><span class="p">,</span><span class="n">coeff</span>

<span class="k">def</span> <span class="nf">dir_check</span><span class="p">(</span><span class="n">dir_stack</span><span class="p">,</span><span class="n">ref_ell</span><span class="p">,</span><span class="n">cur_point</span><span class="p">):</span>
    <span class="n">siz</span> <span class="o">=</span> <span class="n">dir_stack</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">ell_steepness</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">siz</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="mi">2</span><span class="p">))</span>
    <span class="n">dir_cand</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">siz</span><span class="p">[</span><span class="mi">2</span><span class="p">],))</span>
    <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">siz</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
        <span class="n">grad1i</span><span class="p">,</span><span class="n">grad2i</span><span class="p">,</span><span class="n">ellti</span> <span class="o">=</span> <span class="n">ellipticity_gradt</span><span class="p">(</span><span class="n">cur_point</span><span class="p">,</span><span class="n">dir_stack</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">],</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">ell_steepness</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">grad1i</span>
        <span class="n">ell_steepness</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">grad2i</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">ell_steepness</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">ref_ell</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">&lt;=</span><span class="mi">0</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">ell_steepness</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">ref_ell</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">&lt;=</span><span class="mi">0</span><span class="p">):</span>
            <span class="n">dir_cand</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">=</span><span class="mi">1</span>
    <span class="k">return</span> <span class="n">dir_cand</span><span class="p">,</span><span class="n">ell_steepness</span>

<div class="viewcode-block" id="polar_coord"><a class="viewcode-back" href="../utils.html#utils.polar_coord">[docs]</a><span class="k">def</span> <span class="nf">polar_coord</span><span class="p">(</span><span class="n">coord</span><span class="p">,</span><span class="n">cent</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Computes polar coordinates for one cartesian position (angles are in radians).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">numpy</span> <span class="k">import</span> <span class="n">sqrt</span><span class="p">,</span><span class="n">arccos</span><span class="p">,</span><span class="nb">abs</span><span class="p">,</span><span class="n">pi</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">sqrt</span><span class="p">((</span><span class="n">coord</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">cent</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="p">(</span><span class="n">coord</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">cent</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">alpha</span><span class="o">=</span><span class="kc">None</span>
    <span class="k">if</span> <span class="n">r</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
        <span class="n">alpha</span><span class="o">=</span><span class="mi">0</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">alpha_ref</span> <span class="o">=</span> <span class="n">arccos</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">coord</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">cent</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">/</span><span class="n">r</span><span class="p">)</span>
        <span class="n">alpha</span> <span class="o">=</span> <span class="n">alpha_ref</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">coord</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">cent</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">coord</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">cent</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">&gt;=</span><span class="mi">0</span><span class="p">):</span>
            <span class="n">alpha</span> <span class="o">=</span> <span class="n">pi</span><span class="o">-</span><span class="n">alpha</span>
        <span class="k">elif</span> <span class="p">(</span><span class="n">coord</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">cent</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">coord</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">cent</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">):</span>
            <span class="n">alpha</span> <span class="o">=</span> <span class="n">pi</span><span class="o">+</span><span class="n">alpha</span>
        <span class="k">elif</span> <span class="p">(</span><span class="n">coord</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">cent</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">&gt;=</span><span class="mi">0</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">coord</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">cent</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">):</span>
            <span class="n">alpha</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">pi</span><span class="o">-</span><span class="n">alpha</span>

    <span class="k">return</span> <span class="n">r</span><span class="p">,</span><span class="n">alpha</span></div>

<div class="viewcode-block" id="polar_coord_cloud"><a class="viewcode-back" href="../utils.html#utils.polar_coord_cloud">[docs]</a><span class="k">def</span> <span class="nf">polar_coord_cloud</span><span class="p">(</span><span class="n">coord</span><span class="p">,</span><span class="n">cent</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Compute polar coordinates for a set of points.</span>
<span class="sd">    </span>
<span class="sd">    Calls:</span>
<span class="sd">    </span>
<span class="sd">    * :func:`utils.polar_coord`</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">numpy</span> <span class="k">import</span> <span class="n">zeros</span>
    <span class="n">shap</span> <span class="o">=</span> <span class="n">coord</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">out</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
        <span class="n">out</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">i</span><span class="p">],</span><span class="n">out</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">polar_coord</span><span class="p">(</span><span class="n">coord</span><span class="p">[:,</span><span class="n">i</span><span class="p">],</span><span class="n">cent</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">out</span></div>

<span class="k">def</span> <span class="nf">polar_to_cart</span><span class="p">(</span><span class="n">coord</span><span class="p">,</span><span class="n">cent</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">coord</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">cos</span><span class="p">(</span><span class="n">coord</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">+</span><span class="n">cent</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">coord</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">sin</span><span class="p">(</span><span class="n">coord</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">+</span><span class="n">cent</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

<span class="k">def</span> <span class="nf">polar_to_cart_cloud</span><span class="p">(</span><span class="n">coord</span><span class="p">,</span><span class="n">cent</span><span class="p">):</span>

    <span class="kn">from</span> <span class="nn">numpy</span> <span class="k">import</span> <span class="n">zeros</span>
    <span class="n">shap</span> <span class="o">=</span> <span class="n">coord</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">out</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
        <span class="n">out</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">i</span><span class="p">],</span><span class="n">out</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">polar_to_cart</span><span class="p">(</span><span class="n">coord</span><span class="p">[:,</span><span class="n">i</span><span class="p">],</span><span class="n">cent</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">out</span>

<span class="k">def</span> <span class="nf">pol_coord_map_check</span><span class="p">(</span><span class="n">siz</span><span class="p">,</span><span class="n">cent</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">cent</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">cent</span> <span class="o">=</span> <span class="p">[</span><span class="n">siz</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span><span class="n">siz</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">map_r</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">siz</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">siz</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
    <span class="n">map_theta</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">siz</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">siz</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
    <span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">siz</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">siz</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
            <span class="n">r</span><span class="p">,</span><span class="n">theta</span> <span class="o">=</span> <span class="n">polar_coord</span><span class="p">([</span><span class="n">j</span><span class="p">,</span><span class="n">i</span><span class="p">],</span><span class="n">cent</span><span class="p">)</span>
            <span class="n">map_r</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">r</span>
            <span class="n">map_theta</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">theta</span>

    <span class="k">return</span> <span class="n">map_r</span><span class="p">,</span><span class="n">map_theta</span>



<span class="k">def</span> <span class="nf">scaling</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">n</span><span class="p">,</span><span class="n">ainit</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">afinal</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span> <span class="c1"># returns y = ((2x-1)^(1/n)+1)/2; n should be odd</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">afinal</span><span class="o">-</span><span class="n">ainit</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">sign</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">x</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="nb">abs</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">x</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">**</span><span class="p">(</span><span class="mf">1.0</span><span class="o">/</span><span class="n">n</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span> <span class="o">+</span> <span class="n">ainit</span>


<span class="k">def</span> <span class="nf">scaling_2</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">n</span><span class="p">,</span><span class="n">ainit</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">afinal</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span> <span class="c1"># returns y = (afinal-ainit)*(x)^n+ainit</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">afinal</span><span class="o">-</span><span class="n">ainit</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">**</span><span class="n">n</span> <span class="o">+</span> <span class="n">ainit</span>


<span class="k">def</span> <span class="nf">add_test</span><span class="p">(</span><span class="n">a</span><span class="p">):</span>
    <span class="k">return</span> <span class="nb">sum</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">call_fun</span><span class="p">(</span><span class="n">fun</span><span class="p">,</span><span class="n">arg</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">fun</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">stack_transpose</span><span class="p">(</span><span class="n">cube</span><span class="p">):</span>
    <span class="n">shap</span> <span class="o">=</span> <span class="n">cube</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">trans_stack</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
        <span class="n">trans_stack</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">transpose</span><span class="p">(</span><span class="n">cube</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">])</span>

    <span class="k">return</span> <span class="n">trans_stack</span>

<span class="k">def</span> <span class="nf">rot_dissim</span><span class="p">(</span><span class="n">im_1</span><span class="p">,</span><span class="n">im2</span><span class="p">,</span><span class="n">theta</span><span class="p">):</span> <span class="c1"># Theta in degrees</span>
    <span class="n">im2rot</span> <span class="o">=</span> <span class="n">opencv_rot_interf</span><span class="p">(</span><span class="n">im2</span><span class="p">,</span><span class="n">theta</span><span class="p">)</span>
    <span class="n">d1</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">im_1</span><span class="o">-</span><span class="n">im2rot</span><span class="p">)</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">d1</span>

<span class="k">def</span> <span class="nf">int_grid_shift</span><span class="p">(</span><span class="n">psf_stack</span><span class="p">):</span> <span class="c1">#</span>
    <span class="n">shap</span> <span class="o">=</span> <span class="n">psf_stack</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">U</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="mi">2</span><span class="p">))</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
        <span class="c1">#param=gaussfitter.gaussfit(psf_stack[:,:,i],returnfitimage=False)</span>
        <span class="c1">#(centroid,Wc) = compute_centroid(psf_stack[:,:,i],(param[3]+param[4])/2)</span>
        <span class="p">(</span><span class="n">centroid</span><span class="p">,</span><span class="n">Wc</span><span class="p">)</span> <span class="o">=</span> <span class="n">compute_centroid</span><span class="p">(</span><span class="n">psf_stack</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">],</span><span class="mf">1e20</span><span class="p">,</span><span class="n">nb_iter</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">U</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">centroid</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">double</span><span class="p">(</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">/</span><span class="mi">2</span>
        <span class="n">U</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">centroid</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">double</span><span class="p">(</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">/</span><span class="mi">2</span>

    <span class="k">return</span> <span class="n">U</span>

<div class="viewcode-block" id="shift_est"><a class="viewcode-back" href="../utils.html#utils.shift_est">[docs]</a><span class="k">def</span> <span class="nf">shift_est</span><span class="p">(</span><span class="n">psf_stack</span><span class="p">):</span> 
    <span class="sd">&quot;&quot;&quot;Estimates shifts (see SPRITE paper, section 3.4.1., subsection &#39;Subpixel shifts&#39;).</span>
<span class="sd">    </span>
<span class="sd">    Calls:</span>
<span class="sd">    </span>
<span class="sd">    * gaussfitter.gaussfit</span>
<span class="sd">    * :func:`utils.compute_centroid`</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">shap</span> <span class="o">=</span> <span class="n">psf_stack</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">U</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="mi">2</span><span class="p">))</span>
    <span class="n">param</span><span class="o">=</span><span class="n">gaussfitter</span><span class="o">.</span><span class="n">gaussfit</span><span class="p">(</span><span class="n">psf_stack</span><span class="p">[:,:,</span><span class="mi">0</span><span class="p">],</span><span class="n">returnfitimage</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="c1">#(centroid_ref,Wc) = compute_centroid(psf_stack[:,:,0],(param[3]+param[4])/2)</span>
    <span class="n">centroid_out</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="mi">2</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
        <span class="n">param</span><span class="o">=</span><span class="n">gaussfitter</span><span class="o">.</span><span class="n">gaussfit</span><span class="p">(</span><span class="n">psf_stack</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">],</span><span class="n">returnfitimage</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="p">(</span><span class="n">centroid</span><span class="p">,</span><span class="n">Wc</span><span class="p">)</span> <span class="o">=</span> <span class="n">compute_centroid</span><span class="p">(</span><span class="n">psf_stack</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">],(</span><span class="n">param</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">+</span><span class="n">param</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">U</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">centroid</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">double</span><span class="p">(</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">/</span><span class="mi">2</span>
        <span class="n">U</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">centroid</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">double</span><span class="p">(</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">/</span><span class="mi">2</span>
        <span class="n">centroid_out</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>  <span class="o">=</span> <span class="n">centroid</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">centroid_out</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span>  <span class="o">=</span> <span class="n">centroid</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">U</span><span class="p">,</span><span class="n">centroid_out</span></div>

<span class="k">def</span> <span class="nf">shift_est_2_anch</span><span class="p">(</span><span class="n">psf_stack</span><span class="p">,</span><span class="n">anchor</span><span class="p">,</span><span class="n">res</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">width</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span><span class="n">exp</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
    <span class="n">shap</span> <span class="o">=</span> <span class="n">psf_stack</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">shifts</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="mi">2</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
        <span class="n">p</span><span class="p">,</span><span class="n">fwhm</span><span class="p">,</span><span class="n">fit_mod</span> <span class="o">=</span> <span class="n">moffat_fitting_2d</span><span class="p">(</span><span class="n">psf_stack</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">],</span><span class="n">width</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span><span class="n">exp</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">centroid</span> <span class="o">=</span> <span class="n">compute_centroid_2</span><span class="p">(</span><span class="n">psf_stack</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">],</span><span class="n">fit_mod</span><span class="p">)</span>
        <span class="n">shifts</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">anchor</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">centroid</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">res</span>
        <span class="n">shifts</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">anchor</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">centroid</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">res</span>
    <span class="k">return</span> <span class="n">shifts</span>

<span class="k">def</span> <span class="nf">wvl_centroid</span><span class="p">(</span><span class="n">im</span><span class="p">,</span><span class="n">opt</span><span class="p">,</span><span class="n">nsig</span><span class="p">):</span>
    <span class="n">wvl</span><span class="p">,</span><span class="n">mr_file</span> <span class="o">=</span> <span class="n">isap</span><span class="o">.</span><span class="n">mr_trans</span><span class="p">(</span><span class="n">im</span><span class="p">,</span><span class="n">opt</span><span class="o">=</span><span class="n">opt</span><span class="p">)</span>
    <span class="n">shap</span> <span class="o">=</span> <span class="n">wvl</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">sig_map</span> <span class="o">=</span> <span class="n">ones</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>
    <span class="n">k</span><span class="o">=</span><span class="mi">0</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
        <span class="n">sigk</span> <span class="o">=</span> <span class="mf">1.4826</span><span class="o">*</span><span class="n">mad</span><span class="p">(</span><span class="n">wvl</span><span class="p">[:,:,</span><span class="n">k</span><span class="p">])</span>
        <span class="n">sig_map</span><span class="p">[:,:,</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">sig_map</span><span class="p">[:,:,</span><span class="n">k</span><span class="p">]</span><span class="o">*</span><span class="n">sigk</span>
    <span class="n">thresh_type</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">wvl_clean</span> <span class="o">=</span> <span class="n">thresholding</span><span class="p">(</span><span class="n">wvl</span><span class="p">,</span><span class="n">nsig</span><span class="o">*</span><span class="n">sig_map</span><span class="p">,</span><span class="n">thresh_type</span><span class="p">)</span>
    <span class="n">wvl_cent</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
        <span class="n">cent</span><span class="p">,</span><span class="n">w</span> <span class="o">=</span> <span class="n">compute_centroid</span><span class="p">(</span><span class="n">im</span><span class="p">,</span><span class="mi">10</span><span class="o">**</span><span class="mi">3</span><span class="p">,</span><span class="n">nb_iter</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">wvl_cent</span> <span class="o">=</span> <span class="n">wvl_cent</span><span class="o">+</span><span class="n">cent</span>
    <span class="n">wvl_cent</span> <span class="o">=</span> <span class="n">wvl_cent</span><span class="o">/</span><span class="p">(</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">mr_file</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">wvl_cent</span>

<span class="k">def</span> <span class="nf">wvl_shift_est</span><span class="p">(</span><span class="n">psf_stack</span><span class="p">,</span><span class="n">opt</span><span class="p">,</span><span class="n">nsig</span><span class="p">):</span>
    <span class="n">shap</span> <span class="o">=</span> <span class="n">psf_stack</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">U</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="mi">2</span><span class="p">))</span>
    <span class="n">centroid_ref</span> <span class="o">=</span> <span class="n">wvl_centroid</span><span class="p">(</span><span class="n">psf_stack</span><span class="p">[:,:,</span><span class="mi">0</span><span class="p">],</span><span class="n">opt</span><span class="p">,</span><span class="n">nsig</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
        <span class="n">centroid</span> <span class="o">=</span> <span class="n">wvl_centroid</span><span class="p">(</span><span class="n">psf_stack</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">],</span><span class="n">opt</span><span class="p">,</span><span class="n">nsig</span><span class="p">)</span>
        <span class="n">U</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">centroid</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">centroid_ref</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">U</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">centroid</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">centroid_ref</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">U</span>

<span class="k">def</span> <span class="nf">thresh_centroid</span><span class="p">(</span><span class="n">im</span><span class="p">,</span><span class="n">sig_thresh</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">sigw</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">opt</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="n">thresh_type</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">if</span> <span class="n">sig_thresh</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">sig_thresh</span> <span class="o">=</span> <span class="n">im_gauss_nois_est</span><span class="p">(</span><span class="n">im</span><span class="p">,</span><span class="n">opt</span><span class="o">=</span><span class="n">opt</span><span class="p">)</span>
    <span class="n">thresh_map</span> <span class="o">=</span> <span class="n">ones</span><span class="p">(</span><span class="n">im</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span><span class="o">*</span><span class="nb">min</span><span class="p">(</span><span class="mi">4</span><span class="o">*</span><span class="n">sig_thresh</span><span class="p">,</span><span class="nb">abs</span><span class="p">(</span><span class="n">im</span><span class="p">)</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">-</span><span class="n">sig_thresh</span><span class="p">)</span>
    <span class="n">im_thresh</span> <span class="o">=</span> <span class="n">thresholding</span><span class="p">(</span><span class="n">im</span><span class="p">,</span><span class="n">thresh_map</span><span class="p">,</span><span class="n">thresh_type</span><span class="o">=</span><span class="n">thresh_type</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">sigw</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">param</span><span class="o">=</span><span class="n">gaussfitter</span><span class="o">.</span><span class="n">gaussfit</span><span class="p">(</span><span class="n">im</span><span class="p">,</span><span class="n">returnfitimage</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">sigw</span> <span class="o">=</span> <span class="p">(</span><span class="n">param</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">+</span><span class="n">param</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span><span class="o">/</span><span class="mi">2</span>
    <span class="n">cent</span><span class="p">,</span><span class="n">w</span> <span class="o">=</span> <span class="n">compute_centroid</span><span class="p">(</span><span class="n">im_thresh</span><span class="p">,</span><span class="n">sigw</span><span class="p">,</span><span class="n">nb_iter</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">cent</span>

<span class="k">def</span> <span class="nf">thresh_shift_est</span><span class="p">(</span><span class="n">im_stack</span><span class="p">,</span><span class="n">sig_thresh</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">opt</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="n">shap</span> <span class="o">=</span> <span class="n">im_stack</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">sigwv</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">],))</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
        <span class="n">param</span><span class="o">=</span><span class="n">gaussfitter</span><span class="o">.</span><span class="n">gaussfit</span><span class="p">(</span><span class="n">im_stack</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">],</span><span class="n">returnfitimage</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">sigwv</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">param</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">+</span><span class="n">param</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span><span class="o">/</span><span class="mi">2</span>
    <span class="n">sigw_ref</span> <span class="o">=</span> <span class="n">median</span><span class="p">(</span><span class="n">sigwv</span><span class="p">)</span>
    <span class="n">centroids</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="mi">2</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
        <span class="k">if</span> <span class="n">sig_thresh</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">centroids</span><span class="p">[</span><span class="n">i</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">thresh_centroid</span><span class="p">(</span><span class="n">im_stack</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">],</span><span class="n">sig_thresh</span><span class="o">=</span><span class="n">sig_thresh</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">sigw</span><span class="o">=</span><span class="n">sigw_ref</span><span class="p">,</span><span class="n">opt</span><span class="o">=</span><span class="n">opt</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">centroids</span><span class="p">[</span><span class="n">i</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">thresh_centroid</span><span class="p">(</span><span class="n">im_stack</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">],</span><span class="n">sigw</span><span class="o">=</span><span class="n">sigw_ref</span><span class="p">,</span><span class="n">opt</span><span class="o">=</span><span class="n">opt</span><span class="p">)</span>
    <span class="n">U</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="mi">2</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
        <span class="n">U</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">centroids</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">centroids</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">U</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">centroids</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">centroids</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">U</span>


<div class="viewcode-block" id="flux_estimate"><a class="viewcode-back" href="../utils.html#utils.flux_estimate">[docs]</a><span class="k">def</span> <span class="nf">flux_estimate</span><span class="p">(</span><span class="n">im</span><span class="p">,</span><span class="n">cent</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">rad</span><span class="o">=</span><span class="mi">4</span><span class="p">):</span> <span class="c1"># Default value for the flux tunned for Euclid PSF at Euclid resolution</span>
    <span class="sd">&quot;&quot;&quot;Estimate flux for one image (see SPRITE paper, section 3.4.1., subsection &#39;Photometric flux&#39;).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">flux</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">if</span> <span class="n">cent</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">cent</span> <span class="o">=</span> <span class="n">array</span><span class="p">(</span><span class="n">where</span><span class="p">(</span><span class="n">im</span><span class="o">==</span><span class="n">im</span><span class="o">.</span><span class="n">max</span><span class="p">()))</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span>
    <span class="n">shap</span> <span class="o">=</span> <span class="n">im</span><span class="o">.</span><span class="n">shape</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
            <span class="k">if</span> <span class="n">sqrt</span><span class="p">((</span><span class="n">i</span><span class="o">-</span><span class="n">cent</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="p">(</span><span class="n">j</span><span class="o">-</span><span class="n">cent</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">&lt;=</span><span class="n">rad</span><span class="p">:</span>
                <span class="n">flux</span> <span class="o">=</span> <span class="n">flux</span><span class="o">+</span><span class="n">im</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">flux</span></div>

<div class="viewcode-block" id="flux_estimate_stack"><a class="viewcode-back" href="../utils.html#utils.flux_estimate_stack">[docs]</a><span class="k">def</span> <span class="nf">flux_estimate_stack</span><span class="p">(</span><span class="n">stack</span><span class="p">,</span><span class="n">cent</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">rad</span><span class="o">=</span><span class="mi">4</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Estimate flux for a bunch of images.</span>
<span class="sd">    </span>
<span class="sd">    Calls:</span>
<span class="sd">    </span>
<span class="sd">    * :func:`utils.flux_estimate`</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">shap</span> <span class="o">=</span> <span class="n">stack</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">flux</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">],))</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
        <span class="k">if</span> <span class="n">cent</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">flux</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">flux_estimate</span><span class="p">(</span><span class="n">stack</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">],</span><span class="n">cent</span><span class="o">=</span><span class="n">cent</span><span class="p">[</span><span class="n">i</span><span class="p">,:],</span><span class="n">rad</span><span class="o">=</span><span class="n">rad</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">flux</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">flux_estimate</span><span class="p">(</span><span class="n">stack</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">],</span><span class="n">rad</span><span class="o">=</span><span class="n">rad</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">flux</span></div>

<span class="k">def</span> <span class="nf">random_shifts</span><span class="p">(</span><span class="n">im_stack</span><span class="p">,</span><span class="n">amax</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span><span class="n">n</span><span class="o">=</span><span class="mi">10</span><span class="p">):</span> <span class="c1"># random shifts in [-amax,amax]*pix</span>
    <span class="kn">from</span> <span class="nn">numpy.random</span> <span class="k">import</span> <span class="n">rand</span>
    <span class="kn">from</span> <span class="nn">scipy.signal</span> <span class="k">import</span> <span class="n">fftconvolve</span>
    <span class="n">output_stack</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">im_stack</span><span class="p">)</span>
    <span class="n">shap</span> <span class="o">=</span> <span class="n">im_stack</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">shifts</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="mi">2</span><span class="p">))</span>
    <span class="c1">#print &quot; ----------- /!\ Warning /!\: a single image is used in the shift simulation----------- &quot;</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
        <span class="n">u</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">])</span>

        <span class="n">u</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">amax</span><span class="o">*</span><span class="p">(</span><span class="n">rand</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">-</span><span class="mf">0.5</span><span class="p">)</span>
        <span class="n">u</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">amax</span><span class="o">*</span><span class="p">(</span><span class="n">rand</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">-</span><span class="mf">0.5</span><span class="p">)</span>
        <span class="n">shifts</span><span class="p">[</span><span class="n">i</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">2</span><span class="p">,))</span>
        <span class="n">output_stack</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">fftconvolve</span><span class="p">(</span><span class="n">im_stack</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">],</span><span class="n">lanczos</span><span class="p">(</span><span class="n">u</span><span class="p">,</span><span class="n">n</span><span class="o">=</span><span class="n">n</span><span class="p">),</span><span class="n">mode</span><span class="o">=</span><span class="s1">&#39;same&#39;</span><span class="p">)</span> <span class="c1"># here</span>
    <span class="k">return</span> <span class="n">output_stack</span><span class="p">,</span><span class="n">shifts</span>


<span class="k">def</span> <span class="nf">randshift_decim_flux</span><span class="p">(</span><span class="n">im_stack</span><span class="p">,</span><span class="n">down_fact</span><span class="p">,</span><span class="n">amax</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span><span class="n">n</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span><span class="n">var</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_fields</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span> <span class="c1"># Var= Luminosity variability: 0=&gt; same flux,1=&gt; might tend to zero</span>
    <span class="kn">from</span> <span class="nn">numpy.random</span> <span class="k">import</span> <span class="n">random</span>
    <span class="kn">from</span> <span class="nn">numpy</span> <span class="k">import</span> <span class="n">squeeze</span>
    <span class="n">shap</span> <span class="o">=</span> <span class="n">im_stack</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">output_stack</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="nb">int</span><span class="p">(</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="n">down_fact</span><span class="p">),</span><span class="nb">int</span><span class="p">(</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="n">down_fact</span><span class="p">),</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">nb_fields</span><span class="p">))</span>
    <span class="n">P</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">nb_fields</span><span class="p">))</span>
    <span class="n">shifts</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="mi">2</span><span class="p">,</span><span class="n">nb_fields</span><span class="p">))</span>
    <span class="n">flux</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">nb_fields</span><span class="p">))</span>

    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_fields</span><span class="p">):</span>
        <span class="n">shift_stack</span><span class="p">,</span><span class="n">shifts_k</span> <span class="o">=</span> <span class="n">random_shifts</span><span class="p">(</span><span class="n">im_stack</span><span class="p">,</span><span class="n">amax</span><span class="o">=</span><span class="n">amax</span><span class="p">,</span><span class="n">n</span><span class="o">=</span><span class="n">n</span><span class="p">)</span>
        <span class="n">temp</span><span class="p">,</span><span class="n">output_stack_k</span> <span class="o">=</span> <span class="n">decim_arr</span><span class="p">(</span><span class="n">shift_stack</span><span class="p">,</span><span class="n">down_fact</span><span class="p">,</span><span class="n">av_en</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">fft</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">P_k</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">],))</span>
        <span class="n">i</span><span class="o">=</span><span class="mi">0</span>
        <span class="n">flux_k</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">],))</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
            <span class="n">flux</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="o">-</span><span class="n">var</span><span class="o">*</span><span class="n">random</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">P_k</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">output_stack_k</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">/</span><span class="p">(</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">output_stack_k</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">flux</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">k</span><span class="p">]</span><span class="o">*</span><span class="n">output_stack_k</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">]</span>
            <span class="n">shifts_k</span><span class="p">[</span><span class="n">i</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">shifts_k</span><span class="p">[</span><span class="n">i</span><span class="p">,:]</span> <span class="o">-</span> <span class="n">shifts_k</span><span class="p">[</span><span class="mi">0</span><span class="p">,:]</span>
        <span class="n">output_stack</span><span class="p">[:,:,:,</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">output_stack_k</span><span class="p">)</span>
        <span class="n">P</span><span class="p">[:,</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">P_k</span><span class="p">)</span>
        <span class="n">shifts</span><span class="p">[:,:,</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">shifts_k</span>

    <span class="k">return</span> <span class="n">output_stack</span><span class="p">,</span><span class="n">P</span><span class="p">,</span><span class="n">squeeze</span><span class="p">(</span><span class="n">shifts</span><span class="p">),</span><span class="n">squeeze</span><span class="p">(</span><span class="n">flux</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">multiframe_sr_data_gen</span><span class="p">(</span><span class="n">im</span><span class="p">,</span><span class="n">down_fact</span><span class="p">,</span><span class="n">snr</span><span class="p">,</span><span class="n">nb_obs</span><span class="p">,</span><span class="n">noise_var</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">flux_var</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">amax</span><span class="o">=</span><span class="mf">0.5</span><span class="p">):</span>
    <span class="kn">from</span> <span class="nn">numpy</span> <span class="k">import</span> <span class="n">log10</span>
    <span class="n">shap</span> <span class="o">=</span> <span class="n">im</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">im_stack</span> <span class="o">=</span> <span class="n">repeat</span><span class="p">(</span><span class="n">im</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="mi">1</span><span class="p">)),</span><span class="n">nb_obs</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">output_stack</span><span class="p">,</span><span class="n">sig</span><span class="p">,</span><span class="n">dec_stack</span><span class="p">,</span><span class="n">shifts</span><span class="p">,</span><span class="n">sig</span><span class="p">,</span><span class="n">flux</span> <span class="o">=</span> <span class="n">sr_data_gen</span><span class="p">(</span><span class="n">im_stack</span><span class="p">,</span><span class="mi">20</span><span class="o">*</span><span class="n">log10</span><span class="p">(</span><span class="n">snr</span><span class="p">),</span><span class="n">down_fact</span><span class="p">,</span><span class="n">amax</span><span class="o">=</span><span class="n">amax</span><span class="p">,</span><span class="n">n</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span><span class="n">noise_var</span><span class="o">=</span><span class="n">noise_var</span><span class="p">,</span><span class="n">flux_var</span><span class="o">=</span><span class="n">flux_var</span><span class="p">,</span><span class="n">nb_comp</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">nb_fields</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">output_stack</span><span class="p">,</span><span class="n">sig</span>


<span class="k">def</span> <span class="nf">noise_cube</span><span class="p">(</span><span class="n">shap</span><span class="p">,</span><span class="n">snrdb_max</span><span class="p">,</span><span class="nb">pow</span><span class="p">,</span><span class="n">var</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_fields</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span> <span class="c1"># Var= snr variability; 0=same snr, 1=&gt; there might twice more noise in an image compared to another</span>
    <span class="kn">from</span> <span class="nn">numpy.random</span> <span class="k">import</span> <span class="n">random</span>
    <span class="n">cube</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">(</span><span class="n">shap</span><span class="p">)</span>
    <span class="n">sig</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">nb_fields</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_fields</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
            <span class="n">sig</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">var</span><span class="o">*</span><span class="n">random</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span><span class="o">*</span><span class="n">sqrt</span><span class="p">(</span><span class="nb">pow</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">k</span><span class="p">])</span><span class="o">*</span><span class="mi">10</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="n">snrdb_max</span><span class="o">/</span><span class="mi">20</span><span class="p">)</span>
            <span class="n">cube</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">,</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">sig</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">k</span><span class="p">]</span><span class="o">*</span><span class="n">randn</span><span class="p">(</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">cube</span><span class="p">,</span><span class="n">sig</span>

<span class="k">def</span> <span class="nf">sr_data_gen</span><span class="p">(</span><span class="n">im_stack</span><span class="p">,</span><span class="n">snrdB</span><span class="p">,</span><span class="n">down_fact</span><span class="p">,</span><span class="n">amax</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span><span class="n">n</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span><span class="n">noise_var</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">flux_var</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_comp</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">nb_fields</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
    <span class="kn">from</span> <span class="nn">optim_utils</span> <span class="k">import</span> <span class="n">trunc_svd_cube</span>
    <span class="n">im_stack_in</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">im_stack</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">nb_comp</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">im_stack_in</span> <span class="o">=</span> <span class="n">trunc_svd_cube</span><span class="p">(</span><span class="n">im_stack</span><span class="p">,</span><span class="n">nb_comp</span><span class="p">)</span>
    <span class="n">dec_stack</span><span class="p">,</span><span class="n">P</span><span class="p">,</span><span class="n">shifts</span><span class="p">,</span><span class="n">flux</span> <span class="o">=</span> <span class="n">randshift_decim_flux</span><span class="p">(</span><span class="n">im_stack_in</span><span class="p">,</span><span class="n">down_fact</span><span class="p">,</span><span class="n">amax</span><span class="o">=</span><span class="n">amax</span><span class="p">,</span><span class="n">n</span><span class="o">=</span><span class="n">n</span><span class="p">,</span><span class="n">var</span><span class="o">=</span><span class="n">flux_var</span><span class="p">,</span><span class="n">nb_fields</span><span class="o">=</span><span class="n">nb_fields</span><span class="p">)</span>
    <span class="n">shap</span> <span class="o">=</span> <span class="n">dec_stack</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">nb_snr</span> <span class="o">=</span> <span class="n">size</span><span class="p">(</span><span class="n">snrdB</span><span class="p">)</span>
    <span class="n">output_stack</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">sig</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">nb_snr</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
        <span class="n">noise</span><span class="p">,</span><span class="n">sig</span> <span class="o">=</span> <span class="n">noise_cube</span><span class="p">(</span><span class="n">shap</span><span class="p">,</span><span class="n">snrdB</span><span class="p">,</span><span class="n">P</span><span class="p">,</span><span class="n">var</span><span class="o">=</span><span class="n">noise_var</span><span class="p">,</span><span class="n">nb_fields</span><span class="o">=</span><span class="n">nb_fields</span><span class="p">)</span>
        <span class="n">output_stack</span> <span class="o">=</span> <span class="n">dec_stack</span><span class="o">+</span><span class="n">noise</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">sig</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">nb_fields</span><span class="p">,</span><span class="n">nb_snr</span><span class="p">))</span>
        <span class="n">output_stack</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">nb_fields</span><span class="p">,</span><span class="n">nb_snr</span><span class="p">))</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_snr</span><span class="p">):</span>
            <span class="n">noise_i</span><span class="p">,</span><span class="n">sig_i</span> <span class="o">=</span> <span class="n">noise_cube</span><span class="p">(</span><span class="n">shap</span><span class="p">,</span><span class="n">snrdB</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">P</span><span class="p">,</span><span class="n">var</span><span class="o">=</span><span class="n">noise_var</span><span class="p">,</span><span class="n">nb_fields</span><span class="o">=</span><span class="n">nb_fields</span><span class="p">)</span>
            <span class="n">output_stack</span><span class="p">[:,:,:,:,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">dec_stack</span><span class="o">+</span><span class="n">noise_i</span>
            <span class="n">sig</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">sig_i</span>
    <span class="k">return</span> <span class="n">output_stack</span><span class="p">,</span><span class="n">sig</span><span class="p">,</span><span class="n">dec_stack</span><span class="p">,</span><span class="n">shifts</span><span class="p">,</span><span class="n">flux</span>

<span class="k">def</span> <span class="nf">polychrom_star_sim</span><span class="p">(</span><span class="n">poly_chrom_psf</span><span class="p">,</span><span class="n">spectrum</span><span class="p">,</span><span class="n">snr</span><span class="p">,</span><span class="n">noise_en</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">sampling</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">av_en</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>

    <span class="n">shap</span> <span class="o">=</span> <span class="n">poly_chrom_psf</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">output</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="n">sampling</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="n">sampling</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">sampling</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">:</span>
        <span class="n">temp</span><span class="p">,</span><span class="n">psf_d</span> <span class="o">=</span> <span class="n">decim_arr</span><span class="p">(</span><span class="n">poly_chrom_psf</span><span class="p">,</span><span class="n">sampling</span><span class="p">,</span><span class="n">av_en</span><span class="o">=</span><span class="n">av_en</span><span class="p">,</span><span class="n">fft</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
        <span class="n">output</span><span class="o">+=</span> <span class="n">spectrum</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">*</span><span class="n">psf_d</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">]</span><span class="o">/</span><span class="n">psf_d</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>

    <span class="n">sig</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">noise_en</span><span class="p">:</span>
        <span class="n">sig</span> <span class="o">=</span> <span class="n">sqrt</span><span class="p">(((</span><span class="n">norm</span><span class="p">(</span><span class="n">output</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">snr</span><span class="o">*</span><span class="n">sampling</span><span class="o">**</span><span class="mi">2</span><span class="p">)))</span>
        <span class="n">output</span> <span class="o">+=</span> <span class="n">sig</span><span class="o">*</span><span class="n">randn</span><span class="p">(</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="n">sampling</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="n">sampling</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">output</span><span class="p">,</span><span class="n">sig</span><span class="p">,</span><span class="n">psf_d</span>

<span class="k">def</span> <span class="nf">polychrom_star_field_sim</span><span class="p">(</span><span class="n">poly_chrom_psf_cube_list</span><span class="p">,</span><span class="n">snrdB</span><span class="p">,</span><span class="n">sampling</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">sampling_0</span><span class="o">=</span><span class="mi">6</span><span class="p">,</span>\
    <span class="n">flat_sed_en</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">spars_sed</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">nb_spikes</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span><span class="n">frac</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span><span class="n">amax</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span><span class="n">n</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span><span class="n">noise_var</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">flux_var</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_comp</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">nb_fields</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>

    <span class="n">nb_bands</span> <span class="o">=</span> <span class="n">poly_chrom_psf_cube_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">nb_psfs</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">poly_chrom_psf_cube_list</span><span class="p">)</span>

    <span class="c1"># Spectrum</span>
    <span class="k">if</span> <span class="n">flat_sed_en</span><span class="p">:</span>
        <span class="n">spectrums</span> <span class="o">=</span> <span class="n">ones</span><span class="p">((</span><span class="n">nb_bands</span><span class="p">,</span><span class="n">nb_psfs</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">spectrums</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">randn</span><span class="p">(</span><span class="n">nb_bands</span><span class="p">,</span><span class="n">nb_psfs</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">spars_sed</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_psfs</span><span class="p">):</span>
                <span class="n">spectrums</span><span class="p">[:,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">sparsify_sed</span><span class="p">(</span><span class="n">spectrums</span><span class="p">[:,</span><span class="n">i</span><span class="p">],</span><span class="n">nb_spikes</span><span class="p">,</span><span class="n">frac</span><span class="p">)</span>

    <span class="n">spectrums</span> <span class="o">=</span> <span class="n">diag</span><span class="p">((</span><span class="n">spectrums</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">spectrums</span><span class="p">)</span>

    <span class="c1"># HR polychromatic PSFs</span>
    <span class="n">shap</span> <span class="o">=</span> <span class="n">poly_chrom_psf_cube_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">stack_hr</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="n">sampling_0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="n">sampling_0</span><span class="p">,</span><span class="n">nb_psfs</span><span class="p">))</span>
    <span class="n">ref_hr</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="n">sampling_0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="n">sampling_0</span><span class="p">,</span><span class="n">nb_bands</span><span class="p">,</span><span class="n">nb_psfs</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_psfs</span><span class="p">):</span>
        <span class="n">stack_hr</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">],</span><span class="n">sig</span><span class="p">,</span><span class="n">ref_hr</span><span class="p">[:,:,:,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">polychrom_star_sim</span><span class="p">(</span><span class="n">poly_chrom_psf_cube_list</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">spectrums</span><span class="p">[:,</span><span class="n">i</span><span class="p">],</span><span class="mi">0</span><span class="p">,</span><span class="n">noise_en</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">sampling</span><span class="o">=</span><span class="n">sampling_0</span><span class="p">,</span><span class="n">av_en</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="c1"># Simulated observations</span>
    <span class="n">output_stack</span><span class="p">,</span><span class="n">sig</span><span class="p">,</span><span class="n">dec_stack</span><span class="p">,</span><span class="n">shifts</span><span class="p">,</span><span class="n">flux</span> <span class="o">=</span> <span class="n">sr_data_gen</span><span class="p">(</span><span class="n">stack_hr</span><span class="p">,</span><span class="n">snrdB</span><span class="p">,</span><span class="n">sampling</span><span class="p">,</span><span class="n">amax</span><span class="o">=</span><span class="n">amax</span><span class="p">,</span><span class="n">n</span><span class="o">=</span><span class="n">n</span><span class="p">,</span><span class="n">noise_var</span><span class="o">=</span><span class="n">noise_var</span><span class="p">,</span><span class="n">flux_var</span><span class="o">=</span><span class="n">flux_var</span><span class="p">,</span><span class="n">nb_comp</span><span class="o">=</span><span class="n">nb_comp</span><span class="p">,</span><span class="n">nb_fields</span><span class="o">=</span><span class="n">nb_fields</span><span class="p">)</span>


    <span class="k">return</span> <span class="n">output_stack</span><span class="p">,</span><span class="n">sig</span><span class="p">,</span><span class="n">ref_hr</span><span class="p">,</span><span class="n">shifts</span><span class="p">,</span><span class="n">flux</span><span class="p">,</span><span class="n">spectrums</span>


<span class="k">def</span> <span class="nf">sparsify_sed</span><span class="p">(</span><span class="n">spectrum</span><span class="p">,</span><span class="n">nb_spike</span><span class="p">,</span><span class="n">frac</span><span class="p">):</span>
    <span class="n">spectrum_out</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">spectrum</span><span class="p">)</span>
    <span class="n">t</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">spectrum</span><span class="p">)</span>
    <span class="n">id_ref</span> <span class="o">=</span> <span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">size</span><span class="p">(</span><span class="n">spectrum</span><span class="p">))</span>
    <span class="n">samp</span> <span class="o">=</span> <span class="n">choice</span><span class="p">(</span><span class="n">id_ref</span><span class="p">,</span><span class="n">size</span><span class="o">=</span><span class="n">nb_spike</span><span class="p">,</span><span class="n">replace</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">id_ref</span><span class="p">[</span><span class="n">samp</span><span class="p">]</span><span class="o">=-</span><span class="mi">1</span>
    <span class="n">samp_comp</span> <span class="o">=</span> <span class="n">where</span><span class="p">(</span><span class="n">id_ref</span><span class="o">&gt;=</span><span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">spectrum_out</span><span class="p">[</span><span class="n">samp</span><span class="p">]</span><span class="o">*=</span> <span class="n">t</span><span class="o">*</span><span class="n">frac</span><span class="o">/</span><span class="nb">sum</span><span class="p">(</span><span class="n">spectrum_out</span><span class="p">[</span><span class="n">samp</span><span class="p">])</span>
    <span class="n">spectrum_out</span><span class="p">[</span><span class="n">samp_comp</span><span class="p">]</span><span class="o">*=</span> <span class="n">t</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">frac</span><span class="p">)</span><span class="o">/</span><span class="nb">sum</span><span class="p">(</span><span class="n">spectrum_out</span><span class="p">[</span><span class="n">samp_comp</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">spectrum_out</span>


<span class="k">def</span> <span class="nf">stack_satur</span><span class="p">(</span><span class="n">stack</span><span class="p">,</span><span class="n">perc</span><span class="p">,</span><span class="n">satur_interv</span><span class="o">=</span><span class="p">[</span><span class="mf">0.2</span><span class="p">,</span><span class="mf">0.8</span><span class="p">]):</span> <span class="c1"># This routine assumed a single field data stack is provided</span>
    <span class="kn">from</span> <span class="nn">numpy</span> <span class="k">import</span> <span class="nb">int</span>
    <span class="kn">from</span> <span class="nn">numpy.random</span> <span class="k">import</span> <span class="n">rand</span>
    <span class="n">shap</span> <span class="o">=</span> <span class="n">stack</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">nb_satur</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="n">perc</span><span class="p">)</span>
    <span class="n">ind_satur</span> <span class="o">=</span> <span class="n">rand_diff_integ</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">nb_satur</span><span class="p">)</span>
    <span class="n">stack_out</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">stack</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_satur</span><span class="p">):</span>
        <span class="nb">print</span> <span class="s2">&quot;im &quot;</span><span class="p">,</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="s2">&quot;/&quot;</span><span class="p">,</span><span class="n">nb_satur</span>
        <span class="n">perc</span> <span class="o">=</span> <span class="p">(</span><span class="n">satur_interv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">satur_interv</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">*</span><span class="n">rand</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">+</span><span class="n">satur_interv</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">stack_out</span><span class="p">[:,:,</span><span class="n">ind_satur</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">saturate</span><span class="p">(</span><span class="n">stack</span><span class="p">[:,:,</span><span class="n">ind_satur</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="mi">0</span><span class="p">],</span><span class="n">perc</span><span class="o">=</span><span class="n">perc</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">stack_out</span><span class="p">,</span><span class="n">ind_satur</span>

<span class="k">def</span> <span class="nf">sr_data_gen_2</span><span class="p">(</span><span class="n">im_stack</span><span class="p">,</span><span class="n">snrdB</span><span class="p">,</span><span class="n">saturation_perc</span><span class="p">,</span><span class="n">down_fact</span><span class="p">,</span><span class="n">satur_interv</span><span class="o">=</span><span class="p">[</span><span class="mf">0.2</span><span class="p">,</span><span class="mf">0.8</span><span class="p">],</span><span class="n">amax</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span><span class="n">n</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span><span class="n">noise_var</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">flux_var</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_comp</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">nb_fields</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
    <span class="n">im_stack_in</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">im_stack</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">nb_comp</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">im_stack_in</span> <span class="o">=</span> <span class="n">optim_utils</span><span class="o">.</span><span class="n">trunc_svd_cube</span><span class="p">(</span><span class="n">im_stack</span><span class="p">,</span><span class="n">nb_comp</span><span class="p">)</span>
    <span class="n">dec_stack</span><span class="p">,</span><span class="n">P</span><span class="p">,</span><span class="n">shifts</span><span class="p">,</span><span class="n">flux</span> <span class="o">=</span> <span class="n">randshift_decim_flux</span><span class="p">(</span><span class="n">im_stack_in</span><span class="p">,</span><span class="n">down_fact</span><span class="p">,</span><span class="n">amax</span><span class="o">=</span><span class="n">amax</span><span class="p">,</span><span class="n">n</span><span class="o">=</span><span class="n">n</span><span class="p">,</span><span class="n">var</span><span class="o">=</span><span class="n">flux_var</span><span class="p">,</span><span class="n">nb_fields</span><span class="o">=</span><span class="n">nb_fields</span><span class="p">)</span>
    <span class="n">shap</span> <span class="o">=</span> <span class="n">dec_stack</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">nb_satur</span> <span class="o">=</span> <span class="n">size</span><span class="p">(</span><span class="n">saturation_perc</span><span class="p">)</span>
    <span class="n">output_stack</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">sig</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">ind_sat</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">nb_satur</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
        <span class="n">noise</span><span class="p">,</span><span class="n">sig</span> <span class="o">=</span> <span class="n">noise_cube</span><span class="p">(</span><span class="n">shap</span><span class="p">,</span><span class="n">snrdB</span><span class="p">,</span><span class="n">P</span><span class="p">,</span><span class="n">var</span><span class="o">=</span><span class="n">noise_var</span><span class="p">,</span><span class="n">nb_fields</span><span class="o">=</span><span class="n">nb_fields</span><span class="p">)</span>
        <span class="n">sat</span><span class="p">,</span><span class="n">ind_sat</span> <span class="o">=</span> <span class="n">stack_satur</span><span class="p">(</span><span class="n">dec_stack</span><span class="p">,</span><span class="n">saturation_perc</span><span class="p">,</span><span class="n">satur_interv</span><span class="o">=</span><span class="n">satur_interv</span><span class="p">)</span>
        <span class="n">output_stack</span> <span class="o">=</span> <span class="n">sat</span><span class="o">+</span><span class="n">noise</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">output_stack</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">nb_fields</span><span class="p">,</span><span class="n">nb_satur</span><span class="p">))</span>
        <span class="n">noise</span><span class="p">,</span><span class="n">sig</span> <span class="o">=</span> <span class="n">noise_cube</span><span class="p">(</span><span class="n">shap</span><span class="p">,</span><span class="n">snrdB</span><span class="p">,</span><span class="n">P</span><span class="p">,</span><span class="n">var</span><span class="o">=</span><span class="n">noise_var</span><span class="p">,</span><span class="n">nb_fields</span><span class="o">=</span><span class="n">nb_fields</span><span class="p">)</span>
        <span class="n">ind_sat</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_satur</span><span class="p">):</span>
            <span class="n">sat_i</span><span class="p">,</span><span class="n">ind_sat_i</span> <span class="o">=</span> <span class="n">stack_satur</span><span class="p">(</span><span class="n">dec_stack</span><span class="p">,</span><span class="n">saturation_perc</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">satur_interv</span><span class="o">=</span><span class="n">satur_interv</span><span class="p">)</span>
            <span class="n">ind_sat</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ind_sat_i</span><span class="p">)</span>
            <span class="n">output_stack</span><span class="p">[:,:,:,:,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">sat_i</span><span class="o">+</span><span class="n">noise</span>

    <span class="k">return</span> <span class="n">output_stack</span><span class="p">,</span><span class="n">sig</span><span class="p">,</span><span class="n">dec_stack</span><span class="p">,</span><span class="n">shifts</span><span class="p">,</span><span class="n">sig</span><span class="p">,</span><span class="n">flux</span><span class="p">,</span><span class="n">ind_sat</span>



<span class="k">def</span> <span class="nf">cumul_energ_perc</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
    <span class="n">E</span> <span class="o">=</span> <span class="p">(</span><span class="n">s</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    <span class="n">out</span> <span class="o">=</span> <span class="n">s</span><span class="o">*</span><span class="mi">0</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">size</span><span class="p">(</span><span class="n">s</span><span class="p">)):</span>
        <span class="n">out</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">i</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="n">E</span>
    <span class="k">return</span> <span class="n">out</span>

<span class="k">def</span> <span class="nf">rot_invar_correl</span><span class="p">(</span><span class="n">im1</span><span class="p">,</span><span class="n">im2</span><span class="p">):</span>
    <span class="kn">from</span> <span class="nn">numpy</span> <span class="k">import</span> <span class="n">conj</span>
    <span class="n">pol1</span> <span class="o">=</span> <span class="n">polar</span><span class="p">(</span><span class="n">im1</span><span class="p">)</span>
    <span class="n">pol2</span> <span class="o">=</span> <span class="n">polar</span><span class="p">(</span><span class="n">im2</span><span class="p">)</span>
    <span class="n">corr</span> <span class="o">=</span> <span class="n">scipy_fft</span><span class="o">.</span><span class="n">ifft2</span><span class="p">(</span><span class="n">scipy_fft</span><span class="o">.</span><span class="n">fft2</span><span class="p">(</span><span class="n">pol1</span><span class="p">)</span><span class="o">*</span><span class="n">conj</span><span class="p">(</span><span class="n">scipy_fft</span><span class="o">.</span><span class="n">fft2</span><span class="p">(</span><span class="n">pol2</span><span class="p">)))</span>
    <span class="n">n1</span> <span class="o">=</span> <span class="n">sqrt</span><span class="p">((</span><span class="n">pol1</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span>
    <span class="n">n2</span> <span class="o">=</span> <span class="n">sqrt</span><span class="p">((</span><span class="n">pol2</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span>
    <span class="n">corr_coeff</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">corr</span><span class="p">)</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">/</span><span class="p">(</span><span class="n">n1</span><span class="o">*</span><span class="n">n2</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">corr_coeff</span>

<div class="viewcode-block" id="shift_ker_stack"><a class="viewcode-back" href="../utils.html#utils.shift_ker_stack">[docs]</a><span class="k">def</span> <span class="nf">shift_ker_stack</span><span class="p">(</span><span class="n">shifts</span><span class="p">,</span><span class="n">upfact</span><span class="p">,</span><span class="n">lanc_rad</span><span class="o">=</span><span class="mi">4</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Generate shifting kernels and rotated shifting kernels.</span>
<span class="sd">    </span>
<span class="sd">    Calls:</span>
<span class="sd">    </span>
<span class="sd">    * :func:`utils.lanczos`</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">numpy</span> <span class="k">import</span> <span class="n">rot90</span>
    <span class="n">shap</span> <span class="o">=</span> <span class="n">shifts</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">shift_ker_stack</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="mi">2</span><span class="o">*</span><span class="n">lanc_rad</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="o">*</span><span class="n">lanc_rad</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
    <span class="n">shift_ker_stack_adj</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="mi">2</span><span class="o">*</span><span class="n">lanc_rad</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="o">*</span><span class="n">lanc_rad</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>

        <span class="n">uin</span> <span class="o">=</span> <span class="n">shifts</span><span class="p">[</span><span class="n">i</span><span class="p">,:]</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span><span class="o">*</span><span class="n">upfact</span>
        <span class="n">shift_ker_stack</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">lanczos</span><span class="p">(</span><span class="n">uin</span><span class="p">,</span><span class="n">n</span><span class="o">=</span><span class="n">lanc_rad</span><span class="p">)</span>
        <span class="n">shift_ker_stack_adj</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">rot90</span><span class="p">(</span><span class="n">shift_ker_stack</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">],</span><span class="mi">2</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">shift_ker_stack</span><span class="p">,</span><span class="n">shift_ker_stack_adj</span></div>


<span class="k">def</span> <span class="nf">laguerre_poly</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">m</span><span class="p">,</span><span class="n">q</span><span class="p">):</span>
    <span class="c1"># Abramovitz recurrence relation</span>
    <span class="n">L0_x</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">L1m_x</span> <span class="o">=</span> <span class="p">(</span><span class="n">m</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">-</span><span class="n">x</span>
    <span class="n">out</span> <span class="o">=</span> <span class="n">L0_x</span>
    <span class="k">if</span> <span class="n">q</span> <span class="o">==</span><span class="mi">1</span><span class="p">:</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">L1m_x</span>
    <span class="k">elif</span> <span class="n">q</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">:</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">q</span><span class="o">+</span><span class="mi">1</span><span class="p">,))</span>
        <span class="n">out</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">L0_x</span>
        <span class="n">out</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">L1m_x</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="n">q</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
            <span class="n">out</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(((</span><span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">+</span><span class="n">m</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">-</span><span class="n">x</span><span class="p">)</span><span class="o">*</span><span class="n">out</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="p">(</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="o">+</span><span class="n">m</span><span class="p">)</span><span class="o">*</span><span class="n">out</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">2</span><span class="p">])</span><span class="o">/</span><span class="n">i</span>

    <span class="k">return</span> <span class="n">out</span>

<span class="k">def</span> <span class="nf">laguerre_exp_vect</span><span class="p">(</span><span class="n">siz</span><span class="p">,</span><span class="n">sig</span><span class="p">,</span><span class="n">p</span><span class="p">,</span><span class="n">q</span><span class="p">,</span><span class="n">cent</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">cent</span><span class="o">==</span><span class="kc">None</span><span class="p">:</span>
        <span class="n">cent</span> <span class="o">=</span> <span class="n">array</span><span class="p">(</span><span class="n">siz</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span>
    <span class="n">real_comp</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">(</span><span class="n">siz</span><span class="p">)</span>
    <span class="n">imag_comp</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">(</span><span class="n">siz</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">siz</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">siz</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
            <span class="n">r</span><span class="p">,</span><span class="n">theta</span> <span class="o">=</span> <span class="n">polar_coord</span><span class="p">([</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">],</span><span class="n">cent</span><span class="p">)</span>
            <span class="n">a</span> <span class="o">=</span> <span class="n">laguerre_poly</span><span class="p">(</span><span class="n">r</span><span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="n">sig</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span><span class="n">p</span><span class="o">-</span><span class="n">q</span><span class="p">,</span><span class="n">q</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">q</span><span class="o">&lt;=</span><span class="mi">1</span><span class="p">:</span>
                <span class="n">ain</span> <span class="o">=</span> <span class="n">a</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ain</span> <span class="o">=</span> <span class="n">a</span><span class="p">[</span><span class="n">q</span><span class="p">]</span>
            <span class="n">real_comp</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">**</span><span class="n">q</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">sqrt</span><span class="p">(</span><span class="n">pi</span><span class="p">)</span><span class="o">*</span><span class="n">sig</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">sqrt</span><span class="p">(</span><span class="n">double</span><span class="p">(</span><span class="n">factorielle</span><span class="p">(</span><span class="n">q</span><span class="p">))</span><span class="o">/</span><span class="n">factorielle</span><span class="p">(</span><span class="n">p</span><span class="p">))</span><span class="o">*</span><span class="p">((</span><span class="n">r</span><span class="o">/</span><span class="n">sig</span><span class="p">)</span><span class="o">**</span><span class="p">(</span><span class="n">p</span><span class="o">-</span><span class="n">q</span><span class="p">))</span><span class="o">*</span><span class="n">cos</span><span class="p">((</span><span class="n">p</span><span class="o">-</span><span class="n">q</span><span class="p">)</span><span class="o">*</span><span class="n">theta</span><span class="p">)</span><span class="o">*</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">r</span><span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">sig</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span><span class="o">*</span><span class="n">ain</span>
            <span class="n">imag_comp</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">**</span><span class="n">q</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">sqrt</span><span class="p">(</span><span class="n">pi</span><span class="p">)</span><span class="o">*</span><span class="n">sig</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">sqrt</span><span class="p">(</span><span class="n">double</span><span class="p">(</span><span class="n">factorielle</span><span class="p">(</span><span class="n">q</span><span class="p">))</span><span class="o">/</span><span class="n">factorielle</span><span class="p">(</span><span class="n">p</span><span class="p">))</span><span class="o">*</span><span class="p">((</span><span class="n">r</span><span class="o">/</span><span class="n">sig</span><span class="p">)</span><span class="o">**</span><span class="p">(</span><span class="n">p</span><span class="o">-</span><span class="n">q</span><span class="p">))</span><span class="o">*</span><span class="n">sin</span><span class="p">((</span><span class="n">p</span><span class="o">-</span><span class="n">q</span><span class="p">)</span><span class="o">*</span><span class="n">theta</span><span class="p">)</span><span class="o">*</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">r</span><span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">sig</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span><span class="o">*</span><span class="n">ain</span>

    <span class="k">return</span> <span class="n">real_comp</span><span class="p">,</span><span class="n">imag_comp</span>


<span class="k">def</span> <span class="nf">laguerre_exp_dict</span><span class="p">(</span><span class="n">siz</span><span class="p">,</span><span class="n">sig_min</span><span class="p">,</span><span class="n">sig_max</span><span class="p">,</span><span class="n">nb_sc</span><span class="p">,</span><span class="n">p_max</span><span class="p">,</span><span class="n">cent</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="n">nb_el</span> <span class="o">=</span> <span class="n">p_max</span><span class="o">*</span><span class="p">(</span><span class="n">p_max</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span>
    <span class="n">real_dict</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">siz</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">siz</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">nb_el</span><span class="p">,</span><span class="n">nb_sc</span><span class="p">))</span>
    <span class="n">imag_dict</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">siz</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">siz</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">nb_el</span><span class="p">,</span><span class="n">nb_sc</span><span class="p">))</span>
    <span class="n">sig</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_sc</span><span class="p">):</span>
        <span class="n">sig</span> <span class="o">=</span> <span class="n">sig</span><span class="o">+</span><span class="n">sig_min</span><span class="o">+</span><span class="p">(</span><span class="n">sig_max</span><span class="o">-</span><span class="n">sig_min</span><span class="p">)</span><span class="o">*</span><span class="n">k</span><span class="o">/</span><span class="n">nb_sc</span>
        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">p_max</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">q</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">p</span><span class="p">):</span>
                <span class="n">nb_el_p</span> <span class="o">=</span> <span class="n">p</span><span class="o">*</span><span class="p">(</span><span class="n">p</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span>
                <span class="n">r</span><span class="p">,</span><span class="n">im</span> <span class="o">=</span> <span class="n">laguerre_exp_vect</span><span class="p">(</span><span class="n">siz</span><span class="p">,</span><span class="n">sig</span><span class="p">,</span><span class="n">p</span><span class="p">,</span><span class="n">q</span><span class="p">,</span><span class="n">cent</span><span class="o">=</span><span class="n">cent</span><span class="p">)</span>
                <span class="n">real_dict</span><span class="p">[:,:,</span><span class="n">nb_el_p</span><span class="o">+</span><span class="n">q</span><span class="p">,</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">r</span>
                <span class="n">imag_dict</span><span class="p">[:,:,</span><span class="n">nb_el_p</span><span class="o">+</span><span class="n">q</span><span class="p">,</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">im</span>
    <span class="nb">dict</span> <span class="o">=</span> <span class="n">real_dict</span><span class="o">+</span><span class="mi">1</span><span class="n">j</span><span class="o">*</span><span class="n">imag_dict</span>
    <span class="k">return</span> <span class="nb">dict</span>


<span class="k">def</span> <span class="nf">abs_val_reverting</span><span class="p">(</span><span class="n">w</span><span class="p">):</span>
    <span class="n">max_val</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">w</span><span class="p">)</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
    <span class="n">min_val</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">w</span><span class="p">)</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
    <span class="n">ones_arr</span> <span class="o">=</span> <span class="n">ones</span><span class="p">(</span><span class="n">w</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
    <span class="n">w_out</span> <span class="o">=</span> <span class="n">sign</span><span class="p">(</span><span class="n">w</span><span class="p">)</span><span class="o">*</span><span class="p">((</span><span class="n">max_val</span><span class="o">+</span><span class="n">min_val</span><span class="p">)</span><span class="o">*</span><span class="n">ones_arr</span><span class="o">-</span><span class="nb">abs</span><span class="p">(</span><span class="n">w</span><span class="p">))</span>
    <span class="n">w_out</span> <span class="o">=</span> <span class="n">w_out</span><span class="o">/</span><span class="nb">abs</span><span class="p">(</span><span class="n">w_out</span><span class="p">)</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">w_out</span>

<span class="k">def</span> <span class="nf">vect_recond</span><span class="p">(</span><span class="n">w</span><span class="p">,</span><span class="n">cond_fact</span><span class="p">):</span>
    <span class="n">ind</span> <span class="o">=</span> <span class="n">where</span><span class="p">(</span><span class="n">w</span><span class="o">**</span><span class="mi">2</span><span class="o">&lt;</span><span class="n">cond_fact</span><span class="o">*</span><span class="p">(</span><span class="n">w</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">max</span><span class="p">())</span>
    <span class="n">ind2</span> <span class="o">=</span> <span class="n">where</span><span class="p">(</span><span class="n">w</span><span class="o">**</span><span class="mi">2</span><span class="o">&gt;=</span><span class="n">cond_fact</span><span class="o">*</span><span class="p">(</span><span class="n">w</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">max</span><span class="p">())</span>
    <span class="n">min_val</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">w</span><span class="p">[</span><span class="n">ind2</span><span class="p">])</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
    <span class="n">l</span> <span class="o">=</span> <span class="n">size</span><span class="p">(</span><span class="n">ind</span><span class="p">)</span>
    <span class="n">w</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span> <span class="o">=</span> <span class="n">min_val</span><span class="o">*</span><span class="n">ones</span><span class="p">((</span><span class="n">l</span><span class="p">,))</span><span class="o">*</span><span class="n">sign</span><span class="p">(</span><span class="n">w</span><span class="p">[</span><span class="n">ind</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">w</span>



<span class="sd">&quot;&quot;&quot;def fourier_interpolation(im,D):</span>

<span class="sd">    shap = im.shape</span>
<span class="sd">    im_fft = scipy_fft.fft2(im)</span>
<span class="sd">    fft_padd = zeros((shap[0]*D,shap[1]*D))&quot;&quot;&quot;</span>

<span class="k">def</span> <span class="nf">fft_stack</span><span class="p">(</span><span class="n">stack</span><span class="p">):</span>
    <span class="n">out</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">stack</span><span class="p">)</span>
    <span class="n">shap</span> <span class="o">=</span> <span class="n">stack</span><span class="o">.</span><span class="n">shape</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
        <span class="n">out</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">scipy_fft</span><span class="o">.</span><span class="n">fft2</span><span class="p">(</span><span class="n">stack</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">out</span>

<span class="k">def</span> <span class="nf">shift_phase_map</span><span class="p">(</span><span class="n">dx</span><span class="p">,</span><span class="n">dy</span><span class="p">,</span><span class="n">shap</span><span class="p">):</span>
    <span class="nb">map</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">(</span><span class="n">shap</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
            <span class="nb">map</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">exp</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">pi</span><span class="o">*</span><span class="mi">1</span><span class="n">j</span><span class="o">*</span><span class="p">(</span><span class="n">double</span><span class="p">(</span><span class="n">dx</span><span class="o">*</span><span class="n">i</span><span class="p">)</span><span class="o">/</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">double</span><span class="p">(</span><span class="n">dy</span><span class="o">*</span><span class="n">j</span><span class="p">)</span><span class="o">/</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
    <span class="k">return</span> <span class="nb">map</span>

<span class="k">def</span> <span class="nf">sing_freq_mat_lr_fourier</span><span class="p">(</span><span class="n">freq1</span><span class="p">,</span><span class="n">freq2</span><span class="p">,</span><span class="n">dx</span><span class="p">,</span><span class="n">dy</span><span class="p">,</span><span class="n">lr_shap</span><span class="p">,</span><span class="n">down_fact</span><span class="p">):</span> <span class="c1"># The input frequencies are integers indexes in the range corresponding to the lr images size</span>
    <span class="n">s</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">down_fact</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span>
    <span class="n">f1</span> <span class="o">=</span> <span class="n">exp</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">pi</span><span class="o">*</span><span class="mi">1</span><span class="n">j</span><span class="o">/</span><span class="p">(</span><span class="n">lr_shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">down_fact</span><span class="p">))</span>
    <span class="n">f2</span> <span class="o">=</span> <span class="n">exp</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">pi</span><span class="o">*</span><span class="mi">1</span><span class="n">j</span><span class="o">/</span><span class="p">(</span><span class="n">lr_shap</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">down_fact</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">D</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">D</span><span class="p">):</span>
            <span class="n">s</span><span class="p">[</span><span class="n">i</span><span class="o">*</span><span class="n">D</span><span class="o">+</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">f1</span><span class="o">**</span><span class="p">((</span><span class="n">freq1</span><span class="o">+</span><span class="n">i</span><span class="o">*</span><span class="n">lr_shap</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">*</span><span class="n">dx</span><span class="p">))</span><span class="o">*</span><span class="p">(</span><span class="n">f2</span><span class="o">**</span><span class="p">((</span><span class="n">freq2</span><span class="o">+</span><span class="n">j</span><span class="o">*</span><span class="n">lr_shap</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">*</span><span class="n">dy</span><span class="p">))</span>
    <span class="n">S</span> <span class="o">=</span> <span class="n">diag</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">S</span>


<span class="k">def</span> <span class="nf">sing_mat_stack_lr_fourier</span><span class="p">(</span><span class="n">freq1</span><span class="p">,</span><span class="n">freq2</span><span class="p">,</span><span class="n">shift_stack</span><span class="p">,</span><span class="n">lr_shap</span><span class="p">,</span><span class="n">down_fact</span><span class="p">):</span>
    <span class="n">shap</span> <span class="o">=</span> <span class="n">shift_stack</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">sing_freq_mat_stack</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">down_fact</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span><span class="n">down_fact</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
        <span class="n">sing_freq_mat_stack</span><span class="p">[:,:,</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">sing_freq_mat_lr_fourier</span><span class="p">(</span><span class="n">freq1</span><span class="p">,</span><span class="n">freq2</span><span class="p">,</span><span class="n">shift_stack</span><span class="p">[</span><span class="n">k</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span><span class="n">shift_stack</span><span class="p">[</span><span class="n">k</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span><span class="n">lr_shap</span><span class="p">,</span><span class="n">down_fact</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">sing_freq_mat_stack</span>

<span class="k">def</span> <span class="nf">fourier_dec_shift_transp_sing_freq</span><span class="p">(</span><span class="n">sing_freq_mat_stack</span><span class="p">,</span><span class="n">single_freq_fourier_stack</span><span class="p">,</span><span class="n">weights_stack</span><span class="p">):</span>
    <span class="n">shap</span> <span class="o">=</span> <span class="n">sing_freq_mat_stack</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">nb_im</span> <span class="o">=</span> <span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">D</span> <span class="o">=</span> <span class="n">sqrt</span><span class="p">(</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">ones_vect</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">D</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>
    <span class="n">g</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">D</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>
    <span class="n">v</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">D</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span><span class="n">nb_im</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_im</span><span class="p">):</span>
        <span class="n">u</span> <span class="o">=</span> <span class="n">transpose</span><span class="p">(</span><span class="n">sing_freq_mat_stack</span><span class="p">[:,:,</span><span class="n">k</span><span class="p">])</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">ones_vect</span><span class="p">)</span><span class="o">*</span><span class="n">single_freq_fourier_stack</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">*</span><span class="n">weights_stack</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
        <span class="n">v</span><span class="p">[:,</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">D</span><span class="o">**</span><span class="mi">2</span><span class="p">,))</span>
        <span class="n">g</span><span class="o">+=</span><span class="n">copy</span><span class="p">(</span><span class="n">u</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">g</span><span class="p">,</span><span class="n">v</span>

<span class="k">def</span> <span class="nf">fourier_dec_shift_transp_all_freqs</span><span class="p">(</span><span class="n">shifts_stack</span><span class="p">,</span><span class="n">lr_shap</span><span class="p">,</span><span class="n">down_fact</span><span class="p">,</span><span class="n">tfourier_stack</span><span class="p">,</span><span class="n">weights_stack</span><span class="p">):</span>
    <span class="n">shap</span> <span class="o">=</span> <span class="n">tfourier_stack</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">sing_freq_mat_stack</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">G</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">down_fact</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
    <span class="k">for</span> <span class="n">freq1</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
        <span class="k">for</span> <span class="n">freq2</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
            <span class="n">sing_freq_mat_stack_temp</span> <span class="o">=</span> <span class="n">sing_mat_stack_lr_fourier</span><span class="p">(</span><span class="n">freq1</span><span class="p">,</span><span class="n">freq2</span><span class="p">,</span><span class="n">shifts_stack</span><span class="p">,</span><span class="n">lr_shap</span><span class="p">,</span><span class="n">down_fact</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">freq1</span><span class="o">+</span><span class="n">freq2</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
                <span class="n">sing_freq_mat_stack</span> <span class="o">=</span> <span class="n">sing_freq_mat_stack_temp</span>
        <span class="n">G</span><span class="p">[:,</span><span class="n">freq1</span><span class="o">*</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">freq2</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">fourier_dec_shift_transp_sing_freq</span><span class="p">(</span><span class="n">sing_freq_mat_stack</span><span class="p">,</span><span class="n">tfourier_stack</span><span class="p">[</span><span class="n">freq1</span><span class="p">,</span><span class="n">freq2</span><span class="p">,:],</span><span class="n">weights_stack</span><span class="p">))</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">down_fact</span><span class="o">**</span><span class="mi">2</span><span class="p">,))</span>
    <span class="k">return</span> <span class="n">G</span><span class="p">,</span><span class="n">sing_freq_mat_stack</span>


<span class="k">def</span> <span class="nf">fourier_shifts_cost</span><span class="p">(</span><span class="n">G</span><span class="p">,</span><span class="n">freq0_mat_stack</span><span class="p">,</span><span class="n">weights_stack</span><span class="p">):</span>
    <span class="n">shap</span> <span class="o">=</span> <span class="n">freq0_mat_stack</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">ones_vect</span> <span class="o">=</span> <span class="n">ones</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
    <span class="n">kern_mat</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
        <span class="n">u</span> <span class="o">=</span> <span class="n">ones_vect</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">freq0_mat_stack</span><span class="p">[:,:,</span><span class="n">k</span><span class="p">])</span><span class="o">*</span><span class="n">weights_stack</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">kern_mat</span> <span class="o">+=</span> <span class="n">transpose</span><span class="p">(</span><span class="n">u</span><span class="p">)</span><span class="o">*</span><span class="n">dot</span><span class="p">(</span><span class="n">u</span><span class="p">)</span>
    <span class="n">w</span> <span class="o">=</span> <span class="n">LA</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">kern_mat</span><span class="p">)</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">G</span><span class="p">)</span>
    <span class="n">cost</span> <span class="o">=</span> <span class="n">real</span><span class="p">((</span><span class="n">w</span><span class="o">*</span><span class="n">G</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span>
    <span class="k">return</span> <span class="n">w</span><span class="p">,</span><span class="n">kern_mat</span><span class="p">,</span><span class="n">cost</span>

<span class="k">def</span> <span class="nf">convex_hull_init</span><span class="p">(</span><span class="n">X</span><span class="p">,</span><span class="n">nb_pts</span><span class="p">,</span><span class="n">proj_sphere_en</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span> <span class="c1"># Data are stored in the lines of X</span>
    <span class="n">shap</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">ind</span> <span class="o">=</span> <span class="n">array</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
    <span class="n">ret</span><span class="p">,</span><span class="n">label_ind</span><span class="p">,</span><span class="n">label</span><span class="p">,</span><span class="n">center</span> <span class="o">=</span> <span class="n">kmeans_interface</span><span class="p">(</span><span class="n">X</span><span class="p">,</span><span class="n">ind</span><span class="p">,</span><span class="n">nb_pts</span><span class="p">,</span><span class="n">nb_iter</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span><span class="n">eps</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span><span class="n">nb_attempts</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
    <span class="n">centroid</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">/</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">centroid</span> <span class="o">=</span> <span class="n">centroid</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
    <span class="k">if</span> <span class="n">proj_sphere_en</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
        <span class="n">ones_vect</span> <span class="o">=</span> <span class="n">ones</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="mi">1</span><span class="p">))</span>
        <span class="n">centroidn</span> <span class="o">=</span> <span class="n">ones_vect</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">centroid</span><span class="p">)</span>
        <span class="n">dist</span> <span class="o">=</span> <span class="p">((</span><span class="n">X</span><span class="o">-</span><span class="n">centroidn</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">sqrt</span><span class="p">(</span><span class="n">dist</span><span class="o">.</span><span class="n">max</span><span class="p">())</span>
        <span class="n">center</span> <span class="o">=</span> <span class="n">optim_utils</span><span class="o">.</span><span class="n">proj_sphere_mat</span><span class="p">(</span><span class="n">center</span><span class="p">,</span><span class="n">centroidn</span><span class="p">,</span><span class="n">r</span><span class="o">*</span><span class="n">ones_vect</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">center</span><span class="p">,</span><span class="n">centroid</span><span class="p">,</span><span class="n">label_ind</span><span class="p">,</span><span class="n">ret</span>

<span class="k">def</span> <span class="nf">convex_hull_init_2</span><span class="p">(</span><span class="n">X</span><span class="p">,</span><span class="n">nb_pts</span><span class="p">):</span>
    <span class="n">shap</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">centroid</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">/</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">centroid</span> <span class="o">=</span> <span class="n">centroid</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
    <span class="n">ones_vect</span> <span class="o">=</span> <span class="n">ones</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="mi">1</span><span class="p">))</span>
    <span class="n">centroidn</span> <span class="o">=</span> <span class="n">ones_vect</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">centroid</span><span class="p">)</span>
    <span class="n">Xcent</span> <span class="o">=</span> <span class="n">X</span><span class="o">-</span><span class="n">centroidn</span>
    <span class="n">U</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">Vt</span> <span class="o">=</span> <span class="n">linalg</span><span class="o">.</span><span class="n">svd</span><span class="p">(</span><span class="n">Xcent</span><span class="p">,</span><span class="n">full_matrices</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">coeff</span> <span class="o">=</span> <span class="n">Xcent</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">transpose</span><span class="p">(</span><span class="n">Vt</span><span class="p">))</span>
    <span class="n">S</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">nb_pts</span><span class="p">))</span>
    <span class="n">ind_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_pts</span><span class="o">/</span><span class="mi">2</span><span class="p">):</span>
        <span class="n">ind</span> <span class="o">=</span> <span class="n">argsort</span><span class="p">(</span><span class="n">coeff</span><span class="p">[</span><span class="n">k</span><span class="p">,:])</span>
        <span class="n">ind_max</span> <span class="o">=</span> <span class="n">nb_pts</span><span class="o">/</span><span class="mi">2</span><span class="o">-</span><span class="mi">1</span>
        <span class="k">while</span><span class="p">(</span><span class="n">ind</span><span class="p">[</span><span class="n">ind_max</span><span class="p">]</span> <span class="ow">in</span> <span class="n">ind_list</span><span class="p">):</span>
            <span class="n">ind_max</span> <span class="o">-=</span> <span class="mi">1</span>
        <span class="n">ind_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ind</span><span class="p">[</span><span class="n">ind_max</span><span class="p">])</span>
        <span class="n">S</span><span class="p">[:,</span><span class="mi">2</span><span class="o">*</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">X</span><span class="p">[</span><span class="n">ind</span><span class="p">[</span><span class="n">ind_max</span><span class="p">],:]</span>
        <span class="n">ind_min</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">while</span><span class="p">(</span><span class="n">ind</span><span class="p">[</span><span class="n">ind_min</span><span class="p">]</span> <span class="ow">in</span> <span class="n">ind_list</span><span class="p">):</span>
            <span class="n">ind_min</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">ind_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ind</span><span class="p">[</span><span class="n">ind_min</span><span class="p">])</span>
        <span class="n">S</span><span class="p">[:,</span><span class="mi">2</span><span class="o">*</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">X</span><span class="p">[</span><span class="n">ind</span><span class="p">[</span><span class="n">ind_min</span><span class="p">],:]</span>
    <span class="k">return</span> <span class="n">S</span><span class="p">,</span><span class="n">centroid</span>

<span class="k">def</span> <span class="nf">convex_hull_init_3</span><span class="p">(</span><span class="n">X</span><span class="p">,</span><span class="n">nb_pts</span><span class="p">,</span><span class="n">nb_frac</span><span class="o">=</span><span class="mf">0.1</span><span class="p">):</span>
    <span class="n">shap</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">part_ind</span> <span class="o">=</span> <span class="n">diffusion_partionning</span><span class="p">(</span><span class="n">X</span><span class="p">,</span><span class="n">nb_pts</span><span class="p">,</span><span class="n">nb_neigh</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">nb_frac</span><span class="o">*</span><span class="p">(</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">])))</span>
    <span class="n">S</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">nb_pts</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_pts</span><span class="p">):</span>
        <span class="n">part</span> <span class="o">=</span> <span class="n">X</span><span class="p">[</span><span class="n">part_ind</span><span class="p">[</span><span class="n">i</span><span class="p">],:]</span>
        <span class="n">S</span><span class="p">[:,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">part</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">/</span><span class="n">size</span><span class="p">(</span><span class="n">part_ind</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">S</span>

<span class="k">def</span> <span class="nf">rand_oriented_vect</span><span class="p">(</span><span class="n">V</span><span class="p">,</span><span class="n">amp</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">w</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span> <span class="c1"># Directive vectors are stored in column</span>

    <span class="n">shap</span> <span class="o">=</span> <span class="n">V</span><span class="o">.</span><span class="n">shape</span>
    <span class="k">if</span> <span class="n">w</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">w</span> <span class="o">=</span> <span class="n">ones</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="mi">1</span><span class="p">))</span>
    <span class="k">if</span>  <span class="n">amp</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">amp</span><span class="o">=</span><span class="mi">1</span>
    <span class="n">a</span> <span class="o">=</span> <span class="n">randn</span><span class="p">(</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">w</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="mi">1</span><span class="p">)))</span>
    <span class="n">u</span> <span class="o">=</span> <span class="n">V</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
    <span class="n">u</span> <span class="o">=</span> <span class="n">amp</span><span class="o">*</span><span class="n">u</span><span class="o">/</span><span class="n">sqrt</span><span class="p">(((</span><span class="n">u</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span>
    <span class="k">return</span> <span class="n">u</span>

<span class="k">def</span> <span class="nf">tg_rand_disp</span><span class="p">(</span><span class="n">o</span><span class="p">,</span><span class="n">x</span><span class="p">,</span><span class="n">sig</span><span class="p">,</span><span class="n">V</span><span class="p">,</span><span class="n">weights</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span> <span class="c1"># V is a set of column vector basis</span>
    <span class="n">n</span> <span class="o">=</span> <span class="p">(</span><span class="n">o</span><span class="o">-</span><span class="n">x</span><span class="p">)</span><span class="o">/</span><span class="n">sqrt</span><span class="p">(((</span><span class="n">o</span><span class="o">-</span><span class="n">x</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span>
    <span class="n">tgV</span> <span class="o">=</span> <span class="n">optim_utils</span><span class="o">.</span><span class="n">proj_dir</span><span class="p">(</span><span class="n">V</span><span class="p">,</span><span class="n">n</span><span class="p">)</span>
    <span class="n">disp</span> <span class="o">=</span> <span class="n">rand_oriented_vect</span><span class="p">(</span><span class="n">tgV</span><span class="p">,</span><span class="n">sig</span><span class="p">,</span><span class="n">w</span><span class="o">=</span><span class="n">weights</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">x</span><span class="o">+</span><span class="n">disp</span>

<span class="k">def</span> <span class="nf">tg_rand_disp_set</span><span class="p">(</span><span class="n">o</span><span class="p">,</span><span class="n">X</span><span class="p">,</span><span class="n">sig</span><span class="p">,</span><span class="n">V</span><span class="p">,</span><span class="n">weights</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span> <span class="c1"># X and V are sets of column vectors and sig is a vector</span>
    <span class="n">shap</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">Xdisp</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">X</span><span class="p">[:,</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="mi">1</span><span class="p">))</span>
        <span class="n">uk</span> <span class="o">=</span> <span class="n">tg_rand_disp</span><span class="p">(</span><span class="n">o</span><span class="p">,</span><span class="n">x</span><span class="p">,</span><span class="n">sig</span><span class="p">[</span><span class="n">k</span><span class="p">],</span><span class="n">V</span><span class="p">,</span><span class="n">weights</span><span class="o">=</span><span class="n">weights</span><span class="p">)</span>
        <span class="n">Xdisp</span><span class="p">[:,</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">uk</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">],))</span>
    <span class="k">return</span> <span class="n">Xdisp</span>


<span class="k">def</span> <span class="nf">norm2</span><span class="p">(</span><span class="n">u</span><span class="p">):</span>
    <span class="n">normu</span> <span class="o">=</span> <span class="n">sqrt</span><span class="p">((</span><span class="n">u</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span>
    <span class="k">return</span> <span class="n">normu</span>

<span class="k">def</span> <span class="nf">norm1</span><span class="p">(</span><span class="n">u</span><span class="p">):</span>
    <span class="n">normu</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">u</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">normu</span>

<span class="k">def</span> <span class="nf">mat_to_gnetworkx</span><span class="p">(</span><span class="n">mat</span><span class="p">):</span>
    <span class="kn">import</span> <span class="nn">networkx</span> <span class="k">as</span> <span class="nn">nx</span>
    <span class="n">FG</span><span class="o">=</span><span class="n">nx</span><span class="o">.</span><span class="n">Graph</span><span class="p">()</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">mat</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">mat</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
            <span class="n">FG</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">weight</span><span class="o">=</span><span class="n">mat</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">])</span>

    <span class="k">return</span> <span class="n">FG</span>

<span class="k">def</span> <span class="nf">gnetworkx_to_mat</span><span class="p">(</span><span class="n">FG</span><span class="p">,</span><span class="n">inf_val</span><span class="o">=</span><span class="mi">10</span><span class="o">**</span><span class="mi">32</span><span class="p">):</span>
    <span class="n">L</span> <span class="o">=</span> <span class="n">FG</span><span class="o">.</span><span class="n">number_of_nodes</span><span class="p">()</span>
    <span class="n">mat</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">L</span><span class="p">,</span><span class="n">L</span><span class="p">))</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">FG</span><span class="o">.</span><span class="n">edges</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="s1">&#39;weight&#39;</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">i</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">==</span><span class="mi">0</span> <span class="ow">and</span> <span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">!=</span><span class="n">i</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
            <span class="n">mat</span><span class="p">[</span><span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">i</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="n">inf_val</span>
            <span class="c1">#print &#39;hey!!!&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">mat</span><span class="p">[</span><span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">i</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="n">i</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">mat</span><span class="o">+=</span><span class="n">transpose</span><span class="p">(</span><span class="n">mat</span><span class="p">)</span>
    <span class="n">i</span><span class="p">,</span><span class="n">j</span> <span class="o">=</span> <span class="n">where</span><span class="p">(</span><span class="n">mat</span><span class="o">==</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">k</span> <span class="o">=</span> <span class="n">where</span><span class="p">(</span><span class="n">i</span><span class="o">-</span><span class="n">j</span><span class="o">!=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">mat</span><span class="p">[</span><span class="n">i</span><span class="p">[</span><span class="n">k</span><span class="p">],</span><span class="n">j</span><span class="p">[</span><span class="n">k</span><span class="p">]]</span> <span class="o">=</span> <span class="n">inf_val</span>
    <span class="k">return</span> <span class="n">mat</span>

<span class="c1">#def minimum_sppanning_tree_interf(dist_mat):</span>
<span class="c1">#    nx.minimum_spanning_tree(mat_to_gnetworkx(dist_mat),weight=&#39;weight&#39;)</span>



<span class="k">def</span> <span class="nf">floyd_alg</span><span class="p">(</span><span class="n">dist_mat</span><span class="p">):</span>
    <span class="n">shap</span> <span class="o">=</span> <span class="n">dist_mat</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">nb_nodes</span> <span class="o">=</span> <span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span>
    <span class="n">max_dist</span> <span class="o">=</span> <span class="n">dist_mat</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
    <span class="n">path</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
    <span class="n">geod_dist_mat</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">dist_mat</span><span class="p">)</span>
    <span class="n">a</span> <span class="o">=</span> <span class="n">array</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
    <span class="n">a</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
    <span class="n">ones_vect</span> <span class="o">=</span> <span class="n">ones</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="mi">1</span><span class="p">))</span>
    <span class="n">next_mat</span> <span class="o">=</span> <span class="n">ones_vect</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_nodes</span><span class="p">):</span>
        <span class="n">path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">list</span><span class="p">())</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
                <span class="k">if</span> <span class="n">geod_dist_mat</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">k</span><span class="p">]</span><span class="o">+</span><span class="n">geod_dist_mat</span><span class="p">[</span><span class="n">k</span><span class="p">,</span><span class="n">j</span><span class="p">]</span><span class="o">&lt;</span><span class="n">geod_dist_mat</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]:</span>
                    <span class="n">geod_dist_mat</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">geod_dist_mat</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">k</span><span class="p">]</span><span class="o">+</span><span class="n">geod_dist_mat</span><span class="p">[</span><span class="n">k</span><span class="p">,</span><span class="n">j</span><span class="p">]</span>
                    <span class="n">next_mat</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">next_mat</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">k</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">geod_dist_mat</span><span class="p">,</span><span class="n">next_mat</span>

<span class="k">def</span> <span class="nf">dijkstra_interf</span><span class="p">(</span><span class="n">dist_mat</span><span class="p">):</span>
    <span class="kn">import</span> <span class="nn">networkx</span> <span class="k">as</span> <span class="nn">nx</span>
    <span class="n">G</span> <span class="o">=</span> <span class="n">mat_to_gnetworkx</span><span class="p">(</span><span class="n">dist_mat</span><span class="p">)</span>
    <span class="n">length</span><span class="o">=</span><span class="n">nx</span><span class="o">.</span><span class="n">all_pairs_dijkstra_path_length</span><span class="p">(</span><span class="n">G</span><span class="p">)</span>
    <span class="n">geod_dist_mat</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">dist_mat</span><span class="p">)</span><span class="o">*</span><span class="mi">0</span>
    <span class="n">shap</span> <span class="o">=</span> <span class="n">dist_mat</span><span class="o">.</span><span class="n">shape</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
            <span class="n">geod_dist_mat</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">length</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span>

    <span class="n">geod_dist_mat</span><span class="o">+=</span><span class="n">transpose</span><span class="p">(</span><span class="n">geod_dist_mat</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">geod_dist_mat</span>


<span class="k">def</span> <span class="nf">prim_alg</span><span class="p">(</span><span class="n">dist_mat</span><span class="p">):</span>
    <span class="n">inf_val</span> <span class="o">=</span> <span class="mi">10</span><span class="o">**</span><span class="p">(</span><span class="mi">32</span><span class="p">)</span>
    <span class="n">shap</span> <span class="o">=</span> <span class="n">dist_mat</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">edge</span> <span class="o">=</span> <span class="n">array</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
    <span class="n">min_mat</span> <span class="o">=</span> <span class="n">inf_val</span><span class="o">*</span><span class="n">ones</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
        <span class="n">min_mat</span><span class="p">[</span><span class="n">k</span><span class="p">,</span><span class="n">k</span><span class="p">]</span><span class="o">=</span><span class="mi">0</span>
    <span class="n">a</span> <span class="o">=</span> <span class="n">edge</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    <span class="n">used_edge</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">],))</span>
    <span class="n">used_edge</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">while</span> <span class="n">a</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
        <span class="n">id1</span> <span class="o">=</span> <span class="n">where</span><span class="p">(</span><span class="n">used_edge</span><span class="o">==</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">id2</span> <span class="o">=</span> <span class="n">where</span><span class="p">(</span><span class="n">edge</span><span class="o">!=</span><span class="mi">0</span><span class="p">)</span>

        <span class="n">mat</span> <span class="o">=</span> <span class="n">dist_mat</span><span class="p">[</span><span class="n">transpose</span><span class="p">(</span><span class="n">id1</span><span class="p">),</span><span class="n">id2</span><span class="p">]</span>
        <span class="n">i</span><span class="p">,</span><span class="n">j</span> <span class="o">=</span> <span class="n">where</span><span class="p">(</span><span class="n">mat</span><span class="o">==</span><span class="n">mat</span><span class="o">.</span><span class="n">min</span><span class="p">())</span>
        <span class="n">ind1</span> <span class="o">=</span> <span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">ind2</span> <span class="o">=</span> <span class="n">j</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>


        <span class="n">min_mat</span><span class="p">[</span><span class="n">id1</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">ind1</span><span class="p">],</span><span class="n">id2</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">ind2</span><span class="p">]]</span> <span class="o">=</span> <span class="n">mat</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
        <span class="n">min_mat</span><span class="p">[</span><span class="n">id2</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">ind2</span><span class="p">],</span><span class="n">id1</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">ind1</span><span class="p">]]</span> <span class="o">=</span> <span class="n">mat</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
        <span class="n">edge</span><span class="p">[</span><span class="n">id2</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">ind2</span><span class="p">]]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">used_edge</span><span class="p">[</span><span class="n">id2</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">ind2</span><span class="p">]]</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">a</span> <span class="o">=</span> <span class="n">edge</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">min_mat</span>


<span class="k">def</span> <span class="nf">geodesic_distances</span><span class="p">(</span><span class="n">S</span><span class="p">,</span><span class="n">nb_neigh</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span><span class="n">prim_en</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">inf_val</span><span class="o">=</span><span class="mi">10</span><span class="o">**</span><span class="mi">32</span><span class="p">):</span>
    <span class="kn">import</span> <span class="nn">networkx</span> <span class="k">as</span> <span class="nn">nx</span>
    <span class="c1">#inf_val = 10**(16)</span>
    <span class="n">shap</span> <span class="o">=</span> <span class="n">S</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">dist_mat</span> <span class="o">=</span> <span class="n">inf_val</span><span class="o">*</span><span class="n">ones</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
        <span class="n">dist_mat</span><span class="p">[</span><span class="n">k</span><span class="p">,</span><span class="n">k</span><span class="p">]</span><span class="o">=</span><span class="mi">0</span>
    <span class="n">dmax</span> <span class="o">=</span> <span class="n">inf_val</span>
    <span class="n">flann</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">while</span> <span class="p">(</span><span class="n">dmax</span><span class="o">-</span><span class="n">inf_val</span><span class="p">)</span><span class="o">&gt;=</span><span class="mi">0</span><span class="p">:</span>
        <span class="n">neigh</span><span class="p">,</span><span class="n">dists</span><span class="p">,</span><span class="n">flann</span> <span class="o">=</span> <span class="n">knn_interf</span><span class="p">(</span><span class="n">S</span><span class="p">,</span><span class="n">nb_neigh</span><span class="p">,</span><span class="n">return_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_neigh</span><span class="p">):</span>
                <span class="n">dist_mat</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">neigh</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">k</span><span class="p">]]</span> <span class="o">=</span> <span class="n">dists</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">k</span><span class="p">]</span>
                <span class="n">dist_mat</span><span class="p">[</span><span class="n">neigh</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">k</span><span class="p">],</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">dists</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">k</span><span class="p">]</span>

        <span class="n">geod_dist_mat</span> <span class="o">=</span> <span class="n">dijkstra_interf</span><span class="p">(</span><span class="n">dist_mat</span><span class="p">)</span>
        <span class="n">dmax</span> <span class="o">=</span> <span class="n">geod_dist_mat</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
        <span class="n">nb_neigh</span><span class="o">+=</span><span class="mi">1</span>
        <span class="nb">print</span> <span class="s2">&quot;number neigbhor: &quot;</span><span class="p">,</span><span class="n">nb_neigh</span>
        <span class="nb">print</span> <span class="s2">&quot;max geodesic dist: &quot;</span><span class="p">,</span><span class="n">geod_dist_mat</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">prim_en</span><span class="p">:</span>
        <span class="c1">#min_mat = prim_alg(dist_mat)</span>
        <span class="n">min_mat</span> <span class="o">=</span> <span class="n">gnetworkx_to_mat</span><span class="p">(</span><span class="n">nx</span><span class="o">.</span><span class="n">minimum_spanning_tree</span><span class="p">(</span><span class="n">mat_to_gnetworkx</span><span class="p">(</span><span class="n">dist_mat</span><span class="p">),</span><span class="n">weight</span><span class="o">=</span><span class="s1">&#39;weight&#39;</span><span class="p">),</span><span class="n">inf_val</span><span class="o">=</span><span class="n">inf_val</span><span class="p">)</span>
        <span class="nb">print</span> <span class="n">min_mat</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
        <span class="n">geod_dist_mat</span> <span class="o">=</span> <span class="n">dijkstra_interf</span><span class="p">(</span><span class="n">min_mat</span><span class="p">)</span>
        <span class="n">dmax</span> <span class="o">=</span> <span class="n">geod_dist_mat</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
        <span class="nb">print</span> <span class="s2">&quot;dmax: &quot;</span><span class="p">,</span><span class="n">dmax</span>
        <span class="k">return</span> <span class="n">geod_dist_mat</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">),</span><span class="n">nb_neigh</span><span class="p">,</span><span class="n">min_mat</span><span class="p">,</span><span class="n">dist_mat</span><span class="p">,</span><span class="n">flann</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">geod_dist_mat</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">),</span><span class="n">nb_neigh</span><span class="p">,</span><span class="n">dist_mat</span><span class="p">,</span><span class="n">flann</span>

<span class="k">def</span> <span class="nf">mds</span><span class="p">(</span><span class="n">dist_matrix</span><span class="p">,</span><span class="n">nb_components</span><span class="o">=</span><span class="mi">3</span><span class="p">):</span>


    <span class="n">shap</span> <span class="o">=</span> <span class="n">dist_matrix</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">nb_components</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">nb_components</span><span class="p">)</span>
    <span class="n">gram_mat</span> <span class="o">=</span> <span class="n">gram_convert</span><span class="p">(</span><span class="n">dist_matrix</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>

    <span class="n">U</span><span class="p">,</span><span class="n">s</span><span class="p">,</span><span class="n">V</span> <span class="o">=</span> <span class="n">svd</span><span class="p">(</span><span class="n">gram_mat</span><span class="p">,</span><span class="n">full_matrices</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="c1">#w,V = sci_lin.eigh(gram_mat,eigvals=(shap[0]-nb_components,shap[0]-1))</span>

    <span class="n">embedding</span> <span class="o">=</span> <span class="n">U</span><span class="p">[:,</span><span class="mi">0</span><span class="p">:</span><span class="n">nb_components</span><span class="p">]</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">diag</span><span class="p">(</span><span class="n">sqrt</span><span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">nb_components</span><span class="p">])))</span>
    <span class="k">return</span> <span class="n">embedding</span><span class="p">,</span><span class="n">s</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">nb_components</span><span class="p">]</span>

<span class="k">def</span> <span class="nf">new_point_embedding</span><span class="p">(</span><span class="n">new_coord_mat</span><span class="p">,</span><span class="n">geod_dist_mat</span><span class="p">,</span><span class="n">flann</span><span class="p">,</span><span class="n">w</span><span class="p">,</span><span class="n">embedding</span><span class="p">):</span>
    <span class="n">result_temp</span><span class="p">,</span> <span class="n">dists_temp</span> <span class="o">=</span> <span class="n">flann</span><span class="o">.</span><span class="n">nn_index</span><span class="p">(</span><span class="n">transpose</span><span class="p">(</span><span class="n">new_coord_mat</span><span class="p">),</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">ones_vect1</span> <span class="o">=</span> <span class="n">ones</span><span class="p">((</span><span class="n">new_coord_mat</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="mi">1</span><span class="p">))</span>
    <span class="n">ones_vect2</span> <span class="o">=</span> <span class="n">ones</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span><span class="n">embedding</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
    <span class="n">temp1</span> <span class="o">=</span> <span class="n">ones_vect1</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">ones_vect2</span><span class="p">)</span><span class="o">.</span><span class="n">dot</span><span class="p">((</span><span class="n">geod_dist_mat</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="n">embedding</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">temp2</span> <span class="o">=</span> <span class="p">(</span><span class="n">dists_temp</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">new_coord_mat</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">ones_vect2</span><span class="p">)</span><span class="o">+</span><span class="n">geod_dist_mat</span><span class="p">[</span><span class="n">result_temp</span><span class="p">[:,</span><span class="mi">1</span><span class="p">],:]</span><span class="o">**</span><span class="mi">2</span>
    <span class="n">temp3</span> <span class="o">=</span> <span class="n">transpose</span><span class="p">(</span><span class="n">embedding</span><span class="p">)</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">diag</span><span class="p">(</span><span class="n">w</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span><span class="o">/</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">embedding</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
    <span class="n">new_embedding</span> <span class="o">=</span> <span class="n">transpose</span><span class="p">((</span><span class="n">temp1</span><span class="o">-</span><span class="n">temp2</span><span class="p">)</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">temp3</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">new_embedding</span>


<span class="k">def</span> <span class="nf">geodesic_distances_interf</span><span class="p">(</span><span class="n">im_stack</span><span class="p">,</span><span class="n">nb_neigh</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span><span class="n">prim_en</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="n">S</span> <span class="o">=</span> <span class="n">cube_to_mat</span><span class="p">(</span><span class="n">im_stack</span><span class="p">)</span>
    <span class="n">geod_dist_mat</span><span class="p">,</span><span class="n">next_mat</span><span class="p">,</span><span class="n">nb_neigh</span><span class="p">,</span><span class="n">min_mat</span><span class="p">,</span><span class="n">dist_mat</span><span class="p">,</span><span class="n">flann</span> <span class="o">=</span> <span class="n">geodesic_distances</span><span class="p">(</span><span class="n">S</span><span class="p">,</span><span class="n">nb_neigh</span><span class="o">=</span><span class="n">nb_neigh</span><span class="p">,</span><span class="n">prim_en</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">geod_dist_mat</span><span class="p">,</span><span class="n">next_mat</span><span class="p">,</span><span class="n">nb_neigh</span><span class="p">,</span><span class="n">min_mat</span><span class="p">,</span><span class="n">dist_mat</span>

<span class="k">def</span> <span class="nf">get_path</span><span class="p">(</span><span class="n">next_mat</span><span class="p">,</span><span class="n">id1</span><span class="p">,</span><span class="n">id2</span><span class="p">):</span>
    <span class="n">path</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
    <span class="k">while</span> <span class="n">id1</span> <span class="o">!=</span> <span class="n">id2</span><span class="p">:</span>
        <span class="n">id1</span> <span class="o">=</span> <span class="n">next_mat</span><span class="p">[</span><span class="n">id1</span><span class="p">,</span><span class="n">id2</span><span class="p">]</span>
        <span class="n">path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">id1</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">path</span>

<span class="k">def</span> <span class="nf">cube_vect_prod</span><span class="p">(</span><span class="n">cube</span><span class="p">,</span><span class="n">coeff_mat</span><span class="p">):</span> <span class="c1"># Coeff are in columns</span>
    <span class="n">shap</span> <span class="o">=</span> <span class="n">cube</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">S</span> <span class="o">=</span> <span class="n">cube_to_mat</span><span class="p">(</span><span class="n">cube</span><span class="p">)</span>
    <span class="n">out</span> <span class="o">=</span> <span class="n">transpose</span><span class="p">(</span><span class="n">transpose</span><span class="p">(</span><span class="n">S</span><span class="p">)</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">coeff_mat</span><span class="p">))</span>
    <span class="n">out_cube</span> <span class="o">=</span> <span class="n">mat_to_cube</span><span class="p">(</span><span class="n">out</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">out_cube</span>

<span class="c1">#def fourier_shifts_grad(G,freq0_mat_stack,weights_stack):</span>

<span class="k">def</span> <span class="nf">pywt_ksig_noise</span><span class="p">(</span><span class="n">sig_map</span><span class="p">,</span><span class="n">opt</span><span class="o">=</span><span class="s1">&#39;coif5&#39;</span><span class="p">,</span><span class="n">nb_scale</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">k</span><span class="o">=</span><span class="mi">4</span><span class="p">):</span>
    <span class="n">shap</span> <span class="o">=</span> <span class="n">sig_map</span><span class="o">.</span><span class="n">shape</span>
    <span class="k">if</span> <span class="n">nb_scale</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">nb_scale</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">floor</span><span class="p">(</span><span class="n">log2</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">shap</span><span class="p">))))</span>
    <span class="n">var_map</span> <span class="o">=</span> <span class="n">sig_map</span><span class="o">**</span><span class="mi">2</span>
    <span class="n">wav</span> <span class="o">=</span> <span class="n">pywt</span><span class="o">.</span><span class="n">Wavelet</span><span class="p">(</span><span class="n">opt</span><span class="p">)</span>
    <span class="n">dec_lo</span> <span class="o">=</span> <span class="n">wav</span><span class="o">.</span><span class="n">dec_lo</span>
    <span class="n">dec_high</span> <span class="o">=</span> <span class="n">wav</span><span class="o">.</span><span class="n">dec_hi</span>
    <span class="n">rec_lo</span> <span class="o">=</span> <span class="n">wav</span><span class="o">.</span><span class="n">rec_lo</span>
    <span class="n">rec_high</span> <span class="o">=</span> <span class="n">wav</span><span class="o">.</span><span class="n">rec_hi</span>
    <span class="n">dec_lo2</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">dec_lo</span><span class="p">)</span>
    <span class="n">dec_high2</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">dec_high</span><span class="p">)</span>
    <span class="n">rec_lo2</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">rec_lo</span><span class="p">)</span>
    <span class="n">rec_high2</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">rec_high</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">rec_lo</span><span class="p">)):</span>
        <span class="n">rec_lo2</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">rec_lo</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span>
        <span class="n">rec_high2</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">rec_high</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">dec_lo</span><span class="p">)):</span>
        <span class="n">dec_lo2</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">dec_lo</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span>
        <span class="n">dec_high2</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">dec_high</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span>


    <span class="n">filter_bank</span> <span class="o">=</span> <span class="p">[</span><span class="n">dec_lo2</span><span class="p">,</span><span class="n">dec_high2</span><span class="p">,</span><span class="n">rec_lo2</span><span class="p">,</span><span class="n">rec_high2</span><span class="p">]</span>
    <span class="n">myWavelet</span> <span class="o">=</span> <span class="n">pywt</span><span class="o">.</span><span class="n">Wavelet</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;myWavelet&quot;</span><span class="p">,</span> <span class="n">filter_bank</span><span class="o">=</span><span class="n">filter_bank</span><span class="p">)</span>

    <span class="n">var_map_wv</span> <span class="o">=</span> <span class="n">pywt</span><span class="o">.</span><span class="n">wavedec2</span><span class="p">(</span><span class="n">var_map</span><span class="p">,</span><span class="n">myWavelet</span><span class="p">,</span><span class="n">mode</span><span class="o">=</span><span class="s1">&#39;zpd&#39;</span><span class="p">,</span><span class="n">level</span><span class="o">=</span><span class="n">nb_scale</span><span class="p">)</span>
    <span class="n">ksig_map</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
    <span class="n">ksig_map</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">k</span><span class="o">*</span><span class="n">sqrt</span><span class="p">(</span><span class="n">var_map_wv</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_scale</span><span class="p">):</span>
        <span class="n">ksig_map</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">k</span><span class="o">*</span><span class="n">sqrt</span><span class="p">(</span><span class="n">var_map_wv</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]),</span><span class="n">k</span><span class="o">*</span><span class="n">sqrt</span><span class="p">(</span><span class="n">var_map_wv</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]),</span><span class="n">k</span><span class="o">*</span><span class="n">sqrt</span><span class="p">(</span><span class="n">var_map_wv</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">])])</span>

    <span class="k">return</span> <span class="n">ksig_map</span>

<span class="k">def</span> <span class="nf">pywt_ksig_noise_2</span><span class="p">(</span><span class="n">sig_map</span><span class="p">,</span><span class="n">opt</span><span class="o">=</span><span class="s1">&#39;coif5&#39;</span><span class="p">,</span><span class="n">nb_scale</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">k</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">nb_montecarlo</span><span class="o">=</span><span class="mi">1000</span><span class="p">):</span>
    <span class="n">shap</span> <span class="o">=</span> <span class="n">sig_map</span><span class="o">.</span><span class="n">shape</span>
    <span class="k">if</span> <span class="n">nb_scale</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">nb_scale</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">int</span><span class="p">(</span><span class="n">floor</span><span class="p">(</span><span class="n">log2</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">shap</span><span class="p">))))</span>
    <span class="n">zeros_mat</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
    <span class="n">ref_trans</span> <span class="o">=</span> <span class="n">pywt</span><span class="o">.</span><span class="n">wavedec2</span><span class="p">(</span><span class="n">zeros_mat</span><span class="p">,</span><span class="n">opt</span><span class="p">,</span><span class="n">mode</span><span class="o">=</span><span class="s1">&#39;zpd&#39;</span><span class="p">,</span><span class="n">level</span><span class="o">=</span><span class="n">nb_scale</span><span class="p">)</span>
    <span class="n">M2</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
    <span class="n">M2</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">copy</span><span class="p">(</span><span class="n">ref_trans</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
    <span class="n">Mean</span> <span class="o">=</span><span class="nb">list</span><span class="p">()</span>
    <span class="n">Mean</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">copy</span><span class="p">(</span><span class="n">ref_trans</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_scale</span><span class="p">):</span>
        <span class="n">M2</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">copy</span><span class="p">(</span><span class="n">ref_trans</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]),</span><span class="n">copy</span><span class="p">(</span><span class="n">ref_trans</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]),</span><span class="n">copy</span><span class="p">(</span><span class="n">ref_trans</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">][</span><span class="mi">2</span><span class="p">])])</span>
        <span class="n">Mean</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">copy</span><span class="p">(</span><span class="n">ref_trans</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]),</span><span class="n">copy</span><span class="p">(</span><span class="n">ref_trans</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]),</span><span class="n">copy</span><span class="p">(</span><span class="n">ref_trans</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">][</span><span class="mi">2</span><span class="p">])])</span>



    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_montecarlo</span><span class="p">):</span>

        <span class="n">randx</span> <span class="o">=</span> <span class="n">sig_map</span><span class="o">*</span><span class="n">numpy</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">pywt</span><span class="o">.</span><span class="n">wavedec2</span><span class="p">(</span><span class="n">randx</span><span class="p">,</span><span class="n">opt</span><span class="p">,</span><span class="n">mode</span><span class="o">=</span><span class="s1">&#39;zpd&#39;</span><span class="p">,</span><span class="n">level</span><span class="o">=</span><span class="n">nb_scale</span><span class="p">)</span>

        <span class="n">trans_en</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_scale</span><span class="p">):</span>
            <span class="n">trans_en</span><span class="o">+=</span><span class="nb">sum</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span>
            <span class="n">trans_en</span><span class="o">+=</span><span class="nb">sum</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span>
            <span class="n">trans_en</span><span class="o">+=</span><span class="nb">sum</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span>
        <span class="n">Delta</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="n">Delta</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">Mean</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_scale</span><span class="p">):</span>
            <span class="n">Delta</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">Mean</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span><span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">Mean</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span><span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span><span class="o">-</span><span class="n">Mean</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">][</span><span class="mi">2</span><span class="p">]])</span>
        <span class="n">Mean</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+=</span> <span class="n">Delta</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="p">(</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_scale</span><span class="p">):</span>
            <span class="n">Mean</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">+=</span><span class="n">Delta</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="p">(</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">Mean</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">+=</span><span class="n">Delta</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="p">(</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">Mean</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span><span class="o">+=</span><span class="n">Delta</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span><span class="o">/</span><span class="p">(</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">M2</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+=</span><span class="n">Delta</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">Mean</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_scale</span><span class="p">):</span>
            <span class="n">M2</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">+=</span><span class="n">Delta</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">Mean</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">M2</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">+=</span><span class="n">Delta</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">Mean</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">M2</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span><span class="o">+=</span><span class="n">Delta</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span><span class="o">-</span><span class="n">Mean</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">][</span><span class="mi">2</span><span class="p">])</span>


    <span class="n">M2</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/=</span> <span class="n">nb_montecarlo</span><span class="o">-</span><span class="mi">1</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_scale</span><span class="p">):</span>
        <span class="n">M2</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">/=</span> <span class="n">nb_montecarlo</span><span class="o">-</span><span class="mi">1</span>
        <span class="n">M2</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">/=</span> <span class="n">nb_montecarlo</span><span class="o">-</span><span class="mi">1</span>
        <span class="n">M2</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span><span class="o">/=</span> <span class="n">nb_montecarlo</span><span class="o">-</span><span class="mi">1</span>

    <span class="n">M</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
    <span class="n">M</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">k</span><span class="o">*</span><span class="n">sqrt</span><span class="p">(</span><span class="n">M2</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_scale</span><span class="p">):</span>
        <span class="n">M</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">k</span><span class="o">*</span><span class="n">sqrt</span><span class="p">(</span><span class="n">M2</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]),</span><span class="n">k</span><span class="o">*</span><span class="n">sqrt</span><span class="p">(</span><span class="n">M2</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]),</span><span class="n">k</span><span class="o">*</span><span class="n">sqrt</span><span class="p">(</span><span class="n">M2</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">][</span><span class="mi">2</span><span class="p">])])</span>

    <span class="k">return</span> <span class="n">Mean</span><span class="p">,</span><span class="n">M</span>

<span class="k">def</span> <span class="nf">pywt_stack</span><span class="p">(</span><span class="n">im</span><span class="p">,</span><span class="n">opt</span><span class="o">=</span><span class="s1">&#39;coif5&#39;</span><span class="p">,</span><span class="n">nb_scale</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="n">shap</span> <span class="o">=</span> <span class="n">im</span><span class="o">.</span><span class="n">shape</span>

    <span class="k">if</span> <span class="n">nb_scale</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">nb_scale</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">floor</span><span class="p">(</span><span class="n">log2</span><span class="p">(</span><span class="nb">min</span><span class="p">([</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">]]))))</span>
    <span class="n">coeff_wt</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
        <span class="n">coeff_wt</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pywt</span><span class="o">.</span><span class="n">wavedec2</span><span class="p">(</span><span class="n">im</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">],</span><span class="n">opt</span><span class="p">,</span><span class="n">mode</span><span class="o">=</span><span class="s1">&#39;zpd&#39;</span><span class="p">,</span><span class="n">level</span><span class="o">=</span><span class="n">nb_scale</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">coeff_wt</span>

<span class="k">def</span> <span class="nf">pywt_ksig_noise_2_stack</span><span class="p">(</span><span class="n">sig_map</span><span class="p">,</span><span class="n">opt</span><span class="o">=</span><span class="s1">&#39;coif5&#39;</span><span class="p">,</span><span class="n">nb_scale</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">k</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">nb_montecarlo</span><span class="o">=</span><span class="mi">1000</span><span class="p">):</span>
    <span class="n">M</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
    <span class="n">shap</span><span class="o">=</span><span class="n">sig_map</span><span class="o">.</span><span class="n">shape</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
        <span class="n">Mean_i</span><span class="p">,</span><span class="n">M_i</span> <span class="o">=</span> <span class="n">pywt_ksig_noise_2</span><span class="p">(</span><span class="n">sig_map</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">],</span><span class="n">opt</span><span class="o">=</span><span class="n">opt</span><span class="p">,</span><span class="n">nb_scale</span><span class="o">=</span><span class="n">nb_scale</span><span class="p">,</span><span class="n">k</span><span class="o">=</span><span class="n">k</span><span class="p">,</span><span class="n">nb_montecarlo</span><span class="o">=</span><span class="n">nb_montecarlo</span><span class="p">)</span>
        <span class="n">M</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">copy</span><span class="p">(</span><span class="n">M_i</span><span class="p">))</span>


    <span class="k">return</span> <span class="n">M</span>

<span class="k">def</span> <span class="nf">pywt_thresh</span><span class="p">(</span><span class="n">wav_coeff</span><span class="p">,</span><span class="n">ksig_map</span><span class="p">,</span><span class="n">coarse_thresh</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">thresh_type</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
    <span class="n">nb_scales</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">wav_coeff</span><span class="p">)</span>
    <span class="c1">#print len(wav_coeff),len(ksig_map)</span>
    <span class="n">wav_coeff_thresh</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">coarse_thresh</span><span class="p">:</span>
        <span class="n">wav_coeff_thresh</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">thresholding</span><span class="p">(</span><span class="n">wav_coeff</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">ksig_map</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">thresh_type</span><span class="o">=</span><span class="n">thresh_type</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">wav_coeff_thresh</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">wav_coeff</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_scales</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
        <span class="n">wav_coeff_thresh</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">thresholding</span><span class="p">(</span><span class="n">wav_coeff</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span><span class="n">ksig_map</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span><span class="n">thresh_type</span><span class="o">=</span><span class="n">thresh_type</span><span class="p">),</span><span class="n">thresholding</span><span class="p">(</span><span class="n">wav_coeff</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span><span class="n">ksig_map</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span><span class="n">thresh_type</span><span class="o">=</span><span class="n">thresh_type</span><span class="p">),</span><span class="n">thresholding</span><span class="p">(</span><span class="n">wav_coeff</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">][</span><span class="mi">2</span><span class="p">],</span><span class="n">ksig_map</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">][</span><span class="mi">2</span><span class="p">],</span><span class="n">thresh_type</span><span class="o">=</span><span class="n">thresh_type</span><span class="p">)])</span>

    <span class="k">return</span> <span class="n">wav_coeff_thresh</span>

<span class="k">def</span> <span class="nf">pywt_filter</span><span class="p">(</span><span class="n">im</span><span class="p">,</span><span class="n">sig_map</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">ksig_map</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">opt</span><span class="o">=</span><span class="s1">&#39;coif5&#39;</span><span class="p">,</span><span class="n">nb_scale</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">k</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">coarse_thresh</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">thresh_type</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
    <span class="n">shap</span> <span class="o">=</span> <span class="n">im</span><span class="o">.</span><span class="n">shape</span>
    <span class="k">if</span> <span class="n">nb_scale</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">nb_scale</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">floor</span><span class="p">(</span><span class="n">log2</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">shap</span><span class="p">))))</span>

    <span class="k">if</span> <span class="n">ksig_map</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">mean_map</span><span class="p">,</span><span class="n">ksig_map</span> <span class="o">=</span> <span class="n">pywt_ksig_noise_2</span><span class="p">(</span><span class="n">sig_map</span><span class="p">,</span><span class="n">opt</span><span class="o">=</span><span class="n">opt</span><span class="p">,</span><span class="n">nb_scale</span><span class="o">=</span><span class="n">nb_scale</span><span class="p">,</span><span class="n">k</span><span class="o">=</span><span class="n">k</span><span class="p">)</span>
    <span class="n">wav_coeff</span> <span class="o">=</span> <span class="n">pywt</span><span class="o">.</span><span class="n">wavedec2</span><span class="p">(</span><span class="n">im</span><span class="p">,</span><span class="n">opt</span><span class="p">,</span><span class="n">mode</span><span class="o">=</span><span class="s1">&#39;zpd&#39;</span><span class="p">,</span><span class="n">level</span><span class="o">=</span><span class="n">nb_scale</span><span class="p">)</span>
    <span class="n">wav_coeff_thresh</span> <span class="o">=</span> <span class="n">pywt_thresh</span><span class="p">(</span><span class="n">wav_coeff</span><span class="p">,</span><span class="n">ksig_map</span><span class="p">,</span><span class="n">coarse_thresh</span><span class="o">=</span><span class="n">coarse_thresh</span><span class="p">,</span><span class="n">thresh_type</span><span class="o">=</span><span class="n">thresh_type</span><span class="p">)</span>

    <span class="n">im_filt</span> <span class="o">=</span> <span class="n">pywt</span><span class="o">.</span><span class="n">waverec2</span><span class="p">(</span><span class="n">wav_coeff_thresh</span><span class="p">,</span> <span class="n">opt</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">im_filt</span>

<span class="k">def</span> <span class="nf">pywt_filter_stack</span><span class="p">(</span><span class="n">im</span><span class="p">,</span><span class="n">sig_map</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">ksig_map</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">opt</span><span class="o">=</span><span class="s1">&#39;coif5&#39;</span><span class="p">,</span><span class="n">nb_scale</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">k</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">coarse_thresh</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">thresh_type</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
    <span class="n">shap</span> <span class="o">=</span> <span class="n">im</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">im_filt</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">im</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
        <span class="k">if</span> <span class="n">ksig_map</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">im_filt</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">pywt_filter</span><span class="p">(</span><span class="n">im</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">],</span><span class="n">sig_map</span><span class="o">=</span><span class="n">sig_map</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">],</span><span class="n">opt</span><span class="o">=</span><span class="n">opt</span><span class="p">,</span><span class="n">nb_scale</span><span class="o">=</span><span class="n">nb_scale</span><span class="p">,</span><span class="n">k</span><span class="o">=</span><span class="n">k</span><span class="p">,</span><span class="n">coarse_thresh</span><span class="o">=</span><span class="n">coarse_thresh</span><span class="p">,</span><span class="n">thresh_type</span><span class="o">=</span><span class="n">thresh_type</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">im_filt</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">pywt_filter</span><span class="p">(</span><span class="n">im</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">],</span><span class="n">ksig_map</span><span class="o">=</span><span class="n">ksig_map</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">opt</span><span class="o">=</span><span class="n">opt</span><span class="p">,</span><span class="n">nb_scale</span><span class="o">=</span><span class="n">nb_scale</span><span class="p">,</span><span class="n">k</span><span class="o">=</span><span class="n">k</span><span class="p">,</span><span class="n">coarse_thresh</span><span class="o">=</span><span class="n">coarse_thresh</span><span class="p">,</span><span class="n">thresh_type</span><span class="o">=</span><span class="n">thresh_type</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">im_filt</span>

<span class="k">def</span> <span class="nf">pywt_perc_thresh</span><span class="p">(</span><span class="n">im</span><span class="p">,</span><span class="n">perc</span><span class="p">,</span><span class="n">opt</span><span class="o">=</span><span class="s1">&#39;coif5&#39;</span><span class="p">,</span><span class="n">thresh_type</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">nb_scale</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="n">shap</span> <span class="o">=</span> <span class="n">im</span><span class="o">.</span><span class="n">shape</span>






<span class="k">def</span> <span class="nf">distance_graph_sorting</span><span class="p">(</span><span class="n">field_pos</span><span class="p">,</span><span class="n">nb_max</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="n">shap</span> <span class="o">=</span> <span class="n">field_pos</span><span class="o">.</span><span class="n">shape</span>
    <span class="k">if</span> <span class="n">nb_max</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">nb_max</span> <span class="o">=</span> <span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">graph</span><span class="p">,</span><span class="n">dists</span> <span class="o">=</span> <span class="n">knn_interf</span><span class="p">(</span><span class="n">field_pos</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">list_ind</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
    <span class="n">i</span> <span class="o">=</span> <span class="n">ind</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">list_ind</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
    <span class="n">nb_points</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">while</span> <span class="n">nb_points</span><span class="o">&lt;</span><span class="n">nb_max</span><span class="p">:</span>
        <span class="n">nb_points</span><span class="o">+=</span><span class="mi">1</span>
        <span class="n">ref_node</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="n">candidates</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="n">l</span> <span class="o">=</span> <span class="n">size</span><span class="p">(</span><span class="n">list_ind</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">l</span><span class="p">):</span>
            <span class="n">pt</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">flag</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">while</span> <span class="n">pt</span> <span class="o">&lt;</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span> <span class="ow">and</span> <span class="n">flag</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">graph</span><span class="p">[</span><span class="n">list_ind</span><span class="p">[</span><span class="n">k</span><span class="p">],</span><span class="n">pt</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">list_ind</span><span class="p">:</span>
                    <span class="n">flag</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="n">candidates</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">graph</span><span class="p">[</span><span class="n">list_ind</span><span class="p">[</span><span class="n">k</span><span class="p">],</span><span class="n">pt</span><span class="p">])</span>
                    <span class="n">ref_node</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">list_ind</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>
                <span class="n">pt</span><span class="o">+=</span><span class="mi">1</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">size</span><span class="p">(</span><span class="n">candidates</span><span class="p">)</span>
        <span class="n">dist_min</span> <span class="o">=</span> <span class="mf">1e16</span>
        <span class="n">ind_opt</span><span class="o">=</span><span class="mi">0</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">p</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">dists</span><span class="p">[</span><span class="n">ref_node</span><span class="p">[</span><span class="n">k</span><span class="p">],</span><span class="n">candidates</span><span class="p">[</span><span class="n">k</span><span class="p">]]</span><span class="o">&lt;</span><span class="n">dist_min</span><span class="p">:</span>
                <span class="n">ind_opt</span> <span class="o">=</span> <span class="n">candidates</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
                <span class="n">dist_min</span> <span class="o">=</span> <span class="n">dists</span><span class="p">[</span><span class="n">ref_node</span><span class="p">[</span><span class="n">k</span><span class="p">],</span><span class="n">candidates</span><span class="p">[</span><span class="n">k</span><span class="p">]]</span>
        <span class="n">list_ind</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ind_opt</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">array</span><span class="p">(</span><span class="n">list_ind</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">cross_euc_distances</span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="n">histo_en</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">bins</span><span class="o">=</span><span class="mi">10</span><span class="p">):</span> <span class="c1"># Observation are in rows</span>
    <span class="n">nb_pts</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="nb">map</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">nb_pts</span><span class="p">,</span><span class="n">nb_pts</span><span class="p">))</span>
    <span class="n">hist_vect</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((((</span><span class="n">nb_pts</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="n">nb_pts</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">),))</span>
    <span class="n">inc</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_pts</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">nb_pts</span><span class="p">):</span>
            <span class="nb">map</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">sqrt</span><span class="p">(((</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">,:]</span><span class="o">-</span><span class="n">data</span><span class="p">[</span><span class="n">j</span><span class="p">,:])</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span>
            <span class="n">hist_vect</span><span class="p">[</span><span class="n">inc</span><span class="p">]</span> <span class="o">=</span> <span class="nb">map</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span>
            <span class="n">inc</span><span class="o">+=</span><span class="mi">1</span>
    <span class="nb">map</span> <span class="o">=</span> <span class="nb">map</span><span class="o">+</span><span class="n">transpose</span><span class="p">(</span><span class="nb">map</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">histo_en</span><span class="p">:</span>
        <span class="n">hist</span><span class="p">,</span><span class="n">bin_edges</span> <span class="o">=</span> <span class="n">histogram</span><span class="p">(</span><span class="n">hist_vect</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="n">bins</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">map</span><span class="p">,</span><span class="n">hist</span><span class="p">,</span><span class="n">bin_edges</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">map</span><span class="p">,</span><span class="n">hist_vect</span>



<span class="k">def</span> <span class="nf">mesh_estimation</span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="n">part_feat</span><span class="p">,</span><span class="n">emb_dim</span><span class="p">):</span> <span class="c1"># We assume that data rows are coefficients corresponding to principal compoents</span>
    <span class="kn">import</span> <span class="nn">copy</span>
    <span class="n">nb_points</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">nb_points_mesh</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">nb_points</span><span class="o">**</span><span class="p">(</span><span class="n">double</span><span class="p">(</span><span class="n">emb_dim</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="n">emb_dim</span><span class="p">))</span>
    <span class="nb">print</span> <span class="s2">&quot;Mesh size: &quot;</span><span class="p">,</span><span class="n">nb_points_mesh</span>
    <span class="n">tree</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
    <span class="n">tree</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_points</span><span class="p">))</span>
    <span class="n">tree_split</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
    <span class="n">tree_split</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">ind</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_points</span><span class="p">)</span>
    <span class="n">tree_hull</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
    <span class="n">hull3d</span> <span class="o">=</span> <span class="n">ConvexHull</span><span class="p">(</span><span class="n">data</span><span class="p">[:,</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">])</span>
    <span class="n">ind_temp</span> <span class="o">=</span> <span class="n">hull3d</span><span class="o">.</span><span class="n">vertices</span>
    <span class="c1">#hull = ConvexHull(data[ind_temp,:])</span>
    <span class="c1">#tree_hull.append(ind_temp[hull.vertices])</span>
    <span class="n">tree_hull</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ind_temp</span><span class="p">)</span>
    <span class="n">part_en</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">cur_nb_points</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">while</span> <span class="n">part_en</span><span class="p">:</span>
        <span class="n">cur_nb_points</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">new_tree</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="n">new_tree_split</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="n">new_tree_hull</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="n">l</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">tree_split</span><span class="p">)</span>
        <span class="n">part_en</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">l</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">tree_split</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
                <span class="n">data_in</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">tree</span><span class="p">[</span><span class="n">i</span><span class="p">],:]</span>
                <span class="n">part_i</span> <span class="o">=</span> <span class="n">diffusion_partionning</span><span class="p">(</span><span class="n">part_feat</span><span class="p">[</span><span class="n">tree</span><span class="p">[</span><span class="n">i</span><span class="p">]],</span><span class="mi">2</span><span class="p">,</span><span class="n">nb_neigh</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
                <span class="n">hull3d_1</span> <span class="o">=</span> <span class="n">ConvexHull</span><span class="p">(</span><span class="n">data_in</span><span class="p">[</span><span class="n">part_i</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">])</span>
                <span class="n">hull3d_2</span> <span class="o">=</span> <span class="n">ConvexHull</span><span class="p">(</span><span class="n">data_in</span><span class="p">[</span><span class="n">part_i</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">])</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">hull3d_1</span><span class="o">.</span><span class="n">vertices</span><span class="p">)</span><span class="o">==</span><span class="nb">len</span><span class="p">(</span><span class="n">part_i</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">hull3d_2</span><span class="o">.</span><span class="n">vertices</span><span class="p">)</span><span class="o">==</span><span class="nb">len</span><span class="p">(</span><span class="n">part_i</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
                    <span class="n">new_tree</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tree</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                    <span class="n">new_tree_split</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                    <span class="n">new_tree_hull</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tree_hull</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                    <span class="n">cur_nb_points</span><span class="o">+=</span><span class="nb">len</span><span class="p">(</span><span class="n">tree_hull</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">part_en</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="n">ind_temp</span> <span class="o">=</span> <span class="n">tree</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                    <span class="n">new_tree</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">array</span><span class="p">(</span><span class="n">tree</span><span class="p">[</span><span class="n">i</span><span class="p">])[</span><span class="n">part_i</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span>
                    <span class="n">new_tree</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">array</span><span class="p">(</span><span class="n">tree</span><span class="p">[</span><span class="n">i</span><span class="p">])[</span><span class="n">part_i</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">part_i</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">/</span><span class="mi">2</span><span class="o">&gt;</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
                        <span class="n">new_tree_split</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">new_tree_split</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">part_i</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">/</span><span class="mi">2</span><span class="o">&gt;</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
                        <span class="n">new_tree_split</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">new_tree_split</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                    <span class="n">ind1</span> <span class="o">=</span> <span class="n">array</span><span class="p">(</span><span class="n">tree</span><span class="p">[</span><span class="n">i</span><span class="p">])[</span><span class="n">part_i</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
                    <span class="n">ind2</span> <span class="o">=</span> <span class="n">array</span><span class="p">(</span><span class="n">tree</span><span class="p">[</span><span class="n">i</span><span class="p">])[</span><span class="n">part_i</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
                    <span class="c1">#hull_1 = ConvexHull(data[ind1[hull3d_1.vertices],0:min(len(hull3d_1.vertices)-1,data.shape[1])])</span>
                    <span class="c1">#hull_2 = ConvexHull(data[ind2[hull3d_2.vertices],0:min(len(hull3d_2.vertices)-1,data.shape[1])])</span>
                    <span class="c1">#new_tree_hull.append(ind1[hull3d_1.vertices][hull_1.vertices])</span>
                    <span class="c1">#new_tree_hull.append(ind2[hull3d_2.vertices][hull_2.vertices])</span>
                    <span class="n">new_tree_hull</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ind1</span><span class="p">[</span><span class="n">hull3d_1</span><span class="o">.</span><span class="n">vertices</span><span class="p">])</span>
                    <span class="n">new_tree_hull</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ind2</span><span class="p">[</span><span class="n">hull3d_2</span><span class="o">.</span><span class="n">vertices</span><span class="p">])</span>
                    <span class="n">cur_nb_points</span> <span class="o">=</span> <span class="n">cur_nb_points</span><span class="o">+</span><span class="nb">len</span><span class="p">(</span><span class="n">ind1</span><span class="p">[</span><span class="n">hull3d_1</span><span class="o">.</span><span class="n">vertices</span><span class="p">])</span><span class="o">+</span><span class="nb">len</span><span class="p">(</span><span class="n">ind2</span><span class="p">[</span><span class="n">hull3d_2</span><span class="o">.</span><span class="n">vertices</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">new_tree</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tree</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                <span class="n">new_tree_hull</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tree_hull</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                <span class="n">new_tree_split</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tree_split</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                <span class="n">cur_nb_points</span><span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">tree_hull</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">cur_nb_points</span> <span class="o">&gt;</span><span class="n">nb_points_mesh</span><span class="p">:</span>
                <span class="n">part_en</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">tree</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">new_tree</span><span class="p">)</span>
        <span class="n">tree_hull</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">new_tree_hull</span><span class="p">)</span>
        <span class="n">tree_split</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">new_tree_split</span><span class="p">)</span>
        <span class="nb">print</span> <span class="s2">&quot;Number of cells: &quot;</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">tree</span><span class="p">),</span><span class="s2">&quot; Number of points in the current hull: &quot;</span><span class="p">,</span><span class="n">cur_nb_points</span>

    <span class="k">return</span> <span class="n">tree</span><span class="p">,</span><span class="n">tree_hull</span>



<span class="c1"># -------------------- math utils ------------------- #</span>

<span class="k">def</span> <span class="nf">spread_func</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">a</span><span class="o">=</span><span class="mf">1.e1</span><span class="p">):</span> <span class="c1"># Increasing function from [0,1] -&gt; ]-Inf,+Inf[</span>
    <span class="k">return</span> <span class="n">a</span><span class="o">*</span><span class="p">(</span><span class="n">x</span><span class="o">-</span><span class="mf">0.5</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">sigmoid</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">a</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>

    <span class="k">return</span> <span class="mf">1.0</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">a</span><span class="o">*</span><span class="n">x</span><span class="p">))</span>

<span class="k">def</span> <span class="nf">stretch_sigmoid</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">a</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">b</span><span class="o">=</span><span class="mf">1.e1</span><span class="p">):</span>

    <span class="k">return</span> <span class="n">sigmoid</span><span class="p">(</span><span class="n">spread_func</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">a</span><span class="o">=</span><span class="n">b</span><span class="p">),</span><span class="n">a</span><span class="o">=</span><span class="n">a</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">stretch_sigmoid_arr</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">a</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">b</span><span class="o">=</span><span class="mf">1e1</span><span class="p">):</span>
    <span class="n">nb_pts</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">out</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">nb_pts</span><span class="p">,))</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_pts</span><span class="p">):</span>
        <span class="n">out</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">stretch_sigmoid</span><span class="p">(</span><span class="n">double</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">]),</span><span class="n">a</span><span class="o">=</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="o">=</span><span class="n">b</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">out</span>


<span class="k">def</span> <span class="nf">remap_arr</span><span class="p">(</span><span class="n">u</span><span class="p">,</span><span class="n">map_func</span><span class="p">,</span><span class="n">param</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">scale_fact</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">umin</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span> <span class="c1"># remap u according to map_func, which an increasing function from [-1,1] to [-1,1]</span>
    <span class="k">if</span> <span class="n">scale_fact</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">scale_fact</span> <span class="o">=</span> <span class="mf">2.0</span><span class="o">/</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">-</span><span class="n">u</span><span class="o">.</span><span class="n">min</span><span class="p">())</span>
    <span class="k">if</span> <span class="n">umin</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">umin</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
    <span class="n">u_rescale</span> <span class="o">=</span> <span class="n">scale_fact</span><span class="o">*</span><span class="p">(</span><span class="n">u</span><span class="o">-</span><span class="n">umin</span><span class="p">)</span><span class="o">-</span><span class="mf">1.0</span>
    <span class="n">u_remap</span> <span class="o">=</span> <span class="p">(</span><span class="n">map_func</span><span class="p">(</span><span class="n">u_rescale</span><span class="p">,</span><span class="n">param</span><span class="o">=</span><span class="n">param</span><span class="p">)</span><span class="o">+</span><span class="mf">1.0</span><span class="p">)</span><span class="o">/</span><span class="n">scale_fact</span><span class="o">+</span><span class="n">umin</span>
    <span class="k">return</span> <span class="n">u_remap</span><span class="p">,</span><span class="n">scale_fact</span><span class="p">,</span><span class="n">umin</span>

<span class="k">def</span> <span class="nf">root_n</span><span class="p">(</span><span class="n">u</span><span class="p">,</span><span class="n">param</span><span class="o">=</span><span class="mi">2</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">param</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">param</span> <span class="o">=</span> <span class="mi">2</span>
    <span class="k">return</span> <span class="n">sign</span><span class="p">(</span><span class="n">u</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">u</span><span class="p">)</span><span class="o">**</span><span class="p">(</span><span class="mf">1.</span><span class="o">/</span><span class="n">param</span><span class="p">))</span>

<span class="k">def</span> <span class="nf">inv_root_n</span><span class="p">(</span><span class="n">u</span><span class="p">,</span><span class="n">param</span><span class="o">=</span><span class="mi">2</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">param</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">param</span> <span class="o">=</span> <span class="mi">2</span>
    <span class="k">return</span> <span class="n">sign</span><span class="p">(</span><span class="n">u</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">u</span><span class="p">)</span><span class="o">**</span><span class="n">param</span><span class="p">)</span>



<span class="k">def</span> <span class="nf">ring_detect</span><span class="p">(</span><span class="n">psf</span><span class="p">,</span><span class="n">r_init</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>

    <span class="n">psf_out</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">psf</span><span class="p">)</span>
    <span class="n">i</span><span class="p">,</span><span class="n">j</span> <span class="o">=</span> <span class="n">where</span><span class="p">(</span><span class="n">psf</span><span class="o">==</span><span class="n">psf</span><span class="o">.</span><span class="n">max</span><span class="p">())</span>
    <span class="n">lin_x</span> <span class="o">=</span> <span class="n">psf</span><span class="p">[</span><span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">],:]</span>
    <span class="n">lin_x_der</span> <span class="o">=</span> <span class="n">lin_x</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">lin_x</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
    <span class="n">lin_y</span> <span class="o">=</span> <span class="n">psf</span><span class="p">[:,</span><span class="n">j</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
    <span class="n">lin_y_der</span> <span class="o">=</span> <span class="n">lin_y</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">lin_y</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>

    <span class="n">r1</span> <span class="o">=</span> <span class="n">where</span><span class="p">(</span><span class="n">lin_x_der</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">j</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">r1</span> <span class="o">=</span> <span class="n">j</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">r1</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

    <span class="n">r2</span> <span class="o">=</span> <span class="n">where</span><span class="p">(</span><span class="n">lin_x_der</span><span class="p">[</span><span class="n">j</span><span class="p">[</span><span class="mi">0</span><span class="p">]:]</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">r2</span> <span class="o">=</span> <span class="n">r2</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>

    <span class="n">r3</span> <span class="o">=</span> <span class="n">where</span><span class="p">(</span><span class="n">lin_y_der</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">r3</span> <span class="o">=</span> <span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">r3</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

    <span class="n">r4</span> <span class="o">=</span> <span class="n">where</span><span class="p">(</span><span class="n">lin_y_der</span><span class="p">[</span><span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">]:]</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">r4</span> <span class="o">=</span> <span class="n">r4</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>


    <span class="n">r</span> <span class="o">=</span> <span class="n">mean</span><span class="p">([</span><span class="n">r1</span><span class="p">,</span><span class="n">r2</span><span class="p">,</span><span class="n">r3</span><span class="p">,</span><span class="n">r4</span><span class="p">])</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">r</span><span class="p">,</span><span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">r</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">j</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">r</span><span class="p">,</span><span class="n">j</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">r</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">sqrt</span><span class="p">((</span><span class="n">k</span><span class="o">-</span><span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="p">(</span><span class="n">l</span><span class="o">-</span><span class="n">j</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">&lt;=</span><span class="n">r</span><span class="p">:</span>
                <span class="n">psf_out</span><span class="p">[</span><span class="n">k</span><span class="p">,</span><span class="n">l</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">return</span> <span class="n">psf_out</span><span class="p">,</span><span class="n">r</span>

<span class="k">def</span> <span class="nf">hist</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">nb_bins</span><span class="o">=</span><span class="mi">100</span><span class="p">):</span>
    <span class="n">vect</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">size</span><span class="p">(</span><span class="n">x</span><span class="p">),))</span>
    <span class="n">hist</span><span class="p">,</span><span class="n">interv</span> <span class="o">=</span> <span class="n">histogram</span><span class="p">(</span><span class="n">vect</span><span class="p">,</span><span class="n">bins</span><span class="o">=</span><span class="n">nb_bins</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">hist</span><span class="p">,</span><span class="n">interv</span>

<span class="k">def</span> <span class="nf">gen_template</span><span class="p">(</span><span class="n">hist</span><span class="p">,</span><span class="n">interv</span><span class="p">,</span><span class="n">nb_points</span><span class="p">):</span>

    <span class="n">norm_hist</span> <span class="o">=</span> <span class="p">(</span><span class="n">double</span><span class="p">(</span><span class="n">nb_points</span><span class="p">)</span><span class="o">/</span><span class="n">hist</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span><span class="o">*</span><span class="n">hist</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">double</span><span class="p">)</span>
    <span class="n">norm_hist</span> <span class="o">=</span> <span class="n">norm_hist</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

    <span class="n">norm_hist</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="n">nb_points</span><span class="o">-</span><span class="n">norm_hist</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    <span class="n">output</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">nb_points</span><span class="p">))</span>
    <span class="n">pt</span><span class="o">=</span><span class="mi">0</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">norm_hist</span><span class="p">)):</span>
        <span class="n">output</span><span class="p">[</span><span class="n">pt</span><span class="p">:</span><span class="n">pt</span><span class="o">+</span><span class="n">norm_hist</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">=</span> <span class="p">(</span><span class="n">interv</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">interv</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="o">*</span><span class="n">array</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">norm_hist</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span><span class="o">/</span><span class="p">(</span><span class="n">norm_hist</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">interv</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">pt</span><span class="o">+=</span><span class="n">norm_hist</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">output</span>



<span class="k">def</span> <span class="nf">l2_exp</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">r</span><span class="p">,</span><span class="n">b</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">c</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span> <span class="c1"># f(x) = x**2 if |x|&lt;r, f(x) = exp(a*x**2)+b*x**2+c otherwise; b and c are chosen so that f is continuous and differentiable</span>

    <span class="k">if</span> <span class="n">b</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">b</span> <span class="o">=</span> <span class="mi">1</span><span class="o">-</span><span class="n">a</span><span class="o">*</span><span class="n">exp</span><span class="p">(</span><span class="n">a</span><span class="o">*</span><span class="n">r</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">c</span> <span class="o">=</span> <span class="p">(</span><span class="n">r</span><span class="o">**</span><span class="mi">2</span> <span class="o">-</span> <span class="mi">1</span><span class="o">/</span><span class="n">a</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">b</span><span class="p">)</span>

    <span class="n">output</span> <span class="o">=</span> <span class="n">x</span><span class="o">*</span><span class="mi">0</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">shape</span><span class="p">(</span><span class="n">x</span><span class="p">))</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">&lt;</span><span class="n">r</span><span class="p">:</span>
            <span class="n">output</span> <span class="o">=</span> <span class="n">x</span><span class="o">**</span><span class="mi">2</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">output</span> <span class="o">=</span> <span class="n">exp</span><span class="p">(</span><span class="n">a</span><span class="o">*</span><span class="n">x</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">+</span><span class="n">b</span><span class="o">*</span><span class="n">x</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="n">c</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">il2</span> <span class="o">=</span> <span class="n">where</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">&lt;</span><span class="n">r</span><span class="p">)</span>
        <span class="n">iexp</span> <span class="o">=</span> <span class="n">where</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">&gt;=</span><span class="n">r</span><span class="p">)</span>
        <span class="n">output</span><span class="p">[</span><span class="n">il2</span><span class="p">]</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="n">il2</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span>
        <span class="n">output</span><span class="p">[</span><span class="n">iexp</span><span class="p">]</span> <span class="o">=</span> <span class="n">exp</span><span class="p">(</span><span class="n">a</span><span class="o">*</span><span class="n">x</span><span class="p">[</span><span class="n">iexp</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">+</span><span class="n">b</span><span class="o">*</span><span class="n">x</span><span class="p">[</span><span class="n">iexp</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="n">c</span>

    <span class="k">return</span> <span class="n">output</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">c</span>

<span class="k">def</span> <span class="nf">log_norm</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">u</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span><span class="n">min_val</span> <span class="o">=</span> <span class="mf">1e-16</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">a</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
        <span class="n">a</span> <span class="o">=</span> <span class="n">min_val</span>
    <span class="k">if</span> <span class="n">b</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
        <span class="n">b</span> <span class="o">=</span> <span class="n">min_val</span>
    <span class="k">return</span> <span class="n">log</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">a</span><span class="o">/</span><span class="n">b</span><span class="p">),</span><span class="nb">abs</span><span class="p">(</span><span class="n">b</span><span class="o">/</span><span class="n">a</span><span class="p">)))</span><span class="o">/</span><span class="n">log</span><span class="p">(</span><span class="n">u</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">quantizer</span><span class="p">(</span><span class="n">im</span><span class="p">,</span><span class="n">nb_levels</span><span class="p">,</span><span class="n">log_en</span> <span class="o">=</span> <span class="kc">True</span><span class="p">):</span>
    <span class="n">im_out</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">log_en</span><span class="p">:</span>
        <span class="n">im_out</span> <span class="o">=</span> <span class="n">log</span><span class="p">(</span><span class="n">copy</span><span class="p">(</span><span class="n">im</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">im_out</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">im</span><span class="p">)</span>
    <span class="n">im_out</span> <span class="o">/=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">im_out</span><span class="p">)</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
    <span class="n">im_out</span> <span class="o">=</span> <span class="n">floor</span><span class="p">(</span><span class="n">nb_levels</span><span class="o">*</span><span class="n">im_out</span><span class="p">)</span><span class="o">/</span><span class="n">nb_levels</span>
    <span class="k">if</span> <span class="n">log_en</span><span class="p">:</span>
        <span class="n">im_out</span> <span class="o">=</span> <span class="n">exp</span><span class="p">(</span><span class="n">im_out</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">im_out</span>

<span class="k">def</span> <span class="nf">distances_mat</span><span class="p">(</span><span class="n">data</span><span class="p">):</span> <span class="c1"># Samples are stored in the rows</span>
    <span class="kn">from</span> <span class="nn">numpy</span> <span class="k">import</span> <span class="n">ones</span><span class="p">,</span><span class="n">transpose</span>
    <span class="n">nb_samp</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">norm2_vect</span> <span class="o">=</span> <span class="p">((</span><span class="n">data</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">nb_samp</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>
    <span class="n">ones_vect</span> <span class="o">=</span> <span class="n">ones</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span><span class="n">nb_samp</span><span class="p">))</span>
    <span class="n">norm2_mat</span> <span class="o">=</span> <span class="n">norm2_vect</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">ones_vect</span><span class="p">)</span>
    <span class="n">dot_prod_mat</span> <span class="o">=</span> <span class="n">transpose</span><span class="p">(</span><span class="n">data</span><span class="p">)</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">norm2_mat</span><span class="o">+</span><span class="n">transpose</span><span class="p">(</span><span class="n">norm2_mat</span><span class="p">)</span><span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">dot_prod_mat</span>


<span class="k">def</span> <span class="nf">bar_coord2d</span><span class="p">(</span><span class="n">obs</span><span class="p">,</span><span class="n">target</span><span class="p">,</span><span class="n">cond</span><span class="o">=</span><span class="mf">1.</span><span class="o">/</span><span class="mi">50</span><span class="p">,</span><span class="n">acc</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="kn">from</span> <span class="nn">numpy</span> <span class="k">import</span> <span class="n">array</span><span class="p">,</span><span class="n">ones</span>
    <span class="kn">from</span> <span class="nn">numpy.linalg</span> <span class="k">import</span> <span class="n">lstsq</span><span class="p">,</span><span class="n">norm</span>
    <span class="n">shap</span> <span class="o">=</span> <span class="n">obs</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">mat</span> <span class="o">=</span> <span class="n">ones</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
        <span class="n">mat</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">obs</span><span class="p">[</span><span class="n">i</span><span class="p">,:]</span>

    <span class="n">y</span> <span class="o">=</span> <span class="n">ones</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">,))</span>
    <span class="n">y</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">=</span> <span class="n">target</span>
    <span class="n">w</span> <span class="o">=</span> <span class="n">lstsq</span><span class="p">(</span><span class="n">mat</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">rcond</span><span class="o">=</span><span class="n">cond</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">acc</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">w</span><span class="p">,</span><span class="mi">100</span><span class="o">*</span><span class="n">norm</span><span class="p">(</span><span class="n">mat</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">w</span><span class="p">)</span><span class="o">-</span><span class="n">y</span><span class="p">)</span><span class="o">/</span><span class="n">norm</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">w</span>


<span class="k">def</span> <span class="nf">poly_val</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">deg</span><span class="p">):</span>
    <span class="n">nb_monomials</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="n">deg</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span> <span class="n">double</span><span class="p">(</span><span class="n">deg</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">))</span>
    <span class="n">coeff_vect</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">nb_monomials</span><span class="p">,))</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">deg</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
        <span class="n">coeff_vect</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">x</span><span class="o">**</span><span class="n">i</span>
    <span class="n">count</span> <span class="o">=</span> <span class="n">deg</span><span class="o">+</span><span class="mi">1</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">deg</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">deg</span><span class="o">-</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
            <span class="n">coeff_vect</span><span class="p">[</span><span class="n">count</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span><span class="o">**</span><span class="n">j</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">y</span><span class="o">**</span><span class="n">i</span><span class="p">)</span>
            <span class="n">count</span> <span class="o">+=</span><span class="mi">1</span>
    <span class="k">return</span> <span class="n">coeff_vect</span><span class="p">,</span><span class="n">nb_monomials</span>


<span class="k">def</span> <span class="nf">eval_vect_poly</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">s</span><span class="p">,</span><span class="n">deg</span><span class="p">):</span>

    <span class="n">coeff</span><span class="p">,</span><span class="n">nb_monomials</span> <span class="o">=</span> <span class="n">poly_val</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">deg</span><span class="p">)</span>

    <span class="k">return</span> <span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">coeff</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">nb_monomials</span><span class="p">,</span><span class="mi">1</span><span class="p">))))</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">s</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],))</span>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper"><div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../index.html">Documentation overview</a><ul>
  <li><a href="index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2018, Fred Ngolè, Morgan A Schmitz, Rebeca Araripe, Jean-Luc Starck.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 1.7.5</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.7</a>
      
    </div>

    

    
  </body>
</html>