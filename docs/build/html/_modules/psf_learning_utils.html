
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>psf_learning_utils &#8212; LambdaRCA 0.0 documentation</title>
    <link rel="stylesheet" href="../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
   
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for psf_learning_utils</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">gc</span>
<span class="kn">import</span> <span class="nn">utils</span>
<span class="kn">import</span> <span class="nn">optim_utils</span>
<span class="kn">from</span> <span class="nn">numpy</span> <span class="k">import</span> <span class="o">*</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">scipy.interpolate</span> <span class="k">import</span> <span class="n">Rbf</span>
<span class="kn">from</span> <span class="nn">scipy.fftpack</span> <span class="k">import</span> <span class="n">dct</span><span class="p">,</span><span class="n">idct</span>
<span class="kn">import</span> <span class="nn">scipy.signal</span> <span class="k">as</span> <span class="nn">scisig</span>
<span class="kn">from</span> <span class="nn">utils</span> <span class="k">import</span> <span class="n">bar_coord2d</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;../../Github/python_lib/python/psf&#39;</span><span class="p">)</span>
<span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;../utilities&#39;</span><span class="p">)</span>
<span class="kn">import</span> <span class="nn">isap</span>
<span class="kn">from</span> <span class="nn">numpy.random</span> <span class="k">import</span> <span class="n">randn</span>


<span class="k">def</span> <span class="nf">stack_wavelets_transform</span><span class="p">(</span><span class="n">stack</span><span class="p">,</span><span class="n">opt</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;-t2&#39;</span><span class="p">,</span><span class="s1">&#39;-n2&#39;</span><span class="p">],</span><span class="n">kmad</span><span class="o">=</span><span class="mi">5</span><span class="p">):</span>
    <span class="kn">from</span> <span class="nn">scipy.signal</span> <span class="k">import</span> <span class="n">fftconvolve</span>
    <span class="kn">from</span> <span class="nn">wavelet</span> <span class="k">import</span> <span class="n">get_mr_filters</span>
    <span class="kn">from</span> <span class="nn">utils</span> <span class="k">import</span> <span class="n">mad</span><span class="p">,</span><span class="n">thresholding_3D</span>
    <span class="kn">from</span> <span class="nn">numpy</span> <span class="k">import</span> <span class="n">ones</span>
    <span class="n">shap</span> <span class="o">=</span> <span class="n">stack</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">filters</span> <span class="o">=</span> <span class="n">get_mr_filters</span><span class="p">(</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">],</span> <span class="n">levels</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">opt</span><span class="o">=</span><span class="n">opt</span><span class="p">,</span> <span class="n">course</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">output</span> <span class="o">=</span> <span class="n">stack</span><span class="o">*</span><span class="mi">0</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
        <span class="n">output</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">fftconvolve</span><span class="p">(</span><span class="n">stack</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">],</span><span class="n">filters</span><span class="p">[</span><span class="mi">0</span><span class="p">,:,:],</span><span class="n">mode</span><span class="o">=</span><span class="s1">&#39;same&#39;</span><span class="p">)</span>

    <span class="n">mad_data</span> <span class="o">=</span> <span class="n">mad</span><span class="p">(</span><span class="n">output</span><span class="p">)</span>
    <span class="n">output</span> <span class="o">=</span> <span class="n">thresholding_3D</span><span class="p">(</span><span class="n">output</span><span class="p">,</span><span class="n">ones</span><span class="p">(</span><span class="n">shap</span><span class="p">)</span><span class="o">*</span><span class="n">kmad</span><span class="o">*</span><span class="n">mad_data</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">output</span>

<span class="k">def</span> <span class="nf">data_shaping</span><span class="p">(</span><span class="n">psf_arr</span><span class="p">,</span><span class="n">coord</span><span class="p">):</span>
    <span class="n">n1</span> <span class="o">=</span> <span class="n">psf_arr</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">n2</span> <span class="o">=</span> <span class="n">psf_arr</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">n3</span> <span class="o">=</span> <span class="n">psf_arr</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">mat_learning</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">n3</span><span class="p">,</span><span class="n">n1</span><span class="o">*</span><span class="n">n2</span><span class="o">+</span><span class="mi">2</span><span class="p">))</span>
    <span class="n">i</span><span class="o">=</span><span class="mi">0</span>
    <span class="c1">#coordx = coord[:,0]</span>
    <span class="c1">#coordy = coord[:,1]</span>
    <span class="c1">#coordx = (coordx-coordx.min())/(coordx.max()-coordx.min())</span>
    <span class="c1">#coordy = (coordy-coordy.min())/(coordy.max()-coordy.min())</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">n3</span><span class="p">):</span>
        <span class="n">psf_i</span> <span class="o">=</span> <span class="n">psf_arr</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">]</span>
        <span class="n">mat_learning</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">0</span><span class="p">:</span><span class="n">n1</span><span class="o">*</span><span class="n">n2</span><span class="p">]</span> <span class="o">=</span> <span class="n">psf_i</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">n1</span><span class="o">*</span><span class="n">n2</span><span class="p">)</span><span class="c1">#/abs(psf_i.max())</span>
        <span class="n">mat_learning</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">n1</span><span class="o">*</span><span class="n">n2</span><span class="p">]</span> <span class="o">=</span> <span class="n">coord</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">mat_learning</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">n1</span><span class="o">*</span><span class="n">n2</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">coord</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">mat_learning</span>

<span class="k">def</span> <span class="nf">data_shaping_2</span><span class="p">(</span><span class="n">psf_arr</span><span class="p">,</span><span class="n">coord</span><span class="p">,</span><span class="n">scaling_fact</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
    <span class="n">n1</span> <span class="o">=</span> <span class="n">psf_arr</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">n2</span> <span class="o">=</span> <span class="n">psf_arr</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">n3</span> <span class="o">=</span> <span class="n">psf_arr</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">mat_learning</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">n3</span><span class="p">,</span><span class="n">n1</span><span class="o">*</span><span class="n">n2</span><span class="o">+</span><span class="mi">2</span><span class="p">))</span>

    <span class="n">i</span><span class="o">=</span><span class="mi">0</span>
    <span class="n">norm_mean</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">n3</span><span class="p">):</span>
        <span class="n">psf_i</span> <span class="o">=</span> <span class="n">psf_arr</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">]</span>
        <span class="n">norm_mean</span><span class="o">+=</span><span class="n">sqrt</span><span class="p">((</span><span class="n">psf_i</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span>
        <span class="n">mat_learning</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">0</span><span class="p">:</span><span class="n">n1</span><span class="o">*</span><span class="n">n2</span><span class="p">]</span> <span class="o">=</span> <span class="n">psf_i</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">n1</span><span class="o">*</span><span class="n">n2</span><span class="p">)</span>
        <span class="n">mat_learning</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">n1</span><span class="o">*</span><span class="n">n2</span><span class="p">]</span> <span class="o">=</span> <span class="n">coord</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">mat_learning</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">n1</span><span class="o">*</span><span class="n">n2</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">coord</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">norm_mean</span> <span class="o">/=</span><span class="n">n3</span>
    <span class="n">range_coord</span> <span class="o">=</span> <span class="n">sqrt</span><span class="p">((</span><span class="n">coord</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span><span class="o">-</span><span class="n">coord</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">())</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="p">(</span><span class="n">coord</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span><span class="o">-</span><span class="n">coord</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">())</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">scal_fact</span> <span class="o">=</span> <span class="n">norm_mean</span><span class="o">*</span><span class="n">scaling_fact</span><span class="o">/</span><span class="n">range_coord</span>
    <span class="n">mat_learning</span><span class="p">[:,</span><span class="n">n1</span><span class="o">*</span><span class="n">n2</span><span class="p">:]</span> <span class="o">=</span> <span class="n">mat_learning</span><span class="p">[:,</span><span class="n">n1</span><span class="o">*</span><span class="n">n2</span><span class="p">:]</span><span class="o">*</span><span class="n">scal_fact</span>

    <span class="k">return</span> <span class="n">mat_learning</span><span class="p">,</span><span class="n">scal_fact</span>


<span class="k">def</span> <span class="nf">data_shaping_lack</span><span class="p">(</span><span class="n">psf_arr</span><span class="p">,</span><span class="n">coord</span><span class="p">,</span><span class="n">n</span><span class="p">):</span>
    <span class="n">psf_arr_lack</span><span class="p">,</span><span class="n">ind_rm</span><span class="p">,</span><span class="n">ind_kpt</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">cube_sampling</span><span class="p">(</span><span class="n">psf_arr</span><span class="p">,</span><span class="n">n</span><span class="p">)</span>
    <span class="n">coord_lack</span> <span class="o">=</span> <span class="n">coord</span><span class="p">[</span><span class="n">ind_kpt</span><span class="p">,:]</span>
    <span class="n">mat_learning</span> <span class="o">=</span> <span class="n">data_shaping</span><span class="p">(</span><span class="n">psf_arr_lack</span><span class="p">,</span><span class="n">coord_lack</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">mat_learning</span><span class="p">,</span><span class="n">ind_rm</span><span class="p">,</span><span class="n">ind_kpt</span>

<span class="k">def</span> <span class="nf">interp_field_surf</span><span class="p">(</span><span class="n">cells_means</span><span class="p">,</span><span class="nb">dict</span><span class="p">,</span><span class="n">posxy</span><span class="p">):</span>
    <span class="n">nb_cell</span> <span class="o">=</span> <span class="n">cells_means</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">n</span> <span class="o">=</span> <span class="n">cells_means</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">distxy</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">nb_cell</span><span class="p">,))</span>
    <span class="n">i</span><span class="o">=</span><span class="mi">0</span>
    <span class="n">ind</span><span class="o">=</span><span class="mi">0</span>
    <span class="n">min_val</span> <span class="o">=</span> <span class="mf">1e14</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_cell</span><span class="p">):</span>
        <span class="n">distxy</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">sqrt</span><span class="p">((</span><span class="n">cells_means</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">n</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span><span class="o">-</span><span class="n">posxy</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="p">(</span><span class="n">cells_means</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">n</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">posxy</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">distxy</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">&lt;</span><span class="n">min_val</span><span class="p">:</span>
            <span class="n">min_val</span> <span class="o">=</span> <span class="n">distxy</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">ind</span> <span class="o">=</span> <span class="n">i</span>
    <span class="n">O</span> <span class="o">=</span> <span class="n">cells_means</span><span class="p">[</span><span class="n">ind</span><span class="p">,:]</span>
    <span class="n">n1</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">[:,</span><span class="mi">0</span><span class="p">,</span><span class="n">ind</span><span class="p">]</span>
    <span class="n">n2</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">[:,</span><span class="mi">1</span><span class="p">,</span><span class="n">ind</span><span class="p">]</span>
    <span class="n">interp_val</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">affine_surf_eval</span><span class="p">(</span><span class="n">O</span><span class="p">,</span><span class="n">n1</span><span class="p">,</span><span class="n">n2</span><span class="p">,</span><span class="n">posxy</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">posxy</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">interp_val</span> <span class="o">=</span> <span class="n">interp_val</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">n</span><span class="p">)</span>
    <span class="n">output</span> <span class="o">=</span> <span class="n">interp_val</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">:</span><span class="n">n</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">pos_err</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">array</span><span class="p">([</span><span class="n">interp_val</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">n</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span><span class="o">-</span><span class="n">posxy</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">interp_val</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">n</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">posxy</span><span class="p">[</span><span class="mi">1</span><span class="p">]]))</span>
    <span class="k">return</span> <span class="n">output</span><span class="p">,</span><span class="n">pos_err</span>

<span class="k">def</span> <span class="nf">interp_field_surf_arr</span><span class="p">(</span><span class="n">cells_means</span><span class="p">,</span><span class="nb">dict</span><span class="p">,</span><span class="n">posxy_arr</span><span class="p">,</span><span class="n">n1</span><span class="p">,</span><span class="n">n2</span><span class="p">):</span>
    <span class="n">nb_psf</span> <span class="o">=</span> <span class="n">posxy_arr</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">psf_interp</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">n1</span><span class="p">,</span><span class="n">n2</span><span class="p">,</span><span class="n">nb_psf</span><span class="p">))</span>
    <span class="n">i</span><span class="o">=</span><span class="mi">0</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_psf</span><span class="p">):</span>
        <span class="n">posxy</span> <span class="o">=</span> <span class="n">posxy_arr</span><span class="p">[</span><span class="n">i</span><span class="p">,:]</span>
        <span class="n">psf_interp_i</span><span class="p">,</span><span class="n">pos_erri</span> <span class="o">=</span> <span class="n">interp_field_surf</span><span class="p">(</span><span class="n">cells_means</span><span class="p">,</span><span class="nb">dict</span><span class="p">,</span><span class="n">posxy</span><span class="p">)</span>
        <span class="n">psf_interp</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">psf_interp_i</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">n1</span><span class="p">,</span><span class="n">n2</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">psf_interp</span>

<span class="k">def</span> <span class="nf">interp_field_surf_err</span><span class="p">(</span><span class="n">psf_field</span><span class="p">,</span><span class="n">dico</span><span class="p">,</span><span class="n">cells_means</span><span class="p">,</span><span class="n">ell_theta</span><span class="p">,</span><span class="n">posxy</span><span class="p">,</span><span class="n">ind_rmv</span><span class="p">):</span>
    <span class="n">pos_in</span> <span class="o">=</span> <span class="n">posxy</span><span class="p">[</span><span class="n">ind_rmv</span><span class="p">,:]</span>

    <span class="n">n1</span> <span class="o">=</span> <span class="n">psf_field</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">n2</span> <span class="o">=</span> <span class="n">psf_field</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">psf_interp</span> <span class="o">=</span> <span class="n">interp_field_surf_arr</span><span class="p">(</span><span class="n">cells_means</span><span class="p">,</span><span class="n">dico</span><span class="p">,</span><span class="n">pos_in</span><span class="p">,</span><span class="n">n1</span><span class="p">,</span><span class="n">n2</span><span class="p">)</span>
    <span class="n">ell_interp</span><span class="p">,</span><span class="n">theta_interp</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">mk_ellipticity_arr</span><span class="p">(</span><span class="n">psf_interp</span><span class="p">,</span><span class="mf">1e6</span><span class="p">,</span><span class="n">niter_cent</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">nb_interp</span> <span class="o">=</span> <span class="n">ind_rmv</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">mse</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">nb_interp</span><span class="p">,))</span>
    <span class="n">error_map</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">n1</span><span class="p">,</span><span class="n">n2</span><span class="p">,</span><span class="n">nb_interp</span><span class="p">))</span>
    <span class="n">error_ell_theta</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">nb_interp</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span>
    <span class="n">rerror_ell_theta</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">nb_interp</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span>
    <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_interp</span><span class="p">):</span>
        <span class="n">error_map</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">psf_interp</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">]</span><span class="o">-</span><span class="n">psf_field</span><span class="p">[:,:,</span><span class="n">ind_rmv</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span>
        <span class="n">mse</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">error_map</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="n">error_ell_theta</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">ell_theta</span><span class="p">[</span><span class="n">ind_rmv</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">ell_interp</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">error_ell_theta</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">ell_theta</span><span class="p">[</span><span class="n">ind_rmv</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">ell_interp</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">error_ell_theta</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">ell_theta</span><span class="p">[</span><span class="n">ind_rmv</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="mi">2</span><span class="p">]</span><span class="o">-</span><span class="n">theta_interp</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        <span class="n">rerror_ell_theta</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">100</span><span class="o">*</span><span class="n">error_ell_theta</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="nb">abs</span><span class="p">(</span><span class="n">ell_theta</span><span class="p">[</span><span class="n">ind_rmv</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">rerror_ell_theta</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">100</span><span class="o">*</span><span class="n">error_ell_theta</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="nb">abs</span><span class="p">(</span><span class="n">ell_theta</span><span class="p">[</span><span class="n">ind_rmv</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">rerror_ell_theta</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">100</span><span class="o">*</span><span class="n">error_ell_theta</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span><span class="o">/</span><span class="nb">abs</span><span class="p">(</span><span class="n">ell_theta</span><span class="p">[</span><span class="n">ind_rmv</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="mi">1</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">psf_interp</span><span class="p">,</span><span class="n">error_map</span><span class="p">,</span><span class="n">mse</span><span class="p">,</span><span class="n">ell_interp</span><span class="p">,</span><span class="n">theta_interp</span><span class="p">,</span><span class="n">error_ell_theta</span><span class="p">,</span><span class="n">rerror_ell_theta</span>

<span class="k">def</span> <span class="nf">interp_field_inv_weight_pca</span><span class="p">(</span><span class="n">ref_psf</span><span class="p">,</span><span class="n">mean_psf</span><span class="p">,</span><span class="n">p_comp</span><span class="p">,</span><span class="n">coeff_data</span><span class="p">,</span><span class="n">data_coord</span><span class="p">,</span><span class="n">coord_interp</span><span class="p">,</span><span class="n">nb_neighb</span><span class="p">,</span><span class="n">pw</span><span class="o">=</span><span class="mi">5</span><span class="p">):</span>
    <span class="n">nb_data</span> <span class="o">=</span> <span class="n">coeff_data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">dist</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">nb_data</span><span class="p">,))</span>
    <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_data</span><span class="p">):</span>
        <span class="n">dist</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">=</span> <span class="n">sqrt</span><span class="p">(((</span><span class="n">data_coord</span><span class="p">[</span><span class="n">i</span><span class="p">,:]</span><span class="o">-</span><span class="n">coord_interp</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span>
    <span class="n">ind</span> <span class="o">=</span> <span class="n">argsort</span><span class="p">(</span><span class="n">dist</span><span class="p">)</span>
    <span class="n">weights</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">nb_neighb</span><span class="p">,))</span>
    <span class="n">output</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">mean_psf</span><span class="p">)</span>
    <span class="n">shap</span> <span class="o">=</span> <span class="n">ref_psf</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">output</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
    <span class="n">wout</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">nb_data</span><span class="p">,))</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_neighb</span><span class="p">):</span>
        <span class="n">weights</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">=</span><span class="mi">1</span><span class="o">/</span><span class="p">(</span><span class="n">dist</span><span class="p">[</span><span class="n">ind</span><span class="p">[</span><span class="n">i</span><span class="p">]])</span><span class="o">**</span><span class="n">pw</span>
        <span class="c1">#print weights[i]</span>
        <span class="n">output</span> <span class="o">=</span> <span class="n">output</span><span class="o">+</span><span class="n">weights</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">*</span><span class="n">ref_psf</span><span class="p">[:,:,</span><span class="n">ind</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span>

        <span class="n">coeff_i</span> <span class="o">=</span> <span class="n">coeff_data</span><span class="p">[</span><span class="n">ind</span><span class="p">[</span><span class="n">i</span><span class="p">],:]</span>
    <span class="c1">#output = output + weights[i]*coeff_i.dot(nnspose(p_comp))</span>
    <span class="n">tt_weight</span> <span class="o">=</span> <span class="n">weights</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    <span class="n">output</span><span class="o">=</span><span class="n">output</span><span class="o">/</span><span class="n">tt_weight</span>
    <span class="n">wout</span><span class="p">[</span><span class="n">ind</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">nb_neighb</span><span class="p">]]</span> <span class="o">=</span> <span class="n">weights</span><span class="o">/</span><span class="n">tt_weight</span>
    <span class="k">return</span> <span class="n">output</span><span class="p">,</span><span class="n">wout</span>

<span class="k">def</span> <span class="nf">inv_weigthed_coeff</span><span class="p">(</span><span class="n">mat_ref</span><span class="p">,</span><span class="n">pos_ref</span><span class="p">,</span><span class="n">target_pos</span><span class="p">,</span><span class="n">nb_neigh</span><span class="p">,</span><span class="n">pw</span><span class="o">=</span><span class="mi">5</span><span class="p">):</span> <span class="c1"># Each sample coeff is in a column of mat_ref</span>
    <span class="n">nb_data</span> <span class="o">=</span> <span class="n">mat_ref</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">dist</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">nb_data</span><span class="p">,))</span>
    <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_data</span><span class="p">):</span>
        <span class="n">dist</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">=</span> <span class="n">sqrt</span><span class="p">(((</span><span class="n">pos_ref</span><span class="p">[</span><span class="n">i</span><span class="p">,:]</span><span class="o">-</span><span class="n">target_pos</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span>

    <span class="nb">print</span> <span class="n">dist</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
    <span class="n">ind</span> <span class="o">=</span> <span class="n">argsort</span><span class="p">(</span><span class="n">dist</span><span class="p">)</span>
    <span class="n">weights</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">nb_data</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_neigh</span><span class="p">):</span>
        <span class="n">weights</span><span class="p">[</span><span class="n">ind</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">=</span> <span class="mi">1</span><span class="o">/</span><span class="p">(</span><span class="n">dist</span><span class="p">[</span><span class="n">ind</span><span class="p">[</span><span class="n">i</span><span class="p">]])</span><span class="o">**</span><span class="n">pw</span>

    <span class="n">interp_coeff</span> <span class="o">=</span> <span class="n">mat_ref</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">weights</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">interp_coeff</span>

<span class="k">def</span> <span class="nf">inv_weigthed_coeff_stack</span><span class="p">(</span><span class="n">mat_ref</span><span class="p">,</span><span class="n">pos_ref</span><span class="p">,</span><span class="n">target_pos</span><span class="p">,</span><span class="n">nb_neigh</span><span class="p">,</span><span class="n">pw</span><span class="o">=</span><span class="mi">5</span><span class="p">):</span>
    <span class="n">shap1</span> <span class="o">=</span> <span class="n">target_pos</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">shap2</span> <span class="o">=</span> <span class="n">mat_ref</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">nb_target</span> <span class="o">=</span> <span class="n">shap1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">weights_interp</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">shap2</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">nb_target</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_target</span><span class="p">):</span>
        <span class="n">weights_i</span> <span class="o">=</span> <span class="n">inv_weigthed_coeff</span><span class="p">(</span><span class="n">mat_ref</span><span class="p">,</span><span class="n">pos_ref</span><span class="p">,</span><span class="n">target_pos</span><span class="p">[</span><span class="n">i</span><span class="p">,:],</span><span class="n">nb_neigh</span><span class="p">,</span><span class="n">pw</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
        <span class="n">weights_interp</span><span class="p">[:,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">weights_i</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">shap2</span><span class="p">[</span><span class="mi">0</span><span class="p">],))</span>

    <span class="k">return</span> <span class="n">weights_interp</span>

<span class="k">def</span> <span class="nf">inv_weigthed_cube_svd</span><span class="p">(</span><span class="n">cube_ref</span><span class="p">,</span><span class="n">pos_ref</span><span class="p">,</span><span class="n">target_pos</span><span class="p">,</span><span class="n">nb_neigh</span><span class="p">,</span><span class="n">nb_comp</span><span class="p">,</span><span class="n">pw</span><span class="o">=</span><span class="mi">5</span><span class="p">):</span>
    <span class="n">shap</span> <span class="o">=</span> <span class="n">cube_ref</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">data_mat</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">cube_to_mat</span><span class="p">(</span><span class="n">cube_ref</span><span class="p">)</span>
    <span class="n">U</span><span class="p">,</span><span class="n">s</span><span class="p">,</span><span class="n">Vt</span> <span class="o">=</span> <span class="n">linalg</span><span class="o">.</span><span class="n">svd</span><span class="p">(</span><span class="n">data_mat</span><span class="p">,</span><span class="n">full_matrices</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">basis</span> <span class="o">=</span> <span class="n">Vt</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">nb_comp</span><span class="p">,:]</span>
    <span class="n">mat_ref</span> <span class="o">=</span> <span class="n">basis</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">transpose</span><span class="p">(</span><span class="n">data_mat</span><span class="p">))</span>
    <span class="n">weights_interp</span> <span class="o">=</span> <span class="n">inv_weigthed_coeff_stack</span><span class="p">(</span><span class="n">mat_ref</span><span class="p">,</span><span class="n">pos_ref</span><span class="p">,</span><span class="n">target_pos</span><span class="p">,</span><span class="n">nb_neigh</span><span class="p">,</span><span class="n">pw</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>

    <span class="n">data_interp</span> <span class="o">=</span> <span class="n">transpose</span><span class="p">(</span><span class="n">weights_interp</span><span class="p">)</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">basis</span><span class="p">)</span>
    <span class="n">cube_interp</span> <span class="o">=</span>  <span class="n">utils</span><span class="o">.</span><span class="n">mat_to_cube</span><span class="p">(</span><span class="n">data_interp</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

    <span class="k">return</span> <span class="n">cube_interp</span>

<span class="k">def</span> <span class="nf">interp_field_inv_weight_cv_hull</span><span class="p">(</span><span class="n">coeff_data</span><span class="p">,</span><span class="n">data_coord</span><span class="p">,</span><span class="n">coord_interp</span><span class="p">,</span><span class="n">nb_neighb</span><span class="p">,</span><span class="n">pw</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
    <span class="n">nb_data</span> <span class="o">=</span> <span class="n">coeff_data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">dist</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">nb_data</span><span class="p">,))</span>
    <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_data</span><span class="p">):</span>
        <span class="n">dist</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">=</span> <span class="n">sqrt</span><span class="p">(((</span><span class="n">data_coord</span><span class="p">[</span><span class="n">i</span><span class="p">,:]</span><span class="o">-</span><span class="n">coord_interp</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span>
    <span class="n">ind</span> <span class="o">=</span> <span class="n">argsort</span><span class="p">(</span><span class="n">dist</span><span class="p">)</span>
    <span class="n">weights</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">nb_neighb</span><span class="p">,))</span>
    <span class="n">output</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">coeff_data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],))</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_neighb</span><span class="p">):</span>
        <span class="n">weights</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">=</span><span class="mi">1</span><span class="o">/</span><span class="p">(</span><span class="n">dist</span><span class="p">[</span><span class="n">ind</span><span class="p">[</span><span class="n">i</span><span class="p">]])</span><span class="o">**</span><span class="n">pw</span>
        <span class="n">output</span> <span class="o">=</span> <span class="n">output</span><span class="o">+</span><span class="n">weights</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">*</span><span class="n">coeff_data</span><span class="p">[:,</span><span class="n">ind</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span>
    <span class="n">tt_weight</span> <span class="o">=</span> <span class="n">weights</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    <span class="n">output</span><span class="o">=</span><span class="n">output</span><span class="o">/</span><span class="n">tt_weight</span>
    <span class="k">return</span> <span class="n">output</span>

<span class="k">def</span> <span class="nf">interp_field_inv_weight_cv_hull_arr</span><span class="p">(</span><span class="n">coeff_data</span><span class="p">,</span><span class="n">data_coord</span><span class="p">,</span><span class="n">coord_interp_arr</span><span class="p">,</span><span class="n">nb_neighb</span><span class="p">):</span>
    <span class="n">nb_psf</span> <span class="o">=</span> <span class="n">coord_interp_arr</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">coeff_interp</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">coeff_data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">nb_psf</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_psf</span><span class="p">):</span>
        <span class="n">coord_interp</span> <span class="o">=</span> <span class="n">coord_interp_arr</span><span class="p">[</span><span class="n">i</span><span class="p">,:]</span>
        <span class="n">coeff_interp</span><span class="p">[:,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">interp_field_inv_weight_cv_hull</span><span class="p">(</span><span class="n">coeff_data</span><span class="p">,</span><span class="n">data_coord</span><span class="p">,</span><span class="n">coord_interp</span><span class="p">,</span><span class="n">nb_neighb</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">coeff_interp</span>


<span class="k">def</span> <span class="nf">interp_field_inv_weight_pca_arr</span><span class="p">(</span><span class="n">ref_psf</span><span class="p">,</span><span class="n">mean_psf</span><span class="p">,</span><span class="n">p_comp</span><span class="p">,</span><span class="n">coeff_data</span><span class="p">,</span><span class="n">data_coord</span><span class="p">,</span><span class="n">coord_interp_arr</span><span class="p">,</span><span class="n">nb_neighb</span><span class="p">,</span><span class="n">n1</span><span class="p">,</span><span class="n">n2</span><span class="p">):</span>
    <span class="n">nb_psf</span> <span class="o">=</span> <span class="n">coord_interp_arr</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">psf_interp</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">n1</span><span class="p">,</span><span class="n">n2</span><span class="p">,</span><span class="n">nb_psf</span><span class="p">))</span>
    <span class="n">i</span><span class="o">=</span><span class="mi">0</span>
    <span class="n">weights</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">data_coord</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">nb_psf</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_psf</span><span class="p">):</span>
        <span class="n">coord_interp</span> <span class="o">=</span> <span class="n">coord_interp_arr</span><span class="p">[</span><span class="n">i</span><span class="p">,:]</span>
        <span class="n">psf_interp_i</span><span class="p">,</span><span class="n">wout</span> <span class="o">=</span> <span class="n">interp_field_inv_weight_pca</span><span class="p">(</span><span class="n">ref_psf</span><span class="p">,</span><span class="n">mean_psf</span><span class="p">,</span><span class="n">p_comp</span><span class="p">,</span><span class="n">coeff_data</span><span class="p">,</span><span class="n">data_coord</span><span class="p">,</span><span class="n">coord_interp</span><span class="p">,</span><span class="n">nb_neighb</span><span class="p">)</span>
        <span class="n">psf_interp</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">psf_interp_i</span>
        <span class="n">weights</span><span class="p">[:,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">wout</span>
    <span class="k">return</span> <span class="n">psf_interp</span><span class="p">,</span><span class="n">weights</span>


<span class="k">def</span> <span class="nf">interp_field_inv_weight_pca_err</span><span class="p">(</span><span class="n">ref_psf</span><span class="p">,</span><span class="n">psf_field</span><span class="p">,</span><span class="n">mean_psf</span><span class="p">,</span><span class="n">p_comp</span><span class="p">,</span><span class="n">coeff_data</span><span class="p">,</span><span class="n">data_coord</span><span class="p">,</span><span class="n">ind_rmv</span><span class="p">,</span><span class="n">ind_kpt</span><span class="p">,</span><span class="n">nb_neighb</span><span class="p">):</span>
    <span class="n">coord_interp_arr</span> <span class="o">=</span> <span class="n">data_coord</span><span class="p">[</span><span class="n">ind_rmv</span><span class="p">,:]</span>
    <span class="n">coord_interp_learning</span> <span class="o">=</span> <span class="n">data_coord</span><span class="p">[</span><span class="n">ind_kpt</span><span class="p">,:]</span>
    <span class="n">n1</span> <span class="o">=</span> <span class="n">psf_field</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">n2</span> <span class="o">=</span> <span class="n">psf_field</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">psf_interp</span><span class="p">,</span><span class="n">weights</span> <span class="o">=</span> <span class="n">interp_field_inv_weight_pca_arr</span><span class="p">(</span><span class="n">ref_psf</span><span class="p">,</span><span class="n">mean_psf</span><span class="p">,</span><span class="n">p_comp</span><span class="p">,</span><span class="n">coeff_data</span><span class="p">,</span><span class="n">coord_interp_learning</span><span class="p">,</span><span class="n">coord_interp_arr</span><span class="p">,</span><span class="n">nb_neighb</span><span class="p">,</span><span class="n">n1</span><span class="p">,</span><span class="n">n2</span><span class="p">)</span>
    <span class="n">ell_interp</span><span class="p">,</span><span class="n">theta_interp</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">mk_ellipticity_arr</span><span class="p">(</span><span class="n">psf_interp</span><span class="p">,</span><span class="mf">1e6</span><span class="p">,</span><span class="n">niter_cent</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">ell</span><span class="p">,</span><span class="n">theta</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">mk_ellipticity_arr</span><span class="p">(</span><span class="n">psf_field</span><span class="p">,</span><span class="mf">1e6</span><span class="p">,</span><span class="n">niter_cent</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">nb_interp</span> <span class="o">=</span> <span class="n">ind_rmv</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">mse</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">nb_interp</span><span class="p">,))</span>
    <span class="n">error_map</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">n1</span><span class="p">,</span><span class="n">n2</span><span class="p">,</span><span class="n">nb_interp</span><span class="p">))</span>
    <span class="n">error_ell_theta</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">nb_interp</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span>
    <span class="n">rerror_ell_theta</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">nb_interp</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span>
    <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_interp</span><span class="p">):</span>
        <span class="n">error_map</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">psf_interp</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">]</span><span class="o">-</span><span class="n">psf_field</span><span class="p">[:,:,</span><span class="n">ind_rmv</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span>
        <span class="n">mse</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">error_map</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="n">error_ell_theta</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">ell</span><span class="p">[</span><span class="n">ind_rmv</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">ell_interp</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">error_ell_theta</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">ell</span><span class="p">[</span><span class="n">ind_rmv</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">ell_interp</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">error_ell_theta</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">theta</span><span class="p">[</span><span class="n">ind_rmv</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span><span class="o">-</span><span class="n">theta_interp</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        <span class="n">rerror_ell_theta</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">100</span><span class="o">*</span><span class="n">error_ell_theta</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="nb">abs</span><span class="p">(</span><span class="n">ell</span><span class="p">[</span><span class="n">ind_rmv</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">rerror_ell_theta</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">100</span><span class="o">*</span><span class="n">error_ell_theta</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="nb">abs</span><span class="p">(</span><span class="n">ell</span><span class="p">[</span><span class="n">ind_rmv</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">rerror_ell_theta</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">100</span><span class="o">*</span><span class="n">error_ell_theta</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span><span class="o">/</span><span class="nb">abs</span><span class="p">(</span><span class="n">theta</span><span class="p">[</span><span class="n">ind_rmv</span><span class="p">[</span><span class="n">i</span><span class="p">]])</span>
    <span class="k">return</span> <span class="n">psf_interp</span><span class="p">,</span><span class="n">error_map</span><span class="p">,</span><span class="n">mse</span><span class="p">,</span><span class="n">ell_interp</span><span class="p">,</span><span class="n">theta_interp</span><span class="p">,</span><span class="n">error_ell_theta</span><span class="p">,</span><span class="n">rerror_ell_theta</span><span class="p">,</span><span class="n">weights</span>


<span class="k">def</span> <span class="nf">interp_field_err</span><span class="p">(</span><span class="n">psf_field</span><span class="p">,</span><span class="n">psf_interp</span><span class="p">,</span><span class="n">ind_rmv</span><span class="p">,</span><span class="n">ind_kpt</span><span class="p">):</span>
    <span class="n">n1</span> <span class="o">=</span> <span class="n">psf_field</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">n2</span> <span class="o">=</span> <span class="n">psf_field</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

    <span class="n">ell_interp</span><span class="p">,</span><span class="n">theta_interp</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">mk_ellipticity_arr</span><span class="p">(</span><span class="n">psf_interp</span><span class="p">,</span><span class="mf">1e6</span><span class="p">,</span><span class="n">niter_cent</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">ell</span><span class="p">,</span><span class="n">theta</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">mk_ellipticity_arr</span><span class="p">(</span><span class="n">psf_field</span><span class="p">,</span><span class="mf">1e6</span><span class="p">,</span><span class="n">niter_cent</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">nb_interp</span> <span class="o">=</span> <span class="n">ind_rmv</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">mse</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">nb_interp</span><span class="p">,))</span>
    <span class="n">error_map</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">n1</span><span class="p">,</span><span class="n">n2</span><span class="p">,</span><span class="n">nb_interp</span><span class="p">))</span>
    <span class="n">error_ell_theta</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">nb_interp</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span>
    <span class="n">rerror_ell_theta</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">nb_interp</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span>
    <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_interp</span><span class="p">):</span>
        <span class="n">error_map</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">psf_interp</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">]</span><span class="o">-</span><span class="n">psf_field</span><span class="p">[:,:,</span><span class="n">ind_rmv</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span>
        <span class="n">mse</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">error_map</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="n">error_ell_theta</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">ell</span><span class="p">[</span><span class="n">ind_rmv</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">ell_interp</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">error_ell_theta</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">ell</span><span class="p">[</span><span class="n">ind_rmv</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">ell_interp</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">error_ell_theta</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">theta</span><span class="p">[</span><span class="n">ind_rmv</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span><span class="o">-</span><span class="n">theta_interp</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        <span class="n">rerror_ell_theta</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">100</span><span class="o">*</span><span class="n">error_ell_theta</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="nb">abs</span><span class="p">(</span><span class="n">ell</span><span class="p">[</span><span class="n">ind_rmv</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">rerror_ell_theta</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">100</span><span class="o">*</span><span class="n">error_ell_theta</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="nb">abs</span><span class="p">(</span><span class="n">ell</span><span class="p">[</span><span class="n">ind_rmv</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">rerror_ell_theta</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">100</span><span class="o">*</span><span class="n">error_ell_theta</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span><span class="o">/</span><span class="nb">abs</span><span class="p">(</span><span class="n">theta</span><span class="p">[</span><span class="n">ind_rmv</span><span class="p">[</span><span class="n">i</span><span class="p">]])</span>

    <span class="k">return</span> <span class="n">error_map</span><span class="p">,</span><span class="n">mse</span><span class="p">,</span><span class="n">error_ell_theta</span><span class="p">,</span><span class="n">rerror_ell_theta</span>

<span class="k">def</span> <span class="nf">deg_to_micron_euclid</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span><span class="n">up_fact</span><span class="p">):</span> <span class="c1"># up_fact must match the original data resolution (the data containing the angular information in their fits header)</span>
    <span class="n">pos_micron</span> <span class="o">=</span> <span class="mi">12</span><span class="o">*</span><span class="n">pos</span><span class="o">*</span><span class="n">pi</span><span class="o">/</span><span class="p">(</span><span class="n">up_fact</span><span class="o">*</span><span class="mi">180</span><span class="o">*</span><span class="mf">4.03e-8</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">pos_micron</span>

<span class="k">def</span> <span class="nf">euclid_pixels_position_map</span><span class="p">(</span><span class="n">cent_pos</span><span class="p">,</span><span class="n">siz</span><span class="p">,</span><span class="n">up_fact</span><span class="p">):</span> <span class="c1"># cent_pos: central pixel center coordinates in microns (we assume odd sizes); outputs pixels positions in microns; up_fact = upsampling factor compared to Euclid resolution</span>
    <span class="nb">map</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">siz</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">siz</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="mi">2</span><span class="p">))</span>
    <span class="n">i</span><span class="o">=</span><span class="mi">0</span>
    <span class="n">j</span><span class="o">=</span><span class="mi">0</span>
    <span class="n">lx</span> <span class="o">=</span> <span class="p">(</span><span class="n">siz</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span> <span class="c1"># Half the number of columns</span>
    <span class="n">ly</span> <span class="o">=</span> <span class="p">(</span><span class="n">siz</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">siz</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">siz</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
            <span class="nb">map</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">12</span><span class="o">*</span><span class="p">(</span><span class="n">j</span><span class="o">-</span><span class="n">lx</span><span class="p">)</span><span class="o">/</span><span class="n">up_fact</span><span class="o">+</span><span class="n">cent_pos</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="nb">map</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">12</span><span class="o">*</span><span class="p">(</span><span class="n">i</span><span class="o">-</span><span class="n">ly</span><span class="p">)</span><span class="o">/</span><span class="n">up_fact</span><span class="o">+</span><span class="n">cent_pos</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">return</span> <span class="nb">map</span>

<span class="k">def</span> <span class="nf">cross_distances_map</span><span class="p">(</span><span class="n">map1</span><span class="p">,</span><span class="n">map2</span><span class="p">):</span> <span class="c1"># A line of cross_map contains distances from one point in map1 to all the points in map2; the two maps are spanned lines after lines</span>
    <span class="n">shap1</span> <span class="o">=</span> <span class="n">map1</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">shap2</span> <span class="o">=</span> <span class="n">map2</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">siz1</span> <span class="o">=</span> <span class="n">shap1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">shap1</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">siz2</span> <span class="o">=</span> <span class="n">shap2</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">shap2</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">cross_map</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">siz1</span><span class="p">,</span><span class="n">siz2</span><span class="p">))</span>
    <span class="n">i</span><span class="o">=</span><span class="mi">0</span>
    <span class="n">j</span><span class="o">=</span><span class="mi">0</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">siz1</span><span class="p">):</span>
        <span class="n">i1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">int</span><span class="p">(</span><span class="n">i</span><span class="o">/</span><span class="n">shap1</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="c1"># Line index in map1</span>
        <span class="n">j1</span> <span class="o">=</span> <span class="n">mod</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">shap1</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">siz2</span><span class="p">):</span>
            <span class="n">i2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">int</span><span class="p">(</span><span class="n">j</span><span class="o">/</span><span class="n">shap2</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="c1"># Line index in map2</span>
            <span class="n">j2</span> <span class="o">=</span> <span class="n">mod</span><span class="p">(</span><span class="n">j</span><span class="p">,</span><span class="n">shap2</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">cross_map</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span><span class="o">=</span><span class="p">(</span><span class="n">map1</span><span class="p">[</span><span class="n">i1</span><span class="p">,</span><span class="n">j1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">map2</span><span class="p">[</span><span class="n">i2</span><span class="p">,</span><span class="n">j2</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="p">(</span><span class="n">map1</span><span class="p">[</span><span class="n">i1</span><span class="p">,</span><span class="n">j1</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">map2</span><span class="p">[</span><span class="n">i2</span><span class="p">,</span><span class="n">j2</span><span class="p">,</span><span class="mi">1</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span>
    <span class="k">return</span> <span class="n">cross_map</span>


<span class="k">def</span> <span class="nf">cross_distances_cloud</span><span class="p">(</span><span class="n">pos</span><span class="p">):</span> <span class="c1"># A line of cross_map contains distances from one point in map1 to all the points in map2; the two maps are spanned lines after lines</span>
    <span class="n">nb_pts</span> <span class="o">=</span> <span class="n">pos</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">cross_map</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">nb_pts</span><span class="p">,</span><span class="n">nb_pts</span><span class="p">))</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_pts</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">nb_pts</span><span class="p">):</span>
            <span class="n">cross_map</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span><span class="o">=</span><span class="p">(</span><span class="n">pos</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">pos</span><span class="p">[</span><span class="n">j</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="p">(</span><span class="n">pos</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">pos</span><span class="p">[</span><span class="n">j</span><span class="p">,</span><span class="mi">1</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span>
    <span class="n">cross_map</span><span class="o">+=</span><span class="n">transpose</span><span class="p">(</span><span class="n">cross_map</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">cross_map</span>


<span class="k">def</span> <span class="nf">pix_map</span><span class="p">(</span><span class="n">field_cent</span><span class="p">,</span><span class="n">res_fact</span><span class="p">,</span><span class="n">shap</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">field_cent</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">field_cent_pix</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">field_cent_pix</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">field_cent_pix</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">arcsec2pix_euclid</span><span class="p">(</span><span class="n">field_cent</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">res_fact</span><span class="p">)</span>
        <span class="n">field_cent_pix</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">arcsec2pix_euclid</span><span class="p">(</span><span class="n">field_cent</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">res_fact</span><span class="p">)</span>

    <span class="n">mapx</span> <span class="o">=</span> <span class="n">ones</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">array</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">int</span><span class="p">(</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span><span class="p">),</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">int</span><span class="p">(</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span><span class="p">)))</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span> <span class="o">+</span> <span class="n">field_cent_pix</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">ones</span><span class="p">(</span><span class="n">shap</span><span class="p">)</span>
    <span class="n">mapy</span> <span class="o">=</span> <span class="p">(</span><span class="n">array</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">int</span><span class="p">(</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span><span class="p">),</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">int</span><span class="p">(</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span><span class="p">)))</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">ones</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">])))</span> <span class="o">+</span> <span class="n">field_cent_pix</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">ones</span><span class="p">(</span><span class="n">shap</span><span class="p">)</span>

    <span class="nb">map</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="mi">2</span><span class="p">))</span>
    <span class="nb">map</span><span class="p">[:,:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">mapx</span>
    <span class="nb">map</span><span class="p">[:,:,</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">mapy</span>

    <span class="k">return</span> <span class="nb">map</span>

<span class="k">def</span> <span class="nf">dist_map</span><span class="p">(</span><span class="n">map1</span><span class="p">,</span><span class="n">map2</span><span class="p">,</span><span class="n">same</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="n">map_in</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">map1</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">same</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">shap</span> <span class="o">=</span> <span class="n">map1</span><span class="o">.</span><span class="n">shape</span>
        <span class="n">map_in</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span>
        <span class="n">map_in</span><span class="p">[:,</span><span class="mi">0</span><span class="p">:</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">],:]</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">map1</span><span class="p">)</span>
        <span class="n">map_in</span><span class="p">[:,</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]:,:]</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">map2</span><span class="p">)</span>

    <span class="n">dist_map</span> <span class="o">=</span> <span class="n">cross_distances_map</span><span class="p">(</span><span class="n">map_in</span><span class="p">,</span><span class="n">map_in</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">dist_map</span>

<span class="k">def</span> <span class="nf">psf_interp_opt_transp</span><span class="p">(</span><span class="n">psf_cubes</span><span class="p">,</span><span class="n">positions_map</span><span class="p">,</span><span class="n">transport_map</span><span class="p">,</span><span class="n">nb_iter_bar</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span><span class="n">nb_iter_transp</span><span class="o">=</span><span class="mi">100</span><span class="p">):</span> <span class="c1"># PSF interpolation using Wasserstein barycenter</span>

    <span class="c1"># Barycenter coordinates calculation</span>
    <span class="n">shap</span> <span class="o">=</span> <span class="n">psf_cubes</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">nb_psf</span> <span class="o">=</span> <span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">A</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span><span class="n">nb_psf</span><span class="p">))</span>
    <span class="n">k</span><span class="o">=</span><span class="mi">0</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_psf</span><span class="p">):</span>
        <span class="n">A</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">positions_map</span><span class="p">[(</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">,(</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">k</span><span class="p">]</span>
        <span class="n">A</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">positions_map</span><span class="p">[(</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">,(</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">k</span><span class="p">]</span>
    <span class="n">B</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="mi">2</span><span class="p">,))</span>
    <span class="n">B</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">transport_map</span><span class="p">[(</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">,(</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">B</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">transport_map</span><span class="p">[(</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">,(</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">T</span><span class="p">,</span><span class="n">mse_bar</span> <span class="o">=</span> <span class="n">optim_utils</span><span class="o">.</span><span class="n">bar_coord_pb</span><span class="p">(</span><span class="n">A</span><span class="p">,</span><span class="n">B</span><span class="p">,</span><span class="n">nb_iter_bar</span><span class="p">)</span>
    <span class="nb">print</span> <span class="s2">&quot;T = &quot;</span><span class="p">,</span><span class="n">T</span>
    <span class="c1"># Distances map setting</span>
    <span class="n">cross_maps</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">nb_psf</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_psf</span><span class="p">):</span>
        <span class="n">mapk</span> <span class="o">=</span> <span class="n">squeeze</span><span class="p">(</span><span class="n">positions_map</span><span class="p">[:,:,:,</span><span class="n">k</span><span class="p">])</span>
        <span class="n">cross_maps</span><span class="p">[:,:,</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">cross_distances_map</span><span class="p">(</span><span class="n">transport_map</span><span class="p">,</span><span class="n">mapk</span><span class="p">)</span>

    <span class="c1"># Distribution matrix setting</span>
    <span class="n">distrib_mat</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">nb_psf</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_psf</span><span class="p">):</span>
        <span class="n">psf_k</span> <span class="o">=</span> <span class="n">psf_cubes</span><span class="p">[:,:,</span><span class="n">k</span><span class="p">]</span>
        <span class="n">psf_k</span><span class="o">=</span><span class="n">psf_k</span><span class="o">/</span><span class="n">psf_k</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="n">distrib_mat</span><span class="p">[:,</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">psf_k</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">],))</span>

    <span class="n">thresh</span><span class="o">=</span><span class="mf">0.6</span>
    <span class="n">P</span><span class="p">,</span><span class="n">cost</span> <span class="o">=</span> <span class="n">optim_utils</span><span class="o">.</span><span class="n">displacement_interp</span><span class="p">(</span><span class="n">distrib_mat</span><span class="p">,</span><span class="n">cross_maps</span><span class="p">,</span><span class="n">T</span><span class="p">,</span><span class="n">thresh</span><span class="p">,</span><span class="n">nb_iter_transp</span><span class="p">)</span>

    <span class="n">P1</span> <span class="o">=</span> <span class="n">P</span><span class="p">[:,:,</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">P2</span> <span class="o">=</span> <span class="n">P</span><span class="p">[:,:,</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">ones_vect</span> <span class="o">=</span> <span class="n">ones</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="mi">1</span><span class="p">))</span>
    <span class="n">psf_interp_vect</span> <span class="o">=</span> <span class="n">P1</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">ones_vect</span><span class="p">)</span>
    <span class="n">psf_interp_vect_2</span> <span class="o">=</span> <span class="n">P2</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">ones_vect</span><span class="p">)</span>
    <span class="n">err_vect</span> <span class="o">=</span> <span class="n">psf_interp_vect</span><span class="o">-</span><span class="n">psf_interp_vect_2</span>
    <span class="n">err</span> <span class="o">=</span> <span class="n">err_vect</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
    <span class="n">psf_interp</span> <span class="o">=</span> <span class="n">psf_interp_vect</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>

    <span class="k">return</span> <span class="n">psf_interp</span><span class="p">,</span><span class="n">cost</span><span class="p">,</span><span class="n">P</span><span class="p">,</span><span class="n">err</span>


<span class="k">def</span> <span class="nf">wasserstein_geodes</span><span class="p">(</span><span class="n">psf_1</span><span class="p">,</span><span class="n">psf_2</span><span class="p">,</span><span class="n">position_map_1</span><span class="p">,</span><span class="n">position_map_2</span><span class="p">,</span><span class="n">t</span><span class="p">,</span><span class="n">nb_iter_coupling</span><span class="o">=</span><span class="mi">100</span><span class="p">):</span> <span class="c1"># t should be picked between 0 and 1</span>

    <span class="c1"># Distance map setting</span>
    <span class="n">shap</span> <span class="o">=</span> <span class="n">psf_1</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">nb_psf</span> <span class="o">=</span> <span class="mi">2</span>
    <span class="n">cross_map</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
    <span class="n">cross_map</span> <span class="o">=</span> <span class="n">cross_distances_map</span><span class="p">(</span><span class="n">position_map_1</span><span class="p">,</span><span class="n">position_map_2</span><span class="p">)</span>

    <span class="c1"># Distribution matrix setting</span>
    <span class="n">psf_1_temp</span> <span class="o">=</span> <span class="n">psf_1</span><span class="o">/</span><span class="n">psf_1</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    <span class="n">psf_2_temp</span> <span class="o">=</span> <span class="n">psf_2</span><span class="o">/</span><span class="n">psf_2</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>

    <span class="c1"># Optimal coupling estiamtion</span>
    <span class="n">P</span><span class="p">,</span><span class="n">grad</span><span class="o">=</span><span class="n">psf_opt_coupling</span><span class="p">(</span><span class="n">psf_1_temp</span><span class="p">,</span><span class="n">psf_2_temp</span><span class="p">,</span><span class="n">position_map_1</span><span class="p">,</span><span class="n">position_map_2</span><span class="p">,</span><span class="n">nb_iter_coupling</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>

    <span class="c1"># Interpolation</span>
    <span class="n">tol</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">min_val</span> <span class="o">=</span> <span class="n">tol</span><span class="o">*</span><span class="nb">min</span><span class="p">(</span><span class="n">psf_1_temp</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span><span class="n">psf_2_temp</span><span class="o">.</span><span class="n">min</span><span class="p">())</span><span class="o">/</span><span class="p">(</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">interp_pos</span> <span class="o">=</span> <span class="n">t</span><span class="o">*</span><span class="n">position_map_1</span><span class="o">+</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">t</span><span class="p">)</span><span class="o">*</span><span class="n">position_map_2</span>
    <span class="n">psf_interp_vect</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
    <span class="n">psf_interp</span> <span class="o">=</span> <span class="mi">0</span><span class="o">*</span><span class="n">psf_1</span>
    <span class="n">i</span><span class="o">=</span><span class="mi">0</span>
    <span class="n">j</span><span class="o">=</span><span class="mi">0</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
        <span class="n">i1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">int</span><span class="p">(</span><span class="n">i</span><span class="o">/</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="c1"># Line index in position_map_1</span>
        <span class="n">j1</span> <span class="o">=</span> <span class="n">mod</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">P</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">min_val</span><span class="p">):</span>
                <span class="n">i2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">int</span><span class="p">(</span><span class="n">j</span><span class="o">/</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="c1"># Line index in postion_map_2</span>
                <span class="n">j2</span> <span class="o">=</span> <span class="n">mod</span><span class="p">(</span><span class="n">j</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">i1</span><span class="o">==</span><span class="n">i2</span> <span class="ow">and</span> <span class="n">j1</span><span class="o">==</span><span class="n">j2</span><span class="p">):</span>
                    <span class="n">psf_interp</span><span class="p">[</span><span class="n">i1</span><span class="p">,</span><span class="n">j1</span><span class="p">]</span> <span class="o">=</span> <span class="n">psf_interp</span><span class="p">[</span><span class="n">i1</span><span class="p">,</span><span class="n">j1</span><span class="p">]</span> <span class="o">+</span> <span class="n">P</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span>
                <span class="k">else</span> <span class="p">:</span>
                    <span class="n">pos</span> <span class="o">=</span> <span class="n">t</span><span class="o">*</span><span class="n">position_map_1</span><span class="p">[</span><span class="n">i1</span><span class="p">,</span><span class="n">j1</span><span class="p">,:]</span><span class="o">+</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">t</span><span class="p">)</span><span class="o">*</span><span class="n">position_map_2</span><span class="p">[</span><span class="n">i2</span><span class="p">,</span><span class="n">j2</span><span class="p">,:]</span>
                    <span class="n">imin</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">i1</span><span class="p">,</span><span class="n">i2</span><span class="p">))</span>
                    <span class="n">imax</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">i1</span><span class="p">,</span><span class="n">i2</span><span class="p">))</span>
                    <span class="n">jmin</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">j1</span><span class="p">,</span><span class="n">j2</span><span class="p">))</span>
                    <span class="n">jmax</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">j1</span><span class="p">,</span><span class="n">j2</span><span class="p">))</span>
                    <span class="n">min_dist</span> <span class="o">=</span> <span class="mf">1e15</span>
                    <span class="n">iopt</span><span class="o">=</span><span class="mi">0</span>
                    <span class="n">jopt</span><span class="o">=</span><span class="mi">0</span>
                    <span class="n">k</span><span class="o">=</span><span class="mi">0</span>
                    <span class="n">l</span><span class="o">=</span><span class="mi">0</span>
                    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">imin</span><span class="p">,</span><span class="n">imax</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
                        <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">jmin</span><span class="p">,</span><span class="n">jmax</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
                            <span class="n">dist</span> <span class="o">=</span> <span class="n">sqrt</span><span class="p">((</span><span class="n">pos</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">interp_pos</span><span class="p">[</span><span class="n">k</span><span class="p">,</span><span class="n">l</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="p">(</span><span class="n">pos</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">interp_pos</span><span class="p">[</span><span class="n">k</span><span class="p">,</span><span class="n">l</span><span class="p">,</span><span class="mi">1</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
                            <span class="k">if</span> <span class="p">(</span><span class="n">dist</span> <span class="o">&lt;</span> <span class="n">min_dist</span><span class="p">):</span>
                                <span class="n">min_dist</span><span class="o">=</span><span class="n">dist</span>
                                <span class="n">iopt</span> <span class="o">=</span> <span class="n">k</span>
                                <span class="n">jopt</span> <span class="o">=</span> <span class="n">l</span>
                    <span class="n">psf_interp</span><span class="p">[</span><span class="n">iopt</span><span class="p">,</span><span class="n">jopt</span><span class="p">]</span> <span class="o">=</span> <span class="n">psf_interp</span><span class="p">[</span><span class="n">iopt</span><span class="p">,</span><span class="n">jopt</span><span class="p">]</span><span class="o">+</span><span class="n">P</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">psf_interp</span><span class="p">,</span><span class="n">P</span>

<span class="k">def</span> <span class="nf">psf_opt_coupling</span><span class="p">(</span><span class="n">psf_1</span><span class="p">,</span><span class="n">psf_2</span><span class="p">,</span><span class="n">position_map_1</span><span class="p">,</span><span class="n">position_map_2</span><span class="p">,</span><span class="n">nb_iter_coupling</span><span class="o">=</span><span class="mi">100</span><span class="p">):</span> <span class="c1"># t should be picked between 0 and 1</span>

    <span class="c1"># Distance map setting</span>
    <span class="n">shap</span> <span class="o">=</span> <span class="n">psf_1</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">nb_psf</span> <span class="o">=</span> <span class="mi">2</span>
    <span class="n">cross_map</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
    <span class="n">cross_map</span> <span class="o">=</span> <span class="n">cross_distances_map</span><span class="p">(</span><span class="n">position_map_1</span><span class="p">,</span><span class="n">position_map_2</span><span class="p">)</span>

    <span class="c1"># Distribution matrix setting</span>
    <span class="n">distrib_1</span> <span class="o">=</span> <span class="n">psf_1</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="mi">1</span><span class="p">))</span><span class="o">/</span><span class="n">psf_1</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    <span class="n">distrib_2</span> <span class="o">=</span> <span class="n">psf_2</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="mi">1</span><span class="p">))</span><span class="o">/</span><span class="n">psf_2</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    <span class="n">thresh</span><span class="o">=</span><span class="mf">0.05</span>

    <span class="c1"># Optimal coupling estiamtion</span>
    <span class="n">P</span><span class="p">,</span><span class="n">cost</span><span class="p">,</span><span class="n">grad</span> <span class="o">=</span> <span class="n">optim_utils</span><span class="o">.</span><span class="n">opt_coupling</span><span class="p">(</span><span class="n">distrib_1</span><span class="p">,</span><span class="n">distrib_2</span><span class="p">,</span><span class="n">cross_map</span><span class="p">,</span><span class="n">thresh</span><span class="p">,</span><span class="n">nb_iter_coupling</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">P</span><span class="p">,</span><span class="n">grad</span>


<span class="k">def</span> <span class="nf">curved_wasserstein_geodes</span><span class="p">(</span><span class="n">psf_1</span><span class="p">,</span><span class="n">psf_2</span><span class="p">,</span><span class="n">position_map_1</span><span class="p">,</span><span class="n">position_map_2</span><span class="p">,</span><span class="n">t</span><span class="p">,</span><span class="n">theta</span><span class="p">,</span><span class="n">nb_iter_coupling</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span><span class="n">nb_iter_rot</span><span class="o">=</span><span class="mi">100</span><span class="p">):</span> <span class="c1"># t should be picked between 0 and 1</span>
    <span class="c1"># Distance map setting</span>
    <span class="nb">print</span> <span class="s1">&#39;nb_iter_coupling = &#39;</span><span class="p">,</span><span class="n">nb_iter_coupling</span>
    <span class="n">shap</span> <span class="o">=</span> <span class="n">psf_1</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">nb_psf</span> <span class="o">=</span> <span class="mi">2</span>
    <span class="n">cross_map</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
    <span class="n">cross_map</span> <span class="o">=</span> <span class="n">cross_distances_map</span><span class="p">(</span><span class="n">position_map_1</span><span class="p">,</span><span class="n">position_map_2</span><span class="p">)</span>

    <span class="c1"># Distribution matrix setting</span>
    <span class="n">psf_1_temp</span> <span class="o">=</span> <span class="n">psf_1</span><span class="o">/</span><span class="n">psf_1</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    <span class="n">psf_2_temp</span> <span class="o">=</span> <span class="n">psf_2</span><span class="o">/</span><span class="n">psf_2</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>


    <span class="c1"># Optimal coupling estiamtion</span>
    <span class="n">psf_1_temp_rot</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">lanczos_rot</span><span class="p">(</span><span class="n">psf_1_temp</span><span class="p">,</span><span class="n">theta</span><span class="p">)</span>
    <span class="n">psf_1_temp_rot</span> <span class="o">=</span> <span class="n">psf_1_temp_rot</span><span class="o">/</span><span class="n">psf_1_temp_rot</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    <span class="n">rot_map</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">rotate_positions_field</span><span class="p">(</span><span class="n">position_map_1</span><span class="p">,</span><span class="n">theta</span><span class="p">)</span>
    <span class="n">P</span><span class="p">,</span><span class="n">grad</span><span class="o">=</span><span class="n">psf_opt_coupling</span><span class="p">(</span><span class="n">psf_1_temp_rot</span><span class="p">,</span><span class="n">psf_2_temp</span><span class="p">,</span><span class="n">position_map_1</span><span class="p">,</span><span class="n">position_map_2</span><span class="p">,</span><span class="n">nb_iter_coupling</span><span class="o">=</span><span class="n">nb_iter_coupling</span><span class="p">)</span>

    <span class="c1"># Optimal rotation estimation</span>
    <span class="c1">#theta,rot_map = optim_utils.opt_rotation(position_map_1,position_map_2,P,nb_iter=nb_iter_rot)</span>


    <span class="c1"># Interpolation</span>
    <span class="n">tol</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">min_val</span> <span class="o">=</span> <span class="n">tol</span><span class="o">*</span><span class="nb">min</span><span class="p">(</span><span class="n">psf_1_temp_rot</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span><span class="n">psf_2_temp</span><span class="o">.</span><span class="n">min</span><span class="p">())</span><span class="o">/</span><span class="p">(</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="c1">#interp_pos = t*rot_map+(1-t)*position_map_2</span>
    <span class="n">interp_pos</span> <span class="o">=</span> <span class="n">t</span><span class="o">*</span><span class="n">position_map_1</span><span class="o">+</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">t</span><span class="p">)</span><span class="o">*</span><span class="n">position_map_2</span>
    <span class="n">psf_interp_vect</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
    <span class="n">psf_interp</span> <span class="o">=</span> <span class="mi">0</span><span class="o">*</span><span class="n">psf_1</span>
    <span class="n">i</span><span class="o">=</span><span class="mi">0</span>
    <span class="n">j</span><span class="o">=</span><span class="mi">0</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
        <span class="n">i1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">int</span><span class="p">(</span><span class="n">i</span><span class="o">/</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="c1"># Line index in position_map_1</span>
        <span class="n">j1</span> <span class="o">=</span> <span class="n">mod</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">P</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">min_val</span><span class="p">):</span>
                <span class="n">i2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">int</span><span class="p">(</span><span class="n">j</span><span class="o">/</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="c1"># Line index in postion_map_2</span>
                <span class="n">j2</span> <span class="o">=</span> <span class="n">mod</span><span class="p">(</span><span class="n">j</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">i1</span><span class="o">==</span><span class="n">i2</span> <span class="ow">and</span> <span class="n">j1</span><span class="o">==</span><span class="n">j2</span><span class="p">):</span>
                    <span class="n">psf_interp</span><span class="p">[</span><span class="n">i1</span><span class="p">,</span><span class="n">j1</span><span class="p">]</span> <span class="o">=</span> <span class="n">psf_interp</span><span class="p">[</span><span class="n">i1</span><span class="p">,</span><span class="n">j1</span><span class="p">]</span> <span class="o">+</span> <span class="n">P</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span>
                <span class="k">else</span> <span class="p">:</span>
                    <span class="n">pos</span> <span class="o">=</span> <span class="n">t</span><span class="o">*</span><span class="n">position_map_1</span><span class="p">[</span><span class="n">i1</span><span class="p">,</span><span class="n">j1</span><span class="p">,:]</span><span class="o">+</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">t</span><span class="p">)</span><span class="o">*</span><span class="n">position_map_2</span><span class="p">[</span><span class="n">i2</span><span class="p">,</span><span class="n">j2</span><span class="p">,:]</span>
                    <span class="n">imin</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">i1</span><span class="p">,</span><span class="n">i2</span><span class="p">))</span>
                    <span class="n">imax</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">i1</span><span class="p">,</span><span class="n">i2</span><span class="p">))</span>
                    <span class="n">jmin</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">j1</span><span class="p">,</span><span class="n">j2</span><span class="p">))</span>
                    <span class="n">jmax</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">j1</span><span class="p">,</span><span class="n">j2</span><span class="p">))</span>
                    <span class="n">min_dist</span> <span class="o">=</span> <span class="mf">1e15</span>
                    <span class="n">iopt</span><span class="o">=</span><span class="mi">0</span>
                    <span class="n">jopt</span><span class="o">=</span><span class="mi">0</span>
                    <span class="n">k</span><span class="o">=</span><span class="mi">0</span>
                    <span class="n">l</span><span class="o">=</span><span class="mi">0</span>
                    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">imin</span><span class="p">,</span><span class="n">imax</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
                        <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">jmin</span><span class="p">,</span><span class="n">jmax</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
                            <span class="n">dist</span> <span class="o">=</span> <span class="n">sqrt</span><span class="p">((</span><span class="n">pos</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">interp_pos</span><span class="p">[</span><span class="n">k</span><span class="p">,</span><span class="n">l</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="p">(</span><span class="n">pos</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">interp_pos</span><span class="p">[</span><span class="n">k</span><span class="p">,</span><span class="n">l</span><span class="p">,</span><span class="mi">1</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
                            <span class="k">if</span> <span class="p">(</span><span class="n">dist</span> <span class="o">&lt;</span> <span class="n">min_dist</span><span class="p">):</span>
                                <span class="n">min_dist</span><span class="o">=</span><span class="n">dist</span>
                                <span class="n">iopt</span> <span class="o">=</span> <span class="n">k</span>
                                <span class="n">jopt</span> <span class="o">=</span> <span class="n">l</span>
                    <span class="n">psf_interp</span><span class="p">[</span><span class="n">iopt</span><span class="p">,</span><span class="n">jopt</span><span class="p">]</span> <span class="o">=</span> <span class="n">psf_interp</span><span class="p">[</span><span class="n">iopt</span><span class="p">,</span><span class="n">jopt</span><span class="p">]</span><span class="o">+</span><span class="n">P</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span>

    <span class="n">theta_t</span> <span class="o">=</span> <span class="n">t</span><span class="o">*</span><span class="n">theta</span>
    <span class="n">psf_interp_theta</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">lanczos_rot</span><span class="p">(</span><span class="n">psf_interp</span><span class="p">,</span><span class="n">theta_t</span><span class="p">)</span>
    <span class="nb">print</span> <span class="s2">&quot;Cost = &quot;</span><span class="p">,(</span><span class="n">P</span><span class="o">*</span><span class="n">cross_map</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">psf_interp_theta</span><span class="p">,</span><span class="n">psf_interp</span><span class="p">,</span><span class="n">P</span><span class="p">,</span><span class="n">theta</span><span class="p">,</span><span class="n">grad</span><span class="p">,</span><span class="n">psf_1_temp_rot</span>


<span class="k">def</span> <span class="nf">partial_transport</span><span class="p">(</span><span class="n">shap</span><span class="p">,</span><span class="n">mapping</span><span class="p">,</span><span class="n">t</span><span class="p">):</span>
    <span class="n">nb_pair</span> <span class="o">=</span> <span class="n">mapping</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">psf_interp</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
    <span class="n">k</span><span class="o">=</span><span class="mi">0</span>
    <span class="n">coord</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">nb_pair</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_pair</span><span class="p">):</span>
        <span class="n">i</span> <span class="o">=</span> <span class="n">mapping</span><span class="p">[</span><span class="n">k</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">j</span> <span class="o">=</span> <span class="n">mapping</span><span class="p">[</span><span class="n">k</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">i1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">int</span><span class="p">(</span><span class="n">i</span><span class="o">/</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="c1"># Line index in position_map_1</span>
        <span class="n">j1</span> <span class="o">=</span> <span class="n">mod</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">i2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">int</span><span class="p">(</span><span class="n">j</span><span class="o">/</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="c1"># Line index in postion_map_2</span>
        <span class="n">j2</span> <span class="o">=</span> <span class="n">mod</span><span class="p">(</span><span class="n">j</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">i1</span><span class="o">==</span><span class="n">i2</span> <span class="ow">and</span> <span class="n">j1</span><span class="o">==</span><span class="n">j2</span><span class="p">):</span>
            <span class="n">psf_interp</span><span class="p">[</span><span class="n">i1</span><span class="p">,</span><span class="n">j1</span><span class="p">]</span> <span class="o">=</span> <span class="n">psf_interp</span><span class="p">[</span><span class="n">i1</span><span class="p">,</span><span class="n">j1</span><span class="p">]</span> <span class="o">+</span> <span class="n">mapping</span><span class="p">[</span><span class="n">k</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span>
            <span class="n">coord</span><span class="p">[</span><span class="n">k</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="n">i1</span>
            <span class="n">coord</span><span class="p">[</span><span class="n">k</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">=</span><span class="n">j1</span>
        <span class="k">else</span> <span class="p">:</span>
            <span class="n">iopt</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">t</span><span class="o">*</span><span class="n">i1</span><span class="o">+</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">t</span><span class="p">)</span><span class="o">*</span><span class="n">i2</span><span class="p">)</span>
            <span class="n">jopt</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">t</span><span class="o">*</span><span class="n">j1</span><span class="o">+</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">t</span><span class="p">)</span><span class="o">*</span><span class="n">j2</span><span class="p">)</span>
            <span class="n">psf_interp</span><span class="p">[</span><span class="n">iopt</span><span class="p">,</span><span class="n">jopt</span><span class="p">]</span> <span class="o">=</span> <span class="n">psf_interp</span><span class="p">[</span><span class="n">iopt</span><span class="p">,</span><span class="n">jopt</span><span class="p">]</span><span class="o">+</span><span class="n">mapping</span><span class="p">[</span><span class="n">k</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span>
            <span class="n">coord</span><span class="p">[</span><span class="n">k</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="n">iopt</span>
            <span class="n">coord</span><span class="p">[</span><span class="n">k</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">=</span><span class="n">jopt</span>

    <span class="k">return</span> <span class="n">psf_interp</span><span class="p">,</span><span class="n">coord</span>


<span class="k">def</span> <span class="nf">part_transp_gridding</span><span class="p">(</span><span class="n">mapping</span><span class="p">,</span><span class="n">shap</span><span class="p">,</span><span class="n">t</span><span class="p">,</span><span class="n">lanczos_rad</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span><span class="n">nb_iter</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span><span class="n">step_size</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>

    <span class="n">psf_init</span><span class="p">,</span><span class="n">coord</span> <span class="o">=</span> <span class="n">partial_transport</span><span class="p">(</span><span class="n">shap</span><span class="p">,</span><span class="n">mapping</span><span class="p">,</span><span class="n">t</span><span class="p">)</span>
    <span class="n">data_val</span> <span class="o">=</span> <span class="n">mapping</span><span class="p">[:,</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">psf_interp</span><span class="p">,</span><span class="n">mse</span><span class="p">,</span><span class="n">supp_cols</span><span class="p">,</span><span class="n">supp_lines</span><span class="p">,</span><span class="n">mat</span> <span class="o">=</span> <span class="n">optim_utils</span><span class="o">.</span><span class="n">lanczos_gridding</span><span class="p">(</span><span class="n">coord</span><span class="p">,</span><span class="n">data_val</span><span class="p">,</span><span class="n">shap</span><span class="p">,</span><span class="n">lanczos_rad</span><span class="o">=</span><span class="n">lanczos_rad</span><span class="p">,</span><span class="n">nb_iter</span><span class="o">=</span><span class="n">nb_iter</span><span class="p">,</span><span class="n">step_size</span><span class="o">=</span><span class="n">step_size</span><span class="p">,</span><span class="n">im_init</span><span class="o">=</span><span class="n">psf_init</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">psf_interp</span><span class="p">,</span><span class="n">supp_cols</span><span class="p">,</span><span class="n">supp_lines</span><span class="p">,</span><span class="n">mat</span><span class="p">,</span><span class="n">psf_init</span><span class="p">,</span><span class="n">coord</span>


<span class="k">def</span> <span class="nf">psf_ground_transport</span><span class="p">(</span><span class="n">psf_1</span><span class="p">,</span><span class="n">psf_2</span><span class="p">,</span><span class="n">exe_path</span><span class="o">=</span><span class="s2">&quot;../../CPP/NOT/build/gnd_tp_solve&quot;</span><span class="p">):</span>

    <span class="n">psf_1_in</span> <span class="o">=</span> <span class="n">psf_1</span><span class="o">/</span><span class="n">psf_1</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    <span class="n">psf_2_in</span> <span class="o">=</span> <span class="n">psf_2</span><span class="o">/</span><span class="n">psf_2</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    <span class="n">shap</span> <span class="o">=</span> <span class="n">psf_1_in</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">N1</span> <span class="o">=</span> <span class="n">array</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
    <span class="n">N1</span> <span class="o">=</span> <span class="n">N1</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
    <span class="n">N2</span> <span class="o">=</span> <span class="n">array</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
    <span class="n">N2</span> <span class="o">=</span> <span class="n">N2</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="mi">1</span><span class="p">))</span>
    <span class="n">ones1</span> <span class="o">=</span> <span class="n">ones</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="mi">1</span><span class="p">))</span>
    <span class="n">ones2</span> <span class="o">=</span> <span class="n">ones</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
    <span class="n">Xs</span> <span class="o">=</span> <span class="n">ones1</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">N1</span><span class="p">)</span>
    <span class="n">Ys</span> <span class="o">=</span> <span class="n">N2</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">ones2</span><span class="p">)</span>
    <span class="n">pos_map</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="mi">2</span><span class="p">))</span>
    <span class="n">pos_map</span><span class="p">[:,:,</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="n">Xs</span>
    <span class="n">pos_map</span><span class="p">[:,:,</span><span class="mi">1</span><span class="p">]</span><span class="o">=</span><span class="n">Ys</span>
    <span class="n">mapping</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">gnd_tp_solver_wrp</span><span class="p">(</span><span class="n">psf_1_in</span><span class="p">,</span><span class="n">psf_2_in</span><span class="p">,</span><span class="n">pos_map</span><span class="p">,</span><span class="n">pos_map</span><span class="p">,</span><span class="n">exe_path</span><span class="o">=</span><span class="n">exe_path</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">mapping</span>



<span class="k">def</span> <span class="nf">psf_sinkh_transport</span><span class="p">(</span><span class="n">psf_1</span><span class="p">,</span><span class="n">psf_2</span><span class="p">,</span><span class="n">dist_map</span><span class="p">,</span><span class="n">inf_val</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">beta</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span><span class="n">nb_iter</span><span class="o">=</span><span class="mi">10</span><span class="p">):</span>
    <span class="c1"># Distance map setting</span>
    <span class="n">shap</span> <span class="o">=</span> <span class="n">psf_1</span><span class="o">.</span><span class="n">shape</span>

    <span class="c1"># Distribution matrix setting</span>

    <span class="n">distrib_1</span> <span class="o">=</span> <span class="n">psf_1</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="mi">1</span><span class="p">))</span>
    <span class="n">distrib_2</span> <span class="o">=</span> <span class="n">psf_2</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="mi">1</span><span class="p">))</span><span class="o">*</span><span class="n">psf_1</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">/</span><span class="n">psf_2</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>

    <span class="n">P</span><span class="p">,</span><span class="n">dist</span> <span class="o">=</span> <span class="n">optim_utils</span><span class="o">.</span><span class="n">beg_proj_transp</span><span class="p">(</span><span class="n">dist_map</span><span class="p">,</span><span class="n">distrib_1</span><span class="p">,</span><span class="n">distrib_2</span><span class="p">,</span><span class="n">beta</span><span class="o">=</span><span class="n">beta</span><span class="p">,</span><span class="n">nb_iter</span><span class="o">=</span><span class="n">nb_iter</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">P</span><span class="p">,</span><span class="n">dist</span>

<span class="k">def</span> <span class="nf">psf_sinkh_transport_clust</span><span class="p">(</span><span class="n">psf_1</span><span class="p">,</span><span class="n">psf_2</span><span class="p">,</span><span class="n">dist_map</span><span class="p">,</span><span class="n">cart_prods</span><span class="p">,</span><span class="n">w</span><span class="p">,</span><span class="n">inf_val</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">beta</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span><span class="n">nb_iter</span><span class="o">=</span><span class="mi">10</span><span class="p">):</span>
    <span class="c1"># Distance map setting</span>
    <span class="n">shap</span> <span class="o">=</span> <span class="n">psf_1</span><span class="o">.</span><span class="n">shape</span>

    <span class="c1"># Distribution matrix setting</span>

    <span class="n">distrib_1</span> <span class="o">=</span> <span class="n">psf_1</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="mi">1</span><span class="p">))</span>
    <span class="n">distrib_2</span> <span class="o">=</span> <span class="n">psf_2</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="mi">1</span><span class="p">))</span><span class="o">*</span><span class="n">psf_1</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">/</span><span class="n">psf_2</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>

    <span class="n">P</span><span class="p">,</span><span class="n">dist</span> <span class="o">=</span> <span class="n">optim_utils</span><span class="o">.</span><span class="n">beg_proj_transp_clust</span><span class="p">(</span><span class="n">dist_map</span><span class="p">,</span><span class="n">distrib_1</span><span class="p">,</span><span class="n">distrib_2</span><span class="p">,</span><span class="n">cart_prods</span><span class="p">,</span><span class="n">w</span><span class="p">,</span><span class="n">inf_val</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">beta</span><span class="o">=</span><span class="n">beta</span><span class="p">,</span><span class="n">nb_iter</span><span class="o">=</span><span class="n">nb_iter</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">P</span><span class="p">,</span><span class="n">dist</span>



<span class="k">def</span> <span class="nf">psf_sinkh_transport_2</span><span class="p">(</span><span class="n">psf_1</span><span class="p">,</span><span class="n">psf_2</span><span class="p">,</span><span class="n">pos1</span><span class="p">,</span><span class="n">pos2</span><span class="p">,</span><span class="n">res_fact</span><span class="p">,</span><span class="n">same</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">cart_prods</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">w</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">inf_val</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">beta</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span><span class="n">nb_iter</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span><span class="n">centering</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">dist_map</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">pol_en</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">scale_factt</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">scale_factr</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">clust_en</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="n">shap</span> <span class="o">=</span> <span class="n">psf_1</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">psf_2</span> <span class="o">=</span> <span class="n">psf_2</span><span class="o">*</span><span class="n">psf_1</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">/</span><span class="n">psf_2</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    <span class="n">cent</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">map_1</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">dyn_coeff</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">pol_en</span><span class="p">:</span>
        <span class="n">cent1</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">compute_centroid_2</span><span class="p">(</span><span class="n">psf_1</span><span class="p">,</span><span class="n">ones</span><span class="p">(</span><span class="n">shap</span><span class="p">))</span>
        <span class="n">cent2</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">compute_centroid_2</span><span class="p">(</span><span class="n">psf_2</span><span class="p">,</span><span class="n">ones</span><span class="p">(</span><span class="n">shap</span><span class="p">))</span>
        <span class="n">cent</span> <span class="o">=</span> <span class="p">(</span><span class="n">cent1</span><span class="o">+</span><span class="n">cent2</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span>
        <span class="n">map_1</span> <span class="o">=</span> <span class="n">pol_coord_map_2</span><span class="p">(</span><span class="n">shap</span><span class="p">,</span><span class="n">scale_factt</span><span class="p">,</span><span class="n">scale_factr</span><span class="p">,</span><span class="n">cent</span><span class="o">=</span><span class="n">cent</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">map_1</span> <span class="o">=</span> <span class="n">pix_map</span><span class="p">(</span><span class="n">pos1</span><span class="p">,</span><span class="n">res_fact</span><span class="p">,</span><span class="n">shap</span><span class="p">)</span>

    <span class="n">map_2</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">same</span> <span class="ow">is</span> <span class="kc">False</span> <span class="ow">and</span> <span class="n">pol_en</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
        <span class="n">map_2</span> <span class="o">=</span> <span class="n">pix_map</span><span class="p">(</span><span class="n">pos2</span><span class="p">,</span><span class="n">res_fact</span><span class="p">,</span><span class="n">shap</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">same</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">map_2</span> <span class="o">=</span> <span class="n">map_1</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span> <span class="s2">&quot;Warning: if pol_en is True, same has to be True!!&quot;</span>

    <span class="n">map_in</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">psf_in_1</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">psf_in_2</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">psf_in_10</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">psf_1</span><span class="p">)</span>
    <span class="n">psf_in_20</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">psf_2</span><span class="p">)</span>
    <span class="n">inf_im</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">centering</span><span class="p">:</span>
        <span class="n">stack</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="mi">2</span><span class="p">))</span>
        <span class="n">stack</span><span class="p">[:,:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">psf_in_10</span>
        <span class="n">stack</span><span class="p">[:,:,</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">psf_in_20</span>
        <span class="n">stack_cent</span><span class="p">,</span><span class="n">inf_im</span> <span class="o">=</span> <span class="n">optim_utils</span><span class="o">.</span><span class="n">positive_centering</span><span class="p">(</span><span class="n">stack</span><span class="p">)</span>
        <span class="n">psf_in_10</span> <span class="o">=</span> <span class="n">stack_cent</span><span class="p">[:,:,</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">psf_in_20</span> <span class="o">=</span> <span class="n">stack_cent</span><span class="p">[:,:,</span><span class="mi">1</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">same</span><span class="p">:</span>
        <span class="n">psf_in_1</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">psf_in_10</span><span class="p">)</span>
        <span class="n">psf_in_2</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">psf_in_20</span><span class="p">)</span>
        <span class="n">map_in</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">map_1</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">psf_in_1</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="mi">2</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
        <span class="n">psf_in_2</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="mi">2</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
        <span class="n">psf_in_1</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">],:]</span> <span class="o">=</span> <span class="n">psf_in_10</span>
        <span class="n">psf_in_2</span><span class="p">[</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]:,:]</span> <span class="o">=</span> <span class="n">psf_in_20</span>
        <span class="n">map_in</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="mi">2</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="mi">2</span><span class="p">))</span>
        <span class="n">map_in</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">],:,:]</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">map_1</span><span class="p">)</span>
        <span class="n">map_in</span><span class="p">[</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]:,:,:]</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">map_2</span><span class="p">)</span>



    <span class="n">dist_map</span> <span class="o">=</span> <span class="n">cross_distances_map</span><span class="p">(</span><span class="n">map_in</span><span class="p">,</span><span class="n">map_in</span><span class="p">)</span>
    <span class="n">P</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">clust_en</span><span class="p">:</span>
        <span class="n">P</span><span class="p">,</span><span class="n">dist</span> <span class="o">=</span> <span class="n">psf_sinkh_transport_clust</span><span class="p">(</span><span class="n">psf_in_1</span><span class="p">,</span><span class="n">psf_in_2</span><span class="p">,</span><span class="n">dist_map</span><span class="p">,</span><span class="n">cart_prods</span><span class="p">,</span><span class="n">w</span><span class="p">,</span><span class="n">inf_val</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">beta</span><span class="o">=</span><span class="n">beta</span><span class="p">,</span><span class="n">nb_iter</span><span class="o">=</span><span class="n">nb_iter</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">P</span><span class="p">,</span><span class="n">dist</span> <span class="o">=</span> <span class="n">psf_sinkh_transport</span><span class="p">(</span><span class="n">psf_in_1</span><span class="p">,</span><span class="n">psf_in_2</span><span class="p">,</span><span class="n">dist_map</span><span class="p">,</span><span class="n">inf_val</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">beta</span><span class="o">=</span><span class="n">beta</span><span class="p">,</span><span class="n">nb_iter</span><span class="o">=</span><span class="n">nb_iter</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">same</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
        <span class="n">P</span> <span class="o">=</span> <span class="n">P</span><span class="p">[</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">]:,</span><span class="mi">0</span><span class="p">:</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
    <span class="k">if</span> <span class="n">centering</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">P</span><span class="p">,</span><span class="n">map_1</span><span class="p">,</span><span class="n">map_2</span><span class="p">,</span><span class="n">dist_map</span><span class="p">,</span><span class="n">inf_im</span><span class="p">,</span><span class="n">dyn_coeff</span><span class="p">,</span><span class="n">cent</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">P</span><span class="p">,</span><span class="n">map_1</span><span class="p">,</span><span class="n">map_2</span><span class="p">,</span><span class="n">dist_map</span><span class="p">,</span><span class="n">dyn_coeff</span><span class="p">,</span><span class="n">cent</span>

<span class="k">def</span> <span class="nf">psf_sinkh_transport_3</span><span class="p">(</span><span class="n">psf_1</span><span class="p">,</span><span class="n">psf_2</span><span class="p">,</span><span class="n">pos1</span><span class="p">,</span><span class="n">pos2</span><span class="p">,</span><span class="n">res_fact</span><span class="p">,</span><span class="n">nb_iter</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span><span class="n">centering</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">pol_en</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">scale_factt</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">scale_factr</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>

    <span class="n">shap</span> <span class="o">=</span> <span class="n">psf_1</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">psf_2</span> <span class="o">=</span> <span class="n">psf_2</span><span class="o">*</span><span class="n">psf_1</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">/</span><span class="n">psf_2</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    <span class="n">cent</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">map_1</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">dyn_coeff</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">pol_en</span><span class="p">:</span>
        <span class="n">cent1</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">compute_centroid_2</span><span class="p">(</span><span class="n">psf_1</span><span class="p">,</span><span class="n">ones</span><span class="p">(</span><span class="n">shap</span><span class="p">))</span>
        <span class="n">cent2</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">compute_centroid_2</span><span class="p">(</span><span class="n">psf_2</span><span class="p">,</span><span class="n">ones</span><span class="p">(</span><span class="n">shap</span><span class="p">))</span>
        <span class="n">cent</span> <span class="o">=</span> <span class="p">(</span><span class="n">cent1</span><span class="o">+</span><span class="n">cent2</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span>
        <span class="n">map_1</span> <span class="o">=</span> <span class="n">pol_coord_map_2</span><span class="p">(</span><span class="n">shap</span><span class="p">,</span><span class="n">scale_factt</span><span class="p">,</span><span class="n">scale_factr</span><span class="p">,</span><span class="n">cent</span><span class="o">=</span><span class="n">cent</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">map_1</span> <span class="o">=</span> <span class="n">pix_map</span><span class="p">(</span><span class="n">pos1</span><span class="p">,</span><span class="n">res_fact</span><span class="p">,</span><span class="n">shap</span><span class="p">)</span>

    <span class="n">psf_in_1</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">psf_1</span><span class="p">)</span>
    <span class="n">psf_in_2</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">psf_2</span><span class="p">)</span>


    <span class="k">if</span> <span class="n">centering</span><span class="p">:</span>
        <span class="n">stack</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="mi">2</span><span class="p">))</span>
        <span class="n">stack</span><span class="p">[:,:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">psf_1</span><span class="p">)</span>
        <span class="n">stack</span><span class="p">[:,:,</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">psf_2</span><span class="p">)</span>
        <span class="n">stack_cent</span><span class="p">,</span><span class="n">inf_im</span> <span class="o">=</span> <span class="n">optim_utils</span><span class="o">.</span><span class="n">positive_centering</span><span class="p">(</span><span class="n">stack</span><span class="p">)</span>
        <span class="n">psf_in_1</span> <span class="o">=</span> <span class="n">stack_cent</span><span class="p">[:,:,</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">psf_in_2</span> <span class="o">=</span> <span class="n">stack_cent</span><span class="p">[:,:,</span><span class="mi">1</span><span class="p">]</span>

    <span class="c1"># Dynamic normization</span>
    <span class="n">m1</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">map_1</span><span class="p">[:,:,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">std</span><span class="p">(),</span><span class="n">map_1</span><span class="p">[:,:,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">std</span><span class="p">())</span><span class="o">*</span><span class="mf">0.0001000</span>
    <span class="n">m2</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">psf_in_1</span><span class="o">.</span><span class="n">std</span><span class="p">(),</span><span class="n">psf_in_2</span><span class="o">.</span><span class="n">std</span><span class="p">())</span>

    <span class="n">f</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span><span class="n">size</span><span class="p">(</span><span class="n">psf_1</span><span class="p">)))</span>
    <span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">psf_in_1</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">size</span><span class="p">(</span><span class="n">psf_in_1</span><span class="p">)))</span>
    <span class="n">f</span><span class="p">[</span><span class="mi">1</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">map_1</span><span class="p">[:,:,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">size</span><span class="p">(</span><span class="n">psf_in_2</span><span class="p">)))</span><span class="o">*</span><span class="n">m2</span><span class="o">/</span><span class="n">m1</span>
    <span class="n">f</span><span class="p">[</span><span class="mi">2</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">map_1</span><span class="p">[:,:,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">size</span><span class="p">(</span><span class="n">psf_in_2</span><span class="p">)))</span><span class="o">*</span><span class="n">m2</span><span class="o">/</span><span class="n">m1</span>

    <span class="n">g</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span><span class="n">size</span><span class="p">(</span><span class="n">psf_1</span><span class="p">)))</span>
    <span class="n">g</span><span class="p">[</span><span class="mi">0</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">psf_in_2</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">size</span><span class="p">(</span><span class="n">psf_in_1</span><span class="p">)))</span>
    <span class="n">g</span><span class="p">[</span><span class="mi">1</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">map_1</span><span class="p">[:,:,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">size</span><span class="p">(</span><span class="n">psf_in_2</span><span class="p">)))</span><span class="o">*</span><span class="n">m2</span><span class="o">/</span><span class="n">m1</span>
    <span class="n">g</span><span class="p">[</span><span class="mi">2</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">map_1</span><span class="p">[:,:,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">size</span><span class="p">(</span><span class="n">psf_in_2</span><span class="p">)))</span><span class="o">*</span><span class="n">m2</span><span class="o">/</span><span class="n">m1</span>

    <span class="n">pf</span><span class="p">,</span><span class="n">dist_sig</span><span class="p">,</span><span class="n">i_opt</span> <span class="o">=</span> <span class="n">optim_utils</span><span class="o">.</span><span class="n">sliced_transport</span><span class="p">(</span><span class="n">f</span><span class="p">,</span><span class="n">g</span><span class="p">,</span><span class="n">nb_iter</span><span class="o">=</span><span class="n">nb_iter</span><span class="p">)</span>
    <span class="n">pf</span><span class="p">[</span><span class="mi">1</span><span class="p">:,:]</span> <span class="o">*=</span> <span class="n">m1</span><span class="o">/</span><span class="n">m2</span>
    <span class="n">interp</span> <span class="o">=</span> <span class="n">pf</span><span class="p">[</span><span class="mi">0</span><span class="p">,:]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">shap</span><span class="p">)</span>

    <span class="n">final_pos</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="mi">2</span><span class="p">))</span>
    <span class="n">final_pos</span><span class="p">[:,:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">pf</span><span class="p">[</span><span class="mi">1</span><span class="p">,:]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">shap</span><span class="p">)</span>
    <span class="n">final_pos</span><span class="p">[:,:,</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">pf</span><span class="p">[</span><span class="mi">2</span><span class="p">,:]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">shap</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">interp</span><span class="p">,</span><span class="n">map_1</span><span class="p">,</span><span class="n">final_pos</span><span class="p">,</span><span class="n">cent</span>


<span class="k">def</span> <span class="nf">cloud_sinkh_transport_2</span><span class="p">(</span><span class="n">w_1</span><span class="p">,</span><span class="n">w_2</span><span class="p">,</span><span class="n">pos1</span><span class="p">,</span><span class="n">pos2</span><span class="p">,</span><span class="n">same</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">inf_val</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">beta</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span><span class="n">nb_iter</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span><span class="n">centering</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">dist_map</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">pol_en</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">scale_factt</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">scale_factr</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>

    <span class="n">cent</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">nb_pts_1</span> <span class="o">=</span> <span class="n">pos1</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">nb_pts_2</span> <span class="o">=</span> <span class="n">pos2</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">pos_in</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">nb_pts_1</span><span class="o">+</span><span class="n">nb_pts_2</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span>
    <span class="n">pos_in</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">nb_pts_1</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">pos1</span><span class="p">)</span>
    <span class="n">pos_in</span><span class="p">[</span><span class="n">nb_pts_1</span><span class="p">:,:]</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">pos2</span><span class="p">)</span>
    <span class="n">dyn_coeff</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">pol_en</span><span class="p">:</span>
        <span class="n">w</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">nb_pts_1</span><span class="o">+</span><span class="n">nb_pts_2</span><span class="p">,))</span>
        <span class="n">w</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">nb_pts_1</span><span class="p">]</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">w_1</span><span class="p">)</span>
        <span class="n">w</span><span class="p">[</span><span class="n">nb_pts_1</span><span class="p">:]</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">w_2</span><span class="p">)</span>

        <span class="n">cent</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">cloud_centroid</span><span class="p">(</span><span class="n">pos_in</span><span class="p">,</span><span class="n">w</span><span class="p">)</span>
        <span class="n">pos_in</span> <span class="o">=</span> <span class="n">pol_coord_map_cloud</span><span class="p">(</span><span class="n">pos_in</span><span class="p">,</span><span class="n">scale_factt</span><span class="p">,</span><span class="n">scale_factr</span><span class="p">,</span><span class="n">cent</span><span class="p">)</span>

    <span class="n">w1_in</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">nb_pts_1</span><span class="o">+</span><span class="n">nb_pts_2</span><span class="p">,))</span>
    <span class="n">w2_in</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">nb_pts_1</span><span class="o">+</span><span class="n">nb_pts_2</span><span class="p">,))</span>
    <span class="n">w1_in</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">nb_pts_1</span><span class="p">]</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">w_1</span><span class="p">)</span>
    <span class="n">w2_in</span><span class="p">[</span><span class="n">nb_pts_1</span><span class="p">:]</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">w_2</span><span class="p">)</span>


    <span class="n">dist_map</span> <span class="o">=</span> <span class="n">cross_distances_cloud</span><span class="p">(</span><span class="n">pos_in</span><span class="p">)</span>
    <span class="n">P</span><span class="p">,</span><span class="n">dist</span> <span class="o">=</span> <span class="n">optim_utils</span><span class="o">.</span><span class="n">beg_proj_transp</span><span class="p">(</span><span class="n">dist_map</span><span class="p">,</span><span class="n">w1_in</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">nb_pts_1</span><span class="o">+</span><span class="n">nb_pts_2</span><span class="p">,</span><span class="mi">1</span><span class="p">)),</span><span class="n">w2_in</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">nb_pts_1</span><span class="o">+</span><span class="n">nb_pts_2</span><span class="p">,</span><span class="mi">1</span><span class="p">)),</span><span class="n">inf_val</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">beta</span><span class="o">=</span><span class="n">beta</span><span class="p">,</span><span class="n">nb_iter</span><span class="o">=</span><span class="n">nb_iter</span><span class="p">)</span>
    <span class="n">P</span> <span class="o">=</span> <span class="n">P</span><span class="p">[</span><span class="n">nb_pts_2</span><span class="p">:,</span><span class="mi">0</span><span class="p">:</span><span class="n">nb_pts_1</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">P</span><span class="p">,</span><span class="n">dist_map</span><span class="p">,</span><span class="n">dyn_coeff</span><span class="p">,</span><span class="n">cent</span>


<span class="k">def</span> <span class="nf">psf_sinkh_transport_bar</span><span class="p">(</span><span class="n">psf_stack</span><span class="p">,</span><span class="n">dist_maps</span><span class="p">,</span><span class="n">weights</span><span class="p">,</span><span class="n">inf_val</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">beta</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span><span class="n">nb_iter</span><span class="o">=</span><span class="mi">10</span><span class="p">):</span>
    <span class="c1"># Distance map setting</span>
    <span class="n">shap</span> <span class="o">=</span> <span class="n">psf_stack</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">distribs</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
        <span class="c1"># Distribution matrix setting</span>
        <span class="n">distribs</span><span class="p">[</span><span class="n">i</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">psf_stack</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">],))</span><span class="o">/</span><span class="n">psf_stack</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>

    <span class="n">P</span><span class="p">,</span><span class="n">bar</span> <span class="o">=</span> <span class="n">optim_utils</span><span class="o">.</span><span class="n">beg_proj_transp_bar</span><span class="p">(</span><span class="n">dist_maps</span><span class="p">,</span><span class="n">distribs</span><span class="p">,</span><span class="n">weights</span><span class="p">,</span><span class="n">inf_val</span><span class="o">=</span><span class="n">inf_val</span><span class="p">,</span><span class="n">beta</span><span class="o">=</span><span class="n">beta</span><span class="p">,</span><span class="n">nb_iter</span><span class="o">=</span><span class="n">nb_iter</span><span class="p">)</span>
    <span class="n">bar</span> <span class="o">=</span> <span class="n">bar</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
    <span class="k">return</span> <span class="n">P</span><span class="p">,</span><span class="n">bar</span>

<span class="c1">#def psf_sinkh_transport_bar(psf_stack,dist_maps,weights,inf_val=None,beta=100,nb_iter=10):</span>

<span class="k">def</span> <span class="nf">sinkh_transport_bar</span><span class="p">(</span><span class="n">distribs</span><span class="p">,</span><span class="n">dist_maps</span><span class="p">,</span><span class="n">data_pos</span><span class="p">,</span><span class="n">target_pos</span><span class="p">,</span><span class="n">beta</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span><span class="n">nb_iter</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span><span class="n">n</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span> <span class="c1"># The distribution are assumed to be normalized</span>
    <span class="n">shap</span> <span class="o">=</span> <span class="n">distribs</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">weights</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">],))</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
        <span class="c1"># Distribution nromalization</span>
        <span class="n">distribs</span><span class="p">[</span><span class="n">i</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">distribs</span><span class="p">[</span><span class="n">i</span><span class="p">,:]</span><span class="o">/</span><span class="p">(</span><span class="n">distribs</span><span class="p">[</span><span class="n">i</span><span class="p">,:]</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span>
        <span class="n">weights</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">sqrt</span><span class="p">(((</span><span class="n">data_pos</span><span class="p">[</span><span class="n">i</span><span class="p">,:]</span><span class="o">-</span><span class="n">target_pos</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="n">n</span><span class="p">)</span>
    <span class="n">weights</span> <span class="o">=</span> <span class="n">weights</span><span class="o">/</span><span class="p">(</span><span class="n">weights</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span>
    <span class="c1">#print weights</span>
    <span class="n">P</span><span class="p">,</span><span class="n">bar</span> <span class="o">=</span> <span class="n">optim_utils</span><span class="o">.</span><span class="n">beg_proj_transp_bar</span><span class="p">(</span><span class="n">dist_maps</span><span class="p">,</span><span class="n">distribs</span><span class="p">,</span><span class="n">weights</span><span class="p">,</span><span class="n">beta</span><span class="o">=</span><span class="n">beta</span><span class="p">,</span><span class="n">nb_iter</span><span class="o">=</span><span class="n">nb_iter</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">P</span><span class="p">,</span><span class="n">bar</span>

<span class="k">def</span> <span class="nf">opt_assig_psf_bar</span><span class="p">(</span><span class="n">psf</span><span class="p">,</span><span class="n">data_pos</span><span class="p">,</span><span class="n">target_pos</span><span class="p">,</span><span class="n">n</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
    <span class="n">shap</span> <span class="o">=</span> <span class="n">psf</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">weights</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">],))</span>
    <span class="n">distribs</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>
    <span class="n">lin_bar</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">(</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">])</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
        <span class="n">weights</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">sqrt</span><span class="p">(((</span><span class="n">data_pos</span><span class="p">[</span><span class="n">i</span><span class="p">,:]</span><span class="o">-</span><span class="n">target_pos</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="n">n</span><span class="p">)</span>
        <span class="c1"># Distribution matrix setting</span>
        <span class="n">distribs</span><span class="p">[:,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">psf</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">],))</span>
        <span class="n">lin_bar</span><span class="o">+=</span> <span class="n">weights</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">*</span><span class="n">psf</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">]</span>
    <span class="n">lin_bar</span><span class="o">/=</span><span class="n">weights</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    <span class="n">weights</span> <span class="o">=</span> <span class="n">weights</span><span class="o">/</span><span class="p">(</span><span class="n">weights</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span>
    <span class="n">bar_init</span> <span class="o">=</span> <span class="n">lin_bar</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="mi">1</span><span class="p">))</span>
    <span class="c1">#bar_init = distribs[0,:].reshape((shap[0]*shap[1],1))</span>
    <span class="n">bar</span> <span class="o">=</span> <span class="n">optim_utils</span><span class="o">.</span><span class="n">sliced_transport_bar</span><span class="p">(</span><span class="n">distribs</span><span class="p">,</span><span class="n">weights</span><span class="p">,</span><span class="n">bar_init</span><span class="o">=</span><span class="n">bar_init</span><span class="p">)</span>
    <span class="n">assign_bar</span> <span class="o">=</span> <span class="n">bar</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">assign_bar</span><span class="p">,</span><span class="n">lin_bar</span>


<span class="k">def</span> <span class="nf">opt_assig_psf_bar2</span><span class="p">(</span><span class="n">psf</span><span class="p">,</span><span class="n">data_pos</span><span class="p">,</span><span class="n">target_pos</span><span class="p">,</span><span class="n">nb_iter</span><span class="o">=</span><span class="mi">1500</span><span class="p">,</span><span class="n">n</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span><span class="n">embedding_en</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="n">shap</span> <span class="o">=</span> <span class="n">psf</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">nb_obs</span> <span class="o">=</span> <span class="n">psf</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">weights</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">nb_obs</span><span class="p">,))</span>

    <span class="n">lin_bar</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">(</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">])</span>


    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_obs</span><span class="p">):</span>
        <span class="n">weights</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">sqrt</span><span class="p">(((</span><span class="n">data_pos</span><span class="p">[</span><span class="n">i</span><span class="p">,:]</span><span class="o">-</span><span class="n">target_pos</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="n">n</span><span class="p">)</span>
        <span class="n">lin_bar</span><span class="o">+=</span> <span class="n">weights</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">*</span><span class="n">psf</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">]</span>

    <span class="n">lin_bar</span><span class="o">/=</span><span class="n">weights</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    <span class="n">weights</span> <span class="o">=</span> <span class="n">weights</span><span class="o">/</span><span class="p">(</span><span class="n">weights</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span>


    <span class="n">assign_bar</span><span class="p">,</span><span class="n">hess_obj</span><span class="p">,</span><span class="n">flann_obj</span> <span class="o">=</span> <span class="n">LLE_sliced_transport_bar</span><span class="p">(</span><span class="n">psf</span><span class="p">,</span><span class="n">weights</span><span class="p">,</span><span class="n">cent</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">coord_map</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">log_param</span><span class="o">=</span><span class="mf">1.5</span><span class="p">,</span><span class="n">zeros_inc</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">nb_neigh_emb</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">nb_comp</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span><span class="n">nb_neigh_inv_map</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span><span class="n">nb_samp</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span><span class="n">embedding_en</span><span class="o">=</span><span class="n">embedding_en</span><span class="p">)</span>


    <span class="k">return</span> <span class="n">assign_bar</span><span class="p">,</span><span class="n">lin_bar</span>


<span class="k">def</span> <span class="nf">opt_assig_psf_bar2_stack</span><span class="p">(</span><span class="n">psf_in</span><span class="p">,</span><span class="n">data_pos</span><span class="p">,</span><span class="n">target_pos</span><span class="p">,</span><span class="n">n</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">pol_en</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">scale_factt</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">scale_factr</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">res_fact</span><span class="o">=</span><span class="mi">6</span><span class="p">,</span><span class="n">w</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">nb_iter</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span><span class="n">nb_real</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">centering</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">nb_neighb</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span><span class="n">remapping</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">map_fact</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span><span class="n">embedding_en</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="n">nb_est</span> <span class="o">=</span> <span class="n">target_pos</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">shap</span> <span class="o">=</span> <span class="n">psf_in</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">assign_bar</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">nb_est</span><span class="p">))</span>
    <span class="n">assign_bar_2</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">nb_est</span><span class="p">))</span>
    <span class="n">lin_bar</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">nb_est</span><span class="p">))</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_est</span><span class="p">):</span>
        <span class="n">ind</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">knn_pos</span><span class="p">(</span><span class="n">target_pos</span><span class="p">[</span><span class="n">i</span><span class="p">,:],</span><span class="n">data_pos</span><span class="p">,</span><span class="n">nb_neighb</span><span class="p">)</span>
        <span class="n">assign_bar_i</span><span class="p">,</span><span class="n">lin_bar_i</span> <span class="o">=</span> <span class="n">opt_assig_psf_bar2</span><span class="p">(</span><span class="n">psf_in</span><span class="p">[:,:,</span><span class="n">ind</span><span class="p">],</span><span class="n">data_pos</span><span class="p">[</span><span class="n">ind</span><span class="p">,:],</span><span class="n">target_pos</span><span class="p">[</span><span class="n">i</span><span class="p">,:],</span><span class="n">n</span><span class="o">=</span><span class="n">n</span><span class="p">,</span><span class="n">embedding_en</span><span class="o">=</span><span class="n">embedding_en</span><span class="p">)</span>
        <span class="n">assign_bar</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">assign_bar_i</span>

        <span class="n">lin_bar</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">lin_bar_i</span>

    <span class="k">return</span> <span class="n">assign_bar</span><span class="p">,</span><span class="n">lin_bar</span>


<span class="k">def</span> <span class="nf">opt_assig_psf_bar2_stack2</span><span class="p">(</span><span class="n">psf_in</span><span class="p">,</span><span class="n">data_pos</span><span class="p">,</span><span class="n">dist</span><span class="p">,</span><span class="n">data_tree</span><span class="p">,</span><span class="n">min_dist</span><span class="p">,</span><span class="n">n</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">pol_en</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">scale_factt</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">scale_factr</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">res_fact</span><span class="o">=</span><span class="mi">6</span><span class="p">,</span><span class="n">w</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">nb_iter</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span><span class="n">nb_real</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">centering</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">nb_neighb</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span><span class="n">remapping</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">map_fact</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span><span class="n">embedding_en</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="n">nb_est</span> <span class="o">=</span> <span class="n">data_pos</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">shap</span> <span class="o">=</span> <span class="n">psf_in</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">assign_bar</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">nb_est</span><span class="p">))</span>
    <span class="n">assign_bar_2</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">nb_est</span><span class="p">))</span>
    <span class="n">lin_bar</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">nb_est</span><span class="p">))</span>
    <span class="n">rmin</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_est</span><span class="p">):</span>
        <span class="nb">print</span> <span class="s2">&quot;psf &quot;</span><span class="p">,</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="s2">&quot;/&quot;</span><span class="p">,</span><span class="n">nb_est</span>
        <span class="n">ind0</span> <span class="o">=</span> <span class="n">where</span><span class="p">(</span><span class="n">dist</span><span class="p">[</span><span class="n">i</span><span class="p">,:]</span><span class="o">&gt;=</span><span class="n">min_dist</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        <span class="n">ind</span> <span class="o">=</span> <span class="n">data_tree</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">ind0</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">:</span><span class="n">nb_neighb</span><span class="p">]]</span>
        <span class="n">rmin</span> <span class="o">+=</span> <span class="n">dist</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">ind0</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]]</span>
        <span class="n">assign_bar_i</span><span class="p">,</span><span class="n">lin_bar_i</span> <span class="o">=</span> <span class="n">opt_assig_psf_bar2</span><span class="p">(</span><span class="n">psf_in</span><span class="p">[:,:,</span><span class="n">ind</span><span class="p">],</span><span class="n">data_pos</span><span class="p">[</span><span class="n">ind</span><span class="p">,:],</span><span class="n">data_pos</span><span class="p">[</span><span class="n">i</span><span class="p">,:],</span><span class="n">n</span><span class="o">=</span><span class="n">n</span><span class="p">,</span><span class="n">embedding_en</span><span class="o">=</span><span class="n">embedding_en</span><span class="p">)</span>

        <span class="n">assign_bar</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">assign_bar_i</span>
        <span class="nb">print</span> <span class="s2">&quot;Sum val: &quot;</span><span class="p">,</span><span class="n">assign_bar</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>

        <span class="n">lin_bar</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">lin_bar_i</span>
    <span class="n">rmin</span><span class="o">/=</span><span class="n">nb_est</span>
    <span class="k">return</span> <span class="n">assign_bar</span><span class="p">,</span><span class="n">lin_bar</span><span class="p">,</span><span class="n">rmin</span>




<span class="k">def</span> <span class="nf">opt_assig_psf_bar2_stackm</span><span class="p">(</span><span class="n">psf_in</span><span class="p">,</span><span class="n">data_pos</span><span class="p">,</span><span class="n">target_pos</span><span class="p">,</span><span class="n">n</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">pol_en</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">scale_factt</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">scale_factr</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">res_fact</span><span class="o">=</span><span class="mi">6</span><span class="p">,</span><span class="n">w</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">nb_iter</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span><span class="n">nb_real</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">centering</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">nb_neighb</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span><span class="n">remapping</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">map_fact</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span><span class="n">embedding_en</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="n">nb_realizations</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">psf_in</span><span class="p">)</span>
    <span class="n">assign_bar</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
    <span class="n">assign_bar_2</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
    <span class="n">lin_bar</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_realizations</span><span class="p">):</span>
        <span class="nb">print</span> <span class="s2">&quot;realization &quot;</span><span class="p">,</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="s2">&quot;/&quot;</span><span class="p">,</span><span class="n">nb_realizations</span>
        <span class="n">assign_bar_i</span><span class="p">,</span><span class="n">lin_bar_i</span> <span class="o">=</span> <span class="n">opt_assig_psf_bar2_stack</span><span class="p">(</span><span class="n">psf_in</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">data_pos</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">target_pos</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">n</span><span class="o">=</span><span class="n">n</span><span class="p">,</span><span class="n">pol_en</span><span class="o">=</span><span class="n">pol_en</span><span class="p">,</span><span class="n">scale_factt</span><span class="o">=</span><span class="n">scale_factt</span><span class="p">,</span><span class="n">scale_factr</span><span class="o">=</span><span class="n">scale_factr</span><span class="p">,</span><span class="n">res_fact</span><span class="o">=</span><span class="n">res_fact</span><span class="p">,</span><span class="n">w</span><span class="o">=</span><span class="n">w</span><span class="p">,</span><span class="n">nb_iter</span><span class="o">=</span><span class="n">nb_iter</span><span class="p">,</span><span class="n">nb_real</span><span class="o">=</span><span class="n">nb_real</span><span class="p">,</span><span class="n">centering</span><span class="o">=</span><span class="n">centering</span><span class="p">,</span><span class="n">nb_neighb</span><span class="o">=</span><span class="n">nb_neighb</span><span class="p">,</span><span class="n">remapping</span><span class="o">=</span><span class="n">remapping</span><span class="p">,</span><span class="n">map_fact</span><span class="o">=</span><span class="n">map_fact</span><span class="p">,</span><span class="n">embedding_en</span><span class="o">=</span><span class="n">embedding_en</span><span class="p">)</span>
        <span class="n">assign_bar</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">assign_bar_i</span><span class="p">)</span>

        <span class="n">lin_bar</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">lin_bar_i</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">assign_bar</span><span class="p">,</span><span class="n">lin_bar</span>


<span class="k">def</span> <span class="nf">opt_assig_psf_bar2_stackm2</span><span class="p">(</span><span class="n">psf_in</span><span class="p">,</span><span class="n">data_pos</span><span class="p">,</span><span class="n">dist</span><span class="p">,</span><span class="n">data_tree</span><span class="p">,</span><span class="n">dist_range</span><span class="p">,</span><span class="n">n</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span><span class="n">pol_en</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">scale_factt</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">scale_factr</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">res_fact</span><span class="o">=</span><span class="mi">6</span><span class="p">,</span><span class="n">w</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">nb_iter</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span><span class="n">nb_real</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">centering</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">nb_neighb</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span><span class="n">remapping</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">map_fact</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span><span class="n">embedding_en</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="n">nb_realizations</span> <span class="o">=</span> <span class="n">dist_range</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">assign_bar</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
    <span class="n">assign_bar_2</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
    <span class="n">lin_bar</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
    <span class="n">av_dist</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">nb_realizations</span><span class="p">,))</span>
    <span class="n">rmin</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">nb_realizations</span><span class="p">,))</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_realizations</span><span class="p">):</span>
        <span class="nb">print</span> <span class="s2">&quot;realization &quot;</span><span class="p">,</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="s2">&quot;/&quot;</span><span class="p">,</span><span class="n">nb_realizations</span>
        <span class="n">assign_bar_i</span><span class="p">,</span><span class="n">lin_bar_i</span><span class="p">,</span><span class="n">rmini</span> <span class="o">=</span> <span class="n">opt_assig_psf_bar2_stack2</span><span class="p">(</span><span class="n">psf_in</span><span class="p">,</span><span class="n">data_pos</span><span class="p">,</span><span class="n">dist</span><span class="p">,</span><span class="n">data_tree</span><span class="p">,</span><span class="n">dist_range</span><span class="p">[:,</span><span class="n">i</span><span class="p">],</span><span class="n">n</span><span class="o">=</span><span class="n">n</span><span class="p">,</span><span class="n">pol_en</span><span class="o">=</span><span class="n">pol_en</span><span class="p">,</span><span class="n">scale_factt</span><span class="o">=</span><span class="n">scale_factt</span><span class="p">,</span><span class="n">scale_factr</span><span class="o">=</span><span class="n">scale_factr</span><span class="p">,</span><span class="n">res_fact</span><span class="o">=</span><span class="n">res_fact</span><span class="p">,</span><span class="n">w</span><span class="o">=</span><span class="n">w</span><span class="p">,</span><span class="n">nb_iter</span><span class="o">=</span><span class="n">nb_iter</span><span class="p">,</span><span class="n">nb_real</span><span class="o">=</span><span class="n">nb_real</span><span class="p">,</span><span class="n">centering</span><span class="o">=</span><span class="n">centering</span><span class="p">,</span><span class="n">nb_neighb</span><span class="o">=</span><span class="n">nb_neighb</span><span class="p">,</span><span class="n">remapping</span><span class="o">=</span><span class="n">remapping</span><span class="p">,</span><span class="n">map_fact</span><span class="o">=</span><span class="n">map_fact</span><span class="p">,</span><span class="n">embedding_en</span><span class="o">=</span><span class="n">embedding_en</span><span class="p">)</span>
        <span class="n">assign_bar</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">assign_bar_i</span><span class="p">)</span>
        <span class="n">lin_bar</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">lin_bar_i</span><span class="p">)</span>
        <span class="n">rmin</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">rmini</span>

    <span class="k">return</span> <span class="n">assign_bar</span><span class="p">,</span><span class="n">lin_bar</span><span class="p">,</span><span class="n">rmin</span>

<span class="k">def</span> <span class="nf">opt_assig_psf_bar2_stackm2bis</span><span class="p">(</span><span class="n">psf_in</span><span class="p">,</span><span class="n">data_pos</span><span class="p">,</span><span class="n">dist</span><span class="p">,</span><span class="n">data_tree</span><span class="p">,</span><span class="n">dist_range</span><span class="p">,</span><span class="n">n</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span><span class="n">pol_en</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">scale_factt</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">scale_factr</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">res_fact</span><span class="o">=</span><span class="mi">6</span><span class="p">,</span><span class="n">w</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">nb_iter</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span><span class="n">nb_real</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">centering</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">nb_neighb</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">remapping</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">map_fact</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span><span class="n">embedding_en</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="n">nb_realizations</span> <span class="o">=</span> <span class="n">size</span><span class="p">(</span><span class="n">nb_neighb</span><span class="p">)</span>
    <span class="n">assign_bar</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
    <span class="n">assign_bar_2</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
    <span class="n">lin_bar</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_realizations</span><span class="p">):</span>
        <span class="nb">print</span> <span class="s2">&quot;realization &quot;</span><span class="p">,</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="s2">&quot;/&quot;</span><span class="p">,</span><span class="n">nb_realizations</span>
        <span class="n">assign_bar_i</span><span class="p">,</span><span class="n">lin_bar_i</span> <span class="o">=</span> <span class="n">opt_assig_psf_bar2_stack2</span><span class="p">(</span><span class="n">psf_in</span><span class="p">,</span><span class="n">data_pos</span><span class="p">,</span><span class="n">dist</span><span class="p">,</span><span class="n">data_tree</span><span class="p">,</span><span class="n">dist_range</span><span class="p">,</span><span class="n">n</span><span class="o">=</span><span class="n">n</span><span class="p">,</span><span class="n">pol_en</span><span class="o">=</span><span class="n">pol_en</span><span class="p">,</span><span class="n">scale_factt</span><span class="o">=</span><span class="n">scale_factt</span><span class="p">,</span><span class="n">scale_factr</span><span class="o">=</span><span class="n">scale_factr</span><span class="p">,</span><span class="n">res_fact</span><span class="o">=</span><span class="n">res_fact</span><span class="p">,</span><span class="n">w</span><span class="o">=</span><span class="n">w</span><span class="p">,</span><span class="n">nb_iter</span><span class="o">=</span><span class="n">nb_iter</span><span class="p">,</span><span class="n">nb_real</span><span class="o">=</span><span class="n">nb_real</span><span class="p">,</span><span class="n">centering</span><span class="o">=</span><span class="n">centering</span><span class="p">,</span><span class="n">nb_neighb</span><span class="o">=</span><span class="n">nb_neighb</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">remapping</span><span class="o">=</span><span class="n">remapping</span><span class="p">,</span><span class="n">map_fact</span><span class="o">=</span><span class="n">map_fact</span><span class="p">,</span><span class="n">embedding_en</span><span class="o">=</span><span class="n">embedding_en</span><span class="p">)</span>
        <span class="n">assign_bar</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">assign_bar_i</span><span class="p">)</span>
        <span class="n">lin_bar</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">lin_bar_i</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">assign_bar</span><span class="p">,</span><span class="n">lin_bar</span>




<span class="k">def</span> <span class="nf">sinkh_transport_bar_located</span><span class="p">(</span><span class="n">distribs</span><span class="p">,</span><span class="n">dist_maps</span><span class="p">,</span><span class="n">data_pos</span><span class="p">,</span><span class="n">target_pos</span><span class="p">,</span><span class="n">src_pos</span><span class="p">,</span><span class="n">beta</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span><span class="n">nb_iter</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span><span class="n">n</span><span class="o">=</span><span class="mi">20</span><span class="p">):</span> <span class="c1"># The distribution are assumed to be normalized</span>
    <span class="n">shap</span> <span class="o">=</span> <span class="n">distribs</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">weights</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">],))</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
        <span class="c1"># Distribution nromalization</span>
        <span class="n">distribs</span><span class="p">[</span><span class="n">i</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">distribs</span><span class="p">[</span><span class="n">i</span><span class="p">,:]</span><span class="o">/</span><span class="p">(</span><span class="n">distribs</span><span class="p">[</span><span class="n">i</span><span class="p">,:]</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span>
        <span class="n">weights</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">sqrt</span><span class="p">(((</span><span class="n">data_pos</span><span class="p">[</span><span class="n">i</span><span class="p">,:]</span><span class="o">-</span><span class="n">target_pos</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="n">n</span><span class="p">)</span>
    <span class="n">weights</span> <span class="o">=</span> <span class="n">weights</span><span class="o">/</span><span class="p">(</span><span class="n">weights</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span>
    <span class="c1">#print weights</span>

    <span class="n">P</span><span class="p">,</span><span class="n">bar</span> <span class="o">=</span> <span class="n">optim_utils</span><span class="o">.</span><span class="n">beg_proj_transp_bar_located</span><span class="p">(</span><span class="n">dist_maps</span><span class="p">,</span><span class="n">distribs</span><span class="p">,</span><span class="n">weights</span><span class="p">,</span><span class="n">target_pos</span><span class="p">,</span><span class="n">src_pos</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span><span class="n">src_pos</span><span class="p">[:,</span><span class="mi">1</span><span class="p">],</span><span class="n">inf_val</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">beta</span><span class="o">=</span><span class="n">beta</span><span class="p">,</span><span class="n">nb_iter</span><span class="o">=</span><span class="n">nb_iter</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">P</span><span class="p">,</span><span class="n">bar</span>


<span class="k">def</span> <span class="nf">sinkh_transport_ptbar</span><span class="p">(</span><span class="n">distribs</span><span class="p">,</span><span class="n">next_mat</span><span class="p">,</span><span class="n">data_pos</span><span class="p">,</span><span class="n">res_fact</span><span class="p">,</span><span class="n">target_pos</span><span class="p">,</span><span class="n">beta</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span><span class="n">nb_iter</span><span class="o">=</span><span class="mi">10</span><span class="p">):</span> <span class="c1"># The distribution are assumed to be normalized</span>
    <span class="n">shap</span> <span class="o">=</span> <span class="n">distribs</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">weights</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">],))</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
        <span class="c1"># Distribution nromalization</span>
        <span class="n">distribs</span><span class="p">[</span><span class="n">i</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">distribs</span><span class="p">[</span><span class="n">i</span><span class="p">,:]</span><span class="o">/</span><span class="p">(</span><span class="n">distribs</span><span class="p">[</span><span class="n">i</span><span class="p">,:]</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span>
        <span class="n">weights</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">sqrt</span><span class="p">(((</span><span class="n">data_pos</span><span class="p">[</span><span class="n">i</span><span class="p">,:]</span><span class="o">-</span><span class="n">target_pos</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">weights</span> <span class="o">=</span> <span class="n">weights</span><span class="o">/</span><span class="p">(</span><span class="n">weights</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span>
    <span class="n">bar</span> <span class="o">=</span> <span class="n">optim_utils</span><span class="o">.</span><span class="n">beg_proj_transp_ptbar</span><span class="p">(</span><span class="n">dist_mat</span><span class="p">,</span><span class="n">next_mat</span><span class="p">,</span><span class="n">distribs</span><span class="p">,</span><span class="n">weights</span><span class="p">,</span><span class="n">inf_val</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">beta</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span><span class="n">nb_iter</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">bar</span>

<span class="k">def</span> <span class="nf">psf_sinkh_transport_ptbar</span><span class="p">(</span><span class="n">psf_stack</span><span class="p">,</span><span class="n">data_pos</span><span class="p">,</span><span class="n">target_pos</span><span class="p">,</span><span class="n">beta</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span><span class="n">nb_iter</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span><span class="n">centering</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">pol_en</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">same</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">res_fact</span><span class="o">=</span><span class="mi">6</span><span class="p">,</span><span class="n">adaptive_gm</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">p</span><span class="o">=</span><span class="mi">3</span><span class="p">):</span>

    <span class="n">shap</span> <span class="o">=</span> <span class="n">psf_stack</span><span class="o">.</span><span class="n">shape</span>

    <span class="c1"># -------- barycentric coodinates calculation --------- #</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">optim_utils</span><span class="o">.</span><span class="n">bar_coord_pb_dijkstra</span><span class="p">(</span><span class="n">data_pos</span><span class="p">,</span><span class="n">target_pos</span><span class="p">,</span><span class="n">nb_iter</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
    <span class="n">nb_data</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">nb_data</span><span class="p">,))</span>
    <span class="n">ind</span> <span class="o">=</span> <span class="n">argsort</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">cur_est</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">psf_stack</span><span class="p">[:,:,</span><span class="n">ind</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]])</span>
    <span class="n">w</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="n">ind</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span>
    <span class="n">cur_pos</span> <span class="o">=</span> <span class="n">data_pos</span><span class="p">[</span><span class="n">ind</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],:]</span>
    <span class="n">cur_est_stack</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">nb_data</span><span class="p">))</span>
    <span class="n">cur_est_stack</span><span class="p">[:,:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">cur_est</span><span class="p">)</span>
    <span class="n">list_im</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
    <span class="n">inf_pos_stack</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">centering</span><span class="p">:</span>
        <span class="n">inf_pos_stack</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">nb_data</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_data</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
        <span class="nb">print</span> <span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;interpolation/&quot;</span><span class="p">,</span><span class="n">nb_data</span><span class="o">-</span><span class="mi">1</span>
        <span class="c1"># ------- Partial barycenters estimation ------- #</span>
        <span class="n">inf_pos</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">im_in</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="mi">2</span><span class="p">))</span>
        <span class="n">im_in</span><span class="p">[:,:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">cur_est</span><span class="p">)</span>
        <span class="n">im_in</span><span class="p">[:,:,</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">psf_stack</span><span class="p">[:,:,</span><span class="n">ind</span><span class="p">[</span><span class="o">-</span><span class="n">i</span><span class="o">-</span><span class="mi">2</span><span class="p">]])</span>

        <span class="k">if</span> <span class="n">centering</span><span class="p">:</span>
            <span class="n">im_in</span><span class="p">,</span><span class="n">inf_pos</span> <span class="o">=</span> <span class="n">optim_utils</span><span class="o">.</span><span class="n">positive_centering</span><span class="p">(</span><span class="n">im_in</span><span class="p">)</span>
            <span class="n">list_im</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">im_in</span><span class="p">)</span>
            <span class="n">inf_pos_stack</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">inf_pos</span><span class="p">)</span>
        <span class="c1"># ------- Local ground metric parameters computation ------- #</span>
        <span class="n">scale_factr</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">scale_factt</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">adaptive_gm</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">pol_en</span><span class="p">:</span>
                <span class="n">scale</span> <span class="o">=</span> <span class="n">im_in</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
                <span class="n">U1</span><span class="p">,</span><span class="n">s1</span><span class="p">,</span><span class="n">map1</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">im_shape</span><span class="p">(</span><span class="n">im_in</span><span class="p">[:,:,</span><span class="mi">0</span><span class="p">],</span><span class="n">scale</span><span class="o">=</span><span class="n">scale</span><span class="p">)</span>
                <span class="n">U2</span><span class="p">,</span><span class="n">s2</span><span class="p">,</span><span class="n">map2</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">im_shape</span><span class="p">(</span><span class="n">im_in</span><span class="p">[:,:,</span><span class="mi">1</span><span class="p">],</span><span class="n">scale</span><span class="o">=</span><span class="n">scale</span><span class="p">)</span>
                <span class="n">scale_factr</span> <span class="o">=</span> <span class="nb">min</span><span class="p">([</span><span class="n">s1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="n">s2</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">s2</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="n">s1</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span>
                <span class="n">scale_factt</span> <span class="o">=</span> <span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="n">U1</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">U2</span><span class="p">[:,</span><span class="mi">0</span><span class="p">])))</span><span class="o">**</span><span class="n">p</span>
                <span class="nb">print</span> <span class="n">scale_factr</span><span class="p">,</span><span class="n">scale_factt</span>
        <span class="c1"># ------- Transport plan computation ------- #</span>
        <span class="n">P</span><span class="p">,</span><span class="n">map_1</span><span class="p">,</span><span class="n">map_2</span><span class="p">,</span><span class="n">dist_mat</span><span class="p">,</span><span class="n">dyn_coeff</span><span class="p">,</span><span class="n">cent</span> <span class="o">=</span> <span class="n">psf_sinkh_transport_2</span><span class="p">(</span><span class="n">im_in</span><span class="p">[:,:,</span><span class="mi">0</span><span class="p">],</span><span class="n">im_in</span><span class="p">[:,:,</span><span class="mi">1</span><span class="p">],</span><span class="n">cur_pos</span><span class="p">,</span><span class="n">data_pos</span><span class="p">[</span><span class="n">ind</span><span class="p">[</span><span class="o">-</span><span class="n">i</span><span class="o">-</span><span class="mi">2</span><span class="p">],:],</span><span class="n">res_fact</span><span class="p">,</span><span class="n">same</span><span class="o">=</span><span class="n">same</span><span class="p">,</span><span class="n">inf_val</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">beta</span><span class="o">=</span><span class="n">beta</span><span class="p">,</span><span class="n">nb_iter</span><span class="o">=</span><span class="n">nb_iter</span><span class="p">,</span><span class="n">pol_en</span><span class="o">=</span><span class="n">pol_en</span><span class="p">,</span><span class="n">scale_factr</span><span class="o">=</span><span class="n">scale_factr</span><span class="p">,</span><span class="n">scale_factt</span> <span class="o">=</span> <span class="n">scale_factt</span><span class="p">)</span>
        <span class="c1">#P,map_1,map_2,dist_mat,dyn_coeff,cent = psf_sinkh_transport_2(im_in[:,:,0],im_in[:,:,1],cur_pos,data_pos[ind[-i-2],:],res_fact,same=same,inf_val=None,beta=beta,nb_iter=nb_iter,pol_en=pol_en,scale_factt = 0.00001)</span>

        <span class="c1"># ------- Displacement interpolation ------- #</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">w</span><span class="o">/</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">ind</span><span class="p">[</span><span class="o">-</span><span class="n">i</span><span class="o">-</span><span class="mi">2</span><span class="p">]]</span><span class="o">+</span><span class="n">w</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">pol_en</span><span class="p">:</span>
            <span class="n">cur_est</span> <span class="o">=</span> <span class="n">displacement_interp_pol_2</span><span class="p">(</span><span class="n">P</span><span class="p">,</span><span class="n">t</span><span class="p">,[</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">]],</span><span class="n">map_1</span><span class="p">,</span><span class="n">map_2</span><span class="p">,</span><span class="n">cent</span><span class="p">,</span><span class="n">scale_factt</span><span class="p">,</span><span class="n">scale_factr</span><span class="p">,</span><span class="n">tol</span><span class="o">=</span><span class="mf">0.001</span><span class="p">)</span>
            <span class="c1">#cur_est = displacement_interp_pol(P,t,[shap[0],shap[1]],map_1,map_2,cent,1,tol=0.001)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">cur_est</span> <span class="o">=</span> <span class="n">displacement_interp</span><span class="p">(</span><span class="n">P</span><span class="p">,</span><span class="n">t</span><span class="p">,[</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">]],</span><span class="n">map_1</span><span class="p">,</span><span class="n">map_2</span><span class="p">,</span><span class="n">tol</span><span class="o">=</span><span class="mf">0.001</span><span class="p">)</span>
        <span class="n">cur_est_stack</span><span class="p">[:,:,</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">cur_est</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">centering</span><span class="p">:</span>
            <span class="n">cur_est</span> <span class="o">+=</span> <span class="n">inf_pos</span>
        <span class="n">cur_pos</span> <span class="o">=</span> <span class="p">(</span><span class="n">w</span><span class="o">*</span><span class="n">cur_pos</span><span class="o">+</span><span class="n">x</span><span class="p">[</span><span class="n">ind</span><span class="p">[</span><span class="o">-</span><span class="n">i</span><span class="o">-</span><span class="mi">2</span><span class="p">]]</span><span class="o">*</span><span class="n">data_pos</span><span class="p">[</span><span class="n">ind</span><span class="p">[</span><span class="o">-</span><span class="n">i</span><span class="o">-</span><span class="mi">2</span><span class="p">],:])</span><span class="o">/</span><span class="p">(</span><span class="n">w</span><span class="o">+</span><span class="n">x</span><span class="p">[</span><span class="n">ind</span><span class="p">[</span><span class="o">-</span><span class="n">i</span><span class="o">-</span><span class="mi">2</span><span class="p">]])</span>
        <span class="n">w</span> <span class="o">+=</span> <span class="n">x</span><span class="p">[</span><span class="n">ind</span><span class="p">[</span><span class="o">-</span><span class="n">i</span><span class="o">-</span><span class="mi">2</span><span class="p">]]</span>

    <span class="k">return</span> <span class="n">cur_est</span><span class="p">,</span><span class="n">inf_pos_stack</span><span class="p">,</span><span class="n">x</span><span class="p">,</span><span class="n">cur_est_stack</span><span class="p">,</span><span class="n">list_im</span>


<span class="k">def</span> <span class="nf">psf_sinkh_transport_ptbar2</span><span class="p">(</span><span class="n">psf_stack</span><span class="p">,</span><span class="n">data_pos</span><span class="p">,</span><span class="n">target_pos</span><span class="p">,</span><span class="n">beta</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span><span class="n">nb_iter</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span><span class="n">centering</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">pol_en</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">same</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">res_fact</span><span class="o">=</span><span class="mi">6</span><span class="p">,</span><span class="n">adaptive_gm</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">p</span><span class="o">=</span><span class="mi">3</span><span class="p">):</span>

    <span class="n">shap</span> <span class="o">=</span> <span class="n">psf_stack</span><span class="o">.</span><span class="n">shape</span>

    <span class="c1"># -------- barycentric coodinates calculation --------- #</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">optim_utils</span><span class="o">.</span><span class="n">bar_coord_pb_dijkstra</span><span class="p">(</span><span class="n">data_pos</span><span class="p">,</span><span class="n">target_pos</span><span class="p">,</span><span class="n">nb_iter</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
    <span class="n">nb_data</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">nb_data</span><span class="p">,))</span>
    <span class="n">ind</span> <span class="o">=</span> <span class="n">argsort</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

    <span class="n">linear_bar</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
        <span class="n">linear_bar</span><span class="o">+=</span><span class="n">psf_stack</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">]</span><span class="o">*</span><span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

    <span class="n">im_in</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="mi">2</span><span class="p">))</span>
    <span class="n">im_in</span><span class="p">[:,:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">psf_stack</span><span class="p">[:,:,</span><span class="n">ind</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]])</span>
    <span class="n">im_in</span><span class="p">[:,:,</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">linear_bar</span><span class="p">)</span>
    <span class="n">inf_pos</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">centering</span><span class="p">:</span>
        <span class="n">im_in</span><span class="p">,</span><span class="n">inf_pos</span> <span class="o">=</span> <span class="n">optim_utils</span><span class="o">.</span><span class="n">positive_centering</span><span class="p">(</span><span class="n">im_in</span><span class="p">)</span>

    <span class="c1"># ------- Local ground metric parameters computation ------- #</span>
    <span class="n">scale_factr</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">scale_factt</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">if</span> <span class="n">adaptive_gm</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">pol_en</span><span class="p">:</span>
            <span class="n">scale</span> <span class="o">=</span> <span class="n">im_in</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
            <span class="n">U1</span><span class="p">,</span><span class="n">s1</span><span class="p">,</span><span class="n">map1</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">im_shape</span><span class="p">(</span><span class="n">im_in</span><span class="p">[:,:,</span><span class="mi">0</span><span class="p">],</span><span class="n">scale</span><span class="o">=</span><span class="n">scale</span><span class="p">)</span>
            <span class="n">U2</span><span class="p">,</span><span class="n">s2</span><span class="p">,</span><span class="n">map2</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">im_shape</span><span class="p">(</span><span class="n">im_in</span><span class="p">[:,:,</span><span class="mi">1</span><span class="p">],</span><span class="n">scale</span><span class="o">=</span><span class="n">scale</span><span class="p">)</span>
            <span class="n">scale_factr</span> <span class="o">=</span> <span class="nb">min</span><span class="p">([</span><span class="n">s1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="n">s2</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">s2</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="n">s1</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span>
            <span class="n">scale_factt</span> <span class="o">=</span> <span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="n">U1</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">U2</span><span class="p">[:,</span><span class="mi">0</span><span class="p">])))</span><span class="o">**</span><span class="n">p</span>
            <span class="nb">print</span> <span class="n">scale_factr</span><span class="p">,</span><span class="n">scale_factt</span>

    <span class="c1"># ------- Transport plan computation ------- #</span>
    <span class="n">P</span><span class="p">,</span><span class="n">map_1</span><span class="p">,</span><span class="n">map_2</span><span class="p">,</span><span class="n">dist_mat</span><span class="p">,</span><span class="n">dyn_coeff</span><span class="p">,</span><span class="n">cent</span> <span class="o">=</span> <span class="n">psf_sinkh_transport_2</span><span class="p">(</span><span class="n">im_in</span><span class="p">[:,:,</span><span class="mi">0</span><span class="p">],</span><span class="n">im_in</span><span class="p">[:,:,</span><span class="mi">1</span><span class="p">],</span><span class="n">data_pos</span><span class="p">[</span><span class="n">ind</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],:],</span><span class="n">target_pos</span><span class="p">,</span><span class="n">res_fact</span><span class="p">,</span><span class="n">same</span><span class="o">=</span><span class="n">same</span><span class="p">,</span><span class="n">inf_val</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">beta</span><span class="o">=</span><span class="n">beta</span><span class="p">,</span><span class="n">nb_iter</span><span class="o">=</span><span class="n">nb_iter</span><span class="p">,</span><span class="n">pol_en</span><span class="o">=</span><span class="n">pol_en</span><span class="p">,</span><span class="n">scale_factr</span><span class="o">=</span><span class="n">scale_factr</span><span class="p">,</span><span class="n">scale_factt</span> <span class="o">=</span> <span class="n">scale_factt</span><span class="p">)</span>

    <span class="c1"># ------- Displacement interpolation ------- #</span>
    <span class="n">t</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="n">ind</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span><span class="o">/</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="nb">sum</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>

    <span class="n">transp_bar</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">pol_en</span><span class="p">:</span>
        <span class="n">transp_bar</span> <span class="o">=</span> <span class="n">displacement_interp_pol_2</span><span class="p">(</span><span class="n">P</span><span class="p">,</span><span class="n">t</span><span class="p">,[</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">]],</span><span class="n">map_1</span><span class="p">,</span><span class="n">map_2</span><span class="p">,</span><span class="n">cent</span><span class="p">,</span><span class="n">scale_factt</span><span class="p">,</span><span class="n">scale_factr</span><span class="p">,</span><span class="n">tol</span><span class="o">=</span><span class="mf">0.001</span><span class="p">)</span>
    <span class="c1">#cur_est = displacement_interp_pol(P,t,[shap[0],shap[1]],map_1,map_2,cent,1,tol=0.001)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">transp_bar</span> <span class="o">=</span> <span class="n">displacement_interp</span><span class="p">(</span><span class="n">P</span><span class="p">,</span><span class="n">t</span><span class="p">,[</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">]],</span><span class="n">map_1</span><span class="p">,</span><span class="n">map_2</span><span class="p">,</span><span class="n">tol</span><span class="o">=</span><span class="mf">0.001</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">transp_bar</span><span class="p">,</span><span class="n">linear_bar</span><span class="p">,</span><span class="n">inf_pos</span><span class="p">,</span><span class="n">x</span>


<span class="k">def</span> <span class="nf">psf_sinkh_transport_ptbar_stack</span><span class="p">(</span><span class="n">psf_stack</span><span class="p">,</span><span class="n">data_pos</span><span class="p">,</span><span class="n">target_pos</span><span class="p">,</span><span class="n">nb_points</span><span class="p">,</span><span class="n">beta</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span><span class="n">nb_iter</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span><span class="n">centering</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">pol_en</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">same</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">res_fact</span><span class="o">=</span><span class="mi">6</span><span class="p">,</span><span class="n">adaptive_gm</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">p</span><span class="o">=</span><span class="mi">3</span><span class="p">):</span>

    <span class="n">shap</span> <span class="o">=</span> <span class="n">target_pos</span><span class="o">.</span><span class="n">shape</span>

    <span class="n">shap_im</span> <span class="o">=</span> <span class="n">psf_stack</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">est_transp</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">shap_im</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">shap_im</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">nb_points</span><span class="p">))</span>
    <span class="n">est_lin</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">shap_im</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">shap_im</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">nb_points</span><span class="p">))</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
        <span class="n">ind</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">knearest</span><span class="p">(</span><span class="n">target_pos</span><span class="p">[</span><span class="n">i</span><span class="p">,:],</span><span class="n">data_pos</span><span class="p">,</span><span class="n">nb_points</span><span class="p">)</span>
        <span class="nb">print</span> <span class="n">ind</span><span class="p">,</span><span class="n">nb_points</span>
        <span class="n">cur_est</span><span class="p">,</span><span class="n">inf_pos_stack</span><span class="p">,</span><span class="n">x</span><span class="p">,</span><span class="n">cur_est_stack</span><span class="p">,</span><span class="n">list_im</span> <span class="o">=</span> <span class="n">psf_sinkh_transport_ptbar</span><span class="p">(</span><span class="n">psf_stack</span><span class="p">[:,:,</span><span class="n">ind</span><span class="p">],</span><span class="n">data_pos</span><span class="p">[</span><span class="n">ind</span><span class="p">,:],</span><span class="n">target_pos</span><span class="p">[</span><span class="n">i</span><span class="p">,:],</span><span class="n">beta</span><span class="o">=</span><span class="n">beta</span><span class="p">,</span><span class="n">nb_iter</span><span class="o">=</span><span class="n">nb_iter</span><span class="p">,</span><span class="n">centering</span><span class="o">=</span><span class="n">centering</span><span class="p">,</span><span class="n">pol_en</span><span class="o">=</span><span class="n">pol_en</span><span class="p">,</span><span class="n">same</span><span class="o">=</span><span class="n">same</span><span class="p">,</span><span class="n">res_fact</span><span class="o">=</span><span class="n">res_fact</span><span class="p">,</span><span class="n">adaptive_gm</span><span class="o">=</span><span class="n">adaptive_gm</span><span class="p">,</span><span class="n">p</span><span class="o">=</span><span class="n">p</span><span class="p">)</span>
        <span class="n">est_transp</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">cur_est</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_points</span><span class="p">):</span>
            <span class="n">est_lin</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">]</span><span class="o">+=</span><span class="n">x</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">*</span><span class="n">psf_stack</span><span class="p">[:,:,</span><span class="n">ind</span><span class="p">[</span><span class="n">k</span><span class="p">]]</span>

    <span class="k">return</span> <span class="n">est_transp</span><span class="p">,</span><span class="n">est_lin</span>

<span class="k">def</span> <span class="nf">psf_sinkh_transport_ptbar_stackm</span><span class="p">(</span><span class="n">psf_stack</span><span class="p">,</span><span class="n">data_pos</span><span class="p">,</span><span class="n">target_pos</span><span class="p">,</span><span class="n">nb_points</span><span class="p">,</span><span class="n">beta</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span><span class="n">nb_iter</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span><span class="n">centering</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">pol_en</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">same</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">res_fact</span><span class="o">=</span><span class="mi">6</span><span class="p">,</span><span class="n">adaptive_gm</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">p</span><span class="o">=</span><span class="mi">3</span><span class="p">):</span>
    <span class="n">list_trans</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
    <span class="n">list_lin</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
    <span class="n">nb_realizations</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">psf_stack</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_realizations</span><span class="p">):</span>
        <span class="n">est_transp</span><span class="p">,</span><span class="n">est_lin</span> <span class="o">=</span> <span class="n">psf_sinkh_transport_ptbar_stack</span><span class="p">(</span><span class="n">psf_stack</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">data_pos</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">target_pos</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">nb_points</span><span class="p">,</span><span class="n">beta</span><span class="o">=</span><span class="n">beta</span><span class="p">,</span><span class="n">nb_iter</span><span class="o">=</span><span class="n">nb_iter</span><span class="p">,</span><span class="n">centering</span><span class="o">=</span><span class="n">centering</span><span class="p">,</span><span class="n">pol_en</span><span class="o">=</span><span class="n">pol_en</span><span class="p">,</span><span class="n">same</span><span class="o">=</span><span class="n">same</span><span class="p">,</span><span class="n">res_fact</span><span class="o">=</span><span class="n">res_fact</span><span class="p">,</span><span class="n">adaptive_gm</span><span class="o">=</span><span class="n">adaptive_gm</span><span class="p">,</span><span class="n">p</span><span class="o">=</span><span class="n">p</span><span class="p">)</span>
        <span class="n">list_trans</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">est_transp</span><span class="p">)</span>
        <span class="n">list_lin</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">est_lin</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">list_trans</span><span class="p">,</span><span class="n">list_lin</span>


<span class="k">def</span> <span class="nf">psf_field_sinkh_transport_bar</span><span class="p">(</span><span class="n">psf_stack</span><span class="p">,</span><span class="n">dist_maps</span><span class="p">,</span><span class="n">data_pos</span><span class="p">,</span><span class="n">target_pos</span><span class="p">,</span><span class="n">nb_psf_interp</span><span class="p">,</span><span class="n">beta</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span><span class="n">nb_iter</span><span class="o">=</span><span class="mi">500</span><span class="p">):</span>
    <span class="n">shap</span> <span class="o">=</span> <span class="n">psf_stack</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">distribs</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
        <span class="c1"># Distribution matrix setting</span>
        <span class="n">distribs</span><span class="p">[</span><span class="n">i</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">psf_stack</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">],))</span><span class="o">/</span><span class="n">psf_stack</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    <span class="n">bar_distribs</span><span class="p">,</span><span class="n">P</span> <span class="o">=</span> <span class="n">field_sinkh_transport_bar</span><span class="p">(</span><span class="n">distribs</span><span class="p">,</span><span class="n">dist_maps</span><span class="p">,</span><span class="n">data_pos</span><span class="p">,</span><span class="n">target_pos</span><span class="p">,</span><span class="n">nb_psf_interp</span><span class="p">,</span><span class="n">beta</span><span class="o">=</span><span class="n">beta</span><span class="p">,</span><span class="n">nb_iter</span><span class="o">=</span><span class="n">nb_iter</span><span class="p">)</span>
    <span class="n">output</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">bar_distribs</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">bar_distribs</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
        <span class="n">output</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">bar_distribs</span><span class="p">[</span><span class="n">i</span><span class="p">,:]</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
    <span class="k">return</span> <span class="n">output</span>

<span class="k">def</span> <span class="nf">field_sinkh_transport_bar</span><span class="p">(</span><span class="n">distribs</span><span class="p">,</span><span class="n">dist_maps</span><span class="p">,</span><span class="n">data_pos</span><span class="p">,</span><span class="n">target_pos</span><span class="p">,</span><span class="n">nb_psf_interp</span><span class="p">,</span><span class="n">beta</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span><span class="n">nb_iter</span><span class="o">=</span><span class="mi">500</span><span class="p">):</span>
    <span class="n">shap1</span> <span class="o">=</span> <span class="n">distribs</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">shap2</span> <span class="o">=</span> <span class="n">target_pos</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">shap3</span> <span class="o">=</span> <span class="n">data_pos</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">bar_distribs</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">shap2</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">shap1</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
    <span class="n">ones_vect</span> <span class="o">=</span> <span class="n">ones</span><span class="p">((</span><span class="n">shap3</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="mi">1</span><span class="p">))</span>
    <span class="n">P</span><span class="o">=</span><span class="kc">None</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap2</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
        <span class="c1"># Neighbors computation</span>
        <span class="n">u</span> <span class="o">=</span> <span class="n">target_pos</span><span class="p">[</span><span class="n">i</span><span class="p">,:]</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span>
        <span class="n">delta</span> <span class="o">=</span> <span class="n">data_pos</span> <span class="o">-</span> <span class="n">ones_vect</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">u</span><span class="p">)</span>
        <span class="n">dist</span> <span class="o">=</span> <span class="n">sqrt</span><span class="p">((</span><span class="n">delta</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
        <span class="n">ind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">dist</span><span class="p">)</span>
        <span class="n">P</span><span class="p">,</span><span class="n">bar</span> <span class="o">=</span> <span class="n">sinkh_transport_bar</span><span class="p">(</span><span class="n">distribs</span><span class="p">[</span><span class="n">ind</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">nb_psf_interp</span><span class="p">],:],</span><span class="n">dist_maps</span><span class="p">,</span><span class="n">data_pos</span><span class="p">[</span><span class="n">ind</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">nb_psf_interp</span><span class="p">],:],</span><span class="n">target_pos</span><span class="p">[</span><span class="n">i</span><span class="p">,:],</span><span class="n">beta</span><span class="o">=</span><span class="n">beta</span><span class="p">,</span><span class="n">nb_iter</span><span class="o">=</span><span class="n">nb_iter</span><span class="p">)</span>
        <span class="n">bar_distribs</span><span class="p">[</span><span class="n">i</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">bar</span>
    <span class="k">return</span> <span class="n">bar_distribs</span><span class="p">,</span><span class="n">P</span>

<span class="k">def</span> <span class="nf">field_sinkh_transport_bar_reg</span><span class="p">(</span><span class="n">distribs</span><span class="p">,</span><span class="n">next_mat</span><span class="p">,</span><span class="n">lin_bar</span><span class="p">,</span><span class="n">dist_maps</span><span class="p">,</span><span class="n">data_pos</span><span class="p">,</span><span class="n">target_pos</span><span class="p">,</span><span class="n">nb_psf_interp</span><span class="p">,</span><span class="n">beta</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span><span class="n">nb_iter</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">trust</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span><span class="n">tol</span><span class="o">=</span><span class="mi">5000</span><span class="p">,</span><span class="n">pw</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span> <span class="c1"># This function&#39;s purpose is to adjust the linear barycenter</span>
    <span class="n">shap1</span> <span class="o">=</span> <span class="n">distribs</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">shap2</span> <span class="o">=</span> <span class="n">target_pos</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">shap3</span> <span class="o">=</span> <span class="n">data_pos</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">bar_distribs</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">shap2</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">shap1</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
    <span class="n">ones_vect</span> <span class="o">=</span> <span class="n">ones</span><span class="p">((</span><span class="n">shap3</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="mi">1</span><span class="p">))</span>
    <span class="n">Pmax</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">shap1</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">shap1</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
    <span class="nb">input</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">nb_psf_interp</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">shap1</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
    <span class="n">weights</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">nb_psf_interp</span><span class="o">+</span><span class="mi">1</span><span class="p">,))</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">trust</span><span class="p">)</span><span class="o">/</span><span class="n">nb_psf_interp</span>

    <span class="nb">print</span> <span class="s2">&quot;Contructing PSF tree...&quot;</span>
    <span class="n">neigh</span><span class="p">,</span><span class="n">dists</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">knn_interf</span><span class="p">(</span><span class="n">data_pos</span><span class="p">,</span><span class="n">shap3</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="nb">print</span> <span class="s2">&quot;Done...&quot;</span>
    <span class="n">dist_med</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">dists</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap2</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
        <span class="c1"># Neighbors computation</span>
        <span class="n">u</span> <span class="o">=</span> <span class="n">target_pos</span><span class="p">[</span><span class="n">i</span><span class="p">,:]</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span>
        <span class="n">delta</span> <span class="o">=</span> <span class="n">data_pos</span> <span class="o">-</span> <span class="n">ones_vect</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">u</span><span class="p">)</span>
        <span class="n">dist</span> <span class="o">=</span> <span class="n">sqrt</span><span class="p">((</span><span class="n">delta</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
        <span class="n">ind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">dist</span><span class="p">)</span>
        <span class="nb">input</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">nb_psf_interp</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">distribs</span><span class="p">[</span><span class="n">ind</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">nb_psf_interp</span><span class="p">],:]</span>
        <span class="nb">input</span><span class="p">[</span><span class="n">nb_psf_interp</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">lin_bar</span><span class="p">[</span><span class="n">i</span><span class="p">,:]</span>
        <span class="n">trust</span> <span class="o">=</span> <span class="mi">1</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="p">(</span><span class="n">median</span><span class="p">(</span><span class="n">dist</span><span class="p">[</span><span class="n">ind</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">nb_psf_interp</span><span class="p">]])</span><span class="o">/</span><span class="p">(</span><span class="n">tol</span><span class="o">*</span><span class="n">dist_med</span><span class="p">)))</span>
        <span class="nb">print</span> <span class="s2">&quot;trust index: &quot;</span><span class="p">,</span><span class="n">trust</span>
        <span class="c1">#weights = ones((nb_psf_interp+1,))*(1-trust)/nb_psf_interp</span>
        <span class="c1">#weights[nb_psf_interp] = trust</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_psf_interp</span><span class="p">):</span>
            <span class="n">weights</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">dist</span><span class="p">[</span><span class="n">ind</span><span class="p">[</span><span class="n">k</span><span class="p">]]</span><span class="o">**</span><span class="p">(</span><span class="n">pw</span><span class="p">)</span>
        <span class="n">weights</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">nb_psf_interp</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">trust</span><span class="p">)</span><span class="o">*</span><span class="n">weights</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">nb_psf_interp</span><span class="p">]</span><span class="o">/</span><span class="p">(</span><span class="n">weights</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">nb_psf_interp</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span>
        <span class="n">weights</span><span class="p">[</span><span class="n">nb_psf_interp</span><span class="p">]</span> <span class="o">=</span> <span class="n">trust</span>
        <span class="c1">#weights = ones((nb_psf_interp+1,))/(nb_psf_interp+1)</span>
        <span class="c1"># Transport upper bound maps computation</span>
        <span class="sd">&quot;&quot;&quot;Pmax = zeros((shap1[1],shap1[1]))</span>
<span class="sd">        for k in range(0,nb_psf_interp):</span>

<span class="sd">            P,dist = optim_utils.beg_proj_transp(dist_maps[:,:,ind[k]],lin_bar[i,:].reshape((shap1[1],1)),distribs[ind[k],:].reshape((shap1[1],1)),beta=beta,nb_iter=nb_iter)</span>
<span class="sd">            i1,i2 = where(P&gt;Pmax)</span>
<span class="sd">            Pmax[i1,i2] = P[i1,i2]&quot;&quot;&quot;</span>
        <span class="c1">#P,bar = optim_utils.beg_proj_transp_bar(dist_maps[:,:,ind[0:nb_psf_interp+1]],input,weights,beta=beta,nb_iter=nb_iter)</span>
        <span class="n">bar</span> <span class="o">=</span> <span class="n">optim_utils</span><span class="o">.</span><span class="n">beg_proj_transp_ptbar</span><span class="p">(</span><span class="n">dist_maps</span><span class="p">[:,:,</span><span class="mi">0</span><span class="p">],</span><span class="n">next_mat</span><span class="p">,</span><span class="nb">input</span><span class="p">,</span><span class="n">weights</span><span class="p">,</span><span class="n">inf_val</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">beta</span><span class="o">=</span><span class="n">beta</span><span class="p">,</span><span class="n">nb_iter</span><span class="o">=</span><span class="n">nb_iter</span><span class="p">)</span>
        <span class="c1">#P,bar = optim_utils.beg_proj_transp_capacity(dist_maps[:,:,ind[0]],Pmax,lin_bar[i,:].reshape((shap1[1],1)),beta=beta,nb_iter=800)</span>
        <span class="c1">#P,bar = sinkh_transport_bar(distribs[ind[0:nb_psf_interp],:],dist_maps[:,:,ind[0:nb_psf_interp]],data_pos[ind[0:nb_psf_interp],:],target_pos[i,:],beta=beta,nb_iter=nb_iter)</span>
        <span class="n">bar_distribs</span><span class="p">[</span><span class="n">i</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">bar</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">size</span><span class="p">(</span><span class="n">bar</span><span class="p">),))</span>
    <span class="k">return</span> <span class="n">bar_distribs</span><span class="p">,</span><span class="n">Pmax</span>

<span class="k">def</span> <span class="nf">field_sinkh_transport_bar_located</span><span class="p">(</span><span class="n">distribs</span><span class="p">,</span><span class="n">dist_maps</span><span class="p">,</span><span class="n">data_pos</span><span class="p">,</span><span class="n">target_pos</span><span class="p">,</span><span class="n">src_pos</span><span class="p">,</span><span class="n">nb_psf_interp</span><span class="p">,</span><span class="n">beta</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span><span class="n">nb_iter</span><span class="o">=</span><span class="mi">500</span><span class="p">):</span>
    <span class="n">shap1</span> <span class="o">=</span> <span class="n">distribs</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">shap2</span> <span class="o">=</span> <span class="n">target_pos</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">shap3</span> <span class="o">=</span> <span class="n">data_pos</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">bar_distribs</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">shap2</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">shap1</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
    <span class="n">ones_vect</span> <span class="o">=</span> <span class="n">ones</span><span class="p">((</span><span class="n">shap3</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="mi">1</span><span class="p">))</span>
    <span class="n">P</span><span class="o">=</span><span class="kc">None</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap2</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
        <span class="c1"># Neighbors computation</span>
        <span class="n">u</span> <span class="o">=</span> <span class="n">target_pos</span><span class="p">[</span><span class="n">i</span><span class="p">,:]</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span>
        <span class="n">delta</span> <span class="o">=</span> <span class="n">data_pos</span> <span class="o">-</span> <span class="n">ones_vect</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">u</span><span class="p">)</span>
        <span class="n">dist</span> <span class="o">=</span> <span class="n">sqrt</span><span class="p">((</span><span class="n">delta</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
        <span class="n">ind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">dist</span><span class="p">)</span>
        <span class="n">P</span><span class="p">,</span><span class="n">bar</span> <span class="o">=</span> <span class="n">sinkh_transport_bar_located</span><span class="p">(</span><span class="n">distribs</span><span class="p">[</span><span class="n">ind</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">nb_psf_interp</span><span class="p">],:],</span><span class="n">dist_maps</span><span class="p">[:,:,</span><span class="n">ind</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">nb_psf_interp</span><span class="p">]],</span><span class="n">data_pos</span><span class="p">[</span><span class="n">ind</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">nb_psf_interp</span><span class="p">],:],</span><span class="n">target_pos</span><span class="p">[</span><span class="n">i</span><span class="p">,:],</span><span class="n">src_pos</span><span class="p">,</span><span class="n">beta</span><span class="o">=</span><span class="n">beta</span><span class="p">,</span><span class="n">nb_iter</span><span class="o">=</span><span class="n">nb_iter</span><span class="p">)</span>
        <span class="n">bar_distribs</span><span class="p">[</span><span class="n">i</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">bar</span>
    <span class="k">return</span> <span class="n">bar_distribs</span><span class="p">,</span><span class="n">P</span>


<span class="k">def</span> <span class="nf">field_sinkh_transport_ptbar</span><span class="p">(</span><span class="n">distribs</span><span class="p">,</span><span class="n">dist_mat</span><span class="p">,</span><span class="n">next_mat</span><span class="p">,</span><span class="n">data_pos</span><span class="p">,</span><span class="n">target_pos</span><span class="p">,</span><span class="n">nb_psf_interp</span><span class="p">,</span><span class="n">beta</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span><span class="n">nb_iter</span><span class="o">=</span><span class="mi">100</span><span class="p">):</span>
    <span class="n">shap1</span> <span class="o">=</span> <span class="n">distribs</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">shap2</span> <span class="o">=</span> <span class="n">target_pos</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">shap3</span> <span class="o">=</span> <span class="n">data_pos</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">bar_distribs</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">shap2</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">shap1</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
    <span class="n">ones_vect</span> <span class="o">=</span> <span class="n">ones</span><span class="p">((</span><span class="n">shap3</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="mi">1</span><span class="p">))</span>
    <span class="n">P</span><span class="o">=</span><span class="kc">None</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap2</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
        <span class="c1"># Neighbors computation</span>
        <span class="n">u</span> <span class="o">=</span> <span class="n">target_pos</span><span class="p">[</span><span class="n">i</span><span class="p">,:]</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span>
        <span class="n">delta</span> <span class="o">=</span> <span class="n">data_pos</span> <span class="o">-</span> <span class="n">ones_vect</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">u</span><span class="p">)</span>
        <span class="n">dist</span> <span class="o">=</span> <span class="n">sqrt</span><span class="p">((</span><span class="n">delta</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
        <span class="n">ind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">dist</span><span class="p">)</span>
        <span class="n">bar</span> <span class="o">=</span> <span class="n">sinkh_transport_ptbar</span><span class="p">(</span><span class="n">distribs</span><span class="p">[</span><span class="n">ind</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">nb_psf_interp</span><span class="p">],:],</span><span class="n">dist_mat</span><span class="p">,</span><span class="n">next_mat</span><span class="p">,</span><span class="n">data_pos</span><span class="p">[</span><span class="n">ind</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">nb_psf_interp</span><span class="p">],:],</span><span class="n">target_pos</span><span class="p">[</span><span class="n">i</span><span class="p">,:],</span><span class="n">beta</span><span class="o">=</span><span class="n">beta</span><span class="p">,</span><span class="n">nb_iter</span><span class="o">=</span><span class="n">nb_iter</span><span class="p">)</span>
        <span class="n">bar_distribs</span><span class="p">[</span><span class="n">i</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">bar</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">shap1</span><span class="p">[</span><span class="mi">1</span><span class="p">],))</span>
    <span class="k">return</span> <span class="n">bar_distribs</span>

<span class="k">def</span> <span class="nf">field_transport_ptbar</span><span class="p">(</span><span class="n">distribs</span><span class="p">,</span><span class="n">dist_mat</span><span class="p">,</span><span class="n">next_mat</span><span class="p">,</span><span class="n">target_pos</span><span class="p">,</span><span class="n">pos_scaling</span><span class="p">,</span><span class="n">nb_psf_interp</span><span class="p">,</span><span class="n">siz</span><span class="p">,</span><span class="n">beta</span><span class="o">=</span><span class="mi">60</span><span class="p">):</span>
    <span class="n">shap1</span> <span class="o">=</span> <span class="n">distribs</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">anchor_ind</span> <span class="o">=</span> <span class="p">[</span><span class="n">shap1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span><span class="n">shap1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">shap2</span> <span class="o">=</span> <span class="n">target_pos</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">bar_distribs</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">siz</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">siz</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">shap2</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
    <span class="n">pos_interp</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">shap2</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="mi">2</span><span class="p">))</span>
    <span class="n">ones_vect</span> <span class="o">=</span> <span class="n">ones</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span><span class="n">shap1</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
    <span class="n">weights</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">shap1</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">shap2</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
    <span class="n">P</span><span class="o">=</span><span class="kc">None</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap2</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
        <span class="c1"># Neighbors computation</span>
        <span class="nb">print</span> <span class="n">i</span>
        <span class="n">u</span> <span class="o">=</span> <span class="n">target_pos</span><span class="p">[</span><span class="n">i</span><span class="p">,:]</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>
        <span class="n">delta</span> <span class="o">=</span> <span class="n">distribs</span><span class="p">[</span><span class="n">anchor_ind</span><span class="p">,:]</span> <span class="o">-</span> <span class="n">u</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">ones_vect</span><span class="p">)</span><span class="o">*</span><span class="n">pos_scaling</span>
        <span class="n">dist</span> <span class="o">=</span> <span class="n">sqrt</span><span class="p">((</span><span class="n">delta</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
        <span class="n">ind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">dist</span><span class="p">)</span>
        <span class="c1">#S = distribs[:,ind[0:nb_psf_interp]]</span>
        <span class="n">target_feat</span> <span class="o">=</span> <span class="n">pos_scaling</span><span class="o">*</span><span class="n">target_pos</span><span class="p">[</span><span class="n">i</span><span class="p">,:]</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>
        <span class="n">bar</span><span class="p">,</span><span class="n">weights_i</span> <span class="o">=</span> <span class="n">optim_utils</span><span class="o">.</span><span class="n">graph_transport_ptbar</span><span class="p">(</span><span class="n">dist_mat</span><span class="p">,</span><span class="n">next_mat</span><span class="p">,</span><span class="n">ind</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">nb_psf_interp</span><span class="p">],</span><span class="n">distribs</span><span class="p">,</span><span class="n">target_feat</span><span class="p">,</span><span class="n">anchor_ind</span><span class="p">,</span><span class="n">nb_loops</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span><span class="n">tol</span><span class="o">=</span><span class="mf">0.000001</span><span class="p">,</span><span class="n">beta</span><span class="o">=</span><span class="n">beta</span><span class="p">)</span>
        <span class="n">bar_distribs</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">bar</span><span class="p">[:</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">siz</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">siz</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
        <span class="n">pos_interp</span><span class="p">[</span><span class="n">i</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">bar</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">:,</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">weights</span><span class="p">[:,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">weights_i</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">shap1</span><span class="p">[</span><span class="mi">1</span><span class="p">],))</span>
    <span class="k">return</span> <span class="n">bar_distribs</span><span class="p">,</span><span class="n">pos_interp</span><span class="p">,</span><span class="n">weights</span>


<span class="k">def</span> <span class="nf">r_theta_dist_map</span><span class="p">(</span><span class="n">siz</span><span class="p">,</span><span class="n">alpha</span><span class="p">,</span><span class="n">cent</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">cent</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">cent</span> <span class="o">=</span> <span class="p">[</span><span class="n">siz</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span><span class="n">siz</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span><span class="p">]</span>
    <span class="nb">map</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">siz</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">siz</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">siz</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">siz</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
    <span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span>
    <span class="n">dyn_coeff</span> <span class="o">=</span> <span class="n">sqrt</span><span class="p">((</span><span class="n">siz</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="p">(</span><span class="n">siz</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="o">*</span><span class="n">pi</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">siz</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">siz</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
        <span class="n">i1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">int</span><span class="p">(</span><span class="n">i</span><span class="o">/</span><span class="n">siz</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="c1"># Line index in map1</span>
        <span class="n">j1</span> <span class="o">=</span> <span class="n">mod</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">siz</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">r1</span><span class="p">,</span><span class="n">theta1</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">polar_coord</span><span class="p">([</span><span class="n">i1</span><span class="p">,</span><span class="n">j1</span><span class="p">],</span><span class="n">cent</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">siz</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">siz</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
            <span class="n">i2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">int</span><span class="p">(</span><span class="n">j</span><span class="o">/</span><span class="n">siz</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="c1"># Line index in map2</span>
            <span class="n">j2</span> <span class="o">=</span> <span class="n">mod</span><span class="p">(</span><span class="n">j</span><span class="p">,</span><span class="n">siz</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">r2</span><span class="p">,</span><span class="n">theta2</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">polar_coord</span><span class="p">([</span><span class="n">i2</span><span class="p">,</span><span class="n">j2</span><span class="p">],</span><span class="n">cent</span><span class="p">)</span>
            <span class="nb">map</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span><span class="o">=</span><span class="n">sqrt</span><span class="p">((</span><span class="n">r1</span><span class="o">-</span><span class="n">r2</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="p">(</span><span class="n">dyn_coeff</span><span class="o">*</span><span class="n">alpha</span><span class="o">*</span><span class="p">(</span><span class="n">theta1</span><span class="o">-</span><span class="n">theta2</span><span class="p">))</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>

    <span class="k">return</span> <span class="nb">map</span><span class="p">,</span><span class="n">dyn_coeff</span>

<span class="k">def</span> <span class="nf">r_theta_rig_dist_map</span><span class="p">(</span><span class="n">siz</span><span class="p">,</span><span class="n">alpha</span><span class="p">,</span><span class="n">theta</span><span class="p">,</span><span class="n">tol</span><span class="p">,</span><span class="n">inf_val</span><span class="o">=</span><span class="mf">1e64</span><span class="p">,</span><span class="n">cent</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">cent</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">cent</span> <span class="o">=</span> <span class="p">[</span><span class="n">siz</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span><span class="n">siz</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span><span class="p">]</span>
    <span class="nb">map</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">siz</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">siz</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">siz</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">siz</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
    <span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span>
    <span class="n">dyn_coeff</span> <span class="o">=</span> <span class="n">sqrt</span><span class="p">((</span><span class="n">siz</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="p">(</span><span class="n">siz</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="o">*</span><span class="n">pi</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">siz</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">siz</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
        <span class="n">i1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">int</span><span class="p">(</span><span class="n">i</span><span class="o">/</span><span class="n">siz</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="c1"># Line index in map1</span>
        <span class="n">j1</span> <span class="o">=</span> <span class="n">mod</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">siz</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">r1</span><span class="p">,</span><span class="n">theta1</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">polar_coord</span><span class="p">([</span><span class="n">i1</span><span class="p">,</span><span class="n">j1</span><span class="p">],</span><span class="n">cent</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">siz</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">siz</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
            <span class="n">i2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">int</span><span class="p">(</span><span class="n">j</span><span class="o">/</span><span class="n">siz</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="c1"># Line index in map2</span>
            <span class="n">j2</span> <span class="o">=</span> <span class="n">mod</span><span class="p">(</span><span class="n">j</span><span class="p">,</span><span class="n">siz</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">r2</span><span class="p">,</span><span class="n">theta2</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">polar_coord</span><span class="p">([</span><span class="n">i2</span><span class="p">,</span><span class="n">j2</span><span class="p">],</span><span class="n">cent</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">r1</span><span class="o">==</span><span class="mi">0</span> <span class="ow">and</span> <span class="n">r2</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
                <span class="nb">map</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span><span class="o">=</span><span class="mi">0</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">a</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">if</span> <span class="n">r2</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
                    <span class="n">a</span> <span class="o">=</span> <span class="n">arcsin</span><span class="p">(</span><span class="n">r1</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>
                <span class="k">elif</span> <span class="n">r1</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
                    <span class="n">a</span> <span class="o">=</span> <span class="n">arcsin</span><span class="p">(</span><span class="n">r2</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">a</span> <span class="o">=</span> <span class="n">arcsin</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">r1</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span><span class="n">r2</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)))</span>
                <span class="n">tol_rel</span> <span class="o">=</span> <span class="n">tol</span><span class="o">*</span><span class="n">a</span>
                <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">theta1</span><span class="o">-</span><span class="n">theta2</span><span class="o">-</span><span class="n">theta</span><span class="p">)</span><span class="o">&lt;</span><span class="n">tol_rel</span><span class="p">:</span>
                    <span class="nb">map</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span><span class="o">=</span><span class="n">sqrt</span><span class="p">((</span><span class="n">r1</span><span class="o">-</span><span class="n">r2</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="p">(</span><span class="n">dyn_coeff</span><span class="o">*</span><span class="n">alpha</span><span class="o">*</span><span class="p">(</span><span class="n">theta1</span><span class="o">-</span><span class="n">theta2</span><span class="p">))</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="nb">map</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">inf_val</span>

    <span class="k">return</span> <span class="nb">map</span><span class="p">,</span><span class="n">dyn_coeff</span>

<span class="k">def</span> <span class="nf">r_theta_rig_dist_map_2</span><span class="p">(</span><span class="n">siz</span><span class="p">,</span><span class="n">alpha</span><span class="p">,</span><span class="n">theta</span><span class="p">,</span><span class="n">tol</span><span class="p">,</span><span class="n">inf_val</span><span class="o">=</span><span class="mf">1e64</span><span class="p">,</span><span class="n">cent</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">cent</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">cent</span> <span class="o">=</span> <span class="p">[</span><span class="n">siz</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span><span class="n">siz</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">rmax</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">sqrt</span><span class="p">(</span><span class="n">siz</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="n">siz</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">))</span><span class="o">+</span><span class="mi">1</span>
    <span class="n">dyn_coeff</span> <span class="o">=</span> <span class="mi">1</span><span class="c1">#rmax/2*pi</span>
    <span class="nb">map</span> <span class="o">=</span> <span class="n">ones</span><span class="p">((</span><span class="n">siz</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">siz</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">siz</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">siz</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span><span class="o">*</span><span class="n">inf_val</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">siz</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">siz</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
        <span class="n">i1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">int</span><span class="p">(</span><span class="n">i</span><span class="o">/</span><span class="n">siz</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="c1"># Line index in map1</span>
        <span class="n">j1</span> <span class="o">=</span> <span class="n">mod</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">siz</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">r1</span><span class="p">,</span><span class="n">theta1</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">polar_coord</span><span class="p">([</span><span class="n">i1</span><span class="p">,</span><span class="n">j1</span><span class="p">],</span><span class="n">cent</span><span class="p">)</span>
        <span class="n">rk</span><span class="o">=</span><span class="mi">0</span>
        <span class="n">thetak</span> <span class="o">=</span> <span class="n">theta1</span><span class="o">+</span><span class="n">theta</span>
        <span class="k">for</span> <span class="n">rk</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">rmax</span><span class="p">):</span>
            <span class="n">ik</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">int</span><span class="p">(</span><span class="n">rk</span><span class="o">*</span><span class="n">cos</span><span class="p">(</span><span class="n">thetak</span><span class="p">)</span><span class="o">+</span><span class="n">cent</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">jk</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">int</span><span class="p">(</span><span class="n">rk</span><span class="o">*</span><span class="n">sin</span><span class="p">(</span><span class="n">thetak</span><span class="p">)</span><span class="o">+</span><span class="n">cent</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">ik</span><span class="o">&gt;=</span><span class="mi">0</span> <span class="ow">and</span> <span class="n">ik</span><span class="o">&lt;</span><span class="n">siz</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">and</span> <span class="n">jk</span><span class="o">&gt;=</span><span class="mi">0</span> <span class="ow">and</span> <span class="n">jk</span><span class="o">&lt;</span><span class="n">siz</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
                <span class="nb">map</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">ik</span><span class="o">*</span><span class="n">siz</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">jk</span><span class="p">]</span><span class="o">=</span><span class="n">sqrt</span><span class="p">((</span><span class="n">r1</span><span class="o">-</span><span class="n">rk</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="p">(</span><span class="n">dyn_coeff</span><span class="o">*</span><span class="n">alpha</span><span class="o">*</span><span class="n">theta</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">siz</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">siz</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
        <span class="n">i1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">int</span><span class="p">(</span><span class="n">j</span><span class="o">/</span><span class="n">siz</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="c1"># Line index in map1</span>
        <span class="n">j1</span> <span class="o">=</span> <span class="n">mod</span><span class="p">(</span><span class="n">j</span><span class="p">,</span><span class="n">siz</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">r1</span><span class="p">,</span><span class="n">theta1</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">polar_coord</span><span class="p">([</span><span class="n">i1</span><span class="p">,</span><span class="n">j1</span><span class="p">],</span><span class="n">cent</span><span class="p">)</span>
        <span class="n">rk</span><span class="o">=</span><span class="mi">0</span>
        <span class="n">thetak</span> <span class="o">=</span> <span class="n">theta1</span><span class="o">-</span><span class="n">theta</span>
        <span class="k">for</span> <span class="n">rk</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">rmax</span><span class="p">):</span>
            <span class="n">ik</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">int</span><span class="p">(</span><span class="n">rk</span><span class="o">*</span><span class="n">cos</span><span class="p">(</span><span class="n">thetak</span><span class="p">)</span><span class="o">+</span><span class="n">cent</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">jk</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">int</span><span class="p">(</span><span class="n">rk</span><span class="o">*</span><span class="n">sin</span><span class="p">(</span><span class="n">thetak</span><span class="p">)</span><span class="o">+</span><span class="n">cent</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">ik</span><span class="o">&gt;=</span><span class="mi">0</span> <span class="ow">and</span> <span class="n">ik</span><span class="o">&lt;</span><span class="n">siz</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">and</span> <span class="n">jk</span><span class="o">&gt;=</span><span class="mi">0</span> <span class="ow">and</span> <span class="n">jk</span><span class="o">&lt;</span><span class="n">siz</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="ow">and</span> <span class="nb">map</span><span class="p">[</span><span class="n">ik</span><span class="o">*</span><span class="n">siz</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">jk</span><span class="p">,</span><span class="n">j</span><span class="p">]</span><span class="o">==</span><span class="n">inf_val</span><span class="p">:</span>
                <span class="nb">map</span><span class="p">[</span><span class="n">ik</span><span class="o">*</span><span class="n">siz</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">jk</span><span class="p">,</span><span class="n">j</span><span class="p">]</span><span class="o">=</span><span class="n">sqrt</span><span class="p">((</span><span class="n">r1</span><span class="o">-</span><span class="n">rk</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="p">(</span><span class="n">dyn_coeff</span><span class="o">*</span><span class="n">alpha</span><span class="o">*</span><span class="n">theta</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>


    <span class="k">return</span> <span class="nb">map</span><span class="p">,</span> <span class="n">dyn_coeff</span>

<span class="k">def</span> <span class="nf">r_theta_rig_dist_map_3</span><span class="p">(</span><span class="n">siz</span><span class="p">,</span><span class="n">theta</span><span class="p">,</span><span class="n">inf_val</span><span class="o">=</span><span class="mf">1e64</span><span class="p">,</span><span class="n">cent</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">cent</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">cent</span> <span class="o">=</span> <span class="p">[</span><span class="n">siz</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span><span class="n">siz</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">rmax</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">sqrt</span><span class="p">(</span><span class="n">siz</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="n">siz</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">))</span><span class="o">+</span><span class="mi">1</span>
    <span class="n">mapr</span> <span class="o">=</span> <span class="n">ones</span><span class="p">((</span><span class="n">siz</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">siz</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">siz</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">siz</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span><span class="o">*</span><span class="n">inf_val</span>
    <span class="n">maptheta</span> <span class="o">=</span> <span class="n">ones</span><span class="p">((</span><span class="n">siz</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">siz</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">siz</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">siz</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span><span class="o">*</span><span class="n">inf_val</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">siz</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">siz</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
        <span class="n">i1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">int</span><span class="p">(</span><span class="n">i</span><span class="o">/</span><span class="n">siz</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="c1"># Line index in map1</span>
        <span class="n">j1</span> <span class="o">=</span> <span class="n">mod</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">siz</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">r1</span><span class="p">,</span><span class="n">theta1</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">polar_coord</span><span class="p">([</span><span class="n">i1</span><span class="p">,</span><span class="n">j1</span><span class="p">],</span><span class="n">cent</span><span class="p">)</span>
        <span class="n">rk</span><span class="o">=</span><span class="mi">0</span>
        <span class="n">thetak</span> <span class="o">=</span> <span class="n">theta1</span><span class="o">+</span><span class="n">theta</span>
        <span class="k">for</span> <span class="n">rk</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">rmax</span><span class="o">*</span><span class="mi">2</span><span class="p">):</span>
            <span class="n">ik</span>  <span class="o">=</span> <span class="nb">round</span><span class="p">((</span><span class="n">double</span><span class="p">(</span><span class="n">rk</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">cos</span><span class="p">(</span><span class="n">thetak</span><span class="p">)</span><span class="o">+</span><span class="n">cent</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">jk</span>  <span class="o">=</span> <span class="nb">round</span><span class="p">((</span><span class="n">double</span><span class="p">(</span><span class="n">rk</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">sin</span><span class="p">(</span><span class="n">thetak</span><span class="p">)</span><span class="o">+</span><span class="n">cent</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">ik</span><span class="o">&gt;=</span><span class="mi">0</span> <span class="ow">and</span> <span class="n">ik</span><span class="o">&lt;</span><span class="n">siz</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">and</span> <span class="n">jk</span><span class="o">&gt;=</span><span class="mi">0</span> <span class="ow">and</span> <span class="n">jk</span><span class="o">&lt;</span><span class="n">siz</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
                <span class="n">mapr</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">ik</span><span class="o">*</span><span class="n">siz</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">jk</span><span class="p">]</span><span class="o">=</span><span class="nb">abs</span><span class="p">(</span><span class="n">r1</span><span class="o">-</span><span class="p">(</span><span class="n">double</span><span class="p">(</span><span class="n">rk</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">))</span>
                <span class="n">maptheta</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">ik</span><span class="o">*</span><span class="n">siz</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">jk</span><span class="p">]</span><span class="o">=</span><span class="nb">abs</span><span class="p">(</span><span class="n">theta</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">siz</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">siz</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
        <span class="n">i1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">int</span><span class="p">(</span><span class="n">j</span><span class="o">/</span><span class="n">siz</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="c1"># Line index in map1</span>
        <span class="n">j1</span> <span class="o">=</span> <span class="n">mod</span><span class="p">(</span><span class="n">j</span><span class="p">,</span><span class="n">siz</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">r1</span><span class="p">,</span><span class="n">theta1</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">polar_coord</span><span class="p">([</span><span class="n">i1</span><span class="p">,</span><span class="n">j1</span><span class="p">],</span><span class="n">cent</span><span class="p">)</span>
        <span class="n">rk</span><span class="o">=</span><span class="mi">0</span>
        <span class="n">thetak</span> <span class="o">=</span> <span class="n">theta1</span><span class="o">-</span><span class="n">theta</span>
        <span class="k">for</span> <span class="n">rk</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="o">*</span><span class="n">rmax</span><span class="p">):</span>
            <span class="n">ik</span>  <span class="o">=</span> <span class="nb">round</span><span class="p">((</span><span class="n">double</span><span class="p">(</span><span class="n">rk</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">cos</span><span class="p">(</span><span class="n">thetak</span><span class="p">)</span><span class="o">+</span><span class="n">cent</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">jk</span>  <span class="o">=</span> <span class="nb">round</span><span class="p">((</span><span class="n">double</span><span class="p">(</span><span class="n">rk</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">sin</span><span class="p">(</span><span class="n">thetak</span><span class="p">)</span><span class="o">+</span><span class="n">cent</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">ik</span><span class="o">&gt;=</span><span class="mi">0</span> <span class="ow">and</span> <span class="n">ik</span><span class="o">&lt;</span><span class="n">siz</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">and</span> <span class="n">jk</span><span class="o">&gt;=</span><span class="mi">0</span> <span class="ow">and</span> <span class="n">jk</span><span class="o">&lt;</span><span class="n">siz</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="ow">and</span> <span class="n">mapr</span><span class="p">[</span><span class="n">ik</span><span class="o">*</span><span class="n">siz</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">jk</span><span class="p">,</span><span class="n">j</span><span class="p">]</span><span class="o">==</span><span class="n">inf_val</span><span class="p">:</span>
                <span class="n">mapr</span><span class="p">[</span><span class="n">ik</span><span class="o">*</span><span class="n">siz</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">jk</span><span class="p">,</span><span class="n">j</span><span class="p">]</span><span class="o">=</span><span class="nb">abs</span><span class="p">(</span><span class="n">r1</span><span class="o">-</span><span class="p">(</span><span class="n">double</span><span class="p">(</span><span class="n">rk</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">))</span>
                <span class="n">maptheta</span><span class="p">[</span><span class="n">ik</span><span class="o">*</span><span class="n">siz</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">jk</span><span class="p">,</span><span class="n">j</span><span class="p">]</span><span class="o">=</span><span class="nb">abs</span><span class="p">(</span><span class="n">theta</span><span class="p">)</span>
    <span class="c1">#mapr = (mapr+transpose(mapr))/2</span>

    <span class="k">return</span> <span class="n">mapr</span><span class="p">,</span> <span class="n">maptheta</span>


<span class="k">def</span> <span class="nf">pol_coord_map</span><span class="p">(</span><span class="n">siz</span><span class="p">,</span><span class="n">alphat</span><span class="p">,</span><span class="n">alphar</span><span class="p">,</span><span class="n">cent</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="n">coord</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">siz</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">siz</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="mi">2</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">cent</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">cent</span> <span class="o">=</span> <span class="p">[</span><span class="n">siz</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span><span class="n">siz</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">dyn_coeff</span> <span class="o">=</span> <span class="n">sqrt</span><span class="p">((</span><span class="n">siz</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="p">(</span><span class="n">siz</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="o">*</span><span class="n">pi</span>
    <span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">siz</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">siz</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
            <span class="n">r</span><span class="p">,</span><span class="n">theta</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">polar_coord</span><span class="p">([</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">],</span><span class="n">cent</span><span class="p">)</span>
            <span class="n">coord</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">r</span><span class="o">*</span><span class="n">alphar</span>
            <span class="n">coord</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">dyn_coeff</span><span class="o">*</span><span class="n">alphat</span><span class="o">*</span><span class="n">theta</span>

    <span class="k">return</span> <span class="n">coord</span><span class="p">,</span><span class="n">dyn_coeff</span>

<span class="k">def</span> <span class="nf">pol_coord_map_2</span><span class="p">(</span><span class="n">siz</span><span class="p">,</span><span class="n">alphat</span><span class="p">,</span><span class="n">alphar</span><span class="p">,</span><span class="n">cent</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="n">coord</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">siz</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">siz</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="mi">2</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">cent</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">cent</span> <span class="o">=</span> <span class="p">[</span><span class="n">siz</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span><span class="n">siz</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">siz</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">siz</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
            <span class="n">r</span><span class="p">,</span><span class="n">theta</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">polar_coord</span><span class="p">([</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">],</span><span class="n">cent</span><span class="p">)</span>
            <span class="n">coord</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">r</span><span class="o">*</span><span class="n">alphar</span>
            <span class="n">coord</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">r</span><span class="o">*</span><span class="n">alphat</span><span class="o">*</span><span class="n">theta</span>

    <span class="k">return</span> <span class="n">coord</span>


<span class="k">def</span> <span class="nf">pol_coord_map_cloud</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span><span class="n">alphat</span><span class="p">,</span><span class="n">alphar</span><span class="p">,</span><span class="n">cent</span><span class="p">):</span>
    <span class="n">nb_points</span> <span class="o">=</span> <span class="n">pos</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">coord</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">nb_points</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_points</span><span class="p">):</span>
        <span class="n">r</span><span class="p">,</span><span class="n">theta</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">polar_coord</span><span class="p">(</span><span class="n">pos</span><span class="p">[</span><span class="n">i</span><span class="p">,:],</span><span class="n">cent</span><span class="p">)</span>
        <span class="n">coord</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">r</span><span class="o">*</span><span class="n">alphar</span>
        <span class="n">coord</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">r</span><span class="o">*</span><span class="n">alphat</span><span class="o">*</span><span class="n">theta</span>

    <span class="k">return</span> <span class="n">coord</span>


<span class="k">def</span> <span class="nf">intensity_coord</span><span class="p">(</span><span class="n">im</span><span class="p">,</span><span class="n">cent</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="n">siz</span> <span class="o">=</span> <span class="n">im</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">dyn_coeff</span> <span class="o">=</span> <span class="n">sqrt</span><span class="p">((</span><span class="n">siz</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="p">(</span><span class="n">siz</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="o">*</span><span class="n">pi</span>
    <span class="n">coord_map</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span><span class="n">siz</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">siz</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
    <span class="n">coord_map</span><span class="p">[</span><span class="mi">0</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">im</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">siz</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">siz</span><span class="p">[</span><span class="mi">1</span><span class="p">],)))</span>


    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">siz</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">siz</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
            <span class="n">r</span><span class="p">,</span><span class="n">theta</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">polar_coord</span><span class="p">([</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">],</span><span class="n">cent</span><span class="p">)</span>
            <span class="n">coord_map</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span><span class="o">+</span><span class="n">i</span><span class="o">*</span><span class="n">siz</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="n">r</span>
            <span class="n">coord_map</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="n">j</span><span class="o">+</span><span class="n">i</span><span class="o">*</span><span class="n">siz</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="n">theta</span><span class="o">*</span><span class="n">dyn_coeff</span>


    <span class="k">return</span> <span class="n">coord_map</span><span class="p">,</span><span class="n">dyn_coeff</span>

<span class="k">def</span> <span class="nf">psf_dist_map_setting</span><span class="p">(</span><span class="n">coord_map</span><span class="p">,</span><span class="n">r</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span><span class="n">a1</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">a2</span><span class="o">=</span><span class="mf">0.75</span><span class="p">):</span> <span class="c1"># a2&lt;0</span>
    <span class="n">siz</span> <span class="o">=</span> <span class="n">coord_map</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">dist_map</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">siz</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">siz</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
    <span class="n">b</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">c</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">siz</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">i</span><span class="p">):</span>
            <span class="n">intensity_dist</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">log_norm</span><span class="p">(</span><span class="n">coord_map</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">i</span><span class="p">],</span><span class="n">coord_map</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">j</span><span class="p">],</span><span class="n">u</span><span class="o">=</span><span class="n">a2</span><span class="p">)</span>
            <span class="n">rdist2</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">c</span> <span class="o">=</span>  <span class="n">utils</span><span class="o">.</span><span class="n">l2_exp</span><span class="p">((</span><span class="n">coord_map</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="n">i</span><span class="p">]</span><span class="o">-</span><span class="n">coord_map</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span><span class="n">a1</span><span class="p">,</span><span class="n">r</span><span class="p">,</span><span class="n">b</span><span class="o">=</span><span class="n">b</span><span class="p">,</span><span class="n">c</span><span class="o">=</span><span class="n">c</span><span class="p">)</span>
            <span class="n">theta_dist2</span> <span class="o">=</span> <span class="p">(</span><span class="n">coord_map</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="n">i</span><span class="p">]</span><span class="o">-</span><span class="n">coord_map</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="n">j</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span>
            <span class="n">dist_map</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">intensity_dist</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="n">rdist2</span><span class="o">+</span><span class="n">theta_dist2</span>

    <span class="n">dist_map</span><span class="o">+=</span><span class="n">transpose</span><span class="p">(</span><span class="n">dist_map</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">dist_map</span>

<span class="c1">#def mds(dist_mat,):</span>


<span class="k">def</span> <span class="nf">partial_transport_2</span><span class="p">(</span><span class="n">P</span><span class="p">,</span><span class="n">t</span><span class="p">,</span><span class="n">shap</span><span class="p">,</span><span class="n">position_map_1</span><span class="p">,</span><span class="n">position_map_2</span><span class="p">,</span><span class="n">scale_coeff</span><span class="p">,</span><span class="n">tol</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">cent</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="n">psf_interp</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">(</span><span class="n">shap</span><span class="p">)</span>
    <span class="n">min_val</span> <span class="o">=</span> <span class="n">tol</span><span class="o">*</span><span class="n">P</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
    <span class="n">i</span><span class="o">=</span><span class="mi">0</span>
    <span class="n">j</span><span class="o">=</span><span class="mi">0</span>
    <span class="k">if</span> <span class="n">cent</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">cent</span> <span class="o">=</span> <span class="p">[</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
        <span class="n">i1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">int</span><span class="p">(</span><span class="n">i</span><span class="o">/</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="c1"># Line index in position_map_1</span>
        <span class="n">j1</span> <span class="o">=</span> <span class="n">mod</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">P</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">min_val</span><span class="p">):</span>
                <span class="n">i2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">int</span><span class="p">(</span><span class="n">j</span><span class="o">/</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="c1"># Line index in postion_map_2</span>
                <span class="n">j2</span> <span class="o">=</span> <span class="n">mod</span><span class="p">(</span><span class="n">j</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">i1</span><span class="o">==</span><span class="n">i2</span> <span class="ow">and</span> <span class="n">j1</span><span class="o">==</span><span class="n">j2</span><span class="p">):</span>
                    <span class="n">pos</span> <span class="o">=</span> <span class="n">position_map_1</span><span class="p">[</span><span class="n">i1</span><span class="p">,</span><span class="n">j1</span><span class="p">,:]</span>
                    <span class="n">iopt</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">pos</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">cos</span><span class="p">(</span><span class="n">pos</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="n">scale_coeff</span><span class="p">)</span><span class="o">+</span><span class="n">cent</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                    <span class="n">jopt</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">pos</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">sin</span><span class="p">(</span><span class="n">pos</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="n">scale_coeff</span><span class="p">)</span><span class="o">+</span><span class="n">cent</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                    <span class="n">psf_interp</span><span class="p">[</span><span class="n">iopt</span><span class="p">,</span><span class="n">jopt</span><span class="p">]</span> <span class="o">=</span> <span class="n">psf_interp</span><span class="p">[</span><span class="n">iopt</span><span class="p">,</span><span class="n">jopt</span><span class="p">]</span> <span class="o">+</span> <span class="n">P</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span>
                <span class="k">else</span> <span class="p">:</span>
                    <span class="n">pos</span> <span class="o">=</span> <span class="p">((</span><span class="mi">1</span><span class="o">-</span><span class="n">t</span><span class="p">)</span><span class="o">*</span><span class="n">position_map_1</span><span class="p">[</span><span class="n">i1</span><span class="p">,</span><span class="n">j1</span><span class="p">,:]</span><span class="o">+</span><span class="n">t</span><span class="o">*</span><span class="n">position_map_2</span><span class="p">[</span><span class="n">i2</span><span class="p">,</span><span class="n">j2</span><span class="p">,:])</span>
                    <span class="n">iopt</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">pos</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">cos</span><span class="p">(</span><span class="n">pos</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="n">scale_coeff</span><span class="p">)</span><span class="o">+</span><span class="n">cent</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                    <span class="n">jopt</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">pos</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">sin</span><span class="p">(</span><span class="n">pos</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="n">scale_coeff</span><span class="p">)</span><span class="o">+</span><span class="n">cent</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

                    <span class="k">if</span> <span class="n">iopt</span> <span class="o">&lt;</span> <span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">and</span> <span class="n">iopt</span><span class="o">&gt;-</span><span class="mi">1</span> <span class="ow">and</span> <span class="n">jopt</span> <span class="o">&lt;</span> <span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">and</span> <span class="n">jopt</span><span class="o">&gt;-</span><span class="mi">1</span><span class="p">:</span>
                        <span class="n">psf_interp</span><span class="p">[</span><span class="n">iopt</span><span class="p">,</span><span class="n">jopt</span><span class="p">]</span> <span class="o">=</span> <span class="n">psf_interp</span><span class="p">[</span><span class="n">iopt</span><span class="p">,</span><span class="n">jopt</span><span class="p">]</span><span class="o">+</span><span class="n">P</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">psf_interp</span>

<span class="k">def</span> <span class="nf">displacement_interp</span><span class="p">(</span><span class="n">P</span><span class="p">,</span><span class="n">t</span><span class="p">,</span><span class="n">shap</span><span class="p">,</span><span class="n">position_map_1</span><span class="p">,</span><span class="n">position_map_2</span><span class="p">,</span><span class="n">tol</span><span class="o">=</span><span class="mf">0.001</span><span class="p">,</span><span class="n">var_speed</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>

    <span class="n">total</span> <span class="o">=</span> <span class="n">P</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">total</span>
    <span class="n">ind</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">argsort2D</span><span class="p">(</span><span class="n">P</span><span class="p">)</span>
    <span class="n">psf_interp</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">(</span><span class="n">shap</span><span class="p">)</span>
    <span class="n">l</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
    <span class="n">target_pos</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">t</span><span class="p">)</span><span class="o">*</span><span class="n">position_map_1</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,:]</span><span class="o">+</span><span class="n">t</span><span class="o">*</span><span class="n">position_map_2</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,:]</span><span class="o">+</span><span class="n">array</span><span class="p">([</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span><span class="p">])</span>
    <span class="k">while</span> <span class="n">l</span><span class="o">&gt;-</span><span class="p">(</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span> <span class="ow">and</span> <span class="n">res</span><span class="o">&gt;</span><span class="n">total</span><span class="o">*</span><span class="n">tol</span><span class="p">:</span>
        <span class="n">indP</span> <span class="o">=</span> <span class="n">ind</span><span class="p">[</span><span class="n">l</span><span class="p">]</span>
        <span class="n">l</span><span class="o">-=</span><span class="mi">1</span>
        <span class="n">indPl</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">indP</span><span class="o">/</span><span class="p">(</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>

        <span class="n">indPc</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">indP</span><span class="o">%</span><span class="p">(</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>

        <span class="n">i1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">int</span><span class="p">(</span><span class="n">indPl</span><span class="o">/</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="c1"># Line index in position_map_1</span>
        <span class="n">j1</span> <span class="o">=</span> <span class="n">mod</span><span class="p">(</span><span class="n">indPl</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">i2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">int</span><span class="p">(</span><span class="n">indPc</span><span class="o">/</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="c1"># Line index in position_map_2</span>
        <span class="n">j2</span> <span class="o">=</span> <span class="n">mod</span><span class="p">(</span><span class="n">indPc</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">interp_pos</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">var_speed</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
            <span class="n">interp_pos</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">t</span><span class="p">)</span><span class="o">*</span><span class="n">position_map_1</span><span class="p">[</span><span class="n">i1</span><span class="p">,</span><span class="n">j1</span><span class="p">,:]</span><span class="o">+</span><span class="n">t</span><span class="o">*</span><span class="n">position_map_2</span><span class="p">[</span><span class="n">i2</span><span class="p">,</span><span class="n">j2</span><span class="p">,:]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">t1</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">stretch_sigmoid</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
            <span class="n">interp_pos</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">t1</span><span class="p">)</span><span class="o">*</span><span class="n">position_map_1</span><span class="p">[</span><span class="n">i1</span><span class="p">,</span><span class="n">j1</span><span class="p">,:]</span><span class="o">+</span><span class="n">t1</span><span class="o">*</span><span class="n">position_map_2</span><span class="p">[</span><span class="n">i2</span><span class="p">,</span><span class="n">j2</span><span class="p">,:]</span>
        <span class="n">ind_im</span> <span class="o">=</span> <span class="n">interp_pos</span><span class="o">+</span><span class="n">array</span><span class="p">([</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span><span class="o">/</span><span class="mi">2</span><span class="o">-</span><span class="n">target_pos</span>

        <span class="n">ind_im</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">ind_im</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">)))</span>
        <span class="n">ind_im</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">ind_im</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">)))</span>
        <span class="n">psf_interp</span><span class="p">[</span><span class="n">ind_im</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">ind_im</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">+=</span><span class="n">P</span><span class="p">[</span><span class="n">indPl</span><span class="p">,</span><span class="n">indPc</span><span class="p">]</span>
        <span class="n">res</span> <span class="o">-=</span> <span class="n">P</span><span class="p">[</span><span class="n">indPl</span><span class="p">,</span><span class="n">indPc</span><span class="p">]</span>
    <span class="nb">print</span> <span class="nb">abs</span><span class="p">(</span><span class="n">l</span><span class="p">),</span><span class="s2">&quot;/&quot;</span><span class="p">,(</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span>
    <span class="k">return</span> <span class="n">psf_interp</span>


<span class="k">def</span> <span class="nf">displacement_interp_2</span><span class="p">(</span><span class="n">im_ref</span><span class="p">,</span><span class="n">im_proj</span><span class="p">,</span><span class="n">t</span><span class="p">,</span><span class="n">position_map_1</span><span class="p">,</span><span class="n">position_map_2</span><span class="p">,</span><span class="n">tol</span><span class="o">=</span><span class="mf">0.001</span><span class="p">):</span>

    <span class="n">shap</span> <span class="o">=</span> <span class="n">im_ref</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">total</span> <span class="o">=</span> <span class="n">im_ref</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">total</span>
    <span class="n">ind</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">argsort2D</span><span class="p">(</span><span class="n">im_ref</span><span class="p">)</span>
    <span class="n">psf_interp</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">(</span><span class="n">shap</span><span class="p">)</span>
    <span class="n">l</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
    <span class="n">target_pos</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">t</span><span class="p">)</span><span class="o">*</span><span class="n">position_map_1</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,:]</span><span class="o">+</span><span class="n">t</span><span class="o">*</span><span class="n">position_map_2</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,:]</span><span class="o">+</span><span class="n">array</span><span class="p">([</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span><span class="p">])</span>
    <span class="k">while</span> <span class="n">l</span><span class="o">&gt;-</span><span class="p">(</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="ow">and</span> <span class="n">res</span><span class="o">&gt;</span><span class="n">total</span><span class="o">*</span><span class="n">tol</span><span class="p">:</span>
        <span class="n">indP</span> <span class="o">=</span> <span class="n">ind</span><span class="p">[</span><span class="n">l</span><span class="p">]</span>
        <span class="n">l</span><span class="o">-=</span><span class="mi">1</span>
        <span class="n">indPl</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">indP</span><span class="o">/</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

        <span class="n">indPc</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">indP</span><span class="o">%</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>


        <span class="n">interp_pos</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">t</span><span class="p">)</span><span class="o">*</span><span class="n">position_map_1</span><span class="p">[</span><span class="n">indPl</span><span class="p">,</span><span class="n">indPc</span><span class="p">,:]</span><span class="o">+</span><span class="n">t</span><span class="o">*</span><span class="n">position_map_2</span><span class="p">[</span><span class="n">indPl</span><span class="p">,</span><span class="n">indPc</span><span class="p">,:]</span>
        <span class="n">ind_im</span> <span class="o">=</span> <span class="n">interp_pos</span><span class="o">+</span><span class="n">array</span><span class="p">([</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span><span class="o">/</span><span class="mi">2</span><span class="o">-</span><span class="n">target_pos</span>

        <span class="n">ind_im</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">ind_im</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">)))</span>
        <span class="n">ind_im</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">ind_im</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">)))</span>
        <span class="n">psf_interp</span><span class="p">[</span><span class="n">ind_im</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">ind_im</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">+=</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">t</span><span class="p">)</span><span class="o">*</span><span class="n">im_ref</span><span class="p">[</span><span class="n">indPl</span><span class="p">,</span><span class="n">indPc</span><span class="p">]</span><span class="o">+</span><span class="n">t</span><span class="o">*</span><span class="n">im_proj</span><span class="p">[</span><span class="n">indPl</span><span class="p">,</span><span class="n">indPc</span><span class="p">]</span>
        <span class="n">res</span> <span class="o">-=</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">t</span><span class="p">)</span><span class="o">*</span><span class="n">im_ref</span><span class="p">[</span><span class="n">indPl</span><span class="p">,</span><span class="n">indPc</span><span class="p">]</span><span class="o">+</span><span class="n">t</span><span class="o">*</span><span class="n">im_proj</span><span class="p">[</span><span class="n">indPl</span><span class="p">,</span><span class="n">indPc</span><span class="p">]</span>
    <span class="nb">print</span> <span class="nb">abs</span><span class="p">(</span><span class="n">l</span><span class="p">),</span><span class="s2">&quot;/&quot;</span><span class="p">,(</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">psf_interp</span>


<span class="k">def</span> <span class="nf">displacement_interp_pol</span><span class="p">(</span><span class="n">P</span><span class="p">,</span><span class="n">t</span><span class="p">,</span><span class="n">shap</span><span class="p">,</span><span class="n">position_map_1</span><span class="p">,</span><span class="n">position_map_2</span><span class="p">,</span><span class="n">cent</span><span class="p">,</span><span class="n">scale_coefft</span><span class="p">,</span><span class="n">scale_coeffr</span><span class="p">,</span><span class="n">tol</span><span class="o">=</span><span class="mf">0.001</span><span class="p">,</span><span class="n">var_speed</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>

    <span class="n">total</span> <span class="o">=</span> <span class="n">P</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">total</span>
    <span class="n">ind</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">argsort2D</span><span class="p">(</span><span class="n">P</span><span class="p">)</span>
    <span class="n">psf_interp</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">(</span><span class="n">shap</span><span class="p">)</span>
    <span class="n">l</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
    <span class="k">while</span> <span class="n">l</span><span class="o">&gt;-</span><span class="p">(</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span> <span class="ow">and</span> <span class="n">res</span><span class="o">&gt;</span><span class="n">total</span><span class="o">*</span><span class="n">tol</span><span class="p">:</span>
        <span class="n">indP</span> <span class="o">=</span> <span class="n">ind</span><span class="p">[</span><span class="n">l</span><span class="p">]</span>
        <span class="n">l</span><span class="o">-=</span><span class="mi">1</span>
        <span class="n">indPl</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">indP</span><span class="o">/</span><span class="p">(</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>

        <span class="n">indPc</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">indP</span><span class="o">%</span><span class="p">(</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>

        <span class="n">i1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">int</span><span class="p">(</span><span class="n">indPl</span><span class="o">/</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="c1"># Line index in position_map_1</span>
        <span class="n">j1</span> <span class="o">=</span> <span class="n">mod</span><span class="p">(</span><span class="n">indPl</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">i2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">int</span><span class="p">(</span><span class="n">indPc</span><span class="o">/</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="c1"># Line index in position_map_2</span>
        <span class="n">j2</span> <span class="o">=</span> <span class="n">mod</span><span class="p">(</span><span class="n">indPc</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">interp_pos</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">var_speed</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
            <span class="n">interp_pos</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">t</span><span class="p">)</span><span class="o">*</span><span class="n">position_map_1</span><span class="p">[</span><span class="n">i1</span><span class="p">,</span><span class="n">j1</span><span class="p">,:]</span><span class="o">+</span><span class="n">t</span><span class="o">*</span><span class="n">position_map_2</span><span class="p">[</span><span class="n">i2</span><span class="p">,</span><span class="n">j2</span><span class="p">,:]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">t1</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">stretch_sigmoid</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
            <span class="n">interp_pos</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">t1</span><span class="p">)</span><span class="o">*</span><span class="n">position_map_1</span><span class="p">[</span><span class="n">i1</span><span class="p">,</span><span class="n">j1</span><span class="p">,:]</span><span class="o">+</span><span class="n">t1</span><span class="o">*</span><span class="n">position_map_2</span><span class="p">[</span><span class="n">i2</span><span class="p">,</span><span class="n">j2</span><span class="p">,:]</span>
        <span class="n">iopt</span> <span class="o">=</span> <span class="p">(</span><span class="n">interp_pos</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="n">scale_coeffr</span><span class="p">)</span><span class="o">*</span><span class="n">cos</span><span class="p">(</span><span class="n">interp_pos</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="n">scale_coefft</span><span class="p">)</span><span class="o">+</span><span class="n">cent</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">iopt</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">iopt</span><span class="p">),</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">jopt</span> <span class="o">=</span> <span class="p">(</span><span class="n">interp_pos</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="n">scale_coeffr</span><span class="p">)</span><span class="o">*</span><span class="n">sin</span><span class="p">(</span><span class="n">interp_pos</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="n">scale_coefft</span><span class="p">)</span><span class="o">+</span><span class="n">cent</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">jopt</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">jopt</span><span class="p">),</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>

        <span class="n">iopt1</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">int</span><span class="p">(</span><span class="n">iopt</span><span class="p">)),</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">jopt1</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">int</span><span class="p">(</span><span class="n">jopt</span><span class="p">)),</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">iopt1</span><span class="o">==</span><span class="n">iopt</span> <span class="ow">and</span> <span class="n">jopt1</span><span class="o">==</span><span class="n">jopt</span><span class="p">:</span>
            <span class="n">psf_interp</span><span class="p">[</span><span class="n">iopt1</span><span class="p">,</span><span class="n">jopt1</span><span class="p">]</span><span class="o">+=</span><span class="n">P</span><span class="p">[</span><span class="n">indPl</span><span class="p">,</span><span class="n">indPc</span><span class="p">]</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">iopt2</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">int</span><span class="p">(</span><span class="n">iopt1</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">jopt2</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">int</span><span class="p">(</span><span class="n">jopt1</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">iopt</span><span class="o">==</span><span class="n">iopt1</span><span class="p">:</span>
                <span class="n">d1</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">jopt</span><span class="o">-</span><span class="n">jopt1</span><span class="p">)</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">d2</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">jopt</span><span class="o">-</span><span class="n">jopt2</span><span class="p">)</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">d</span> <span class="o">=</span> <span class="n">d1</span><span class="o">+</span><span class="n">d2</span>
                <span class="n">psf_interp</span><span class="p">[</span><span class="n">iopt1</span><span class="p">,</span><span class="n">jopt1</span><span class="p">]</span><span class="o">+=</span><span class="n">d1</span><span class="o">*</span><span class="n">P</span><span class="p">[</span><span class="n">indPl</span><span class="p">,</span><span class="n">indPc</span><span class="p">]</span><span class="o">/</span><span class="n">d</span>
                <span class="n">psf_interp</span><span class="p">[</span><span class="n">iopt1</span><span class="p">,</span><span class="n">jopt2</span><span class="p">]</span><span class="o">+=</span><span class="n">d2</span><span class="o">*</span><span class="n">P</span><span class="p">[</span><span class="n">indPl</span><span class="p">,</span><span class="n">indPc</span><span class="p">]</span><span class="o">/</span><span class="n">d</span>
            <span class="k">elif</span> <span class="n">jopt</span><span class="o">==</span><span class="n">jopt1</span><span class="p">:</span>
                <span class="n">d1</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">iopt</span><span class="o">-</span><span class="n">iopt1</span><span class="p">)</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">d2</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">iopt</span><span class="o">-</span><span class="n">iopt2</span><span class="p">)</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">d</span> <span class="o">=</span> <span class="n">d1</span><span class="o">+</span><span class="n">d2</span>
                <span class="n">psf_interp</span><span class="p">[</span><span class="n">iopt1</span><span class="p">,</span><span class="n">jopt1</span><span class="p">]</span><span class="o">+=</span><span class="n">d1</span><span class="o">*</span><span class="n">P</span><span class="p">[</span><span class="n">indPl</span><span class="p">,</span><span class="n">indPc</span><span class="p">]</span><span class="o">/</span><span class="n">d</span>
                <span class="n">psf_interp</span><span class="p">[</span><span class="n">iopt2</span><span class="p">,</span><span class="n">jopt1</span><span class="p">]</span><span class="o">+=</span><span class="n">d2</span><span class="o">*</span><span class="n">P</span><span class="p">[</span><span class="n">indPl</span><span class="p">,</span><span class="n">indPc</span><span class="p">]</span><span class="o">/</span><span class="n">d</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="n">d1</span> <span class="o">=</span> <span class="n">sqrt</span><span class="p">((</span><span class="n">iopt</span><span class="o">-</span><span class="n">iopt1</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="p">(</span><span class="n">jopt</span><span class="o">-</span><span class="n">jopt1</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">d2</span> <span class="o">=</span> <span class="n">sqrt</span><span class="p">((</span><span class="n">iopt</span><span class="o">-</span><span class="n">iopt1</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="p">(</span><span class="n">jopt</span><span class="o">-</span><span class="n">jopt2</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">d3</span> <span class="o">=</span> <span class="n">sqrt</span><span class="p">((</span><span class="n">iopt</span><span class="o">-</span><span class="n">iopt2</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="p">(</span><span class="n">jopt</span><span class="o">-</span><span class="n">jopt1</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">d4</span> <span class="o">=</span> <span class="n">sqrt</span><span class="p">((</span><span class="n">iopt</span><span class="o">-</span><span class="n">iopt2</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="p">(</span><span class="n">jopt</span><span class="o">-</span><span class="n">jopt2</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">d</span> <span class="o">=</span> <span class="n">d1</span><span class="o">+</span><span class="n">d2</span><span class="o">+</span><span class="n">d3</span><span class="o">+</span><span class="n">d4</span>
                <span class="n">psf_interp</span><span class="p">[</span><span class="n">iopt1</span><span class="p">,</span><span class="n">jopt1</span><span class="p">]</span><span class="o">+=</span><span class="n">d1</span><span class="o">*</span><span class="n">P</span><span class="p">[</span><span class="n">indPl</span><span class="p">,</span><span class="n">indPc</span><span class="p">]</span><span class="o">/</span><span class="n">d</span>
                <span class="n">psf_interp</span><span class="p">[</span><span class="n">iopt1</span><span class="p">,</span><span class="n">jopt2</span><span class="p">]</span><span class="o">+=</span><span class="n">d2</span><span class="o">*</span><span class="n">P</span><span class="p">[</span><span class="n">indPl</span><span class="p">,</span><span class="n">indPc</span><span class="p">]</span><span class="o">/</span><span class="n">d</span>
                <span class="n">psf_interp</span><span class="p">[</span><span class="n">iopt2</span><span class="p">,</span><span class="n">jopt1</span><span class="p">]</span><span class="o">+=</span><span class="n">d3</span><span class="o">*</span><span class="n">P</span><span class="p">[</span><span class="n">indPl</span><span class="p">,</span><span class="n">indPc</span><span class="p">]</span><span class="o">/</span><span class="n">d</span>
                <span class="n">psf_interp</span><span class="p">[</span><span class="n">iopt2</span><span class="p">,</span><span class="n">jopt2</span><span class="p">]</span><span class="o">+=</span><span class="n">d4</span><span class="o">*</span><span class="n">P</span><span class="p">[</span><span class="n">indPl</span><span class="p">,</span><span class="n">indPc</span><span class="p">]</span><span class="o">/</span><span class="n">d</span>

        <span class="n">res</span> <span class="o">-=</span> <span class="n">P</span><span class="p">[</span><span class="n">indPl</span><span class="p">,</span><span class="n">indPc</span><span class="p">]</span>

    <span class="nb">print</span> <span class="nb">abs</span><span class="p">(</span><span class="n">l</span><span class="p">),</span><span class="s2">&quot;/&quot;</span><span class="p">,(</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span>
    <span class="k">return</span> <span class="n">psf_interp</span>


<span class="k">def</span> <span class="nf">displacement_interp_pol_2</span><span class="p">(</span><span class="n">P</span><span class="p">,</span><span class="n">t</span><span class="p">,</span><span class="n">shap</span><span class="p">,</span><span class="n">position_map_1</span><span class="p">,</span><span class="n">position_map_2</span><span class="p">,</span><span class="n">cent</span><span class="p">,</span><span class="n">scale_coefft</span><span class="p">,</span><span class="n">scale_coeffr</span><span class="p">,</span><span class="n">tol</span><span class="o">=</span><span class="mf">0.001</span><span class="p">,</span><span class="n">var_speed</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>

    <span class="n">total</span> <span class="o">=</span> <span class="n">P</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">total</span>
    <span class="n">ind</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">argsort2D</span><span class="p">(</span><span class="n">P</span><span class="p">)</span>
    <span class="n">psf_interp</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">(</span><span class="n">shap</span><span class="p">)</span>
    <span class="n">l</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
    <span class="k">while</span> <span class="n">l</span><span class="o">&gt;-</span><span class="p">(</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span> <span class="ow">and</span> <span class="n">res</span><span class="o">&gt;</span><span class="n">total</span><span class="o">*</span><span class="n">tol</span><span class="p">:</span>
        <span class="n">indP</span> <span class="o">=</span> <span class="n">ind</span><span class="p">[</span><span class="n">l</span><span class="p">]</span>
        <span class="n">l</span><span class="o">-=</span><span class="mi">1</span>
        <span class="n">indPl</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">indP</span><span class="o">/</span><span class="p">(</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>

        <span class="n">indPc</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">indP</span><span class="o">%</span><span class="p">(</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>

        <span class="n">i1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">int</span><span class="p">(</span><span class="n">indPl</span><span class="o">/</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="c1"># Line index in position_map_1</span>
        <span class="n">j1</span> <span class="o">=</span> <span class="n">mod</span><span class="p">(</span><span class="n">indPl</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">i2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">int</span><span class="p">(</span><span class="n">indPc</span><span class="o">/</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="c1"># Line index in position_map_2</span>
        <span class="n">j2</span> <span class="o">=</span> <span class="n">mod</span><span class="p">(</span><span class="n">indPc</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">interp_pos</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">var_speed</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
            <span class="n">interp_pos</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">t</span><span class="p">)</span><span class="o">*</span><span class="n">position_map_1</span><span class="p">[</span><span class="n">i1</span><span class="p">,</span><span class="n">j1</span><span class="p">,:]</span><span class="o">+</span><span class="n">t</span><span class="o">*</span><span class="n">position_map_2</span><span class="p">[</span><span class="n">i2</span><span class="p">,</span><span class="n">j2</span><span class="p">,:]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">t1</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">stretch_sigmoid</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
            <span class="n">interp_pos</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">t1</span><span class="p">)</span><span class="o">*</span><span class="n">position_map_1</span><span class="p">[</span><span class="n">i1</span><span class="p">,</span><span class="n">j1</span><span class="p">,:]</span><span class="o">+</span><span class="n">t1</span><span class="o">*</span><span class="n">position_map_2</span><span class="p">[</span><span class="n">i2</span><span class="p">,</span><span class="n">j2</span><span class="p">,:]</span>
        <span class="n">iopt</span> <span class="o">=</span> <span class="n">cent</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">jopt</span> <span class="o">=</span> <span class="n">cent</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">interp_pos</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
            <span class="n">iopt</span> <span class="o">=</span> <span class="p">(</span><span class="n">interp_pos</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="n">scale_coeffr</span><span class="p">)</span><span class="o">*</span><span class="n">cos</span><span class="p">(</span><span class="n">scale_coeffr</span><span class="o">*</span><span class="n">interp_pos</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="p">(</span><span class="n">scale_coefft</span><span class="o">*</span><span class="n">interp_pos</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span><span class="o">+</span><span class="n">cent</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">iopt</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">iopt</span><span class="p">),</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">jopt</span> <span class="o">=</span> <span class="p">(</span><span class="n">interp_pos</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="n">scale_coeffr</span><span class="p">)</span><span class="o">*</span><span class="n">sin</span><span class="p">(</span><span class="n">scale_coeffr</span><span class="o">*</span><span class="n">interp_pos</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="p">(</span><span class="n">scale_coefft</span><span class="o">*</span><span class="n">interp_pos</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span><span class="o">+</span><span class="n">cent</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">jopt</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">jopt</span><span class="p">),</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>

        <span class="n">iopt1</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">int</span><span class="p">(</span><span class="n">iopt</span><span class="p">)),</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">jopt1</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">int</span><span class="p">(</span><span class="n">jopt</span><span class="p">)),</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">iopt1</span><span class="o">==</span><span class="n">iopt</span> <span class="ow">and</span> <span class="n">jopt1</span><span class="o">==</span><span class="n">jopt</span><span class="p">:</span>
            <span class="n">psf_interp</span><span class="p">[</span><span class="n">iopt1</span><span class="p">,</span><span class="n">jopt1</span><span class="p">]</span><span class="o">+=</span><span class="n">P</span><span class="p">[</span><span class="n">indPl</span><span class="p">,</span><span class="n">indPc</span><span class="p">]</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">iopt2</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">int</span><span class="p">(</span><span class="n">iopt1</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">jopt2</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">int</span><span class="p">(</span><span class="n">jopt1</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">iopt</span><span class="o">==</span><span class="n">iopt1</span><span class="p">:</span>
                <span class="n">d1</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">jopt</span><span class="o">-</span><span class="n">jopt1</span><span class="p">)</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">d2</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">jopt</span><span class="o">-</span><span class="n">jopt2</span><span class="p">)</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">d</span> <span class="o">=</span> <span class="n">d1</span><span class="o">+</span><span class="n">d2</span>
                <span class="n">psf_interp</span><span class="p">[</span><span class="n">iopt1</span><span class="p">,</span><span class="n">jopt1</span><span class="p">]</span><span class="o">+=</span><span class="n">d1</span><span class="o">*</span><span class="n">P</span><span class="p">[</span><span class="n">indPl</span><span class="p">,</span><span class="n">indPc</span><span class="p">]</span><span class="o">/</span><span class="n">d</span>
                <span class="n">psf_interp</span><span class="p">[</span><span class="n">iopt1</span><span class="p">,</span><span class="n">jopt2</span><span class="p">]</span><span class="o">+=</span><span class="n">d2</span><span class="o">*</span><span class="n">P</span><span class="p">[</span><span class="n">indPl</span><span class="p">,</span><span class="n">indPc</span><span class="p">]</span><span class="o">/</span><span class="n">d</span>
            <span class="k">elif</span> <span class="n">jopt</span><span class="o">==</span><span class="n">jopt1</span><span class="p">:</span>
                <span class="n">d1</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">iopt</span><span class="o">-</span><span class="n">iopt1</span><span class="p">)</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">d2</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">iopt</span><span class="o">-</span><span class="n">iopt2</span><span class="p">)</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">d</span> <span class="o">=</span> <span class="n">d1</span><span class="o">+</span><span class="n">d2</span>
                <span class="n">psf_interp</span><span class="p">[</span><span class="n">iopt1</span><span class="p">,</span><span class="n">jopt1</span><span class="p">]</span><span class="o">+=</span><span class="n">d1</span><span class="o">*</span><span class="n">P</span><span class="p">[</span><span class="n">indPl</span><span class="p">,</span><span class="n">indPc</span><span class="p">]</span><span class="o">/</span><span class="n">d</span>
                <span class="n">psf_interp</span><span class="p">[</span><span class="n">iopt2</span><span class="p">,</span><span class="n">jopt1</span><span class="p">]</span><span class="o">+=</span><span class="n">d2</span><span class="o">*</span><span class="n">P</span><span class="p">[</span><span class="n">indPl</span><span class="p">,</span><span class="n">indPc</span><span class="p">]</span><span class="o">/</span><span class="n">d</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="n">d1</span> <span class="o">=</span> <span class="n">sqrt</span><span class="p">((</span><span class="n">iopt</span><span class="o">-</span><span class="n">iopt1</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="p">(</span><span class="n">jopt</span><span class="o">-</span><span class="n">jopt1</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">d2</span> <span class="o">=</span> <span class="n">sqrt</span><span class="p">((</span><span class="n">iopt</span><span class="o">-</span><span class="n">iopt1</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="p">(</span><span class="n">jopt</span><span class="o">-</span><span class="n">jopt2</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">d3</span> <span class="o">=</span> <span class="n">sqrt</span><span class="p">((</span><span class="n">iopt</span><span class="o">-</span><span class="n">iopt2</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="p">(</span><span class="n">jopt</span><span class="o">-</span><span class="n">jopt1</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">d4</span> <span class="o">=</span> <span class="n">sqrt</span><span class="p">((</span><span class="n">iopt</span><span class="o">-</span><span class="n">iopt2</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="p">(</span><span class="n">jopt</span><span class="o">-</span><span class="n">jopt2</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">d</span> <span class="o">=</span> <span class="n">d1</span><span class="o">+</span><span class="n">d2</span><span class="o">+</span><span class="n">d3</span><span class="o">+</span><span class="n">d4</span>
                <span class="n">psf_interp</span><span class="p">[</span><span class="n">iopt1</span><span class="p">,</span><span class="n">jopt1</span><span class="p">]</span><span class="o">+=</span><span class="n">d1</span><span class="o">*</span><span class="n">P</span><span class="p">[</span><span class="n">indPl</span><span class="p">,</span><span class="n">indPc</span><span class="p">]</span><span class="o">/</span><span class="n">d</span>
                <span class="n">psf_interp</span><span class="p">[</span><span class="n">iopt1</span><span class="p">,</span><span class="n">jopt2</span><span class="p">]</span><span class="o">+=</span><span class="n">d2</span><span class="o">*</span><span class="n">P</span><span class="p">[</span><span class="n">indPl</span><span class="p">,</span><span class="n">indPc</span><span class="p">]</span><span class="o">/</span><span class="n">d</span>
                <span class="n">psf_interp</span><span class="p">[</span><span class="n">iopt2</span><span class="p">,</span><span class="n">jopt1</span><span class="p">]</span><span class="o">+=</span><span class="n">d3</span><span class="o">*</span><span class="n">P</span><span class="p">[</span><span class="n">indPl</span><span class="p">,</span><span class="n">indPc</span><span class="p">]</span><span class="o">/</span><span class="n">d</span>
                <span class="n">psf_interp</span><span class="p">[</span><span class="n">iopt2</span><span class="p">,</span><span class="n">jopt2</span><span class="p">]</span><span class="o">+=</span><span class="n">d4</span><span class="o">*</span><span class="n">P</span><span class="p">[</span><span class="n">indPl</span><span class="p">,</span><span class="n">indPc</span><span class="p">]</span><span class="o">/</span><span class="n">d</span>

        <span class="n">res</span> <span class="o">-=</span> <span class="n">P</span><span class="p">[</span><span class="n">indPl</span><span class="p">,</span><span class="n">indPc</span><span class="p">]</span>

    <span class="nb">print</span> <span class="nb">abs</span><span class="p">(</span><span class="n">l</span><span class="p">),</span><span class="s2">&quot;/&quot;</span><span class="p">,(</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span>
    <span class="k">return</span> <span class="n">psf_interp</span>


<span class="k">def</span> <span class="nf">displacement_interp_pol_3</span><span class="p">(</span><span class="n">im_ref</span><span class="p">,</span><span class="n">im_proj</span><span class="p">,</span><span class="n">t</span><span class="p">,</span><span class="n">pos_map</span><span class="p">,</span><span class="n">final_pos</span><span class="p">,</span><span class="n">cent</span><span class="p">,</span><span class="n">scale_coefft</span><span class="p">,</span><span class="n">scale_coeffr</span><span class="p">,</span><span class="n">tol</span><span class="o">=</span><span class="mf">0.001</span><span class="p">):</span>
    <span class="n">shap</span> <span class="o">=</span> <span class="n">im_proj</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">total</span> <span class="o">=</span> <span class="n">im_proj</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">total</span>
    <span class="n">ind</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">argsort2D</span><span class="p">(</span><span class="n">im_ref</span><span class="p">)</span>
    <span class="n">psf_interp</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">(</span><span class="n">shap</span><span class="p">)</span>
    <span class="n">l</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
    <span class="k">while</span> <span class="n">l</span><span class="o">&gt;-</span><span class="p">(</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="ow">and</span> <span class="n">res</span><span class="o">&gt;</span><span class="n">total</span><span class="o">*</span><span class="n">tol</span><span class="p">:</span>
        <span class="n">indP</span> <span class="o">=</span> <span class="n">ind</span><span class="p">[</span><span class="n">l</span><span class="p">]</span>
        <span class="n">l</span><span class="o">-=</span><span class="mi">1</span>
        <span class="n">indPl</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">indP</span><span class="o">/</span><span class="p">(</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>

        <span class="n">indPc</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">indP</span><span class="o">%</span><span class="p">(</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>

        <span class="n">interp_pos</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">t</span><span class="p">)</span><span class="o">*</span><span class="n">pos_map</span><span class="p">[</span><span class="n">indPl</span><span class="p">,</span><span class="n">indPc</span><span class="p">,:]</span><span class="o">+</span><span class="n">t</span><span class="o">*</span><span class="n">final_pos</span><span class="p">[</span><span class="n">indPl</span><span class="p">,</span><span class="n">indPc</span><span class="p">,:]</span>

        <span class="n">iopt</span> <span class="o">=</span> <span class="n">cent</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">jopt</span> <span class="o">=</span> <span class="n">cent</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">interp_pos</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
            <span class="n">iopt</span> <span class="o">=</span> <span class="p">(</span><span class="n">interp_pos</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="n">scale_coeffr</span><span class="p">)</span><span class="o">*</span><span class="n">cos</span><span class="p">(</span><span class="n">scale_coeffr</span><span class="o">*</span><span class="n">interp_pos</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="p">(</span><span class="n">scale_coefft</span><span class="o">*</span><span class="n">interp_pos</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span><span class="o">+</span><span class="n">cent</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">iopt</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">iopt</span><span class="p">),</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">jopt</span> <span class="o">=</span> <span class="p">(</span><span class="n">interp_pos</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="n">scale_coeffr</span><span class="p">)</span><span class="o">*</span><span class="n">sin</span><span class="p">(</span><span class="n">scale_coeffr</span><span class="o">*</span><span class="n">interp_pos</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="p">(</span><span class="n">scale_coefft</span><span class="o">*</span><span class="n">interp_pos</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span><span class="o">+</span><span class="n">cent</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">jopt</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">jopt</span><span class="p">),</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>

        <span class="n">iopt1</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">int</span><span class="p">(</span><span class="n">iopt</span><span class="p">)),</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">jopt1</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">int</span><span class="p">(</span><span class="n">jopt</span><span class="p">)),</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">mass</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">t</span><span class="p">)</span><span class="o">*</span><span class="n">im_ref</span><span class="p">[</span><span class="n">indPl</span><span class="p">,</span><span class="n">indPc</span><span class="p">]</span><span class="o">+</span><span class="n">t</span><span class="o">*</span><span class="n">im_proj</span><span class="p">[</span><span class="n">indPl</span><span class="p">,</span><span class="n">indPc</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">iopt1</span><span class="o">==</span><span class="n">iopt</span> <span class="ow">and</span> <span class="n">jopt1</span><span class="o">==</span><span class="n">jopt</span><span class="p">:</span>
            <span class="n">psf_interp</span><span class="p">[</span><span class="n">iopt1</span><span class="p">,</span><span class="n">jopt1</span><span class="p">]</span><span class="o">+=</span><span class="n">mass</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">iopt2</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">int</span><span class="p">(</span><span class="n">iopt1</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">jopt2</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">int</span><span class="p">(</span><span class="n">jopt1</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">iopt</span><span class="o">==</span><span class="n">iopt1</span><span class="p">:</span>
                <span class="n">d1</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">jopt</span><span class="o">-</span><span class="n">jopt1</span><span class="p">)</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">d2</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">jopt</span><span class="o">-</span><span class="n">jopt2</span><span class="p">)</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">d</span> <span class="o">=</span> <span class="n">d1</span><span class="o">+</span><span class="n">d2</span>
                <span class="n">psf_interp</span><span class="p">[</span><span class="n">iopt1</span><span class="p">,</span><span class="n">jopt1</span><span class="p">]</span><span class="o">+=</span><span class="n">d1</span><span class="o">*</span><span class="n">mass</span><span class="o">/</span><span class="n">d</span>
                <span class="n">psf_interp</span><span class="p">[</span><span class="n">iopt1</span><span class="p">,</span><span class="n">jopt2</span><span class="p">]</span><span class="o">+=</span><span class="n">d2</span><span class="o">*</span><span class="n">mass</span><span class="o">/</span><span class="n">d</span>
            <span class="k">elif</span> <span class="n">jopt</span><span class="o">==</span><span class="n">jopt1</span><span class="p">:</span>
                <span class="n">d1</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">iopt</span><span class="o">-</span><span class="n">iopt1</span><span class="p">)</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">d2</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">iopt</span><span class="o">-</span><span class="n">iopt2</span><span class="p">)</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">d</span> <span class="o">=</span> <span class="n">d1</span><span class="o">+</span><span class="n">d2</span>
                <span class="n">psf_interp</span><span class="p">[</span><span class="n">iopt1</span><span class="p">,</span><span class="n">jopt1</span><span class="p">]</span><span class="o">+=</span><span class="n">d1</span><span class="o">*</span><span class="n">mass</span><span class="o">/</span><span class="n">d</span>
                <span class="n">psf_interp</span><span class="p">[</span><span class="n">iopt2</span><span class="p">,</span><span class="n">jopt1</span><span class="p">]</span><span class="o">+=</span><span class="n">d2</span><span class="o">*</span><span class="n">mass</span><span class="o">/</span><span class="n">d</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="n">d1</span> <span class="o">=</span> <span class="n">sqrt</span><span class="p">((</span><span class="n">iopt</span><span class="o">-</span><span class="n">iopt1</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="p">(</span><span class="n">jopt</span><span class="o">-</span><span class="n">jopt1</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">d2</span> <span class="o">=</span> <span class="n">sqrt</span><span class="p">((</span><span class="n">iopt</span><span class="o">-</span><span class="n">iopt1</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="p">(</span><span class="n">jopt</span><span class="o">-</span><span class="n">jopt2</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">d3</span> <span class="o">=</span> <span class="n">sqrt</span><span class="p">((</span><span class="n">iopt</span><span class="o">-</span><span class="n">iopt2</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="p">(</span><span class="n">jopt</span><span class="o">-</span><span class="n">jopt1</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">d4</span> <span class="o">=</span> <span class="n">sqrt</span><span class="p">((</span><span class="n">iopt</span><span class="o">-</span><span class="n">iopt2</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="p">(</span><span class="n">jopt</span><span class="o">-</span><span class="n">jopt2</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">d</span> <span class="o">=</span> <span class="n">d1</span><span class="o">+</span><span class="n">d2</span><span class="o">+</span><span class="n">d3</span><span class="o">+</span><span class="n">d4</span>
                <span class="n">psf_interp</span><span class="p">[</span><span class="n">iopt1</span><span class="p">,</span><span class="n">jopt1</span><span class="p">]</span><span class="o">+=</span><span class="n">d1</span><span class="o">*</span><span class="n">mass</span><span class="o">/</span><span class="n">d</span>
                <span class="n">psf_interp</span><span class="p">[</span><span class="n">iopt1</span><span class="p">,</span><span class="n">jopt2</span><span class="p">]</span><span class="o">+=</span><span class="n">d2</span><span class="o">*</span><span class="n">mass</span><span class="o">/</span><span class="n">d</span>
                <span class="n">psf_interp</span><span class="p">[</span><span class="n">iopt2</span><span class="p">,</span><span class="n">jopt1</span><span class="p">]</span><span class="o">+=</span><span class="n">d3</span><span class="o">*</span><span class="n">mass</span><span class="o">/</span><span class="n">d</span>
                <span class="n">psf_interp</span><span class="p">[</span><span class="n">iopt2</span><span class="p">,</span><span class="n">jopt2</span><span class="p">]</span><span class="o">+=</span><span class="n">d4</span><span class="o">*</span><span class="n">mass</span><span class="o">/</span><span class="n">d</span>

        <span class="n">res</span> <span class="o">-=</span> <span class="n">mass</span>

    <span class="nb">print</span> <span class="nb">abs</span><span class="p">(</span><span class="n">l</span><span class="p">),</span><span class="s2">&quot;/&quot;</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">psf_interp</span>

<div class="viewcode-block" id="full_displacement"><a class="viewcode-back" href="../psf_learning_utils.html#psf_learning_utils.full_displacement">[docs]</a><span class="k">def</span> <span class="nf">full_displacement</span><span class="p">(</span><span class="n">shap</span><span class="p">,</span><span class="n">supp</span><span class="p">,</span><span class="n">t</span><span class="p">,</span><span class="n">pol_en</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">cent</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">theta_param</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">pol_mod</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">coord_map</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">knn</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">eps</span> <span class="o">=</span> <span class="mf">1.e-16</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Computes all quantities required to compute displacement interpolation at steps ``t``.</span>
<span class="sd">    </span>
<span class="sd">    Calls:</span>
<span class="sd">    </span>
<span class="sd">    * :func:`utils.polar_coord_cloud`</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">numpy</span> <span class="k">import</span> <span class="n">ones</span><span class="p">,</span><span class="n">zeros</span><span class="p">,</span><span class="n">copy</span><span class="p">,</span><span class="n">array</span><span class="p">,</span><span class="n">pi</span><span class="p">,</span><span class="nb">int</span><span class="p">,</span><span class="n">transpose</span><span class="p">,</span><span class="n">diag</span>
    <span class="kn">from</span> <span class="nn">utils</span> <span class="k">import</span> <span class="n">polar_coord_cloud</span>
    <span class="kn">from</span> <span class="nn">pyflann</span> <span class="k">import</span> <span class="n">FLANN</span>

    <span class="k">if</span> <span class="n">coord_map</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">coord_map</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="mi">2</span><span class="p">))</span>
        <span class="n">coord_map</span><span class="p">[:,:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">ones</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">])))</span>
        <span class="n">coord_map</span><span class="p">[:,:,</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">ones</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">])))</span>
        <span class="k">if</span> <span class="n">pol_en</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">cent</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">cent</span> <span class="o">=</span> <span class="n">array</span><span class="p">([</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span><span class="p">])</span>
            <span class="n">cloud_in</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
            <span class="n">cloud_in</span><span class="p">[</span><span class="mi">0</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">coord_map</span><span class="p">[:,:,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">],)))</span>
            <span class="n">cloud_in</span><span class="p">[</span><span class="mi">1</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">coord_map</span><span class="p">[:,:,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">],)))</span>
            <span class="n">cloud_out</span> <span class="o">=</span> <span class="n">polar_coord_cloud</span><span class="p">(</span><span class="n">cloud_in</span><span class="p">,</span><span class="n">cent</span><span class="p">)</span>
            <span class="n">coord_map</span><span class="p">[:,:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">cloud_out</span><span class="p">[</span><span class="mi">0</span><span class="p">,:]</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
            <span class="n">coord_map</span><span class="p">[:,:,</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">theta_param</span><span class="o">*</span><span class="n">cloud_out</span><span class="p">[</span><span class="mi">1</span><span class="p">,:]</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span><span class="o">/</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">pi</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">pol_mod</span><span class="p">:</span>
                <span class="n">coord_map</span><span class="p">[:,:,</span><span class="mi">1</span><span class="p">]</span> <span class="o">*=</span> <span class="n">coord_map</span><span class="p">[:,:,</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">knn</span> <span class="o">=</span> <span class="n">FLANN</span><span class="p">()</span>
        <span class="n">cloud_in</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="mi">2</span><span class="p">))</span>
        <span class="n">cloud_in</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">coord_map</span><span class="p">[:,:,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">],)))</span>
        <span class="n">cloud_in</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">coord_map</span><span class="p">[:,:,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">],)))</span>
        <span class="n">params</span> <span class="o">=</span> <span class="n">knn</span><span class="o">.</span><span class="n">build_index</span><span class="p">(</span><span class="n">array</span><span class="p">(</span><span class="n">cloud_in</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">float64</span><span class="p">))</span>

    <span class="n">advection_points</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">supp</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="mi">2</span><span class="p">,</span><span class="n">size</span><span class="p">(</span><span class="n">t</span><span class="p">)))</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">supp</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
        <span class="c1"># Matching coordinates</span>
        <span class="n">pos1_i</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">supp</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="p">(</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
        <span class="n">pos1_j</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">supp</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">%</span><span class="p">(</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
        <span class="n">pos2_i</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">supp</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="p">(</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
        <span class="n">pos2_j</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">supp</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">%</span><span class="p">(</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>

        <span class="k">if</span> <span class="n">size</span><span class="p">(</span><span class="n">t</span><span class="p">)</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">advection_points</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">t</span><span class="p">)</span><span class="o">*</span><span class="n">coord_map</span><span class="p">[</span><span class="n">pos1_i</span><span class="p">,</span><span class="n">pos1_j</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">t</span><span class="o">*</span><span class="n">coord_map</span><span class="p">[</span><span class="n">pos2_i</span><span class="p">,</span><span class="n">pos2_j</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">advection_points</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">t</span><span class="p">)</span><span class="o">*</span><span class="n">coord_map</span><span class="p">[</span><span class="n">pos1_i</span><span class="p">,</span><span class="n">pos1_j</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">t</span><span class="o">*</span><span class="n">coord_map</span><span class="p">[</span><span class="n">pos2_i</span><span class="p">,</span><span class="n">pos2_j</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">size</span><span class="p">(</span><span class="n">t</span><span class="p">)):</span>
                <span class="n">advection_points</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">t</span><span class="p">[</span><span class="n">j</span><span class="p">])</span><span class="o">*</span><span class="n">coord_map</span><span class="p">[</span><span class="n">pos1_i</span><span class="p">,</span><span class="n">pos1_j</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">t</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">*</span><span class="n">coord_map</span><span class="p">[</span><span class="n">pos2_i</span><span class="p">,</span><span class="n">pos2_j</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">advection_points</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">t</span><span class="p">[</span><span class="n">j</span><span class="p">])</span><span class="o">*</span><span class="n">coord_map</span><span class="p">[</span><span class="n">pos1_i</span><span class="p">,</span><span class="n">pos1_j</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">t</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">*</span><span class="n">coord_map</span><span class="p">[</span><span class="n">pos2_i</span><span class="p">,</span><span class="n">pos2_j</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span>

    <span class="n">neighbors_graph</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">supp</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="mi">4</span><span class="p">,</span><span class="n">size</span><span class="p">(</span><span class="n">t</span><span class="p">)))</span>
    <span class="n">neighbors_graph</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">supp</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="mi">2</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="n">size</span><span class="p">(</span><span class="n">t</span><span class="p">)))</span>
    <span class="n">weights_neighbors</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">supp</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="mi">4</span><span class="p">,</span><span class="n">size</span><span class="p">(</span><span class="n">t</span><span class="p">)))</span>

    <span class="k">if</span> <span class="n">size</span><span class="p">(</span><span class="n">t</span><span class="p">)</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
        <span class="n">neighbors_graph_temp</span><span class="p">,</span><span class="n">dist_neighbors</span> <span class="o">=</span> <span class="n">knn</span><span class="o">.</span><span class="n">nn_index</span><span class="p">(</span><span class="n">advection_points</span><span class="p">[:,:,</span><span class="mi">0</span><span class="p">],</span><span class="mi">4</span><span class="p">)</span>
        <span class="n">neighbors_graph</span><span class="p">[:,</span><span class="mi">0</span><span class="p">,:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">neighbors_graph_temp</span><span class="o">/</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">neighbors_graph</span><span class="p">[:,</span><span class="mi">1</span><span class="p">,:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">neighbors_graph_temp</span><span class="o">%</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">inv_dist</span> <span class="o">=</span> <span class="p">(</span><span class="n">dist_neighbors</span><span class="o">+</span><span class="n">eps</span><span class="p">)</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">weights_neighbors</span><span class="p">[:,:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">inv_dist</span><span class="o">/</span><span class="p">(</span><span class="n">inv_dist</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">supp</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">ones</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span><span class="mi">4</span><span class="p">))))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">size</span><span class="p">(</span><span class="n">t</span><span class="p">)):</span>
            <span class="nb">print</span> <span class="s2">&quot;Wavelength &quot;</span><span class="p">,</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="s2">&quot;/&quot;</span><span class="p">,</span><span class="n">size</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
            <span class="n">neighbors_graph_temp</span><span class="p">,</span><span class="n">dist_neighbors</span> <span class="o">=</span> <span class="n">knn</span><span class="o">.</span><span class="n">nn_index</span><span class="p">(</span><span class="n">advection_points</span><span class="p">[:,:,</span><span class="n">j</span><span class="p">],</span><span class="mi">4</span><span class="p">)</span>
            <span class="n">neighbors_graph</span><span class="p">[:,</span><span class="mi">0</span><span class="p">,:,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">neighbors_graph_temp</span><span class="o">/</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">neighbors_graph</span><span class="p">[:,</span><span class="mi">1</span><span class="p">,:,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">neighbors_graph_temp</span><span class="o">%</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">inv_dist</span> <span class="o">=</span> <span class="p">(</span><span class="n">dist_neighbors</span><span class="o">+</span><span class="n">eps</span><span class="p">)</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">weights_neighbors</span><span class="p">[:,:,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">inv_dist</span><span class="o">/</span><span class="p">(</span><span class="n">inv_dist</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">supp</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">ones</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span><span class="mi">4</span><span class="p">))))</span>
    <span class="n">gc</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">neighbors_graph</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">),</span><span class="n">weights_neighbors</span><span class="p">,</span><span class="n">cent</span><span class="p">,</span><span class="n">coord_map</span><span class="p">,</span><span class="n">knn</span></div>


<span class="c1">#def transport_plan_approx(supp,P_stack,shap):</span>




<div class="viewcode-block" id="transport_plan_projections"><a class="viewcode-back" href="../psf_learning_utils.html#psf_learning_utils.transport_plan_projections">[docs]</a><span class="k">def</span> <span class="nf">transport_plan_projections</span><span class="p">(</span><span class="n">P</span><span class="p">,</span><span class="n">shap</span><span class="p">,</span><span class="n">supp</span><span class="p">,</span><span class="n">neighbors_graph</span><span class="p">,</span><span class="n">weights_neighbors</span><span class="p">,</span><span class="n">spectrum</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">indices</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Computes monochromatic components (displacement interpolation steps) from transport plan.</span>
<span class="sd">    </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">numpy</span> <span class="k">import</span> <span class="n">zeros</span><span class="p">,</span><span class="nb">int</span><span class="p">,</span><span class="n">squeeze</span><span class="p">,</span><span class="n">add</span><span class="p">,</span><span class="n">ones</span>

    <span class="k">if</span> <span class="n">indices</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">nb_proj</span> <span class="o">=</span> <span class="n">neighbors_graph</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
        <span class="n">indices</span> <span class="o">=</span> <span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_proj</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">nb_proj</span> <span class="o">=</span> <span class="n">size</span><span class="p">(</span><span class="n">indices</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">spectrum</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">spectrum</span> <span class="o">=</span> <span class="n">ones</span><span class="p">((</span><span class="n">nb_proj</span><span class="p">,))</span>
    <span class="n">im_proj</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">nb_proj</span><span class="p">))</span>
    <span class="n">siz_supp</span> <span class="o">=</span> <span class="n">neighbors_graph</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_proj</span><span class="p">):</span>
        <span class="n">add</span><span class="o">.</span><span class="n">at</span><span class="p">(</span><span class="n">im_proj</span><span class="p">[:,:,</span><span class="n">indices</span><span class="p">[</span><span class="n">i</span><span class="p">]],(</span><span class="n">neighbors_graph</span><span class="p">[:,</span><span class="mi">0</span><span class="p">,:,</span><span class="n">indices</span><span class="p">[</span><span class="n">i</span><span class="p">]],</span><span class="n">neighbors_graph</span><span class="p">[:,</span><span class="mi">1</span><span class="p">,:,</span><span class="n">indices</span><span class="p">[</span><span class="n">i</span><span class="p">]]),</span>\
        <span class="n">spectrum</span><span class="p">[</span><span class="n">indices</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span><span class="o">*</span><span class="n">weights_neighbors</span><span class="p">[:,:,</span><span class="n">indices</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span><span class="o">*</span><span class="n">P</span><span class="p">[</span><span class="n">supp</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span><span class="n">supp</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]]</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">siz_supp</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">ones</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span><span class="mi">4</span><span class="p">))))</span>

    <span class="k">return</span> <span class="n">squeeze</span><span class="p">(</span><span class="n">im_proj</span><span class="p">)</span></div>

<div class="viewcode-block" id="transport_plan_projections_transpose"><a class="viewcode-back" href="../psf_learning_utils.html#psf_learning_utils.transport_plan_projections_transpose">[docs]</a><span class="k">def</span> <span class="nf">transport_plan_projections_transpose</span><span class="p">(</span><span class="n">im</span><span class="p">,</span><span class="n">supp</span><span class="p">,</span><span class="n">neighbors_graph</span><span class="p">,</span><span class="n">weights_neighbors</span><span class="p">,</span><span class="n">spectrum</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">indices</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Adjoint operator to :func:`transport_plan_projections` </span>
<span class="sd">    </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">numpy</span> <span class="k">import</span> <span class="n">zeros</span><span class="p">,</span><span class="n">squeeze</span><span class="p">,</span><span class="n">sqrt</span><span class="p">,</span><span class="n">add</span><span class="p">,</span><span class="n">repeat</span>

    <span class="n">shap</span> <span class="o">=</span> <span class="n">im</span><span class="o">.</span><span class="n">shape</span>
    <span class="k">if</span> <span class="n">indices</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">nb_proj</span> <span class="o">=</span> <span class="n">neighbors_graph</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
        <span class="n">indices</span> <span class="o">=</span> <span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_proj</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">nb_proj</span> <span class="o">=</span> <span class="n">size</span><span class="p">(</span><span class="n">indices</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">spectrum</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">spectrum</span> <span class="o">=</span> <span class="n">ones</span><span class="p">((</span><span class="n">nb_proj</span><span class="p">,))</span>
    <span class="n">P_out</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">nb_proj</span><span class="p">))</span>
    <span class="n">siz_supp</span> <span class="o">=</span> <span class="n">neighbors_graph</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">indx</span> <span class="o">=</span> <span class="n">repeat</span><span class="p">(</span><span class="n">supp</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span><span class="mi">4</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">siz_supp</span><span class="p">,</span><span class="mi">4</span><span class="p">))</span>
    <span class="n">indy</span> <span class="o">=</span> <span class="n">repeat</span><span class="p">(</span><span class="n">supp</span><span class="p">[:,</span><span class="mi">1</span><span class="p">],</span><span class="mi">4</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">siz_supp</span><span class="p">,</span><span class="mi">4</span><span class="p">))</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_proj</span><span class="p">):</span>
        <span class="n">add</span><span class="o">.</span><span class="n">at</span><span class="p">(</span><span class="n">P_out</span><span class="p">[:,:,</span><span class="n">indices</span><span class="p">[</span><span class="n">i</span><span class="p">]],(</span><span class="n">indx</span><span class="p">,</span><span class="n">indy</span><span class="p">),</span><span class="n">spectrum</span><span class="p">[</span><span class="n">indices</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span><span class="o">*</span><span class="n">weights_neighbors</span><span class="p">[:,:,</span><span class="n">indices</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span>\
                                <span class="o">*</span><span class="n">im</span><span class="p">[</span><span class="n">neighbors_graph</span><span class="p">[:,</span><span class="mi">0</span><span class="p">,:,</span><span class="n">indices</span><span class="p">[</span><span class="n">i</span><span class="p">]],</span><span class="n">neighbors_graph</span><span class="p">[:,</span><span class="mi">1</span><span class="p">,:,</span><span class="n">indices</span><span class="p">[</span><span class="n">i</span><span class="p">]]])</span>
    <span class="k">return</span> <span class="n">squeeze</span><span class="p">(</span><span class="n">P_out</span><span class="p">)</span></div>

<div class="viewcode-block" id="transport_plan_projections_field_marg"><a class="viewcode-back" href="../psf_learning_utils.html#psf_learning_utils.transport_plan_projections_field_marg">[docs]</a><span class="k">def</span> <span class="nf">transport_plan_projections_field_marg</span><span class="p">(</span><span class="n">P_stack</span><span class="p">,</span><span class="n">shap</span><span class="p">,</span><span class="n">supp</span><span class="p">,</span><span class="n">neighbors_graph</span><span class="p">,</span><span class="n">weights_neighbors</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Computes marginals of a set of transport plans.</span>
<span class="sd">    </span>
<span class="sd">    Calls:</span>
<span class="sd">    </span>
<span class="sd">    * :func:`psf_learning_utils.transport_plan_projections`</span>
<span class="sd">    </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">nb_plans</span> <span class="o">=</span> <span class="n">P_stack</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">output</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">nb_plans</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_plans</span><span class="p">):</span>
        <span class="n">output</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">transport_plan_projections</span><span class="p">(</span><span class="n">P_stack</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">],</span><span class="n">shap</span><span class="p">,</span><span class="n">supp</span><span class="p">,</span><span class="n">neighbors_graph</span><span class="p">,</span><span class="n">weights_neighbors</span><span class="p">,</span><span class="n">indices</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

    <span class="k">return</span> <span class="n">output</span></div>

<div class="viewcode-block" id="transport_plan_projections_field_marg_transpose"><a class="viewcode-back" href="../psf_learning_utils.html#psf_learning_utils.transport_plan_projections_field_marg_transpose">[docs]</a><span class="k">def</span> <span class="nf">transport_plan_projections_field_marg_transpose</span><span class="p">(</span><span class="n">im_stack</span><span class="p">,</span><span class="n">shap</span><span class="p">,</span><span class="n">supp</span><span class="p">,</span><span class="n">neighbors_graph</span><span class="p">,</span><span class="n">weights_neighbors</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Adjoint operator to :func:`transport_plan_projections_field_marg`.</span>
<span class="sd">    </span>
<span class="sd">    Calls:</span>
<span class="sd">    </span>
<span class="sd">    * :func:`psf_learning_utils.transport_plan_projections_transpose`</span>
<span class="sd">    </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">nb_plans</span> <span class="o">=</span> <span class="n">im_stack</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">output</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">nb_plans</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_plans</span><span class="p">):</span>
        <span class="n">output</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">transport_plan_projections_transpose</span><span class="p">(</span><span class="n">im_stack</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">],</span><span class="n">supp</span><span class="p">,</span><span class="n">neighbors_graph</span><span class="p">,</span><span class="n">weights_neighbors</span><span class="p">,</span><span class="n">indices</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">output</span></div>

<div class="viewcode-block" id="transport_plan_projections_field"><a class="viewcode-back" href="../psf_learning_utils.html#psf_learning_utils.transport_plan_projections_field">[docs]</a><span class="k">def</span> <span class="nf">transport_plan_projections_field</span><span class="p">(</span><span class="n">P_stack</span><span class="p">,</span><span class="n">shap</span><span class="p">,</span><span class="n">supp</span><span class="p">,</span><span class="n">neighbors_graph</span><span class="p">,</span><span class="n">weights_neighbors</span><span class="p">,</span><span class="n">spectrums</span><span class="p">,</span><span class="n">A</span><span class="p">,</span><span class="n">flux</span><span class="p">,</span><span class="n">sig</span><span class="p">,</span><span class="n">ker</span><span class="p">,</span><span class="n">D</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Reconstruct all stars in the field from current eigen transport plans.</span>
<span class="sd">    </span>
<span class="sd">    Calls:</span>
<span class="sd">    </span>
<span class="sd">    * :func:`psf_learning_utils.transport_plan_projections`</span>
<span class="sd">    * :func:`utils.decim`</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">numpy</span> <span class="k">import</span> <span class="n">zeros</span><span class="p">,</span><span class="n">ones</span><span class="p">,</span><span class="n">prod</span><span class="p">,</span><span class="n">median</span>
    <span class="n">nb_comp</span> <span class="o">=</span> <span class="n">P_stack</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">nb_bands</span> <span class="o">=</span> <span class="n">spectrums</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">nb_im</span> <span class="o">=</span> <span class="n">size</span><span class="p">(</span><span class="n">flux</span><span class="p">)</span>
    <span class="n">multi_spec_comp_mat</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">nb_comp</span><span class="p">,</span><span class="n">nb_bands</span><span class="p">))</span>
    <span class="n">mono_chromatic_psf</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">nb_im</span><span class="p">,</span><span class="n">nb_bands</span><span class="p">))</span>
    <span class="n">ones_vect</span> <span class="o">=</span> <span class="n">ones</span><span class="p">((</span><span class="n">nb_bands</span><span class="p">,))</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_comp</span><span class="p">):</span>
        <span class="n">multi_spec_comp</span> <span class="o">=</span> <span class="n">transport_plan_projections</span><span class="p">(</span><span class="n">P_stack</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">],</span><span class="n">shap</span><span class="p">,</span><span class="n">supp</span><span class="p">,</span><span class="n">neighbors_graph</span><span class="p">,</span><span class="n">weights_neighbors</span><span class="p">)</span>
        <span class="n">multi_spec_comp_mat</span><span class="p">[:,</span><span class="n">i</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">multi_spec_comp</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">prod</span><span class="p">(</span><span class="n">shap</span><span class="p">),</span><span class="n">nb_bands</span><span class="p">))</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_bands</span><span class="p">):</span>
        <span class="n">mono_chromatic_psf</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">multi_spec_comp_mat</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">A</span><span class="p">)</span>

    <span class="n">stars_est</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="n">D</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="n">D</span><span class="p">,</span><span class="n">nb_im</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_im</span><span class="p">):</span>
        <span class="n">stars_temp</span> <span class="o">=</span> <span class="p">(</span><span class="n">mono_chromatic_psf</span><span class="p">[:,</span><span class="n">i</span><span class="p">,:]</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">spectrums</span><span class="p">[:,</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">nb_bands</span><span class="p">,</span><span class="mi">1</span><span class="p">))))</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">shap</span><span class="p">)</span>
        <span class="n">stars_est</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">flux</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">/</span><span class="n">sig</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="o">*</span><span class="n">utils</span><span class="o">.</span><span class="n">decim</span><span class="p">(</span><span class="n">scisig</span><span class="o">.</span><span class="n">fftconvolve</span><span class="p">(</span><span class="n">stars_temp</span><span class="p">,</span><span class="n">ker</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">],</span><span class="n">mode</span><span class="o">=</span><span class="s1">&#39;same&#39;</span><span class="p">),</span><span class="n">D</span><span class="p">,</span><span class="n">av_en</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">gc</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">stars_est</span></div>

<div class="viewcode-block" id="transport_plan_projections_flat_field"><a class="viewcode-back" href="../psf_learning_utils.html#psf_learning_utils.transport_plan_projections_flat_field">[docs]</a><span class="k">def</span> <span class="nf">transport_plan_projections_flat_field</span><span class="p">(</span><span class="n">P_stack</span><span class="p">,</span><span class="n">supp</span><span class="p">,</span><span class="n">A</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; This method returns linear combinations of the slices of the input cube</span>
<span class="sd">        on the support, following the mixing matrix A</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">P_stack</span><span class="p">[</span><span class="n">supp</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span><span class="n">supp</span><span class="p">[:,</span><span class="mi">1</span><span class="p">],:]</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">A</span><span class="p">)</span></div>

<div class="viewcode-block" id="transport_plan_projections_flat_field_transpose"><a class="viewcode-back" href="../psf_learning_utils.html#psf_learning_utils.transport_plan_projections_flat_field_transpose">[docs]</a><span class="k">def</span> <span class="nf">transport_plan_projections_flat_field_transpose</span><span class="p">(</span><span class="n">P_mat</span><span class="p">,</span><span class="n">supp</span><span class="p">,</span><span class="n">A</span><span class="p">,</span><span class="n">shap</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Adjoint operator to :func:`transport_plan_projections_flat_field`(with</span>
<span class="sd">    regards to transport plans).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">temp_mat</span> <span class="o">=</span> <span class="n">P_mat</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">transpose</span><span class="p">(</span><span class="n">A</span><span class="p">))</span>
    <span class="n">P_stack</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">prod</span><span class="p">(</span><span class="n">shap</span><span class="p">),</span><span class="n">prod</span><span class="p">(</span><span class="n">shap</span><span class="p">),</span><span class="n">A</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
    <span class="n">P_stack</span><span class="p">[</span><span class="n">supp</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span><span class="n">supp</span><span class="p">[:,</span><span class="mi">1</span><span class="p">],:]</span> <span class="o">=</span> <span class="n">temp_mat</span>
    <span class="k">return</span> <span class="n">P_stack</span></div>

<div class="viewcode-block" id="transport_plan_projections_flat_field_transpose_coeff"><a class="viewcode-back" href="../psf_learning_utils.html#psf_learning_utils.transport_plan_projections_flat_field_transpose_coeff">[docs]</a><span class="k">def</span> <span class="nf">transport_plan_projections_flat_field_transpose_coeff</span><span class="p">(</span><span class="n">P_mat</span><span class="p">,</span><span class="n">P_stack</span><span class="p">,</span><span class="n">supp</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Adjoint operator to :func:`transport_plan_projections_flat_field` (with</span>
<span class="sd">    regards to weights).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">transpose</span><span class="p">(</span><span class="n">P_stack</span><span class="p">[</span><span class="n">supp</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span><span class="n">supp</span><span class="p">[:,</span><span class="mi">1</span><span class="p">],:])</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">P_mat</span><span class="p">)</span></div>

<div class="viewcode-block" id="field_reconstruction"><a class="viewcode-back" href="../psf_learning_utils.html#psf_learning_utils.field_reconstruction">[docs]</a><span class="k">def</span> <span class="nf">field_reconstruction</span><span class="p">(</span><span class="n">P_stack</span><span class="p">,</span><span class="n">shap</span><span class="p">,</span><span class="n">supp</span><span class="p">,</span><span class="n">neighbors_graph</span><span class="p">,</span><span class="n">weights_neighbors</span><span class="p">,</span><span class="n">A</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Computes monochromatic PSFs from eigenTransport plans.</span>
<span class="sd">    </span>
<span class="sd">    Calls:</span>
<span class="sd">    </span>
<span class="sd">    * :func:`psf_learning_utils.transport_plan_projections`</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">numpy</span> <span class="k">import</span> <span class="n">zeros</span><span class="p">,</span><span class="n">ones</span><span class="p">,</span><span class="n">prod</span><span class="p">,</span><span class="n">median</span>
    <span class="n">nb_comp</span> <span class="o">=</span> <span class="n">P_stack</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">nb_bands</span> <span class="o">=</span> <span class="n">neighbors_graph</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">nb_im</span> <span class="o">=</span> <span class="n">A</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">multi_spec_comp_mat</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">nb_comp</span><span class="p">,</span><span class="n">nb_bands</span><span class="p">))</span>
    <span class="n">mono_chromatic_psf</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">nb_im</span><span class="p">,</span><span class="n">nb_bands</span><span class="p">))</span>
    <span class="n">ones_vect</span> <span class="o">=</span> <span class="n">ones</span><span class="p">((</span><span class="n">nb_bands</span><span class="p">,))</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_comp</span><span class="p">):</span>
        <span class="n">multi_spec_comp</span> <span class="o">=</span> <span class="n">transport_plan_projections</span><span class="p">(</span><span class="n">P_stack</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">],</span><span class="n">shap</span><span class="p">,</span><span class="n">supp</span><span class="p">,</span><span class="n">neighbors_graph</span><span class="p">,</span><span class="n">weights_neighbors</span><span class="p">)</span>
        <span class="n">multi_spec_comp_mat</span><span class="p">[:,</span><span class="n">i</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">multi_spec_comp</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">prod</span><span class="p">(</span><span class="n">shap</span><span class="p">),</span><span class="n">nb_bands</span><span class="p">))</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_bands</span><span class="p">):</span>
        <span class="n">mono_chromatic_psf_temp</span> <span class="o">=</span> <span class="n">multi_spec_comp_mat</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">A</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_im</span><span class="p">):</span>
            <span class="n">mono_chromatic_psf</span><span class="p">[:,:,</span><span class="n">j</span><span class="p">,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">mono_chromatic_psf_temp</span><span class="p">[:,</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>

    <span class="k">return</span> <span class="n">mono_chromatic_psf</span></div>

<div class="viewcode-block" id="transport_plan_projections_field_transpose"><a class="viewcode-back" href="../psf_learning_utils.html#psf_learning_utils.transport_plan_projections_field_transpose">[docs]</a><span class="k">def</span> <span class="nf">transport_plan_projections_field_transpose</span><span class="p">(</span><span class="n">im_stack</span><span class="p">,</span><span class="n">supp</span><span class="p">,</span><span class="n">neighbors_graph</span><span class="p">,</span><span class="n">weights_neighbors</span><span class="p">,</span><span class="n">spectrums</span><span class="p">,</span><span class="n">A</span><span class="p">,</span><span class="n">flux</span><span class="p">,</span><span class="n">sig</span><span class="p">,</span><span class="n">ker_rot</span><span class="p">,</span><span class="n">D</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Adjoint operator to :func:`psf_learning_utils.transport_plan_projections_field`</span>
<span class="sd">    (with regards to transport plans).</span>
<span class="sd">    </span>
<span class="sd">    Calls:</span>
<span class="sd">    </span>
<span class="sd">    * :func:`utils.transpose_decim`</span>
<span class="sd">    * :func:`psf_learning_utils.transport_plan_projections_transpose_2`</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="kn">from</span> <span class="nn">numpy</span> <span class="k">import</span> <span class="n">zeros</span><span class="p">,</span><span class="n">ones</span><span class="p">,</span><span class="n">prod</span><span class="p">,</span><span class="n">median</span><span class="p">,</span><span class="n">diag</span>
    <span class="n">nb_comp</span> <span class="o">=</span> <span class="n">A</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">nb_bands</span> <span class="o">=</span> <span class="n">spectrums</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">nb_im</span> <span class="o">=</span> <span class="n">size</span><span class="p">(</span><span class="n">flux</span><span class="p">)</span>
    <span class="n">shap_lr</span> <span class="o">=</span> <span class="n">im_stack</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">shap</span> <span class="o">=</span> <span class="p">(</span><span class="n">shap_lr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">D</span><span class="p">,</span><span class="n">shap_lr</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">D</span><span class="p">)</span>
    <span class="n">psf_est</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">nb_im</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_im</span><span class="p">):</span>
        <span class="n">psf_temp</span> <span class="o">=</span> <span class="p">(</span><span class="n">flux</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">/</span><span class="n">sig</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="o">*</span><span class="n">scisig</span><span class="o">.</span><span class="n">convolve</span><span class="p">(</span><span class="n">utils</span><span class="o">.</span><span class="n">transpose_decim</span><span class="p">(</span><span class="n">im_stack</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">],</span><span class="n">D</span><span class="p">),</span><span class="n">ker_rot</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">],</span><span class="n">mode</span><span class="o">=</span><span class="s1">&#39;same&#39;</span><span class="p">)</span>
        <span class="n">psf_est</span><span class="p">[:,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">psf_temp</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">prod</span><span class="p">(</span><span class="n">shap</span><span class="p">),))</span>
    <span class="n">comp_est</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">nb_comp</span><span class="p">,</span><span class="n">nb_bands</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_bands</span><span class="p">):</span>
        <span class="n">comp_est</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">psf_est</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">diag</span><span class="p">(</span><span class="n">spectrums</span><span class="p">[</span><span class="n">i</span><span class="p">,:])</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">transpose</span><span class="p">(</span><span class="n">A</span><span class="p">)))</span>
    <span class="n">ones_vect</span> <span class="o">=</span> <span class="n">ones</span><span class="p">((</span><span class="n">nb_bands</span><span class="p">,))</span>
    <span class="n">P_stack</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">prod</span><span class="p">(</span><span class="n">shap</span><span class="p">),</span><span class="n">prod</span><span class="p">(</span><span class="n">shap</span><span class="p">),</span><span class="n">nb_comp</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_comp</span><span class="p">):</span>
        <span class="n">P_stack</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">transport_plan_projections_transpose_2</span><span class="p">(</span><span class="n">comp_est</span><span class="p">[:,</span><span class="n">i</span><span class="p">,:]</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">nb_bands</span><span class="p">)),</span><span class="n">supp</span><span class="p">,</span><span class="n">neighbors_graph</span><span class="p">,</span><span class="n">weights_neighbors</span><span class="p">,</span><span class="n">ones_vect</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">gc</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">P_stack</span></div>

<span class="k">def</span> <span class="nf">transport_plan_projections_field_grad_mat</span><span class="p">(</span><span class="n">input_op</span><span class="p">):</span>

    <span class="n">P_stack</span> <span class="o">=</span> <span class="n">input_op</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">shap</span> <span class="o">=</span> <span class="n">input_op</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">supp</span> <span class="o">=</span> <span class="n">input_op</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">neighbors_graph</span> <span class="o">=</span> <span class="n">input_op</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
    <span class="n">weights_neighbors</span> <span class="o">=</span> <span class="n">input_op</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>
    <span class="n">spectrums</span> <span class="o">=</span> <span class="n">input_op</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span>
    <span class="n">A</span> <span class="o">=</span> <span class="n">input_op</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span>
    <span class="n">flux</span> <span class="o">=</span> <span class="n">input_op</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span>
    <span class="n">sig</span> <span class="o">=</span> <span class="n">input_op</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span>
    <span class="n">ker</span> <span class="o">=</span> <span class="n">input_op</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span>
    <span class="n">D</span> <span class="o">=</span> <span class="n">input_op</span><span class="p">[</span><span class="mi">10</span><span class="p">]</span>
    <span class="n">ker_rot</span> <span class="o">=</span> <span class="n">input_op</span><span class="p">[</span><span class="mi">11</span><span class="p">]</span>

    <span class="n">star_est</span> <span class="o">=</span> <span class="n">transport_plan_projections_field</span><span class="p">(</span><span class="n">P_stack</span><span class="p">,</span><span class="n">shap</span><span class="p">,</span><span class="n">supp</span><span class="p">,</span><span class="n">neighbors_graph</span><span class="p">,</span><span class="n">weights_neighbors</span><span class="p">,</span><span class="n">spectrums</span><span class="p">,</span><span class="n">A</span><span class="p">,</span><span class="n">flux</span><span class="p">,</span><span class="n">sig</span><span class="p">,</span><span class="n">ker</span><span class="p">,</span><span class="n">D</span><span class="p">)</span>
    <span class="n">P</span> <span class="o">=</span> <span class="n">transport_plan_projections_field_transpose</span><span class="p">(</span><span class="n">star_est</span><span class="p">,</span><span class="n">supp</span><span class="p">,</span><span class="n">neighbors_graph</span><span class="p">,</span><span class="n">weights_neighbors</span><span class="p">,</span><span class="n">spectrums</span><span class="p">,</span><span class="n">A</span><span class="p">,</span><span class="n">flux</span><span class="p">,</span><span class="n">sig</span><span class="p">,</span><span class="n">ker_rot</span><span class="p">,</span><span class="n">D</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">P</span>

<span class="k">def</span> <span class="nf">transport_plan_projections_field_gradient</span><span class="p">(</span><span class="n">obs_stars</span><span class="p">,</span><span class="n">P_est</span><span class="p">,</span><span class="n">supp</span><span class="p">,</span><span class="n">neighbors_graph</span><span class="p">,</span><span class="n">weights_neighbors</span><span class="p">,</span><span class="n">spectrums</span><span class="p">,</span><span class="n">A_est</span><span class="p">,</span><span class="n">flux</span><span class="p">,</span><span class="n">sig</span><span class="p">,</span><span class="n">ker</span><span class="p">,</span><span class="n">ker_rot</span><span class="p">,</span><span class="n">D</span><span class="p">):</span>

    <span class="n">shap_obs</span> <span class="o">=</span> <span class="n">obs_stars</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">shap</span> <span class="o">=</span> <span class="p">(</span><span class="n">shap_obs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">D</span><span class="p">,</span><span class="n">shap_obs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">D</span><span class="p">)</span>
    <span class="n">star_est</span> <span class="o">=</span> <span class="n">transport_plan_projections_field</span><span class="p">(</span><span class="n">P_est</span><span class="p">,</span><span class="n">shap</span><span class="p">,</span><span class="n">supp</span><span class="p">,</span><span class="n">neighbors_graph</span><span class="p">,</span><span class="n">weights_neighbors</span><span class="p">,</span><span class="n">spectrums</span><span class="p">,</span><span class="n">A_est</span><span class="p">,</span><span class="n">flux</span><span class="p">,</span><span class="n">sig</span><span class="p">,</span><span class="n">ker</span><span class="p">,</span><span class="n">D</span><span class="p">)</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">obs_stars</span><span class="o">-</span><span class="n">star_est</span>
    <span class="n">grad</span> <span class="o">=</span> <span class="o">-</span><span class="n">transport_plan_projections_field_transpose</span><span class="p">(</span><span class="n">res</span><span class="p">,</span><span class="n">supp</span><span class="p">,</span><span class="n">neighbors_graph</span><span class="p">,</span><span class="n">weights_neighbors</span><span class="p">,</span><span class="n">spectrums</span><span class="p">,</span><span class="n">A_est</span><span class="p">,</span><span class="n">flux</span><span class="p">,</span><span class="n">sig</span><span class="p">,</span><span class="n">ker_rot</span><span class="p">,</span><span class="n">D</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">res</span><span class="p">,</span><span class="n">grad</span>

<span class="k">def</span> <span class="nf">transport_plan_projections_field_coeff_grad_mat</span><span class="p">(</span><span class="n">input_op</span><span class="p">):</span>

    <span class="n">A</span> <span class="o">=</span> <span class="n">input_op</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">P_stack</span> <span class="o">=</span> <span class="n">input_op</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span>
    <span class="n">shap</span> <span class="o">=</span> <span class="n">input_op</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">supp</span> <span class="o">=</span> <span class="n">input_op</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">neighbors_graph</span> <span class="o">=</span> <span class="n">input_op</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
    <span class="n">weights_neighbors</span> <span class="o">=</span> <span class="n">input_op</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>
    <span class="n">spectrums</span> <span class="o">=</span> <span class="n">input_op</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span>
    <span class="n">flux</span> <span class="o">=</span> <span class="n">input_op</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span>
    <span class="n">sig</span> <span class="o">=</span> <span class="n">input_op</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span>
    <span class="n">ker</span> <span class="o">=</span> <span class="n">input_op</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span>
    <span class="n">D</span> <span class="o">=</span> <span class="n">input_op</span><span class="p">[</span><span class="mi">10</span><span class="p">]</span>
    <span class="n">ker_rot</span> <span class="o">=</span> <span class="n">input_op</span><span class="p">[</span><span class="mi">11</span><span class="p">]</span>

    <span class="n">star_est</span> <span class="o">=</span> <span class="n">transport_plan_projections_field</span><span class="p">(</span><span class="n">P_stack</span><span class="p">,</span><span class="n">shap</span><span class="p">,</span><span class="n">supp</span><span class="p">,</span><span class="n">neighbors_graph</span><span class="p">,</span><span class="n">weights_neighbors</span><span class="p">,</span><span class="n">spectrums</span><span class="p">,</span><span class="n">A</span><span class="p">,</span><span class="n">flux</span><span class="p">,</span><span class="n">sig</span><span class="p">,</span><span class="n">ker</span><span class="p">,</span><span class="n">D</span><span class="p">)</span>
    <span class="n">A_out</span> <span class="o">=</span> <span class="n">transport_plan_projections_field_coeff_transpose</span><span class="p">(</span><span class="n">star_est</span><span class="p">,</span><span class="n">supp</span><span class="p">,</span><span class="n">neighbors_graph</span><span class="p">,</span>\
                                    <span class="n">weights_neighbors</span><span class="p">,</span><span class="n">spectrums</span><span class="p">,</span><span class="n">P_stack</span><span class="p">,</span><span class="n">flux</span><span class="p">,</span><span class="n">sig</span><span class="p">,</span><span class="n">ker_rot</span><span class="p">,</span><span class="n">D</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">A_out</span>


<span class="k">def</span> <span class="nf">transport_plan_projections_field_coeff_gradient</span><span class="p">(</span><span class="n">obs_stars</span><span class="p">,</span><span class="n">P_est</span><span class="p">,</span><span class="n">supp</span><span class="p">,</span><span class="n">neighbors_graph</span><span class="p">,</span><span class="n">weights_neighbors</span><span class="p">,</span><span class="n">spectrums</span><span class="p">,</span><span class="n">A_est</span><span class="p">,</span><span class="n">flux</span><span class="p">,</span><span class="n">sig</span><span class="p">,</span><span class="n">ker</span><span class="p">,</span><span class="n">ker_rot</span><span class="p">,</span><span class="n">D</span><span class="p">):</span>

    <span class="n">shap_obs</span> <span class="o">=</span> <span class="n">obs_stars</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">shap</span> <span class="o">=</span> <span class="p">(</span><span class="n">shap_obs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">D</span><span class="p">,</span><span class="n">shap_obs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">D</span><span class="p">)</span>
    <span class="n">star_est</span> <span class="o">=</span> <span class="n">transport_plan_projections_field</span><span class="p">(</span><span class="n">P_est</span><span class="p">,</span><span class="n">shap</span><span class="p">,</span><span class="n">supp</span><span class="p">,</span><span class="n">neighbors_graph</span><span class="p">,</span><span class="n">weights_neighbors</span><span class="p">,</span><span class="n">spectrums</span><span class="p">,</span><span class="n">A_est</span><span class="p">,</span><span class="n">flux</span><span class="p">,</span><span class="n">sig</span><span class="p">,</span><span class="n">ker</span><span class="p">,</span><span class="n">D</span><span class="p">)</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">obs_stars</span><span class="o">-</span><span class="n">star_est</span>
    <span class="n">grad</span> <span class="o">=</span> <span class="o">-</span><span class="n">transport_plan_projections_field_coeff_transpose</span><span class="p">(</span><span class="n">res</span><span class="p">,</span><span class="n">supp</span><span class="p">,</span><span class="n">neighbors_graph</span><span class="p">,</span>\
                                                            <span class="n">weights_neighbors</span><span class="p">,</span><span class="n">spectrums</span><span class="p">,</span><span class="n">P_est</span><span class="p">,</span><span class="n">flux</span><span class="p">,</span><span class="n">sig</span><span class="p">,</span><span class="n">ker_rot</span><span class="p">,</span><span class="n">D</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">res</span><span class="p">,</span><span class="n">grad</span>


<div class="viewcode-block" id="transport_plan_projections_field_coeff_transpose"><a class="viewcode-back" href="../psf_learning_utils.html#psf_learning_utils.transport_plan_projections_field_coeff_transpose">[docs]</a><span class="k">def</span> <span class="nf">transport_plan_projections_field_coeff_transpose</span><span class="p">(</span><span class="n">im_stack</span><span class="p">,</span><span class="n">supp</span><span class="p">,</span><span class="n">neighbors_graph</span><span class="p">,</span><span class="n">weights_neighbors</span><span class="p">,</span><span class="n">spectrums</span><span class="p">,</span><span class="n">P_stack</span><span class="p">,</span><span class="n">flux</span><span class="p">,</span><span class="n">sig</span><span class="p">,</span><span class="n">ker_rot</span><span class="p">,</span><span class="n">D</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Adjoint operator to :func:`psf_learning_utils.transport_plan_projections_field`</span>
<span class="sd">    (with regards to weights).</span>
<span class="sd">    </span>
<span class="sd">    Calls:</span>
<span class="sd">    </span>
<span class="sd">    * :func:`utils.transpose_decim`</span>
<span class="sd">    * :func:`psf_learning_utils.transport_plan_projections`</span>
<span class="sd">    </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">numpy</span> <span class="k">import</span> <span class="n">zeros</span><span class="p">,</span><span class="n">ones</span><span class="p">,</span><span class="n">prod</span><span class="p">,</span><span class="n">median</span><span class="p">,</span><span class="n">diag</span>

    <span class="n">nb_comp</span> <span class="o">=</span> <span class="n">P_stack</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">nb_bands</span> <span class="o">=</span> <span class="n">spectrums</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">nb_im</span> <span class="o">=</span> <span class="n">size</span><span class="p">(</span><span class="n">flux</span><span class="p">)</span>
    <span class="n">shap_lr</span> <span class="o">=</span> <span class="n">im_stack</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">shap</span> <span class="o">=</span> <span class="p">(</span><span class="n">shap_lr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">D</span><span class="p">,</span><span class="n">shap_lr</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">D</span><span class="p">)</span>
    <span class="n">multi_spec_comp_mat</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">nb_comp</span><span class="p">,</span><span class="n">nb_bands</span><span class="p">))</span>
    <span class="n">psf_est</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">nb_im</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_im</span><span class="p">):</span>
        <span class="n">psf_temp</span> <span class="o">=</span> <span class="p">(</span><span class="n">flux</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">/</span><span class="n">sig</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="o">*</span><span class="n">scisig</span><span class="o">.</span><span class="n">convolve</span><span class="p">(</span><span class="n">utils</span><span class="o">.</span><span class="n">transpose_decim</span><span class="p">(</span><span class="n">im_stack</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">],</span><span class="n">D</span><span class="p">),</span><span class="n">ker_rot</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">],</span><span class="n">mode</span><span class="o">=</span><span class="s1">&#39;same&#39;</span><span class="p">)</span>
        <span class="n">psf_est</span><span class="p">[:,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">psf_temp</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">prod</span><span class="p">(</span><span class="n">shap</span><span class="p">),))</span>

    <span class="n">ones_vect</span> <span class="o">=</span> <span class="n">ones</span><span class="p">((</span><span class="n">nb_bands</span><span class="p">,))</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_comp</span><span class="p">):</span>
        <span class="n">multi_spec_comp</span> <span class="o">=</span> <span class="n">transport_plan_projections</span><span class="p">(</span><span class="n">P_stack</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">],</span><span class="n">shap</span><span class="p">,</span><span class="n">supp</span><span class="p">,</span><span class="n">neighbors_graph</span><span class="p">,</span><span class="n">weights_neighbors</span><span class="p">)</span>
        <span class="n">multi_spec_comp_mat</span><span class="p">[:,</span><span class="n">i</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">multi_spec_comp</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">prod</span><span class="p">(</span><span class="n">shap</span><span class="p">),</span><span class="n">nb_bands</span><span class="p">))</span>

    <span class="n">A</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">nb_comp</span><span class="p">,</span><span class="n">nb_im</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_im</span><span class="p">):</span>
        <span class="n">Si</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">nb_comp</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_comp</span><span class="p">):</span>
            <span class="n">Si</span><span class="p">[:,</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">multi_spec_comp_mat</span><span class="p">[:,</span><span class="n">k</span><span class="p">,:]</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">spectrums</span><span class="p">[:,</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">nb_bands</span><span class="p">,</span><span class="mi">1</span><span class="p">))))</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">prod</span><span class="p">(</span><span class="n">shap</span><span class="p">),))</span>
        <span class="n">A</span><span class="p">[:,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">transpose</span><span class="p">(</span><span class="n">Si</span><span class="p">)</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">psf_est</span><span class="p">[:,</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">prod</span><span class="p">(</span><span class="n">shap</span><span class="p">),</span><span class="mi">1</span><span class="p">))))</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">nb_comp</span><span class="p">,))</span>
    <span class="n">gc</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">A</span></div>


<div class="viewcode-block" id="transport_plan_projections_transpose_2"><a class="viewcode-back" href="../psf_learning_utils.html#psf_learning_utils.transport_plan_projections_transpose_2">[docs]</a><span class="k">def</span> <span class="nf">transport_plan_projections_transpose_2</span><span class="p">(</span><span class="n">im_stack</span><span class="p">,</span><span class="n">supp</span><span class="p">,</span><span class="n">neighbors_graph</span><span class="p">,</span><span class="n">weights_neighbors</span><span class="p">,</span><span class="n">spectrum</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Computes the adjoint operator of the displacement inteerpolation for a</span>
<span class="sd">    given transport plan.&quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">numpy</span> <span class="k">import</span> <span class="n">zeros</span><span class="p">,</span><span class="n">squeeze</span><span class="p">,</span><span class="n">sqrt</span><span class="p">,</span><span class="n">add</span><span class="p">,</span><span class="n">repeat</span>
    <span class="n">shap</span> <span class="o">=</span> <span class="n">im_stack</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">nb_proj</span> <span class="o">=</span> <span class="n">neighbors_graph</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
    <span class="n">P_out</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">nb_proj</span><span class="p">))</span>
    <span class="n">siz_supp</span> <span class="o">=</span> <span class="n">neighbors_graph</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">indx</span> <span class="o">=</span> <span class="n">repeat</span><span class="p">(</span><span class="n">supp</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span><span class="mi">4</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">siz_supp</span><span class="p">,</span><span class="mi">4</span><span class="p">))</span>
    <span class="n">indy</span> <span class="o">=</span> <span class="n">repeat</span><span class="p">(</span><span class="n">supp</span><span class="p">[:,</span><span class="mi">1</span><span class="p">],</span><span class="mi">4</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">siz_supp</span><span class="p">,</span><span class="mi">4</span><span class="p">))</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_proj</span><span class="p">):</span>
        <span class="n">add</span><span class="o">.</span><span class="n">at</span><span class="p">(</span><span class="n">P_out</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">],(</span><span class="n">indx</span><span class="p">,</span><span class="n">indy</span><span class="p">),</span><span class="n">spectrum</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">*</span><span class="n">weights_neighbors</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">]</span><span class="o">*</span><span class="n">im_stack</span><span class="p">[</span><span class="n">neighbors_graph</span><span class="p">[:,</span><span class="mi">0</span><span class="p">,:,</span><span class="n">i</span><span class="p">],</span><span class="n">neighbors_graph</span><span class="p">[:,</span><span class="mi">1</span><span class="p">,:,</span><span class="n">i</span><span class="p">],</span><span class="n">i</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">P_out</span></div>


<span class="k">def</span> <span class="nf">pwr_mth_transpose</span><span class="p">(</span><span class="nb">input</span><span class="p">):</span>
    <span class="n">P</span> <span class="o">=</span> <span class="nb">input</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">shap</span> <span class="o">=</span> <span class="nb">input</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">supp</span> <span class="o">=</span> <span class="nb">input</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">neighbors_graph</span> <span class="o">=</span> <span class="nb">input</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
    <span class="n">weights_neighbors</span> <span class="o">=</span> <span class="nb">input</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>
    <span class="n">spectrum</span> <span class="o">=</span> <span class="nb">input</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">transport_plan_projections_transpose</span><span class="p">(</span><span class="n">transport_plan_projections</span><span class="p">(</span><span class="n">P</span><span class="p">,</span><span class="n">shap</span><span class="p">,</span>\
    <span class="n">supp</span><span class="p">,</span><span class="n">neighbors_graph</span><span class="p">,</span><span class="n">weights_neighbors</span><span class="p">,</span><span class="n">spectrum</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">),</span><span class="n">supp</span><span class="p">,</span><span class="n">neighbors_graph</span><span class="p">,</span><span class="n">weights_neighbors</span><span class="p">,</span><span class="n">spectrum</span><span class="o">=</span><span class="n">spectrum</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">transport_plan_noise_map</span><span class="p">(</span><span class="n">spectrum</span><span class="p">,</span><span class="n">supp</span><span class="p">,</span><span class="n">neighbors_graph</span><span class="p">,</span><span class="n">weights_neighbors</span><span class="p">,</span><span class="n">shap</span><span class="p">):</span>
    <span class="kn">from</span> <span class="nn">numpy.linalg</span> <span class="k">import</span> <span class="n">norm</span>
    <span class="kn">from</span> <span class="nn">numpy</span> <span class="k">import</span> <span class="n">add</span><span class="p">,</span><span class="n">repeat</span><span class="p">,</span><span class="n">transpose</span>

    <span class="n">nb_proj</span> <span class="o">=</span> <span class="n">neighbors_graph</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
    <span class="n">P_out</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
    <span class="n">rep_spec</span> <span class="o">=</span> <span class="n">transpose</span><span class="p">(</span><span class="n">repeat</span><span class="p">(</span><span class="n">spectrum</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">nb_proj</span><span class="p">,</span><span class="mi">4</span><span class="p">)))</span>

    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">supp</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
        <span class="n">temp_im</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">(</span><span class="n">shap</span><span class="p">)</span>
        <span class="n">add</span><span class="o">.</span><span class="n">at</span><span class="p">(</span><span class="n">temp_im</span><span class="p">,(</span><span class="n">neighbors_graph</span><span class="p">[</span><span class="n">j</span><span class="p">,</span><span class="mi">0</span><span class="p">,:,:],</span><span class="n">neighbors_graph</span><span class="p">[</span><span class="n">j</span><span class="p">,</span><span class="mi">1</span><span class="p">,:,:]),</span><span class="n">rep_spec</span><span class="o">*</span><span class="n">weights_neighbors</span><span class="p">[</span><span class="n">j</span><span class="p">,:,:])</span>
        <span class="sd">&quot;&quot;&quot;for i in range(0,nb_proj):</span>
<span class="sd">            if dist_neighbors[j,0,i]==0:</span>
<span class="sd">                i_im = int(neighbors_graph[j,0,i]/shap[0])</span>
<span class="sd">                j_im = int(neighbors_graph[j,0,i]%shap[0])</span>
<span class="sd">                temp_im[i_im,j_im]+=spectrum[i]</span>
<span class="sd">            else:</span>
<span class="sd">                for k in range(0,dist_neighbors.shape[1]):</span>
<span class="sd">                    i_im = int(neighbors_graph[j,k,i]/shap[0])</span>
<span class="sd">                    j_im = int(neighbors_graph[j,k,i]%shap[0])</span>
<span class="sd">                    temp_im[i_im,j_im]+=spectrum[i]*(dist_neighbors[j,k,i]**(-1))/sum(dist_neighbors[j,:,i]**(-1))&quot;&quot;&quot;</span>
        <span class="n">P_out</span><span class="p">[</span><span class="n">supp</span><span class="p">[</span><span class="n">j</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span><span class="n">supp</span><span class="p">[</span><span class="n">j</span><span class="p">,</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="n">norm</span><span class="p">(</span><span class="n">temp_im</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">P_out</span>

<span class="k">def</span> <span class="nf">noise_estimation</span><span class="p">(</span><span class="n">im_stack</span><span class="p">,</span><span class="n">shap</span><span class="p">,</span><span class="n">supp</span><span class="p">,</span><span class="n">neighbors_graph</span><span class="p">,</span><span class="n">weights_neighbors</span><span class="p">,</span><span class="n">spectrums</span><span class="p">,</span>\
    <span class="n">A</span><span class="p">,</span><span class="n">flux</span><span class="p">,</span><span class="n">sig</span><span class="p">,</span><span class="n">ker_rot</span><span class="p">,</span><span class="n">D</span><span class="p">,</span><span class="n">stack_coeff</span><span class="p">,</span><span class="n">filters</span><span class="p">,</span><span class="n">opt_wvlth</span><span class="p">,</span><span class="n">ind_i</span><span class="p">,</span><span class="n">nb_comp</span> <span class="o">=</span> <span class="mi">50</span><span class="p">):</span>
    <span class="kn">from</span> <span class="nn">utils</span> <span class="k">import</span> <span class="n">correlated_noise_est</span>
    <span class="n">P_stack</span> <span class="o">=</span> <span class="n">transport_plan_projections_field_transpose</span><span class="p">(</span><span class="n">im_stack</span><span class="p">,</span><span class="n">shap</span><span class="p">,</span><span class="n">supp</span><span class="p">,</span><span class="n">neighbors_graph</span><span class="p">,</span><span class="n">weights_neighbors</span><span class="p">,</span><span class="n">spectrums</span><span class="p">,</span><span class="n">A</span><span class="p">,</span><span class="n">flux</span><span class="p">,</span><span class="n">sig</span><span class="p">,</span><span class="n">ker_rot</span><span class="p">,</span><span class="n">D</span><span class="p">)</span>

    <span class="c1"># Transport plans noise maps</span>
    <span class="n">shap_P</span> <span class="o">=</span> <span class="n">P_stack</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">plans_noise_map</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">(</span><span class="n">shap_P</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap_P</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
        <span class="n">plans_noise_map</span><span class="p">[</span><span class="n">supp</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span><span class="n">supp</span><span class="p">[:,</span><span class="mi">1</span><span class="p">],</span><span class="n">i</span><span class="p">]</span><span class="o">+=</span> <span class="n">correlated_noise_est</span><span class="p">(</span><span class="n">P_stack</span><span class="p">[</span><span class="n">supp</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span><span class="n">supp</span><span class="p">[:,</span><span class="mi">1</span><span class="p">],</span><span class="n">i</span><span class="p">])</span>

    <span class="n">nb_bands</span> <span class="o">=</span> <span class="n">spectrums</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">wavelets_coeff</span><span class="p">,</span><span class="n">spec_coeff_dct</span><span class="p">,</span><span class="n">spec_coeff_wav</span> <span class="o">=</span> <span class="n">analysis_op_3</span><span class="p">(</span><span class="n">P_stack</span><span class="p">,</span><span class="n">stack_coeff</span><span class="p">,</span><span class="n">filters</span><span class="p">,</span><span class="n">opt_wvlth</span><span class="p">,</span><span class="n">shap</span><span class="p">,</span><span class="n">supp</span><span class="p">,</span><span class="n">neighbors_graph</span><span class="p">,</span><span class="n">ind_i</span><span class="p">,</span><span class="n">weights_neighbors</span><span class="p">,</span><span class="n">nb_bands</span><span class="p">,</span><span class="n">nb_comp</span> <span class="o">=</span> <span class="mi">50</span><span class="p">)</span>

    <span class="n">wavelets_coeff_noise</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">(</span><span class="n">wavelets_coeff</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
    <span class="n">spec_coeff_dct_noise</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">(</span><span class="n">spec_coeff_dct</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
    <span class="n">spec_coeff_wav_noise</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">(</span><span class="n">spec_coeff_wav</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

    <span class="sd">&quot;&quot;&quot;for i in range(0,nb_bands):</span>
<span class="sd">        spec_coeff_dct_noise[:,:,i]+=&quot;&quot;&quot;</span>



<span class="k">def</span> <span class="nf">transpose_check</span><span class="p">(</span><span class="n">shap</span><span class="p">,</span><span class="n">sig</span><span class="o">=</span><span class="mf">3.</span><span class="p">):</span>
    <span class="kn">from</span> <span class="nn">numpy</span> <span class="k">import</span> <span class="n">zeros</span><span class="p">,</span><span class="n">where</span><span class="p">,</span><span class="n">transpose</span><span class="p">,</span><span class="n">array</span>
    <span class="kn">from</span> <span class="nn">numpy.random</span> <span class="k">import</span> <span class="n">random</span><span class="p">,</span><span class="n">randn</span>
    <span class="kn">from</span> <span class="nn">utils</span> <span class="k">import</span> <span class="n">diagonally_dominated_mat</span>
    <span class="kn">from</span> <span class="nn">numpy.linalg</span> <span class="k">import</span> <span class="n">norm</span>

    <span class="n">P</span> <span class="o">=</span> <span class="n">diagonally_dominated_mat</span><span class="p">(</span><span class="n">shap</span><span class="p">,</span><span class="n">sig</span><span class="o">=</span><span class="n">sig</span><span class="p">,</span><span class="n">thresh_en</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">i</span><span class="p">,</span><span class="n">j</span> <span class="o">=</span> <span class="n">where</span><span class="p">(</span><span class="n">P</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">P</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">randn</span><span class="p">(</span><span class="n">size</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>
    <span class="n">supp</span> <span class="o">=</span> <span class="n">transpose</span><span class="p">(</span><span class="n">array</span><span class="p">([</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]))</span>
    <span class="n">t</span> <span class="o">=</span> <span class="n">random</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">neighbors_graph</span><span class="p">,</span><span class="n">dist_neighbors</span><span class="p">,</span><span class="n">cent</span><span class="p">,</span><span class="n">coord_map</span><span class="p">,</span><span class="n">knn</span> <span class="o">=</span> <span class="n">full_displacement</span><span class="p">(</span><span class="n">shap</span><span class="p">,</span><span class="n">supp</span><span class="p">,</span><span class="n">t</span><span class="p">,</span><span class="n">pol_en</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">cent</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">theta_param</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">pol_mod</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">coord_map</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">knn</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
    <span class="n">im</span> <span class="o">=</span> <span class="n">randn</span><span class="p">(</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

    <span class="n">im_proj</span> <span class="o">=</span> <span class="n">transport_plan_projections</span><span class="p">(</span><span class="n">P</span><span class="p">,</span><span class="n">shap</span><span class="p">,</span><span class="n">supp</span><span class="p">,</span><span class="n">neighbors_graph</span><span class="p">,</span><span class="n">dist_neighbors</span><span class="p">)</span>
    <span class="n">P_proj</span> <span class="o">=</span> <span class="n">transport_plan_projections_transpose</span><span class="p">(</span><span class="n">im</span><span class="p">,</span><span class="n">supp</span><span class="p">,</span><span class="n">neighbors_graph</span><span class="p">,</span><span class="n">dist_neighbors</span><span class="p">)</span>

    <span class="n">a1</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">im</span><span class="o">*</span><span class="n">im_proj</span><span class="p">)</span>
    <span class="n">a2</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">P</span><span class="o">*</span><span class="n">P_proj</span><span class="p">)</span>

    <span class="n">check</span> <span class="o">=</span> <span class="mi">100</span><span class="o">*</span><span class="nb">abs</span><span class="p">(</span><span class="n">a1</span><span class="o">-</span><span class="n">a2</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">norm</span><span class="p">(</span><span class="n">im</span><span class="p">)</span><span class="o">*</span><span class="n">norm</span><span class="p">(</span><span class="n">P</span><span class="p">))</span>

    <span class="nb">print</span> <span class="s2">&quot;Transposition accuracy: &quot;</span><span class="p">,</span><span class="mi">100</span> <span class="o">-</span> <span class="n">check</span><span class="p">,</span><span class="s2">&quot;%&quot;</span>
    <span class="k">return</span> <span class="kc">None</span>

<span class="k">def</span> <span class="nf">transpose_field_check</span><span class="p">(</span><span class="n">shap</span><span class="p">,</span><span class="n">nb_comp</span><span class="p">,</span><span class="n">wvl</span><span class="p">,</span><span class="n">flux</span><span class="p">,</span><span class="n">sig</span><span class="p">,</span><span class="n">ker</span><span class="p">,</span><span class="n">ker_rot</span><span class="p">,</span><span class="n">D</span><span class="p">,</span><span class="n">sig_supp</span><span class="o">=</span><span class="mf">3.</span><span class="p">):</span>
    <span class="kn">from</span> <span class="nn">utils</span> <span class="k">import</span> <span class="n">diagonally_dominated_mat_stack</span>
    <span class="kn">from</span> <span class="nn">numpy.linalg</span> <span class="k">import</span> <span class="n">norm</span>

    <span class="n">PX</span> <span class="o">=</span> <span class="n">diagonally_dominated_mat_stack</span><span class="p">(</span><span class="n">shap</span><span class="p">,</span><span class="n">nb_comp</span><span class="p">,</span><span class="n">sig</span><span class="o">=</span><span class="n">sig_supp</span><span class="p">,</span><span class="n">thresh_en</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">nb_im</span> <span class="o">=</span> <span class="n">size</span><span class="p">(</span><span class="n">flux</span><span class="p">)</span>
    <span class="n">imY</span> <span class="o">=</span> <span class="n">randn</span><span class="p">(</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="n">D</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="n">D</span><span class="p">,</span><span class="n">nb_im</span><span class="p">)</span>
    <span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span> <span class="o">=</span> <span class="n">where</span><span class="p">(</span><span class="n">PX</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">PX</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">randn</span><span class="p">(</span><span class="n">size</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>
    <span class="n">i</span><span class="p">,</span><span class="n">j</span> <span class="o">=</span> <span class="n">where</span><span class="p">(</span><span class="n">PX</span><span class="p">[:,:,</span><span class="mi">0</span><span class="p">]</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">supp</span> <span class="o">=</span> <span class="n">transpose</span><span class="p">(</span><span class="n">array</span><span class="p">([</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]))</span>
    <span class="n">t</span> <span class="o">=</span> <span class="p">(</span><span class="n">wvl</span><span class="o">-</span><span class="n">wvl</span><span class="o">.</span><span class="n">min</span><span class="p">())</span><span class="o">/</span><span class="p">(</span><span class="n">wvl</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">-</span><span class="n">wvl</span><span class="o">.</span><span class="n">min</span><span class="p">())</span>
    <span class="n">neighbors_graph</span><span class="p">,</span><span class="n">dist_neighbors</span><span class="p">,</span><span class="n">cent</span><span class="p">,</span><span class="n">coord_map</span><span class="p">,</span><span class="n">knn</span> <span class="o">=</span> <span class="n">full_displacement</span><span class="p">(</span><span class="n">shap</span><span class="p">,</span><span class="n">supp</span><span class="p">,</span><span class="n">t</span><span class="p">,</span>\
    <span class="n">pol_en</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">cent</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">theta_param</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">pol_mod</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">coord_map</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">knn</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
    <span class="n">spectrums</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">randn</span><span class="p">(</span><span class="n">size</span><span class="p">(</span><span class="n">wvl</span><span class="p">),</span><span class="n">size</span><span class="p">(</span><span class="n">flux</span><span class="p">)))</span>
    <span class="n">A</span> <span class="o">=</span> <span class="n">randn</span><span class="p">(</span><span class="n">nb_comp</span><span class="p">,</span><span class="n">size</span><span class="p">(</span><span class="n">flux</span><span class="p">))</span>

    <span class="n">imX</span> <span class="o">=</span> <span class="n">transport_plan_projections_field</span><span class="p">(</span><span class="n">PX</span><span class="p">,</span><span class="n">shap</span><span class="p">,</span><span class="n">supp</span><span class="p">,</span><span class="n">neighbors_graph</span><span class="p">,</span><span class="n">dist_neighbors</span><span class="p">,</span><span class="n">spectrums</span><span class="p">,</span><span class="n">A</span><span class="p">,</span><span class="n">flux</span><span class="p">,</span><span class="n">sig</span><span class="p">,</span><span class="n">ker</span><span class="p">,</span><span class="n">D</span><span class="p">)</span>
    <span class="n">PY</span> <span class="o">=</span> <span class="n">transport_plan_projections_field_transpose</span><span class="p">(</span><span class="n">imY</span><span class="p">,</span><span class="n">supp</span><span class="p">,</span><span class="n">neighbors_graph</span><span class="p">,</span><span class="n">dist_neighbors</span><span class="p">,</span><span class="n">spectrums</span><span class="p">,</span><span class="n">A</span><span class="p">,</span><span class="n">flux</span><span class="p">,</span><span class="n">sig</span><span class="p">,</span><span class="n">ker_rot</span><span class="p">,</span><span class="n">D</span><span class="p">)</span>

    <span class="n">a1</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">imX</span><span class="o">*</span><span class="n">imY</span><span class="p">)</span>
    <span class="n">a2</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">PX</span><span class="o">*</span><span class="n">PY</span><span class="p">)</span>
    <span class="nb">print</span> <span class="n">a1</span><span class="p">,</span><span class="n">a2</span>
    <span class="n">check</span> <span class="o">=</span> <span class="mi">100</span><span class="o">*</span><span class="nb">abs</span><span class="p">(</span><span class="n">a1</span><span class="o">-</span><span class="n">a2</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">norm</span><span class="p">(</span><span class="n">imY</span><span class="p">)</span><span class="o">*</span><span class="n">norm</span><span class="p">(</span><span class="n">PY</span><span class="p">))</span>
    <span class="nb">print</span> <span class="s2">&quot;Transposition accuracy: &quot;</span><span class="p">,</span><span class="mi">100</span> <span class="o">-</span> <span class="n">check</span><span class="p">,</span><span class="s2">&quot;%&quot;</span>
    <span class="k">return</span> <span class="kc">None</span>

<span class="k">def</span> <span class="nf">transpose_field_check_coeff</span><span class="p">(</span><span class="n">shap</span><span class="p">,</span><span class="n">nb_comp</span><span class="p">,</span><span class="n">wvl</span><span class="p">,</span><span class="n">flux</span><span class="p">,</span><span class="n">sig</span><span class="p">,</span><span class="n">ker</span><span class="p">,</span><span class="n">ker_rot</span><span class="p">,</span><span class="n">D</span><span class="p">,</span><span class="n">sig_supp</span><span class="o">=</span><span class="mf">3.</span><span class="p">):</span>
    <span class="kn">from</span> <span class="nn">utils</span> <span class="k">import</span> <span class="n">diagonally_dominated_mat_stack</span>
    <span class="kn">from</span> <span class="nn">numpy.linalg</span> <span class="k">import</span> <span class="n">norm</span>

    <span class="n">AX</span> <span class="o">=</span> <span class="n">randn</span><span class="p">(</span><span class="n">nb_comp</span><span class="p">,</span><span class="n">size</span><span class="p">(</span><span class="n">flux</span><span class="p">))</span>
    <span class="n">P</span> <span class="o">=</span> <span class="n">diagonally_dominated_mat_stack</span><span class="p">(</span><span class="n">shap</span><span class="p">,</span><span class="n">nb_comp</span><span class="p">,</span><span class="n">sig</span><span class="o">=</span><span class="n">sig_supp</span><span class="p">,</span><span class="n">thresh_en</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">nb_im</span> <span class="o">=</span> <span class="n">size</span><span class="p">(</span><span class="n">flux</span><span class="p">)</span>
    <span class="n">imY</span> <span class="o">=</span> <span class="n">randn</span><span class="p">(</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="n">D</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="n">D</span><span class="p">,</span><span class="n">nb_im</span><span class="p">)</span>
    <span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span> <span class="o">=</span> <span class="n">where</span><span class="p">(</span><span class="n">P</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">P</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">randn</span><span class="p">(</span><span class="n">size</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>
    <span class="n">i</span><span class="p">,</span><span class="n">j</span> <span class="o">=</span> <span class="n">where</span><span class="p">(</span><span class="n">P</span><span class="p">[:,:,</span><span class="mi">0</span><span class="p">]</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">supp</span> <span class="o">=</span> <span class="n">transpose</span><span class="p">(</span><span class="n">array</span><span class="p">([</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]))</span>
    <span class="n">t</span> <span class="o">=</span> <span class="p">(</span><span class="n">wvl</span><span class="o">-</span><span class="n">wvl</span><span class="o">.</span><span class="n">min</span><span class="p">())</span><span class="o">/</span><span class="p">(</span><span class="n">wvl</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">-</span><span class="n">wvl</span><span class="o">.</span><span class="n">min</span><span class="p">())</span>
    <span class="n">neighbors_graph</span><span class="p">,</span><span class="n">dist_neighbors</span><span class="p">,</span><span class="n">cent</span><span class="p">,</span><span class="n">coord_map</span><span class="p">,</span><span class="n">knn</span> <span class="o">=</span> <span class="n">full_displacement</span><span class="p">(</span><span class="n">shap</span><span class="p">,</span><span class="n">supp</span><span class="p">,</span><span class="n">t</span><span class="p">,</span>\
    <span class="n">pol_en</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">cent</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">theta_param</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">pol_mod</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">coord_map</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">knn</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
    <span class="n">spectrums</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">randn</span><span class="p">(</span><span class="n">size</span><span class="p">(</span><span class="n">wvl</span><span class="p">),</span><span class="n">size</span><span class="p">(</span><span class="n">flux</span><span class="p">)))</span>

    <span class="n">AY</span> <span class="o">=</span> <span class="n">transport_plan_projections_field_coeff_transpose</span><span class="p">(</span><span class="n">imY</span><span class="p">,</span><span class="n">supp</span><span class="p">,</span><span class="n">neighbors_graph</span><span class="p">,</span><span class="n">dist_neighbors</span><span class="p">,</span><span class="n">spectrums</span><span class="p">,</span><span class="n">P</span><span class="p">,</span><span class="n">flux</span><span class="p">,</span><span class="n">sig</span><span class="p">,</span><span class="n">ker_rot</span><span class="p">,</span><span class="n">D</span><span class="p">)</span>
    <span class="n">imX</span> <span class="o">=</span> <span class="n">transport_plan_projections_field</span><span class="p">(</span><span class="n">P</span><span class="p">,</span><span class="n">shap</span><span class="p">,</span><span class="n">supp</span><span class="p">,</span><span class="n">neighbors_graph</span><span class="p">,</span><span class="n">dist_neighbors</span><span class="p">,</span><span class="n">spectrums</span><span class="p">,</span><span class="n">AX</span><span class="p">,</span><span class="n">flux</span><span class="p">,</span><span class="n">sig</span><span class="p">,</span><span class="n">ker</span><span class="p">,</span><span class="n">D</span><span class="p">)</span>

    <span class="n">a1</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">imX</span><span class="o">*</span><span class="n">imY</span><span class="p">)</span>
    <span class="n">a2</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">AX</span><span class="o">*</span><span class="n">AY</span><span class="p">)</span>
    <span class="nb">print</span> <span class="n">a1</span><span class="p">,</span><span class="n">a2</span>
    <span class="n">check</span> <span class="o">=</span> <span class="mi">100</span><span class="o">*</span><span class="nb">abs</span><span class="p">(</span><span class="n">a1</span><span class="o">-</span><span class="n">a2</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">norm</span><span class="p">(</span><span class="n">imY</span><span class="p">)</span><span class="o">*</span><span class="n">norm</span><span class="p">(</span><span class="n">AY</span><span class="p">))</span>
    <span class="nb">print</span> <span class="s2">&quot;Transposition accuracy: &quot;</span><span class="p">,</span><span class="mi">100</span> <span class="o">-</span> <span class="n">check</span><span class="p">,</span><span class="s2">&quot;%&quot;</span>
    <span class="k">return</span> <span class="kc">None</span>




<span class="k">def</span> <span class="nf">wavelengths_separation_init</span><span class="p">(</span><span class="n">obs_psf</span><span class="p">,</span><span class="n">wavelengths</span><span class="p">,</span><span class="n">spectrum</span><span class="p">,</span><span class="n">supp_rad</span><span class="p">,</span><span class="n">thresh_en</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">coord_map</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">pol_en</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">cent</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">theta_param</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">pol_mod</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">knn</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">nsig</span><span class="o">=</span><span class="mf">3.</span><span class="p">,</span><span class="n">sig</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">radial_cons</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">tol_deg</span><span class="o">=</span><span class="mf">15.</span><span class="p">,</span><span class="n">opt_space</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">opt_wvlth</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
    <span class="kn">from</span> <span class="nn">isap</span> <span class="k">import</span> <span class="n">mr_trans_1d</span><span class="p">,</span><span class="n">mr_trans_2</span>
    <span class="kn">from</span> <span class="nn">utils</span> <span class="k">import</span> <span class="n">diagonally_dominated_mat</span><span class="p">,</span><span class="n">im_gauss_nois_est</span><span class="p">,</span><span class="n">radial_support</span>
    <span class="kn">from</span> <span class="nn">numpy</span> <span class="k">import</span> <span class="n">sqrt</span><span class="p">,</span><span class="n">newaxis</span>
    <span class="n">nb_bands</span> <span class="o">=</span> <span class="n">size</span><span class="p">(</span><span class="n">spectrum</span><span class="p">)</span>
    <span class="n">shap</span> <span class="o">=</span> <span class="n">obs_psf</span><span class="o">.</span><span class="n">shape</span>
    <span class="nb">print</span> <span class="s2">&quot;Initializing the transport plan...&quot;</span>
    <span class="n">Px</span> <span class="o">=</span> <span class="n">diagonally_dominated_mat</span><span class="p">(</span><span class="n">shap</span><span class="p">,</span><span class="n">sig</span><span class="o">=</span><span class="n">supp_rad</span><span class="p">,</span><span class="n">thresh_en</span><span class="o">=</span><span class="n">thresh_en</span><span class="p">,</span><span class="n">coord_map</span><span class="o">=</span><span class="n">coord_map</span><span class="p">,</span><span class="n">pol_en</span><span class="o">=</span><span class="n">pol_en</span><span class="p">,</span><span class="n">cent</span><span class="o">=</span><span class="n">cent</span><span class="p">,</span><span class="n">theta_param</span><span class="o">=</span><span class="n">theta_param</span><span class="p">,</span><span class="n">pol_mod</span><span class="o">=</span><span class="n">pol_mod</span><span class="p">)</span>
    <span class="n">Px</span> <span class="o">=</span> <span class="n">radial_support</span><span class="p">(</span><span class="n">Px</span><span class="p">,</span><span class="n">shap</span><span class="p">,</span><span class="n">cent</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">tol_deg</span><span class="o">=</span><span class="mf">10.</span><span class="p">,</span><span class="n">coord_map</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
    <span class="nb">print</span> <span class="s2">&quot;Done.&quot;</span>
    <span class="n">t</span> <span class="o">=</span> <span class="p">(</span><span class="n">wavelengths</span><span class="o">-</span><span class="n">wavelengths</span><span class="o">.</span><span class="n">min</span><span class="p">())</span><span class="o">/</span><span class="p">(</span><span class="n">wavelengths</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">-</span><span class="n">wavelengths</span><span class="o">.</span><span class="n">min</span><span class="p">())</span>
    <span class="n">supp</span> <span class="o">=</span> <span class="n">transpose</span><span class="p">(</span><span class="n">array</span><span class="p">(</span><span class="n">where</span><span class="p">(</span><span class="n">Px</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">)))</span>
    <span class="nb">print</span> <span class="s2">&quot;Creating the displacement architecture...&quot;</span>
    <span class="n">neighbors_graph</span><span class="p">,</span><span class="n">weights_neighbors</span><span class="p">,</span><span class="n">cent</span><span class="p">,</span><span class="n">coord_map</span><span class="p">,</span><span class="n">knn</span> <span class="o">=</span> <span class="n">full_displacement</span><span class="p">(</span><span class="n">shap</span><span class="p">,</span><span class="n">supp</span><span class="p">,</span><span class="n">t</span><span class="p">,</span><span class="n">pol_en</span><span class="o">=</span><span class="n">pol_en</span><span class="p">,</span><span class="n">cent</span><span class="o">=</span><span class="n">cent</span><span class="p">,</span><span class="n">theta_param</span><span class="o">=</span><span class="n">theta_param</span><span class="p">,</span><span class="n">pol_mod</span><span class="o">=</span><span class="n">pol_mod</span><span class="p">,</span><span class="n">coord_map</span><span class="o">=</span><span class="n">coord_map</span><span class="p">,</span><span class="n">knn</span><span class="o">=</span><span class="n">knn</span><span class="p">)</span>
    <span class="nb">print</span> <span class="s2">&quot;Done.&quot;</span>
    <span class="nb">print</span> <span class="s2">&quot;Noise map setting...&quot;</span>
    <span class="c1"># Transport plan space noise</span>
    <span class="k">if</span> <span class="n">sig</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">sig</span><span class="p">,</span><span class="n">filt</span> <span class="o">=</span> <span class="n">im_gauss_nois_est</span><span class="p">(</span><span class="n">obs_psf</span><span class="p">)</span>
    <span class="n">noise_map</span> <span class="o">=</span> <span class="n">transport_plan_noise_map</span><span class="p">(</span><span class="n">spectrum</span><span class="p">,</span><span class="n">supp</span><span class="p">,</span><span class="n">neighbors_graph</span><span class="p">,</span><span class="n">weights_neighbors</span><span class="p">,</span><span class="n">shap</span><span class="p">)</span><span class="o">*</span><span class="n">sig</span>

    <span class="c1"># Spectral direction noise</span>
    <span class="n">spec_coeff_wav</span><span class="p">,</span><span class="n">info_file</span> <span class="o">=</span> <span class="n">isap</span><span class="o">.</span><span class="n">mr_trans_1d</span><span class="p">(</span><span class="n">spectrum</span><span class="p">,</span><span class="n">opt</span><span class="o">=</span><span class="n">opt_wvlth</span><span class="p">,</span><span class="n">path</span><span class="o">=</span><span class="s1">&#39;../data/&#39;</span><span class="p">,</span><span class="n">save_info_en</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">spec_coeff_dct</span> <span class="o">=</span> <span class="n">dct</span><span class="p">(</span><span class="n">spectrum</span><span class="p">,</span><span class="n">norm</span><span class="o">=</span><span class="s1">&#39;ortho&#39;</span><span class="p">)</span>

    <span class="n">weights_spec</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">nb_bands</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span>
    <span class="n">weights_spec</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">sig</span><span class="o">*</span><span class="nb">abs</span><span class="p">(</span><span class="n">spec_coeff_wav</span><span class="p">)</span>
    <span class="n">weights_spec</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">sig</span><span class="o">*</span><span class="nb">abs</span><span class="p">(</span><span class="n">spec_coeff_dct</span><span class="p">)</span>

    <span class="c1"># Spatial noise</span>
    <span class="n">output</span><span class="p">,</span><span class="n">filters</span> <span class="o">=</span> <span class="n">isap</span><span class="o">.</span><span class="n">mr_trans_2</span><span class="p">(</span><span class="n">obs_psf</span><span class="p">,</span><span class="n">filters</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">opt</span><span class="o">=</span><span class="n">opt_space</span><span class="p">)</span>
    <span class="n">weights_space</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">obs_psf</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">obs_psf</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">filters</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>
    <span class="n">ones_mat</span> <span class="o">=</span> <span class="n">ones</span><span class="p">(</span><span class="n">obs_psf</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">filters</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
        <span class="n">weights_space</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">sig</span><span class="o">*</span><span class="n">sqrt</span><span class="p">(</span><span class="n">scisig</span><span class="o">.</span><span class="n">fftconvolve</span><span class="p">(</span><span class="n">ones_mat</span><span class="p">,</span><span class="n">filters</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span><span class="n">mode</span><span class="o">=</span><span class="s1">&#39;same&#39;</span><span class="p">))</span> <span class="c1"># account for the sed while thresholding!</span>
    <span class="nb">print</span> <span class="s2">&quot;Done.&quot;</span>


    <span class="k">return</span> <span class="n">Px</span><span class="p">,</span><span class="n">supp</span><span class="p">,</span><span class="n">neighbors_graph</span><span class="p">,</span><span class="n">weights_neighbors</span><span class="p">,</span><span class="n">t</span><span class="p">,</span><span class="n">noise_map</span><span class="p">,</span><span class="n">coord_map</span><span class="p">,</span><span class="n">knn</span><span class="p">,</span><span class="n">weights_spec</span><span class="p">,</span><span class="n">weights_space</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="n">newaxis</span><span class="p">]</span><span class="o">*</span><span class="nb">abs</span><span class="p">(</span><span class="n">spectrum</span><span class="p">[</span><span class="n">newaxis</span><span class="p">,</span><span class="o">...</span><span class="p">]),</span><span class="n">filters</span><span class="p">[:,:,:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span><span class="n">info_file</span>

<span class="c1">#def displacement_times_cost(obs_psf,spectrum)</span>
<span class="k">def</span> <span class="nf">spectral_weights</span><span class="p">(</span><span class="n">siz</span><span class="p">,</span><span class="n">nb_bands</span><span class="p">,</span><span class="n">fwhm</span><span class="p">,</span><span class="n">thresh_vect_dct</span><span class="p">,</span><span class="n">thresh_vect_wav</span><span class="p">,</span><span class="n">cent</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">k</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
    <span class="kn">from</span> <span class="nn">numpy.linalg</span> <span class="k">import</span> <span class="n">norm</span>
    <span class="kn">from</span> <span class="nn">numpy</span> <span class="k">import</span> <span class="n">exp</span><span class="p">,</span><span class="n">newaxis</span>
    <span class="k">if</span> <span class="n">cent</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">cent</span> <span class="o">=</span> <span class="n">array</span><span class="p">(</span><span class="n">siz</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span>
    <span class="n">ones_col</span> <span class="o">=</span> <span class="n">ones</span><span class="p">((</span><span class="n">siz</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="mi">1</span><span class="p">))</span>
    <span class="n">ones_line</span> <span class="o">=</span> <span class="n">ones</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span><span class="n">siz</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
    <span class="n">arange_line</span> <span class="o">=</span> <span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">siz</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span><span class="n">siz</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
    <span class="n">arange_col</span> <span class="o">=</span> <span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">siz</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">siz</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="mi">1</span><span class="p">))</span>
    <span class="n">i_coord</span> <span class="o">=</span> <span class="n">arange_col</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">ones_line</span><span class="p">)</span>
    <span class="n">j_coord</span> <span class="o">=</span> <span class="n">ones_col</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">arange_line</span><span class="p">)</span>

    <span class="n">coord</span> <span class="o">=</span> <span class="n">concatenate</span><span class="p">((</span><span class="n">i_coord</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span><span class="n">prod</span><span class="p">(</span><span class="n">siz</span><span class="p">))),</span><span class="n">j_coord</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span><span class="n">prod</span><span class="p">(</span><span class="n">siz</span><span class="p">)))),</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="n">cent</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">)))</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">ones</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span><span class="n">prod</span><span class="p">(</span><span class="n">siz</span><span class="p">))))</span>
    <span class="n">dist_mat</span> <span class="o">=</span> <span class="n">norm</span><span class="p">(</span><span class="n">coord</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">siz</span><span class="p">)</span>

    <span class="n">smooth_comp_weight</span> <span class="o">=</span> <span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">dist_mat</span><span class="o">/</span><span class="n">k</span><span class="o">*</span><span class="n">fwhm</span><span class="p">)</span>
    <span class="n">smooth_comp_weight</span><span class="o">/=</span> <span class="n">smooth_comp_weight</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>

    <span class="n">osci_comp_weight</span> <span class="o">=</span> <span class="mi">1</span><span class="o">-</span><span class="n">smooth_comp_weight</span>


    <span class="k">return</span> <span class="n">smooth_comp_weight</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="n">newaxis</span><span class="p">]</span><span class="o">*</span><span class="n">thresh_vect_wav</span><span class="p">[</span><span class="n">newaxis</span><span class="p">,</span><span class="o">...</span><span class="p">],</span><span class="n">osci_comp_weight</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="n">newaxis</span><span class="p">]</span><span class="o">*</span><span class="n">thresh_vect_dct</span><span class="p">[</span><span class="n">newaxis</span><span class="p">,</span><span class="o">...</span><span class="p">]</span>


<span class="k">def</span> <span class="nf">wavelengths_separation_gradient</span><span class="p">(</span><span class="n">obs</span><span class="p">,</span><span class="n">Px</span><span class="p">,</span><span class="n">shap</span><span class="p">,</span><span class="n">supp</span><span class="p">,</span><span class="n">neighbors_graph</span><span class="p">,</span><span class="n">ind_i</span><span class="p">,</span><span class="n">dist_neighbors</span><span class="p">,</span><span class="n">spectrum</span><span class="p">):</span>

    <span class="n">err</span> <span class="o">=</span> <span class="n">obs</span> <span class="o">-</span> <span class="n">transport_plan_projections</span><span class="p">(</span><span class="n">Px</span><span class="p">,</span><span class="n">shap</span><span class="p">,</span><span class="n">supp</span><span class="p">[</span><span class="n">ind_i</span><span class="p">,:],</span><span class="n">neighbors_graph</span><span class="p">[</span><span class="n">ind_i</span><span class="p">,:,:,:],</span><span class="n">dist_neighbors</span><span class="p">[</span><span class="n">ind_i</span><span class="p">,:,:],</span><span class="n">spectrum</span><span class="o">=</span><span class="n">spectrum</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">grad</span> <span class="o">=</span> <span class="o">-</span><span class="n">transport_plan_projections_transpose</span><span class="p">(</span><span class="n">err</span><span class="p">,</span><span class="n">supp</span><span class="p">[</span><span class="n">ind_i</span><span class="p">,:],</span><span class="n">neighbors_graph</span><span class="p">[</span><span class="n">ind_i</span><span class="p">,:,:,:],</span><span class="n">dist_neighbors</span><span class="p">[</span><span class="n">ind_i</span><span class="p">,:,:],</span><span class="n">spectrum</span><span class="o">=</span><span class="n">spectrum</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">grad</span><span class="p">,</span><span class="n">err</span>

<span class="k">def</span> <span class="nf">prox_pos</span><span class="p">(</span><span class="n">Px</span><span class="p">,</span><span class="n">mass</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">simplex_en</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>

    <span class="kn">from</span> <span class="nn">optim_utils</span> <span class="k">import</span> <span class="n">pos_proj_mat</span>
    <span class="kn">from</span> <span class="nn">simplex_projection</span> <span class="k">import</span> <span class="n">euclidean_proj_simplex</span>

    <span class="k">if</span> <span class="n">simplex_en</span><span class="p">:</span>
        <span class="n">Pout</span> <span class="o">=</span> <span class="n">euclidean_proj_simplex</span><span class="p">(</span><span class="n">Px</span><span class="p">,</span><span class="n">s</span><span class="o">=</span><span class="n">mass</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">Pout</span> <span class="o">=</span> <span class="n">pos_proj_mat</span><span class="p">(</span><span class="n">Px</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">Pout</span>

<div class="viewcode-block" id="columns_wise_simplex_proj"><a class="viewcode-back" href="../psf_learning_utils.html#psf_learning_utils.columns_wise_simplex_proj">[docs]</a><span class="k">def</span> <span class="nf">columns_wise_simplex_proj</span><span class="p">(</span><span class="n">mat</span><span class="p">,</span><span class="n">mass</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Projects each column of input matrix onto simplex.</span>
<span class="sd">    </span>
<span class="sd">    Calls:</span>
<span class="sd">    </span>
<span class="sd">    * simplex_projection.euclidean_proj_simplex</span>
<span class="sd">    </span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="kn">from</span> <span class="nn">simplex_projection</span> <span class="k">import</span> <span class="n">euclidean_proj_simplex</span>
    <span class="n">nb_columns</span> <span class="o">=</span> <span class="n">mat</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">mat_out</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">(</span><span class="n">mat</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">mass</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">mass</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,((</span><span class="n">mat</span><span class="o">*</span><span class="p">(</span><span class="n">mat</span><span class="o">&gt;=</span><span class="mi">0</span><span class="p">))</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span>
    <span class="k">if</span> <span class="n">mass</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_columns</span><span class="p">):</span>
            <span class="n">mat_out</span><span class="p">[:,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">euclidean_proj_simplex</span><span class="p">(</span><span class="n">mat</span><span class="p">[:,</span><span class="n">i</span><span class="p">],</span><span class="n">s</span><span class="o">=</span><span class="n">mass</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">mat_out</span></div>

<span class="k">def</span> <span class="nf">prox_pos_dual_stack</span><span class="p">(</span><span class="n">Px_stack</span><span class="p">,</span><span class="n">ind_i</span><span class="p">,</span><span class="n">mass</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">simplex_en</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="n">Px_stack_out</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">(</span><span class="n">Px_stack</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">size</span><span class="p">(</span><span class="n">ind_i</span><span class="p">)):</span>
        <span class="n">Px_stack_out</span><span class="p">[:,:,</span><span class="n">ind_i</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">=</span> <span class="n">Px_stack</span><span class="p">[:,:,</span><span class="n">ind_i</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">-</span> <span class="n">sigma</span><span class="o">*</span><span class="n">prox_pos</span><span class="p">(</span><span class="n">Px_stack</span><span class="p">[:,:,</span><span class="n">ind_i</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span><span class="o">/</span><span class="n">sigma</span><span class="p">,</span><span class="n">mass</span><span class="o">=</span><span class="n">mass</span><span class="p">,</span><span class="n">simplex_en</span><span class="o">=</span><span class="n">simplex_en</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">Px_stack_out</span>


<span class="k">def</span> <span class="nf">prox_sparsity</span><span class="p">(</span><span class="n">P</span><span class="p">,</span><span class="n">stack_wav</span><span class="p">,</span><span class="n">stack_dct</span><span class="p">,</span><span class="n">stack_spec_wav</span><span class="p">,</span><span class="n">mono_direct_weights</span><span class="p">,</span><span class="n">space_weights</span><span class="p">,</span><span class="n">dct_weights</span><span class="p">,</span><span class="n">spec_wav_weights</span><span class="p">,</span><span class="n">sigma</span><span class="p">,</span><span class="n">thresh_type</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>

    <span class="n">P_thresh</span> <span class="o">=</span> <span class="n">P</span><span class="o">-</span><span class="n">sigma</span><span class="o">*</span><span class="n">utils</span><span class="o">.</span><span class="n">thresholding</span><span class="p">(</span><span class="n">P</span><span class="o">/</span><span class="n">sigma</span><span class="p">,</span><span class="n">mono_direct_weights</span><span class="o">/</span><span class="n">sigma</span><span class="p">,</span><span class="n">thresh_type</span><span class="p">)</span>
    <span class="n">stack_wav_thresh</span> <span class="o">=</span> <span class="n">stack_wav</span><span class="o">*</span><span class="mi">0</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">stack_wav</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]):</span>
        <span class="n">stack_wav_thresh</span><span class="p">[:,:,:,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">stack_wav</span><span class="p">[:,:,:,</span><span class="n">i</span><span class="p">]</span><span class="o">-</span><span class="n">sigma</span><span class="o">*</span><span class="n">utils</span><span class="o">.</span><span class="n">thresholding_3D</span><span class="p">(</span><span class="n">stack_wav</span><span class="p">[:,:,:,</span><span class="n">i</span><span class="p">]</span><span class="o">/</span><span class="n">sigma</span><span class="p">,</span><span class="n">space_weights</span><span class="p">[:,:,:,</span><span class="n">i</span><span class="p">]</span><span class="o">/</span><span class="n">sigma</span><span class="p">,</span><span class="n">thresh_type</span><span class="p">)</span>
    <span class="n">stack_dct_thresh</span> <span class="o">=</span> <span class="n">stack_dct</span><span class="o">-</span><span class="n">sigma</span><span class="o">*</span><span class="n">utils</span><span class="o">.</span><span class="n">thresholding_3D</span><span class="p">(</span><span class="n">stack_dct</span><span class="o">/</span><span class="n">sigma</span><span class="p">,</span><span class="n">dct_weights</span><span class="o">/</span><span class="n">sigma</span><span class="p">,</span><span class="n">thresh_type</span><span class="p">)</span>
    <span class="n">stack_spec_wav_thresh</span> <span class="o">=</span> <span class="n">stack_spec_wav</span><span class="o">-</span><span class="n">sigma</span><span class="o">*</span><span class="n">utils</span><span class="o">.</span><span class="n">thresholding_3D</span><span class="p">(</span><span class="n">stack_spec_wav</span><span class="o">/</span><span class="n">sigma</span><span class="p">,</span><span class="n">spec_wav_weights</span><span class="o">/</span><span class="n">sigma</span><span class="p">,</span><span class="n">thresh_type</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">P_thresh</span><span class="p">,</span><span class="n">stack_wav_thresh</span><span class="p">,</span><span class="n">stack_dct_thresh</span><span class="p">,</span><span class="n">stack_spec_wav_thresh</span>

<span class="k">def</span> <span class="nf">prox_sparsity_2</span><span class="p">(</span><span class="n">stack_wav</span><span class="p">,</span><span class="n">stack_dct</span><span class="p">,</span><span class="n">stack_spec_wav</span><span class="p">,</span><span class="n">space_weights</span><span class="p">,</span><span class="n">dct_weights</span><span class="p">,</span><span class="n">spec_wav_weights</span><span class="p">,</span><span class="n">sigma</span><span class="p">,</span><span class="n">thresh_type</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>

    <span class="n">stack_wav_thresh</span> <span class="o">=</span> <span class="n">stack_wav</span><span class="o">*</span><span class="mi">0</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">stack_wav</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]):</span>
        <span class="n">stack_wav_thresh</span><span class="p">[:,:,:,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">thresholding_3D</span><span class="p">(</span><span class="n">stack_wav</span><span class="p">[:,:,:,</span><span class="n">i</span><span class="p">],</span><span class="n">space_weights</span><span class="p">[:,:,:,</span><span class="n">i</span><span class="p">]</span><span class="o">*</span><span class="n">sigma</span><span class="p">,</span><span class="n">thresh_type</span><span class="p">)</span>
    <span class="n">stack_dct_thresh</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">thresholding_3D</span><span class="p">(</span><span class="n">stack_dct</span><span class="p">,</span><span class="n">dct_weights</span><span class="o">*</span><span class="n">sigma</span><span class="p">,</span><span class="n">thresh_type</span><span class="p">)</span>
    <span class="n">stack_spec_wav_thresh</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">thresholding_3D</span><span class="p">(</span><span class="n">stack_spec_wav</span><span class="p">,</span><span class="n">spec_wav_weights</span><span class="o">*</span><span class="n">sigma</span><span class="p">,</span><span class="n">thresh_type</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">stack_wav_thresh</span><span class="p">,</span><span class="n">stack_dct_thresh</span><span class="p">,</span><span class="n">stack_spec_wav_thresh</span>


<span class="k">def</span> <span class="nf">analysis_op</span><span class="p">(</span><span class="n">Px</span><span class="p">,</span><span class="n">filters</span><span class="p">,</span><span class="n">opt_wvlth</span><span class="p">,</span><span class="n">shap</span><span class="p">,</span><span class="n">supp</span><span class="p">,</span><span class="n">neighbors_graph</span><span class="p">,</span><span class="n">ind_i</span><span class="p">,</span><span class="n">dist_neighbors</span><span class="p">,</span><span class="n">spectrum</span><span class="p">,</span><span class="n">nb_comp</span> <span class="o">=</span> <span class="mi">50</span><span class="p">):</span>
    <span class="kn">from</span> <span class="nn">numpy.linalg</span> <span class="k">import</span> <span class="n">svd</span>

    <span class="n">mono_chrom</span> <span class="o">=</span> <span class="n">transport_plan_projections</span><span class="p">(</span><span class="n">Px</span><span class="p">,</span><span class="n">shap</span><span class="p">,</span><span class="n">supp</span><span class="p">[</span><span class="n">ind_i</span><span class="p">,:],</span><span class="n">neighbors_graph</span><span class="p">[</span><span class="n">ind_i</span><span class="p">,:,:,:],</span><span class="n">dist_neighbors</span><span class="p">[</span><span class="n">ind_i</span><span class="p">,:,:],</span><span class="n">spectrum</span><span class="o">=</span><span class="n">spectrum</span><span class="p">)</span>

    <span class="c1"># Spatial wavelet coeff</span>
    <span class="n">shap1</span> <span class="o">=</span> <span class="n">mono_chrom</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">shap2</span> <span class="o">=</span> <span class="n">filters</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">wavelets_coeff</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">shap1</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">shap1</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">shap2</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">shap1</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap1</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
        <span class="n">temp</span><span class="p">,</span><span class="n">filters</span> <span class="o">=</span> <span class="n">isap</span><span class="o">.</span><span class="n">mr_trans_2</span><span class="p">(</span><span class="n">mono_chrom</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">],</span><span class="n">filters</span><span class="o">=</span><span class="n">filters</span><span class="p">)</span>
        <span class="n">wavelets_coeff</span><span class="p">[:,:,:,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">temp</span>

    <span class="n">spec_mono_chrom</span> <span class="o">=</span> <span class="n">mono_chrom</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">prod</span><span class="p">(</span><span class="n">shap1</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">]),</span><span class="n">shap1</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>
    <span class="n">U</span><span class="p">,</span><span class="n">s</span><span class="p">,</span><span class="n">V</span> <span class="o">=</span> <span class="n">svd</span><span class="p">(</span><span class="n">spec_mono_chrom</span><span class="p">,</span> <span class="n">full_matrices</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">U</span> <span class="o">=</span> <span class="n">U</span><span class="p">[:,</span><span class="mi">0</span><span class="p">:</span><span class="n">nb_comp</span><span class="p">]</span>
    <span class="n">s</span> <span class="o">=</span> <span class="n">s</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">nb_comp</span><span class="p">]</span>
    <span class="n">V</span> <span class="o">=</span> <span class="n">V</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">nb_comp</span><span class="p">,:]</span>

    <span class="c1"># Spectral DCT coeff</span>
    <span class="n">spec_coeff_dct_V</span> <span class="o">=</span> <span class="n">dct</span><span class="p">(</span><span class="n">V</span><span class="p">,</span><span class="n">norm</span><span class="o">=</span><span class="s1">&#39;ortho&#39;</span><span class="p">)</span>
    <span class="n">spec_coeff_dct</span> <span class="o">=</span> <span class="n">U</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">diag</span><span class="p">(</span><span class="n">s</span><span class="p">)</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">spec_coeff_dct_V</span><span class="p">))</span>

    <span class="c1"># Wavelets coeff</span>
    <span class="n">spec_coeff_wav_V</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">nb_comp</span><span class="p">,</span><span class="n">shap1</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_comp</span><span class="p">):</span>
        <span class="n">spec_coeff_wav_V</span><span class="p">[</span><span class="n">i</span><span class="p">,:],</span><span class="n">info_file</span> <span class="o">=</span> <span class="n">isap</span><span class="o">.</span><span class="n">mr_trans_1d</span><span class="p">(</span><span class="n">V</span><span class="p">[</span><span class="n">i</span><span class="p">,:],</span><span class="n">opt</span><span class="o">=</span><span class="n">opt_wvlth</span><span class="p">,</span><span class="n">path</span><span class="o">=</span><span class="s1">&#39;../data/&#39;</span><span class="p">,</span><span class="n">save_info_en</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">spec_coeff_wav</span> <span class="o">=</span> <span class="n">U</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">diag</span><span class="p">(</span><span class="n">s</span><span class="p">)</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">spec_coeff_wav_V</span><span class="p">))</span>

    <span class="k">return</span>


<span class="k">def</span> <span class="nf">analysis_op_2</span><span class="p">(</span><span class="n">mono_chrom</span><span class="p">,</span><span class="n">filters</span><span class="p">,</span><span class="n">opt_wvlth</span><span class="p">,</span><span class="n">shap</span><span class="p">,</span><span class="n">spectrum</span><span class="p">,</span><span class="n">nb_comp</span> <span class="o">=</span> <span class="mi">50</span><span class="p">):</span>
    <span class="kn">from</span> <span class="nn">numpy.linalg</span> <span class="k">import</span> <span class="n">svd</span>

    <span class="c1"># Spatial wavelet coeff</span>
    <span class="n">shap1</span> <span class="o">=</span> <span class="n">mono_chrom</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">shap2</span> <span class="o">=</span> <span class="n">filters</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">wavelets_coeff</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">shap1</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">shap1</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">shap2</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">shap1</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap1</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
        <span class="n">temp</span><span class="p">,</span><span class="n">filters</span> <span class="o">=</span> <span class="n">isap</span><span class="o">.</span><span class="n">mr_trans_2</span><span class="p">(</span><span class="n">mono_chrom</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">],</span><span class="n">filters</span><span class="o">=</span><span class="n">filters</span><span class="p">)</span>
        <span class="n">wavelets_coeff</span><span class="p">[:,:,:,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">temp</span>

    <span class="n">spec_mono_chrom</span> <span class="o">=</span> <span class="n">mono_chrom</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">prod</span><span class="p">(</span><span class="n">shap1</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">]),</span><span class="n">shap1</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>
    <span class="n">U</span><span class="p">,</span><span class="n">s</span><span class="p">,</span><span class="n">V</span> <span class="o">=</span> <span class="n">svd</span><span class="p">(</span><span class="n">spec_mono_chrom</span><span class="p">,</span> <span class="n">full_matrices</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">U</span> <span class="o">=</span> <span class="n">U</span><span class="p">[:,</span><span class="mi">0</span><span class="p">:</span><span class="n">nb_comp</span><span class="p">]</span>
    <span class="n">s</span> <span class="o">=</span> <span class="n">s</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">nb_comp</span><span class="p">]</span>
    <span class="n">V</span> <span class="o">=</span> <span class="n">V</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">nb_comp</span><span class="p">,:]</span>

    <span class="c1"># Spectral DCT coeff</span>
    <span class="n">spec_coeff_dct_V</span> <span class="o">=</span> <span class="n">dct</span><span class="p">(</span><span class="n">V</span><span class="p">,</span><span class="n">norm</span><span class="o">=</span><span class="s1">&#39;ortho&#39;</span><span class="p">)</span>
    <span class="n">spec_coeff_dct</span> <span class="o">=</span> <span class="n">U</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">diag</span><span class="p">(</span><span class="n">s</span><span class="p">)</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">spec_coeff_dct_V</span><span class="p">))</span>

    <span class="c1"># Wavelets coeff</span>
    <span class="n">spec_coeff_wav_V</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">nb_comp</span><span class="p">,</span><span class="n">shap1</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_comp</span><span class="p">):</span>
        <span class="n">spec_coeff_wav_V</span><span class="p">[</span><span class="n">i</span><span class="p">,:],</span><span class="n">info_file</span> <span class="o">=</span> <span class="n">isap</span><span class="o">.</span><span class="n">mr_trans_1d</span><span class="p">(</span><span class="n">V</span><span class="p">[</span><span class="n">i</span><span class="p">,:],</span><span class="n">opt</span><span class="o">=</span><span class="n">opt_wvlth</span><span class="p">,</span><span class="n">path</span><span class="o">=</span><span class="s1">&#39;../data/&#39;</span><span class="p">,</span><span class="n">save_info_en</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">spec_coeff_wav</span> <span class="o">=</span> <span class="n">U</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">diag</span><span class="p">(</span><span class="n">s</span><span class="p">)</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">spec_coeff_wav_V</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">wavelets_coeff</span><span class="p">,</span><span class="n">spec_coeff_dct</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">shap1</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">shap1</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">size</span><span class="p">(</span><span class="n">spectrum</span><span class="p">))),</span><span class="n">spec_coeff_wav</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">shap1</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">shap1</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">size</span><span class="p">(</span><span class="n">spectrum</span><span class="p">)))</span>

<span class="k">def</span> <span class="nf">analysis_op_3</span><span class="p">(</span><span class="n">Px_stack</span><span class="p">,</span><span class="n">stack_coeff</span><span class="p">,</span><span class="n">filters</span><span class="p">,</span><span class="n">opt_wvlth</span><span class="p">,</span><span class="n">shap</span><span class="p">,</span><span class="n">supp</span><span class="p">,</span><span class="n">neighbors_graph</span><span class="p">,</span><span class="n">ind_i</span><span class="p">,</span><span class="n">dist_neighbors</span><span class="p">,</span><span class="n">nb_bands</span><span class="p">,</span><span class="n">nb_comp</span> <span class="o">=</span> <span class="mi">50</span><span class="p">):</span>
    <span class="kn">from</span> <span class="nn">numpy</span> <span class="k">import</span> <span class="n">multiply</span>

    <span class="n">Px</span> <span class="o">=</span> <span class="n">multiply</span><span class="p">(</span><span class="n">Px_stack</span><span class="p">,</span><span class="n">stack_coeff</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">analysis_op</span><span class="p">(</span><span class="n">Px</span><span class="p">,</span><span class="n">filters</span><span class="p">,</span><span class="n">opt_wvlth</span><span class="p">,</span><span class="n">shap</span><span class="p">,</span><span class="n">supp</span><span class="p">,</span><span class="n">neighbors_graph</span><span class="p">,</span><span class="n">ind_i</span><span class="p">,</span><span class="n">dist_neighbors</span><span class="p">,</span><span class="n">ones</span><span class="p">((</span><span class="n">nb_bands</span><span class="p">,)),</span><span class="n">nb_comp</span> <span class="o">=</span> <span class="mi">50</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">analysis_op_transpose</span><span class="p">(</span><span class="n">wavelets_coeff</span><span class="p">,</span><span class="n">spec_coeff_dct</span><span class="p">,</span><span class="n">spec_coeff_wav</span><span class="p">,</span><span class="n">filters_rot</span><span class="p">,</span><span class="n">info_filename</span><span class="p">,</span><span class="n">shap</span><span class="p">,</span><span class="n">supp</span><span class="p">,</span><span class="n">neighbors_graph</span><span class="p">,</span><span class="n">ind_i</span><span class="p">,</span><span class="n">dist_neighbors</span><span class="p">,</span><span class="n">spectrum</span><span class="p">,</span><span class="n">nb_comp</span> <span class="o">=</span> <span class="mi">50</span><span class="p">):</span>
    <span class="kn">from</span> <span class="nn">numpy.linalg</span> <span class="k">import</span> <span class="n">svd</span>

    <span class="n">shap1</span> <span class="o">=</span> <span class="n">wavelets_coeff</span><span class="o">.</span><span class="n">shape</span>
    <span class="c1"># Spatial wavelet transp</span>
    <span class="n">recons_stack</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">shap1</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap1</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]):</span>
        <span class="n">recons_stack</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">isap</span><span class="o">.</span><span class="n">mr_transf_transp</span><span class="p">(</span><span class="n">wavelets_coeff</span><span class="p">[:,:,:,</span><span class="n">i</span><span class="p">],</span><span class="n">filters_rot</span><span class="p">)</span>

    <span class="c1"># Spectral DCT coeff</span>
    <span class="n">U</span><span class="p">,</span><span class="n">s</span><span class="p">,</span><span class="n">V</span> <span class="o">=</span> <span class="n">svd</span><span class="p">(</span><span class="n">spec_coeff_dct</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">prod</span><span class="p">(</span><span class="n">shap</span><span class="p">),</span><span class="n">size</span><span class="p">(</span><span class="n">spectrum</span><span class="p">))),</span> <span class="n">full_matrices</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">U</span> <span class="o">=</span> <span class="n">U</span><span class="p">[:,</span><span class="mi">0</span><span class="p">:</span><span class="n">nb_comp</span><span class="p">]</span>
    <span class="n">s</span> <span class="o">=</span> <span class="n">s</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">nb_comp</span><span class="p">]</span>
    <span class="n">V</span> <span class="o">=</span> <span class="n">V</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">nb_comp</span><span class="p">,:]</span>

    <span class="n">spec_mono_chrom_dct_V</span> <span class="o">=</span> <span class="n">idct</span><span class="p">(</span><span class="n">V</span><span class="p">,</span><span class="n">norm</span><span class="o">=</span><span class="s1">&#39;ortho&#39;</span><span class="p">)</span>
    <span class="n">spec_mono_chrom_dct</span> <span class="o">=</span> <span class="n">U</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">diag</span><span class="p">(</span><span class="n">s</span><span class="p">)</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">spec_mono_chrom_dct_V</span><span class="p">))</span>
    <span class="n">mono_chrom_dct</span> <span class="o">=</span> <span class="n">spec_mono_chrom_dct</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">shap1</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>

    <span class="c1"># Wavelets coeff</span>
    <span class="n">U</span><span class="p">,</span><span class="n">s</span><span class="p">,</span><span class="n">V</span> <span class="o">=</span> <span class="n">svd</span><span class="p">(</span><span class="n">spec_coeff_wav</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">prod</span><span class="p">(</span><span class="n">shap</span><span class="p">),</span><span class="n">size</span><span class="p">(</span><span class="n">spectrum</span><span class="p">))),</span> <span class="n">full_matrices</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">U</span> <span class="o">=</span> <span class="n">U</span><span class="p">[:,</span><span class="mi">0</span><span class="p">:</span><span class="n">nb_comp</span><span class="p">]</span>
    <span class="n">s</span> <span class="o">=</span> <span class="n">s</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">nb_comp</span><span class="p">]</span>
    <span class="n">V</span> <span class="o">=</span> <span class="n">V</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">nb_comp</span><span class="p">,:]</span>

    <span class="n">spec_mono_chrom_wav_V</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">nb_comp</span><span class="p">,</span><span class="n">shap1</span><span class="p">[</span><span class="mi">3</span><span class="p">]))</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_comp</span><span class="p">):</span>
        <span class="n">spec_mono_chrom_wav_V</span><span class="p">[</span><span class="n">i</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">isap</span><span class="o">.</span><span class="n">mr_recons_1d</span><span class="p">(</span><span class="n">V</span><span class="p">[</span><span class="n">i</span><span class="p">,:],</span><span class="n">info_filename</span><span class="p">)</span>
    <span class="n">spec_mono_chrom_wav</span> <span class="o">=</span> <span class="n">U</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">diag</span><span class="p">(</span><span class="n">s</span><span class="p">)</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">spec_mono_chrom_wav_V</span><span class="p">))</span>
    <span class="n">mono_chrom_wav</span> <span class="o">=</span> <span class="n">spec_mono_chrom_wav</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">shap1</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>

    <span class="n">P</span> <span class="o">=</span> <span class="n">transport_plan_projections_transpose_2</span><span class="p">(</span><span class="n">recons_stack</span><span class="o">+</span><span class="n">mono_chrom_dct</span><span class="o">+</span><span class="n">mono_chrom_wav</span><span class="p">,</span><span class="n">supp</span><span class="p">[</span><span class="n">ind_i</span><span class="p">,:],</span><span class="n">neighbors_graph</span><span class="p">[</span><span class="n">ind_i</span><span class="p">,:,:,:],</span><span class="n">dist_neighbors</span><span class="p">[</span><span class="n">ind_i</span><span class="p">,:,:],</span><span class="n">spectrum</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">P</span>

<span class="k">def</span> <span class="nf">analysis_op_transpose_2</span><span class="p">(</span><span class="n">wavelets_coeff</span><span class="p">,</span><span class="n">spec_coeff_dct</span><span class="p">,</span><span class="n">spec_coeff_wav</span><span class="p">,</span><span class="n">filters_rot</span><span class="p">,</span><span class="n">info_filename</span><span class="p">,</span><span class="n">shap</span><span class="p">,</span><span class="n">spectrum</span><span class="p">,</span><span class="n">nb_comp</span> <span class="o">=</span> <span class="mi">50</span><span class="p">):</span>
    <span class="kn">from</span> <span class="nn">numpy.linalg</span> <span class="k">import</span> <span class="n">svd</span>

    <span class="n">shap1</span> <span class="o">=</span> <span class="n">wavelets_coeff</span><span class="o">.</span><span class="n">shape</span>
    <span class="c1"># Spatial wavelet transp</span>
    <span class="n">recons_stack</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">shap1</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap1</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]):</span>
        <span class="n">recons_stack</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">isap</span><span class="o">.</span><span class="n">mr_transf_transp</span><span class="p">(</span><span class="n">wavelets_coeff</span><span class="p">[:,:,:,</span><span class="n">i</span><span class="p">],</span><span class="n">filters_rot</span><span class="p">)</span>

    <span class="c1"># Spectral DCT coeff</span>
    <span class="n">U</span><span class="p">,</span><span class="n">s</span><span class="p">,</span><span class="n">V</span> <span class="o">=</span> <span class="n">svd</span><span class="p">(</span><span class="n">spec_coeff_dct</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">prod</span><span class="p">(</span><span class="n">shap</span><span class="p">),</span><span class="n">size</span><span class="p">(</span><span class="n">spectrum</span><span class="p">))),</span> <span class="n">full_matrices</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">U</span> <span class="o">=</span> <span class="n">U</span><span class="p">[:,</span><span class="mi">0</span><span class="p">:</span><span class="n">nb_comp</span><span class="p">]</span>
    <span class="n">s</span> <span class="o">=</span> <span class="n">s</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">nb_comp</span><span class="p">]</span>
    <span class="n">V</span> <span class="o">=</span> <span class="n">V</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">nb_comp</span><span class="p">,:]</span>

    <span class="n">spec_mono_chrom_dct_V</span> <span class="o">=</span> <span class="n">idct</span><span class="p">(</span><span class="n">V</span><span class="p">,</span><span class="n">norm</span><span class="o">=</span><span class="s1">&#39;ortho&#39;</span><span class="p">)</span>
    <span class="n">spec_mono_chrom_dct</span> <span class="o">=</span> <span class="n">U</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">diag</span><span class="p">(</span><span class="n">s</span><span class="p">)</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">spec_mono_chrom_dct_V</span><span class="p">))</span>
    <span class="n">mono_chrom_dct</span> <span class="o">=</span> <span class="n">spec_mono_chrom_dct</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">shap1</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>

    <span class="c1"># Wavelets coeff</span>
    <span class="n">U</span><span class="p">,</span><span class="n">s</span><span class="p">,</span><span class="n">V</span> <span class="o">=</span> <span class="n">svd</span><span class="p">(</span><span class="n">spec_coeff_wav</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">prod</span><span class="p">(</span><span class="n">shap</span><span class="p">),</span><span class="n">size</span><span class="p">(</span><span class="n">spectrum</span><span class="p">))),</span> <span class="n">full_matrices</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">U</span> <span class="o">=</span> <span class="n">U</span><span class="p">[:,</span><span class="mi">0</span><span class="p">:</span><span class="n">nb_comp</span><span class="p">]</span>
    <span class="n">s</span> <span class="o">=</span> <span class="n">s</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">nb_comp</span><span class="p">]</span>
    <span class="n">V</span> <span class="o">=</span> <span class="n">V</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">nb_comp</span><span class="p">,:]</span>

    <span class="n">spec_mono_chrom_wav_V</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">nb_comp</span><span class="p">,</span><span class="n">shap1</span><span class="p">[</span><span class="mi">3</span><span class="p">]))</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_comp</span><span class="p">):</span>
        <span class="n">spec_mono_chrom_wav_V</span><span class="p">[</span><span class="n">i</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">isap</span><span class="o">.</span><span class="n">mr_recons_1d</span><span class="p">(</span><span class="n">V</span><span class="p">[</span><span class="n">i</span><span class="p">,:],</span><span class="n">info_filename</span><span class="p">)</span>
    <span class="n">spec_mono_chrom_wav</span> <span class="o">=</span> <span class="n">U</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">diag</span><span class="p">(</span><span class="n">s</span><span class="p">)</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">spec_mono_chrom_wav_V</span><span class="p">))</span>
    <span class="n">mono_chrom_wav</span> <span class="o">=</span> <span class="n">spec_mono_chrom_wav</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">shap1</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>

    <span class="k">return</span> <span class="n">recons_stack</span><span class="o">+</span><span class="n">mono_chrom_dct</span><span class="o">+</span><span class="n">mono_chrom_wav</span>

<span class="k">def</span> <span class="nf">analysis_op_transpose_3</span><span class="p">(</span><span class="n">stack_coeff</span><span class="p">,</span><span class="n">wavelets_coeff</span><span class="p">,</span><span class="n">spec_coeff_dct</span><span class="p">,</span><span class="n">spec_coeff_wav</span><span class="p">,</span><span class="n">filters_rot</span><span class="p">,</span><span class="n">info_filename</span><span class="p">,</span><span class="n">shap</span><span class="p">,</span><span class="n">supp</span><span class="p">,</span><span class="n">neighbors_graph</span><span class="p">,</span><span class="n">ind_i</span><span class="p">,</span><span class="n">dist_neighbors</span><span class="p">,</span><span class="n">nb_bands</span><span class="p">,</span><span class="n">nb_comp</span> <span class="o">=</span> <span class="mi">50</span><span class="p">):</span>
    <span class="kn">from</span> <span class="nn">numpy</span> <span class="k">import</span> <span class="n">newaxis</span>

    <span class="n">P</span> <span class="o">=</span> <span class="n">analysis_op_transpose</span><span class="p">(</span><span class="n">wavelets_coeff</span><span class="p">,</span><span class="n">spec_coeff_dct</span><span class="p">,</span><span class="n">spec_coeff_wav</span><span class="p">,</span><span class="n">filters_rot</span><span class="p">,</span><span class="n">info_filename</span><span class="p">,</span><span class="n">shap</span><span class="p">,</span><span class="n">supp</span><span class="p">,</span><span class="n">neighbors_graph</span><span class="p">,</span><span class="n">ind_i</span><span class="p">,</span><span class="n">dist_neighbors</span><span class="p">,</span><span class="n">ones</span><span class="p">((</span><span class="n">nb_bands</span><span class="p">,)),</span><span class="n">nb_comp</span> <span class="o">=</span> <span class="mi">50</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">P</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="n">newaxis</span><span class="p">]</span><span class="o">*</span><span class="n">stack_coeff</span><span class="p">[</span><span class="n">newaxis</span><span class="p">,</span><span class="o">...</span><span class="p">]</span>


<span class="k">def</span> <span class="nf">wavelengths_separation_cv</span><span class="p">(</span><span class="n">obs_psf</span><span class="p">,</span><span class="n">wavelengths</span><span class="p">,</span><span class="n">spectrum</span><span class="p">,</span><span class="n">supp_rad</span><span class="p">,</span><span class="n">noise_map</span><span class="p">,</span><span class="n">weights_spec</span><span class="p">,</span><span class="n">weights_space</span><span class="p">,</span><span class="n">filters</span><span class="p">,</span><span class="n">info_file</span><span class="p">,</span><span class="n">opt_wvlth</span><span class="p">,</span><span class="n">tol</span> <span class="o">=</span> <span class="mf">0.01</span><span class="p">,</span><span class="n">nb_iter</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span><span class="n">knn</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">nsig</span><span class="o">=</span><span class="mf">3.</span><span class="p">,</span><span class="n">Px</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">supp</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">neighbors_graph</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">dist_neighbors</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">t</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">spec_rad</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">pwr_meth_en</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">line_search</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">rand_frac</span> <span class="o">=</span> <span class="mf">0.2</span><span class="p">,</span><span class="n">simplex_en</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">mass</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">ksig</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span><span class="n">fwhm</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span><span class="n">nb_rw</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">eps</span><span class="o">=</span><span class="mf">1e-15</span><span class="p">):</span>

    <span class="kn">from</span> <span class="nn">utils</span> <span class="k">import</span> <span class="n">diagonally_dominated_mat</span><span class="p">,</span><span class="n">im_gauss_nois_est</span><span class="p">,</span><span class="n">thresholding</span>
    <span class="kn">from</span> <span class="nn">numpy.linalg</span> <span class="k">import</span> <span class="n">norm</span>
    <span class="kn">from</span> <span class="nn">numpy</span> <span class="k">import</span> <span class="n">copy</span>
    <span class="kn">from</span> <span class="nn">numpy.random</span> <span class="k">import</span> <span class="n">choice</span>
    <span class="kn">from</span> <span class="nn">optim_utils</span> <span class="k">import</span> <span class="n">pow_meth</span>

    <span class="c1"># Init</span>
    <span class="n">shap</span> <span class="o">=</span> <span class="n">obs_psf</span><span class="o">.</span><span class="n">shape</span>
    <span class="k">if</span> <span class="n">Px</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="nb">print</span> <span class="s2">&quot;Initializing the transport plan...&quot;</span>
        <span class="n">Px</span> <span class="o">=</span> <span class="n">diagonally_dominated_mat</span><span class="p">(</span><span class="n">shap</span><span class="p">,</span><span class="n">sig</span><span class="o">=</span><span class="n">supp_rad</span><span class="p">,</span><span class="n">thresh_en</span><span class="o">=</span><span class="n">thresh_en</span><span class="p">,</span><span class="n">coord_map</span><span class="o">=</span><span class="n">coord_map</span><span class="p">,</span><span class="n">pol_en</span><span class="o">=</span><span class="n">pol_en</span><span class="p">,</span><span class="n">cent</span><span class="o">=</span><span class="n">cent</span><span class="p">,</span><span class="n">theta_param</span><span class="o">=</span><span class="n">theta_param</span><span class="p">,</span><span class="n">pol_mod</span><span class="o">=</span><span class="n">pol_mod</span><span class="p">)</span>
        <span class="nb">print</span> <span class="s2">&quot;Done.&quot;</span>


    <span class="k">if</span> <span class="n">t</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">t</span> <span class="o">=</span> <span class="p">(</span><span class="n">wavelengths</span><span class="o">-</span><span class="n">wavelengths</span><span class="o">.</span><span class="n">min</span><span class="p">())</span><span class="o">/</span><span class="p">(</span><span class="n">wavelengths</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">-</span><span class="n">wavelengths</span><span class="o">.</span><span class="n">min</span><span class="p">())</span>
        <span class="k">if</span> <span class="n">supp</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">supp</span> <span class="o">=</span> <span class="n">transpose</span><span class="p">(</span><span class="n">array</span><span class="p">(</span><span class="n">where</span><span class="p">(</span><span class="n">Px</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">)))</span>

    <span class="k">if</span> <span class="n">neighbors_graph</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="nb">print</span> <span class="s2">&quot;Creating the displacement architecture...&quot;</span>
        <span class="n">shap</span> <span class="o">=</span> <span class="n">obs_psf</span><span class="o">.</span><span class="n">shape</span>
        <span class="n">neighbors_graph</span><span class="p">,</span><span class="n">dist_neighbors</span><span class="p">,</span><span class="n">cent</span><span class="p">,</span><span class="n">coord_map</span><span class="p">,</span><span class="n">knn</span> <span class="o">=</span> <span class="n">full_displacement</span><span class="p">(</span><span class="n">shap</span><span class="p">,</span><span class="n">supp</span><span class="p">,</span><span class="n">t</span><span class="p">,</span><span class="n">pol_en</span><span class="o">=</span><span class="n">pol_en</span><span class="p">,</span><span class="n">cent</span><span class="o">=</span><span class="n">cent</span><span class="p">,</span><span class="n">theta_param</span><span class="o">=</span><span class="n">theta_param</span><span class="p">,</span><span class="n">pol_mod</span><span class="o">=</span><span class="n">pol_mod</span><span class="p">,</span><span class="n">coord_map</span><span class="o">=</span><span class="n">coord_map</span><span class="p">,</span><span class="n">knn</span><span class="o">=</span><span class="n">knn</span><span class="p">)</span>
        <span class="nb">print</span> <span class="s2">&quot;Done.&quot;</span>

    <span class="c1"># Hyper parameters</span>
    <span class="n">sigm</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">filters</span><span class="p">))</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">prod</span><span class="p">(</span><span class="n">shap</span><span class="p">))</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">tau</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">pwr_meth_en</span> <span class="ow">or</span> <span class="n">spec_rad</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">line_search</span><span class="p">:</span>
        <span class="nb">input</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="nb">input</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Px</span><span class="p">)</span>
        <span class="nb">input</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">shap</span><span class="p">)</span>
        <span class="nb">input</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">supp</span><span class="p">)</span>
        <span class="nb">input</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">neighbors_graph</span><span class="p">)</span>
        <span class="nb">input</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dist_neighbors</span><span class="p">)</span>
        <span class="nb">input</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">spectrum</span><span class="p">)</span>
        <span class="n">vect</span><span class="p">,</span><span class="n">spec_rad</span> <span class="o">=</span> <span class="n">pow_meth</span><span class="p">(</span><span class="n">pwr_mth_transpose</span><span class="p">,</span><span class="nb">input</span><span class="p">,</span><span class="n">Px</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span><span class="n">tol</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span><span class="n">ainit</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">nb_iter_max</span><span class="o">=</span><span class="mi">30</span><span class="p">)</span>
        <span class="nb">print</span> <span class="s2">&quot;Spectral radius: &quot;</span><span class="p">,</span><span class="n">spec_rad</span>
        <span class="n">tau</span> <span class="o">=</span> <span class="p">(</span><span class="n">spec_rad</span><span class="o">/</span><span class="mi">2</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">sigm</span> <span class="o">=</span> <span class="n">tau</span>

    <span class="c1">#print sigm,tau</span>
    <span class="c1">#</span>
    <span class="n">rho</span> <span class="o">=</span> <span class="mf">0.9</span>

    <span class="c1"># Dual variables</span>
    <span class="n">filters_rot</span> <span class="o">=</span> <span class="n">filters</span><span class="o">*</span><span class="mi">0</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">filters</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]):</span>
        <span class="n">filters_rot</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">rot90</span><span class="p">(</span><span class="n">filters</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">],</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">Px_dual</span> <span class="o">=</span> <span class="n">Px</span><span class="o">*</span><span class="mi">0</span>
    <span class="n">WPx_dual</span> <span class="o">=</span> <span class="n">ones</span><span class="p">(</span><span class="n">Px</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

    <span class="n">space_sparse</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">filters</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span><span class="n">size</span><span class="p">(</span><span class="n">spectrum</span><span class="p">)))</span>
    <span class="n">Wspace_sparse</span> <span class="o">=</span> <span class="n">ones</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">filters</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span><span class="n">size</span><span class="p">(</span><span class="n">spectrum</span><span class="p">)))</span>

    <span class="n">spec_dct_sparse</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">size</span><span class="p">(</span><span class="n">spectrum</span><span class="p">)))</span>
    <span class="n">Wspec_dct_sparse</span> <span class="o">=</span> <span class="n">ones</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">size</span><span class="p">(</span><span class="n">spectrum</span><span class="p">)))</span>

    <span class="n">spec_smooth_sparse</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">size</span><span class="p">(</span><span class="n">spectrum</span><span class="p">)))</span>
    <span class="n">Wspec_smooth_sparse</span> <span class="o">=</span> <span class="n">ones</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">size</span><span class="p">(</span><span class="n">spectrum</span><span class="p">)))</span>


    <span class="c1"># Spectral thresholds</span>
    <span class="n">spec_wav_weights</span><span class="p">,</span><span class="n">spec_dct_weights</span> <span class="o">=</span> <span class="n">spectral_weights</span><span class="p">(</span><span class="n">shap</span><span class="p">,</span><span class="n">size</span><span class="p">(</span><span class="n">spectrum</span><span class="p">),</span><span class="n">fwhm</span><span class="p">,</span><span class="n">weights_spec</span><span class="p">[:,</span><span class="mi">1</span><span class="p">],</span><span class="n">weights_spec</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span><span class="n">cent</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">k</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>


    <span class="n">rel_var</span> <span class="o">=</span> <span class="mi">100</span>
    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_rw</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
        <span class="n">i</span><span class="o">=</span><span class="mi">0</span>
        <span class="k">while</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">nb_iter</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="ow">and</span> <span class="n">rel_var</span><span class="o">&gt;</span><span class="n">tol</span><span class="p">:</span>
            <span class="c1">#ind_i = choice(supp.shape[0],nb_samp)</span>
            <span class="c1">#print ind_i</span>
            <span class="n">ind_i</span> <span class="o">=</span> <span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">supp</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="nb">print</span> <span class="s2">&quot;iter &quot;</span><span class="p">,</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="s2">&quot;/&quot;</span><span class="p">,</span><span class="n">nb_iter</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
            <span class="c1"># Primal step</span>
            <span class="n">grad</span><span class="p">,</span><span class="n">err</span> <span class="o">=</span> <span class="n">wavelengths_separation_gradient</span><span class="p">(</span><span class="n">obs_psf</span><span class="p">,</span><span class="n">Px</span><span class="p">,</span><span class="n">shap</span><span class="p">,</span><span class="n">supp</span><span class="p">,</span><span class="n">neighbors_graph</span><span class="p">,</span><span class="n">ind_i</span><span class="p">,</span><span class="n">dist_neighbors</span><span class="p">,</span><span class="n">spectrum</span><span class="p">)</span>
            <span class="nb">print</span> <span class="s2">&quot;MSE: &quot;</span><span class="p">,</span><span class="n">norm</span><span class="p">(</span><span class="n">err</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span>
            <span class="nb">print</span> <span class="s2">&quot;Cost components: data attachment,&quot;</span><span class="p">,</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">norm</span><span class="p">(</span><span class="n">err</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span><span class="s2">&quot; dual components: &quot;</span><span class="p">,</span><span class="nb">sum</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">space_sparse</span><span class="o">*</span><span class="n">ksig</span><span class="o">*</span><span class="n">weights_space</span><span class="o">*</span><span class="n">Wspace_sparse</span><span class="p">))</span><span class="o">+</span><span class="nb">sum</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">spec_dct_sparse</span><span class="o">*</span><span class="n">ksig</span><span class="o">*</span><span class="n">spec_dct_weights</span><span class="o">*</span><span class="n">Wspec_dct_sparse</span><span class="p">))</span><span class="o">+</span><span class="nb">sum</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">spec_smooth_sparse</span><span class="o">*</span><span class="n">ksig</span><span class="o">*</span><span class="n">spec_wav_weights</span><span class="o">*</span><span class="n">Wspec_smooth_sparse</span><span class="p">))</span><span class="o">+</span><span class="nb">sum</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">Px_dual</span><span class="o">*</span><span class="n">ksig</span><span class="o">*</span><span class="n">noise_map</span><span class="o">*</span><span class="n">WPx_dual</span><span class="p">))</span>
            <span class="c1">#print &quot;Cost function: &quot;, sum(abs(Px*ksig*noise_map*WPx_dual))</span>
            <span class="n">temp1</span> <span class="o">=</span> <span class="n">analysis_op_transpose</span><span class="p">(</span><span class="n">space_sparse</span><span class="p">,</span><span class="n">spec_dct_sparse</span><span class="p">,</span><span class="n">spec_smooth_sparse</span><span class="p">,</span><span class="n">filters_rot</span><span class="p">,</span><span class="n">info_file</span><span class="p">,</span><span class="n">shap</span><span class="p">,</span><span class="n">supp</span><span class="p">,</span><span class="n">neighbors_graph</span><span class="p">,</span><span class="n">ind_i</span><span class="p">,</span><span class="n">dist_neighbors</span><span class="p">,</span><span class="n">spectrum</span><span class="p">,</span><span class="n">nb_comp</span> <span class="o">=</span> <span class="mi">50</span><span class="p">)</span><span class="o">+</span><span class="n">Px_dual</span>
            <span class="k">if</span> <span class="n">line_search</span><span class="p">:</span>
                <span class="n">tGrad</span> <span class="o">=</span> <span class="n">transport_plan_projections</span><span class="p">(</span><span class="n">grad</span><span class="o">+</span><span class="n">temp1</span><span class="p">,</span><span class="n">shap</span><span class="p">,</span><span class="n">supp</span><span class="p">[</span><span class="n">ind_i</span><span class="p">,:],</span><span class="n">neighbors_graph</span><span class="p">[</span><span class="n">ind_i</span><span class="p">,:,:,:],</span><span class="n">dist_neighbors</span><span class="p">[</span><span class="n">ind_i</span><span class="p">,:,:],</span><span class="n">spectrum</span><span class="o">=</span><span class="n">spectrum</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
                <span class="n">tau</span> <span class="o">=</span> <span class="o">-</span><span class="nb">sum</span><span class="p">(</span><span class="n">err</span><span class="o">*</span><span class="n">tGrad</span><span class="p">)</span><span class="o">/</span><span class="nb">sum</span><span class="p">(</span><span class="n">tGrad</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
                <span class="n">sigm</span> <span class="o">=</span> <span class="n">tau</span>
            <span class="n">Px_temp</span> <span class="o">=</span> <span class="n">prox_pos</span><span class="p">(</span><span class="n">Px</span><span class="o">-</span><span class="n">tau</span><span class="o">*</span><span class="p">(</span><span class="n">grad</span><span class="o">+</span><span class="n">temp1</span><span class="p">),</span><span class="n">mass</span><span class="o">=</span><span class="n">mass</span><span class="p">,</span><span class="n">simplex_en</span><span class="o">=</span><span class="n">simplex_en</span><span class="p">)</span>
            <span class="c1">#Px_temp = Px-tau*(grad+temp1)</span>


            <span class="c1"># Dual step</span>
            <span class="n">wavelets_coeff_temp</span><span class="p">,</span><span class="n">spec_coeff_dct_temp</span><span class="p">,</span><span class="n">spec_coeff_wav_temp</span> <span class="o">=</span> <span class="n">analysis_op</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">Px_temp</span><span class="o">-</span><span class="n">Px</span><span class="p">,</span><span class="n">filters</span><span class="p">,</span><span class="n">opt_wvlth</span><span class="p">,</span><span class="n">shap</span><span class="p">,</span><span class="n">supp</span><span class="p">,</span><span class="n">neighbors_graph</span><span class="p">,</span><span class="n">ind_i</span><span class="p">,</span><span class="n">dist_neighbors</span><span class="p">,</span><span class="n">spectrum</span><span class="p">,</span><span class="n">nb_comp</span> <span class="o">=</span> <span class="mi">50</span><span class="p">)</span>
            <span class="n">P_thresh</span><span class="p">,</span><span class="n">stack_wav_thresh</span><span class="p">,</span><span class="n">stack_dct_thresh</span><span class="p">,</span><span class="n">stack_spec_wav_thresh</span> <span class="o">=</span> <span class="n">prox_sparsity</span><span class="p">(</span><span class="n">Px_dual</span><span class="o">+</span><span class="n">sigm</span><span class="o">*</span><span class="p">(</span><span class="n">Px_temp</span><span class="o">-</span><span class="n">Px</span><span class="p">),</span><span class="n">space_sparse</span><span class="o">+</span><span class="n">sigm</span><span class="o">*</span><span class="n">wavelets_coeff_temp</span><span class="p">,</span><span class="n">spec_dct_sparse</span><span class="o">+</span><span class="n">sigm</span><span class="o">*</span><span class="n">spec_coeff_dct_temp</span><span class="p">,</span><span class="n">spec_smooth_sparse</span><span class="o">+</span><span class="n">sigm</span><span class="o">*</span><span class="n">spec_coeff_wav_temp</span><span class="p">,</span><span class="n">ksig</span><span class="o">*</span><span class="n">noise_map</span><span class="o">*</span><span class="n">WPx_dual</span><span class="p">,</span><span class="n">ksig</span><span class="o">*</span><span class="n">weights_space</span><span class="o">*</span><span class="n">Wspace_sparse</span><span class="p">,</span><span class="n">ksig</span><span class="o">*</span><span class="n">spec_dct_weights</span><span class="o">*</span><span class="n">Wspec_dct_sparse</span><span class="p">,</span><span class="n">ksig</span><span class="o">*</span><span class="n">spec_wav_weights</span><span class="o">*</span><span class="n">Wspec_smooth_sparse</span><span class="p">,</span><span class="n">sigm</span><span class="p">,</span><span class="n">thresh_type</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

            <span class="c1"># Variables update</span>
            <span class="n">Px</span> <span class="o">=</span> <span class="n">rho</span><span class="o">*</span><span class="n">Px_temp</span><span class="o">+</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">rho</span><span class="p">)</span><span class="o">*</span><span class="n">Px</span>
            <span class="n">Px_dual</span> <span class="o">=</span> <span class="n">rho</span><span class="o">*</span><span class="n">P_thresh</span><span class="o">+</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">rho</span><span class="p">)</span><span class="o">*</span><span class="n">Px_dual</span>
            <span class="n">space_sparse</span> <span class="o">=</span> <span class="n">rho</span><span class="o">*</span><span class="n">stack_wav_thresh</span><span class="o">+</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">rho</span><span class="p">)</span><span class="o">*</span><span class="n">space_sparse</span>
            <span class="n">spec_dct_sparse</span> <span class="o">=</span> <span class="n">rho</span><span class="o">*</span><span class="n">stack_dct_thresh</span><span class="o">+</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">rho</span><span class="p">)</span><span class="o">*</span><span class="n">spec_dct_sparse</span>
            <span class="n">spec_smooth_sparse</span> <span class="o">=</span> <span class="n">rho</span><span class="o">*</span><span class="n">stack_spec_wav_thresh</span><span class="o">+</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">rho</span><span class="p">)</span><span class="o">*</span><span class="n">spec_smooth_sparse</span>
            <span class="n">i</span><span class="o">+=</span><span class="mi">1</span>
        <span class="c1"># Reweighting</span>

        <span class="k">if</span> <span class="n">j</span><span class="o">&lt;</span><span class="n">nb_rw</span><span class="p">:</span>
            <span class="n">WPx_dual</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="nb">abs</span><span class="p">(</span><span class="n">Px</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">ksig</span><span class="o">*</span><span class="n">noise_map</span><span class="o">+</span><span class="n">eps</span><span class="p">))</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">wavelets_coeff_temp</span><span class="p">,</span><span class="n">spec_coeff_dct_temp</span><span class="p">,</span><span class="n">spec_coeff_wav_temp</span> <span class="o">=</span> <span class="n">analysis_op</span><span class="p">(</span><span class="n">Px</span><span class="p">,</span><span class="n">filters</span><span class="p">,</span><span class="n">opt_wvlth</span><span class="p">,</span><span class="n">shap</span><span class="p">,</span><span class="n">supp</span><span class="p">,</span><span class="n">neighbors_graph</span><span class="p">,</span><span class="n">ind_i</span><span class="p">,</span><span class="n">dist_neighbors</span><span class="p">,</span><span class="n">spectrum</span><span class="p">,</span><span class="n">nb_comp</span> <span class="o">=</span> <span class="mi">50</span><span class="p">)</span>
            <span class="n">Wspace_sparse</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="nb">abs</span><span class="p">(</span><span class="n">wavelets_coeff_temp</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">ksig</span><span class="o">*</span><span class="n">weights_space</span><span class="o">+</span><span class="n">eps</span><span class="p">))</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">Wspec_dct_sparse</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="nb">abs</span><span class="p">(</span><span class="n">spec_coeff_dct_temp</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">ksig</span><span class="o">*</span><span class="n">spec_dct_weights</span><span class="o">+</span><span class="n">eps</span><span class="p">))</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">Wspec_smooth_sparse</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="nb">abs</span><span class="p">(</span><span class="n">spec_coeff_wav_temp</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">ksig</span><span class="o">*</span><span class="n">spec_wav_weights</span><span class="o">+</span><span class="n">eps</span><span class="p">))</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
            <span class="nb">print</span> <span class="s2">&quot;Reweighting &quot;</span><span class="p">,</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="s2">&quot;/&quot;</span><span class="p">,</span><span class="n">nb_rw</span>

    <span class="k">return</span> <span class="n">transport_plan_projections</span><span class="p">(</span><span class="n">Px</span><span class="p">,</span><span class="n">shap</span><span class="p">,</span><span class="n">supp</span><span class="p">,</span><span class="n">neighbors_graph</span><span class="p">,</span><span class="n">dist_neighbors</span><span class="p">),</span><span class="n">Px</span><span class="p">,</span><span class="n">err</span><span class="p">,</span><span class="n">spec_rad</span>


<span class="k">def</span> <span class="nf">wavelengths_separation_gfb</span><span class="p">(</span><span class="n">obs_psf</span><span class="p">,</span><span class="n">wavelengths</span><span class="p">,</span><span class="n">spectrum</span><span class="p">,</span><span class="n">supp_rad</span><span class="p">,</span><span class="n">noise_map</span><span class="p">,</span><span class="n">weights_spec</span><span class="p">,</span><span class="n">weights_space</span><span class="p">,</span><span class="n">filters</span><span class="p">,</span><span class="n">info_file</span><span class="p">,</span><span class="n">opt_wvlth</span><span class="p">,</span><span class="n">mu</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span><span class="n">Gamma</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span><span class="n">tol</span> <span class="o">=</span> <span class="mf">0.01</span><span class="p">,</span><span class="n">nb_iter</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span><span class="n">knn</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">nsig</span><span class="o">=</span><span class="mf">3.</span><span class="p">,</span><span class="n">Px</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">supp</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">neighbors_graph</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">dist_neighbors</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">t</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">spec_rad</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">pwr_meth_en</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">grad_en</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">line_search</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">rand_frac</span> <span class="o">=</span> <span class="mf">0.2</span><span class="p">,</span><span class="n">simplex_en</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">mass</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">ksig</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span><span class="n">fwhm</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span><span class="n">nb_rw</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">eps</span><span class="o">=</span><span class="mf">1e-15</span><span class="p">):</span>
    <span class="kn">from</span> <span class="nn">utils</span> <span class="k">import</span> <span class="n">diagonally_dominated_mat</span><span class="p">,</span><span class="n">im_gauss_nois_est</span><span class="p">,</span><span class="n">thresholding</span>
    <span class="kn">from</span> <span class="nn">numpy.linalg</span> <span class="k">import</span> <span class="n">norm</span>
    <span class="kn">from</span> <span class="nn">optim_utils</span> <span class="k">import</span> <span class="n">pos_proj_mat</span><span class="p">,</span><span class="n">prox_coeff_sum</span><span class="p">,</span><span class="n">pow_meth</span>
    <span class="kn">from</span> <span class="nn">simplex_projection</span> <span class="k">import</span> <span class="n">euclidean_proj_simplex</span>
    <span class="kn">from</span> <span class="nn">numpy</span> <span class="k">import</span> <span class="n">copy</span><span class="p">,</span><span class="n">multiply</span>
    <span class="kn">from</span> <span class="nn">numpy.random</span> <span class="k">import</span> <span class="n">choice</span>

    <span class="n">nb_bands</span> <span class="o">=</span> <span class="n">size</span><span class="p">(</span><span class="n">spectrum</span><span class="p">)</span>

    <span class="c1"># Hyper-parameters</span>
    <span class="n">gamma</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">lambd</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">w1</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="c1"># Positivity or positive simplex constraint</span>
    <span class="n">w2</span> <span class="o">=</span> <span class="mi">1</span><span class="o">-</span><span class="n">w1</span> <span class="c1"># Sparsity</span>

    <span class="c1"># Init</span>
    <span class="n">shap</span> <span class="o">=</span> <span class="n">obs_psf</span><span class="o">.</span><span class="n">shape</span>
    <span class="k">if</span> <span class="n">Px</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="nb">print</span> <span class="s2">&quot;Initializing the transport plan...&quot;</span>
        <span class="n">Px</span> <span class="o">=</span> <span class="n">diagonally_dominated_mat</span><span class="p">(</span><span class="n">shap</span><span class="p">,</span><span class="n">sig</span><span class="o">=</span><span class="n">supp_rad</span><span class="p">,</span><span class="n">thresh_en</span><span class="o">=</span><span class="n">thresh_en</span><span class="p">,</span><span class="n">coord_map</span><span class="o">=</span><span class="n">coord_map</span><span class="p">,</span><span class="n">pol_en</span><span class="o">=</span><span class="n">pol_en</span><span class="p">,</span><span class="n">cent</span><span class="o">=</span><span class="n">cent</span><span class="p">,</span><span class="n">theta_param</span><span class="o">=</span><span class="n">theta_param</span><span class="p">,</span><span class="n">pol_mod</span><span class="o">=</span><span class="n">pol_mod</span><span class="p">)</span>
        <span class="nb">print</span> <span class="s2">&quot;Done.&quot;</span>

    <span class="n">space_sparse</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">filters</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span><span class="n">size</span><span class="p">(</span><span class="n">spectrum</span><span class="p">)))</span>
    <span class="n">Wspace_sparse</span> <span class="o">=</span> <span class="n">ones</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">filters</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span><span class="n">size</span><span class="p">(</span><span class="n">spectrum</span><span class="p">)))</span>

    <span class="n">spec_dct_sparse</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">size</span><span class="p">(</span><span class="n">spectrum</span><span class="p">)))</span>
    <span class="n">Wspec_dct_sparse</span> <span class="o">=</span> <span class="n">ones</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">size</span><span class="p">(</span><span class="n">spectrum</span><span class="p">)))</span>

    <span class="n">spec_smooth_sparse</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">size</span><span class="p">(</span><span class="n">spectrum</span><span class="p">)))</span>
    <span class="n">Wspec_smooth_sparse</span> <span class="o">=</span> <span class="n">ones</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">size</span><span class="p">(</span><span class="n">spectrum</span><span class="p">)))</span>

    <span class="c1"># First auxiliary variables and related weights</span>
    <span class="n">Pz1</span> <span class="o">=</span> <span class="n">w1</span><span class="o">*</span><span class="n">Px</span>
    <span class="n">filters_rot</span> <span class="o">=</span> <span class="n">filters</span><span class="o">*</span><span class="mi">0</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">filters</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]):</span>
        <span class="n">filters_rot</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">rot90</span><span class="p">(</span><span class="n">filters</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">],</span><span class="mi">2</span><span class="p">)</span>

    <span class="c1"># Spectral thresholds</span>
    <span class="n">spec_wav_weights</span><span class="p">,</span><span class="n">spec_dct_weights</span> <span class="o">=</span> <span class="n">spectral_weights</span><span class="p">(</span><span class="n">shap</span><span class="p">,</span><span class="n">size</span><span class="p">(</span><span class="n">spectrum</span><span class="p">),</span><span class="n">fwhm</span><span class="p">,</span><span class="n">weights_spec</span><span class="p">[:,</span><span class="mi">1</span><span class="p">],</span><span class="n">weights_spec</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span><span class="n">cent</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">k</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>


    <span class="c1"># Second auxiliary variables</span>
    <span class="n">Pz2</span> <span class="o">=</span> <span class="n">w2</span><span class="o">*</span><span class="n">Px</span>
    <span class="n">WPz2</span> <span class="o">=</span> <span class="n">ones</span><span class="p">(</span><span class="n">Px</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">t</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">t</span> <span class="o">=</span> <span class="p">(</span><span class="n">wavelengths</span><span class="o">-</span><span class="n">wavelengths</span><span class="o">.</span><span class="n">min</span><span class="p">())</span><span class="o">/</span><span class="p">(</span><span class="n">wavelengths</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">-</span><span class="n">wavelengths</span><span class="o">.</span><span class="n">min</span><span class="p">())</span>
        <span class="k">if</span> <span class="n">supp</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">supp</span> <span class="o">=</span> <span class="n">transpose</span><span class="p">(</span><span class="n">array</span><span class="p">(</span><span class="n">where</span><span class="p">(</span><span class="n">Px</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">)))</span>
    <span class="k">if</span> <span class="n">neighbors_graph</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="nb">print</span> <span class="s2">&quot;Creating the displacement architecture...&quot;</span>
        <span class="n">shap</span> <span class="o">=</span> <span class="n">obs_psf</span><span class="o">.</span><span class="n">shape</span>
        <span class="n">neighbors_graph</span><span class="p">,</span><span class="n">dist_neighbors</span><span class="p">,</span><span class="n">cent</span><span class="p">,</span><span class="n">coord_map</span><span class="p">,</span><span class="n">knn</span> <span class="o">=</span> <span class="n">full_displacement</span><span class="p">(</span><span class="n">shap</span><span class="p">,</span><span class="n">supp</span><span class="p">,</span><span class="n">t</span><span class="p">,</span><span class="n">pol_en</span><span class="o">=</span><span class="n">pol_en</span><span class="p">,</span><span class="n">cent</span><span class="o">=</span><span class="n">cent</span><span class="p">,</span><span class="n">theta_param</span><span class="o">=</span><span class="n">theta_param</span><span class="p">,</span><span class="n">pol_mod</span><span class="o">=</span><span class="n">pol_mod</span><span class="p">,</span><span class="n">coord_map</span><span class="o">=</span><span class="n">coord_map</span><span class="p">,</span><span class="n">knn</span><span class="o">=</span><span class="n">knn</span><span class="p">)</span>
        <span class="nb">print</span> <span class="s2">&quot;Done.&quot;</span>
    <span class="n">i</span><span class="o">=</span><span class="mi">0</span>
    <span class="n">rel_var</span> <span class="o">=</span> <span class="mi">100</span>

    <span class="c1"># Noise estimation</span>


    <span class="k">if</span> <span class="n">noise_map</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">grad_en</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
        <span class="nb">print</span> <span class="s2">&quot;Noise map setting...&quot;</span>
        <span class="n">sig</span><span class="p">,</span><span class="n">filt</span> <span class="o">=</span> <span class="n">im_gauss_nois_est</span><span class="p">(</span><span class="n">obs_psf</span><span class="p">)</span>
        <span class="n">Gamma</span> <span class="o">*=</span> <span class="n">sig</span>
        <span class="n">noise_map</span> <span class="o">=</span> <span class="n">transport_plan_noise_map</span><span class="p">(</span><span class="n">spectrum</span><span class="p">,</span><span class="n">supp</span><span class="p">,</span><span class="n">neighbors_graph</span><span class="p">,</span><span class="n">dist_neighbors</span><span class="p">,</span><span class="n">shap</span><span class="p">)</span><span class="o">*</span><span class="n">sig</span>
        <span class="nb">print</span> <span class="s2">&quot;Done.&quot;</span>

    <span class="c1"># Spectral radius estmation</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">pwr_meth_en</span> <span class="ow">or</span> <span class="n">spec_rad</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">line_search</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">mult_update</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">spec_rad</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="nb">input</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
            <span class="nb">input</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Px</span><span class="p">)</span>
            <span class="nb">input</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">shap</span><span class="p">)</span>
            <span class="nb">input</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">supp</span><span class="p">)</span>
            <span class="nb">input</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">neighbors_graph</span><span class="p">)</span>
            <span class="nb">input</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dist_neighbors</span><span class="p">)</span>
            <span class="nb">input</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">spectrum</span><span class="p">)</span>
            <span class="n">vect</span><span class="p">,</span><span class="n">spec_rad</span> <span class="o">=</span> <span class="n">pow_meth</span><span class="p">(</span><span class="n">pwr_mth_transpose</span><span class="p">,</span><span class="nb">input</span><span class="p">,</span><span class="n">Px</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span><span class="n">tol</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span><span class="n">ainit</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">nb_iter_max</span><span class="o">=</span><span class="mi">30</span><span class="p">)</span>
            <span class="nb">print</span> <span class="s2">&quot;Spectral radius: &quot;</span><span class="p">,</span><span class="n">spec_rad</span>
        <span class="n">mu</span><span class="o">/=</span><span class="p">(</span><span class="n">spec_rad</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">Gamma</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">mu</span><span class="o">/=</span> <span class="n">size</span><span class="p">(</span><span class="n">obs_psf</span><span class="p">)</span><span class="o">*</span><span class="nb">sum</span><span class="p">(</span><span class="n">spectrum</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>


    <span class="nb">print</span> <span class="s2">&quot;Main loop:&quot;</span>

    <span class="n">nb_samp</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">supp</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">rand_frac</span><span class="p">)</span>
    <span class="k">while</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">nb_iter</span> <span class="ow">and</span> <span class="n">rel_var</span><span class="o">&gt;</span><span class="n">tol</span><span class="p">:</span>
        <span class="c1">#ind_i = choice(supp.shape[0],nb_samp)</span>
        <span class="c1">#print ind_i</span>
        <span class="n">ind_i</span> <span class="o">=</span> <span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">supp</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="nb">print</span> <span class="s2">&quot;iter &quot;</span><span class="p">,</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="s2">&quot;/&quot;</span><span class="p">,</span><span class="n">nb_iter</span>

        <span class="n">mono_comp_est</span> <span class="o">=</span> <span class="n">transport_plan_projections</span><span class="p">(</span><span class="n">Px</span><span class="p">,</span><span class="n">shap</span><span class="p">,</span><span class="n">supp</span><span class="p">[</span><span class="n">ind_i</span><span class="p">,:],</span><span class="n">neighbors_graph</span><span class="p">[</span><span class="n">ind_i</span><span class="p">,:,:,:],</span><span class="n">dist_neighbors</span><span class="p">[</span><span class="n">ind_i</span><span class="p">,:,:])</span>
        <span class="n">cur_est</span> <span class="o">=</span> <span class="n">multiply</span><span class="p">(</span><span class="n">mono_comp_est</span><span class="p">,</span><span class="n">spectrum</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">wav_const_comp</span> <span class="o">=</span> <span class="n">analysis_op_transpose_2</span><span class="p">(</span><span class="n">space_sparse</span><span class="p">,</span><span class="n">spec_dct_sparse</span><span class="p">,</span><span class="n">spec_smooth_sparse</span><span class="p">,</span><span class="n">filters_rot</span><span class="p">,</span><span class="n">info_file</span><span class="p">,</span><span class="n">shap</span><span class="p">,</span><span class="n">spectrum</span><span class="p">,</span><span class="n">nb_comp</span> <span class="o">=</span> <span class="mi">50</span><span class="p">)</span>

        <span class="n">err_1</span> <span class="o">=</span> <span class="n">cur_est</span><span class="o">-</span><span class="n">obs_psf</span>
        <span class="n">err_2</span> <span class="o">=</span> <span class="n">mono_comp_est</span> <span class="o">-</span> <span class="n">wav_const_comp</span>
        <span class="n">sum_err_1</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">err_1</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">sum_err_2</span> <span class="o">=</span> <span class="n">Gamma</span><span class="o">*</span><span class="nb">sum</span><span class="p">(</span><span class="n">err_2</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
        <span class="nb">print</span> <span class="s2">&quot;Error: &quot;</span><span class="p">,</span> <span class="n">sum_err_1</span>
        <span class="nb">print</span> <span class="s2">&quot;Quadratic part of the cost: &quot;</span><span class="p">,</span><span class="n">sum_err_1</span><span class="o">+</span><span class="n">sum_err_2</span>
        <span class="nb">print</span> <span class="s2">&quot;L1 norms:&quot;</span><span class="p">,</span><span class="s2">&quot; transport plan: &quot;</span><span class="p">,</span><span class="nb">sum</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">Px</span><span class="o">*</span><span class="n">WPz2</span><span class="o">*</span><span class="n">noise_map</span><span class="o">*</span><span class="n">ksig</span><span class="p">)),</span><span class="s2">&quot; Spatial smoothness: &quot;</span><span class="p">,</span><span class="nb">sum</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">space_sparse</span><span class="o">*</span><span class="n">ksig</span><span class="o">*</span><span class="n">weights_space</span><span class="o">*</span><span class="n">Wspace_sparse</span><span class="p">))</span>
        <span class="nb">print</span> <span class="s2">&quot;Spectral regularity: &quot;</span><span class="p">,</span><span class="nb">sum</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">spec_dct_sparse</span><span class="o">*</span><span class="n">ksig</span><span class="o">*</span><span class="n">spec_dct_weights</span><span class="o">*</span><span class="n">Wspec_dct_sparse</span><span class="p">))</span><span class="o">+</span><span class="nb">sum</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">spec_smooth_sparse</span><span class="o">*</span><span class="n">ksig</span><span class="o">*</span><span class="n">spec_wav_weights</span><span class="o">*</span><span class="n">Wspec_smooth_sparse</span><span class="p">))</span>
        <span class="nb">print</span> <span class="s2">&quot;Constraint transfer: &quot;</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">norm</span><span class="p">(</span><span class="n">err_2</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="nb">max</span><span class="p">(</span><span class="n">norm</span><span class="p">(</span><span class="n">mono_comp_est</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span><span class="n">norm</span><span class="p">(</span><span class="n">wav_const_comp</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span><span class="o">*</span><span class="mi">100</span><span class="p">,</span><span class="s2">&quot;%&quot;</span>
        <span class="n">Pxold</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">Px</span><span class="p">)</span>


        <span class="n">grad_comp_1</span> <span class="o">=</span> <span class="n">transport_plan_projections_transpose</span><span class="p">(</span><span class="n">err_1</span><span class="p">,</span><span class="n">supp</span><span class="p">[</span><span class="n">ind_i</span><span class="p">,:],</span><span class="n">neighbors_graph</span><span class="p">[</span><span class="n">ind_i</span><span class="p">,:,:,:],</span><span class="n">dist_neighbors</span><span class="p">[</span><span class="n">ind_i</span><span class="p">,:,:],</span><span class="n">spectrum</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span><span class="o">+</span><span class="n">transport_plan_projections_transpose_2</span><span class="p">(</span><span class="n">Gamma</span><span class="o">*</span><span class="n">err_2</span><span class="p">,</span><span class="n">supp</span><span class="p">[</span><span class="n">ind_i</span><span class="p">,:],</span><span class="n">neighbors_graph</span><span class="p">[</span><span class="n">ind_i</span><span class="p">,:,:,:],</span><span class="n">dist_neighbors</span><span class="p">[</span><span class="n">ind_i</span><span class="p">,:,:],</span><span class="n">ones</span><span class="p">((</span><span class="n">nb_bands</span><span class="p">,)))</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">grad_wavelets_coeff</span><span class="p">,</span><span class="n">grad_spec_coeff_dct</span><span class="p">,</span><span class="n">grad_spec_coeff_wav</span> <span class="o">=</span> <span class="n">analysis_op_2</span><span class="p">(</span><span class="o">-</span><span class="n">Gamma</span><span class="o">*</span><span class="n">err_2</span><span class="p">,</span><span class="n">filters</span><span class="p">,</span><span class="n">opt_wvlth</span><span class="p">,</span><span class="n">shap</span><span class="p">,</span><span class="n">spectrum</span><span class="p">,</span><span class="n">nb_comp</span> <span class="o">=</span> <span class="mi">50</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">line_search</span><span class="p">:</span>
            <span class="n">comp_tgrad_1</span> <span class="o">=</span> <span class="o">-</span><span class="n">transport_plan_projections</span><span class="p">(</span><span class="n">grad_comp_1</span><span class="p">,</span><span class="n">shap</span><span class="p">,</span><span class="n">supp</span><span class="p">[</span><span class="n">ind_i</span><span class="p">,:],</span><span class="n">neighbors_graph</span><span class="p">[</span><span class="n">ind_i</span><span class="p">,:,:,:],</span><span class="n">dist_neighbors</span><span class="p">[</span><span class="n">ind_i</span><span class="p">,:,:])</span>
            <span class="n">tGrad_1</span> <span class="o">=</span> <span class="n">multiply</span><span class="p">(</span><span class="n">comp_tgrad_1</span><span class="p">,</span><span class="n">spectrum</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
            <span class="n">diff_tGrad</span> <span class="o">=</span> <span class="n">comp_tgrad_1</span><span class="o">-</span><span class="n">analysis_op_transpose_2</span><span class="p">(</span><span class="n">grad_wavelets_coeff</span><span class="p">,</span><span class="n">grad_spec_coeff_dct</span><span class="p">,</span><span class="n">grad_spec_coeff_wav</span><span class="p">,</span><span class="n">filters_rot</span><span class="p">,</span><span class="n">info_file</span><span class="p">,</span><span class="n">shap</span><span class="p">,</span><span class="n">spectrum</span><span class="p">,</span><span class="n">nb_comp</span> <span class="o">=</span> <span class="mi">50</span><span class="p">)</span>
            <span class="n">mu</span> <span class="o">=</span> <span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="o">-</span><span class="n">err_1</span><span class="o">*</span><span class="n">tGrad_1</span><span class="p">)</span><span class="o">-</span><span class="n">Gamma</span><span class="o">*</span><span class="nb">sum</span><span class="p">(</span><span class="n">err_2</span><span class="o">*</span><span class="n">diff_tGrad</span><span class="p">))</span><span class="o">/</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="n">tGrad_1</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">+</span><span class="n">Gamma</span><span class="o">*</span><span class="nb">sum</span><span class="p">(</span><span class="n">diff_tGrad</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">grad_en</span><span class="p">:</span>
            <span class="n">Px</span> <span class="o">-=</span> <span class="n">mu</span><span class="o">*</span><span class="n">grad_comp_1</span>
            <span class="n">space_sparse</span> <span class="o">-=</span> <span class="n">mu</span><span class="o">*</span><span class="n">grad_wavelets_coeff</span>
            <span class="n">spec_dct_sparse</span> <span class="o">-=</span> <span class="n">mu</span><span class="o">*</span><span class="n">grad_spec_coeff_dct</span>
            <span class="n">spec_smooth_sparse</span> <span class="o">-=</span> <span class="n">mu</span><span class="o">*</span><span class="n">grad_spec_coeff_wav</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Positivity/simplex constraint</span>
            <span class="n">temp</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">Px</span> <span class="o">-</span> <span class="n">Pz1</span> <span class="o">-</span> <span class="n">mu</span><span class="o">*</span><span class="n">gamma</span><span class="o">*</span><span class="n">grad_comp_1</span>
            <span class="n">Pz1</span> <span class="o">+=</span> <span class="n">lambd</span><span class="o">*</span><span class="n">prox_pos</span><span class="p">(</span><span class="n">temp</span><span class="p">,</span><span class="n">mass</span><span class="o">=</span><span class="n">mass</span><span class="p">,</span><span class="n">simplex_en</span><span class="o">=</span><span class="n">simplex_en</span><span class="p">)</span>

            <span class="c1"># Wavelet sparsity constraint</span>
            <span class="n">temp1</span> <span class="o">=</span> <span class="n">space_sparse</span> <span class="o">-</span> <span class="n">mu</span><span class="o">*</span><span class="n">gamma</span><span class="o">*</span><span class="n">grad_wavelets_coeff</span>
            <span class="n">temp2</span> <span class="o">=</span> <span class="n">spec_dct_sparse</span> <span class="o">-</span> <span class="n">mu</span><span class="o">*</span><span class="n">gamma</span><span class="o">*</span><span class="n">grad_spec_coeff_dct</span>
            <span class="n">temp3</span> <span class="o">=</span> <span class="n">spec_smooth_sparse</span> <span class="o">-</span> <span class="n">mu</span><span class="o">*</span><span class="n">gamma</span><span class="o">*</span><span class="n">grad_spec_coeff_wav</span>

            <span class="n">temp1</span><span class="p">,</span><span class="n">temp2</span><span class="p">,</span><span class="n">temp3</span> <span class="o">=</span> <span class="n">prox_sparsity_2</span><span class="p">(</span><span class="n">temp1</span><span class="p">,</span><span class="n">temp2</span><span class="p">,</span><span class="n">temp3</span><span class="p">,</span><span class="n">ksig</span><span class="o">*</span><span class="n">weights_space</span><span class="o">*</span><span class="n">Wspace_sparse</span><span class="p">,</span><span class="n">ksig</span><span class="o">*</span><span class="n">spec_dct_weights</span><span class="o">*</span><span class="n">Wspec_dct_sparse</span><span class="p">,</span><span class="n">ksig</span><span class="o">*</span><span class="n">spec_wav_weights</span><span class="o">*</span><span class="n">Wspec_smooth_sparse</span><span class="p">,</span><span class="n">mu</span><span class="o">*</span><span class="n">gamma</span><span class="p">,</span><span class="n">thresh_type</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

            <span class="n">space_sparse</span> <span class="o">+=</span> <span class="n">lambd</span><span class="o">*</span><span class="n">temp1</span>
            <span class="n">spec_dct_sparse</span> <span class="o">+=</span> <span class="n">lambd</span><span class="o">*</span><span class="n">temp2</span>
            <span class="n">spec_smooth_sparse</span> <span class="o">+=</span> <span class="n">lambd</span><span class="o">*</span><span class="n">temp3</span>

            <span class="c1"># Sparsity constraint</span>
            <span class="n">temp</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">Px</span> <span class="o">-</span> <span class="n">Pz2</span> <span class="o">-</span> <span class="n">mu</span><span class="o">*</span><span class="n">gamma</span><span class="o">*</span><span class="n">grad_comp_1</span>
            <span class="n">Pz2</span> <span class="o">+=</span> <span class="n">lambd</span><span class="o">*</span><span class="p">(</span><span class="n">thresholding</span><span class="p">(</span><span class="n">temp</span><span class="p">,</span><span class="n">WPz2</span><span class="o">*</span><span class="n">noise_map</span><span class="o">*</span><span class="n">ksig</span><span class="o">*</span><span class="n">mu</span><span class="o">*</span><span class="n">gamma</span><span class="o">/</span><span class="n">w2</span><span class="p">,</span><span class="n">thresh_type</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">-</span><span class="n">Px</span><span class="p">)</span>

            <span class="c1"># Main variable update</span>
            <span class="n">Px</span> <span class="o">=</span> <span class="n">w1</span><span class="o">*</span><span class="n">Pz1</span><span class="o">+</span><span class="n">w2</span><span class="o">*</span><span class="n">Pz2</span>

        <span class="n">rel_var</span> <span class="o">=</span> <span class="mi">100</span><span class="o">*</span><span class="nb">sum</span><span class="p">((</span><span class="n">Px</span><span class="o">-</span><span class="n">Pxold</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="nb">sum</span><span class="p">(</span><span class="n">Px</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">i</span><span class="o">+=</span><span class="mi">1</span>
    <span class="nb">print</span> <span class="s2">&quot;Done.&quot;</span>

    <span class="k">return</span> <span class="n">transport_plan_projections</span><span class="p">(</span><span class="n">Px</span><span class="p">,</span><span class="n">shap</span><span class="p">,</span><span class="n">supp</span><span class="p">,</span><span class="n">neighbors_graph</span><span class="p">,</span><span class="n">dist_neighbors</span><span class="p">),</span><span class="n">Px</span><span class="p">,</span><span class="n">err_1</span><span class="p">,</span><span class="n">spec_rad</span>




<span class="k">def</span> <span class="nf">wavelengths_separation</span><span class="p">(</span><span class="n">obs_psf</span><span class="p">,</span><span class="n">wavelengths</span><span class="p">,</span><span class="n">spectrum</span><span class="p">,</span><span class="n">supp_rad</span><span class="p">,</span><span class="n">mu</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span><span class="n">tol</span> <span class="o">=</span> <span class="mf">0.01</span><span class="p">,</span><span class="n">nb_iter</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span><span class="n">thresh_en</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">coord_map</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">pol_en</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">cent</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">theta_param</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">pol_mod</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">knn</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">nsig</span><span class="o">=</span><span class="mf">3.</span><span class="p">,</span><span class="n">Px</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">supp</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">neighbors_graph</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">dist_neighbors</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">t</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">noise_map</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">grad_en</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">spec_rad</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">pwr_meth_en</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">line_search</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">mult_update</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">rand_frac</span> <span class="o">=</span> <span class="mf">0.2</span><span class="p">,</span><span class="n">simplex_en</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">mass</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>

    <span class="kn">from</span> <span class="nn">utils</span> <span class="k">import</span> <span class="n">diagonally_dominated_mat</span><span class="p">,</span><span class="n">im_gauss_nois_est</span><span class="p">,</span><span class="n">thresholding</span>
    <span class="kn">from</span> <span class="nn">numpy.linalg</span> <span class="k">import</span> <span class="n">norm</span>
    <span class="kn">from</span> <span class="nn">optim_utils</span> <span class="k">import</span> <span class="n">pos_proj_mat</span><span class="p">,</span><span class="n">prox_coeff_sum</span><span class="p">,</span><span class="n">pow_meth</span>
    <span class="kn">from</span> <span class="nn">simplex_projection</span> <span class="k">import</span> <span class="n">euclidean_proj_simplex</span>
    <span class="kn">from</span> <span class="nn">numpy</span> <span class="k">import</span> <span class="n">copy</span>
    <span class="kn">from</span> <span class="nn">numpy.random</span> <span class="k">import</span> <span class="n">choice</span>


    <span class="k">if</span> <span class="n">mult_update</span><span class="p">:</span>
        <span class="n">grad_en</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">spec_rad_en</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">obs_psf_pos</span> <span class="o">=</span> <span class="n">pos_proj_mat</span><span class="p">(</span><span class="n">obs_psf</span><span class="p">)</span>
        <span class="n">tObs</span> <span class="o">=</span> <span class="n">transport_plan_projections_transpose</span><span class="p">(</span><span class="n">obs_psf_pos</span><span class="p">,</span><span class="n">supp</span><span class="p">,</span><span class="n">neighbors_graph</span><span class="p">,</span><span class="n">dist_neighbors</span><span class="p">,</span><span class="n">spectrum</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

    <span class="c1"># Hyper-parameters</span>
    <span class="n">gamma</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">lambd</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">w1</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="c1"># Positivity or positive simplex constraint</span>
    <span class="n">w2</span> <span class="o">=</span> <span class="mi">1</span><span class="o">-</span><span class="n">w1</span> <span class="c1"># Sparsity</span>

    <span class="c1"># Init</span>
    <span class="n">shap</span> <span class="o">=</span> <span class="n">obs_psf</span><span class="o">.</span><span class="n">shape</span>
    <span class="k">if</span> <span class="n">Px</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="nb">print</span> <span class="s2">&quot;Initializing the transport plan...&quot;</span>
        <span class="n">Px</span> <span class="o">=</span> <span class="n">diagonally_dominated_mat</span><span class="p">(</span><span class="n">shap</span><span class="p">,</span><span class="n">sig</span><span class="o">=</span><span class="n">supp_rad</span><span class="p">,</span><span class="n">thresh_en</span><span class="o">=</span><span class="n">thresh_en</span><span class="p">,</span><span class="n">coord_map</span><span class="o">=</span><span class="n">coord_map</span><span class="p">,</span><span class="n">pol_en</span><span class="o">=</span><span class="n">pol_en</span><span class="p">,</span><span class="n">cent</span><span class="o">=</span><span class="n">cent</span><span class="p">,</span><span class="n">theta_param</span><span class="o">=</span><span class="n">theta_param</span><span class="p">,</span><span class="n">pol_mod</span><span class="o">=</span><span class="n">pol_mod</span><span class="p">)</span>
        <span class="nb">print</span> <span class="s2">&quot;Done.&quot;</span>
    <span class="n">Pz1</span> <span class="o">=</span> <span class="n">w1</span><span class="o">*</span><span class="n">Px</span>
    <span class="n">Pz2</span> <span class="o">=</span> <span class="n">w2</span><span class="o">*</span><span class="n">Px</span>

    <span class="k">if</span> <span class="n">t</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">t</span> <span class="o">=</span> <span class="p">(</span><span class="n">wavelengths</span><span class="o">-</span><span class="n">wavelengths</span><span class="o">.</span><span class="n">min</span><span class="p">())</span><span class="o">/</span><span class="p">(</span><span class="n">wavelengths</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">-</span><span class="n">wavelengths</span><span class="o">.</span><span class="n">min</span><span class="p">())</span>
    <span class="k">if</span> <span class="n">supp</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">supp</span> <span class="o">=</span> <span class="n">transpose</span><span class="p">(</span><span class="n">array</span><span class="p">(</span><span class="n">where</span><span class="p">(</span><span class="n">Px</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">)))</span>
    <span class="k">if</span> <span class="n">neighbors_graph</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="nb">print</span> <span class="s2">&quot;Creating the displacement architecture...&quot;</span>
        <span class="n">shap</span> <span class="o">=</span> <span class="n">obs_psf</span><span class="o">.</span><span class="n">shape</span>
        <span class="n">neighbors_graph</span><span class="p">,</span><span class="n">dist_neighbors</span><span class="p">,</span><span class="n">cent</span><span class="p">,</span><span class="n">coord_map</span><span class="p">,</span><span class="n">knn</span> <span class="o">=</span> <span class="n">full_displacement</span><span class="p">(</span><span class="n">shap</span><span class="p">,</span><span class="n">supp</span><span class="p">,</span><span class="n">t</span><span class="p">,</span><span class="n">pol_en</span><span class="o">=</span><span class="n">pol_en</span><span class="p">,</span><span class="n">cent</span><span class="o">=</span><span class="n">cent</span><span class="p">,</span><span class="n">theta_param</span><span class="o">=</span><span class="n">theta_param</span><span class="p">,</span><span class="n">pol_mod</span><span class="o">=</span><span class="n">pol_mod</span><span class="p">,</span><span class="n">coord_map</span><span class="o">=</span><span class="n">coord_map</span><span class="p">,</span><span class="n">knn</span><span class="o">=</span><span class="n">knn</span><span class="p">)</span>
        <span class="nb">print</span> <span class="s2">&quot;Done.&quot;</span>
    <span class="n">i</span><span class="o">=</span><span class="mi">0</span>
    <span class="n">rel_var</span> <span class="o">=</span> <span class="mi">100</span>

    <span class="c1"># Noise estimation</span>


    <span class="k">if</span> <span class="n">noise_map</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">grad_en</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
        <span class="nb">print</span> <span class="s2">&quot;Noise map setting...&quot;</span>
        <span class="n">sig</span><span class="p">,</span><span class="n">filt</span> <span class="o">=</span> <span class="n">im_gauss_nois_est</span><span class="p">(</span><span class="n">obs_psf</span><span class="p">)</span>
        <span class="n">noise_map</span> <span class="o">=</span> <span class="n">transport_plan_noise_map</span><span class="p">(</span><span class="n">spectrum</span><span class="p">,</span><span class="n">supp</span><span class="p">,</span><span class="n">neighbors_graph</span><span class="p">,</span><span class="n">dist_neighbors</span><span class="p">,</span><span class="n">shap</span><span class="p">)</span><span class="o">*</span><span class="n">sig</span>
        <span class="nb">print</span> <span class="s2">&quot;Done.&quot;</span>

    <span class="c1"># Spectral radius estmation</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">pwr_meth_en</span> <span class="ow">or</span> <span class="n">spec_rad</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">line_search</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">mult_update</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">spec_rad</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="nb">input</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
            <span class="nb">input</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Px</span><span class="p">)</span>
            <span class="nb">input</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">shap</span><span class="p">)</span>
            <span class="nb">input</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">supp</span><span class="p">)</span>
            <span class="nb">input</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">neighbors_graph</span><span class="p">)</span>
            <span class="nb">input</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dist_neighbors</span><span class="p">)</span>
            <span class="nb">input</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">spectrum</span><span class="p">)</span>
            <span class="n">vect</span><span class="p">,</span><span class="n">spec_rad</span> <span class="o">=</span> <span class="n">pow_meth</span><span class="p">(</span><span class="n">pwr_mth_transpose</span><span class="p">,</span><span class="nb">input</span><span class="p">,</span><span class="n">Px</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span><span class="n">tol</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span><span class="n">ainit</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">nb_iter_max</span><span class="o">=</span><span class="mi">30</span><span class="p">)</span>
            <span class="nb">print</span> <span class="s2">&quot;Spectral radius: &quot;</span><span class="p">,</span><span class="n">spec_rad</span>
        <span class="n">mu</span><span class="o">/=</span><span class="n">spec_rad</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">mu</span><span class="o">/=</span> <span class="n">size</span><span class="p">(</span><span class="n">obs_psf</span><span class="p">)</span><span class="o">*</span><span class="nb">sum</span><span class="p">(</span><span class="n">spectrum</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>


    <span class="nb">print</span> <span class="s2">&quot;Main loop:&quot;</span>

    <span class="n">nb_samp</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">supp</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">rand_frac</span><span class="p">)</span>
    <span class="k">while</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">nb_iter</span> <span class="ow">and</span> <span class="n">rel_var</span><span class="o">&gt;</span><span class="n">tol</span><span class="p">:</span>
        <span class="c1">#ind_i = choice(supp.shape[0],nb_samp)</span>
        <span class="c1">#print ind_i</span>
        <span class="n">ind_i</span> <span class="o">=</span> <span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">supp</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="nb">print</span> <span class="s2">&quot;iter &quot;</span><span class="p">,</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="s2">&quot;/&quot;</span><span class="p">,</span><span class="n">nb_iter</span>
        <span class="n">err</span> <span class="o">=</span> <span class="n">obs_psf</span> <span class="o">-</span> <span class="n">transport_plan_projections</span><span class="p">(</span><span class="n">Px</span><span class="p">,</span><span class="n">shap</span><span class="p">,</span><span class="n">supp</span><span class="p">[</span><span class="n">ind_i</span><span class="p">,:],</span><span class="n">neighbors_graph</span><span class="p">[</span><span class="n">ind_i</span><span class="p">,:,:,:],</span><span class="n">dist_neighbors</span><span class="p">[</span><span class="n">ind_i</span><span class="p">,:,:],</span><span class="n">spectrum</span><span class="o">=</span><span class="n">spectrum</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="nb">print</span> <span class="s2">&quot;Error: &quot;</span><span class="p">,</span><span class="n">norm</span><span class="p">(</span><span class="n">err</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span>
        <span class="nb">print</span> <span class="s2">&quot;Cost function: &quot;</span><span class="p">,</span><span class="mf">0.5</span><span class="o">*</span><span class="n">norm</span><span class="p">(</span><span class="n">err</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="nb">sum</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">Px</span><span class="o">*</span><span class="n">noise_map</span><span class="o">*</span><span class="n">nsig</span><span class="p">))</span>
        <span class="n">Pxold</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">Px</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">mult_update</span><span class="p">:</span>
            <span class="n">temp</span> <span class="o">=</span> <span class="n">transport_plan_projections_transpose</span><span class="p">(</span><span class="n">transport_plan_projections</span><span class="p">(</span><span class="n">Px</span><span class="p">,</span><span class="n">shap</span><span class="p">,</span><span class="n">supp</span><span class="p">[</span><span class="n">ind_i</span><span class="p">,:],</span>\
            <span class="n">neighbors_graph</span><span class="p">[</span><span class="n">ind_i</span><span class="p">,:,:,:],</span><span class="n">dist_neighbors</span><span class="p">[</span><span class="n">ind_i</span><span class="p">,:,:],</span><span class="n">spectrum</span><span class="o">=</span><span class="n">spectrum</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">),</span><span class="n">supp</span><span class="p">,</span><span class="n">neighbors_graph</span><span class="p">,</span><span class="n">dist_neighbors</span><span class="p">,</span><span class="n">spectrum</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
            <span class="n">ind</span> <span class="o">=</span> <span class="n">where</span><span class="p">(</span><span class="n">temp</span><span class="p">[</span><span class="n">supp</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span><span class="n">supp</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]]</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">Px</span><span class="p">[</span><span class="n">supp</span><span class="p">[</span><span class="n">ind_i</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span><span class="n">supp</span><span class="p">[</span><span class="n">ind_i</span><span class="p">,</span><span class="mi">1</span><span class="p">]]</span><span class="o">*=</span> <span class="n">tObs</span><span class="p">[</span><span class="n">supp</span><span class="p">[</span><span class="n">ind_i</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span><span class="n">supp</span><span class="p">[</span><span class="n">ind_i</span><span class="p">,</span><span class="mi">1</span><span class="p">]]</span><span class="o">/</span><span class="n">temp</span><span class="p">[</span><span class="n">supp</span><span class="p">[</span><span class="n">ind_i</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span><span class="n">supp</span><span class="p">[</span><span class="n">ind_i</span><span class="p">,</span><span class="mi">1</span><span class="p">]]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">grad</span> <span class="o">=</span> <span class="o">-</span><span class="n">transport_plan_projections_transpose</span><span class="p">(</span><span class="n">err</span><span class="p">,</span><span class="n">supp</span><span class="p">[</span><span class="n">ind_i</span><span class="p">,:],</span><span class="n">neighbors_graph</span><span class="p">[</span><span class="n">ind_i</span><span class="p">,:,:,:],</span><span class="n">dist_neighbors</span><span class="p">[</span><span class="n">ind_i</span><span class="p">,:,:],</span><span class="n">spectrum</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">line_search</span><span class="p">:</span>
                <span class="n">tGrad</span> <span class="o">=</span> <span class="n">transport_plan_projections</span><span class="p">(</span><span class="n">grad</span><span class="p">,</span><span class="n">shap</span><span class="p">,</span><span class="n">supp</span><span class="p">[</span><span class="n">ind_i</span><span class="p">,:],</span><span class="n">neighbors_graph</span><span class="p">[</span><span class="n">ind_i</span><span class="p">,:,:,:],</span><span class="n">dist_neighbors</span><span class="p">[</span><span class="n">ind_i</span><span class="p">,:,:],</span><span class="n">spectrum</span><span class="o">=</span><span class="n">spectrum</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
                <span class="n">mu</span> <span class="o">=</span> <span class="o">-</span><span class="nb">sum</span><span class="p">(</span><span class="n">err</span><span class="o">*</span><span class="n">tGrad</span><span class="p">)</span><span class="o">/</span><span class="nb">sum</span><span class="p">(</span><span class="n">tGrad</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">grad_en</span><span class="p">:</span>
                <span class="n">Px</span> <span class="o">-=</span> <span class="n">mu</span><span class="o">*</span><span class="n">gamma</span><span class="o">*</span><span class="n">grad</span>
                <span class="n">Px</span> <span class="o">=</span> <span class="n">pos_proj_mat</span><span class="p">(</span><span class="n">Px</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Positivity constraint</span>
                <span class="n">temp</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">Px</span> <span class="o">-</span> <span class="n">Pz1</span> <span class="o">-</span> <span class="n">mu</span><span class="o">*</span><span class="n">gamma</span><span class="o">*</span><span class="n">grad</span>
                <span class="k">if</span> <span class="n">simplex_en</span><span class="p">:</span>
                    <span class="n">Pz1</span> <span class="o">+=</span> <span class="n">lambd</span><span class="o">*</span><span class="p">(</span><span class="n">euclidean_proj_simplex</span><span class="p">(</span><span class="n">temp</span><span class="o">.</span><span class="n">reshape</span><span class="p">(((</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span><span class="p">,)),</span><span class="n">s</span><span class="o">=</span><span class="n">mass</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span><span class="o">-</span><span class="n">Px</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">Pz1</span> <span class="o">+=</span> <span class="n">lambd</span><span class="o">*</span><span class="p">(</span><span class="n">pos_proj_mat</span><span class="p">(</span><span class="n">temp</span><span class="p">)</span><span class="o">-</span><span class="n">Px</span><span class="p">)</span>


                <span class="c1"># Sparsity constraint</span>
                <span class="n">temp</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">Px</span> <span class="o">-</span> <span class="n">Pz2</span> <span class="o">-</span> <span class="n">mu</span><span class="o">*</span><span class="n">gamma</span><span class="o">*</span><span class="n">grad</span>
                <span class="n">Pz2</span> <span class="o">+=</span> <span class="n">lambd</span><span class="o">*</span><span class="p">(</span><span class="n">thresholding</span><span class="p">(</span><span class="n">temp</span><span class="p">,</span><span class="n">noise_map</span><span class="o">*</span><span class="n">nsig</span><span class="o">*</span><span class="n">mu</span><span class="o">*</span><span class="n">gamma</span><span class="o">/</span><span class="n">w2</span><span class="p">,</span><span class="n">thresh_type</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">-</span><span class="n">Px</span><span class="p">)</span>

                <span class="n">Pxold</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">Px</span><span class="p">)</span>
                <span class="c1">#Px = w1*Pz1+w2*Pz2+w3*Pz3</span>
                <span class="n">Px</span> <span class="o">=</span> <span class="n">w1</span><span class="o">*</span><span class="n">Pz1</span><span class="o">+</span><span class="n">w2</span><span class="o">*</span><span class="n">Pz2</span>
        <span class="n">rel_var</span> <span class="o">=</span> <span class="mi">100</span><span class="o">*</span><span class="n">norm</span><span class="p">(</span><span class="n">Px</span><span class="o">-</span><span class="n">Pxold</span><span class="p">)</span><span class="o">/</span><span class="n">norm</span><span class="p">(</span><span class="n">Px</span><span class="p">)</span>
        <span class="n">i</span><span class="o">+=</span><span class="mi">1</span>
    <span class="nb">print</span> <span class="s2">&quot;Done.&quot;</span>

    <span class="k">return</span> <span class="n">transport_plan_projections</span><span class="p">(</span><span class="n">Px</span><span class="p">,</span><span class="n">shap</span><span class="p">,</span><span class="n">supp</span><span class="p">,</span><span class="n">neighbors_graph</span><span class="p">,</span><span class="n">dist_neighbors</span><span class="p">),</span><span class="n">Px</span><span class="p">,</span><span class="n">err</span><span class="p">,</span><span class="n">spec_rad</span>

<span class="k">def</span> <span class="nf">bar_1d_2d</span><span class="p">(</span><span class="n">bar</span><span class="p">,</span><span class="n">shap</span><span class="p">,</span><span class="n">pol_en</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">scale_coeffr</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">scale_coefft</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">tol</span><span class="o">=</span><span class="mf">0.001</span><span class="p">,</span><span class="n">cent</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">target_pos</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>

    <span class="n">im_out</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">(</span><span class="n">shap</span><span class="p">)</span>
    <span class="n">ind</span> <span class="o">=</span> <span class="n">argsort</span><span class="p">(</span><span class="n">bar</span><span class="p">[</span><span class="mi">0</span><span class="p">,:])</span>
    <span class="n">total</span> <span class="o">=</span> <span class="n">bar</span><span class="p">[</span><span class="mi">0</span><span class="p">,:]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">total</span>
    <span class="n">ind</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">bar</span><span class="p">[</span><span class="mi">0</span><span class="p">,:])</span>
    <span class="n">psf_interp</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">(</span><span class="n">shap</span><span class="p">)</span>
    <span class="n">l</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
    <span class="k">while</span> <span class="n">l</span><span class="o">&gt;-</span><span class="p">(</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="ow">and</span> <span class="n">res</span><span class="o">&gt;</span><span class="n">total</span><span class="o">*</span><span class="n">tol</span><span class="p">:</span>
        <span class="n">indP</span> <span class="o">=</span> <span class="n">ind</span><span class="p">[</span><span class="n">l</span><span class="p">]</span>
        <span class="n">l</span><span class="o">-=</span><span class="mi">1</span>
        <span class="n">indPl</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">indP</span><span class="o">/</span><span class="p">(</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
        <span class="n">indPc</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">indP</span><span class="o">%</span><span class="p">(</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
        <span class="n">interp_pos</span> <span class="o">=</span> <span class="n">array</span><span class="p">([</span><span class="n">bar</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="n">ind</span><span class="p">[</span><span class="n">l</span><span class="p">]],</span><span class="n">bar</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="n">ind</span><span class="p">[</span><span class="n">l</span><span class="p">]]])</span>
        <span class="n">mass</span> <span class="o">=</span> <span class="n">bar</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">ind</span><span class="p">[</span><span class="n">l</span><span class="p">]]</span>
        <span class="k">if</span> <span class="n">pol_en</span><span class="p">:</span>
            <span class="n">iopt</span> <span class="o">=</span> <span class="n">cent</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">jopt</span> <span class="o">=</span> <span class="n">cent</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

            <span class="k">if</span> <span class="n">interp_pos</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
                <span class="n">iopt</span> <span class="o">=</span> <span class="p">(</span><span class="n">interp_pos</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="n">scale_coeffr</span><span class="p">)</span><span class="o">*</span><span class="n">cos</span><span class="p">(</span><span class="n">scale_coeffr</span><span class="o">*</span><span class="n">interp_pos</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="p">(</span><span class="n">scale_coefft</span><span class="o">*</span><span class="n">interp_pos</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span><span class="o">+</span><span class="n">cent</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">iopt</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">iopt</span><span class="p">),</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">jopt</span> <span class="o">=</span> <span class="p">(</span><span class="n">interp_pos</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="n">scale_coeffr</span><span class="p">)</span><span class="o">*</span><span class="n">sin</span><span class="p">(</span><span class="n">scale_coeffr</span><span class="o">*</span><span class="n">interp_pos</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="p">(</span><span class="n">scale_coefft</span><span class="o">*</span><span class="n">interp_pos</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span><span class="o">+</span><span class="n">cent</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">jopt</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">jopt</span><span class="p">),</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>

            <span class="c1">#print np.int(iopt),np.int(jopt)</span>
            <span class="n">iopt1</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">int</span><span class="p">(</span><span class="n">iopt</span><span class="p">)),</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">jopt1</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">int</span><span class="p">(</span><span class="n">jopt</span><span class="p">)),</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">iopt1</span><span class="o">==</span><span class="n">iopt</span> <span class="ow">and</span> <span class="n">jopt1</span><span class="o">==</span><span class="n">jopt</span><span class="p">:</span>
                <span class="n">psf_interp</span><span class="p">[</span><span class="n">iopt1</span><span class="p">,</span><span class="n">jopt1</span><span class="p">]</span><span class="o">+=</span><span class="n">mass</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="n">iopt2</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">int</span><span class="p">(</span><span class="n">iopt1</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">jopt2</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">int</span><span class="p">(</span><span class="n">jopt1</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">iopt</span><span class="o">==</span><span class="n">iopt1</span><span class="p">:</span>
                    <span class="n">d1</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">jopt</span><span class="o">-</span><span class="n">jopt1</span><span class="p">)</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
                    <span class="n">d2</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">jopt</span><span class="o">-</span><span class="n">jopt2</span><span class="p">)</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
                    <span class="n">d</span> <span class="o">=</span> <span class="n">d1</span><span class="o">+</span><span class="n">d2</span>
                    <span class="n">psf_interp</span><span class="p">[</span><span class="n">iopt1</span><span class="p">,</span><span class="n">jopt1</span><span class="p">]</span><span class="o">+=</span><span class="n">d1</span><span class="o">*</span><span class="n">mass</span><span class="o">/</span><span class="n">d</span>
                    <span class="n">psf_interp</span><span class="p">[</span><span class="n">iopt1</span><span class="p">,</span><span class="n">jopt2</span><span class="p">]</span><span class="o">+=</span><span class="n">d2</span><span class="o">*</span><span class="n">mass</span><span class="o">/</span><span class="n">d</span>
                <span class="k">elif</span> <span class="n">jopt</span><span class="o">==</span><span class="n">jopt1</span><span class="p">:</span>
                    <span class="n">d1</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">iopt</span><span class="o">-</span><span class="n">iopt1</span><span class="p">)</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
                    <span class="n">d2</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">iopt</span><span class="o">-</span><span class="n">iopt2</span><span class="p">)</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
                    <span class="n">d</span> <span class="o">=</span> <span class="n">d1</span><span class="o">+</span><span class="n">d2</span>
                    <span class="n">psf_interp</span><span class="p">[</span><span class="n">iopt1</span><span class="p">,</span><span class="n">jopt1</span><span class="p">]</span><span class="o">+=</span><span class="n">d1</span><span class="o">*</span><span class="n">mass</span><span class="o">/</span><span class="n">d</span>
                    <span class="n">psf_interp</span><span class="p">[</span><span class="n">iopt2</span><span class="p">,</span><span class="n">jopt1</span><span class="p">]</span><span class="o">+=</span><span class="n">d2</span><span class="o">*</span><span class="n">mass</span><span class="o">/</span><span class="n">d</span>

                <span class="k">else</span><span class="p">:</span>
                    <span class="n">d1</span> <span class="o">=</span> <span class="n">sqrt</span><span class="p">((</span><span class="n">iopt</span><span class="o">-</span><span class="n">iopt1</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="p">(</span><span class="n">jopt</span><span class="o">-</span><span class="n">jopt1</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
                    <span class="n">d2</span> <span class="o">=</span> <span class="n">sqrt</span><span class="p">((</span><span class="n">iopt</span><span class="o">-</span><span class="n">iopt1</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="p">(</span><span class="n">jopt</span><span class="o">-</span><span class="n">jopt2</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
                    <span class="n">d3</span> <span class="o">=</span> <span class="n">sqrt</span><span class="p">((</span><span class="n">iopt</span><span class="o">-</span><span class="n">iopt2</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="p">(</span><span class="n">jopt</span><span class="o">-</span><span class="n">jopt1</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
                    <span class="n">d4</span> <span class="o">=</span> <span class="n">sqrt</span><span class="p">((</span><span class="n">iopt</span><span class="o">-</span><span class="n">iopt2</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="p">(</span><span class="n">jopt</span><span class="o">-</span><span class="n">jopt2</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
                    <span class="n">d</span> <span class="o">=</span> <span class="n">d1</span><span class="o">+</span><span class="n">d2</span><span class="o">+</span><span class="n">d3</span><span class="o">+</span><span class="n">d4</span>
                    <span class="n">psf_interp</span><span class="p">[</span><span class="n">iopt1</span><span class="p">,</span><span class="n">jopt1</span><span class="p">]</span><span class="o">+=</span><span class="n">d1</span><span class="o">*</span><span class="n">mass</span><span class="o">/</span><span class="n">d</span>
                    <span class="n">psf_interp</span><span class="p">[</span><span class="n">iopt1</span><span class="p">,</span><span class="n">jopt2</span><span class="p">]</span><span class="o">+=</span><span class="n">d2</span><span class="o">*</span><span class="n">mass</span><span class="o">/</span><span class="n">d</span>
                    <span class="n">psf_interp</span><span class="p">[</span><span class="n">iopt2</span><span class="p">,</span><span class="n">jopt1</span><span class="p">]</span><span class="o">+=</span><span class="n">d3</span><span class="o">*</span><span class="n">mass</span><span class="o">/</span><span class="n">d</span>
                    <span class="n">psf_interp</span><span class="p">[</span><span class="n">iopt2</span><span class="p">,</span><span class="n">jopt2</span><span class="p">]</span><span class="o">+=</span><span class="n">d4</span><span class="o">*</span><span class="n">mass</span><span class="o">/</span><span class="n">d</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ind_im</span> <span class="o">=</span> <span class="n">interp_pos</span><span class="o">+</span><span class="n">array</span><span class="p">([</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span><span class="o">/</span><span class="mi">2</span><span class="o">-</span><span class="n">target_pos</span>

            <span class="n">ind_im</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">ind_im</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">)))</span>
            <span class="n">ind_im</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">ind_im</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">)))</span>
            <span class="n">psf_interp</span><span class="p">[</span><span class="n">ind_im</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">ind_im</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">+=</span> <span class="n">mass</span>

        <span class="n">res</span> <span class="o">-=</span> <span class="n">mass</span>
    <span class="c1">#print abs(l),&quot;/&quot;,shap[0]*shap[1]</span>
    <span class="k">return</span> <span class="n">psf_interp</span>

<span class="k">def</span> <span class="nf">bar_1d_2d_bis</span><span class="p">(</span><span class="n">bar_in</span><span class="p">,</span><span class="n">shap</span><span class="p">,</span><span class="n">cent</span><span class="p">,</span><span class="n">pol_en</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">log_param</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">tol</span><span class="o">=</span><span class="mf">0.000000000000000000001</span><span class="p">,</span><span class="n">target_pos</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">tol_num</span><span class="o">=</span><span class="mf">2.0</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mi">62</span><span class="p">)):</span>
    <span class="kn">from</span> <span class="nn">numpy</span> <span class="k">import</span> <span class="n">exp</span><span class="p">,</span><span class="n">argsort</span>
    <span class="n">bar</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">bar_in</span><span class="p">)</span>

    <span class="n">total</span> <span class="o">=</span> <span class="n">bar</span><span class="p">[</span><span class="mi">2</span><span class="p">,:]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">total</span>
    <span class="n">ind</span> <span class="o">=</span> <span class="n">argsort</span><span class="p">(</span><span class="n">bar</span><span class="p">[</span><span class="mi">2</span><span class="p">,:])</span>
    <span class="n">psf_interp</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">(</span><span class="n">shap</span><span class="p">)</span>
    <span class="n">l</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
    <span class="k">while</span> <span class="n">l</span><span class="o">&gt;-</span><span class="p">(</span><span class="n">bar</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="ow">and</span> <span class="n">res</span><span class="o">&gt;</span><span class="n">total</span><span class="o">*</span><span class="n">tol</span><span class="p">:</span>

        <span class="n">interp_pos</span> <span class="o">=</span> <span class="n">array</span><span class="p">([</span><span class="n">bar</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">ind</span><span class="p">[</span><span class="n">l</span><span class="p">]],</span><span class="n">bar</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="n">ind</span><span class="p">[</span><span class="n">l</span><span class="p">]]])</span>
        <span class="n">mass</span> <span class="o">=</span> <span class="n">bar</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="n">ind</span><span class="p">[</span><span class="n">l</span><span class="p">]]</span>
        <span class="n">iopt</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">jopt</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="sd">&quot;&quot;&quot;if pol_en:</span>
<span class="sd">            iopt = cent[0]</span>
<span class="sd">            jopt = cent[1]</span>

<span class="sd">            if bar[1,ind[l]]&gt;0:</span>
<span class="sd">                iopt = bar[1,ind[l]]*cos(bar[2,ind[l]]/bar[1,ind[l]])+cent[0]</span>
<span class="sd">                iopt = min(max(0,iopt),shap[0]-1)</span>
<span class="sd">                jopt = bar[1,ind[l]]*sin(bar[2,ind[l]]/bar[1,ind[l]])+cent[1]</span>
<span class="sd">                jopt = min(max(0,jopt),shap[1]-1)</span>
<span class="sd">        else:&quot;&quot;&quot;</span>
        <span class="n">iopt</span> <span class="o">=</span> <span class="n">bar</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">ind</span><span class="p">[</span><span class="n">l</span><span class="p">]]</span>
        <span class="n">jopt</span> <span class="o">=</span> <span class="n">bar</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="n">ind</span><span class="p">[</span><span class="n">l</span><span class="p">]]</span>

        <span class="c1">#print iopt,jopt</span>
        <span class="n">iopt1</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">int</span><span class="p">(</span><span class="n">iopt</span><span class="p">)),</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">jopt1</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">int</span><span class="p">(</span><span class="n">jopt</span><span class="p">)),</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">iopt1</span><span class="o">-</span><span class="n">iopt</span><span class="p">)</span><span class="o">&lt;</span><span class="n">tol_num</span> <span class="ow">and</span> <span class="nb">abs</span><span class="p">(</span><span class="n">jopt1</span><span class="o">-</span><span class="n">jopt</span><span class="p">)</span><span class="o">&lt;</span><span class="n">tol_num</span><span class="p">:</span>
            <span class="n">psf_interp</span><span class="p">[</span><span class="n">iopt1</span><span class="p">,</span><span class="n">jopt1</span><span class="p">]</span><span class="o">+=</span><span class="n">mass</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">iopt2</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">int</span><span class="p">(</span><span class="n">iopt1</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">jopt2</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">int</span><span class="p">(</span><span class="n">jopt1</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">iopt</span><span class="o">-</span><span class="n">iopt1</span><span class="p">)</span><span class="o">&lt;</span><span class="n">tol_num</span><span class="p">:</span>
                <span class="n">d1</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">jopt</span><span class="o">-</span><span class="n">jopt1</span><span class="p">)</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">d2</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">jopt</span><span class="o">-</span><span class="n">jopt2</span><span class="p">)</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">d</span> <span class="o">=</span> <span class="n">d1</span><span class="o">+</span><span class="n">d2</span>
                <span class="n">psf_interp</span><span class="p">[</span><span class="n">iopt1</span><span class="p">,</span><span class="n">jopt1</span><span class="p">]</span><span class="o">+=</span><span class="n">d1</span><span class="o">*</span><span class="n">mass</span><span class="o">/</span><span class="n">d</span>
                <span class="n">psf_interp</span><span class="p">[</span><span class="n">iopt1</span><span class="p">,</span><span class="n">jopt2</span><span class="p">]</span><span class="o">+=</span><span class="n">d2</span><span class="o">*</span><span class="n">mass</span><span class="o">/</span><span class="n">d</span>
            <span class="k">elif</span> <span class="nb">abs</span><span class="p">(</span><span class="n">jopt</span><span class="o">-</span><span class="n">jopt1</span><span class="p">)</span><span class="o">&lt;</span><span class="n">tol_num</span><span class="p">:</span>
                <span class="n">d1</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">iopt</span><span class="o">-</span><span class="n">iopt1</span><span class="p">)</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">d2</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">iopt</span><span class="o">-</span><span class="n">iopt2</span><span class="p">)</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">d</span> <span class="o">=</span> <span class="n">d1</span><span class="o">+</span><span class="n">d2</span>
                <span class="n">psf_interp</span><span class="p">[</span><span class="n">iopt1</span><span class="p">,</span><span class="n">jopt1</span><span class="p">]</span><span class="o">+=</span><span class="n">d1</span><span class="o">*</span><span class="n">mass</span><span class="o">/</span><span class="n">d</span>
                <span class="n">psf_interp</span><span class="p">[</span><span class="n">iopt2</span><span class="p">,</span><span class="n">jopt1</span><span class="p">]</span><span class="o">+=</span><span class="n">d2</span><span class="o">*</span><span class="n">mass</span><span class="o">/</span><span class="n">d</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="n">d1</span> <span class="o">=</span> <span class="n">sqrt</span><span class="p">((</span><span class="n">iopt</span><span class="o">-</span><span class="n">iopt1</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="p">(</span><span class="n">jopt</span><span class="o">-</span><span class="n">jopt1</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">d2</span> <span class="o">=</span> <span class="n">sqrt</span><span class="p">((</span><span class="n">iopt</span><span class="o">-</span><span class="n">iopt1</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="p">(</span><span class="n">jopt</span><span class="o">-</span><span class="n">jopt2</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">d3</span> <span class="o">=</span> <span class="n">sqrt</span><span class="p">((</span><span class="n">iopt</span><span class="o">-</span><span class="n">iopt2</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="p">(</span><span class="n">jopt</span><span class="o">-</span><span class="n">jopt1</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">d4</span> <span class="o">=</span> <span class="n">sqrt</span><span class="p">((</span><span class="n">iopt</span><span class="o">-</span><span class="n">iopt2</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="p">(</span><span class="n">jopt</span><span class="o">-</span><span class="n">jopt2</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">d</span> <span class="o">=</span> <span class="n">d1</span><span class="o">+</span><span class="n">d2</span><span class="o">+</span><span class="n">d3</span><span class="o">+</span><span class="n">d4</span>
                <span class="n">psf_interp</span><span class="p">[</span><span class="n">iopt1</span><span class="p">,</span><span class="n">jopt1</span><span class="p">]</span><span class="o">+=</span><span class="n">d1</span><span class="o">*</span><span class="n">mass</span><span class="o">/</span><span class="n">d</span>
                <span class="n">psf_interp</span><span class="p">[</span><span class="n">iopt1</span><span class="p">,</span><span class="n">jopt2</span><span class="p">]</span><span class="o">+=</span><span class="n">d2</span><span class="o">*</span><span class="n">mass</span><span class="o">/</span><span class="n">d</span>
                <span class="n">psf_interp</span><span class="p">[</span><span class="n">iopt2</span><span class="p">,</span><span class="n">jopt1</span><span class="p">]</span><span class="o">+=</span><span class="n">d3</span><span class="o">*</span><span class="n">mass</span><span class="o">/</span><span class="n">d</span>
                <span class="n">psf_interp</span><span class="p">[</span><span class="n">iopt2</span><span class="p">,</span><span class="n">jopt2</span><span class="p">]</span><span class="o">+=</span><span class="n">d4</span><span class="o">*</span><span class="n">mass</span><span class="o">/</span><span class="n">d</span>

        <span class="n">l</span><span class="o">-=</span><span class="mi">1</span>

        <span class="n">res</span> <span class="o">-=</span> <span class="n">mass</span>

    <span class="k">return</span> <span class="n">psf_interp</span>




<span class="k">def</span> <span class="nf">displacement_interp_stack</span><span class="p">(</span><span class="n">P</span><span class="p">,</span><span class="n">t</span><span class="p">,</span><span class="n">shap</span><span class="p">,</span><span class="n">position_map_1</span><span class="p">,</span><span class="n">position_map_2</span><span class="p">,</span><span class="n">tol</span><span class="o">=</span><span class="mf">0.001</span><span class="p">,</span><span class="n">pol_en</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">cent</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">scale_coefft</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">scale_coeffr</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="n">nb_im</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
    <span class="n">psf_interp</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">nb_im</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_im</span><span class="p">):</span>
        <span class="nb">print</span> <span class="s2">&quot;Image &quot;</span><span class="p">,</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="s2">&quot;/&quot;</span><span class="p">,</span><span class="n">nb_im</span>
        <span class="k">if</span> <span class="n">pol_en</span><span class="p">:</span>
            <span class="n">psf_interp</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">displacement_interp_pol_2</span><span class="p">(</span><span class="n">P</span><span class="p">,</span><span class="n">t</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">shap</span><span class="p">,</span><span class="n">position_map_1</span><span class="p">,</span><span class="n">position_map_2</span><span class="p">,</span><span class="n">cent</span><span class="p">,</span><span class="n">scale_coefft</span><span class="p">,</span><span class="n">scale_coeffr</span><span class="p">,</span><span class="n">tol</span><span class="o">=</span><span class="n">tol</span><span class="p">,</span><span class="n">var_speed</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">psf_interp</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">displacement_interp</span><span class="p">(</span><span class="n">P</span><span class="p">,</span><span class="n">t</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">shap</span><span class="p">,</span><span class="n">position_map_1</span><span class="p">,</span><span class="n">position_map_2</span><span class="p">,</span><span class="n">tol</span><span class="o">=</span><span class="n">tol</span><span class="p">,</span><span class="n">var_speed</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">psf_interp</span>

<span class="k">def</span> <span class="nf">displacement_interp_stack_2</span><span class="p">(</span><span class="n">im_ref</span><span class="p">,</span><span class="n">im_proj</span><span class="p">,</span><span class="n">t</span><span class="p">,</span><span class="n">pos_map</span><span class="p">,</span><span class="n">final_pos</span><span class="p">,</span><span class="n">tol</span><span class="o">=</span><span class="mf">0.001</span><span class="p">,</span><span class="n">pol_en</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">cent</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">scale_coefft</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">scale_coeffr</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="n">nb_im</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
    <span class="n">shap</span> <span class="o">=</span> <span class="n">im_ref</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">psf_interp</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">nb_im</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_im</span><span class="p">):</span>
        <span class="nb">print</span> <span class="s2">&quot;Image &quot;</span><span class="p">,</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="s2">&quot;/&quot;</span><span class="p">,</span><span class="n">nb_im</span>
        <span class="k">if</span> <span class="n">pol_en</span><span class="p">:</span>
            <span class="n">psf_interp</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">displacement_interp_pol_3</span><span class="p">(</span><span class="n">im_ref</span><span class="p">,</span><span class="n">im_proj</span><span class="p">,</span><span class="n">t</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">pos_map</span><span class="p">,</span><span class="n">final_pos</span><span class="p">,</span><span class="n">cent</span><span class="p">,</span><span class="n">scale_coefft</span><span class="p">,</span><span class="n">scale_coeffr</span><span class="p">,</span><span class="n">tol</span><span class="o">=</span><span class="mf">0.001</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">psf_interp</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">displacement_interp_2</span><span class="p">(</span><span class="n">P</span><span class="p">,</span><span class="n">t</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">shap</span><span class="p">,</span><span class="n">position_map_1</span><span class="p">,</span><span class="n">position_map_2</span><span class="p">,</span><span class="n">tol</span><span class="o">=</span><span class="n">tol</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">psf_interp</span>



<span class="k">def</span> <span class="nf">partial_transport_3</span><span class="p">(</span><span class="n">P</span><span class="p">,</span><span class="n">t</span><span class="p">,</span><span class="n">shap</span><span class="p">,</span><span class="n">tol</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">cent</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="n">psf_interp</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">(</span><span class="n">shap</span><span class="p">)</span>
    <span class="n">min_val</span> <span class="o">=</span> <span class="n">tol</span><span class="o">*</span><span class="n">P</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
    <span class="n">i</span><span class="o">=</span><span class="mi">0</span>
    <span class="n">j</span><span class="o">=</span><span class="mi">0</span>
    <span class="k">if</span> <span class="n">cent</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">cent</span> <span class="o">=</span> <span class="p">[</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
        <span class="n">i1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">int</span><span class="p">(</span><span class="n">i</span><span class="o">/</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="c1"># Line index in position_map_1</span>
        <span class="n">j1</span> <span class="o">=</span> <span class="n">mod</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">P</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">min_val</span><span class="p">):</span>
                <span class="n">i2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">int</span><span class="p">(</span><span class="n">j</span><span class="o">/</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="c1"># Line index in postion_map_2</span>
                <span class="n">j2</span> <span class="o">=</span> <span class="n">mod</span><span class="p">(</span><span class="n">j</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">i1</span><span class="o">==</span><span class="n">i2</span> <span class="ow">and</span> <span class="n">j1</span><span class="o">==</span><span class="n">j2</span><span class="p">):</span>
                    <span class="n">psf_interp</span><span class="p">[</span><span class="n">i1</span><span class="p">,</span><span class="n">j1</span><span class="p">]</span> <span class="o">=</span> <span class="n">psf_interp</span><span class="p">[</span><span class="n">i1</span><span class="p">,</span><span class="n">j1</span><span class="p">]</span> <span class="o">+</span> <span class="n">P</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span>
                <span class="k">else</span> <span class="p">:</span>
                    <span class="n">iopt</span> <span class="o">=</span> <span class="nb">round</span><span class="p">((</span><span class="mi">1</span><span class="o">-</span><span class="n">t</span><span class="p">)</span><span class="o">*</span><span class="n">i1</span><span class="o">+</span><span class="n">t</span><span class="o">*</span><span class="n">i2</span><span class="p">)</span>
                    <span class="n">jopt</span> <span class="o">=</span> <span class="nb">round</span><span class="p">((</span><span class="mi">1</span><span class="o">-</span><span class="n">t</span><span class="p">)</span><span class="o">*</span><span class="n">j1</span><span class="o">+</span><span class="n">t</span><span class="o">*</span><span class="n">j2</span><span class="p">)</span>

                    <span class="k">if</span> <span class="n">iopt</span> <span class="o">&lt;</span> <span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">and</span> <span class="n">iopt</span><span class="o">&gt;-</span><span class="mi">1</span> <span class="ow">and</span> <span class="n">jopt</span> <span class="o">&lt;</span> <span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">and</span> <span class="n">jopt</span><span class="o">&gt;-</span><span class="mi">1</span><span class="p">:</span>
                        <span class="n">psf_interp</span><span class="p">[</span><span class="n">iopt</span><span class="p">,</span><span class="n">jopt</span><span class="p">]</span> <span class="o">=</span> <span class="n">psf_interp</span><span class="p">[</span><span class="n">iopt</span><span class="p">,</span><span class="n">jopt</span><span class="p">]</span><span class="o">+</span><span class="n">P</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">psf_interp</span>



<span class="k">def</span> <span class="nf">distance_matrices</span><span class="p">(</span><span class="n">weights</span><span class="p">,</span><span class="n">angles</span><span class="p">,</span><span class="n">shap</span><span class="p">,</span><span class="n">inf_val</span><span class="o">=</span><span class="mf">1e64</span><span class="p">,</span><span class="n">cent</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="n">l</span> <span class="o">=</span> <span class="n">size</span><span class="p">(</span><span class="n">weights</span><span class="p">)</span>
    <span class="n">dist_map</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">l</span><span class="p">))</span>
    <span class="n">theta</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">weights</span><span class="o">*</span><span class="n">angles</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">l</span><span class="p">):</span>
        <span class="n">mapr</span><span class="p">,</span> <span class="n">maptheta</span> <span class="o">=</span> <span class="n">r_theta_rig_dist_map_3</span><span class="p">(</span><span class="n">shap</span><span class="p">,</span><span class="o">-</span><span class="n">theta</span><span class="o">+</span><span class="n">angles</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">inf_val</span><span class="o">=</span><span class="n">inf_val</span><span class="p">,</span><span class="n">cent</span><span class="o">=</span><span class="n">cent</span><span class="p">)</span>
        <span class="n">dist_map</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">mapr</span>
    <span class="k">return</span> <span class="n">dist_map</span>


<span class="k">def</span> <span class="nf">rbf_interp</span><span class="p">(</span><span class="n">comp_cube</span><span class="p">,</span><span class="n">coeff</span><span class="p">,</span><span class="n">pos_data</span><span class="p">,</span><span class="n">target_pos</span><span class="p">):</span>
    <span class="n">shap</span> <span class="o">=</span> <span class="n">comp_cube</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">interp_psf</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">(</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">])</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
        <span class="n">rbf</span> <span class="o">=</span> <span class="n">Rbf</span><span class="p">(</span><span class="n">pos_data</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span> <span class="n">pos_data</span><span class="p">[:,</span><span class="mi">1</span><span class="p">],</span> <span class="n">coeff</span><span class="p">[</span><span class="n">i</span><span class="p">,:],</span> <span class="n">function</span><span class="o">=</span><span class="s1">&#39;thin_plate&#39;</span><span class="p">)</span>
        <span class="n">interp_psf</span> <span class="o">+=</span> <span class="n">rbf</span><span class="p">(</span><span class="n">target_pos</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">target_pos</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">*</span><span class="n">comp_cube</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">interp_psf</span>


<span class="k">def</span> <span class="nf">rbf_3d</span><span class="p">(</span><span class="n">pos_data</span><span class="p">,</span><span class="n">values</span><span class="p">):</span>
    <span class="n">rbf_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">):</span>
        <span class="n">rbf_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Rbf</span><span class="p">(</span><span class="n">pos_data</span><span class="p">[</span><span class="mi">0</span><span class="p">,:],</span> <span class="n">pos_data</span><span class="p">[</span><span class="mi">1</span><span class="p">,:],</span> <span class="n">pos_data</span><span class="p">[</span><span class="mi">2</span><span class="p">,:],</span> <span class="n">values</span><span class="p">[</span><span class="n">i</span><span class="p">,:],</span> <span class="n">function</span><span class="o">=</span><span class="s1">&#39;thin_plate&#39;</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">rbf_list</span>

<span class="k">def</span> <span class="nf">rbf_3d_2</span><span class="p">(</span><span class="n">pos_data</span><span class="p">,</span><span class="n">flann_obj</span><span class="p">,</span><span class="n">pos_ref</span><span class="p">,</span><span class="n">data_ref</span><span class="p">,</span><span class="n">nb_neigh</span><span class="o">=</span><span class="mi">20</span><span class="p">):</span>
    <span class="n">shap</span> <span class="o">=</span> <span class="n">pos_data</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">out</span> <span class="o">=</span> <span class="n">pos_data</span><span class="o">*</span><span class="mi">0</span>
    <span class="n">result</span><span class="p">,</span> <span class="n">dists</span> <span class="o">=</span> <span class="n">flann_obj</span><span class="o">.</span><span class="n">nn_index</span><span class="p">(</span><span class="n">transpose</span><span class="p">(</span><span class="n">pos_data</span><span class="p">),</span> <span class="n">nb_neigh</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">):</span>
            <span class="n">rbf_interpij</span> <span class="o">=</span> <span class="n">Rbf</span><span class="p">(</span><span class="n">pos_ref</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">result</span><span class="p">[</span><span class="n">i</span><span class="p">,:]],</span> <span class="n">pos_ref</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="n">result</span><span class="p">[</span><span class="n">i</span><span class="p">,:]],</span> <span class="n">pos_ref</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="n">result</span><span class="p">[</span><span class="n">i</span><span class="p">,:]],</span> <span class="n">data_ref</span><span class="p">[</span><span class="n">j</span><span class="p">,</span><span class="n">result</span><span class="p">[</span><span class="n">i</span><span class="p">,:]],</span> <span class="n">function</span><span class="o">=</span><span class="s1">&#39;thin_plate&#39;</span><span class="p">)</span>
            <span class="n">out</span><span class="p">[</span><span class="n">j</span><span class="p">,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">rbf_interpij</span><span class="p">(</span><span class="n">pos_data</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">i</span><span class="p">],</span> <span class="n">pos_data</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="n">i</span><span class="p">],</span> <span class="n">pos_data</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="n">i</span><span class="p">])</span>

    <span class="k">return</span> <span class="n">out</span>


<span class="k">def</span> <span class="nf">apply_rbf_3d</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span><span class="n">rbf_list</span><span class="p">):</span>
    <span class="n">out</span> <span class="o">=</span> <span class="n">pos</span><span class="o">*</span><span class="mi">0</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">):</span>
        <span class="n">out</span><span class="p">[</span><span class="n">i</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">rbf_list</span><span class="p">[</span><span class="n">i</span><span class="p">](</span><span class="n">pos</span><span class="p">[</span><span class="mi">0</span><span class="p">,:],</span> <span class="n">pos</span><span class="p">[</span><span class="mi">1</span><span class="p">,:],</span> <span class="n">pos</span><span class="p">[</span><span class="mi">2</span><span class="p">,:])</span>
    <span class="k">return</span> <span class="n">out</span>



<span class="k">def</span> <span class="nf">rbf_stack</span><span class="p">(</span><span class="n">psf</span><span class="p">,</span><span class="n">pos_data</span><span class="p">,</span><span class="n">data_tree</span><span class="p">,</span><span class="n">dist</span><span class="p">,</span><span class="n">min_dist</span><span class="p">,</span><span class="n">nb_neighb</span><span class="p">,</span><span class="n">nb_comp</span><span class="o">=</span><span class="mi">20</span><span class="p">):</span>
    <span class="n">shap</span> <span class="o">=</span> <span class="n">psf</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">coeff</span><span class="p">,</span><span class="n">comp_cube</span><span class="p">,</span><span class="n">approx_cube</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">cube_svd</span><span class="p">(</span><span class="n">psf</span><span class="p">,</span><span class="n">nb_comp</span><span class="o">=</span><span class="n">nb_comp</span><span class="p">)</span>
    <span class="n">psf_interp</span> <span class="o">=</span> <span class="n">psf</span><span class="o">*</span><span class="mi">0</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
        <span class="nb">print</span> <span class="s2">&quot;psf &quot;</span><span class="p">,</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="s2">&quot;/&quot;</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
        <span class="n">ind0</span> <span class="o">=</span> <span class="n">where</span><span class="p">(</span><span class="n">dist</span><span class="p">[</span><span class="n">i</span><span class="p">,:]</span><span class="o">&gt;=</span><span class="n">min_dist</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        <span class="n">ind</span> <span class="o">=</span> <span class="n">data_tree</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">ind0</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">:</span><span class="n">nb_neighb</span><span class="p">]]</span>
        <span class="n">psf_interp</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">rbf_interp</span><span class="p">(</span><span class="n">comp_cube</span><span class="p">,</span><span class="n">coeff</span><span class="p">[:,</span><span class="n">ind</span><span class="p">],</span><span class="n">pos_data</span><span class="p">[</span><span class="n">ind</span><span class="p">,:],</span><span class="n">pos_data</span><span class="p">[</span><span class="n">i</span><span class="p">,:])</span>

    <span class="k">return</span> <span class="n">psf_interp</span>


<span class="k">def</span> <span class="nf">rbf_stack_2</span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="n">pos_data</span><span class="p">,</span><span class="n">target_pos</span><span class="p">,</span><span class="n">nb_neigh</span><span class="p">,</span><span class="n">nb_comp</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span><span class="n">knn</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>

    <span class="kn">from</span> <span class="nn">utils</span> <span class="k">import</span> <span class="n">cube_svd</span>
    <span class="kn">from</span> <span class="nn">pyflann</span> <span class="k">import</span> <span class="n">FLANN</span>
    <span class="kn">from</span> <span class="nn">numpy</span> <span class="k">import</span> <span class="n">zeros</span><span class="p">,</span><span class="n">transpose</span><span class="p">,</span><span class="n">diag</span>
    <span class="kn">import</span> <span class="nn">time</span>
    <span class="k">if</span> <span class="n">knn</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">knn</span> <span class="o">=</span> <span class="n">FLANN</span><span class="p">()</span>
        <span class="n">params</span> <span class="o">=</span> <span class="n">knn</span><span class="o">.</span><span class="n">build_index</span><span class="p">(</span><span class="n">array</span><span class="p">(</span><span class="n">pos_data</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">float64</span><span class="p">))</span>
    <span class="n">shap</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">nb_pts</span> <span class="o">=</span> <span class="n">target_pos</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="c1"># Computing the weights</span>
    <span class="n">result</span><span class="p">,</span> <span class="n">dists</span> <span class="o">=</span> <span class="n">knn</span><span class="o">.</span><span class="n">nn_index</span><span class="p">(</span><span class="n">target_pos</span><span class="p">,</span> <span class="n">nb_neigh</span><span class="p">)</span>
    <span class="n">coeff</span><span class="p">,</span><span class="n">comp_cube</span><span class="p">,</span><span class="n">approx_cube</span> <span class="o">=</span> <span class="n">cube_svd</span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="n">nb_comp</span><span class="o">=</span><span class="nb">min</span><span class="p">(</span><span class="n">nb_comp</span><span class="p">,</span><span class="n">nb_neigh</span><span class="p">))</span>
    <span class="n">psf_interp</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">nb_pts</span><span class="p">))</span>
    <span class="n">tmean</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_pts</span><span class="p">):</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">psf_interp</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">rbf_interp</span><span class="p">(</span><span class="n">comp_cube</span><span class="p">,</span><span class="n">coeff</span><span class="p">[:,</span><span class="n">result</span><span class="p">[</span><span class="n">i</span><span class="p">,:]],</span><span class="n">pos_data</span><span class="p">[</span><span class="n">result</span><span class="p">[</span><span class="n">i</span><span class="p">,:],:],</span><span class="n">target_pos</span><span class="p">[</span><span class="n">i</span><span class="p">,:])</span>
        <span class="n">tmean</span><span class="o">+=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">t</span>

    <span class="nb">print</span> <span class="s2">&quot;Elapsed time: &quot;</span><span class="p">,</span><span class="n">tmean</span><span class="o">/</span><span class="n">nb_pts</span>
    <span class="k">return</span> <span class="n">psf_interp</span>



<span class="k">def</span> <span class="nf">rbf_stack_2_loc</span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="n">pos_data</span><span class="p">,</span><span class="n">target_pos</span><span class="p">,</span><span class="n">nb_neigh</span><span class="p">,</span><span class="n">nb_comp</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span><span class="n">knn</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>

    <span class="kn">from</span> <span class="nn">utils</span> <span class="k">import</span> <span class="n">cube_svd</span>
    <span class="kn">from</span> <span class="nn">pyflann</span> <span class="k">import</span> <span class="n">FLANN</span>
    <span class="kn">from</span> <span class="nn">numpy</span> <span class="k">import</span> <span class="n">zeros</span><span class="p">,</span><span class="n">transpose</span><span class="p">,</span><span class="n">diag</span>

    <span class="k">if</span> <span class="n">knn</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">knn</span> <span class="o">=</span> <span class="n">FLANN</span><span class="p">()</span>
        <span class="n">params</span> <span class="o">=</span> <span class="n">knn</span><span class="o">.</span><span class="n">build_index</span><span class="p">(</span><span class="n">array</span><span class="p">(</span><span class="n">pos_data</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">float64</span><span class="p">))</span>
    <span class="n">shap</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">nb_pts</span> <span class="o">=</span> <span class="n">target_pos</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">psf_interp</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">nb_pts</span><span class="p">))</span>
    <span class="c1"># Computing the weights</span>
    <span class="n">result</span><span class="p">,</span> <span class="n">dists</span> <span class="o">=</span> <span class="n">knn</span><span class="o">.</span><span class="n">nn_index</span><span class="p">(</span><span class="n">target_pos</span><span class="p">,</span> <span class="n">nb_neigh</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_pts</span><span class="p">):</span>

        <span class="n">coeff</span><span class="p">,</span><span class="n">comp_cube</span><span class="p">,</span><span class="n">approx_cube</span> <span class="o">=</span> <span class="n">cube_svd</span><span class="p">(</span><span class="n">data</span><span class="p">[:,:,</span><span class="n">result</span><span class="p">[</span><span class="n">i</span><span class="p">,:]],</span><span class="n">nb_comp</span><span class="o">=</span><span class="nb">min</span><span class="p">(</span><span class="n">nb_comp</span><span class="p">,</span><span class="n">nb_neigh</span><span class="p">))</span>
        <span class="n">psf_interp</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">rbf_interp</span><span class="p">(</span><span class="n">comp_cube</span><span class="p">,</span><span class="n">coeff</span><span class="p">,</span><span class="n">pos_data</span><span class="p">[</span><span class="n">result</span><span class="p">[</span><span class="n">i</span><span class="p">,:],:],</span><span class="n">target_pos</span><span class="p">[</span><span class="n">i</span><span class="p">,:])</span>

    <span class="k">return</span> <span class="n">psf_interp</span>


<span class="k">def</span> <span class="nf">rbf_stack_2_feat_wise</span><span class="p">(</span><span class="n">list_data_feat</span><span class="p">,</span><span class="n">pos_data</span><span class="p">,</span><span class="n">target_pos</span><span class="p">,</span><span class="n">nb_neigh</span><span class="p">,</span><span class="n">nb_comp</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span><span class="n">knn</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="kn">from</span> <span class="nn">numpy</span> <span class="k">import</span> <span class="n">zeros</span>
    <span class="n">shap</span> <span class="o">=</span> <span class="n">list_data_feat</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">nb_points</span> <span class="o">=</span> <span class="n">target_pos</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">psf_interp</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">nb_points</span><span class="p">))</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">list_data_feat</span><span class="p">)):</span>
        <span class="n">psf_interp</span><span class="o">+=</span><span class="n">rbf_stack_2</span><span class="p">(</span><span class="n">list_data_feat</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">pos_data</span><span class="p">,</span><span class="n">target_pos</span><span class="p">,</span><span class="n">nb_neigh</span><span class="p">,</span><span class="n">nb_comp</span><span class="o">=</span><span class="n">nb_comp</span><span class="p">,</span><span class="n">knn</span><span class="o">=</span><span class="n">knn</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">psf_interp</span>

<span class="k">def</span> <span class="nf">rbf_stack_2m</span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="n">pos_data</span><span class="p">,</span><span class="n">target_pos</span><span class="p">,</span><span class="n">nb_neigh</span><span class="p">,</span><span class="n">nb_comp</span><span class="o">=</span><span class="mi">30</span><span class="p">):</span>

    <span class="n">nb_real</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">nb_neigh</span><span class="p">)</span>
    <span class="n">psf_interp</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_real</span><span class="p">):</span>
        <span class="n">psf_interp</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rbf_stack_2</span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="n">pos_data</span><span class="p">,</span><span class="n">target_pos</span><span class="p">,</span><span class="n">nb_neigh</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">nb_comp</span><span class="o">=</span><span class="n">nb_comp</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">psf_interp</span>


<span class="k">def</span> <span class="nf">rbf_stack_2_loc_m</span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="n">pos_data</span><span class="p">,</span><span class="n">target_pos</span><span class="p">,</span><span class="n">nb_neigh</span><span class="p">,</span><span class="n">nb_comp</span><span class="o">=</span><span class="mi">30</span><span class="p">):</span>

    <span class="n">nb_real</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">nb_neigh</span><span class="p">)</span>
    <span class="n">psf_interp</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_real</span><span class="p">):</span>
        <span class="n">psf_interp</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rbf_stack_2_loc</span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="n">pos_data</span><span class="p">,</span><span class="n">target_pos</span><span class="p">,</span><span class="n">nb_neigh</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">nb_comp</span><span class="o">=</span><span class="n">nb_comp</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">psf_interp</span>

<span class="k">def</span> <span class="nf">rbf_stack_2_feat_m</span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="n">pos_data</span><span class="p">,</span><span class="n">target_pos</span><span class="p">,</span><span class="n">nb_neigh</span><span class="p">,</span><span class="n">nb_comp</span><span class="o">=</span><span class="mi">30</span><span class="p">):</span>

    <span class="n">nb_real</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">nb_neigh</span><span class="p">)</span>
    <span class="n">psf_interp</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_real</span><span class="p">):</span>
        <span class="n">psf_interp</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rbf_stack_2_feat_wise</span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="n">pos_data</span><span class="p">,</span><span class="n">target_pos</span><span class="p">,</span><span class="n">nb_neigh</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">nb_comp</span><span class="o">=</span><span class="n">nb_comp</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">psf_interp</span>


<span class="k">def</span> <span class="nf">rbf_stackm</span><span class="p">(</span><span class="n">psf</span><span class="p">,</span><span class="n">pos_data</span><span class="p">,</span><span class="n">data_tree</span><span class="p">,</span><span class="n">dist</span><span class="p">,</span><span class="n">dist_range</span><span class="p">,</span><span class="n">nb_neighb</span><span class="p">,</span><span class="n">nb_comp</span><span class="o">=</span><span class="mi">20</span><span class="p">):</span>
    <span class="n">nb_realizations</span> <span class="o">=</span> <span class="n">dist_range</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">interp</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_realizations</span><span class="p">):</span>
        <span class="nb">print</span> <span class="s2">&quot;realization &quot;</span><span class="p">,</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="s2">&quot;/&quot;</span><span class="p">,</span><span class="n">nb_realizations</span>
        <span class="n">interp</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rbf_stack</span><span class="p">(</span><span class="n">psf</span><span class="p">,</span><span class="n">pos_data</span><span class="p">,</span><span class="n">data_tree</span><span class="p">,</span><span class="n">dist</span><span class="p">,</span><span class="n">dist_range</span><span class="p">[:,</span><span class="n">i</span><span class="p">],</span><span class="n">nb_neighb</span><span class="p">,</span><span class="n">nb_comp</span><span class="o">=</span><span class="n">nb_comp</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">interp</span>


<span class="k">def</span> <span class="nf">rbf_stackmbis</span><span class="p">(</span><span class="n">psf</span><span class="p">,</span><span class="n">pos_data</span><span class="p">,</span><span class="n">data_tree</span><span class="p">,</span><span class="n">dist</span><span class="p">,</span><span class="n">dist_range</span><span class="p">,</span><span class="n">nb_neighb</span><span class="p">,</span><span class="n">nb_comp</span><span class="o">=</span><span class="mi">20</span><span class="p">):</span>
    <span class="n">nb_realizations</span> <span class="o">=</span> <span class="n">size</span><span class="p">(</span><span class="n">nb_neighb</span><span class="p">)</span>
    <span class="n">interp</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_realizations</span><span class="p">):</span>
        <span class="nb">print</span> <span class="s2">&quot;realization &quot;</span><span class="p">,</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="s2">&quot;/&quot;</span><span class="p">,</span><span class="n">nb_realizations</span>
        <span class="n">interp</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rbf_stack</span><span class="p">(</span><span class="n">psf</span><span class="p">,</span><span class="n">pos_data</span><span class="p">,</span><span class="n">data_tree</span><span class="p">,</span><span class="n">dist</span><span class="p">,</span><span class="n">dist_range</span><span class="p">,</span><span class="n">nb_neighb</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">nb_comp</span><span class="o">=</span><span class="n">nb_comp</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">interp</span>



<span class="k">def</span> <span class="nf">ri_profile</span><span class="p">(</span><span class="n">psf</span><span class="p">):</span>
    <span class="n">prof</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span><span class="n">size</span><span class="p">(</span><span class="n">psf</span><span class="p">)))</span>
    <span class="n">i</span><span class="p">,</span><span class="n">j</span> <span class="o">=</span> <span class="n">where</span><span class="p">(</span><span class="n">psf</span><span class="o">==</span><span class="n">psf</span><span class="o">.</span><span class="n">max</span><span class="p">())</span>
    <span class="n">im</span> <span class="o">=</span> <span class="n">mean</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
    <span class="n">jm</span> <span class="o">=</span> <span class="n">mean</span><span class="p">(</span><span class="n">j</span><span class="p">)</span>
    <span class="n">shap</span> <span class="o">=</span> <span class="n">psf</span><span class="o">.</span><span class="n">shape</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
            <span class="n">prof</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">i</span><span class="o">+</span><span class="n">j</span><span class="o">*</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="n">sqrt</span><span class="p">((</span><span class="n">im</span><span class="o">-</span><span class="n">i</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="p">(</span><span class="n">jm</span><span class="o">-</span><span class="n">j</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
            <span class="n">prof</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="n">i</span><span class="o">+</span><span class="n">j</span><span class="o">*</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="n">psf</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">prof</span>



<span class="k">def</span> <span class="nf">im_to_point_cloud</span><span class="p">(</span><span class="n">im</span><span class="p">):</span>

    <span class="kn">from</span> <span class="nn">numpy</span> <span class="k">import</span> <span class="n">ones</span><span class="p">,</span><span class="n">zeros</span>

    <span class="n">shap</span> <span class="o">=</span> <span class="n">im</span><span class="o">.</span><span class="n">shape</span>

    <span class="n">point_cloud</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">point_cloud</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>

    <span class="n">point_cloud</span><span class="p">[</span><span class="mi">0</span><span class="p">,:]</span> <span class="o">=</span> <span class="p">(</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">ones</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">]))))</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">],))</span>
    <span class="n">point_cloud</span><span class="p">[</span><span class="mi">1</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">ones</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">])))</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">],))</span>
    <span class="n">point_cloud</span><span class="p">[</span><span class="mi">2</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">im</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">],))</span>


    <span class="k">return</span> <span class="n">point_cloud</span>

<span class="k">def</span> <span class="nf">xlog</span><span class="p">(</span><span class="n">arr</span><span class="p">,</span><span class="n">a</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>

    <span class="kn">from</span> <span class="nn">numpy</span> <span class="k">import</span> <span class="n">log</span> <span class="k">as</span> <span class="n">lognp</span><span class="p">,</span><span class="n">median</span>
    <span class="n">t</span><span class="o">=</span><span class="mi">1</span>
    <span class="k">if</span> <span class="n">a</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">a</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">t</span><span class="p">)</span><span class="o">*</span><span class="n">median</span><span class="p">(</span><span class="n">arr</span><span class="p">)</span><span class="o">+</span> <span class="n">t</span><span class="o">*</span><span class="n">arr</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
    <span class="n">arr_out</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">arr</span><span class="p">)</span>
    <span class="n">i</span><span class="p">,</span><span class="n">j</span> <span class="o">=</span> <span class="n">where</span><span class="p">(</span><span class="n">arr</span><span class="o">&lt;</span><span class="n">a</span><span class="p">)</span>
    <span class="n">arr_out</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">a</span><span class="o">*</span><span class="n">lognp</span><span class="p">(</span><span class="n">arr</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">])</span><span class="o">+</span><span class="n">a</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">lognp</span><span class="p">(</span><span class="n">a</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">arr_out</span>


<span class="k">def</span> <span class="nf">xexp</span><span class="p">(</span><span class="n">arr</span><span class="p">,</span><span class="n">c</span><span class="o">=</span><span class="mf">0.0000007</span><span class="p">):</span>
    <span class="kn">from</span> <span class="nn">numpy</span> <span class="k">import</span> <span class="n">exp</span> <span class="k">as</span> <span class="n">expnp</span><span class="p">,</span><span class="n">median</span>
    <span class="n">t</span><span class="o">=</span><span class="mi">1</span>
    <span class="n">x</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">t</span><span class="p">)</span><span class="o">*</span><span class="n">median</span><span class="p">(</span><span class="n">arr</span><span class="p">)</span><span class="o">+</span> <span class="n">t</span><span class="o">*</span><span class="n">arr</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
    <span class="n">arr_out</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">arr</span><span class="p">)</span>
    <span class="n">i</span><span class="p">,</span><span class="n">j</span> <span class="o">=</span> <span class="n">where</span><span class="p">(</span><span class="n">arr</span><span class="o">&lt;</span><span class="n">x</span><span class="p">)</span>
    <span class="n">arr_out</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">x</span><span class="o">*</span><span class="n">expnp</span><span class="p">(</span><span class="o">-</span><span class="n">c</span><span class="o">/</span><span class="n">x</span><span class="p">)</span><span class="o">*</span><span class="n">expnp</span><span class="p">(</span><span class="n">c</span><span class="o">/</span><span class="n">arr</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">])</span>

    <span class="k">return</span> <span class="n">arr_out</span>



<span class="k">def</span> <span class="nf">cube_to_point_cloud</span><span class="p">(</span><span class="n">cube</span><span class="p">):</span>

    <span class="kn">from</span> <span class="nn">numpy</span> <span class="k">import</span> <span class="n">zeros</span>

    <span class="n">shap</span> <span class="o">=</span> <span class="n">cube</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">nb_pix</span> <span class="o">=</span> <span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">nb_im</span> <span class="o">=</span> <span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>

    <span class="n">point_cloud</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">nb_im</span><span class="p">))</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_im</span><span class="p">):</span>
        <span class="n">point_cloud</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">]</span><span class="o">=</span> <span class="n">im_to_point_cloud</span><span class="p">(</span><span class="n">cube</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">])</span>

    <span class="k">return</span> <span class="n">point_cloud</span>


<span class="k">def</span> <span class="nf">isomap_interface</span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="n">dim</span><span class="p">,</span><span class="n">nb_neigh_min</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span><span class="n">nb_neigh_max</span><span class="o">=</span><span class="mi">29</span><span class="p">,</span><span class="n">step</span><span class="o">=</span><span class="mi">2</span><span class="p">):</span> <span class="c1"># Data: each sample is in a row</span>
    <span class="kn">from</span> <span class="nn">sklearn</span> <span class="k">import</span> <span class="n">manifold</span>
    <span class="kn">from</span> <span class="nn">utils</span> <span class="k">import</span> <span class="n">distances_mat</span>
    <span class="kn">from</span> <span class="nn">copy</span> <span class="k">import</span> <span class="n">copy</span><span class="p">,</span><span class="n">deepcopy</span>
    <span class="n">nb_samp</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">dist_data</span> <span class="o">=</span> <span class="n">distances_mat</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="n">nb_step</span> <span class="o">=</span> <span class="n">floor</span><span class="p">((</span><span class="n">nb_neigh_max</span><span class="o">-</span><span class="n">nb_neigh_min</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="n">step</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
    <span class="n">neigh</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="n">nb_neigh_min</span><span class="p">,</span><span class="n">nb_neigh_max</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">step</span><span class="p">)</span>
    <span class="n">kernel_embedding_error</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">nb_step</span><span class="p">,))</span>
    <span class="n">dist_embedding_error</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">nb_step</span><span class="p">,))</span>
    <span class="n">over_fit</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">nb_step</span><span class="p">,))</span>
    <span class="n">select_func</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">nb_step</span><span class="p">,))</span>
    <span class="n">err_min</span> <span class="o">=</span> <span class="mf">1e15</span>
    <span class="n">iso_out</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">embedding_out</span> <span class="o">=</span> <span class="kc">None</span>


    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_step</span><span class="p">):</span>
        <span class="nb">print</span> <span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="s1">&#39;/&#39;</span><span class="p">,</span><span class="n">nb_step</span>
        <span class="n">iso</span> <span class="o">=</span> <span class="n">manifold</span><span class="o">.</span><span class="n">Isomap</span><span class="p">(</span><span class="n">neigh</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">dim</span><span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">transpose</span><span class="p">(</span><span class="n">data</span><span class="p">))</span>
        <span class="n">Y</span> <span class="o">=</span> <span class="n">transpose</span><span class="p">(</span><span class="n">iso</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">transpose</span><span class="p">(</span><span class="n">data</span><span class="p">)))</span>
        <span class="n">dist_y</span> <span class="o">=</span> <span class="n">distances_mat</span><span class="p">(</span><span class="n">Y</span><span class="p">)</span>
        <span class="n">k</span><span class="p">,</span><span class="n">l</span> <span class="o">=</span> <span class="n">where</span><span class="p">(</span><span class="n">iso</span><span class="o">.</span><span class="n">dist_matrix_</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">dist_embedding_error</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">100</span><span class="o">*</span><span class="nb">abs</span><span class="p">((</span><span class="n">iso</span><span class="o">.</span><span class="n">dist_matrix_</span><span class="p">[</span><span class="n">k</span><span class="p">,</span><span class="n">l</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span> <span class="o">-</span> <span class="n">dist_y</span><span class="p">[</span><span class="n">k</span><span class="p">,</span><span class="n">l</span><span class="p">])</span><span class="o">/</span><span class="n">iso</span><span class="o">.</span><span class="n">dist_matrix_</span><span class="p">[</span><span class="n">k</span><span class="p">,</span><span class="n">l</span><span class="p">])</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="n">kernel_embedding_error</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">iso</span><span class="o">.</span><span class="n">reconstruction_error</span><span class="p">()</span>
        <span class="n">over_fit</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">iso</span><span class="o">.</span><span class="n">dist_matrix_</span><span class="o">**</span><span class="mi">2</span> <span class="o">-</span> <span class="n">dist_data</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">/</span><span class="n">nb_samp</span>

    <span class="k">return</span> <span class="n">iso_out</span><span class="p">,</span><span class="n">embedding_out</span><span class="p">,</span><span class="n">kernel_embedding_error</span><span class="p">,</span><span class="n">dist_embedding_error</span><span class="p">,</span><span class="n">over_fit</span>

<span class="k">def</span> <span class="nf">LLE_sliced_transport_bar</span><span class="p">(</span><span class="n">im_cube</span><span class="p">,</span><span class="n">weights</span><span class="p">,</span><span class="n">nb_points</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">cent</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">coord_map</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">log_param</span><span class="o">=</span><span class="mf">1.5</span><span class="p">,</span><span class="n">zeros_inc</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">nb_neigh_emb</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">nb_comp</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">nb_neigh_inv_map</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span><span class="n">nb_samp</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span><span class="n">embedding_en</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">embedding_closest</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">log_en</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="kn">from</span> <span class="nn">numpy</span> <span class="k">import</span> <span class="n">size</span><span class="p">,</span><span class="n">transpose</span><span class="p">,</span><span class="n">array</span><span class="p">,</span><span class="n">float64</span>
    <span class="kn">from</span> <span class="nn">sklearn</span> <span class="k">import</span> <span class="n">manifold</span>
    <span class="kn">from</span> <span class="nn">pyflann</span> <span class="k">import</span> <span class="n">FLANN</span>
    <span class="kn">from</span> <span class="nn">utils</span> <span class="k">import</span> <span class="n">knn_bar</span><span class="p">,</span><span class="n">circle_vect</span>
    <span class="kn">from</span> <span class="nn">optim_utils</span> <span class="k">import</span> <span class="n">sliced_transport_bar</span>
    <span class="n">shap</span> <span class="o">=</span> <span class="n">im_cube</span><span class="o">.</span><span class="n">shape</span>
    <span class="k">if</span> <span class="n">cent</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">cent</span>  <span class="o">=</span> <span class="n">where</span><span class="p">(</span><span class="n">im_cube</span><span class="p">[:,:,</span><span class="mi">0</span><span class="p">]</span><span class="o">==</span><span class="n">im_cube</span><span class="p">[:,:,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">())</span>
    <span class="k">if</span> <span class="n">nb_neigh_emb</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">embedding_closest</span><span class="p">:</span>
            <span class="n">nb_neigh_emb</span> <span class="o">=</span> <span class="mi">15</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">nb_neigh_emb</span> <span class="o">=</span> <span class="mi">30</span><span class="o">*</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>


    <span class="k">if</span> <span class="n">nb_points</span> <span class="ow">is</span> <span class="n">none</span><span class="p">:</span>
        <span class="n">nb_points</span> <span class="o">=</span> <span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">embedd_point_clouds</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">nb_comp</span><span class="p">,</span><span class="n">nb_points</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>
    <span class="n">embedd_point_clouds_unwrp</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">nb_comp</span><span class="p">,</span><span class="n">nb_points</span><span class="o">*</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>
    <span class="n">clouds</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span><span class="n">nb_points</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>


    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
        <span class="n">clouds</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">im_to_point_cloud</span><span class="p">(</span><span class="n">im_cube</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">],</span><span class="n">rand_en</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">nb_samp</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span><span class="n">pol_en</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">cent</span><span class="o">=</span><span class="n">cent</span><span class="p">,</span><span class="n">coord_map</span><span class="o">=</span><span class="n">coord_map</span><span class="p">,</span><span class="n">log_param</span><span class="o">=</span><span class="n">log_param</span><span class="p">,</span><span class="n">min_val</span> <span class="o">=</span> <span class="mf">1e-31</span><span class="p">,</span><span class="n">zeros_inc</span><span class="o">=</span><span class="n">zeros_inc</span><span class="p">,</span><span class="n">log_advanced</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">log_en</span><span class="o">=</span><span class="n">log_en</span><span class="p">)</span>


    <span class="n">Yhess_obj</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">flann</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">embedding_en</span><span class="p">:</span>
        <span class="n">point_cloud</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span><span class="n">nb_points</span><span class="o">*</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
            <span class="n">point_cloud</span><span class="p">[:,</span><span class="n">i</span><span class="o">*</span><span class="n">nb_points</span><span class="p">:(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">nb_points</span><span class="p">]</span> <span class="o">=</span> <span class="n">clouds</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">]</span>
        <span class="nb">print</span> <span class="s2">&quot;Calculating the embedding...&quot;</span>
        <span class="k">if</span> <span class="n">embedding_closest</span><span class="p">:</span>
            <span class="n">imax</span> <span class="o">=</span> <span class="n">where</span><span class="p">(</span><span class="n">weights</span><span class="o">==</span><span class="n">weights</span><span class="o">.</span><span class="n">max</span><span class="p">())</span>
            <span class="n">in_cloud</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="n">size</span><span class="p">(</span><span class="n">imax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">==</span><span class="mi">1</span><span class="p">):</span>
                <span class="n">in_cloud</span> <span class="o">=</span> <span class="n">clouds</span><span class="p">[:,:,</span><span class="n">imax</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">in_cloud</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span><span class="n">nb_points</span><span class="o">*</span><span class="n">size</span><span class="p">(</span><span class="n">imax</span><span class="p">[</span><span class="mi">0</span><span class="p">])))</span>
                <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">size</span><span class="p">(</span><span class="n">imax</span><span class="p">[</span><span class="mi">0</span><span class="p">])):</span>
                    <span class="n">in_cloud</span><span class="p">[:,</span><span class="n">k</span><span class="o">*</span><span class="n">nb_points</span><span class="p">:(</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">nb_points</span><span class="p">]</span> <span class="o">=</span> <span class="n">clouds</span><span class="p">[:,:,</span><span class="n">imax</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">k</span><span class="p">]]</span>
            <span class="n">Yhess_obj</span> <span class="o">=</span> <span class="n">manifold</span><span class="o">.</span><span class="n">LocallyLinearEmbedding</span><span class="p">(</span><span class="n">nb_neigh_emb</span><span class="p">,</span> <span class="n">nb_comp</span><span class="p">,</span><span class="n">eigen_solver</span><span class="o">=</span><span class="s1">&#39;dense&#39;</span><span class="p">,</span><span class="n">method</span><span class="o">=</span><span class="s1">&#39;hessian&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">transpose</span><span class="p">(</span><span class="n">in_cloud</span><span class="p">))</span>
            <span class="c1">#Yhess_obj = manifold.Isomap(nb_neigh_emb, nb_comp).fit(transpose(in_cloud))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">Yhess_obj</span> <span class="o">=</span> <span class="n">manifold</span><span class="o">.</span><span class="n">LocallyLinearEmbedding</span><span class="p">(</span><span class="n">nb_neigh_emb</span><span class="p">,</span> <span class="n">nb_comp</span><span class="p">,</span><span class="n">eigen_solver</span><span class="o">=</span><span class="s1">&#39;dense&#39;</span><span class="p">,</span><span class="n">method</span><span class="o">=</span><span class="s1">&#39;hessian&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">transpose</span><span class="p">(</span><span class="n">point_cloud</span><span class="p">))</span>
            <span class="c1">#Yhess_obj = manifold.Isomap(nb_neigh_emb, nb_comp).fit(transpose(point_cloud))</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
            <span class="k">if</span> <span class="n">embedding_closest</span><span class="p">:</span>
                <span class="n">embedd_point_clouds</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">transpose</span><span class="p">(</span><span class="n">Yhess_obj</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">transpose</span><span class="p">(</span><span class="n">clouds</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">])))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">embedd_point_clouds</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">transpose</span><span class="p">(</span><span class="n">Yhess_obj</span><span class="o">.</span><span class="n">embedding_</span><span class="p">[</span><span class="n">i</span><span class="o">*</span><span class="n">nb_points</span><span class="p">:(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">nb_points</span><span class="p">,:])</span>
            <span class="n">embedd_point_clouds_unwrp</span><span class="p">[:,</span><span class="n">i</span><span class="o">*</span><span class="n">nb_points</span><span class="p">:(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">nb_points</span><span class="p">]</span> <span class="o">=</span> <span class="n">embedd_point_clouds</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">]</span>

    <span class="n">rand_en</span><span class="o">=</span><span class="kc">False</span>
    <span class="n">basis</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">nb_comp</span><span class="o">==</span><span class="mi">2</span> <span class="ow">and</span> <span class="n">embedding_en</span><span class="p">:</span>
        <span class="n">basis</span> <span class="o">=</span> <span class="n">circle_vect</span><span class="p">(</span><span class="n">nb_samp</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">rand_en</span> <span class="o">=</span> <span class="kc">True</span>




    <span class="k">if</span> <span class="n">embedding_en</span><span class="p">:</span>
        <span class="nb">print</span> <span class="s2">&quot;Calculating the sliced barycenter...&quot;</span>
        <span class="n">init_bar</span> <span class="o">=</span> <span class="n">knn_bar</span><span class="p">(</span><span class="n">embedd_point_clouds</span><span class="p">,</span><span class="n">weights</span><span class="p">)</span>

        <span class="n">emb_bar</span><span class="p">,</span><span class="n">basis</span> <span class="o">=</span> <span class="n">sliced_transport_bar</span><span class="p">(</span><span class="n">embedd_point_clouds</span><span class="p">,</span><span class="n">weights</span><span class="p">,</span><span class="n">nb_iter</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span><span class="n">tol</span><span class="o">=</span><span class="mf">0.0000001</span><span class="p">,</span><span class="n">alph</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span><span class="n">bar_init</span><span class="o">=</span><span class="n">init_bar</span><span class="p">,</span><span class="n">rand_en</span><span class="o">=</span><span class="n">rand_en</span><span class="p">,</span><span class="n">basis</span><span class="o">=</span><span class="n">basis</span><span class="p">)</span>

        <span class="nb">print</span> <span class="s2">&quot;Inverting the embedding...&quot;</span>
        <span class="n">flann</span> <span class="o">=</span> <span class="n">FLANN</span><span class="p">()</span>
        <span class="n">params</span> <span class="o">=</span> <span class="n">flann</span><span class="o">.</span><span class="n">build_index</span><span class="p">(</span><span class="n">array</span><span class="p">(</span><span class="n">Yhess_obj</span><span class="o">.</span><span class="n">embedding_</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">float64</span><span class="p">))</span>
        <span class="n">bar</span> <span class="o">=</span> <span class="n">inverse_mapping</span><span class="p">(</span><span class="n">emb_bar</span><span class="p">,</span><span class="n">embedd_point_clouds_unwrp</span><span class="p">,</span><span class="n">point_cloud</span><span class="p">,</span><span class="n">flann</span><span class="p">,</span><span class="n">nb_neigh</span><span class="o">=</span><span class="n">nb_neigh_inv_map</span><span class="p">)</span>

        <span class="nb">print</span> <span class="s2">&quot;Mapping the final point cloud to an image...&quot;</span>
        <span class="n">im_out</span> <span class="o">=</span> <span class="n">bar_1d_2d_bis</span><span class="p">(</span><span class="n">bar</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">],</span><span class="n">cent</span><span class="p">,</span><span class="n">pol_en</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">log_param</span><span class="o">=</span><span class="n">log_param</span><span class="p">,</span><span class="n">tol</span><span class="o">=</span><span class="mf">0.001</span><span class="p">)</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="n">init_bar</span> <span class="o">=</span> <span class="n">knn_bar</span><span class="p">(</span><span class="n">clouds</span><span class="p">,</span><span class="n">weights</span><span class="p">)</span>
        <span class="n">bar</span><span class="p">,</span><span class="n">basis</span> <span class="o">=</span> <span class="n">sliced_transport_bar</span><span class="p">(</span><span class="n">clouds</span><span class="p">,</span><span class="n">weights</span><span class="p">,</span><span class="n">nb_iter</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span><span class="n">tol</span><span class="o">=</span><span class="mf">0.0000001</span><span class="p">,</span><span class="n">alph</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span><span class="n">bar_init</span><span class="o">=</span><span class="n">init_bar</span><span class="p">,</span><span class="n">rand_en</span><span class="o">=</span><span class="n">rand_en</span><span class="p">,</span><span class="n">basis</span><span class="o">=</span><span class="n">basis</span><span class="p">)</span>
        <span class="nb">print</span> <span class="s2">&quot;Mapping the final point cloud to an image...&quot;</span>
        <span class="n">im_out</span> <span class="o">=</span> <span class="n">bar_1d_2d_bis</span><span class="p">(</span><span class="n">bar</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">],</span><span class="n">cent</span><span class="p">,</span><span class="n">pol_en</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">log_param</span><span class="o">=</span><span class="n">log_param</span><span class="p">,</span><span class="n">tol</span><span class="o">=</span><span class="mf">0.001</span><span class="p">)</span>

    <span class="nb">print</span> <span class="s2">&quot;Done...&quot;</span>

    <span class="k">return</span> <span class="n">im_out</span><span class="p">,</span><span class="n">Yhess_obj</span><span class="p">,</span><span class="n">flann</span>



<span class="k">def</span> <span class="nf">structured_sliced_transport_bar</span><span class="p">(</span><span class="n">im_cube</span><span class="p">,</span><span class="n">weights</span><span class="p">,</span><span class="n">nb_points</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">cent</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">coord_map</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">log_param</span><span class="o">=</span><span class="mf">1.5</span><span class="p">,</span><span class="n">zeros_inc</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">nb_neigh_emb</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">nb_comp</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">nb_neigh_inv_map</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span><span class="n">nb_samp</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span><span class="n">embedding_en</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">embedding_closest</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">log_en</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">kmad</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span><span class="n">deg</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span><span class="n">win</span><span class="o">=</span><span class="mi">9</span><span class="p">,</span><span class="n">win2</span><span class="o">=</span><span class="mi">7</span><span class="p">):</span>
    <span class="kn">from</span> <span class="nn">numpy</span> <span class="k">import</span> <span class="n">zeros</span>
    <span class="n">shap</span> <span class="o">=</span> <span class="n">im_cube</span><span class="o">.</span><span class="n">shape</span>
    <span class="c1"># Detecting and extracting structures</span>
    <span class="n">label_im</span><span class="p">,</span><span class="n">poly_fit</span><span class="p">,</span><span class="n">nb_samples</span> <span class="o">=</span> <span class="n">ring_stack</span><span class="p">(</span><span class="n">im_cube</span><span class="p">,</span><span class="n">center</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">kmad</span><span class="o">=</span><span class="n">kmad</span><span class="p">,</span><span class="n">deg</span><span class="o">=</span><span class="n">deg</span><span class="p">,</span><span class="n">win</span><span class="o">=</span><span class="n">win</span><span class="p">,</span><span class="n">win2</span><span class="o">=</span><span class="n">win2</span><span class="p">)</span>

    <span class="n">nb_zeros</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">nb_samples</span><span class="p">)</span>
    <span class="n">indexes</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,[</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">],[</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">],</span><span class="nb">range</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="n">nb_zeros</span><span class="o">+</span><span class="mi">1</span><span class="p">)]</span>
    <span class="n">nb_points</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="mi">4</span><span class="p">,))</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">4</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">size</span><span class="p">(</span><span class="n">indexes</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">nb_points</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">nb_samples</span><span class="p">[</span><span class="n">indexes</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">size</span><span class="p">(</span><span class="n">indexes</span><span class="p">[</span><span class="n">i</span><span class="p">])):</span>
                <span class="n">nb_points</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+=</span> <span class="n">nb_samples</span><span class="p">[</span><span class="n">indexes</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">k</span><span class="p">]]</span>

    <span class="n">list_structures</span> <span class="o">=</span> <span class="n">get_ring_stack</span><span class="p">(</span><span class="n">im_cube</span><span class="p">,</span><span class="nb">map</span><span class="p">,</span><span class="n">indexes</span><span class="p">)</span>

    <span class="n">bar_out</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="mi">4</span><span class="p">))</span>
    <span class="n">hess_obj</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
    <span class="n">knn_obj</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">4</span><span class="p">):</span>
        <span class="n">bar_out</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">],</span><span class="n">Yhess_obj</span><span class="p">,</span><span class="n">flann</span> <span class="o">=</span> <span class="n">LLE_sliced_transport_bar</span><span class="p">(</span><span class="n">list_structures</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">weights</span><span class="p">,</span><span class="n">nb_points</span><span class="o">=</span><span class="n">nb_points</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">cent</span><span class="o">=</span><span class="n">cent</span><span class="p">,</span><span class="n">coord_map</span><span class="o">=</span><span class="n">coord_map</span><span class="p">,</span><span class="n">log_param</span><span class="o">=</span><span class="n">log_param</span><span class="p">,</span><span class="n">zeros_inc</span><span class="o">=</span><span class="n">zeros_inc</span><span class="p">,</span><span class="n">nb_neigh_emb</span><span class="o">=</span><span class="n">nb_neigh_emb</span><span class="p">,</span><span class="n">nb_comp</span><span class="o">=</span><span class="n">nb_comp</span><span class="p">,</span><span class="n">nb_neigh_inv_map</span><span class="o">=</span><span class="n">nb_neigh_inv_map</span><span class="p">,</span><span class="n">nb_samp</span><span class="o">=</span><span class="n">nb_samp</span><span class="p">,</span><span class="n">embedding_en</span><span class="o">=</span><span class="n">embedding_en</span><span class="p">,</span><span class="n">embedding_closest</span><span class="o">=</span><span class="n">embedding_closest</span><span class="p">,</span><span class="n">log_en</span><span class="o">=</span><span class="n">log_en</span><span class="p">)</span>
        <span class="n">hess_obj</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Yhess_obj</span><span class="p">)</span>
        <span class="n">knn_obj</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">flann</span><span class="p">)</span>


    <span class="k">return</span> <span class="n">bar_out</span><span class="p">,</span><span class="n">hess_obj</span><span class="p">,</span><span class="n">knn_obj</span>


<span class="k">def</span> <span class="nf">arc_length</span><span class="p">(</span><span class="nb">map</span><span class="p">,</span><span class="n">samp</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="n">shap</span> <span class="o">=</span> <span class="nb">map</span><span class="o">.</span><span class="n">shape</span>
    <span class="k">if</span> <span class="n">samp</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">samp</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">shap</span><span class="p">)</span>
    <span class="n">curv_abs</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">t</span> <span class="o">=</span> <span class="n">double</span><span class="p">(</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">samp</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span><span class="o">/</span><span class="n">samp</span>
    <span class="n">step</span> <span class="o">=</span> <span class="n">sqrt</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="p">(</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="n">samp</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">samp</span><span class="p">):</span>

        <span class="n">curv_abs</span><span class="o">+=</span> <span class="nb">abs</span><span class="p">(</span><span class="nb">map</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">t</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">)),</span><span class="nb">int</span><span class="p">(</span><span class="n">t</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">))]</span><span class="o">-</span><span class="nb">map</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">t</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">)),</span><span class="nb">int</span><span class="p">(</span><span class="n">t</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">))])</span><span class="o">*</span><span class="n">step</span>
        <span class="c1">#curv_abs+= map[int(t[i]*(shap[0]-1)),int(t[i]*(shap[1]-1))]*step</span>
    <span class="k">return</span> <span class="n">curv_abs</span>



<span class="k">def</span> <span class="nf">embedding</span><span class="p">(</span><span class="n">mani_obj</span><span class="p">,</span><span class="n">im_stack</span><span class="p">,</span><span class="n">pol_en</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">cent</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">coord_map</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">log_param</span><span class="o">=</span><span class="mf">1.5</span><span class="p">,</span><span class="n">log_advanced</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="kn">from</span> <span class="nn">numpy</span> <span class="k">import</span> <span class="n">transpose</span>
    <span class="n">shap</span> <span class="o">=</span><span class="n">im_stack</span><span class="o">.</span><span class="n">shape</span>

    <span class="n">out</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">mani_obj</span><span class="o">.</span><span class="n">embedding_</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
        <span class="n">point_cloud</span> <span class="o">=</span> <span class="n">im_to_point_cloud</span><span class="p">(</span><span class="n">im_stack</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">],</span><span class="n">rand_en</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">pol_en</span><span class="o">=</span><span class="n">pol_en</span><span class="p">,</span><span class="n">cent</span><span class="o">=</span><span class="n">cent</span><span class="p">,</span><span class="n">coord_map</span><span class="o">=</span><span class="n">coord_map</span><span class="p">,</span><span class="n">log_param</span><span class="o">=</span><span class="n">log_param</span><span class="p">,</span><span class="n">zeros_inc</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">log_advanced</span><span class="o">=</span><span class="n">log_advanced</span><span class="p">)</span>
        <span class="n">out</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">transpose</span><span class="p">(</span><span class="n">mani_obj</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">transpose</span><span class="p">(</span><span class="n">point_cloud_ref</span><span class="p">)))</span>

    <span class="k">return</span> <span class="n">out</span>


<span class="k">def</span> <span class="nf">inverse_mapping</span><span class="p">(</span><span class="n">embed_coord</span><span class="p">,</span><span class="n">embed_ref</span><span class="p">,</span><span class="n">original_ref</span><span class="p">,</span><span class="n">flann_obj</span><span class="p">,</span><span class="n">nb_neigh</span><span class="o">=</span><span class="mi">3</span><span class="p">):</span>
    <span class="kn">from</span> <span class="nn">numpy</span> <span class="k">import</span> <span class="n">zeros</span><span class="p">,</span><span class="n">diag</span>
    <span class="n">shap1</span> <span class="o">=</span> <span class="n">embed_coord</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">shap2</span> <span class="o">=</span> <span class="n">original_ref</span><span class="o">.</span><span class="n">shape</span>

    <span class="n">output</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">shap2</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">shap1</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
    <span class="n">result</span><span class="p">,</span> <span class="n">dists</span> <span class="o">=</span> <span class="n">flann_obj</span><span class="o">.</span><span class="n">nn_index</span><span class="p">(</span><span class="n">transpose</span><span class="p">(</span><span class="n">embed_coord</span><span class="p">),</span> <span class="n">nb_neigh</span><span class="p">)</span>
    <span class="n">bar_coord</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">shap1</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">nb_neigh</span><span class="p">))</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap1</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
        <span class="n">bar_coord</span><span class="p">[</span><span class="n">i</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">bar_coord2d</span><span class="p">(</span><span class="n">embed_ref</span><span class="p">[:,</span><span class="n">result</span><span class="p">[</span><span class="n">i</span><span class="p">]],</span><span class="n">embed_coord</span><span class="p">[:,</span><span class="n">i</span><span class="p">],</span><span class="n">cond</span><span class="o">=</span><span class="mf">1.</span><span class="o">/</span><span class="mi">50</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">nb_neigh</span><span class="p">,))</span>
        <span class="n">output</span><span class="p">[:,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">diag</span><span class="p">(</span><span class="n">bar_coord</span><span class="p">[</span><span class="n">i</span><span class="p">,:])</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">original_ref</span><span class="p">[:,</span><span class="n">result</span><span class="p">[</span><span class="n">i</span><span class="p">]])</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">output</span><span class="p">,</span><span class="n">bar_coord</span><span class="p">,</span><span class="n">result</span>


<span class="k">def</span> <span class="nf">inverse_mapping_2D</span><span class="p">(</span><span class="n">embed_coord</span><span class="p">,</span><span class="n">embed_ref</span><span class="p">,</span><span class="n">original_ref</span><span class="p">,</span><span class="n">flann_obj</span><span class="p">,</span><span class="n">nb_neigh</span><span class="o">=</span><span class="mi">3</span><span class="p">):</span>
    <span class="kn">from</span> <span class="nn">numpy</span> <span class="k">import</span> <span class="n">zeros</span><span class="p">,</span><span class="n">diag</span>
    <span class="n">shap1</span> <span class="o">=</span> <span class="n">embed_coord</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">shap2</span> <span class="o">=</span> <span class="n">original_ref</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">output</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">bar_coord</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">shap1</span><span class="p">)</span><span class="o">&lt;=</span><span class="mi">1</span><span class="p">:</span>
        <span class="n">output</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">shap2</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">shap2</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
        <span class="n">bar_coord</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">nb_neigh</span><span class="p">,))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">output</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">shap2</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">shap2</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">shap1</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
        <span class="n">bar_coord</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">shap1</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">nb_neigh</span><span class="p">))</span>

    <span class="n">result</span><span class="p">,</span> <span class="n">dists</span> <span class="o">=</span> <span class="n">flann_obj</span><span class="o">.</span><span class="n">nn_index</span><span class="p">(</span><span class="n">embed_coord</span><span class="p">,</span> <span class="n">nb_neigh</span><span class="p">)</span>



    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">shap1</span><span class="p">)</span><span class="o">&lt;=</span><span class="mi">1</span><span class="p">:</span>
        <span class="n">bar_coord</span> <span class="o">=</span> <span class="n">bar_coord2d</span><span class="p">(</span><span class="n">embed_ref</span><span class="p">[:,</span><span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">,:]],</span><span class="n">embed_coord</span><span class="p">,</span><span class="n">cond</span><span class="o">=</span><span class="mf">1.</span><span class="o">/</span><span class="mi">50</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">nb_neigh</span><span class="p">,))</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_neigh</span><span class="p">):</span>
            <span class="n">output</span><span class="o">+=</span> <span class="n">bar_coord</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">*</span><span class="n">original_ref</span><span class="p">[:,:,</span><span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">j</span><span class="p">]]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap1</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
            <span class="n">bar_coord</span><span class="p">[</span><span class="n">i</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">bar_coord2d</span><span class="p">(</span><span class="n">embed_ref</span><span class="p">[:,</span><span class="n">result</span><span class="p">[</span><span class="n">i</span><span class="p">]],</span><span class="n">embed_coord</span><span class="p">[:,</span><span class="n">i</span><span class="p">],</span><span class="n">cond</span><span class="o">=</span><span class="mf">1.</span><span class="o">/</span><span class="mi">50</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">nb_neigh</span><span class="p">,))</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_neigh</span><span class="p">):</span>
                <span class="n">output</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">]</span><span class="o">+=</span> <span class="n">bar_coord</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span><span class="o">*</span><span class="n">original_ref</span><span class="p">[:,:,</span><span class="n">result</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]]</span>

    <span class="k">return</span> <span class="n">output</span><span class="p">,</span><span class="n">bar_coord</span><span class="p">,</span><span class="n">result</span>


<span class="k">def</span> <span class="nf">w_inverse_mapping_2D</span><span class="p">(</span><span class="n">embed_coord</span><span class="p">,</span><span class="n">embed_ref</span><span class="p">,</span><span class="n">original_ref</span><span class="p">,</span><span class="n">flann_obj</span><span class="p">,</span><span class="n">cent</span><span class="p">,</span><span class="n">coeff_poly</span><span class="p">,</span><span class="n">basis</span><span class="p">,</span><span class="n">nb_neigh</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span><span class="n">nb_iter</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span><span class="n">support</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="kn">from</span> <span class="nn">numpy</span> <span class="k">import</span> <span class="n">zeros</span><span class="p">,</span><span class="n">diag</span><span class="p">,</span><span class="n">argsort</span>
    <span class="kn">from</span> <span class="nn">optim_utils</span> <span class="k">import</span> <span class="n">sliced_transport_bar</span>
    <span class="kn">from</span> <span class="nn">numpy.polynomial.polynomial</span> <span class="k">import</span> <span class="n">polyval</span>
    <span class="n">shap1</span> <span class="o">=</span> <span class="n">embed_coord</span><span class="o">.</span><span class="n">shape</span>

    <span class="n">shap2</span> <span class="o">=</span> <span class="n">original_ref</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">output</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">bar_coord</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">shap1</span><span class="p">)</span><span class="o">&lt;=</span><span class="mi">1</span><span class="p">:</span>
        <span class="n">output</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">shap2</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">shap2</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
        <span class="n">bar_coord</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">nb_neigh</span><span class="p">,))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">output</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">shap2</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">shap2</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">shap1</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
        <span class="n">bar_coord</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">shap1</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">nb_neigh</span><span class="p">))</span>

    <span class="n">result</span><span class="p">,</span> <span class="n">dists</span> <span class="o">=</span> <span class="n">flann_obj</span><span class="o">.</span><span class="n">nn_index</span><span class="p">(</span><span class="n">transpose</span><span class="p">(</span><span class="n">embed_coord</span><span class="p">),</span> <span class="n">nb_neigh</span><span class="p">)</span>


    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">shap1</span><span class="p">)</span><span class="o">&lt;=</span><span class="mi">1</span><span class="p">:</span>
        <span class="n">bar_coord</span> <span class="o">=</span> <span class="n">bar_coord2d</span><span class="p">(</span><span class="n">embed_ref</span><span class="p">[:,</span><span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">,:]],</span><span class="n">embed_coord</span><span class="p">,</span><span class="n">cond</span><span class="o">=</span><span class="mf">1.</span><span class="o">/</span><span class="mi">50</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">nb_neigh</span><span class="p">,))</span>
        <span class="n">point_cloud_w</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">original_ref</span><span class="p">[:,:,</span><span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">,:]])</span>
        <span class="c1"># Weighting</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_neigh</span><span class="p">):</span>
            <span class="n">rad_dist_bar</span> <span class="o">=</span> <span class="n">sqrt</span><span class="p">(</span><span class="nb">sum</span><span class="p">((</span><span class="n">point_cloud_w</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">,:,</span><span class="n">i</span><span class="p">]</span><span class="o">-</span><span class="n">array</span><span class="p">(</span><span class="n">cent</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">ones</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span><span class="n">shap2</span><span class="p">[</span><span class="mi">1</span><span class="p">]))))</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">support</span><span class="p">:</span>
                <span class="n">point_cloud_w</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">,:,</span><span class="n">i</span><span class="p">]</span> <span class="o">/=</span> <span class="n">exp</span><span class="p">(</span><span class="n">polyval</span><span class="p">(</span><span class="n">rad_dist_bar</span><span class="p">,</span><span class="n">coeff_poly</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">point_cloud_w</span><span class="p">[</span><span class="mi">2</span><span class="p">,:,</span><span class="n">i</span><span class="p">]</span> <span class="o">*=</span> <span class="n">exp</span><span class="p">(</span><span class="n">polyval</span><span class="p">(</span><span class="n">rad_dist_bar</span><span class="p">,</span><span class="n">coeff_poly</span><span class="p">))</span>
        <span class="n">ind</span> <span class="o">=</span> <span class="n">argsort</span><span class="p">(</span><span class="n">bar_coord</span><span class="p">)</span>
        <span class="n">init_bar</span> <span class="o">=</span> <span class="n">point_cloud_w</span><span class="p">[:,:,</span><span class="n">ind</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
        <span class="n">output</span><span class="p">,</span><span class="n">basis_out</span> <span class="o">=</span> <span class="n">sliced_transport_bar</span><span class="p">(</span><span class="n">point_cloud_w</span><span class="p">,</span><span class="n">bar_coord</span><span class="p">,</span><span class="n">nb_iter</span><span class="o">=</span><span class="n">nb_iter</span><span class="p">,</span><span class="n">tol</span><span class="o">=</span><span class="mf">0.000000001</span><span class="p">,</span><span class="n">alph</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span><span class="n">bar_init</span><span class="o">=</span><span class="n">init_bar</span><span class="p">,</span><span class="n">rand_en</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">basis</span><span class="o">=</span><span class="n">basis</span><span class="p">,</span><span class="n">support</span><span class="o">=</span><span class="n">support</span><span class="p">)</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap1</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
            <span class="n">bar_coord</span><span class="p">[</span><span class="n">i</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">bar_coord2d</span><span class="p">(</span><span class="n">embed_ref</span><span class="p">[:,</span><span class="n">result</span><span class="p">[</span><span class="n">i</span><span class="p">]],</span><span class="n">embed_coord</span><span class="p">[:,</span><span class="n">i</span><span class="p">],</span><span class="n">cond</span><span class="o">=</span><span class="mf">1.</span><span class="o">/</span><span class="mi">50</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">nb_neigh</span><span class="p">,))</span>

            <span class="n">point_cloud_w</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">original_ref</span><span class="p">[:,:,</span><span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">,:]])</span>
            <span class="c1"># Weighting</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_neigh</span><span class="p">):</span>
                <span class="n">rad_dist_bar</span> <span class="o">=</span> <span class="n">sqrt</span><span class="p">(</span><span class="nb">sum</span><span class="p">((</span><span class="n">point_cloud_w</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">,:,</span><span class="n">i</span><span class="p">]</span><span class="o">-</span><span class="n">array</span><span class="p">(</span><span class="n">cent</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">ones</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span><span class="n">shap2</span><span class="p">[</span><span class="mi">1</span><span class="p">]))))</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">support</span><span class="p">:</span>
                    <span class="n">point_cloud_w</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">,:,</span><span class="n">i</span><span class="p">]</span> <span class="o">/=</span> <span class="n">exp</span><span class="p">(</span><span class="n">polyval</span><span class="p">(</span><span class="n">rad_dist_bar</span><span class="p">,</span><span class="n">coeff_poly</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">point_cloud_w</span><span class="p">[</span><span class="mi">2</span><span class="p">,:,</span><span class="n">i</span><span class="p">]</span> <span class="o">*=</span> <span class="n">exp</span><span class="p">(</span><span class="n">polyval</span><span class="p">(</span><span class="n">rad_dist_bar</span><span class="p">,</span><span class="n">coeff_poly</span><span class="p">))</span>
            <span class="n">ind</span> <span class="o">=</span> <span class="n">argsort</span><span class="p">(</span><span class="n">bar_coord</span><span class="p">[</span><span class="n">i</span><span class="p">,:])</span>
            <span class="n">init_bar</span> <span class="o">=</span> <span class="n">point_cloud_w</span><span class="p">[:,:,</span><span class="n">result</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">ind</span><span class="p">[</span><span class="mi">0</span><span class="p">]]]</span>
        <span class="n">output</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">],</span><span class="n">basis_out</span> <span class="o">=</span> <span class="n">sliced_transport_bar</span><span class="p">(</span><span class="n">original_ref</span><span class="p">[:,:,</span><span class="n">result</span><span class="p">[</span><span class="n">i</span><span class="p">,:]],</span><span class="n">bar_coord</span><span class="p">,</span><span class="n">nb_iter</span><span class="o">=</span><span class="n">nb_iter</span><span class="p">,</span><span class="n">tol</span><span class="o">=</span><span class="mf">0.0000001</span><span class="p">,</span><span class="n">alph</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span><span class="n">bar_init</span><span class="o">=</span><span class="n">init_bar</span><span class="p">,</span><span class="n">rand_en</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">basis</span><span class="o">=</span><span class="n">basis</span><span class="p">,</span><span class="n">support</span><span class="o">=</span><span class="n">support</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">output</span><span class="p">,</span><span class="n">bar_coord</span><span class="p">,</span><span class="n">result</span>


<span class="k">def</span> <span class="nf">w_inverse_mapping_hybrid_2D</span><span class="p">(</span><span class="n">embed_coord</span><span class="p">,</span><span class="n">embed_ref</span><span class="p">,</span><span class="n">original_ref_clouds</span><span class="p">,</span><span class="n">original_ref_im</span><span class="p">,</span><span class="n">flann_obj</span><span class="p">,</span><span class="n">cent</span><span class="p">,</span><span class="n">coeff_poly</span><span class="p">,</span><span class="n">basis</span><span class="p">,</span><span class="n">nb_neigh</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span><span class="n">nb_iter</span><span class="o">=</span><span class="mi">1000</span><span class="p">):</span>
    <span class="kn">from</span> <span class="nn">numpy</span> <span class="k">import</span> <span class="n">zeros</span><span class="p">,</span><span class="n">diag</span><span class="p">,</span><span class="n">argsort</span>
    <span class="kn">from</span> <span class="nn">optim_utils</span> <span class="k">import</span> <span class="n">sliced_transport_bar</span><span class="p">,</span><span class="n">euc_support_barycenter</span>
    <span class="kn">from</span> <span class="nn">numpy.polynomial.polynomial</span> <span class="k">import</span> <span class="n">polyval</span>
    <span class="n">shap1</span> <span class="o">=</span> <span class="n">embed_coord</span><span class="o">.</span><span class="n">shape</span>

    <span class="n">shap2</span> <span class="o">=</span> <span class="n">original_ref</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">output</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">bar_coord</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">shap1</span><span class="p">)</span><span class="o">&lt;=</span><span class="mi">1</span><span class="p">:</span>
        <span class="n">output</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">shap2</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">shap2</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
        <span class="n">bar_coord</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">nb_neigh</span><span class="p">,))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">output</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">shap2</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">shap2</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">shap1</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
        <span class="n">bar_coord</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">shap1</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">nb_neigh</span><span class="p">))</span>

    <span class="n">result</span><span class="p">,</span> <span class="n">dists</span> <span class="o">=</span> <span class="n">flann_obj</span><span class="o">.</span><span class="n">nn_index</span><span class="p">(</span><span class="n">transpose</span><span class="p">(</span><span class="n">embed_coord</span><span class="p">),</span> <span class="n">nb_neigh</span><span class="p">)</span>


    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">shap1</span><span class="p">)</span><span class="o">&lt;=</span><span class="mi">1</span><span class="p">:</span>
        <span class="n">bar_coord</span> <span class="o">=</span> <span class="n">bar_coord2d</span><span class="p">(</span><span class="n">embed_ref</span><span class="p">[:,</span><span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">,:]],</span><span class="n">embed_coord</span><span class="p">,</span><span class="n">cond</span><span class="o">=</span><span class="mf">1.</span><span class="o">/</span><span class="mi">50</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">nb_neigh</span><span class="p">,))</span>
        <span class="n">point_cloud_w</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">original_ref</span><span class="p">[:,:,</span><span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">,:]])</span>
        <span class="c1"># Weighting</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_neigh</span><span class="p">):</span>
            <span class="n">rad_dist_bar</span> <span class="o">=</span> <span class="n">sqrt</span><span class="p">(</span><span class="nb">sum</span><span class="p">((</span><span class="n">point_cloud_w</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">,:,</span><span class="n">i</span><span class="p">]</span><span class="o">-</span><span class="n">array</span><span class="p">(</span><span class="n">cent</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">ones</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span><span class="n">shap2</span><span class="p">[</span><span class="mi">1</span><span class="p">]))))</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
            <span class="n">point_cloud_w</span><span class="p">[</span><span class="mi">2</span><span class="p">,:,</span><span class="n">i</span><span class="p">]</span> <span class="o">*=</span> <span class="n">exp</span><span class="p">(</span><span class="n">polyval</span><span class="p">(</span><span class="n">rad_dist_bar</span><span class="p">,</span><span class="n">coeff_poly</span><span class="p">))</span>
        <span class="n">ind</span> <span class="o">=</span> <span class="n">argsort</span><span class="p">(</span><span class="n">bar_coord</span><span class="p">)</span>
        <span class="n">init_bar</span> <span class="o">=</span> <span class="n">point_cloud_w</span><span class="p">[:,:,</span><span class="n">ind</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
        <span class="n">output</span><span class="p">,</span><span class="n">basis_out</span> <span class="o">=</span> <span class="n">sliced_transport_bar</span><span class="p">(</span><span class="n">point_cloud_w</span><span class="p">,</span><span class="n">bar_coord</span><span class="p">,</span><span class="n">nb_iter</span><span class="o">=</span><span class="n">nb_iter</span><span class="p">,</span><span class="n">tol</span><span class="o">=</span><span class="mf">0.000000001</span><span class="p">,</span><span class="n">alph</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span><span class="n">bar_init</span><span class="o">=</span><span class="n">init_bar</span><span class="p">,</span><span class="n">rand_en</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">basis</span><span class="o">=</span><span class="n">basis</span><span class="p">)</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap1</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
            <span class="n">bar_coord</span><span class="p">[</span><span class="n">i</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">bar_coord2d</span><span class="p">(</span><span class="n">embed_ref</span><span class="p">[:,</span><span class="n">result</span><span class="p">[</span><span class="n">i</span><span class="p">]],</span><span class="n">embed_coord</span><span class="p">[:,</span><span class="n">i</span><span class="p">],</span><span class="n">cond</span><span class="o">=</span><span class="mf">1.</span><span class="o">/</span><span class="mi">50</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">nb_neigh</span><span class="p">,))</span>

            <span class="n">point_cloud_w</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">original_ref</span><span class="p">[:,:,</span><span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">,:]])</span>
            <span class="c1"># Weighting</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_neigh</span><span class="p">):</span>
                <span class="n">rad_dist_bar</span> <span class="o">=</span> <span class="n">sqrt</span><span class="p">(</span><span class="nb">sum</span><span class="p">((</span><span class="n">point_cloud_ref</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">,:,</span><span class="n">i</span><span class="p">]</span><span class="o">-</span><span class="n">array</span><span class="p">(</span><span class="n">cent</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">ones</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span><span class="n">shap2</span><span class="p">[</span><span class="mi">1</span><span class="p">]))))</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
                <span class="n">point_cloud_w</span><span class="p">[</span><span class="mi">2</span><span class="p">,:,</span><span class="n">i</span><span class="p">]</span> <span class="o">*=</span> <span class="n">exp</span><span class="p">(</span><span class="n">polyval</span><span class="p">(</span><span class="n">rad_dist_bar</span><span class="p">,</span><span class="n">coeff_poly</span><span class="p">))</span>
            <span class="n">ind</span> <span class="o">=</span> <span class="n">argsort</span><span class="p">(</span><span class="n">bar_coord</span><span class="p">[</span><span class="n">i</span><span class="p">,:])</span>
            <span class="n">init_bar</span> <span class="o">=</span> <span class="n">point_cloud_w</span><span class="p">[:,:,</span><span class="n">result</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">ind</span><span class="p">[</span><span class="mi">0</span><span class="p">]]]</span>
        <span class="n">output</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">],</span><span class="n">basis_out</span> <span class="o">=</span> <span class="n">sliced_transport_bar</span><span class="p">(</span><span class="n">original_ref</span><span class="p">[:,:,</span><span class="n">result</span><span class="p">[</span><span class="n">i</span><span class="p">,:]],</span><span class="n">bar_coord</span><span class="p">,</span><span class="n">nb_iter</span><span class="o">=</span><span class="n">nb_iter</span><span class="p">,</span><span class="n">tol</span><span class="o">=</span><span class="mf">0.0000001</span><span class="p">,</span><span class="n">alph</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span><span class="n">bar_init</span><span class="o">=</span><span class="n">init_bar</span><span class="p">,</span><span class="n">rand_en</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">basis</span><span class="o">=</span><span class="n">basis</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">output</span><span class="p">,</span><span class="n">bar_coord</span><span class="p">,</span><span class="n">result</span>




<span class="k">def</span> <span class="nf">psf_zeros_detector</span><span class="p">(</span><span class="n">im</span><span class="p">,</span><span class="n">center</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">kmad</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span><span class="n">deg</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span><span class="n">win</span><span class="o">=</span><span class="mi">9</span><span class="p">,</span><span class="n">spline_ord</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span><span class="n">nb_rings</span> <span class="o">=</span> <span class="mi">7</span><span class="p">):</span> <span class="c1"># deg: degree of the polynomial interpolator</span>
    <span class="kn">from</span> <span class="nn">utils</span> <span class="k">import</span> <span class="n">polar</span><span class="p">,</span><span class="n">mad</span>
    <span class="kn">from</span> <span class="nn">numpy</span> <span class="k">import</span> <span class="n">less</span><span class="p">,</span><span class="n">zeros</span><span class="p">,</span><span class="nb">float</span> <span class="k">as</span> <span class="n">floatnump</span><span class="p">,</span><span class="n">flipud</span><span class="p">,</span><span class="n">pi</span><span class="p">,</span><span class="n">array</span><span class="p">,</span><span class="n">argsort</span>
    <span class="kn">from</span> <span class="nn">numpy.polynomial.polynomial</span> <span class="k">import</span> <span class="n">polyfit</span>
    <span class="kn">from</span> <span class="nn">scipy.signal</span> <span class="k">import</span> <span class="n">argrelextrema</span>
    <span class="kn">from</span> <span class="nn">copy</span> <span class="k">import</span> <span class="n">deepcopy</span>
    <span class="kn">from</span> <span class="nn">scipy.signal</span> <span class="k">import</span> <span class="n">savgol_filter</span>
    <span class="kn">from</span> <span class="nn">scipy.interpolate</span> <span class="k">import</span> <span class="n">interp1d</span>
    <span class="kn">from</span> <span class="nn">scipy.signal</span> <span class="k">import</span> <span class="n">medfilt</span>

    <span class="k">if</span> <span class="n">win</span><span class="o">%</span><span class="mi">2</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
        <span class="n">win</span><span class="o">-=</span><span class="mi">1</span>

    <span class="k">if</span> <span class="n">center</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">center</span> <span class="o">=</span> <span class="n">flipud</span><span class="p">(</span><span class="n">where</span><span class="p">(</span><span class="n">im</span><span class="o">==</span><span class="n">im</span><span class="o">.</span><span class="n">max</span><span class="p">()))</span>
    <span class="n">pol_im</span> <span class="o">=</span> <span class="n">polar</span><span class="p">(</span><span class="n">im</span><span class="p">,</span><span class="n">center</span><span class="o">=</span><span class="n">center</span><span class="p">)</span>

    <span class="n">nb_angles</span> <span class="o">=</span> <span class="n">pol_im</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">angle_max</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">pi</span><span class="o">*</span><span class="nb">float</span><span class="p">(</span><span class="n">nb_angles</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="n">nb_angles</span>
    <span class="n">zeros_pos</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
    <span class="n">nb_zeros_max</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="c1"># First detection</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_angles</span><span class="p">):</span>
        <span class="n">rz</span> <span class="o">=</span> <span class="n">argrelextrema</span><span class="p">(</span><span class="n">pol_im</span><span class="p">[</span><span class="n">i</span><span class="p">,:],</span><span class="n">less</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">i</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
            <span class="n">nb_zeros_max</span> <span class="o">=</span> <span class="n">size</span><span class="p">(</span><span class="n">rz</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">size</span><span class="p">(</span><span class="n">rz</span><span class="p">)):</span>
                <span class="n">zeros_pos</span><span class="o">.</span><span class="n">append</span><span class="p">({})</span>
                <span class="n">zeros_pos</span><span class="p">[</span><span class="n">l</span><span class="p">][</span><span class="n">i</span><span class="o">*</span><span class="mi">2</span><span class="o">*</span><span class="n">pi</span><span class="o">/</span><span class="n">nb_angles</span><span class="p">]</span> <span class="o">=</span> <span class="n">rz</span><span class="p">[</span><span class="n">l</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">min</span><span class="p">(</span><span class="n">nb_zeros_max</span><span class="p">,</span><span class="n">size</span><span class="p">(</span><span class="n">rz</span><span class="p">))):</span>
                <span class="n">zeros_pos</span><span class="p">[</span><span class="n">l</span><span class="p">][</span><span class="n">i</span><span class="o">*</span><span class="mi">2</span><span class="o">*</span><span class="n">pi</span><span class="o">/</span><span class="n">nb_angles</span><span class="p">]</span> <span class="o">=</span> <span class="n">rz</span><span class="p">[</span><span class="n">l</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">size</span><span class="p">(</span><span class="n">rz</span><span class="p">)</span><span class="o">&gt;</span><span class="n">nb_zeros_max</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nb_zeros_max</span><span class="p">,</span><span class="n">size</span><span class="p">(</span><span class="n">rz</span><span class="p">)):</span>
                    <span class="n">zeros_pos</span><span class="o">.</span><span class="n">append</span><span class="p">({})</span>
                    <span class="n">zeros_pos</span><span class="p">[</span><span class="n">l</span><span class="p">][</span><span class="n">i</span><span class="o">*</span><span class="mi">2</span><span class="o">*</span><span class="n">pi</span><span class="o">/</span><span class="n">nb_angles</span><span class="p">]</span> <span class="o">=</span> <span class="n">rz</span><span class="p">[</span><span class="n">l</span><span class="p">]</span>
                <span class="n">nb_zeros_max</span> <span class="o">=</span> <span class="n">size</span><span class="p">(</span><span class="n">rz</span><span class="p">)</span>



    <span class="c1"># Remapping outliers</span>
    <span class="c1">#print &quot;nb zeros: &quot;,nb_zeros_max,len(zeros_pos)</span>

    <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_zeros_max</span><span class="p">):</span>
        <span class="n">nb_samp</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">zeros_pos</span><span class="p">[</span><span class="n">l</span><span class="p">])</span>
        <span class="n">angles</span> <span class="o">=</span> <span class="n">zeros_pos</span><span class="p">[</span><span class="n">l</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
        <span class="n">radius</span> <span class="o">=</span> <span class="n">zeros_pos</span><span class="p">[</span><span class="n">l</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">()</span>
        <span class="n">outliers</span> <span class="o">=</span> <span class="n">where</span><span class="p">(</span><span class="n">radius</span><span class="o">&gt;</span><span class="n">kmad</span><span class="o">*</span><span class="n">mad</span><span class="p">(</span><span class="n">radius</span><span class="p">)</span><span class="o">+</span><span class="n">median</span><span class="p">(</span><span class="n">radius</span><span class="p">))</span>
        <span class="n">out_detect</span><span class="o">=</span><span class="kc">False</span>
        <span class="k">if</span> <span class="n">size</span><span class="p">(</span><span class="n">outliers</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">out_detect</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
                <span class="n">out_detect</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">zeros_pos</span><span class="o">.</span><span class="n">append</span><span class="p">({})</span>
            <span class="n">zeros_pos_cp</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">zeros_pos</span><span class="p">)</span>
            <span class="c1">#print &quot;nb zeros: &quot;,len(zeros_pos)</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">size</span><span class="p">(</span><span class="n">outliers</span><span class="p">[</span><span class="mi">0</span><span class="p">])):</span>

                <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">l</span><span class="p">,</span><span class="n">nb_zeros_max</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>

                    <span class="k">if</span> <span class="n">angles</span><span class="p">[</span><span class="n">outliers</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">i</span><span class="p">]]</span> <span class="ow">in</span> <span class="n">zeros_pos</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                        <span class="k">del</span> <span class="n">zeros_pos</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="n">angles</span><span class="p">[</span><span class="n">outliers</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">i</span><span class="p">]]]</span>
                    <span class="k">if</span> <span class="n">k</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">angles</span><span class="p">[</span><span class="n">outliers</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">i</span><span class="p">]]</span> <span class="ow">in</span> <span class="n">zeros_pos_cp</span><span class="p">[</span><span class="n">k</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                            <span class="n">zeros_pos</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="n">angles</span><span class="p">[</span><span class="n">outliers</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">i</span><span class="p">]]]</span> <span class="o">=</span> <span class="n">zeros_pos_cp</span><span class="p">[</span><span class="n">k</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="n">angles</span><span class="p">[</span><span class="n">outliers</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">i</span><span class="p">]]]</span>

    <span class="n">zeros_pos_clean</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">zeros_pos</span><span class="p">)):</span>
        <span class="k">if</span> <span class="n">size</span><span class="p">(</span><span class="n">zeros_pos</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
            <span class="n">zeros_pos_clean</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">zeros_pos</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>

    <span class="n">zeros_pos</span> <span class="o">=</span> <span class="n">zeros_pos_clean</span>
    <span class="c1"># Final mapping</span>
    <span class="n">final_zeros_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
    <span class="n">poly_out</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
    <span class="n">width</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>


    <span class="c1"># Preprocessings for interpolation</span>

    <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">zeros_pos</span><span class="p">)):</span>

        <span class="k">if</span> <span class="mi">0</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">zeros_pos</span><span class="p">[</span><span class="n">l</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">zeros_pos</span><span class="p">[</span><span class="n">l</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">zeros_pos</span><span class="p">[</span><span class="n">l</span><span class="p">][</span><span class="n">array</span><span class="p">(</span><span class="n">zeros_pos</span><span class="p">[</span><span class="n">l</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span><span class="o">.</span><span class="n">min</span><span class="p">()]</span>

        <span class="n">zeros_pos</span><span class="p">[</span><span class="n">l</span><span class="p">][</span><span class="mi">2</span><span class="o">*</span><span class="n">pi</span><span class="p">]</span> <span class="o">=</span> <span class="n">zeros_pos</span><span class="p">[</span><span class="n">l</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>

        <span class="n">nb_samp</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">zeros_pos</span><span class="p">[</span><span class="n">l</span><span class="p">])</span>
        <span class="n">final_zeros_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">zeros</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span><span class="n">nb_samp</span><span class="p">)))</span>
        <span class="n">dict_keys</span> <span class="o">=</span> <span class="n">zeros_pos</span><span class="p">[</span><span class="n">l</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
        <span class="n">ind</span> <span class="o">=</span> <span class="n">argsort</span><span class="p">(</span><span class="n">dict_keys</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_samp</span><span class="p">):</span>
            <span class="n">final_zeros_list</span><span class="p">[</span><span class="n">l</span><span class="p">][</span><span class="mi">1</span><span class="p">,</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">dict_keys</span><span class="p">[</span><span class="n">ind</span><span class="p">[</span><span class="n">k</span><span class="p">]]</span>
            <span class="n">final_zeros_list</span><span class="p">[</span><span class="n">l</span><span class="p">][</span><span class="mi">0</span><span class="p">,</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">zeros_pos</span><span class="p">[</span><span class="n">l</span><span class="p">][</span><span class="n">dict_keys</span><span class="p">[</span><span class="n">ind</span><span class="p">[</span><span class="n">k</span><span class="p">]]]</span>

        <span class="c1">#final_zeros_list[l][1,:] = array(zeros_pos[l].keys())</span>
        <span class="c1">#final_zeros_list[l][0,:] = array(zeros_pos[l].values())</span>


        <span class="k">if</span> <span class="n">nb_samp</span><span class="o">&gt;</span><span class="n">win</span><span class="p">:</span>
            <span class="c1">#print final_zeros_list[l][0,:]</span>
            <span class="k">if</span> <span class="n">nb_samp</span><span class="o">&gt;</span><span class="mi">2</span><span class="o">*</span><span class="n">win</span><span class="p">:</span>
                <span class="n">final_zeros_list</span><span class="p">[</span><span class="n">l</span><span class="p">][</span><span class="mi">0</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">medfilt</span><span class="p">(</span><span class="n">final_zeros_list</span><span class="p">[</span><span class="n">l</span><span class="p">][</span><span class="mi">0</span><span class="p">,:],</span><span class="n">win</span><span class="p">)</span>
            <span class="n">final_zeros_list</span><span class="p">[</span><span class="n">l</span><span class="p">][</span><span class="mi">0</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">savgol_filter</span><span class="p">(</span><span class="n">final_zeros_list</span><span class="p">[</span><span class="n">l</span><span class="p">][</span><span class="mi">0</span><span class="p">,:],</span><span class="n">win</span><span class="p">,</span><span class="n">deg</span><span class="p">)</span>

    <span class="c1"># Enforcing radial monotonicity</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_angles</span><span class="p">):</span>
        <span class="n">key</span> <span class="o">=</span> <span class="n">i</span><span class="o">*</span><span class="mi">2</span><span class="o">*</span><span class="n">pi</span><span class="o">/</span><span class="n">nb_angles</span>
        <span class="n">val</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">zeros_pos</span><span class="p">)):</span>
            <span class="n">ind</span> <span class="o">=</span> <span class="n">where</span><span class="p">(</span><span class="n">final_zeros_list</span><span class="p">[</span><span class="n">l</span><span class="p">][</span><span class="mi">1</span><span class="p">,:]</span><span class="o">==</span><span class="n">key</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ind</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
                <span class="n">val</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">final_zeros_list</span><span class="p">[</span><span class="n">l</span><span class="p">][</span><span class="mi">0</span><span class="p">,</span><span class="n">ind</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span>

        <span class="n">ind_val</span> <span class="o">=</span> <span class="n">argsort</span><span class="p">(</span><span class="n">array</span><span class="p">(</span><span class="n">val</span><span class="p">))</span>
        <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">zeros_pos</span><span class="p">)):</span>
            <span class="n">ind</span> <span class="o">=</span> <span class="n">where</span><span class="p">(</span><span class="n">final_zeros_list</span><span class="p">[</span><span class="n">l</span><span class="p">][</span><span class="mi">1</span><span class="p">,:]</span><span class="o">==</span><span class="n">key</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ind</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
                <span class="n">final_zeros_list</span><span class="p">[</span><span class="n">l</span><span class="p">][</span><span class="mi">0</span><span class="p">,</span><span class="n">ind</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="n">val</span><span class="p">[</span><span class="n">count</span><span class="p">]</span>
                <span class="n">count</span><span class="o">+=</span><span class="mi">1</span>

    <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">zeros_pos</span><span class="p">)):</span>
        <span class="n">nb_samp</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">zeros_pos</span><span class="p">[</span><span class="n">l</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">nb_samp</span><span class="o">&gt;</span><span class="n">win</span><span class="p">:</span>
            <span class="n">final_zeros_list</span><span class="p">[</span><span class="n">l</span><span class="p">][</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">final_zeros_list</span><span class="p">[</span><span class="n">l</span><span class="p">][</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">final_zeros_list</span><span class="p">[</span><span class="n">l</span><span class="p">][</span><span class="mi">0</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span><span class="o">/</span><span class="mi">2</span>
            <span class="n">final_zeros_list</span><span class="p">[</span><span class="n">l</span><span class="p">][</span><span class="mi">0</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">final_zeros_list</span><span class="p">[</span><span class="n">l</span><span class="p">][</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">poly_out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">interp1d</span><span class="p">(</span><span class="n">final_zeros_list</span><span class="p">[</span><span class="n">l</span><span class="p">][</span><span class="mi">1</span><span class="p">,:],</span><span class="n">final_zeros_list</span><span class="p">[</span><span class="n">l</span><span class="p">][</span><span class="mi">0</span><span class="p">,:],</span><span class="n">kind</span><span class="o">=</span><span class="n">spline_ord</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">l</span><span class="o">&lt;</span> <span class="n">nb_rings</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">l</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
                    <span class="n">width</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">array</span><span class="p">(</span><span class="n">zeros_pos</span><span class="p">[</span><span class="n">l</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">())</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">width</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">array</span><span class="p">(</span><span class="n">zeros_pos</span><span class="p">[</span><span class="n">l</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">())</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">-</span><span class="n">width</span><span class="p">[</span><span class="n">l</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>




    <span class="k">return</span> <span class="n">final_zeros_list</span><span class="p">,</span><span class="n">poly_out</span><span class="p">,</span><span class="n">width</span>



<span class="k">def</span> <span class="nf">ring_separation</span><span class="p">(</span><span class="n">im</span><span class="p">,</span><span class="n">center</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">kmad</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span><span class="n">deg</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span><span class="n">win</span><span class="o">=</span><span class="mi">9</span><span class="p">,</span><span class="n">win2</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">nb_rings</span> <span class="o">=</span> <span class="mi">7</span><span class="p">):</span>
    <span class="kn">from</span> <span class="nn">utils</span> <span class="k">import</span> <span class="n">polar_coord</span>
    <span class="kn">from</span> <span class="nn">numpy</span> <span class="k">import</span> <span class="n">argsort</span><span class="p">,</span><span class="n">flipud</span><span class="p">,</span><span class="n">median</span><span class="p">,</span><span class="n">zeros</span><span class="p">,</span><span class="n">ones</span><span class="p">,</span><span class="n">sqrt</span>
    <span class="kn">from</span> <span class="nn">numpy.linalg</span> <span class="k">import</span> <span class="n">norm</span>
    <span class="kn">from</span> <span class="nn">scipy.signal</span> <span class="k">import</span> <span class="n">medfilt</span>

    <span class="k">if</span> <span class="n">center</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">center</span> <span class="o">=</span> <span class="n">flipud</span><span class="p">(</span><span class="n">where</span><span class="p">(</span><span class="n">im</span><span class="o">==</span><span class="n">im</span><span class="o">.</span><span class="n">max</span><span class="p">()))</span>
    <span class="n">final_zeros_list</span><span class="p">,</span><span class="n">poly_out</span><span class="p">,</span><span class="n">widths</span> <span class="o">=</span> <span class="n">psf_zeros_detector</span><span class="p">(</span><span class="n">im</span><span class="p">,</span><span class="n">center</span><span class="o">=</span><span class="n">center</span><span class="p">,</span><span class="n">kmad</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span><span class="n">deg</span><span class="o">=</span><span class="n">deg</span><span class="p">,</span><span class="n">win</span><span class="o">=</span><span class="n">win</span><span class="p">,</span><span class="n">nb_rings</span><span class="o">=</span><span class="n">nb_rings</span><span class="p">)</span>

    <span class="n">rtheta_pos</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span><span class="n">size</span><span class="p">(</span><span class="n">im</span><span class="p">)))</span>
    <span class="n">cart_pos</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span><span class="n">size</span><span class="p">(</span><span class="n">im</span><span class="p">)))</span>
    <span class="n">shap</span> <span class="o">=</span> <span class="n">im</span><span class="o">.</span><span class="n">shape</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
            <span class="n">rtheta_pos</span><span class="p">[:,</span><span class="n">j</span><span class="o">+</span><span class="n">i</span><span class="o">*</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="n">polar_coord</span><span class="p">([</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">],</span><span class="n">center</span><span class="p">)</span>
            <span class="n">cart_pos</span><span class="p">[:,</span><span class="n">j</span><span class="o">+</span><span class="n">i</span><span class="o">*</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span>

    <span class="n">ind</span> <span class="o">=</span> <span class="n">argsort</span><span class="p">(</span><span class="n">rtheta_pos</span><span class="p">[</span><span class="mi">0</span><span class="p">,:])</span>

    <span class="n">label_im</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">(</span><span class="n">shap</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">nb_rings</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">nb_rings</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">poly_out</span><span class="p">)</span>



    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">size</span><span class="p">(</span><span class="n">im</span><span class="p">)):</span>
        <span class="n">found</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">l</span><span class="o">=</span><span class="mi">0</span>
        <span class="sd">&quot;&quot;&quot;r = zeros((nb_rings+1,))</span>
<span class="sd">        for l in range(0,nb_rings):</span>
<span class="sd">            r[l] = poly_out[l](rtheta_pos[1,ind[k]])</span>

<span class="sd">        r[nb_rings] = rtheta_pos[0,ind[k]]</span>

<span class="sd">        argsr = argsort(r)</span>
<span class="sd">        #print sum(abs(r[0:nb_rings]-r[argsr[0:nb_rings]]))</span>

<span class="sd">        if argsr[nb_rings]==nb_rings:</span>
<span class="sd">            label_im[cart_pos[1,ind[k]],cart_pos[0,ind[k]]] = nb_rings</span>
<span class="sd">        else:</span>
<span class="sd">            label_im[cart_pos[1,ind[k]],cart_pos[0,ind[k]]] = where(argsr==argsr[nb_rings]+1)[0]+1&quot;&quot;&quot;</span>

        <span class="k">while</span> <span class="n">found</span> <span class="ow">is</span> <span class="kc">False</span> <span class="ow">and</span> <span class="n">l</span><span class="o">&lt;</span> <span class="n">nb_rings</span><span class="p">:</span>


            <span class="k">if</span> <span class="n">poly_out</span><span class="p">[</span><span class="n">l</span><span class="p">](</span><span class="n">rtheta_pos</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="n">k</span><span class="p">])</span> <span class="o">&gt;=</span> <span class="n">rtheta_pos</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">k</span><span class="p">]:</span>

                <span class="k">if</span> <span class="n">l</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
                    <span class="n">label_im</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">rtheta_pos</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">k</span><span class="p">]</span><span class="o">*</span><span class="n">sin</span><span class="p">(</span><span class="n">rtheta_pos</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="n">k</span><span class="p">])</span><span class="o">+</span><span class="n">center</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span><span class="nb">int</span><span class="p">(</span><span class="n">rtheta_pos</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">k</span><span class="p">]</span><span class="o">*</span><span class="n">cos</span><span class="p">(</span><span class="n">rtheta_pos</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="n">k</span><span class="p">])</span><span class="o">+</span><span class="n">center</span><span class="p">[</span><span class="mi">0</span><span class="p">])]</span> <span class="o">=</span> <span class="n">l</span><span class="o">+</span><span class="mi">1</span>
                    <span class="n">found</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">poly_out</span><span class="p">[</span><span class="n">l</span><span class="o">-</span><span class="mi">1</span><span class="p">](</span><span class="n">rtheta_pos</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="n">k</span><span class="p">])</span> <span class="o">&lt;=</span> <span class="n">rtheta_pos</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">k</span><span class="p">]:</span>
                        <span class="n">label_im</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">rtheta_pos</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">k</span><span class="p">]</span><span class="o">*</span><span class="n">sin</span><span class="p">(</span><span class="n">rtheta_pos</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="n">k</span><span class="p">])</span><span class="o">+</span><span class="n">center</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span><span class="nb">int</span><span class="p">(</span><span class="n">rtheta_pos</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">k</span><span class="p">]</span><span class="o">*</span><span class="n">cos</span><span class="p">(</span><span class="n">rtheta_pos</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="n">k</span><span class="p">])</span><span class="o">+</span><span class="n">center</span><span class="p">[</span><span class="mi">0</span><span class="p">])]</span> <span class="o">=</span> <span class="n">l</span><span class="o">+</span><span class="mi">1</span>
                        <span class="n">found</span> <span class="o">=</span> <span class="kc">True</span>

            <span class="k">if</span> <span class="n">l</span><span class="o">==</span><span class="n">nb_rings</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span>

                <span class="k">if</span> <span class="n">poly_out</span><span class="p">[</span><span class="n">l</span><span class="p">](</span><span class="n">rtheta_pos</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="n">k</span><span class="p">])</span> <span class="o">&lt;=</span> <span class="n">rtheta_pos</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">k</span><span class="p">]:</span>
                    <span class="n">label_im</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">rtheta_pos</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">k</span><span class="p">]</span><span class="o">*</span><span class="n">sin</span><span class="p">(</span><span class="n">rtheta_pos</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="n">k</span><span class="p">])</span><span class="o">+</span><span class="n">center</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span><span class="nb">int</span><span class="p">(</span><span class="n">rtheta_pos</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">k</span><span class="p">]</span><span class="o">*</span><span class="n">cos</span><span class="p">(</span><span class="n">rtheta_pos</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="n">k</span><span class="p">])</span><span class="o">+</span><span class="n">center</span><span class="p">[</span><span class="mi">0</span><span class="p">])]</span> <span class="o">=</span> <span class="n">l</span><span class="o">+</span><span class="mi">1</span>
                    <span class="n">found</span> <span class="o">=</span> <span class="kc">True</span>

            <span class="n">l</span><span class="o">+=</span><span class="mi">1</span>



    <span class="n">i</span><span class="p">,</span><span class="n">j</span> <span class="o">=</span> <span class="n">where</span><span class="p">(</span><span class="n">label_im</span><span class="o">==</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">label_im_ref</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">label_im</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">i</span><span class="p">)):</span>
            <span class="n">increase</span><span class="o">=</span><span class="kc">True</span>
            <span class="n">rad</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="k">while</span> <span class="n">increase</span><span class="p">:</span>
                <span class="n">wind</span> <span class="o">=</span> <span class="n">label_im_ref</span><span class="p">[</span><span class="nb">max</span><span class="p">(</span><span class="n">i</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">-</span><span class="n">rad</span><span class="p">,</span><span class="mi">0</span><span class="p">):</span><span class="nb">min</span><span class="p">(</span><span class="n">i</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">+</span><span class="n">rad</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">label_im</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span><span class="nb">max</span><span class="p">(</span><span class="n">j</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">-</span><span class="n">rad</span><span class="p">,</span><span class="mi">0</span><span class="p">):</span><span class="nb">min</span><span class="p">(</span><span class="n">j</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">+</span><span class="n">rad</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">label_im</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">)]</span>
                <span class="n">a</span> <span class="o">=</span> <span class="n">median</span><span class="p">(</span><span class="n">wind</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">a</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
                    <span class="n">increase</span><span class="o">=</span><span class="kc">False</span>
                    <span class="n">label_im</span><span class="p">[</span><span class="n">i</span><span class="p">[</span><span class="n">k</span><span class="p">],</span><span class="n">j</span><span class="p">[</span><span class="n">k</span><span class="p">]]</span> <span class="o">=</span> <span class="n">a</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">rad</span><span class="o">+=</span><span class="mi">2</span>

    <span class="n">label_im</span> <span class="o">=</span> <span class="n">medfilt</span><span class="p">(</span><span class="n">label_im</span><span class="p">,</span><span class="n">win2</span><span class="p">)</span>

    <span class="n">i</span><span class="p">,</span><span class="n">j</span> <span class="o">=</span> <span class="n">where</span><span class="p">(</span><span class="n">label_im</span><span class="o">==</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">label_im_ref</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">label_im</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">i</span><span class="p">)):</span>
            <span class="n">increase</span><span class="o">=</span><span class="kc">True</span>
            <span class="n">rad</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="k">while</span> <span class="n">increase</span><span class="p">:</span>
                <span class="n">wind</span> <span class="o">=</span> <span class="n">label_im_ref</span><span class="p">[</span><span class="nb">max</span><span class="p">(</span><span class="n">i</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">-</span><span class="n">rad</span><span class="p">,</span><span class="mi">0</span><span class="p">):</span><span class="nb">min</span><span class="p">(</span><span class="n">i</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">+</span><span class="n">rad</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">label_im</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span><span class="nb">max</span><span class="p">(</span><span class="n">j</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">-</span><span class="n">rad</span><span class="p">,</span><span class="mi">0</span><span class="p">):</span><span class="nb">min</span><span class="p">(</span><span class="n">j</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">+</span><span class="n">rad</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">label_im</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">)]</span>
                <span class="n">a</span> <span class="o">=</span> <span class="n">median</span><span class="p">(</span><span class="n">wind</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">a</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
                    <span class="n">increase</span><span class="o">=</span><span class="kc">False</span>
                    <span class="n">label_im</span><span class="p">[</span><span class="n">i</span><span class="p">[</span><span class="n">k</span><span class="p">],</span><span class="n">j</span><span class="p">[</span><span class="n">k</span><span class="p">]]</span> <span class="o">=</span> <span class="n">a</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">rad</span><span class="o">+=</span><span class="mi">2</span>



    <span class="n">heights</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
    <span class="n">mean_rad</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="nb">int</span><span class="p">(</span><span class="n">label_im</span><span class="o">.</span><span class="n">max</span><span class="p">())</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
        <span class="n">i</span><span class="p">,</span><span class="n">j</span> <span class="o">=</span> <span class="n">where</span><span class="p">(</span><span class="n">label_im</span><span class="o">==</span><span class="n">l</span><span class="p">)</span>
        <span class="n">heights</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">im</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">-</span><span class="n">im</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">())</span>
        <span class="n">nb_points</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
        <span class="n">mean_rad</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sqrt</span><span class="p">(</span><span class="n">norm</span><span class="p">(</span><span class="n">i</span><span class="o">-</span><span class="n">center</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">ones</span><span class="p">((</span><span class="n">nb_points</span><span class="p">,)))</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="n">norm</span><span class="p">(</span><span class="n">j</span><span class="o">-</span><span class="n">center</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">ones</span><span class="p">((</span><span class="n">nb_points</span><span class="p">,)))</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="n">sqrt</span><span class="p">(</span><span class="n">nb_points</span><span class="p">))</span>


    <span class="k">return</span> <span class="n">final_zeros_list</span><span class="p">,</span><span class="n">poly_out</span><span class="p">,</span><span class="n">label_im</span><span class="p">,</span><span class="n">rtheta_pos</span><span class="p">,</span><span class="n">widths</span><span class="p">,</span><span class="n">heights</span><span class="p">,</span><span class="n">mean_rad</span>

<span class="k">def</span> <span class="nf">ring_equalizer</span><span class="p">(</span><span class="nb">map</span><span class="p">,</span><span class="n">nb_pix</span><span class="p">,</span><span class="n">rad</span><span class="p">):</span>
    <span class="kn">from</span> <span class="nn">numpy</span> <span class="k">import</span> <span class="n">flipud</span><span class="p">,</span><span class="n">argsort</span><span class="c1">#,median,zeros</span>
    <span class="n">map_out</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="nb">map</span><span class="p">)</span>
    <span class="n">shap</span> <span class="o">=</span> <span class="nb">map</span><span class="o">.</span><span class="n">shape</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">size</span><span class="p">(</span><span class="n">nb_pix</span><span class="p">)):</span>
        <span class="n">k</span><span class="p">,</span><span class="n">l</span> <span class="o">=</span> <span class="n">where</span><span class="p">(</span><span class="n">map_out</span><span class="o">==</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">size</span><span class="p">(</span><span class="n">k</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
            <span class="n">ind_lin</span> <span class="o">=</span> <span class="n">l</span><span class="o">+</span><span class="n">k</span><span class="o">*</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">nb_pts</span> <span class="o">=</span> <span class="n">size</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">nb_pts</span><span class="o">&gt;</span><span class="n">nb_pix</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>
                <span class="n">ind</span> <span class="o">=</span> <span class="n">argsort</span><span class="p">(</span><span class="n">rad</span><span class="p">[</span><span class="n">ind_lin</span><span class="p">])</span>
                <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_pts</span><span class="o">-</span><span class="n">nb_pix</span><span class="p">[</span><span class="n">i</span><span class="p">]):</span>
                    <span class="n">map_out</span><span class="p">[</span><span class="n">k</span><span class="p">[</span><span class="n">ind</span><span class="p">[</span><span class="o">-</span><span class="p">(</span><span class="n">p</span><span class="o">+</span><span class="mi">1</span><span class="p">)]],</span><span class="n">l</span><span class="p">[</span><span class="n">ind</span><span class="p">[</span><span class="o">-</span><span class="p">(</span><span class="n">p</span><span class="o">+</span><span class="mi">1</span><span class="p">)]]]</span> <span class="o">=</span> <span class="n">i</span><span class="o">+</span><span class="mi">2</span>
            <span class="k">if</span> <span class="n">nb_pts</span><span class="o">&lt;</span><span class="n">nb_pix</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>
                <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">ring_ind</span> <span class="o">=</span> <span class="n">i</span><span class="o">+</span><span class="mi">2</span>
                <span class="n">it</span><span class="p">,</span><span class="n">jt</span> <span class="o">=</span> <span class="n">where</span><span class="p">(</span><span class="n">map_out</span><span class="o">&gt;</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>

                <span class="k">while</span> <span class="n">nb_pts</span><span class="o">+</span><span class="n">count</span><span class="o">&lt;</span><span class="n">nb_pix</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>

                    <span class="n">k1</span><span class="p">,</span><span class="n">l1</span> <span class="o">=</span> <span class="n">where</span><span class="p">(</span><span class="n">map_out</span><span class="o">==</span><span class="n">ring_ind</span><span class="p">)</span>
                    <span class="n">nb_pts_2</span> <span class="o">=</span> <span class="n">size</span><span class="p">(</span><span class="n">k1</span><span class="p">)</span>

                    <span class="k">if</span> <span class="n">nb_pts_2</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>

                        <span class="n">ind_lin</span> <span class="o">=</span> <span class="n">l1</span><span class="o">+</span><span class="n">k1</span><span class="o">*</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                        <span class="n">ind</span> <span class="o">=</span> <span class="n">argsort</span><span class="p">(</span><span class="n">rad</span><span class="p">[</span><span class="n">ind_lin</span><span class="p">])</span>

                        <span class="k">if</span> <span class="n">nb_pts_2</span><span class="o">&gt;</span> <span class="n">nb_pix</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-</span><span class="n">nb_pts</span><span class="o">-</span><span class="n">count</span><span class="p">:</span>
                            <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_pix</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-</span><span class="n">nb_pts</span><span class="o">-</span><span class="n">count</span><span class="p">):</span>
                                <span class="n">map_out</span><span class="p">[</span><span class="n">k1</span><span class="p">[</span><span class="n">ind</span><span class="p">[</span><span class="o">-</span><span class="p">(</span><span class="n">p</span><span class="o">+</span><span class="mi">1</span><span class="p">)]],</span><span class="n">l1</span><span class="p">[</span><span class="n">ind</span><span class="p">[</span><span class="o">-</span><span class="p">(</span><span class="n">p</span><span class="o">+</span><span class="mi">1</span><span class="p">)]]]</span> <span class="o">=</span> <span class="n">i</span><span class="o">+</span><span class="mi">1</span>
                            <span class="n">count</span> <span class="o">=</span> <span class="n">nb_pix</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-</span><span class="n">nb_pts</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">count</span> <span class="o">+=</span> <span class="n">nb_pts_2</span>
                            <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_pts_2</span><span class="p">):</span>
                                <span class="n">map_out</span><span class="p">[</span><span class="n">k1</span><span class="p">[</span><span class="n">ind</span><span class="p">[</span><span class="o">-</span><span class="p">(</span><span class="n">p</span><span class="o">+</span><span class="mi">1</span><span class="p">)]],</span><span class="n">l1</span><span class="p">[</span><span class="n">ind</span><span class="p">[</span><span class="o">-</span><span class="p">(</span><span class="n">p</span><span class="o">+</span><span class="mi">1</span><span class="p">)]]]</span> <span class="o">=</span> <span class="n">i</span><span class="o">+</span><span class="mi">1</span>



                        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">int</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">nb_pts_2</span><span class="p">,</span><span class="n">nb_pix</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-</span><span class="n">nb_pts</span><span class="o">-</span><span class="n">count</span><span class="p">))):</span>
                            <span class="n">map_out</span><span class="p">[</span><span class="n">k1</span><span class="p">[</span><span class="n">ind</span><span class="p">[</span><span class="o">-</span><span class="p">(</span><span class="n">p</span><span class="o">+</span><span class="mi">1</span><span class="p">)]],</span><span class="n">l1</span><span class="p">[</span><span class="n">ind</span><span class="p">[</span><span class="o">-</span><span class="p">(</span><span class="n">p</span><span class="o">+</span><span class="mi">1</span><span class="p">)]]]</span> <span class="o">=</span> <span class="n">i</span><span class="o">+</span><span class="mi">1</span>
                    <span class="n">ring_ind</span><span class="o">+=</span><span class="mi">1</span>
                <span class="n">k</span><span class="p">,</span><span class="n">l</span> <span class="o">=</span> <span class="n">where</span><span class="p">(</span><span class="n">map_out</span><span class="o">==</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>


    <span class="k">return</span> <span class="n">map_out</span>



<span class="k">def</span> <span class="nf">ring_stack</span><span class="p">(</span><span class="n">psf_stack</span><span class="p">,</span><span class="n">center</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">kmad</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span><span class="n">deg</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span><span class="n">win</span><span class="o">=</span><span class="mi">9</span><span class="p">,</span><span class="n">win2</span><span class="o">=</span><span class="mi">7</span><span class="p">,</span><span class="n">equalize_en</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">nb_rings</span> <span class="o">=</span> <span class="mi">7</span><span class="p">):</span>

    <span class="kn">from</span> <span class="nn">numpy</span> <span class="k">import</span> <span class="n">flipud</span><span class="p">,</span><span class="n">median</span><span class="p">,</span><span class="n">zeros</span><span class="p">,</span><span class="n">array</span>

    <span class="k">if</span> <span class="n">center</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">center</span> <span class="o">=</span> <span class="n">flipud</span><span class="p">(</span><span class="n">where</span><span class="p">(</span><span class="n">psf_stack</span><span class="p">[:,:,</span><span class="mi">0</span><span class="p">]</span><span class="o">==</span><span class="n">psf_stack</span><span class="p">[:,:,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()))</span>

    <span class="n">label_im</span> <span class="o">=</span> <span class="n">psf_stack</span><span class="o">*</span><span class="mi">0</span>
    <span class="n">nb_zeros</span> <span class="o">=</span> <span class="mi">1000000</span>
    <span class="n">shap</span> <span class="o">=</span> <span class="n">psf_stack</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">pol_coord</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">nb_samples_per_ring</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>
    <span class="n">poly_fit</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
    <span class="n">widths</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
    <span class="n">heights</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
    <span class="n">mean_rad</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>


    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
        <span class="nb">print</span> <span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="s2">&quot; image/&quot;</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
        <span class="n">final_zeros_list</span><span class="p">,</span><span class="n">poly_out</span><span class="p">,</span><span class="n">label_im</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">],</span><span class="n">pol_coord</span><span class="p">,</span><span class="n">widths_i</span><span class="p">,</span><span class="n">heights_i</span><span class="p">,</span><span class="n">mean_rad_i</span> <span class="o">=</span> <span class="n">ring_separation</span><span class="p">(</span><span class="n">psf_stack</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">],</span><span class="n">center</span><span class="o">=</span><span class="n">center</span><span class="p">,</span><span class="n">kmad</span><span class="o">=</span><span class="n">kmad</span><span class="p">,</span><span class="n">deg</span><span class="o">=</span><span class="n">deg</span><span class="p">,</span><span class="n">win</span><span class="o">=</span><span class="n">win</span><span class="p">,</span><span class="n">win2</span><span class="o">=</span><span class="n">win2</span><span class="p">,</span><span class="n">nb_rings</span> <span class="o">=</span> <span class="n">nb_rings</span><span class="p">)</span>
        <span class="n">mean_rad</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mean_rad_i</span><span class="p">)</span>
        <span class="n">poly_fit</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">poly_out</span><span class="p">)</span>
        <span class="n">nb_zeros_i</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">poly_out</span><span class="p">)</span>
        <span class="n">widths</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">widths_i</span><span class="p">)</span>
        <span class="n">heights</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">heights_i</span><span class="p">)</span>



        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_rings</span><span class="p">):</span>
            <span class="n">x</span><span class="p">,</span><span class="n">y</span> <span class="o">=</span> <span class="n">where</span><span class="p">(</span><span class="n">label_im</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">]</span><span class="o">==</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">nb_samples_per_ring</span><span class="p">[</span><span class="n">j</span><span class="p">,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">size</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

    <span class="c1"># Widths and heights equalizing</span>
    <span class="n">nb_min</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">widths</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">widths</span><span class="p">)):</span>
        <span class="k">if</span> <span class="n">nb_min</span><span class="o">&gt;</span><span class="nb">len</span><span class="p">(</span><span class="n">widths</span><span class="p">[</span><span class="n">i</span><span class="p">]):</span>
            <span class="n">nb_min</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">widths</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">widths</span><span class="p">[</span><span class="n">j</span><span class="p">])</span> <span class="o">&gt;</span> <span class="n">nb_min</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nb_min</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">widths</span><span class="p">[</span><span class="n">j</span><span class="p">])):</span>
                    <span class="n">widths</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">widths</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
                    <span class="n">heights</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">heights</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
                    <span class="n">mean_rad</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">mean_rad</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>


    <span class="c1">#print nb_samples_per_ring[0:nb_zeros,:].sum(axis=1)</span>


    <span class="n">final_nb_samples</span> <span class="o">=</span> <span class="n">mean</span><span class="p">(</span><span class="n">nb_samples_per_ring</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">nb_rings</span><span class="p">,:],</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">final_nb_samples</span> <span class="o">=</span> <span class="n">final_nb_samples</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

    <span class="c1"># Equalizing zeros maps</span>
    <span class="k">if</span> <span class="n">equalize_en</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
            <span class="n">label_im</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">ring_equalizer</span><span class="p">(</span><span class="n">label_im</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">],</span><span class="n">final_nb_samples</span><span class="p">,</span><span class="n">pol_coord</span><span class="p">[</span><span class="mi">0</span><span class="p">,:])</span>



    <span class="k">return</span> <span class="n">label_im</span><span class="p">,</span><span class="n">poly_fit</span><span class="p">,</span><span class="n">final_nb_samples</span><span class="p">,</span><span class="n">pol_coord</span><span class="p">,</span><span class="n">array</span><span class="p">(</span><span class="n">widths</span><span class="p">),</span><span class="n">array</span><span class="p">(</span><span class="n">heights</span><span class="p">),</span><span class="n">array</span><span class="p">(</span><span class="n">mean_rad</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">get_ring</span><span class="p">(</span><span class="n">im</span><span class="p">,</span><span class="nb">map</span><span class="p">,</span><span class="n">indexes</span><span class="p">,</span><span class="n">theta_im</span><span class="p">,</span><span class="n">scaling_fact</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
    <span class="kn">from</span> <span class="nn">numpy</span> <span class="k">import</span> <span class="n">zeros</span><span class="p">,</span><span class="n">ones</span><span class="p">,</span><span class="n">pi</span><span class="p">,</span><span class="n">copy</span>

    <span class="n">shap</span> <span class="o">=</span> <span class="n">im</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">ring_out</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">(</span><span class="n">shap</span><span class="p">)</span>
    <span class="n">pol_coord_ring</span> <span class="o">=</span> <span class="n">ones</span><span class="p">(</span><span class="n">shap</span><span class="p">)</span><span class="o">*</span><span class="mi">2</span><span class="o">*</span><span class="n">pi</span>
    <span class="n">nb_points</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">if</span> <span class="n">size</span><span class="p">(</span><span class="n">indexes</span><span class="p">)</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
        <span class="n">i</span><span class="p">,</span><span class="n">j</span> <span class="o">=</span> <span class="n">where</span><span class="p">(</span><span class="nb">map</span><span class="o">==</span><span class="n">indexes</span><span class="p">)</span>
        <span class="n">ring_out</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">im</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">])</span>
        <span class="n">pol_coord_ring</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">theta_im</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">])</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">indexes</span><span class="p">)):</span>
            <span class="n">i</span><span class="p">,</span><span class="n">j</span> <span class="o">=</span> <span class="n">where</span><span class="p">(</span><span class="nb">map</span><span class="o">==</span><span class="n">indexes</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>
            <span class="n">ring_out</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">+=</span> <span class="n">copy</span><span class="p">(</span><span class="n">im</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">])</span>
            <span class="n">pol_coord_ring</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">theta_im</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">])</span>


    <span class="n">point_cloud</span> <span class="o">=</span> <span class="n">im_to_point_cloud</span><span class="p">(</span><span class="n">ring_out</span><span class="p">)</span>


    <span class="k">return</span> <span class="n">ring_out</span><span class="p">,</span><span class="n">pol_coord_ring</span><span class="p">,</span><span class="n">point_cloud</span>


<span class="k">def</span> <span class="nf">get_ring_stack</span><span class="p">(</span><span class="n">im_stack</span><span class="p">,</span><span class="nb">map</span><span class="p">,</span><span class="n">indexes</span><span class="p">,</span><span class="n">theta_im</span><span class="p">):</span>
    <span class="kn">from</span> <span class="nn">numpy</span> <span class="k">import</span> <span class="n">zeros</span><span class="p">,</span><span class="n">swapaxes</span>
    <span class="n">shap</span> <span class="o">=</span> <span class="n">im_stack</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">list_map</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
    <span class="n">list_pol_coord</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
    <span class="n">list_point_clouds</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
    <span class="n">nb_points</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">indexes</span><span class="p">)):</span>

        <span class="n">rings_i</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">(</span><span class="n">shap</span><span class="p">)</span>
        <span class="n">pol_coord_ring_i</span> <span class="o">=</span> <span class="n">ones</span><span class="p">(</span><span class="n">shap</span><span class="p">)</span><span class="o">*</span><span class="mi">2</span><span class="o">*</span><span class="n">pi</span>
        <span class="n">pt_cloud</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
            <span class="n">rings_i</span><span class="p">[:,:,</span><span class="n">j</span><span class="p">],</span><span class="n">pol_coord_ring_i</span><span class="p">[:,:,</span><span class="n">j</span><span class="p">],</span><span class="n">point_cloud_j</span> <span class="o">=</span> <span class="n">get_ring</span><span class="p">(</span><span class="n">im_stack</span><span class="p">[:,:,</span><span class="n">j</span><span class="p">],</span><span class="nb">map</span><span class="p">[:,:,</span><span class="n">j</span><span class="p">],</span><span class="n">indexes</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">theta_im</span><span class="p">)</span>
            <span class="n">pt_cloud</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">point_cloud_j</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">j</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
                <span class="n">nb_points</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">point_cloud_j</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

        <span class="n">list_point_clouds</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">swapaxes</span><span class="p">(</span><span class="n">swapaxes</span><span class="p">(</span><span class="n">array</span><span class="p">(</span><span class="n">pt_cloud</span><span class="p">),</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span>
        <span class="n">list_map</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rings_i</span><span class="p">)</span>
        <span class="n">list_pol_coord</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pol_coord_ring_i</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">list_map</span><span class="p">,</span><span class="n">list_pol_coord</span><span class="p">,</span><span class="n">list_point_clouds</span><span class="p">,</span><span class="n">array</span><span class="p">(</span><span class="n">nb_points</span><span class="p">)</span>



<span class="k">def</span> <span class="nf">partionn_circle</span><span class="p">(</span><span class="n">nb_parts</span><span class="p">,</span><span class="n">offset</span><span class="p">,</span><span class="n">pol_coord</span><span class="p">):</span>
    <span class="kn">from</span> <span class="nn">numpy</span> <span class="k">import</span> <span class="n">arange</span><span class="p">,</span><span class="n">pi</span><span class="p">,</span><span class="n">zeros</span><span class="p">,</span><span class="n">pi</span>
    <span class="n">i0</span><span class="p">,</span><span class="n">j0</span> <span class="o">=</span> <span class="n">where</span><span class="p">(</span><span class="n">pol_coord</span><span class="o">&lt;</span><span class="mi">2</span><span class="o">*</span><span class="n">pi</span><span class="p">)</span>
    <span class="n">nb_pts</span> <span class="o">=</span> <span class="n">size</span><span class="p">(</span><span class="n">i0</span><span class="p">)</span>
    <span class="n">step</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">pi</span><span class="o">/</span><span class="n">nb_parts</span>
    <span class="n">z</span> <span class="o">=</span> <span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_parts</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">step</span><span class="o">+</span><span class="n">offset</span>
    <span class="n">z</span> <span class="o">=</span> <span class="n">z</span><span class="o">%</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">pi</span><span class="p">)</span>
    <span class="n">labels</span> <span class="o">=</span> <span class="n">pol_coord</span><span class="o">*</span><span class="mi">0</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_parts</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
        <span class="n">i1</span><span class="p">,</span><span class="n">j1</span> <span class="o">=</span> <span class="n">where</span><span class="p">(</span><span class="n">pol_coord</span><span class="o">&gt;=</span><span class="n">z</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        <span class="n">i2</span> <span class="o">=</span> <span class="n">where</span><span class="p">(</span><span class="n">pol_coord</span><span class="p">[</span><span class="n">i1</span><span class="p">,</span><span class="n">j1</span><span class="p">]</span><span class="o">&lt;</span><span class="n">z</span><span class="p">[(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">%</span><span class="n">nb_parts</span><span class="p">])</span>
        <span class="n">labels</span><span class="p">[</span><span class="n">i1</span><span class="p">[</span><span class="n">i2</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span><span class="n">j1</span><span class="p">[</span><span class="n">i2</span><span class="p">[</span><span class="mi">0</span><span class="p">]]]</span> <span class="o">=</span> <span class="n">i</span><span class="o">+</span><span class="mi">1</span>

    <span class="n">i1</span><span class="p">,</span><span class="n">j1</span> <span class="o">=</span> <span class="n">where</span><span class="p">(</span><span class="n">pol_coord</span><span class="o">&lt;</span><span class="n">z</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">i2</span><span class="p">,</span><span class="n">j2</span> <span class="o">=</span> <span class="n">where</span><span class="p">(</span><span class="n">pol_coord</span><span class="o">&gt;=</span><span class="n">z</span><span class="p">[</span><span class="n">nb_parts</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">i3</span> <span class="o">=</span> <span class="n">where</span><span class="p">(</span><span class="n">pol_coord</span><span class="p">[</span><span class="n">i2</span><span class="p">,</span><span class="n">j2</span><span class="p">]</span><span class="o">&lt;</span><span class="mi">2</span><span class="o">*</span><span class="n">pi</span><span class="p">)</span>

    <span class="n">labels</span><span class="p">[</span><span class="n">i1</span><span class="p">,</span><span class="n">j1</span><span class="p">]</span> <span class="o">=</span> <span class="n">nb_parts</span>
    <span class="n">labels</span><span class="p">[</span><span class="n">i2</span><span class="p">[</span><span class="n">i3</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span><span class="n">j2</span><span class="p">[</span><span class="n">i3</span><span class="p">[</span><span class="mi">0</span><span class="p">]]]</span> <span class="o">=</span> <span class="n">nb_parts</span>

    <span class="k">return</span> <span class="n">labels</span>

<span class="k">def</span> <span class="nf">partionn_circle_stack</span><span class="p">(</span><span class="n">nb_parts</span><span class="p">,</span><span class="n">offset</span><span class="p">,</span><span class="n">pol_coord_stack</span><span class="p">):</span>
    <span class="kn">from</span> <span class="nn">numpy</span> <span class="k">import</span> <span class="n">zeros</span><span class="p">,</span><span class="n">pi</span><span class="p">,</span><span class="n">where</span><span class="p">,</span><span class="n">squeeze</span>
    <span class="kn">from</span> <span class="nn">optim_utils</span> <span class="k">import</span> <span class="n">optimal_assignement_1d</span>
    <span class="n">nb_sets</span> <span class="o">=</span> <span class="n">pol_coord_stack</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>

    <span class="n">labels</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">(</span><span class="n">pol_coord_stack</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

    <span class="n">labels</span><span class="p">[:,:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">partionn_circle</span><span class="p">(</span><span class="n">nb_parts</span><span class="p">,</span><span class="n">offset</span><span class="p">,</span><span class="n">pol_coord_stack</span><span class="p">[:,:,</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">i0</span><span class="p">,</span><span class="n">j0</span> <span class="o">=</span> <span class="n">where</span><span class="p">(</span><span class="n">pol_coord_stack</span><span class="p">[:,:,</span><span class="mi">0</span><span class="p">]</span><span class="o">&lt;</span><span class="mi">2</span><span class="o">*</span><span class="n">pi</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">nb_sets</span><span class="p">):</span>
        <span class="n">i1</span><span class="p">,</span><span class="n">j1</span> <span class="o">=</span> <span class="n">where</span><span class="p">(</span><span class="n">pol_coord_stack</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">]</span><span class="o">&lt;</span><span class="mi">2</span><span class="o">*</span><span class="n">pi</span><span class="p">)</span>

        <span class="n">opt_ind</span><span class="p">,</span><span class="n">proj</span> <span class="o">=</span> <span class="n">optimal_assignement_1d</span><span class="p">(</span><span class="n">pol_coord_stack</span><span class="p">[</span><span class="n">i1</span><span class="p">,</span><span class="n">j1</span><span class="p">,</span><span class="n">i</span><span class="p">],</span><span class="n">pol_coord_stack</span><span class="p">[</span><span class="n">i0</span><span class="p">,</span><span class="n">j0</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">labels</span><span class="p">[</span><span class="n">i1</span><span class="p">,</span><span class="n">j1</span><span class="p">,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">labels</span><span class="p">[</span><span class="n">i0</span><span class="p">[</span><span class="n">opt_ind</span><span class="p">],</span><span class="n">j0</span><span class="p">[</span><span class="n">opt_ind</span><span class="p">],</span><span class="mi">0</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">labels</span>


<span class="k">def</span> <span class="nf">extract_point_cloud</span><span class="p">(</span><span class="n">ring_stack</span><span class="p">,</span><span class="n">pol_coord_stack</span><span class="p">,</span><span class="n">part_id</span><span class="p">,</span><span class="n">normalize_en</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="kn">from</span> <span class="nn">numpy.linalg</span> <span class="k">import</span> <span class="n">svd</span>
    <span class="kn">from</span> <span class="nn">numpy</span> <span class="k">import</span> <span class="n">sqrt</span> <span class="k">as</span> <span class="n">n_sqrt</span>
    <span class="n">i</span><span class="p">,</span><span class="n">j</span> <span class="o">=</span> <span class="n">where</span><span class="p">(</span><span class="n">pol_coord_stack</span><span class="p">[:,:,</span><span class="mi">0</span><span class="p">]</span><span class="o">==</span><span class="n">part_id</span><span class="p">)</span>
    <span class="n">nb_points</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">*</span><span class="n">ring_stack</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">point_cloud</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span><span class="n">nb_points</span><span class="p">))</span>
    <span class="n">point_cloud</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">,</span><span class="mi">0</span><span class="p">:</span><span class="nb">len</span><span class="p">(</span><span class="n">i</span><span class="p">)]</span> <span class="o">=</span>  <span class="n">array</span><span class="p">([</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">])</span>
    <span class="n">point_cloud</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="mi">0</span><span class="p">:</span><span class="nb">len</span><span class="p">(</span><span class="n">i</span><span class="p">)]</span> <span class="o">=</span> <span class="n">ring_stack</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>

    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">ring_stack</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
        <span class="n">i</span><span class="p">,</span><span class="n">j</span> <span class="o">=</span> <span class="n">where</span><span class="p">(</span><span class="n">pol_coord_stack</span><span class="p">[:,:,</span><span class="n">k</span><span class="p">]</span><span class="o">==</span><span class="n">part_id</span><span class="p">)</span>
        <span class="n">point_cloud</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">,</span><span class="n">k</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">i</span><span class="p">):(</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">i</span><span class="p">)]</span> <span class="o">=</span>  <span class="n">array</span><span class="p">([</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">])</span>
        <span class="n">point_cloud</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="n">k</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">i</span><span class="p">):(</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">i</span><span class="p">)]</span> <span class="o">=</span> <span class="n">ring_stack</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">normalize_en</span><span class="p">:</span>
        <span class="n">u</span><span class="p">,</span><span class="n">s</span><span class="p">,</span><span class="n">v</span> <span class="o">=</span> <span class="n">linalg</span><span class="o">.</span><span class="n">svd</span><span class="p">(</span><span class="n">point_cloud</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">transpose</span><span class="p">(</span><span class="n">point_cloud</span><span class="p">)),</span><span class="n">full_matrices</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">point_cloud</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">diag</span><span class="p">(</span><span class="n">n_sqrt</span><span class="p">(</span><span class="n">s</span><span class="p">)</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)))</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">transpose</span><span class="p">(</span><span class="n">u</span><span class="p">))</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">point_cloud</span><span class="p">)</span>
        <span class="n">scale_mat</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">diag</span><span class="p">(</span><span class="n">n_sqrt</span><span class="p">(</span><span class="n">s</span><span class="p">)))</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">transpose</span><span class="p">(</span><span class="n">u</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">point_cloud</span><span class="p">,</span><span class="n">scale_mat</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">point_cloud</span>


<span class="k">def</span> <span class="nf">interpolation_setting</span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="n">center</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">kmad</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span><span class="n">deg</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span><span class="n">win</span><span class="o">=</span><span class="mi">9</span><span class="p">,</span><span class="n">win2</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span><span class="n">nb_ring_parts</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span><span class="n">offset</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">nb_components</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span><span class="n">neigh_fact</span><span class="o">=</span><span class="mf">1.5</span><span class="p">,</span><span class="n">ring_wise</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>

    <span class="kn">from</span> <span class="nn">numpy</span> <span class="k">import</span> <span class="n">arange</span><span class="p">,</span><span class="n">pi</span>
    <span class="kn">from</span> <span class="nn">sklearn</span> <span class="k">import</span> <span class="n">manifold</span>
    <span class="kn">from</span> <span class="nn">pyflann</span> <span class="k">import</span> <span class="n">FLANN</span>
    <span class="kn">from</span> <span class="nn">numpy.polynomial.polynomial</span> <span class="k">import</span> <span class="n">polyfit</span>

    <span class="k">if</span> <span class="n">center</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">center</span> <span class="o">=</span> <span class="n">where</span><span class="p">(</span><span class="n">data</span><span class="p">[:,:,</span><span class="mi">0</span><span class="p">]</span><span class="o">==</span><span class="n">data</span><span class="p">[:,:,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">())</span>
        <span class="k">if</span> <span class="n">size</span><span class="p">(</span><span class="n">center</span><span class="o">&gt;</span><span class="mi">2</span><span class="p">):</span>
            <span class="n">center</span> <span class="o">=</span> <span class="n">array</span><span class="p">([</span><span class="n">center</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span><span class="n">center</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]])</span>
    <span class="n">shap</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">nb_data</span> <span class="o">=</span> <span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>


    <span class="c1"># -- Features setting -- #</span>

    <span class="c1"># Rings detection</span>
    <span class="nb">map</span><span class="p">,</span><span class="n">poly_fit</span><span class="p">,</span><span class="n">final_nb_samples</span><span class="p">,</span><span class="n">pol_coord</span><span class="p">,</span><span class="n">widths</span><span class="p">,</span><span class="n">heights</span><span class="p">,</span><span class="n">mean_rad</span> <span class="o">=</span> <span class="n">ring_stack</span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="n">center</span><span class="o">=</span><span class="n">center</span><span class="p">,</span><span class="n">kmad</span><span class="o">=</span><span class="n">kmad</span><span class="p">,</span><span class="n">deg</span><span class="o">=</span><span class="n">deg</span><span class="p">,</span><span class="n">win</span><span class="o">=</span><span class="n">win</span><span class="p">,</span><span class="n">win2</span><span class="o">=</span><span class="n">win2</span><span class="p">)</span>
    <span class="n">scale_poly</span> <span class="o">=</span> <span class="n">polyfit</span><span class="p">(</span><span class="n">mean_rad</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span><span class="n">log</span><span class="p">(</span><span class="n">widths</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">/</span><span class="n">heights</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)),</span><span class="mi">2</span><span class="p">)</span>


    <span class="c1"># Rings extraction and scaling</span>
    <span class="c1"># Rings extraction</span>
    <span class="n">indexes</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>



    <span class="k">if</span> <span class="n">ring_wise</span><span class="p">:</span>
        <span class="n">indexes</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">size</span><span class="p">(</span><span class="n">final_nb_samples</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">indexes</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="nb">list</span><span class="p">(</span><span class="n">arange</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="n">size</span><span class="p">(</span><span class="n">final_nb_samples</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">))]</span>



    <span class="n">list_rings_learning</span><span class="p">,</span><span class="n">list_pol_coord</span><span class="p">,</span><span class="n">list_points_clouds</span><span class="p">,</span><span class="n">nb_points</span> <span class="o">=</span> <span class="n">get_ring_stack</span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="nb">map</span><span class="p">,</span><span class="n">indexes</span><span class="p">,</span><span class="n">pol_coord</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">]))</span>


    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    # Computing embeddings</span>
<span class="sd">    embeddings1 = list()</span>
<span class="sd">    embeddings2 = list()</span>
<span class="sd">    knn1 = list()</span>
<span class="sd">    knn2 = list()</span>
<span class="sd">    scale_mats_1 = list()</span>
<span class="sd">    scale_mats_2 = list()</span>
<span class="sd">    for j in range(0,nb_struct):</span>
<span class="sd">        embeddings1.append([])</span>
<span class="sd">        embeddings2.append([])</span>
<span class="sd">        knn1.append([])</span>
<span class="sd">        knn2.append([])</span>
<span class="sd">        scale_mats_1.append([])</span>
<span class="sd">        scale_mats_2.append([])</span>
<span class="sd">        for i in range(0,nb_ring_parts):</span>
<span class="sd">            pt_cloud1,scale_mat1 = extract_point_cloud(list_rings_learning[j],section_numb0,i+1)</span>
<span class="sd">            scale_mats_1[j].append(scale_mat1)</span>
<span class="sd">            Yhess_obj = manifold.LocallyLinearEmbedding(int(neigh_fact*nb_data), nb_comp,eigen_solver=&#39;dense&#39;,method=&#39;hessian&#39;).fit(transpose(pt_clouds_list[i]))</span>
<span class="sd">    embed_list.append(Yhess_obj)</span>
<span class="sd">    flann = FLANN()</span>
<span class="sd">    params = flann.build_index(array(Yhess_obj.embedding_, dtype=float64))</span>
<span class="sd">    knn_list.append(flann)</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">return</span> <span class="n">list_rings_learning</span><span class="p">,</span><span class="n">list_points_clouds</span><span class="p">,</span><span class="n">nb_points</span><span class="p">,</span><span class="n">widths</span><span class="p">,</span><span class="n">heights</span><span class="p">,</span><span class="n">mean_rad</span><span class="p">,</span><span class="n">scale_poly</span>


<span class="k">def</span> <span class="nf">merger</span><span class="p">(</span><span class="n">list_rings</span><span class="p">,</span><span class="n">list_points_clouds</span><span class="p">,</span><span class="n">indices</span><span class="p">):</span>
    <span class="n">list_rings_merge</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
    <span class="n">list_points_clouds_merge</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">indices</span><span class="p">)):</span>
        <span class="k">if</span> <span class="n">size</span><span class="p">(</span><span class="n">indices</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">list_rings_merge</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">list_rings</span><span class="p">[</span><span class="n">indices</span><span class="p">[</span><span class="n">i</span><span class="p">]])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">list_rings_merge</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">list_rings</span><span class="p">[</span><span class="n">indices</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]])</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">size</span><span class="p">(</span><span class="n">indices</span><span class="p">[</span><span class="n">i</span><span class="p">])):</span>
                <span class="n">list_rings_merge</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">+=</span><span class="n">list_rings</span><span class="p">[</span><span class="n">indices</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]]</span>
        <span class="n">list_points_clouds_merge</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cube_to_point_cloud</span><span class="p">(</span><span class="n">list_rings_merge</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>

    <span class="k">return</span> <span class="n">list_rings_merge</span><span class="p">,</span><span class="n">list_points_clouds_merge</span>






<span class="k">def</span> <span class="nf">interpolation_setting_2</span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="n">center</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">kmad</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span><span class="n">deg</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span><span class="n">win</span><span class="o">=</span><span class="mi">9</span><span class="p">,</span><span class="n">win2</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span><span class="n">offset</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">nb_components</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span><span class="n">nb_neigh</span><span class="o">=</span><span class="kc">None</span> <span class="p">,</span><span class="n">ring_wise</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">equalize_en</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>

    <span class="kn">from</span> <span class="nn">numpy</span> <span class="k">import</span> <span class="n">arange</span><span class="p">,</span><span class="n">pi</span>
    <span class="kn">from</span> <span class="nn">sklearn</span> <span class="k">import</span> <span class="n">manifold</span>
    <span class="kn">from</span> <span class="nn">pyflann</span> <span class="k">import</span> <span class="n">FLANN</span>
    <span class="kn">from</span> <span class="nn">numpy.polynomial.polynomial</span> <span class="k">import</span> <span class="n">polyfit</span>
    <span class="kn">from</span> <span class="nn">utils</span> <span class="k">import</span> <span class="n">cube_to_mat</span>


    <span class="k">if</span> <span class="n">nb_neigh</span><span class="o">&lt;=</span> <span class="nb">round</span><span class="p">(</span><span class="n">nb_components</span> <span class="o">*</span> <span class="p">(</span><span class="n">nb_components</span> <span class="o">+</span> <span class="mi">3</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">):</span>
        <span class="n">nb_neigh</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">nb_components</span> <span class="o">*</span> <span class="p">(</span><span class="n">nb_components</span> <span class="o">+</span> <span class="mi">3</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">center</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">center</span> <span class="o">=</span> <span class="n">where</span><span class="p">(</span><span class="n">data</span><span class="p">[:,:,</span><span class="mi">0</span><span class="p">]</span><span class="o">==</span><span class="n">data</span><span class="p">[:,:,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">())</span>
        <span class="k">if</span> <span class="n">size</span><span class="p">(</span><span class="n">center</span><span class="o">&gt;</span><span class="mi">2</span><span class="p">):</span>
            <span class="n">center</span> <span class="o">=</span> <span class="n">array</span><span class="p">([</span><span class="n">center</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span><span class="n">center</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]])</span>
    <span class="n">shap</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">nb_data</span> <span class="o">=</span> <span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>


    <span class="c1"># -- Features setting -- #</span>

    <span class="c1"># Rings detection</span>
    <span class="nb">map</span><span class="p">,</span><span class="n">poly_fit</span><span class="p">,</span><span class="n">final_nb_samples</span><span class="p">,</span><span class="n">pol_coord</span><span class="p">,</span><span class="n">widths</span><span class="p">,</span><span class="n">heights</span><span class="p">,</span><span class="n">mean_rad</span> <span class="o">=</span> <span class="n">ring_stack</span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="n">center</span><span class="o">=</span><span class="n">center</span><span class="p">,</span><span class="n">kmad</span><span class="o">=</span><span class="n">kmad</span><span class="p">,</span><span class="n">deg</span><span class="o">=</span><span class="n">deg</span><span class="p">,</span><span class="n">win</span><span class="o">=</span><span class="n">win</span><span class="p">,</span><span class="n">win2</span><span class="o">=</span><span class="n">win2</span><span class="p">,</span><span class="n">equalize_en</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="n">scale_poly</span> <span class="o">=</span> <span class="n">polyfit</span><span class="p">(</span><span class="n">mean_rad</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span><span class="n">log</span><span class="p">(</span><span class="n">widths</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">/</span><span class="n">heights</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)),</span><span class="mi">2</span><span class="p">)</span>

    <span class="c1"># Rings extraction</span>
    <span class="n">indexes</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">ring_wise</span><span class="p">:</span>
        <span class="n">indexes</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">size</span><span class="p">(</span><span class="n">final_nb_samples</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">indexes</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="nb">list</span><span class="p">(</span><span class="n">arange</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="n">size</span><span class="p">(</span><span class="n">final_nb_samples</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">))]</span>



    <span class="n">list_rings_learning</span><span class="p">,</span><span class="n">list_pol_coord</span><span class="p">,</span><span class="n">list_points_clouds</span><span class="p">,</span><span class="n">nb_points</span> <span class="o">=</span> <span class="n">get_ring_stack</span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="nb">map</span><span class="p">,</span><span class="n">indexes</span><span class="p">,</span><span class="n">pol_coord</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">]))</span>


    <span class="c1"># Computing embeddings</span>
    <span class="n">embed_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
    <span class="n">knn_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">list_rings_learning</span><span class="p">)):</span>
        <span class="n">Yhess_obj</span> <span class="o">=</span> <span class="n">manifold</span><span class="o">.</span><span class="n">LocallyLinearEmbedding</span><span class="p">(</span><span class="n">nb_neigh</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">nb_components</span><span class="p">,</span><span class="n">eigen_solver</span><span class="o">=</span><span class="s1">&#39;dense&#39;</span><span class="p">,</span><span class="n">method</span><span class="o">=</span><span class="s1">&#39;hessian&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">cube_to_mat</span><span class="p">(</span><span class="n">list_rings_learning</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>
        <span class="n">embed_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Yhess_obj</span><span class="p">)</span>
        <span class="n">flann</span> <span class="o">=</span> <span class="n">FLANN</span><span class="p">()</span>
        <span class="n">params</span> <span class="o">=</span> <span class="n">flann</span><span class="o">.</span><span class="n">build_index</span><span class="p">(</span><span class="n">array</span><span class="p">(</span><span class="n">Yhess_obj</span><span class="o">.</span><span class="n">embedding_</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">float64</span><span class="p">))</span>
        <span class="n">knn_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">flann</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">embed_list</span><span class="p">,</span><span class="n">knn_list</span><span class="p">,</span><span class="n">list_rings_learning</span><span class="p">,</span><span class="n">list_points_clouds</span><span class="p">,</span><span class="n">scale_poly</span>



<span class="k">def</span> <span class="nf">field_mapping</span><span class="p">(</span><span class="n">embed_list</span><span class="p">,</span><span class="n">pos_field</span><span class="p">):</span>

    <span class="kn">from</span> <span class="nn">optim_utils</span> <span class="k">import</span> <span class="n">optim_poly_fit_2d</span>

    <span class="n">nb_struct</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">embed_list</span><span class="p">)</span>
    <span class="n">poly_modes</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
    <span class="n">deg</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_struct</span><span class="p">):</span>
        <span class="n">s</span><span class="p">,</span><span class="n">mean_err</span><span class="p">,</span><span class="n">w</span><span class="p">,</span><span class="n">deg_i</span> <span class="o">=</span> <span class="n">optim_poly_fit_2d</span><span class="p">(</span><span class="n">pos_field</span><span class="p">,</span><span class="n">transpose</span><span class="p">(</span><span class="n">embed_list</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>
        <span class="n">poly_modes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
        <span class="n">deg</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">deg_i</span><span class="p">)</span>
        <span class="nb">print</span> <span class="s2">&quot;Position fittig accuracy: &quot;</span><span class="p">,</span><span class="n">mean_err</span><span class="p">,</span><span class="s2">&quot;%&quot;</span>

    <span class="k">return</span> <span class="n">poly_modes</span><span class="p">,</span><span class="n">deg</span>

<span class="k">def</span> <span class="nf">sliced_transport_time_assessing_interface</span><span class="p">(</span><span class="n">stack</span><span class="p">,</span><span class="n">nb_pts</span><span class="p">,</span><span class="n">param</span><span class="p">,</span><span class="n">nb_real</span><span class="p">,</span><span class="n">nb_iter</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span><span class="n">tol</span><span class="o">=</span><span class="mf">0.001</span><span class="p">,</span><span class="n">alph</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span><span class="n">basis</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">rand</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">disc_err</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span><span class="n">smart_init_en</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span><span class="n">rad</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span><span class="n">ind</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>

    <span class="kn">from</span> <span class="nn">utils</span> <span class="k">import</span> <span class="n">rand_diff_integ_pair</span><span class="p">,</span><span class="n">window_ind</span>
    <span class="kn">from</span> <span class="nn">numpy</span> <span class="k">import</span> <span class="n">zeros</span>
    <span class="kn">from</span> <span class="nn">optim_utils</span> <span class="k">import</span> <span class="n">sliced_transport_time_assessing_m</span>

    <span class="n">indf</span><span class="o">=</span><span class="kc">None</span>
    <span class="n">indg</span><span class="o">=</span><span class="kc">None</span>
    <span class="n">shap</span> <span class="o">=</span> <span class="n">stack</span><span class="o">.</span><span class="n">shape</span>
    <span class="k">if</span> <span class="n">ind</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">ind</span> <span class="o">=</span> <span class="n">rand_diff_integ_pair</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">nb_pts</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">nb_pts</span> <span class="o">=</span> <span class="n">ind</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">smart_init_en</span><span class="p">:</span>
        <span class="n">indf</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">nb_pts</span><span class="p">,(</span><span class="mi">2</span><span class="o">*</span><span class="n">rad</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span>
        <span class="n">indg</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">nb_pts</span><span class="p">,(</span><span class="mi">2</span><span class="o">*</span><span class="n">rad</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_pts</span><span class="p">):</span>
            <span class="n">cent1</span> <span class="o">=</span> <span class="n">where</span><span class="p">(</span><span class="n">stack</span><span class="p">[:,:,</span><span class="n">ind</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">0</span><span class="p">]]</span><span class="o">==</span><span class="n">stack</span><span class="p">[:,:,</span><span class="n">ind</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">max</span><span class="p">())</span>
            <span class="n">cent2</span> <span class="o">=</span> <span class="n">where</span><span class="p">(</span><span class="n">stack</span><span class="p">[:,:,</span><span class="n">ind</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">1</span><span class="p">]]</span><span class="o">==</span><span class="n">stack</span><span class="p">[:,:,</span><span class="n">ind</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">1</span><span class="p">]]</span><span class="o">.</span><span class="n">max</span><span class="p">())</span>
            <span class="n">indf</span><span class="p">[</span><span class="n">i</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">window_ind</span><span class="p">(</span><span class="n">cent1</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">],</span><span class="n">rad</span><span class="p">)</span>
            <span class="n">indg</span><span class="p">[</span><span class="n">i</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">window_ind</span><span class="p">(</span><span class="n">cent2</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">],</span><span class="n">rad</span><span class="p">)</span>
        <span class="n">indf</span> <span class="o">=</span> <span class="n">indf</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
        <span class="n">indg</span> <span class="o">=</span> <span class="n">indg</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

    <span class="n">pt1</span> <span class="o">=</span> <span class="n">cube_to_point_cloud</span><span class="p">(</span><span class="n">stack</span><span class="p">[:,:,</span><span class="n">ind</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]])</span>
    <span class="n">pt2</span> <span class="o">=</span> <span class="n">cube_to_point_cloud</span><span class="p">(</span><span class="n">stack</span><span class="p">[:,:,</span><span class="n">ind</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]])</span>

    <span class="n">pt1</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">,:]</span><span class="o">*=</span> <span class="n">param</span>
    <span class="n">pt2</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">,:]</span><span class="o">*=</span> <span class="n">param</span>

    <span class="k">return</span> <span class="p">[</span><span class="n">sliced_transport_time_assessing_m</span><span class="p">(</span><span class="n">pt1</span><span class="p">,</span><span class="n">pt2</span><span class="p">,</span><span class="n">nb_real</span><span class="p">,</span><span class="n">nb_iter</span><span class="o">=</span><span class="n">nb_iter</span><span class="p">,</span><span class="n">tol</span><span class="o">=</span><span class="n">tol</span><span class="p">,</span><span class="n">alph</span> <span class="o">=</span> <span class="n">alph</span><span class="p">,</span><span class="n">basis</span><span class="o">=</span><span class="n">basis</span><span class="p">,</span><span class="n">rand</span><span class="o">=</span><span class="n">rand</span><span class="p">,</span><span class="n">disc_err</span><span class="o">=</span><span class="n">disc_err</span><span class="p">,</span><span class="n">indf</span><span class="o">=</span><span class="n">indf</span><span class="p">,</span><span class="n">indg</span><span class="o">=</span><span class="n">indg</span><span class="p">,</span><span class="n">smart_init_en</span> <span class="o">=</span> <span class="n">smart_init_en</span><span class="p">),</span><span class="n">ind</span><span class="p">]</span>

<span class="k">def</span> <span class="nf">sliced_transport_time_assessing_interface_2</span><span class="p">(</span><span class="n">im1</span><span class="p">,</span><span class="n">im2</span><span class="p">,</span><span class="n">param</span><span class="p">,</span><span class="n">nb_real</span><span class="p">,</span><span class="n">nb_iter</span><span class="o">=</span><span class="mi">20000</span><span class="p">,</span><span class="n">tol</span><span class="o">=</span><span class="mf">0.001</span><span class="p">,</span><span class="n">alph</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span><span class="n">basis</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">rand</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">disc_err</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span><span class="n">smart_init_en</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span><span class="n">ind</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">monte_carlo</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span><span class="n">rad</span><span class="o">=</span><span class="mi">15</span><span class="p">):</span>
    <span class="kn">from</span> <span class="nn">optim_utils</span> <span class="k">import</span> <span class="n">sliced_transport_time_assessing_2</span>
    <span class="n">pt1</span> <span class="o">=</span> <span class="n">im_to_point_cloud</span><span class="p">(</span><span class="n">im1</span><span class="p">)</span>
    <span class="n">pt2</span> <span class="o">=</span> <span class="n">im_to_point_cloud</span><span class="p">(</span><span class="n">im2</span><span class="p">)</span>
    <span class="n">pt1</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">,:]</span><span class="o">*=</span> <span class="n">param</span>
    <span class="n">pt2</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">,:]</span><span class="o">*=</span> <span class="n">param</span>

    <span class="k">return</span> <span class="n">sliced_transport_time_assessing_2</span><span class="p">(</span><span class="n">pt1</span><span class="p">,</span><span class="n">pt2</span><span class="p">,</span><span class="n">nb_iter</span><span class="o">=</span><span class="n">nb_iter</span><span class="p">,</span><span class="n">tol</span><span class="o">=</span><span class="n">tol</span><span class="p">,</span><span class="n">alph</span> <span class="o">=</span> <span class="n">alph</span><span class="p">,</span><span class="n">basis</span><span class="o">=</span><span class="n">basis</span><span class="p">,</span><span class="n">nb_real</span><span class="o">=</span><span class="n">nb_real</span><span class="p">,</span><span class="n">rand</span><span class="o">=</span><span class="n">rand</span><span class="p">,</span><span class="n">disc_err</span><span class="o">=</span><span class="n">disc_err</span><span class="p">,</span><span class="n">smart_init_en</span> <span class="o">=</span> <span class="n">smart_init_en</span><span class="p">,</span><span class="n">monte_carlo</span><span class="o">=</span><span class="n">monte_carlo</span><span class="p">,</span><span class="n">gap</span><span class="o">=</span><span class="n">param</span><span class="p">,</span><span class="n">shap</span><span class="o">=</span><span class="n">im1</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span><span class="n">rad</span><span class="o">=</span><span class="n">rad</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">sliced_displacement_interp_test</span><span class="p">(</span><span class="n">im1</span><span class="p">,</span><span class="n">im2</span><span class="p">,</span><span class="n">param</span><span class="p">,</span><span class="n">nb_steps</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span><span class="n">nb_iter</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span><span class="n">nb_real</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span><span class="n">tol</span><span class="o">=</span><span class="mf">0.001</span><span class="p">,</span><span class="n">basis</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">rand</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">rad</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span><span class="n">smart_init_en</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">output_control</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">theta_en</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">max_dist</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">cent</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span><span class="n">norm_en</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">pf</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="kn">from</span> <span class="nn">optim_utils</span> <span class="k">import</span> <span class="n">sliced_transport</span><span class="p">,</span><span class="n">setting_polar</span><span class="p">,</span><span class="n">setting_cart_from_polar</span><span class="p">,</span><span class="n">cloud_size_constraint</span><span class="p">,</span><span class="n">dist_map_2</span><span class="p">,</span><span class="n">lasso_constraint</span><span class="p">,</span><span class="n">energy_warping_metric</span><span class="p">,</span><span class="n">cloud_size_constraint_simp</span>
    <span class="kn">from</span> <span class="nn">utils</span> <span class="k">import</span> <span class="n">window_ind</span>
    <span class="kn">from</span> <span class="nn">numpy</span> <span class="k">import</span> <span class="n">copy</span><span class="p">,</span><span class="n">linspace</span><span class="p">,</span><span class="n">ones</span><span class="p">,</span><span class="n">pi</span><span class="p">,</span><span class="nb">float</span>
    <span class="kn">from</span> <span class="nn">numpy.linalg</span> <span class="k">import</span> <span class="n">norm</span>

    <span class="n">pt1</span> <span class="o">=</span> <span class="n">im_to_point_cloud</span><span class="p">(</span><span class="n">im1</span><span class="p">)</span>
    <span class="n">pt2</span> <span class="o">=</span> <span class="n">im_to_point_cloud</span><span class="p">(</span><span class="n">im2</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">pf</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">theta_en</span><span class="p">:</span>
            <span class="n">pt1</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">setting_polar</span><span class="p">(</span><span class="n">pt1</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">,:],</span><span class="n">param</span><span class="p">,</span><span class="n">cent</span><span class="p">,</span><span class="n">max_dist</span><span class="p">)</span>
            <span class="n">pt2</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">pt1</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">,:])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">pt1</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">,:]</span><span class="o">*=</span><span class="n">param</span>
            <span class="n">pt2</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">,:]</span><span class="o">*=</span><span class="n">param</span>
        <span class="n">iopt</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">indf</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">indg</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">smart_init_en</span><span class="p">:</span>
            <span class="n">cent1</span> <span class="o">=</span> <span class="n">where</span><span class="p">(</span><span class="n">im1</span><span class="o">==</span><span class="n">im1</span><span class="o">.</span><span class="n">max</span><span class="p">())</span>
            <span class="n">cent2</span> <span class="o">=</span> <span class="n">where</span><span class="p">(</span><span class="n">im2</span><span class="o">==</span><span class="n">im2</span><span class="o">.</span><span class="n">max</span><span class="p">())</span>
            <span class="n">indf</span> <span class="o">=</span> <span class="n">window_ind</span><span class="p">(</span><span class="n">cent1</span><span class="p">,</span><span class="n">im1</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span><span class="n">rad</span><span class="p">)</span>
            <span class="n">indg</span> <span class="o">=</span> <span class="n">window_ind</span><span class="p">(</span><span class="n">cent2</span><span class="p">,</span><span class="n">im2</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span><span class="n">rad</span><span class="p">)</span>
        <span class="c1">#print indf,&quot;------&quot;,indg</span>
        <span class="n">pf</span><span class="p">,</span><span class="n">dist</span><span class="p">,</span><span class="n">sig</span><span class="p">,</span><span class="n">i_opt</span> <span class="o">=</span> <span class="n">sliced_transport</span><span class="p">(</span><span class="n">pt1</span><span class="p">,</span><span class="n">pt2</span><span class="p">,</span><span class="n">nb_real</span><span class="o">=</span><span class="n">nb_real</span><span class="p">,</span><span class="n">nb_iter</span><span class="o">=</span><span class="n">nb_iter</span><span class="p">,</span><span class="n">tol</span><span class="o">=</span><span class="n">tol</span><span class="p">,</span><span class="n">alph</span> <span class="o">=</span> <span class="n">alpha</span><span class="p">,</span><span class="n">basis</span><span class="o">=</span><span class="n">basis</span><span class="p">,</span><span class="n">rand</span><span class="o">=</span><span class="n">rand</span><span class="p">,</span><span class="n">output_control</span><span class="o">=</span><span class="n">output_control</span><span class="p">,</span><span class="n">iter_control</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">gap</span><span class="o">=</span><span class="n">param</span><span class="p">,</span><span class="n">shap</span> <span class="o">=</span> <span class="n">im1</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span><span class="n">rad</span><span class="o">=</span><span class="n">rad</span><span class="p">,</span><span class="n">indf</span><span class="o">=</span><span class="n">indf</span><span class="p">,</span><span class="n">indg</span><span class="o">=</span><span class="n">indg</span><span class="p">,</span><span class="n">smart_init_en</span><span class="o">=</span><span class="n">smart_init_en</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">theta_en</span><span class="p">:</span>
            <span class="n">pf</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">setting_cart_from_polar</span><span class="p">(</span><span class="n">pf</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">,:],</span><span class="n">param</span><span class="p">,</span><span class="n">cent</span><span class="p">,</span><span class="n">max_dist</span><span class="p">)</span>
            <span class="n">pt1</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">setting_cart_from_polar</span><span class="p">(</span><span class="n">pt1</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">,:],</span><span class="n">param</span><span class="p">,</span><span class="n">cent</span><span class="p">,</span><span class="n">max_dist</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">pf</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">,:]</span><span class="o">/=</span><span class="n">param</span>
            <span class="n">pt1</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">,:]</span><span class="o">/=</span><span class="n">param</span>

    <span class="n">im_interp</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">im1</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">im1</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">nb_steps</span><span class="p">))</span>
    <span class="n">t</span> <span class="o">=</span> <span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">nb_steps</span><span class="p">)</span>
    <span class="n">cent_mat</span> <span class="o">=</span> <span class="n">cent</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">ones</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span><span class="n">pf</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])))</span>
    <span class="n">dist_ref</span> <span class="o">=</span> <span class="n">norm</span><span class="p">(</span><span class="n">cent_mat</span><span class="o">-</span><span class="n">pf</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">,:])</span>
    <span class="n">siz_i</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">((</span><span class="n">norm</span><span class="p">((</span><span class="n">pt1</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">,:]</span><span class="o">-</span><span class="n">cent_mat</span><span class="p">),</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">pt1</span><span class="p">[</span><span class="mi">2</span><span class="p">,:])</span>
    <span class="n">siz_f</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">((</span><span class="n">norm</span><span class="p">((</span><span class="n">pf</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">,:]</span><span class="o">-</span><span class="n">cent_mat</span><span class="p">),</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">pf</span><span class="p">[</span><span class="mi">2</span><span class="p">,:])</span>
    <span class="n">cloud</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">pt1</span><span class="p">)</span>
    <span class="n">angle_min</span> <span class="o">=</span> <span class="n">pi</span><span class="o">/</span><span class="mi">3</span>
    <span class="n">energy_distrib</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">nb_steps</span><span class="p">,))</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_steps</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">nb_steps</span><span class="o">-</span><span class="mi">1</span> <span class="ow">and</span> <span class="n">i</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
            <span class="n">cloud</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">nb_steps</span><span class="o">-</span><span class="n">i</span><span class="p">))</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span><span class="o">*</span><span class="n">cloud</span><span class="o">+</span><span class="p">((</span><span class="mi">1</span><span class="o">+</span><span class="nb">float</span><span class="p">(</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">nb_steps</span><span class="o">-</span><span class="n">i</span><span class="p">))</span><span class="o">/</span><span class="p">(</span><span class="n">nb_steps</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span><span class="o">*</span><span class="n">pf</span>
            <span class="k">if</span> <span class="n">norm_en</span><span class="p">:</span>
                <span class="n">cloud</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">cloud_size_constraint_simp</span><span class="p">(</span><span class="n">cloud</span><span class="p">,</span><span class="n">cent</span><span class="p">,(</span><span class="mi">1</span><span class="o">-</span><span class="n">t</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="o">*</span><span class="n">siz_i</span><span class="o">+</span><span class="n">t</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">*</span><span class="n">siz_f</span><span class="p">)</span>
            <span class="nb">print</span> <span class="s2">&quot;cloud_err: &quot;</span><span class="p">,</span><span class="n">norm</span><span class="p">(</span><span class="n">cloud</span><span class="o">-</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">t</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="o">*</span><span class="n">pt1</span><span class="o">-</span><span class="n">t</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">*</span><span class="n">pf</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">i</span><span class="o">==</span><span class="n">nb_steps</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">cloud</span> <span class="o">=</span> <span class="n">pf</span>
        <span class="n">intensities</span><span class="p">,</span><span class="n">inv_dist_weights</span><span class="p">,</span><span class="n">energy_distrib</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">knn</span> <span class="o">=</span> <span class="n">energy_warping_metric</span><span class="p">(</span><span class="n">cloud</span><span class="p">,</span><span class="n">nb_neigh</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
        <span class="n">dist_mat</span> <span class="o">=</span> <span class="n">dist_map_2</span><span class="p">(</span><span class="n">cloud</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">,:])</span>
        <span class="n">k</span><span class="p">,</span><span class="n">l</span> <span class="o">=</span> <span class="n">where</span><span class="p">(</span><span class="n">dist_mat</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">)</span>
        <span class="nb">print</span> <span class="s2">&quot;Mean dist before correction: &quot;</span><span class="p">,</span><span class="n">dist_mat</span><span class="p">[</span><span class="n">k</span><span class="p">,</span><span class="n">l</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>

        <span class="sd">&quot;&quot;&quot;if norm_en:</span>
<span class="sd">            #cloud[0:2,:] = lasso_constraint(cloud[0:2,:],im1.shape,0.4,angle_min,nb_iter=400,mu=0.0005,tol=1.e-2)</span>
<span class="sd">            cloud[0:2,:] = lasso_constraint((1-t[i])*pt1[0:2,:]-t[i]*pf[0:2,:],im1.shape,0.2,angle_min,nb_iter=400,mu=0.0005,tol=1.e-2)</span>
<span class="sd">            #cloud = cloud_size_constraint(cloud,cent,(1-t[i])*siz_i+t[i]*siz_f,dist_ref)</span>
<span class="sd">            #cloud[0:2,:] = dist_ref*(cloud[0:2,:]-cent_mat)/norm(cloud[0:2,:]-cent_mat) + cent_mat&quot;&quot;&quot;</span>
        <span class="n">moment</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">((</span><span class="n">norm</span><span class="p">((</span><span class="n">cloud</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">,:]</span><span class="o">-</span><span class="n">cent_mat</span><span class="p">),</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">cloud</span><span class="p">[</span><span class="mi">2</span><span class="p">,:])</span>
        <span class="nb">print</span> <span class="s2">&quot;Step &quot;</span><span class="p">,</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="s2">&quot;/&quot;</span><span class="p">,</span><span class="n">nb_steps</span>
        <span class="nb">print</span> <span class="s2">&quot;Moment: &quot;</span><span class="p">,</span><span class="n">moment</span>
        <span class="nb">print</span> <span class="s2">&quot;Energy: &quot;</span><span class="p">,</span><span class="n">norm</span><span class="p">(</span><span class="n">cloud</span><span class="p">[</span><span class="mi">2</span><span class="p">,:])</span><span class="o">**</span><span class="mi">2</span>
        <span class="n">im_interp</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">bar_1d_2d_bis</span><span class="p">(</span><span class="n">cloud</span><span class="p">,</span><span class="n">im1</span><span class="o">.</span><span class="n">shape</span><span class="p">,[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span><span class="n">pol_en</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">log_param</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">tol</span><span class="o">=</span><span class="mf">10.0</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mi">15</span><span class="p">))</span>
        <span class="nb">print</span> <span class="s2">&quot;Image Energy: &quot;</span><span class="p">,</span><span class="n">norm</span><span class="p">(</span><span class="n">im_interp</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span>


    <span class="k">return</span> <span class="n">im_interp</span><span class="p">,</span><span class="n">pf</span><span class="p">,</span><span class="n">energy_distrib</span>

<span class="k">def</span> <span class="nf">sliced_displacement_interp_test_2</span><span class="p">(</span><span class="n">im1</span><span class="p">,</span><span class="n">im2</span><span class="p">,</span><span class="n">param</span><span class="p">,</span><span class="n">cent</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">nb_iter</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span><span class="n">nb_real</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span><span class="n">tol</span><span class="o">=</span><span class="mf">1.e-15</span><span class="p">):</span>
    <span class="kn">from</span> <span class="nn">optim_utils</span> <span class="k">import</span> <span class="n">sliced_transport_single_dir</span>
    <span class="kn">from</span> <span class="nn">numpy</span> <span class="k">import</span> <span class="n">zeros</span><span class="p">,</span><span class="n">array</span>
    <span class="kn">from</span> <span class="nn">numpy.linalg</span> <span class="k">import</span> <span class="n">norm</span>

    <span class="n">pt1</span> <span class="o">=</span> <span class="n">im_to_point_cloud</span><span class="p">(</span><span class="n">im1</span><span class="p">)</span>
    <span class="n">pt2</span> <span class="o">=</span> <span class="n">im_to_point_cloud</span><span class="p">(</span><span class="n">im2</span><span class="p">)</span>
    <span class="n">shap</span> <span class="o">=</span> <span class="n">im1</span><span class="o">.</span><span class="n">shape</span>

    <span class="k">if</span> <span class="n">cent</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">cent</span> <span class="o">=</span>  <span class="n">array</span><span class="p">(</span><span class="n">where</span><span class="p">(</span><span class="n">im1</span><span class="o">==</span><span class="n">im1</span><span class="o">.</span><span class="n">max</span><span class="p">()))</span>

    <span class="n">pt1</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">,:]</span><span class="o">*=</span><span class="n">param</span>
    <span class="n">pt2</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">,:]</span><span class="o">*=</span><span class="n">param</span>
    <span class="n">rmin</span> <span class="o">=</span> <span class="mf">0.00000000000000001</span>

    <span class="n">displacement</span> <span class="o">=</span> <span class="n">sliced_transport_single_dir</span><span class="p">(</span><span class="n">pt1</span><span class="p">,</span><span class="n">pt2</span><span class="p">,</span><span class="n">nb_iter</span><span class="o">=</span><span class="n">nb_iter</span><span class="p">,</span><span class="n">tol</span><span class="o">=</span><span class="n">tol</span><span class="p">,</span><span class="n">nb_real</span><span class="o">=</span><span class="n">nb_real</span><span class="p">)</span>

    <span class="n">nb_time_steps</span> <span class="o">=</span> <span class="mi">11</span>
    <span class="n">advect_summary</span> <span class="o">=</span> <span class="n">advection_synthesis</span><span class="p">(</span><span class="n">displacement</span><span class="p">,</span><span class="n">nb_time_steps</span><span class="o">=</span><span class="n">nb_time_steps</span><span class="p">)</span>
    <span class="n">im_interp</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">im1</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">im1</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">nb_time_steps</span><span class="p">))</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_time_steps</span><span class="p">):</span>
        <span class="n">advect_summary</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">,:,</span><span class="n">i</span><span class="p">]</span><span class="o">/=</span><span class="n">param</span>
        <span class="n">im_interp</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">bar_1d_2d_bis</span><span class="p">(</span><span class="n">advect_summary</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">],</span><span class="n">im1</span><span class="o">.</span><span class="n">shape</span><span class="p">,[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span><span class="n">pol_en</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">log_param</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">tol</span><span class="o">=</span><span class="mf">10.0</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mi">15</span><span class="p">))</span>
        <span class="nb">print</span> <span class="s2">&quot;Image Energy: &quot;</span><span class="p">,</span><span class="n">norm</span><span class="p">(</span><span class="n">im_interp</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span>

    <span class="k">return</span> <span class="n">im_interp</span>




<span class="k">def</span> <span class="nf">sliced_displacement_interp_test_3</span><span class="p">(</span><span class="n">im1</span><span class="p">,</span><span class="n">im2</span><span class="p">,</span><span class="n">param</span><span class="p">,</span><span class="n">step_max</span><span class="p">,</span><span class="n">nb_iter</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span><span class="n">nb_real</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span><span class="n">tol</span><span class="o">=</span><span class="mf">1.e-15</span><span class="p">,</span><span class="n">basis</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">rand</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">rad</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span><span class="n">smart_init_en</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">output_control</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">theta_en</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">max_dist</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">cent</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span><span class="n">norm_en</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">pf</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">nb_time_steps</span> <span class="o">=</span> <span class="mi">11</span><span class="p">):</span>
    <span class="kn">from</span> <span class="nn">optim_utils</span> <span class="k">import</span> <span class="n">sliced_transport</span><span class="p">,</span><span class="n">setting_polar</span><span class="p">,</span><span class="n">setting_cart_from_polar</span><span class="p">,</span><span class="n">cloud_size_constraint</span><span class="p">,</span><span class="n">dist_map_2</span><span class="p">,</span><span class="n">lasso_constraint</span>
    <span class="kn">from</span> <span class="nn">utils</span> <span class="k">import</span> <span class="n">window_ind</span>
    <span class="kn">from</span> <span class="nn">numpy</span> <span class="k">import</span> <span class="n">copy</span><span class="p">,</span><span class="n">linspace</span><span class="p">,</span><span class="n">ones</span><span class="p">,</span><span class="n">pi</span><span class="p">,</span><span class="nb">float</span><span class="p">,</span><span class="n">array</span>
    <span class="kn">from</span> <span class="nn">numpy.linalg</span> <span class="k">import</span> <span class="n">norm</span>



    <span class="n">pt1</span> <span class="o">=</span> <span class="n">im_to_point_cloud</span><span class="p">(</span><span class="n">im1</span><span class="p">)</span>
    <span class="n">pt2</span> <span class="o">=</span> <span class="n">im_to_point_cloud</span><span class="p">(</span><span class="n">im2</span><span class="p">)</span>
    <span class="n">cent1</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">pf</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">theta_en</span><span class="p">:</span>
            <span class="n">pt1</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">setting_polar</span><span class="p">(</span><span class="n">pt1</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">,:],</span><span class="n">param</span><span class="p">,</span><span class="n">cent</span><span class="p">,</span><span class="n">max_dist</span><span class="p">)</span>
            <span class="n">pt2</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">pt1</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">,:])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">pt1</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">,:]</span><span class="o">*=</span><span class="n">param</span>
            <span class="n">pt2</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">,:]</span><span class="o">*=</span><span class="n">param</span>
        <span class="n">iopt</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">indf</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">indg</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">smart_init_en</span><span class="p">:</span>
            <span class="n">cent1</span> <span class="o">=</span> <span class="n">where</span><span class="p">(</span><span class="n">im1</span><span class="o">==</span><span class="n">im1</span><span class="o">.</span><span class="n">max</span><span class="p">())</span>
            <span class="n">cent2</span> <span class="o">=</span> <span class="n">where</span><span class="p">(</span><span class="n">im2</span><span class="o">==</span><span class="n">im2</span><span class="o">.</span><span class="n">max</span><span class="p">())</span>
            <span class="n">indf</span> <span class="o">=</span> <span class="n">window_ind</span><span class="p">(</span><span class="n">cent1</span><span class="p">,</span><span class="n">im1</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span><span class="n">rad</span><span class="p">)</span>
            <span class="n">indg</span> <span class="o">=</span> <span class="n">window_ind</span><span class="p">(</span><span class="n">cent2</span><span class="p">,</span><span class="n">im2</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span><span class="n">rad</span><span class="p">)</span>
        <span class="c1">#print indf,&quot;------&quot;,indg</span>
        <span class="n">pf</span><span class="p">,</span><span class="n">dist</span><span class="p">,</span><span class="n">sig</span><span class="p">,</span><span class="n">i_opt</span> <span class="o">=</span> <span class="n">sliced_transport</span><span class="p">(</span><span class="n">pt1</span><span class="p">,</span><span class="n">pt2</span><span class="p">,</span><span class="n">nb_real</span><span class="o">=</span><span class="n">nb_real</span><span class="p">,</span><span class="n">nb_iter</span><span class="o">=</span><span class="n">nb_iter</span><span class="p">,</span><span class="n">tol</span><span class="o">=</span><span class="n">tol</span><span class="p">,</span><span class="n">alph</span> <span class="o">=</span> <span class="n">alpha</span><span class="p">,</span><span class="n">basis</span><span class="o">=</span><span class="n">basis</span><span class="p">,</span><span class="n">rand</span><span class="o">=</span><span class="n">rand</span><span class="p">,</span><span class="n">output_control</span><span class="o">=</span><span class="n">output_control</span><span class="p">,</span><span class="n">iter_control</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">gap</span><span class="o">=</span><span class="n">param</span><span class="p">,</span><span class="n">shap</span> <span class="o">=</span> <span class="n">im1</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span><span class="n">rad</span><span class="o">=</span><span class="n">rad</span><span class="p">,</span><span class="n">indf</span><span class="o">=</span><span class="n">indf</span><span class="p">,</span><span class="n">indg</span><span class="o">=</span><span class="n">indg</span><span class="p">,</span><span class="n">smart_init_en</span><span class="o">=</span><span class="n">smart_init_en</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">theta_en</span><span class="p">:</span>
            <span class="n">pf</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">setting_cart_from_polar</span><span class="p">(</span><span class="n">pf</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">,:],</span><span class="n">param</span><span class="p">,</span><span class="n">cent</span><span class="p">,</span><span class="n">max_dist</span><span class="p">)</span>
            <span class="n">pt1</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">setting_cart_from_polar</span><span class="p">(</span><span class="n">pt1</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">,:],</span><span class="n">param</span><span class="p">,</span><span class="n">cent</span><span class="p">,</span><span class="n">max_dist</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">pf</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">,:]</span><span class="o">/=</span><span class="n">param</span>
            <span class="n">pt1</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">,:]</span><span class="o">/=</span><span class="n">param</span>

    <span class="k">if</span> <span class="n">cent1</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">cent1</span> <span class="o">=</span> <span class="n">where</span><span class="p">(</span><span class="n">im1</span><span class="o">==</span><span class="n">im1</span><span class="o">.</span><span class="n">max</span><span class="p">())</span>

    <span class="n">advect_list</span> <span class="o">=</span> <span class="n">size_constraint_advection</span><span class="p">(</span><span class="n">pt1</span><span class="p">,</span><span class="n">pf</span><span class="p">,</span><span class="n">array</span><span class="p">(</span><span class="n">cent1</span><span class="p">),</span><span class="n">gap</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">step_max</span><span class="o">=</span><span class="n">step_max</span><span class="p">,</span><span class="n">tol</span><span class="o">=</span><span class="mf">1.e-13</span><span class="p">,</span><span class="n">nb_steps</span><span class="o">=</span><span class="mi">50000</span><span class="p">)</span>

    <span class="n">advect_summary</span> <span class="o">=</span> <span class="n">advection_synthesis</span><span class="p">(</span><span class="n">advect_list</span><span class="p">,</span><span class="n">nb_time_steps</span><span class="o">=</span><span class="n">nb_time_steps</span><span class="p">)</span>
    <span class="n">im_interp</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">im1</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">im1</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">nb_time_steps</span><span class="p">))</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_time_steps</span><span class="p">):</span>
        <span class="n">im_interp</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">bar_1d_2d_bis</span><span class="p">(</span><span class="n">advect_summary</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">],</span><span class="n">im1</span><span class="o">.</span><span class="n">shape</span><span class="p">,[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span><span class="n">pol_en</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">log_param</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">tol</span><span class="o">=</span><span class="mf">10.0</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mi">15</span><span class="p">))</span>
        <span class="nb">print</span> <span class="s2">&quot;Image Energy: &quot;</span><span class="p">,</span><span class="n">norm</span><span class="p">(</span><span class="n">im_interp</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span>

    <span class="k">return</span> <span class="n">im_interp</span><span class="p">,</span><span class="n">pf</span>




<span class="k">def</span> <span class="nf">size_constraint_advection</span><span class="p">(</span><span class="n">pt1</span><span class="p">,</span><span class="n">pf</span><span class="p">,</span><span class="n">cent</span><span class="p">,</span><span class="n">gap</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">step_max</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">tol</span><span class="o">=</span><span class="mf">1.e-15</span><span class="p">,</span><span class="n">nb_steps</span><span class="o">=</span><span class="mi">5000</span><span class="p">,</span><span class="n">imax</span> <span class="o">=</span> <span class="mi">200000</span><span class="p">,</span><span class="n">energy_cons</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">sheep_constraint</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="kn">from</span> <span class="nn">numpy.linalg</span> <span class="k">import</span> <span class="n">norm</span><span class="p">,</span><span class="n">svd</span>
    <span class="kn">from</span> <span class="nn">optim_utils</span> <span class="k">import</span> <span class="n">shape_tg_proj</span><span class="p">,</span><span class="n">energy_warping_tg_proj</span>
    <span class="kn">from</span> <span class="nn">numpy</span> <span class="k">import</span> <span class="n">transpose</span><span class="p">,</span><span class="n">ones</span>
    <span class="k">if</span> <span class="n">step_max</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">step_max</span> <span class="o">=</span> <span class="n">norm</span><span class="p">(</span><span class="n">pt1</span><span class="o">-</span><span class="n">pf</span><span class="p">)</span><span class="o">/</span><span class="n">nb_steps</span>

    <span class="nb">print</span> <span class="s2">&quot;step max: &quot;</span><span class="p">,</span><span class="n">step_max</span>

    <span class="n">var</span> <span class="o">=</span> <span class="n">norm</span><span class="p">(</span><span class="n">pt1</span><span class="o">-</span><span class="n">pf</span><span class="p">)</span>
    <span class="n">i</span><span class="o">=</span><span class="mi">0</span>
    <span class="n">advect_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
    <span class="n">advect_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pt1</span><span class="p">)</span>
    <span class="n">nb_points</span> <span class="o">=</span> <span class="n">pt1</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">while</span><span class="p">(</span><span class="n">var</span><span class="o">&gt;</span><span class="n">tol</span> <span class="ow">and</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">imax</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">energy_cons</span><span class="p">:</span>
            <span class="n">ascent_dir</span> <span class="o">=</span> <span class="n">energy_warping_tg_proj</span><span class="p">(</span><span class="n">advect_list</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">advect_list</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-</span><span class="n">pf</span><span class="p">,</span><span class="n">nb_neigh</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">sheep_constraint</span><span class="p">:</span>
            <span class="n">intensity_weigh_mat</span> <span class="o">=</span> <span class="n">ones</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">advect_list</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">2</span><span class="p">,:]</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span><span class="n">nb_points</span><span class="p">)))</span>
            <span class="c1">#U,s,V = svd((intensity_weigh_mat*(advect_list[i][0:2,:]-pf[0:2,:])).dot(transpose(intensity_weigh_mat*(advect_list[i][0:2,:]-pf[0:2,:]))))</span>
            <span class="n">U</span><span class="p">,</span><span class="n">s</span><span class="p">,</span><span class="n">V</span> <span class="o">=</span> <span class="n">svd</span><span class="p">((</span><span class="n">advect_list</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-</span><span class="n">pf</span><span class="p">)</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">transpose</span><span class="p">(</span><span class="n">advect_list</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-</span><span class="n">pf</span><span class="p">)))</span>
            <span class="c1">#print &quot;advection energy: &quot;,s</span>
            <span class="c1">#ascent_dir = copy(advect_list[i]-pf)</span>
            <span class="n">ascent_dir</span> <span class="o">=</span> <span class="n">U</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">U</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">)))</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">advect_list</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-</span><span class="n">pf</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ascent_dir</span> <span class="o">=</span> <span class="n">shape_tg_proj</span><span class="p">(</span><span class="n">advect_list</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">advect_list</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-</span><span class="n">pf</span><span class="p">,</span><span class="n">cent</span><span class="p">,</span><span class="n">gap</span><span class="o">=</span><span class="n">gap</span><span class="p">)</span>

        <span class="n">step</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">step_max</span><span class="p">,</span><span class="nb">sum</span><span class="p">((</span><span class="n">advect_list</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-</span><span class="n">pf</span><span class="p">)</span><span class="o">*</span><span class="n">ascent_dir</span><span class="p">)</span><span class="o">/</span><span class="n">norm</span><span class="p">(</span><span class="n">ascent_dir</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
        <span class="c1">#step = sum((advect_list[i]-pf)*ascent_dir)/norm(ascent_dir)**2</span>
        <span class="n">cloud_i</span> <span class="o">=</span> <span class="n">advect_list</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">step</span><span class="o">*</span><span class="n">ascent_dir</span>
        <span class="n">var</span> <span class="o">=</span> <span class="n">norm</span><span class="p">(</span><span class="n">step</span><span class="o">*</span><span class="n">ascent_dir</span><span class="p">)</span>
        <span class="nb">print</span> <span class="s2">&quot;Advection vector norm: &quot;</span><span class="p">,</span><span class="n">var</span><span class="p">,</span><span class="s2">&quot; Relative error: &quot;</span><span class="p">,</span><span class="mi">100</span><span class="o">*</span><span class="n">norm</span><span class="p">(</span><span class="n">cloud_i</span><span class="o">-</span><span class="n">pf</span><span class="p">)</span><span class="o">/</span><span class="n">norm</span><span class="p">(</span><span class="n">pf</span><span class="p">)</span>
        <span class="n">advect_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cloud_i</span><span class="p">)</span>
        <span class="n">i</span><span class="o">+=</span><span class="mi">1</span>
    <span class="n">advect_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pf</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">advect_list</span>

<span class="k">def</span> <span class="nf">advection_analysis</span><span class="p">(</span><span class="n">advect_list</span><span class="p">):</span>
    <span class="kn">from</span> <span class="nn">numpy</span> <span class="k">import</span> <span class="n">zeros</span>
    <span class="kn">from</span> <span class="nn">numpy.linalg</span> <span class="k">import</span> <span class="n">norm</span>
    <span class="n">dist</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">advect_list</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">,))</span>
    <span class="n">dist</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">norm</span><span class="p">(</span><span class="n">advect_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">advect_list</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">advect_list</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
        <span class="n">dist</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">dist</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">norm</span><span class="p">(</span><span class="n">advect_list</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-</span><span class="n">advect_list</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">dist</span>

<span class="k">def</span> <span class="nf">advection_synthesis</span><span class="p">(</span><span class="n">advect_list</span><span class="p">,</span><span class="n">nb_time_steps</span><span class="o">=</span><span class="mi">11</span><span class="p">):</span>
    <span class="kn">from</span> <span class="nn">numpy</span> <span class="k">import</span> <span class="n">linspace</span><span class="p">,</span><span class="n">sort</span>
    <span class="n">shap</span> <span class="o">=</span> <span class="n">advect_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">cumulated_dist</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">advection_analysis</span><span class="p">(</span><span class="n">advect_list</span><span class="p">))</span>

    <span class="n">output</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">nb_time_steps</span><span class="p">))</span>
    <span class="n">t</span> <span class="o">=</span> <span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">nb_time_steps</span><span class="p">)</span>
    <span class="n">output</span><span class="p">[:,:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">advect_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">output</span><span class="p">[:,:,</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">advect_list</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">nb_time_steps</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
        <span class="n">geod_t</span> <span class="o">=</span> <span class="n">t</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">*</span><span class="n">cumulated_dist</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">cumulated_dist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">geod_t</span><span class="p">)</span>
        <span class="n">sort_dist</span> <span class="o">=</span> <span class="n">sort</span><span class="p">(</span><span class="n">cumulated_dist</span><span class="p">)</span>
        <span class="n">j</span> <span class="o">=</span> <span class="n">where</span><span class="p">(</span><span class="n">sort_dist</span><span class="o">==</span><span class="n">geod_t</span><span class="p">)</span>
        <span class="n">output</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="n">sort_dist</span><span class="p">[</span><span class="n">j</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">geod_t</span><span class="p">)</span><span class="o">*</span><span class="n">advect_list</span><span class="p">[</span><span class="n">j</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="p">(</span><span class="n">geod_t</span><span class="o">-</span><span class="n">sort_dist</span><span class="p">[</span><span class="n">j</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span><span class="o">*</span><span class="n">advect_list</span><span class="p">[</span><span class="n">j</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span><span class="o">/</span><span class="p">(</span><span class="n">sort_dist</span><span class="p">[</span><span class="n">j</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">sort_dist</span><span class="p">[</span><span class="n">j</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">cumulated_dist</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">geod_t</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">output</span>

<span class="k">def</span> <span class="nf">sliced_wassertein_dist_interface</span><span class="p">(</span><span class="n">im1</span><span class="p">,</span><span class="n">im2</span><span class="p">,</span><span class="n">param</span><span class="p">,</span><span class="n">nb_iter</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span><span class="n">nb_real</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span><span class="n">tol</span><span class="o">=</span><span class="mf">0.001</span><span class="p">,</span><span class="n">basis</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">rand</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">im_output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">matched_output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">rad</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span><span class="n">smart_init_en</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">output_control</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">theta_en</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">max_dist</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">cent</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="mf">1.0</span><span class="p">):</span>
    <span class="kn">from</span> <span class="nn">optim_utils</span> <span class="k">import</span> <span class="n">sliced_transport</span><span class="p">,</span><span class="n">opt_assignment</span><span class="p">,</span><span class="n">setting_polar</span><span class="p">,</span><span class="n">setting_cart_from_polar</span>
    <span class="kn">from</span> <span class="nn">utils</span> <span class="k">import</span> <span class="n">window_ind</span>
    <span class="kn">import</span> <span class="nn">time</span>
    <span class="kn">from</span> <span class="nn">numpy</span> <span class="k">import</span> <span class="n">copy</span>

    <span class="n">pt1</span> <span class="o">=</span> <span class="n">im_to_point_cloud</span><span class="p">(</span><span class="n">im1</span><span class="p">)</span>
    <span class="n">pt2</span> <span class="o">=</span> <span class="n">im_to_point_cloud</span><span class="p">(</span><span class="n">im2</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">theta_en</span><span class="p">:</span>
        <span class="n">pt1</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">setting_polar</span><span class="p">(</span><span class="n">pt1</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">,:],</span><span class="n">param</span><span class="p">,</span><span class="n">cent</span><span class="p">,</span><span class="n">max_dist</span><span class="p">)</span>
        <span class="n">pt2</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">pt1</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">,:])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">pt1</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">,:]</span><span class="o">*=</span><span class="n">param</span>
        <span class="n">pt2</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">,:]</span><span class="o">*=</span><span class="n">param</span>
    <span class="n">iopt</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">indf</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">indg</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">smart_init_en</span><span class="p">:</span>
        <span class="n">cent1</span> <span class="o">=</span> <span class="n">where</span><span class="p">(</span><span class="n">im1</span><span class="o">==</span><span class="n">im1</span><span class="o">.</span><span class="n">max</span><span class="p">())</span>
        <span class="n">cent2</span> <span class="o">=</span> <span class="n">where</span><span class="p">(</span><span class="n">im2</span><span class="o">==</span><span class="n">im2</span><span class="o">.</span><span class="n">max</span><span class="p">())</span>
        <span class="n">indf</span> <span class="o">=</span> <span class="n">window_ind</span><span class="p">(</span><span class="n">cent1</span><span class="p">,</span><span class="n">im1</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span><span class="n">rad</span><span class="p">)</span>
        <span class="n">indg</span> <span class="o">=</span> <span class="n">window_ind</span><span class="p">(</span><span class="n">cent2</span><span class="p">,</span><span class="n">im2</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span><span class="n">rad</span><span class="p">)</span>
    <span class="c1">#print indf,&quot;------&quot;,indg</span>
    <span class="n">pf</span><span class="p">,</span><span class="n">dist</span><span class="p">,</span><span class="n">sig</span><span class="p">,</span><span class="n">i_opt</span><span class="p">,</span><span class="nb">iter</span><span class="o">=</span> <span class="n">sliced_transport</span><span class="p">(</span><span class="n">pt1</span><span class="p">,</span><span class="n">pt2</span><span class="p">,</span><span class="n">nb_real</span><span class="o">=</span><span class="n">nb_real</span><span class="p">,</span><span class="n">nb_iter</span><span class="o">=</span><span class="n">nb_iter</span><span class="p">,</span><span class="n">tol</span><span class="o">=</span><span class="n">tol</span><span class="p">,</span><span class="n">alph</span> <span class="o">=</span> <span class="n">alpha</span><span class="p">,</span><span class="n">basis</span><span class="o">=</span><span class="n">basis</span><span class="p">,</span><span class="n">rand</span><span class="o">=</span><span class="n">rand</span><span class="p">,</span><span class="n">output_control</span><span class="o">=</span><span class="n">output_control</span><span class="p">,</span><span class="n">iter_control</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">gap</span><span class="o">=</span><span class="n">param</span><span class="p">,</span><span class="n">shap</span> <span class="o">=</span> <span class="n">im1</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span><span class="n">rad</span><span class="o">=</span><span class="n">rad</span><span class="p">,</span><span class="n">indf</span><span class="o">=</span><span class="n">indf</span><span class="p">,</span><span class="n">indg</span><span class="o">=</span><span class="n">indg</span><span class="p">,</span><span class="n">smart_init_en</span><span class="o">=</span><span class="n">smart_init_en</span><span class="p">)</span>



    <span class="k">if</span> <span class="n">theta_en</span><span class="p">:</span>
        <span class="n">pf</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">setting_cart_from_polar</span><span class="p">(</span><span class="n">pf</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">,:],</span><span class="n">param</span><span class="p">,</span><span class="n">cent</span><span class="p">,</span><span class="n">max_dist</span><span class="p">)</span>
        <span class="n">pt1</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">setting_cart_from_polar</span><span class="p">(</span><span class="n">pt1</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">,:],</span><span class="n">param</span><span class="p">,</span><span class="n">cent</span><span class="p">,</span><span class="n">max_dist</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">pf</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">,:]</span><span class="o">/=</span><span class="n">param</span>
        <span class="n">pt1</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">,:]</span><span class="o">/=</span><span class="n">param</span>
    <span class="n">matched</span> <span class="o">=</span> <span class="p">[</span><span class="n">pt1</span><span class="p">,</span><span class="n">pf</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">im_output</span><span class="p">:</span>
        <span class="n">projim1</span> <span class="o">=</span> <span class="n">bar_1d_2d_bis</span><span class="p">(</span><span class="n">pf</span><span class="p">,</span><span class="n">im1</span><span class="o">.</span><span class="n">shape</span><span class="p">,[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span><span class="n">pol_en</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">log_param</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">tol</span><span class="o">=</span><span class="mf">10.0</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mi">15</span><span class="p">))</span>
        <span class="n">iter_im</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">projim1</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">projim1</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="nb">iter</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">iter</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
            <span class="k">if</span> <span class="n">theta_en</span><span class="p">:</span>
                <span class="n">iter_im</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">,:,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">setting_cart_from_polar</span><span class="p">(</span><span class="n">iter_im</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">,:,</span><span class="n">i</span><span class="p">],</span><span class="n">param</span><span class="p">,</span><span class="n">cent</span><span class="p">,</span><span class="n">max_dist</span><span class="p">)</span>
            <span class="n">iter_im</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">bar_1d_2d_bis</span><span class="p">(</span><span class="nb">iter</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">],</span><span class="n">im1</span><span class="o">.</span><span class="n">shape</span><span class="p">,[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span><span class="n">pol_en</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">log_param</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">tol</span><span class="o">=</span><span class="mf">10.0</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mi">15</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">dist</span><span class="p">,</span><span class="n">sig</span><span class="p">,</span><span class="n">projim1</span><span class="p">,</span><span class="n">i_opt</span><span class="p">,</span><span class="n">iter_im</span>
    <span class="k">elif</span> <span class="n">matched_output</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">dist</span><span class="p">,</span><span class="n">sig</span><span class="p">,</span><span class="n">matched</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">dist</span><span class="p">,</span><span class="n">sig</span>




<span class="k">def</span> <span class="nf">sliced_wassertein_dist_interface_target</span><span class="p">(</span><span class="n">stack</span><span class="p">,</span><span class="n">pos_field</span><span class="p">,</span><span class="n">target_pos</span><span class="p">,</span><span class="n">param</span><span class="p">,</span><span class="n">nb_iter</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span><span class="n">tol</span><span class="o">=</span><span class="mf">10.0</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mi">10</span><span class="p">),</span><span class="n">basis</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">rand</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">nb_neigh</span><span class="o">=</span><span class="mi">30</span><span class="p">):</span>
    <span class="kn">from</span> <span class="nn">numpy</span> <span class="k">import</span> <span class="n">zeros</span>
    <span class="kn">from</span> <span class="nn">pyflann</span> <span class="k">import</span> <span class="n">FLANN</span>
    <span class="n">knn</span> <span class="o">=</span> <span class="n">FLANN</span><span class="p">()</span>
    <span class="n">params</span> <span class="o">=</span> <span class="n">knn</span><span class="o">.</span><span class="n">build_index</span><span class="p">(</span><span class="n">array</span><span class="p">(</span><span class="n">pos_field</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">float64</span><span class="p">))</span>


    <span class="c1"># Computing the weights</span>
    <span class="n">result</span><span class="p">,</span> <span class="n">dists</span> <span class="o">=</span> <span class="n">knn</span><span class="o">.</span><span class="n">nn_index</span><span class="p">(</span><span class="n">target_pos</span><span class="p">,</span> <span class="n">nb_neigh</span><span class="p">)</span>
    <span class="n">dist</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">nb_neigh</span><span class="p">,</span><span class="n">nb_neigh</span><span class="p">))</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_neigh</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
        <span class="nb">print</span> <span class="s2">&quot;Observation &quot;</span><span class="p">,</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="s2">&quot;/&quot;</span><span class="p">,</span><span class="n">nb_neigh</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">nb_neigh</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">dist</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
                <span class="n">dist</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">],</span><span class="n">sig</span> <span class="o">=</span> <span class="n">sliced_wassertein_dist_interface</span><span class="p">(</span><span class="n">stack</span><span class="p">[:,:,</span><span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">i</span><span class="p">]],</span><span class="n">stack</span><span class="p">[:,:,</span><span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">j</span><span class="p">]],</span><span class="n">param</span><span class="p">,</span><span class="n">nb_iter</span><span class="o">=</span><span class="n">nb_iter</span><span class="p">,</span><span class="n">tol</span><span class="o">=</span><span class="n">tol</span><span class="p">,</span><span class="n">basis</span><span class="o">=</span><span class="n">basis</span><span class="p">,</span><span class="n">rand</span><span class="o">=</span><span class="n">rand</span><span class="p">)</span>
            <span class="n">dist</span><span class="p">[</span><span class="n">j</span><span class="p">,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">dist</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">dist</span>



<span class="k">def</span> <span class="nf">transport_pair_wise_distances</span><span class="p">(</span><span class="n">stack</span><span class="p">,</span><span class="n">pos_field</span><span class="p">,</span><span class="n">target_field</span><span class="p">,</span><span class="n">nb_neigh</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span><span class="n">gap</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">nb_iter</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span><span class="n">tol</span><span class="o">=</span><span class="mf">10.0</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mi">10</span><span class="p">),</span><span class="n">basis</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">rand</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">sliced_dist</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">nb_real</span><span class="o">=</span><span class="mi">10</span><span class="p">):</span>
    <span class="kn">from</span> <span class="nn">optim_utils</span> <span class="k">import</span> <span class="n">max_gap</span>
    <span class="kn">from</span> <span class="nn">numpy</span> <span class="k">import</span> <span class="n">zeros</span><span class="p">,</span><span class="n">arange</span><span class="p">,</span><span class="n">copy</span><span class="p">,</span><span class="n">argsort</span>
    <span class="kn">from</span> <span class="nn">pyflann</span> <span class="k">import</span> <span class="n">FLANN</span>

    <span class="n">knn</span> <span class="o">=</span> <span class="n">FLANN</span><span class="p">()</span>
    <span class="n">params</span> <span class="o">=</span> <span class="n">knn</span><span class="o">.</span><span class="n">build_index</span><span class="p">(</span><span class="n">array</span><span class="p">(</span><span class="n">pos_field</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">float64</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">gap</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">gap</span><span class="p">,</span><span class="n">inear</span><span class="p">,</span><span class="n">jnear</span><span class="p">,</span><span class="n">dist_mat</span> <span class="o">=</span> <span class="n">max_gap</span><span class="p">(</span><span class="n">stack</span><span class="p">,</span><span class="n">pos_field</span><span class="p">,</span><span class="n">tol</span><span class="o">=</span><span class="mf">0.001</span><span class="p">,</span><span class="n">nb_neigh</span><span class="o">=</span><span class="n">nb_neigh</span><span class="p">,</span><span class="n">max_val</span> <span class="o">=</span><span class="mi">2</span><span class="o">**</span><span class="mi">63</span><span class="p">,</span><span class="n">dist_mat</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>

    <span class="n">nb_points</span> <span class="o">=</span> <span class="n">stack</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">nb_val</span> <span class="o">=</span> <span class="n">stack</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">stack</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">sliced_dist</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">sliced_dist</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">nb_points</span><span class="p">,</span><span class="n">nb_points</span><span class="p">))</span>

    <span class="n">nb_targets</span> <span class="o">=</span> <span class="n">target_field</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">neighborhood</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">nb_targets</span><span class="p">,</span><span class="n">nb_neigh</span><span class="p">))</span>
    <span class="n">permutations</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">nb_points</span><span class="p">,</span><span class="n">nb_val</span><span class="p">,</span><span class="n">nb_points</span><span class="p">))</span> <span class="c1"># convention: the lines M[i,:,j] contains a permutation sigma verifying fi approx fj[sigma]</span>
    <span class="n">Id</span> <span class="o">=</span> <span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_points</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_targets</span><span class="p">):</span>
        <span class="nb">print</span> <span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="s2">&quot;th target/&quot;</span><span class="p">,</span><span class="n">nb_targets</span>
        <span class="n">results</span><span class="p">,</span><span class="n">dist</span> <span class="o">=</span> <span class="n">knn</span><span class="o">.</span><span class="n">nn_index</span><span class="p">(</span><span class="n">target_field</span><span class="p">[</span><span class="n">i</span><span class="p">,:],</span> <span class="n">nb_neigh</span><span class="p">)</span>
        <span class="n">neighborhood</span><span class="p">[</span><span class="n">i</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">results</span><span class="p">[</span><span class="mi">0</span><span class="p">,:]</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_neigh</span><span class="p">):</span>
            <span class="nb">print</span> <span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="s2">&quot; neighbor/&quot;</span><span class="p">,</span><span class="n">nb_neigh</span>
            <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">nb_neigh</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">sliced_dist</span><span class="p">[</span><span class="n">results</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">k</span><span class="p">],</span><span class="n">results</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">l</span><span class="p">]]</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
                    <span class="nb">print</span> <span class="s2">&quot;PSFs indices: &quot;</span><span class="p">,</span><span class="n">results</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">k</span><span class="p">],</span><span class="n">results</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">l</span><span class="p">]</span>
                    <span class="n">sliced_dist</span><span class="p">[</span><span class="n">results</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">k</span><span class="p">],</span><span class="n">results</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">l</span><span class="p">]],</span><span class="n">sig</span> <span class="o">=</span> <span class="n">sliced_wassertein_dist_interface</span><span class="p">(</span><span class="n">stack</span><span class="p">[:,:,</span><span class="n">results</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">k</span><span class="p">]],</span><span class="n">stack</span><span class="p">[:,:,</span><span class="n">results</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">l</span><span class="p">]],</span><span class="n">gap</span><span class="p">,</span><span class="n">nb_iter</span><span class="o">=</span><span class="n">nb_iter</span><span class="p">,</span><span class="n">tol</span><span class="o">=</span><span class="n">tol</span><span class="p">,</span><span class="n">basis</span><span class="o">=</span><span class="n">basis</span><span class="p">,</span><span class="n">rand</span><span class="o">=</span><span class="n">rand</span><span class="p">,</span><span class="n">nb_real</span><span class="o">=</span><span class="n">nb_real</span><span class="p">)</span>
                    <span class="n">sliced_dist</span><span class="p">[</span><span class="n">results</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">l</span><span class="p">],</span><span class="n">results</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">k</span><span class="p">]]</span> <span class="o">=</span> <span class="n">sliced_dist</span><span class="p">[</span><span class="n">results</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">k</span><span class="p">],</span><span class="n">results</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">l</span><span class="p">]]</span>
                    <span class="n">permutations</span><span class="p">[</span><span class="n">results</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">k</span><span class="p">],:,</span><span class="n">results</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">l</span><span class="p">]]</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">sig</span><span class="p">)</span>
                    <span class="n">permutations</span><span class="p">[</span><span class="n">results</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">l</span><span class="p">],:,</span><span class="n">results</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">k</span><span class="p">]]</span> <span class="o">=</span> <span class="n">argsort</span><span class="p">(</span><span class="n">sig</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">sliced_dist</span><span class="p">,</span><span class="n">neighborhood</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">),</span><span class="n">permutations</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">local_embedding_bar_coordinates</span><span class="p">(</span><span class="n">dist_mat</span><span class="p">,</span><span class="n">neighborhood</span><span class="p">,</span><span class="n">pos_field</span><span class="p">,</span><span class="n">target_pos</span><span class="p">,</span><span class="n">local_dim</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span><span class="n">nb_neigh_inv_map</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="kn">from</span> <span class="nn">numpy</span> <span class="k">import</span> <span class="n">zeros</span><span class="p">,</span><span class="n">ones</span><span class="p">,</span><span class="n">copy</span><span class="p">,</span><span class="n">transpose</span>
    <span class="kn">from</span> <span class="nn">pyflann</span> <span class="k">import</span> <span class="n">FLANN</span>
    <span class="kn">from</span> <span class="nn">utils</span> <span class="k">import</span> <span class="n">bar_coord2d</span><span class="p">,</span><span class="n">mds</span>
    <span class="kn">from</span> <span class="nn">optim_utils</span> <span class="k">import</span> <span class="n">bar_coord_pb</span>
    <span class="kn">import</span> <span class="nn">time</span>
    <span class="n">knn</span> <span class="o">=</span> <span class="n">FLANN</span><span class="p">()</span>

    <span class="n">nb_neigh</span> <span class="o">=</span> <span class="n">neighborhood</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">nb_points</span> <span class="o">=</span> <span class="n">target_pos</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">nb_neigh_inv_map</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">nb_neigh_inv_map</span> <span class="o">=</span> <span class="n">nb_neigh</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">nb_neigh_inv_map</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">nb_neigh</span><span class="p">,</span><span class="n">nb_neigh_inv_map</span><span class="p">)</span>
    <span class="n">weights</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">nb_points</span><span class="p">,</span><span class="n">nb_neigh_inv_map</span><span class="p">))</span>
    <span class="n">ones_line</span> <span class="o">=</span> <span class="n">ones</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span><span class="n">nb_neigh_inv_map</span><span class="p">))</span>
    <span class="n">loc_eig_val</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">nb_points</span><span class="p">,</span><span class="n">local_dim</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">nb_neigh_inv_map</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">nb_neigh_inv_map</span> <span class="o">=</span> <span class="n">local_dim</span><span class="o">+</span><span class="mi">1</span>

    <span class="n">acc</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">nb_points</span><span class="p">,))</span>
    <span class="n">neighborhood_inv</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">nb_points</span><span class="p">,</span><span class="n">nb_neigh_inv_map</span><span class="p">))</span>
    <span class="n">list_dist</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
    <span class="n">list_dim</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">local_dim</span><span class="o">&gt;=</span><span class="n">nb_neigh_inv_map</span><span class="p">:</span>
        <span class="n">local_dim</span> <span class="o">=</span> <span class="n">nb_neigh_inv_map</span><span class="o">-</span><span class="mi">1</span>

    <span class="n">tmean</span> <span class="o">=</span> <span class="mi">0</span>


    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_points</span><span class="p">):</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="c1"># Calculating local embedded coordinates</span>
        <span class="n">neigh_indices0</span> <span class="o">=</span> <span class="p">((</span><span class="n">neighborhood</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">0</span><span class="p">:</span><span class="n">nb_neigh_inv_map</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">nb_neigh_inv_map</span><span class="p">,</span><span class="mi">1</span><span class="p">)))</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">ones_line</span><span class="p">))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
        <span class="n">dist_i</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">dist_mat</span><span class="p">[</span><span class="n">neigh_indices0</span><span class="p">,</span><span class="n">transpose</span><span class="p">(</span><span class="n">neigh_indices0</span><span class="p">)])</span>
        <span class="c1">#print &quot;max dist check: &quot;,dist_i.max(),&quot; Number non zeros: &quot;,size(where(dist_mat[i,:]&gt;0)[0])</span>
        <span class="n">loc_coord_i</span><span class="p">,</span><span class="n">w</span> <span class="o">=</span> <span class="n">mds</span><span class="p">(</span><span class="n">dist_i</span><span class="p">,</span><span class="n">nb_components</span> <span class="o">=</span> <span class="n">local_dim</span><span class="p">)</span> <span class="c1"># Embedded coordiantes are in loc_coord_i lines</span>
        <span class="n">list_dim</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">w</span><span class="p">)</span>
        <span class="c1"># Interpolating at the target position according to the target coodiantes</span>
        <span class="n">loc_coord_interp</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">local_dim</span><span class="p">,))</span>
        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">local_dim</span><span class="p">):</span>
            <span class="n">rbfp</span> <span class="o">=</span> <span class="n">Rbf</span><span class="p">(</span><span class="n">pos_field</span><span class="p">[</span><span class="n">neighborhood</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_neigh_inv_map</span><span class="p">)],</span><span class="mi">0</span><span class="p">],</span> <span class="n">pos_field</span><span class="p">[</span><span class="n">neighborhood</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_neigh_inv_map</span><span class="p">)],</span><span class="mi">1</span><span class="p">],</span> <span class="n">loc_coord_i</span><span class="p">[:,</span><span class="n">p</span><span class="p">],</span> <span class="n">function</span><span class="o">=</span><span class="s1">&#39;thin_plate&#39;</span><span class="p">)</span>
            <span class="n">loc_coord_interp</span><span class="p">[</span><span class="n">p</span><span class="p">]</span> <span class="o">=</span> <span class="n">rbfp</span><span class="p">(</span><span class="n">target_pos</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span><span class="n">target_pos</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">1</span><span class="p">])</span>
        <span class="c1"># Calculating barycentric coordinates</span>
        <span class="c1">#params = knn.build_index(array(loc_coord_i, dtype=float64))</span>

        <span class="c1">#results,dist = knn.nn_index(loc_coord_interp, nb_neigh_inv_map)</span>
        <span class="c1">#list_dist.append(dist)</span>
        <span class="n">neighborhood_inv</span><span class="p">[</span><span class="n">i</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">neighborhood</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_neigh_inv_map</span><span class="p">)])</span>
        <span class="c1">#wi,acc[i] = bar_coord2d(transpose(loc_coord_i[results[0,:],:]),loc_coord_interp.reshape((local_dim,1)),cond=1./50,acc=True)</span>
        <span class="n">wi</span><span class="p">,</span><span class="n">acc</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">bar_coord_pb</span><span class="p">(</span><span class="n">transpose</span><span class="p">(</span><span class="n">loc_coord_i</span><span class="p">),</span><span class="n">loc_coord_interp</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">local_dim</span><span class="p">,</span><span class="mi">1</span><span class="p">)),</span><span class="mi">300</span><span class="p">)</span>
        <span class="nb">print</span> <span class="s2">&quot;Percentage of accuracy: &quot;</span><span class="p">,</span><span class="n">acc</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">weights</span><span class="p">[</span><span class="n">i</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">wi</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">nb_neigh_inv_map</span><span class="p">,))</span>
        <span class="n">tmean</span> <span class="o">+=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="o">-</span><span class="n">t</span>

    <span class="nb">print</span> <span class="s2">&quot;Elapsed time&quot;</span><span class="p">,</span> <span class="n">tmean</span><span class="o">/</span><span class="n">nb_points</span>
    <span class="k">return</span> <span class="n">weights</span><span class="p">,</span><span class="n">acc</span><span class="p">,</span><span class="n">neighborhood_inv</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span><span class="c1">#,list_dist,list_dim</span>



<span class="k">def</span> <span class="nf">neighborhood_analysis</span><span class="p">(</span><span class="n">dist_mat</span><span class="p">,</span><span class="n">intrinsic_dim</span><span class="p">,</span><span class="n">target_pos</span><span class="p">,</span><span class="n">pos_field</span><span class="p">,</span><span class="n">max_size</span><span class="o">=</span><span class="mi">40</span><span class="p">,</span><span class="n">tol</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">dim_max</span> <span class="o">=</span> <span class="mi">20</span><span class="p">,</span><span class="n">n</span><span class="o">=</span><span class="mi">3</span><span class="p">):</span>
    <span class="kn">from</span> <span class="nn">numpy</span> <span class="k">import</span> <span class="n">ones</span><span class="p">,</span><span class="n">transpose</span><span class="p">,</span><span class="n">array</span><span class="p">,</span><span class="n">argsort</span><span class="p">,</span><span class="n">arange</span>
    <span class="kn">from</span> <span class="nn">utils</span> <span class="k">import</span> <span class="n">mds</span>
    <span class="kn">from</span> <span class="nn">pyflann</span> <span class="k">import</span> <span class="n">FLANN</span>
    <span class="kn">from</span> <span class="nn">numpy.polynomial.polynomial</span> <span class="k">import</span> <span class="n">polyfit</span><span class="p">,</span><span class="n">polyval</span>


    <span class="n">knn</span> <span class="o">=</span> <span class="n">FLANN</span><span class="p">()</span>
    <span class="n">params</span> <span class="o">=</span> <span class="n">knn</span><span class="o">.</span><span class="n">build_index</span><span class="p">(</span><span class="n">array</span><span class="p">(</span><span class="n">pos_field</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">float64</span><span class="p">))</span>

    <span class="n">neighborhood</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
    <span class="n">embeddings</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
    <span class="n">eig_val_r</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
    <span class="n">obs_dist</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>


    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">target_pos</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
        <span class="n">nb_neigh</span> <span class="o">=</span> <span class="n">intrinsic_dim</span><span class="o">+</span><span class="mi">3</span>
        <span class="n">eig_r</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">eig_val_ri</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="n">obs_dist_i</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="n">loc_coord_i</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">results</span><span class="p">,</span><span class="n">dist</span> <span class="o">=</span> <span class="n">knn</span><span class="o">.</span><span class="n">nn_index</span><span class="p">(</span><span class="n">target_pos</span><span class="p">[</span><span class="n">i</span><span class="p">,:],</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">nb_neigh</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">intrinsic_dim</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">max_size</span><span class="p">):</span>
            <span class="n">ones_line</span> <span class="o">=</span> <span class="n">ones</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span><span class="n">nb_neigh</span><span class="p">))</span>
            <span class="n">ind_neigh</span> <span class="o">=</span> <span class="p">((</span><span class="n">argsort</span><span class="p">(</span><span class="n">dist_mat</span><span class="p">[</span><span class="n">results</span><span class="p">[</span><span class="mi">0</span><span class="p">],:])[</span><span class="mi">0</span><span class="p">:</span><span class="n">nb_neigh</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">nb_neigh</span><span class="p">,</span><span class="mi">1</span><span class="p">)))</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">ones_line</span><span class="p">))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
            <span class="n">dist_loc</span> <span class="o">=</span> <span class="n">dist_mat</span><span class="p">[</span><span class="n">ind_neigh</span><span class="p">,</span><span class="n">transpose</span><span class="p">(</span><span class="n">ind_neigh</span><span class="p">)]</span>
            <span class="n">loc_coord_i</span><span class="p">,</span><span class="n">w</span> <span class="o">=</span> <span class="n">mds</span><span class="p">(</span><span class="n">dist_loc</span><span class="p">,</span><span class="n">nb_components</span> <span class="o">=</span> <span class="n">dim_max</span><span class="p">)</span>
            <span class="n">obs_dist_i</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dist_loc</span><span class="o">.</span><span class="n">max</span><span class="p">())</span>
            <span class="n">eig_val_ri</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="n">w</span><span class="p">[</span><span class="mi">2</span><span class="p">:]))</span>
            <span class="n">nb_neigh</span><span class="o">+=</span><span class="mi">1</span>
        <span class="n">eig_val_r</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">array</span><span class="p">(</span><span class="n">eig_val_ri</span><span class="p">))</span>
        <span class="n">obs_dist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">array</span><span class="p">(</span><span class="n">obs_dist_i</span><span class="p">))</span>

    <span class="n">r</span> <span class="o">=</span> <span class="n">array</span><span class="p">(</span><span class="n">obs_dist</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">size</span><span class="p">(</span><span class="n">array</span><span class="p">(</span><span class="n">obs_dist</span><span class="p">)),))</span>
    <span class="n">eig_fit</span> <span class="o">=</span> <span class="n">array</span><span class="p">(</span><span class="n">eig_val_r</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">size</span><span class="p">(</span><span class="n">array</span><span class="p">(</span><span class="n">eig_val_r</span><span class="p">)),))</span>
    <span class="n">a</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">eig_fit</span><span class="o">*</span><span class="n">r</span><span class="o">**</span><span class="n">n</span><span class="p">)</span><span class="o">/</span><span class="nb">sum</span><span class="p">(</span><span class="n">r</span><span class="o">**</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">n</span><span class="p">))</span>

    <span class="n">fit_val</span> <span class="o">=</span> <span class="n">a</span><span class="o">*</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">*</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">max_size</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">max_size</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span><span class="o">**</span><span class="n">n</span>

    <span class="k">return</span> <span class="n">eig_val_r</span><span class="p">,</span><span class="n">obs_dist</span><span class="p">,</span><span class="n">fit_val</span><span class="p">,</span><span class="n">array</span><span class="p">(</span><span class="n">obs_dist</span><span class="p">)</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">*</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">max_size</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">max_size</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span><span class="n">a</span>

<span class="k">def</span> <span class="nf">neighborhood_analysis_2</span><span class="p">(</span><span class="n">pos_target</span><span class="p">,</span><span class="n">pos_ref</span><span class="p">,</span><span class="n">nb_neigh</span><span class="p">):</span>
    <span class="kn">from</span> <span class="nn">numpy</span> <span class="k">import</span> <span class="n">zeros</span><span class="p">,</span><span class="n">ones</span>
    <span class="kn">from</span> <span class="nn">numpy.linalg</span> <span class="k">import</span> <span class="n">norm</span>
    <span class="kn">from</span> <span class="nn">pyflann</span> <span class="k">import</span> <span class="n">FLANN</span>

    <span class="n">knn</span> <span class="o">=</span> <span class="n">FLANN</span><span class="p">()</span>
    <span class="n">params</span> <span class="o">=</span> <span class="n">knn</span><span class="o">.</span><span class="n">build_index</span><span class="p">(</span><span class="n">array</span><span class="p">(</span><span class="n">pos_ref</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">float64</span><span class="p">))</span>
    <span class="n">results</span><span class="p">,</span><span class="n">dist</span> <span class="o">=</span> <span class="n">knn</span><span class="o">.</span><span class="n">nn_index</span><span class="p">(</span><span class="n">pos_target</span><span class="p">,</span><span class="n">nb_neigh</span><span class="p">)</span>
    <span class="n">shap</span> <span class="o">=</span> <span class="n">pos_target</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">mean_dist</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">],))</span>
    <span class="n">neigh_compactness</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">],))</span>
    <span class="n">ones_vect</span> <span class="o">=</span> <span class="n">ones</span><span class="p">((</span><span class="n">nb_neigh</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
        <span class="n">bar</span> <span class="o">=</span> <span class="n">pos_ref</span><span class="p">[</span><span class="n">results</span><span class="p">[</span><span class="n">i</span><span class="p">,:],:]</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">mean_dist</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">mean</span><span class="p">(</span><span class="n">norm</span><span class="p">(</span><span class="n">ones_vect</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">bar</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">])))</span><span class="o">-</span><span class="n">pos_ref</span><span class="p">[</span><span class="n">results</span><span class="p">[</span><span class="n">i</span><span class="p">,:],:],</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>

        <span class="n">neigh_compactness</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">norm</span><span class="p">(</span><span class="n">bar</span><span class="o">-</span><span class="n">pos_target</span><span class="p">[</span><span class="n">i</span><span class="p">,:])</span><span class="o">/</span><span class="n">mean_dist</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">mean_dist</span><span class="p">,</span><span class="n">neigh_compactness</span>

<span class="k">def</span> <span class="nf">neighborhood_analysis_3</span><span class="p">(</span><span class="n">pos_target</span><span class="p">,</span><span class="n">pos_ref</span><span class="p">,</span><span class="n">nb_neigh</span><span class="p">):</span>
    <span class="kn">from</span> <span class="nn">numpy</span> <span class="k">import</span> <span class="n">zeros</span><span class="p">,</span><span class="n">ones</span><span class="p">,</span><span class="n">pi</span><span class="p">,</span><span class="n">arange</span><span class="p">,</span><span class="n">sort</span>
    <span class="kn">from</span> <span class="nn">numpy.linalg</span> <span class="k">import</span> <span class="n">norm</span>
    <span class="kn">from</span> <span class="nn">pyflann</span> <span class="k">import</span> <span class="n">FLANN</span>
    <span class="kn">from</span> <span class="nn">utils</span> <span class="k">import</span> <span class="n">polar_coord</span>

    <span class="n">knn</span> <span class="o">=</span> <span class="n">FLANN</span><span class="p">()</span>
    <span class="n">params</span> <span class="o">=</span> <span class="n">knn</span><span class="o">.</span><span class="n">build_index</span><span class="p">(</span><span class="n">array</span><span class="p">(</span><span class="n">pos_ref</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">float64</span><span class="p">))</span>
    <span class="n">results</span><span class="p">,</span><span class="n">dist</span> <span class="o">=</span> <span class="n">knn</span><span class="o">.</span><span class="n">nn_index</span><span class="p">(</span><span class="n">pos_target</span><span class="p">,</span><span class="n">nb_neigh</span><span class="p">)</span>
    <span class="n">shap</span> <span class="o">=</span> <span class="n">pos_target</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">mean_dist</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">],))</span>
    <span class="n">neigh_isotropy</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">],))</span>
    <span class="n">ones_vect</span> <span class="o">=</span> <span class="n">ones</span><span class="p">((</span><span class="n">nb_neigh</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>
    <span class="n">angle_vect</span> <span class="o">=</span> <span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">pi</span><span class="p">)</span><span class="o">*</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_neigh</span><span class="p">)</span><span class="o">/</span><span class="n">nb_neigh</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
        <span class="n">bar</span> <span class="o">=</span> <span class="n">pos_ref</span><span class="p">[</span><span class="n">results</span><span class="p">[</span><span class="n">i</span><span class="p">,:],:]</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">mean_dist</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">mean</span><span class="p">(</span><span class="n">norm</span><span class="p">(</span><span class="n">ones_vect</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">bar</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">])))</span><span class="o">-</span><span class="n">pos_ref</span><span class="p">[</span><span class="n">results</span><span class="p">[</span><span class="n">i</span><span class="p">,:],:],</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
        <span class="n">ang</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">nb_neigh</span><span class="p">,))</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_neigh</span><span class="p">):</span>
            <span class="n">r</span><span class="p">,</span><span class="n">ang</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">polar_coord</span><span class="p">(</span><span class="n">pos_ref</span><span class="p">[</span><span class="n">results</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">],:],</span><span class="n">pos_target</span><span class="p">[</span><span class="n">i</span><span class="p">,:])</span>

        <span class="n">neigh_isotropy</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">norm</span><span class="p">(</span><span class="n">angle_vect</span><span class="o">-</span><span class="n">sort</span><span class="p">(</span><span class="n">ang</span><span class="p">))</span><span class="o">/</span><span class="n">nb_neigh</span>

    <span class="k">return</span> <span class="n">mean_dist</span><span class="p">,</span><span class="n">neigh_isotropy</span>


<span class="k">def</span> <span class="nf">neighborhood_analysis_4</span><span class="p">(</span><span class="n">pos_target</span><span class="p">,</span><span class="n">pos_ref</span><span class="p">,</span><span class="n">nb_neigh</span><span class="p">,</span><span class="n">coherence_mat</span><span class="p">):</span>
    <span class="kn">from</span> <span class="nn">numpy</span> <span class="k">import</span> <span class="n">zeros</span><span class="p">,</span><span class="n">ones</span><span class="p">,</span><span class="n">pi</span><span class="p">,</span><span class="n">arange</span><span class="p">,</span><span class="n">sort</span><span class="p">,</span><span class="n">transpose</span>
    <span class="kn">from</span> <span class="nn">numpy.linalg</span> <span class="k">import</span> <span class="n">norm</span>
    <span class="kn">from</span> <span class="nn">pyflann</span> <span class="k">import</span> <span class="n">FLANN</span>
    <span class="kn">from</span> <span class="nn">utils</span> <span class="k">import</span> <span class="n">polar_coord</span>

    <span class="n">knn</span> <span class="o">=</span> <span class="n">FLANN</span><span class="p">()</span>
    <span class="n">params</span> <span class="o">=</span> <span class="n">knn</span><span class="o">.</span><span class="n">build_index</span><span class="p">(</span><span class="n">array</span><span class="p">(</span><span class="n">pos_ref</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">float64</span><span class="p">))</span>
    <span class="n">results</span><span class="p">,</span><span class="n">dist</span> <span class="o">=</span> <span class="n">knn</span><span class="o">.</span><span class="n">nn_index</span><span class="p">(</span><span class="n">pos_target</span><span class="p">,</span><span class="n">nb_neigh</span><span class="p">)</span>
    <span class="n">shap</span> <span class="o">=</span> <span class="n">pos_target</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">mean_dist</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">],))</span>
    <span class="n">neigh_coherence</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">],))</span>
    <span class="n">ones_vect</span> <span class="o">=</span> <span class="n">ones</span><span class="p">((</span><span class="n">nb_neigh</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>
    <span class="n">angle_vect</span> <span class="o">=</span> <span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">pi</span><span class="p">)</span><span class="o">*</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_neigh</span><span class="p">)</span><span class="o">/</span><span class="n">nb_neigh</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
        <span class="n">bar</span> <span class="o">=</span> <span class="n">pos_ref</span><span class="p">[</span><span class="n">results</span><span class="p">[</span><span class="n">i</span><span class="p">,:],:]</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">mean_dist</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">mean</span><span class="p">(</span><span class="n">norm</span><span class="p">(</span><span class="n">ones_vect</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">bar</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">])))</span><span class="o">-</span><span class="n">pos_ref</span><span class="p">[</span><span class="n">results</span><span class="p">[</span><span class="n">i</span><span class="p">,:],:],</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
        <span class="n">ind</span> <span class="o">=</span> <span class="n">ones_vect</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">results</span><span class="p">[</span><span class="n">i</span><span class="p">,:]</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span><span class="n">nb_neigh</span><span class="p">)))</span>
        <span class="n">ind</span> <span class="o">=</span> <span class="n">ind</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
        <span class="n">neigh_coherence</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">coherence_mat</span><span class="p">[</span><span class="n">ind</span><span class="p">,</span><span class="n">transpose</span><span class="p">(</span><span class="n">ind</span><span class="p">)]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">mean_dist</span><span class="p">,</span><span class="n">neigh_coherence</span>



<span class="k">def</span> <span class="nf">param_dispersion</span><span class="p">(</span><span class="n">ell</span><span class="p">,</span><span class="n">dist_map</span><span class="p">):</span>
    <span class="kn">from</span> <span class="nn">numpy</span> <span class="k">import</span> <span class="n">zeros</span><span class="p">,</span><span class="n">argsort</span>

    <span class="n">nb_neigh</span> <span class="o">=</span> <span class="n">ell</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="n">disp_map</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">nb_neigh</span><span class="p">,</span><span class="n">nb_neigh</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_neigh</span><span class="p">):</span>
        <span class="n">ind_i</span> <span class="o">=</span> <span class="n">argsort</span><span class="p">(</span><span class="n">dist_map</span><span class="p">[</span><span class="n">i</span><span class="p">,:])</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">nb_neigh</span><span class="p">):</span>
            <span class="n">disp_map</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">ell</span><span class="p">[</span><span class="n">ind_i</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">j</span><span class="p">],:]</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">disp_map</span>



<span class="k">def</span> <span class="nf">local_sliced_transport_bar_interface_2</span><span class="p">(</span><span class="n">stack</span><span class="p">,</span><span class="n">gap</span><span class="p">,</span><span class="n">dist_mat</span><span class="p">,</span><span class="n">neighborhood</span><span class="p">,</span><span class="n">pos_ref</span><span class="p">,</span><span class="n">target_ref</span><span class="p">,</span><span class="n">nb_iter</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span><span class="n">local_dim</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span><span class="n">nb_neigh_inv_map</span><span class="o">=</span><span class="mi">11</span><span class="p">,</span><span class="n">output_path</span><span class="o">=</span><span class="s1">&#39;../../../Data/Result_interp/&#39;</span><span class="p">,</span><span class="nb">id</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">return_all</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">cent</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">theta_en</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>

    <span class="n">weights</span><span class="p">,</span><span class="n">acc</span><span class="p">,</span><span class="n">neighborhood_inv</span> <span class="o">=</span> <span class="n">local_embedding_bar_coordinates</span><span class="p">(</span><span class="n">dist_mat</span><span class="p">,</span><span class="n">neighborhood</span><span class="p">,</span><span class="n">pos_ref</span><span class="p">,</span><span class="n">target_ref</span><span class="p">,</span><span class="n">local_dim</span><span class="o">=</span><span class="n">local_dim</span><span class="p">,</span><span class="n">nb_neigh_inv_map</span><span class="o">=</span><span class="n">nb_neigh_inv_map</span><span class="p">)</span>
    <span class="n">psf_interp_local_wass</span><span class="p">,</span><span class="n">sig</span> <span class="o">=</span> <span class="n">local_sliced_transport_bar_interface</span><span class="p">(</span><span class="n">stack</span><span class="p">,</span><span class="n">gap</span><span class="p">,</span><span class="n">neighborhood_inv</span><span class="p">,</span><span class="n">weights</span><span class="p">,</span><span class="n">nb_iter</span><span class="o">=</span><span class="n">nb_iter</span><span class="p">,</span><span class="n">tol</span><span class="o">=</span><span class="mf">10.0</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mi">20</span><span class="p">),</span><span class="n">single_dir</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">output_path</span><span class="o">=</span><span class="n">output_path</span><span class="p">,</span><span class="n">save_file_en</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span><span class="nb">id</span><span class="o">=</span><span class="nb">id</span><span class="p">,</span><span class="n">cent</span><span class="o">=</span><span class="n">cent</span><span class="p">,</span><span class="n">theta_en</span><span class="o">=</span><span class="n">theta_en</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">psf_interp_local_wass</span>

<span class="k">def</span> <span class="nf">euclidian_interp</span><span class="p">(</span><span class="n">stack</span><span class="p">,</span><span class="n">neighborhood_inv</span><span class="p">,</span><span class="n">weights</span><span class="p">):</span>
    <span class="kn">from</span> <span class="nn">numpy</span> <span class="k">import</span> <span class="n">zeros</span><span class="p">,</span><span class="n">diag</span>
    <span class="kn">from</span> <span class="nn">utils</span> <span class="k">import</span> <span class="n">cube_to_mat</span><span class="p">,</span><span class="n">mat_to_cube</span><span class="p">,</span><span class="n">transpose</span>

    <span class="n">shap</span> <span class="o">=</span> <span class="n">stack</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">interp</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">weights</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">weights</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
        <span class="n">interp</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">transpose</span><span class="p">(</span><span class="n">cube_to_mat</span><span class="p">(</span><span class="n">stack</span><span class="p">[:,:,</span><span class="n">neighborhood_inv</span><span class="p">[</span><span class="n">i</span><span class="p">,:]]))</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">weights</span><span class="p">[</span><span class="n">i</span><span class="p">,:]</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">weights</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="mi">1</span><span class="p">))))</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
    <span class="k">return</span> <span class="n">interp</span>

<span class="k">def</span> <span class="nf">local_euclidean_bar</span><span class="p">(</span><span class="n">stack</span><span class="p">,</span><span class="n">dist_mat</span><span class="p">,</span><span class="n">neighborhood</span><span class="p">,</span><span class="n">pos_ref</span><span class="p">,</span><span class="n">target_ref</span><span class="p">,</span><span class="n">local_dim</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span><span class="n">nb_neigh_inv_map</span><span class="o">=</span><span class="mi">11</span><span class="p">):</span>

    <span class="n">weights</span><span class="p">,</span><span class="n">acc</span><span class="p">,</span><span class="n">neighborhood_inv</span> <span class="o">=</span> <span class="n">local_embedding_bar_coordinates</span><span class="p">(</span><span class="n">dist_mat</span><span class="p">,</span><span class="n">neighborhood</span><span class="p">,</span><span class="n">pos_ref</span><span class="p">,</span><span class="n">target_ref</span><span class="p">,</span><span class="n">local_dim</span><span class="o">=</span><span class="n">local_dim</span><span class="p">,</span><span class="n">nb_neigh_inv_map</span><span class="o">=</span><span class="n">nb_neigh_inv_map</span><span class="p">)</span>
    <span class="n">psf_interp_local_euc</span> <span class="o">=</span> <span class="n">euclidian_interp</span><span class="p">(</span><span class="n">stack</span><span class="p">,</span><span class="n">neighborhood_inv</span><span class="p">,</span><span class="n">weights</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">psf_interp_local_euc</span>

<span class="k">def</span> <span class="nf">local_sliced_transport_bar_interface</span><span class="p">(</span><span class="n">stack</span><span class="p">,</span><span class="n">gap</span><span class="p">,</span><span class="n">neighborhood</span><span class="p">,</span><span class="n">weights</span><span class="p">,</span><span class="n">nb_iter</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span><span class="n">tol</span><span class="o">=</span><span class="mf">10.0</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mi">20</span><span class="p">),</span><span class="n">single_dir</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">output_path</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="n">save_file_en</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span><span class="n">rad</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span><span class="nb">id</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="n">cent</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">theta_en</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="kn">from</span> <span class="nn">numpy</span> <span class="k">import</span> <span class="n">zeros</span><span class="p">,</span><span class="n">copy</span><span class="p">,</span><span class="n">squeeze</span>
    <span class="kn">from</span> <span class="nn">optim_utils</span> <span class="k">import</span> <span class="n">sliced_transport_bar</span><span class="p">,</span><span class="n">sliced_transport_ptbar</span><span class="p">,</span><span class="n">setting_polar_2</span><span class="p">,</span><span class="n">setting_cart_from_polar_2</span>
    <span class="kn">from</span> <span class="nn">astropy.io</span> <span class="k">import</span> <span class="n">fits</span>
    <span class="kn">from</span> <span class="nn">utils</span> <span class="k">import</span> <span class="n">compute_centroid</span>
    <span class="kn">import</span> <span class="nn">time</span>
    <span class="n">pt_clouds</span> <span class="o">=</span> <span class="n">cube_to_point_cloud</span><span class="p">(</span><span class="n">stack</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">theta_en</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">cent</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">im_mean</span> <span class="o">=</span> <span class="n">stack</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
            <span class="n">cent</span><span class="p">,</span><span class="n">w</span> <span class="o">=</span> <span class="n">compute_centroid</span><span class="p">(</span><span class="n">im_mean</span><span class="p">,</span><span class="n">sigw</span><span class="o">=</span><span class="mi">100000000</span><span class="p">)</span>
            <span class="n">cent</span> <span class="o">=</span> <span class="n">squeeze</span><span class="p">(</span><span class="n">cent</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">pt_clouds</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
            <span class="n">pt_clouds</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">,:,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">setting_polar_2</span><span class="p">(</span><span class="n">pt_clouds</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">,:,</span><span class="n">i</span><span class="p">],</span><span class="n">gap</span><span class="p">,</span><span class="n">cent</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">pt_clouds</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">,:,:]</span><span class="o">*=</span><span class="n">gap</span>
    <span class="n">nb_points</span> <span class="o">=</span> <span class="n">weights</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">shap</span> <span class="o">=</span> <span class="n">stack</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">psf_interp</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">nb_points</span><span class="p">))</span>
    <span class="n">sig</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
    <span class="n">tmean</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_points</span><span class="p">):</span>
        <span class="nb">print</span> <span class="s2">&quot;Target &quot;</span><span class="p">,</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="s2">&quot;/&quot;</span><span class="p">,</span><span class="n">nb_points</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">w</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">weights</span><span class="p">[</span><span class="n">i</span><span class="p">,:])</span>
        <span class="k">if</span> <span class="n">w</span><span class="o">.</span><span class="n">min</span><span class="p">()</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">:</span>
            <span class="n">ind</span> <span class="o">=</span> <span class="n">where</span><span class="p">(</span><span class="n">w</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">w</span><span class="p">[</span><span class="n">ind</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">w</span><span class="o">/=</span><span class="n">w</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="n">ind</span> <span class="o">=</span> <span class="n">where</span><span class="p">(</span><span class="n">w</span><span class="o">==</span><span class="n">w</span><span class="o">.</span><span class="n">max</span><span class="p">())</span>
        <span class="c1">#bar,basis,sig_out = sliced_transport_bar(pt_clouds[:,:,neighborhood[i,:]],w,nb_iter=nb_iter,tol=tol,alph=0.01,bar_init=pt_clouds[:,:,neighborhood[i,ind[0][0]]],rand_en=True,basis=None,adapted_basis=False,pos_en=False,min_basis=False,support=False,assign_out=True,single_dir=single_dir)</span>
        <span class="n">bar</span> <span class="o">=</span> <span class="n">sliced_transport_ptbar</span><span class="p">(</span><span class="n">pt_clouds</span><span class="p">[:,:,</span><span class="n">neighborhood</span><span class="p">[</span><span class="n">i</span><span class="p">,:]],</span><span class="n">w</span><span class="p">,</span><span class="n">nb_iter</span><span class="o">=</span><span class="n">nb_iter</span><span class="p">,</span><span class="n">tol</span><span class="o">=</span><span class="n">tol</span><span class="p">,</span><span class="n">alph</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span><span class="n">bar_init</span><span class="o">=</span><span class="n">pt_clouds</span><span class="p">[:,:,</span><span class="n">neighborhood</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">ind</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]]],</span><span class="n">rand_en</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">basis</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">adapted_basis</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">pos_en</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">min_basis</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">support</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">assign_out</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">single_dir</span><span class="o">=</span><span class="n">single_dir</span><span class="p">,</span><span class="n">shap</span><span class="o">=</span><span class="n">shap</span><span class="p">,</span><span class="n">gap</span><span class="o">=</span><span class="n">gap</span><span class="p">,</span><span class="n">rad</span><span class="o">=</span><span class="n">rad</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">theta_en</span><span class="p">:</span>
            <span class="n">bar</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">setting_cart_from_polar_2</span><span class="p">(</span><span class="n">bar</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">,:],</span><span class="n">gap</span><span class="p">,</span><span class="n">cent</span><span class="p">,</span><span class="n">max_dist</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">bar</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">,:]</span><span class="o">/=</span><span class="n">gap</span>
        <span class="c1">#sig.append(sig_out)</span>
        <span class="n">psf_interp</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">bar_1d_2d_bis</span><span class="p">(</span><span class="n">bar</span><span class="p">,</span><span class="n">shap</span><span class="p">,[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span><span class="n">pol_en</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">log_param</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">tol</span><span class="o">=</span><span class="mf">10.0</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mi">15</span><span class="p">))</span>
        <span class="nb">print</span> <span class="s2">&quot;elapsed time: &quot;</span><span class="p">,</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="o">-</span><span class="n">t</span>
        <span class="k">if</span> <span class="n">save_file_en</span><span class="p">:</span>
            <span class="n">fits</span><span class="o">.</span><span class="n">writeto</span><span class="p">(</span><span class="n">output_path</span><span class="o">+</span><span class="s1">&#39;psf_&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">+</span><span class="nb">id</span><span class="o">+</span><span class="s1">&#39;.fits&#39;</span><span class="p">,</span><span class="n">psf_interp</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">])</span>

    <span class="k">return</span> <span class="n">psf_interp</span><span class="p">,</span><span class="n">sig</span>

<span class="k">def</span> <span class="nf">get_data</span><span class="p">(</span><span class="n">output_path</span><span class="p">,</span><span class="n">shap</span><span class="p">,</span><span class="n">ids</span><span class="p">,</span><span class="n">nb_points</span><span class="p">):</span>
    <span class="kn">from</span> <span class="nn">numpy</span> <span class="k">import</span> <span class="n">zeros</span>
    <span class="kn">from</span> <span class="nn">astropy.io</span> <span class="k">import</span> <span class="n">fits</span>
    <span class="n">output</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
    <span class="n">nb_samp</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">ids</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_samp</span><span class="p">):</span>
        <span class="n">nb_reals</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">ids</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>
        <span class="n">im</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">nb_points</span><span class="p">,</span><span class="n">nb_reals</span><span class="p">))</span>
        <span class="nb">print</span> <span class="s2">&quot;samp &quot;</span><span class="p">,</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="s2">&quot;/&quot;</span><span class="p">,</span><span class="n">nb_samp</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_reals</span><span class="p">):</span>
            <span class="nb">print</span> <span class="s2">&quot;real &quot;</span><span class="p">,</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="s2">&quot;/&quot;</span><span class="p">,</span><span class="n">nb_reals</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_points</span><span class="p">):</span>
                <span class="n">im</span><span class="p">[:,:,</span><span class="n">k</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">getdata</span><span class="p">(</span><span class="n">output_path</span><span class="o">+</span><span class="s1">&#39;psf_&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">k</span><span class="p">)</span><span class="o">+</span><span class="n">ids</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;.fits&#39;</span><span class="p">)</span>
        <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">im</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">output</span>


<span class="k">def</span> <span class="nf">sliced_transport_bar_interface</span><span class="p">(</span><span class="n">stack</span><span class="p">,</span><span class="n">gap</span><span class="p">,</span><span class="n">weights</span><span class="p">,</span><span class="n">nb_iter</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span><span class="n">tol</span><span class="o">=</span><span class="mf">10.0</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mi">10</span><span class="p">),</span><span class="n">pt_en</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">nb_real</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">rad</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span><span class="n">smart_init_en</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">theta_en</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">cent</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">max_dist</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="kn">from</span> <span class="nn">numpy</span> <span class="k">import</span> <span class="n">zeros</span><span class="p">,</span><span class="n">copy</span>
    <span class="kn">from</span> <span class="nn">optim_utils</span> <span class="k">import</span> <span class="n">sliced_transport_bar</span><span class="p">,</span><span class="n">sliced_transport_ptbar</span><span class="p">,</span><span class="n">setting_polar_2</span><span class="p">,</span><span class="n">setting_cart_from_polar_2</span>

    <span class="n">pt_clouds</span> <span class="o">=</span> <span class="n">cube_to_point_cloud</span><span class="p">(</span><span class="n">stack</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">theta_en</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">pt_clouds</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
            <span class="n">pt_clouds</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">,:,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">setting_polar_2</span><span class="p">(</span><span class="n">pt_clouds</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">,:,</span><span class="n">i</span><span class="p">],</span><span class="n">gap</span><span class="p">,</span><span class="n">cent</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">pt_clouds</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">,:,:]</span><span class="o">*=</span><span class="n">gap</span>
    <span class="n">shap</span> <span class="o">=</span> <span class="n">stack</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">i</span> <span class="o">=</span> <span class="n">where</span><span class="p">(</span><span class="n">weights</span><span class="o">==</span><span class="n">weights</span><span class="o">.</span><span class="n">max</span><span class="p">())</span>
    <span class="n">bar</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">pt_en</span><span class="p">:</span>
        <span class="n">bar</span> <span class="o">=</span> <span class="n">sliced_transport_ptbar</span><span class="p">(</span><span class="n">pt_clouds</span><span class="p">,</span><span class="n">weights</span><span class="p">,</span><span class="n">nb_iter</span><span class="o">=</span><span class="n">nb_iter</span><span class="p">,</span><span class="n">tol</span><span class="o">=</span><span class="n">tol</span><span class="p">,</span><span class="n">alph</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span><span class="n">bar_init</span><span class="o">=</span><span class="n">pt_clouds</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]],</span><span class="n">rand_en</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">basis</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">adapted_basis</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">pos_en</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">min_basis</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">support</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">assign_out</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">nb_real</span><span class="o">=</span><span class="n">nb_real</span><span class="p">,</span><span class="n">shap</span><span class="o">=</span><span class="n">shap</span><span class="p">,</span><span class="n">gap</span><span class="o">=</span><span class="n">gap</span><span class="p">,</span><span class="n">rad</span><span class="o">=</span><span class="n">rad</span><span class="p">,</span><span class="n">smart_init_en</span><span class="o">=</span><span class="n">smart_init_en</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">bar</span><span class="p">,</span><span class="n">basis</span><span class="p">,</span><span class="n">sig_out</span> <span class="o">=</span> <span class="n">sliced_transport_bar</span><span class="p">(</span><span class="n">pt_clouds</span><span class="p">,</span><span class="n">weights</span><span class="p">,</span><span class="n">nb_iter</span><span class="o">=</span><span class="n">nb_iter</span><span class="p">,</span><span class="n">tol</span><span class="o">=</span><span class="n">tol</span><span class="p">,</span><span class="n">alph</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span><span class="n">bar_init</span><span class="o">=</span><span class="n">pt_clouds</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]],</span><span class="n">rand_en</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">basis</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">adapted_basis</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">pos_en</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">min_basis</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">support</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">assign_out</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">nb_real</span><span class="o">=</span><span class="n">nb_real</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">theta_en</span><span class="p">:</span>
        <span class="n">bar</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">setting_cart_from_polar_2</span><span class="p">(</span><span class="n">bar</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">,:],</span><span class="n">gap</span><span class="p">,</span><span class="n">cent</span><span class="p">,</span><span class="n">max_dist</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">bar</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">,:]</span><span class="o">/=</span><span class="n">gap</span>

    <span class="k">return</span> <span class="n">bar_1d_2d_bis</span><span class="p">(</span><span class="n">bar</span><span class="p">,</span><span class="n">shap</span><span class="p">,[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span><span class="n">pol_en</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">log_param</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">tol</span><span class="o">=</span><span class="mf">10.0</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mi">15</span><span class="p">))</span>

<span class="k">def</span> <span class="nf">local_sliced_transport_bar_interface_m</span><span class="p">(</span><span class="n">stack</span><span class="p">,</span><span class="n">gap</span><span class="p">,</span><span class="n">dist_mat</span><span class="p">,</span><span class="n">neighborhood</span><span class="p">,</span><span class="n">nb_neigh_inv_map</span><span class="p">,</span><span class="n">pos_field</span><span class="p">,</span><span class="n">target_pos</span><span class="p">,</span><span class="n">output_path</span><span class="p">,</span><span class="n">local_dim</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span><span class="n">nb_iter</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span><span class="n">save_file_en</span> <span class="o">=</span> <span class="kc">True</span><span class="p">):</span>
    <span class="kn">import</span> <span class="nn">time</span>
    <span class="n">nb_real</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">nb_neigh_inv_map</span><span class="p">)</span>

    <span class="n">output</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
    <span class="n">tmean</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_real</span><span class="p">):</span>
        <span class="nb">print</span> <span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="s2">&quot; th/&quot;</span><span class="p">,</span><span class="n">nb_real</span>

        <span class="n">weights</span><span class="p">,</span><span class="n">acc</span><span class="p">,</span><span class="n">neighborhood_inv</span> <span class="o">=</span> <span class="n">local_embedding_bar_coordinates</span><span class="p">(</span><span class="n">dist_mat</span><span class="p">,</span><span class="n">neighborhood</span><span class="p">,</span><span class="n">pos_field</span><span class="p">,</span><span class="n">target_pos</span><span class="p">,</span><span class="n">local_dim</span><span class="o">=</span><span class="n">local_dim</span><span class="p">,</span><span class="n">nb_neigh_inv_map</span><span class="o">=</span><span class="n">nb_neigh_inv_map</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">local_sliced_transport_bar_interface</span><span class="p">(</span><span class="n">stack</span><span class="p">,</span><span class="n">gap</span><span class="p">,</span><span class="n">neighborhood_inv</span><span class="p">,</span><span class="n">weights</span><span class="p">,</span><span class="n">nb_iter</span><span class="o">=</span><span class="n">nb_iter</span><span class="p">,</span><span class="n">tol</span><span class="o">=</span><span class="mf">10.0</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mi">10</span><span class="p">),</span><span class="n">single_dir</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">output_path</span><span class="o">=</span><span class="n">output_path</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">save_file_en</span> <span class="o">=</span> <span class="n">save_file_en</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>

    <span class="k">return</span> <span class="n">output</span>


<span class="k">def</span> <span class="nf">sliced_transport_ptbar_interface</span><span class="p">(</span><span class="n">stack</span><span class="p">,</span><span class="n">weights</span><span class="p">,</span><span class="n">gap</span><span class="p">,</span><span class="n">nb_iter</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span><span class="n">tol</span><span class="o">=</span><span class="mf">10.0</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mi">10</span><span class="p">),</span><span class="n">single_dir</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">output_path</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="n">save_file_en</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span><span class="n">cent</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">pol</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">theta_w</span> <span class="o">=</span> <span class="mi">1</span><span class="p">):</span>
    <span class="kn">from</span> <span class="nn">numpy</span> <span class="k">import</span> <span class="n">zeros</span><span class="p">,</span><span class="n">copy</span><span class="p">,</span><span class="n">pi</span>
    <span class="kn">from</span> <span class="nn">optim_utils</span> <span class="k">import</span> <span class="n">sliced_transport_bar</span><span class="p">,</span><span class="n">sliced_transport_ptbar</span><span class="p">,</span><span class="n">setting_polar</span>
    <span class="kn">from</span> <span class="nn">astropy.io</span> <span class="k">import</span> <span class="n">fits</span>
    <span class="kn">from</span> <span class="nn">utils</span> <span class="k">import</span> <span class="n">polar_to_cart_cloud</span>
    <span class="n">pt_clouds</span> <span class="o">=</span> <span class="n">cube_to_point_cloud</span><span class="p">(</span><span class="n">stack</span><span class="p">)</span>
    <span class="n">shap</span> <span class="o">=</span> <span class="n">stack</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">pol</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">stack</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
            <span class="n">pt_clouds</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">,:,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">setting_polar</span><span class="p">(</span><span class="n">pt_clouds</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">,:,</span><span class="n">i</span><span class="p">],</span><span class="n">gap</span><span class="p">,</span><span class="n">cent</span><span class="p">)</span>
        <span class="n">pt_clouds</span><span class="p">[</span><span class="mi">1</span><span class="p">,:,:]</span><span class="o">*=</span><span class="n">theta_w</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">pt_clouds</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">,:,:]</span><span class="o">*=</span><span class="n">gap</span>

    <span class="n">bar</span> <span class="o">=</span> <span class="n">sliced_transport_ptbar</span><span class="p">(</span><span class="n">pt_clouds</span><span class="p">,</span><span class="n">weights</span><span class="p">,</span><span class="n">nb_iter</span><span class="o">=</span><span class="n">nb_iter</span><span class="p">,</span><span class="n">tol</span><span class="o">=</span><span class="n">tol</span><span class="p">,</span><span class="n">alph</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span><span class="n">rand_en</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">basis</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">adapted_basis</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">pos_en</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">min_basis</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">support</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">assign_out</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">single_dir</span><span class="o">=</span><span class="n">single_dir</span><span class="p">,</span><span class="n">gap</span><span class="o">=</span><span class="n">gap</span><span class="p">,</span><span class="n">shap</span><span class="o">=</span><span class="n">shap</span><span class="p">)</span>

    <span class="n">bar</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">,:]</span><span class="o">/=</span><span class="n">gap</span>
    <span class="n">bar</span><span class="p">[</span><span class="mi">1</span><span class="p">,:]</span><span class="o">/=</span><span class="n">theta_w</span>
    <span class="k">if</span> <span class="n">pol</span><span class="p">:</span>
        <span class="n">bar</span><span class="p">[</span><span class="mi">1</span><span class="p">,:]</span><span class="o">*=</span><span class="n">pi</span>
        <span class="n">bar</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">polar_to_cart_cloud</span><span class="p">(</span><span class="n">bar</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">,:],</span><span class="n">cent</span><span class="p">)</span>

    <span class="c1">#sig.append(sig_out)</span>

    <span class="n">psf_interp</span> <span class="o">=</span> <span class="n">bar_1d_2d_bis</span><span class="p">(</span><span class="n">bar</span><span class="p">,</span><span class="n">shap</span><span class="p">,[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span><span class="n">pol_en</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">log_param</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">tol</span><span class="o">=</span><span class="mf">10.0</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mi">15</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">psf_interp</span>

<span class="k">def</span> <span class="nf">get_res</span><span class="p">(</span><span class="n">nb_psf</span><span class="p">,</span><span class="n">shap</span><span class="p">,</span><span class="nb">dir</span><span class="p">):</span>
    <span class="kn">from</span> <span class="nn">astropy.io</span> <span class="k">import</span> <span class="n">fits</span>
    <span class="kn">from</span> <span class="nn">numpy</span> <span class="k">import</span> <span class="n">zeros</span>

    <span class="n">output</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">nb_psf</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_psf</span><span class="p">):</span>
        <span class="n">output</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">getdata</span><span class="p">(</span><span class="nb">dir</span><span class="o">+</span><span class="s1">&#39;psf_&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;.fits&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">output</span>

<span class="k">def</span> <span class="nf">get_res_m</span><span class="p">(</span><span class="n">nb_psf</span><span class="p">,</span><span class="n">shap</span><span class="p">,</span><span class="n">dir_list</span><span class="p">):</span>
    <span class="n">nb_res</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">dir_list</span><span class="p">)</span>
    <span class="n">output</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_res</span><span class="p">):</span>
        <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">get_res</span><span class="p">(</span><span class="n">nb_psf</span><span class="p">,</span><span class="n">shap</span><span class="p">,</span><span class="n">dir_list</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>

    <span class="k">return</span> <span class="n">output</span>


<span class="k">def</span> <span class="nf">local_sliced_dist_interface</span><span class="p">(</span><span class="n">stack</span><span class="p">,</span><span class="n">pos_field</span><span class="p">,</span><span class="n">scale_poly</span><span class="p">,</span><span class="n">nb_iter</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span><span class="n">tol</span><span class="o">=</span><span class="mf">0.001</span><span class="p">,</span><span class="n">alph</span> <span class="o">=</span> <span class="mf">0.1</span><span class="p">,</span><span class="n">basis</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">rand</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">nb_neigh</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span><span class="n">cent</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">weights</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="kn">from</span> <span class="nn">optim_utils</span> <span class="k">import</span> <span class="n">local_sliced_dist_mat</span>
    <span class="kn">from</span> <span class="nn">numpy</span> <span class="k">import</span> <span class="n">exp</span><span class="p">,</span><span class="n">copy</span>
    <span class="kn">from</span> <span class="nn">numpy.polynomial.polynomial</span> <span class="k">import</span> <span class="n">polyval</span>

    <span class="n">shap_clouds</span> <span class="o">=</span> <span class="n">stack</span><span class="o">.</span><span class="n">shape</span>
    <span class="k">if</span> <span class="n">weights</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">weights</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">shap_clouds</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">shap_clouds</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap_clouds</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
            <span class="n">rad_dist</span> <span class="o">=</span> <span class="n">sqrt</span><span class="p">(</span><span class="nb">sum</span><span class="p">((</span><span class="n">stack</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">,:,</span><span class="n">i</span><span class="p">]</span><span class="o">-</span><span class="n">array</span><span class="p">(</span><span class="n">cent</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">ones</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span><span class="n">shap_clouds</span><span class="p">[</span><span class="mi">1</span><span class="p">]))))</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
            <span class="n">a</span> <span class="o">=</span> <span class="n">exp</span><span class="p">(</span><span class="n">polyval</span><span class="p">(</span><span class="n">rad_dist</span><span class="p">,</span><span class="n">scale_poly</span><span class="p">))</span>
            <span class="n">weights</span><span class="p">[</span><span class="n">i</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">a</span>

    <span class="n">stackw</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">stack</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap_clouds</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
        <span class="n">stackw</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">,:,</span><span class="n">i</span><span class="p">]</span><span class="o">/=</span><span class="n">weights</span><span class="p">[</span><span class="n">i</span><span class="p">,:]</span>

    <span class="k">return</span> <span class="n">local_sliced_dist_mat</span><span class="p">(</span><span class="n">stackw</span><span class="p">,</span><span class="n">pos_field</span><span class="p">,</span><span class="n">nb_iter</span><span class="o">=</span><span class="n">nb_iter</span><span class="p">,</span><span class="n">tol</span><span class="o">=</span><span class="n">tol</span><span class="p">,</span><span class="n">alph</span> <span class="o">=</span> <span class="n">alph</span><span class="p">,</span><span class="n">basis</span><span class="o">=</span><span class="n">basis</span><span class="p">,</span><span class="n">rand</span><span class="o">=</span><span class="n">rand</span><span class="p">,</span><span class="n">nb_neigh</span><span class="o">=</span><span class="n">nb_neigh</span><span class="p">),</span><span class="n">weights</span>

<span class="k">def</span> <span class="nf">local_sliced_dist_target_interface</span><span class="p">(</span><span class="n">stack</span><span class="p">,</span><span class="n">pos_field</span><span class="p">,</span><span class="n">target_pos</span><span class="p">,</span><span class="n">scale_poly</span><span class="p">,</span><span class="n">nb_iter</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span><span class="n">tol</span><span class="o">=</span><span class="mf">0.001</span><span class="p">,</span><span class="n">alph</span> <span class="o">=</span> <span class="mf">0.1</span><span class="p">,</span><span class="n">basis</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">rand</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">nb_neigh</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span><span class="n">cent</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">weights</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="kn">from</span> <span class="nn">optim_utils</span> <span class="k">import</span> <span class="n">local_sliced_dist_mat_target</span>

    <span class="kn">from</span> <span class="nn">numpy</span> <span class="k">import</span> <span class="n">exp</span><span class="p">,</span><span class="n">copy</span>
    <span class="kn">from</span> <span class="nn">numpy.polynomial.polynomial</span> <span class="k">import</span> <span class="n">polyval</span>

    <span class="n">shap_clouds</span> <span class="o">=</span> <span class="n">stack</span><span class="o">.</span><span class="n">shape</span>
    <span class="k">if</span> <span class="n">weights</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">weights</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">shap_clouds</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">shap_clouds</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap_clouds</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
            <span class="n">rad_dist</span> <span class="o">=</span> <span class="n">sqrt</span><span class="p">(</span><span class="nb">sum</span><span class="p">((</span><span class="n">stack</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">,:,</span><span class="n">i</span><span class="p">]</span><span class="o">-</span><span class="n">array</span><span class="p">(</span><span class="n">cent</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">ones</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span><span class="n">shap_clouds</span><span class="p">[</span><span class="mi">1</span><span class="p">]))))</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
            <span class="n">a</span> <span class="o">=</span> <span class="n">exp</span><span class="p">(</span><span class="n">polyval</span><span class="p">(</span><span class="n">rad_dist</span><span class="p">,</span><span class="n">scale_poly</span><span class="p">))</span>
            <span class="n">weights</span><span class="p">[</span><span class="n">i</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">a</span>

    <span class="n">stackw</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">stack</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap_clouds</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
        <span class="n">stackw</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">,:,</span><span class="n">i</span><span class="p">]</span><span class="o">/=</span><span class="n">weights</span><span class="p">[</span><span class="n">i</span><span class="p">,:]</span>

    <span class="k">return</span> <span class="n">local_sliced_dist_mat_target</span><span class="p">(</span><span class="n">stackw</span><span class="p">,</span><span class="n">pos_field</span><span class="p">,</span><span class="n">target_pos</span><span class="p">,</span><span class="n">nb_iter</span><span class="o">=</span><span class="n">nb_iter</span><span class="p">,</span><span class="n">tol</span><span class="o">=</span><span class="n">tol</span><span class="p">,</span><span class="n">alph</span> <span class="o">=</span> <span class="n">alph</span><span class="p">,</span><span class="n">basis</span><span class="o">=</span><span class="n">basis</span><span class="p">,</span><span class="n">rand</span><span class="o">=</span><span class="n">rand</span><span class="p">,</span><span class="n">nb_neigh</span><span class="o">=</span><span class="n">nb_neigh</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">local_sliced_dist_supp_interface</span><span class="p">(</span><span class="n">stack</span><span class="p">,</span><span class="n">pos_field</span><span class="p">,</span><span class="n">scale_poly</span><span class="p">,</span><span class="n">nb_iter</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span><span class="n">tol</span><span class="o">=</span><span class="mf">0.001</span><span class="p">,</span><span class="n">alph</span> <span class="o">=</span> <span class="mf">0.1</span><span class="p">,</span><span class="n">basis</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">rand</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">nb_neigh</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span><span class="n">cent</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">weights</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">max_val</span> <span class="o">=</span> <span class="mi">2</span><span class="o">**</span><span class="mi">63</span><span class="p">,</span><span class="n">knn</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="kn">from</span> <span class="nn">optim_utils</span> <span class="k">import</span> <span class="n">local_sliced_dist_mat_supp</span>
    <span class="kn">from</span> <span class="nn">numpy</span> <span class="k">import</span> <span class="n">exp</span><span class="p">,</span><span class="n">copy</span>
    <span class="kn">from</span> <span class="nn">numpy.polynomial.polynomial</span> <span class="k">import</span> <span class="n">polyval</span>
    <span class="kn">from</span> <span class="nn">pyflann</span> <span class="k">import</span> <span class="n">FLANN</span>
    <span class="k">if</span> <span class="n">knn</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">knn</span> <span class="o">=</span> <span class="n">FLANN</span><span class="p">()</span>
        <span class="n">params</span> <span class="o">=</span> <span class="n">knn</span><span class="o">.</span><span class="n">build_index</span><span class="p">(</span><span class="n">array</span><span class="p">(</span><span class="n">pos_field</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">float64</span><span class="p">))</span>
    <span class="n">shap_clouds</span> <span class="o">=</span> <span class="n">stack</span><span class="o">.</span><span class="n">shape</span>
    <span class="k">if</span> <span class="n">weights</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">weights</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">shap_clouds</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">shap_clouds</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap_clouds</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
            <span class="n">rad_dist</span> <span class="o">=</span> <span class="n">sqrt</span><span class="p">(</span><span class="nb">sum</span><span class="p">((</span><span class="n">stack</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">,:,</span><span class="n">i</span><span class="p">]</span><span class="o">-</span><span class="n">array</span><span class="p">(</span><span class="n">cent</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">ones</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span><span class="n">shap_clouds</span><span class="p">[</span><span class="mi">1</span><span class="p">]))))</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
            <span class="n">a</span> <span class="o">=</span> <span class="n">exp</span><span class="p">(</span><span class="n">polyval</span><span class="p">(</span><span class="n">rad_dist</span><span class="p">,</span><span class="n">scale_poly</span><span class="p">))</span>
            <span class="n">weights</span><span class="p">[</span><span class="n">i</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">a</span>

    <span class="n">stackw</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">stack</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap_clouds</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
        <span class="n">stackw</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">,:,</span><span class="n">i</span><span class="p">]</span><span class="o">/=</span><span class="n">weights</span><span class="p">[</span><span class="n">i</span><span class="p">,:]</span>

    <span class="k">return</span> <span class="n">local_sliced_dist_mat_supp</span><span class="p">(</span><span class="n">stackw</span><span class="p">,</span><span class="n">pos_field</span><span class="p">,</span><span class="n">knn</span><span class="o">=</span><span class="n">knn</span><span class="p">,</span><span class="n">nb_iter</span><span class="o">=</span><span class="n">nb_iter</span><span class="p">,</span><span class="n">tol</span><span class="o">=</span><span class="n">tol</span><span class="p">,</span><span class="n">alph</span> <span class="o">=</span> <span class="n">alph</span><span class="p">,</span><span class="n">basis</span><span class="o">=</span><span class="n">basis</span><span class="p">,</span><span class="n">rand</span><span class="o">=</span><span class="n">rand</span><span class="p">,</span><span class="n">nb_neigh</span><span class="o">=</span><span class="n">nb_neigh</span><span class="p">,</span><span class="n">max_val</span><span class="o">=</span><span class="n">max_val</span><span class="p">),</span><span class="n">weights</span>



<span class="k">def</span> <span class="nf">local_hybrid_distance</span><span class="p">(</span><span class="n">im_stack</span><span class="p">,</span><span class="n">clouds_stack</span><span class="p">,</span><span class="n">pos_field</span><span class="p">,</span><span class="n">scale_poly</span><span class="p">,</span><span class="n">nb_iter</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span><span class="n">tol</span><span class="o">=</span><span class="mf">0.000000000001</span><span class="p">,</span><span class="n">alph</span> <span class="o">=</span> <span class="mf">0.1</span><span class="p">,</span><span class="n">basis</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">rand</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">nb_neigh</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span><span class="n">cent</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">weights</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">max_val</span> <span class="o">=</span> <span class="mi">2</span><span class="o">**</span><span class="mi">63</span><span class="p">):</span>
    <span class="kn">from</span> <span class="nn">numpy</span> <span class="k">import</span> <span class="n">sqrt</span>
    <span class="kn">from</span> <span class="nn">optim_utils</span> <span class="k">import</span> <span class="n">local_euc_dist_mat_support</span>
    <span class="kn">from</span> <span class="nn">pyflann</span> <span class="k">import</span> <span class="n">FLANN</span>

    <span class="n">knn</span> <span class="o">=</span> <span class="n">FLANN</span><span class="p">()</span>
    <span class="n">params</span> <span class="o">=</span> <span class="n">knn</span><span class="o">.</span><span class="n">build_index</span><span class="p">(</span><span class="n">array</span><span class="p">(</span><span class="n">pos_field</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">float64</span><span class="p">))</span>

    <span class="n">dist_mat_1</span><span class="p">,</span><span class="n">weights</span> <span class="o">=</span> <span class="n">local_sliced_dist_supp_interface</span><span class="p">(</span><span class="n">clouds_stack</span><span class="p">,</span><span class="n">pos_field</span><span class="p">,</span><span class="n">scale_poly</span><span class="p">,</span><span class="n">knn</span><span class="o">=</span><span class="n">knn</span><span class="p">,</span><span class="n">nb_iter</span><span class="o">=</span><span class="n">nb_iter</span><span class="p">,</span><span class="n">tol</span><span class="o">=</span><span class="n">tol</span><span class="p">,</span><span class="n">alph</span> <span class="o">=</span> <span class="n">alph</span><span class="p">,</span><span class="n">basis</span><span class="o">=</span><span class="n">basis</span><span class="p">,</span><span class="n">rand</span><span class="o">=</span><span class="n">rand</span><span class="p">,</span><span class="n">nb_neigh</span><span class="o">=</span><span class="n">nb_neigh</span><span class="p">,</span><span class="n">cent</span><span class="o">=</span><span class="n">cent</span><span class="p">,</span><span class="n">weights</span><span class="o">=</span><span class="n">weights</span><span class="p">,</span><span class="n">max_val</span> <span class="o">=</span> <span class="n">max_val</span><span class="p">)</span>
    <span class="n">dist_mat_2</span> <span class="o">=</span> <span class="n">local_euc_dist_mat_support</span><span class="p">(</span><span class="n">im_stack</span><span class="p">,</span><span class="n">pos_field</span><span class="p">,</span><span class="n">knn</span><span class="o">=</span><span class="n">knn</span><span class="p">,</span><span class="n">nb_neigh</span><span class="o">=</span><span class="n">nb_neigh</span><span class="p">,</span><span class="n">max_val</span> <span class="o">=</span><span class="n">max_val</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">sqrt</span><span class="p">(</span><span class="n">dist_mat_1</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="n">dist_mat_2</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>



<span class="k">def</span> <span class="nf">local_sliced_dist_interface_m</span><span class="p">(</span><span class="n">stack_list</span><span class="p">,</span><span class="n">pos_field</span><span class="p">,</span><span class="n">scale_poly</span><span class="p">,</span><span class="n">nb_iter</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span><span class="n">tol</span><span class="o">=</span><span class="mf">0.001</span><span class="p">,</span><span class="n">alph</span> <span class="o">=</span> <span class="mf">0.1</span><span class="p">,</span><span class="n">basis</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">rand</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">nb_neigh</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span><span class="n">cent</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">weights</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>

    <span class="n">dist_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">stack_list</span><span class="p">)):</span>
        <span class="nb">print</span> <span class="s2">&quot;Feature &quot;</span><span class="p">,</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span>
        <span class="n">dist_i</span><span class="p">,</span><span class="n">weights</span> <span class="o">=</span> <span class="n">local_sliced_dist_interface</span><span class="p">(</span><span class="n">stack_list</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">pos_field</span><span class="p">,</span><span class="n">scale_poly</span><span class="p">,</span><span class="n">nb_iter</span><span class="o">=</span><span class="n">nb_iter</span><span class="p">,</span><span class="n">tol</span><span class="o">=</span><span class="n">tol</span><span class="p">,</span><span class="n">alph</span> <span class="o">=</span> <span class="n">alph</span><span class="p">,</span><span class="n">basis</span><span class="o">=</span><span class="n">basis</span><span class="p">,</span><span class="n">rand</span><span class="o">=</span><span class="n">rand</span><span class="p">,</span><span class="n">nb_neigh</span><span class="o">=</span><span class="n">nb_neigh</span><span class="p">,</span><span class="n">cent</span><span class="o">=</span><span class="n">cent</span><span class="p">,</span><span class="n">weights</span><span class="o">=</span><span class="n">weights</span><span class="p">)</span>
        <span class="n">dist_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dist_i</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">dist_list</span>


<span class="k">def</span> <span class="nf">local_sliced_hybrid_dist_m</span><span class="p">(</span><span class="n">im_stack_list</span><span class="p">,</span><span class="n">cloud_stack_list</span><span class="p">,</span><span class="n">pos_field</span><span class="p">,</span><span class="n">scale_poly</span><span class="p">,</span><span class="n">nb_iter</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span><span class="n">tol</span><span class="o">=</span><span class="mf">0.001</span><span class="p">,</span><span class="n">alph</span> <span class="o">=</span> <span class="mf">0.1</span><span class="p">,</span><span class="n">basis</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">rand</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">nb_neigh</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span><span class="n">cent</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">weights</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>

    <span class="n">dist_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">im_stack_list</span><span class="p">)):</span>
        <span class="nb">print</span> <span class="s2">&quot;Feature &quot;</span><span class="p">,</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span>
        <span class="n">dist_i</span> <span class="o">=</span> <span class="n">local_hybrid_distance</span><span class="p">(</span><span class="n">im_stack_list</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">cloud_stack_list</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">pos_field</span><span class="p">,</span><span class="n">scale_poly</span><span class="p">,</span><span class="n">nb_iter</span><span class="o">=</span><span class="n">nb_iter</span><span class="p">,</span><span class="n">tol</span><span class="o">=</span><span class="n">tol</span><span class="p">,</span><span class="n">alph</span> <span class="o">=</span> <span class="n">alph</span><span class="p">,</span><span class="n">basis</span><span class="o">=</span><span class="n">basis</span><span class="p">,</span><span class="n">rand</span><span class="o">=</span><span class="n">rand</span><span class="p">,</span><span class="n">nb_neigh</span><span class="o">=</span><span class="n">nb_neigh</span><span class="p">,</span><span class="n">cent</span><span class="o">=</span><span class="n">cent</span><span class="p">,</span><span class="n">weights</span><span class="o">=</span><span class="n">weights</span><span class="p">)</span>
        <span class="n">dist_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dist_i</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">dist_list</span>




<span class="k">def</span> <span class="nf">LLE_interpolation</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span><span class="n">shap</span><span class="p">,</span><span class="n">embed_list</span><span class="p">,</span><span class="n">knn_list</span><span class="p">,</span><span class="n">poly_modes</span><span class="p">,</span><span class="n">deg</span><span class="p">,</span><span class="n">list_rings</span><span class="p">,</span><span class="n">nb_neigh</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">nb_struct_max</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>

    <span class="kn">from</span> <span class="nn">utils</span> <span class="k">import</span> <span class="n">eval_vect_poly</span>
    <span class="kn">from</span> <span class="nn">numpy</span> <span class="k">import</span> <span class="n">zeros</span><span class="p">,</span><span class="n">transpose</span>

    <span class="n">psf</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">(</span><span class="n">shap</span><span class="p">)</span>
    <span class="n">nb_struct</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">embed_list</span><span class="p">)</span>
    <span class="n">auto_nb_neigh</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">if</span> <span class="n">nb_neigh</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">auto_nb_neigh</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="n">weights</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
    <span class="n">struct_neigh</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">nb_struct_max</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">nb_struct_max</span> <span class="o">=</span> <span class="n">nb_struct</span>



    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_struct_max</span><span class="p">):</span>

        <span class="k">if</span> <span class="n">auto_nb_neigh</span><span class="p">:</span>
            <span class="n">nb_neigh</span> <span class="o">=</span> <span class="n">embed_list</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span>
        <span class="n">embed_coord</span> <span class="o">=</span> <span class="n">eval_vect_poly</span><span class="p">(</span><span class="n">pos</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">pos</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">poly_modes</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">deg</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>

        <span class="n">struct_i</span><span class="p">,</span><span class="n">weights_i</span><span class="p">,</span><span class="n">struct_neigh_i</span> <span class="o">=</span> <span class="n">inverse_mapping_2D</span><span class="p">(</span><span class="n">embed_coord</span><span class="p">,</span><span class="n">embed_list</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">list_rings</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">knn_list</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">nb_neigh</span><span class="o">=</span><span class="n">nb_neigh</span><span class="p">)</span>
        <span class="n">psf</span><span class="o">+=</span> <span class="n">struct_i</span>
        <span class="n">weights</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">weights_i</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">nb_neigh</span><span class="p">,)))</span>
        <span class="n">struct_neigh</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">struct_neigh_i</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">nb_neigh</span><span class="p">,)))</span>

    <span class="k">return</span> <span class="n">psf</span><span class="p">,</span><span class="n">weights</span><span class="p">,</span><span class="n">struct_neigh</span>

<span class="k">def</span> <span class="nf">LLE_rbf_interpolation</span><span class="p">(</span><span class="n">target_pos</span><span class="p">,</span><span class="n">pos_field</span><span class="p">,</span><span class="n">shap</span><span class="p">,</span><span class="n">embed_coord</span><span class="p">,</span><span class="n">psf_ref</span><span class="p">,</span><span class="n">knn_pos</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">knn_embed</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">nb_neigh</span><span class="o">=</span><span class="mi">20</span><span class="p">):</span>
    <span class="kn">from</span> <span class="nn">numpy</span> <span class="k">import</span> <span class="n">transpose</span><span class="p">,</span><span class="n">zeros</span><span class="p">,</span><span class="n">array</span>
    <span class="kn">from</span> <span class="nn">pyflann</span> <span class="k">import</span> <span class="n">FLANN</span>

    <span class="k">if</span> <span class="n">knn_pos</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">knn_pos</span> <span class="o">=</span> <span class="n">FLANN</span><span class="p">()</span>
        <span class="n">params1</span> <span class="o">=</span> <span class="n">knn_pos</span><span class="o">.</span><span class="n">build_index</span><span class="p">(</span><span class="n">array</span><span class="p">(</span><span class="n">pos_field</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">float64</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">knn_embed</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">knn_embed</span> <span class="o">=</span> <span class="n">FLANN</span><span class="p">()</span>
        <span class="n">params2</span> <span class="o">=</span> <span class="n">knn_embed</span><span class="o">.</span><span class="n">build_index</span><span class="p">(</span><span class="n">array</span><span class="p">(</span><span class="n">transpose</span><span class="p">(</span><span class="n">embed_coord</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">float64</span><span class="p">))</span>

    <span class="n">nb_points</span> <span class="o">=</span> <span class="n">target_pos</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="n">psf_interp</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">nb_points</span><span class="p">))</span>
    <span class="n">dim</span> <span class="o">=</span> <span class="n">embed_coord</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">weights</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_points</span><span class="p">):</span>
        <span class="nb">print</span> <span class="s2">&quot;PSF&quot;</span><span class="p">,</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="s2">&quot;/&quot;</span><span class="p">,</span><span class="n">nb_points</span>
        <span class="n">result_pos</span><span class="p">,</span> <span class="n">dists</span> <span class="o">=</span> <span class="n">knn_pos</span><span class="o">.</span><span class="n">nn_index</span><span class="p">(</span><span class="n">target_pos</span><span class="p">[</span><span class="n">i</span><span class="p">,:],</span> <span class="n">nb_neigh</span><span class="p">)</span>
        <span class="n">embed_coord_i</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">dim</span><span class="p">,))</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">dim</span><span class="p">):</span>
            <span class="n">rbf</span> <span class="o">=</span> <span class="n">Rbf</span><span class="p">(</span><span class="n">pos_field</span><span class="p">[</span><span class="n">result_pos</span><span class="p">[</span><span class="mi">0</span><span class="p">,:],</span><span class="mi">0</span><span class="p">],</span> <span class="n">pos_field</span><span class="p">[</span><span class="n">result_pos</span><span class="p">[</span><span class="mi">0</span><span class="p">,:],</span><span class="mi">1</span><span class="p">],</span> <span class="n">embed_coord</span><span class="p">[</span><span class="n">j</span><span class="p">,</span><span class="n">result_pos</span><span class="p">[</span><span class="mi">0</span><span class="p">,:]],</span> <span class="n">function</span><span class="o">=</span><span class="s1">&#39;thin_plate&#39;</span><span class="p">)</span>
            <span class="n">embed_coord_i</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">rbf</span><span class="p">(</span><span class="n">target_pos</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span><span class="n">target_pos</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">psf_interp</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">],</span><span class="n">weights_i</span><span class="p">,</span><span class="n">struct_neigh_i</span> <span class="o">=</span> <span class="n">inverse_mapping_2D</span><span class="p">(</span><span class="n">embed_coord_i</span><span class="p">,</span><span class="n">emax_mbed_coord</span><span class="p">,</span><span class="n">psf_ref</span><span class="p">,</span><span class="n">knn_embed</span><span class="p">,</span><span class="n">nb_neigh</span><span class="o">=</span><span class="n">dim</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">weights</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">weights_i</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">psf_interp</span><span class="p">,</span><span class="n">knn_embed</span><span class="p">,</span><span class="n">knn_pos</span><span class="p">,</span><span class="n">array</span><span class="p">(</span><span class="n">weights</span><span class="p">)</span>


<span class="c1">#w_inverse_mapping_2D(embed_coord,embed_ref,original_ref,flann_obj,basis,nb_neigh=3,nb_iter=1000)</span>


<span class="k">def</span> <span class="nf">W_LLE_interpolation</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span><span class="n">shap</span><span class="p">,</span><span class="n">embed_list</span><span class="p">,</span><span class="n">knn_list</span><span class="p">,</span><span class="n">poly_modes</span><span class="p">,</span><span class="n">coeff_poly</span><span class="p">,</span><span class="n">cent</span><span class="p">,</span><span class="n">deg</span><span class="p">,</span><span class="n">list_points_clouds</span><span class="p">,</span><span class="n">basis</span><span class="p">,</span><span class="n">nb_neigh</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">nb_iter</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">,</span><span class="n">support</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">nb_struct_max</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>

    <span class="kn">from</span> <span class="nn">utils</span> <span class="k">import</span> <span class="n">eval_vect_poly</span>
    <span class="kn">from</span> <span class="nn">numpy</span> <span class="k">import</span> <span class="n">zeros</span><span class="p">,</span><span class="n">transpose</span><span class="p">,</span><span class="n">sqrt</span>
    <span class="kn">from</span> <span class="nn">numpy.polynomial.polynomial</span> <span class="k">import</span> <span class="n">polyval</span>

    <span class="n">psf</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">(</span><span class="n">shap</span><span class="p">)</span>
    <span class="n">nb_struct</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">embed_list</span><span class="p">)</span>
    <span class="n">auto_nb_neigh</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">if</span> <span class="n">nb_neigh</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">auto_nb_neigh</span> <span class="o">=</span> <span class="kc">True</span>


    <span class="n">weights</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
    <span class="n">struct_neigh</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">nb_struct_max</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">nb_struct_max</span> <span class="o">=</span> <span class="n">nb_struct</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_struct_max</span><span class="p">):</span>

        <span class="n">embed_coord</span> <span class="o">=</span> <span class="n">eval_vect_poly</span><span class="p">(</span><span class="n">pos</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">pos</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">poly_modes</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">deg</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">auto_nb_neigh</span><span class="p">:</span>
            <span class="n">nb_neigh</span> <span class="o">=</span> <span class="n">embed_list</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span>

        <span class="n">bar_i</span><span class="p">,</span><span class="n">weights_i</span><span class="p">,</span><span class="n">struct_neigh_i</span> <span class="o">=</span> <span class="n">w_inverse_mapping_2D</span><span class="p">(</span><span class="n">embed_coord</span><span class="p">,</span><span class="n">embed_list</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">list_points_clouds</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">knn_list</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">cent</span><span class="p">,</span><span class="n">coeff_poly</span><span class="p">,</span><span class="n">basis</span><span class="p">,</span><span class="n">nb_neigh</span><span class="o">=</span><span class="n">nb_neigh</span><span class="p">,</span><span class="n">nb_iter</span><span class="o">=</span><span class="n">nb_iter</span><span class="p">,</span><span class="n">support</span><span class="o">=</span><span class="n">support</span><span class="p">)</span>
        <span class="n">shap_clouds</span> <span class="o">=</span> <span class="n">list_points_clouds</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span>
        <span class="n">rad_dist_bar</span> <span class="o">=</span> <span class="n">sqrt</span><span class="p">(</span><span class="nb">sum</span><span class="p">((</span><span class="n">bar_i</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">,:]</span><span class="o">-</span><span class="n">array</span><span class="p">(</span><span class="n">cent</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">ones</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span><span class="n">shap_clouds</span><span class="p">[</span><span class="mi">1</span><span class="p">]))))</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">support</span><span class="p">:</span>
            <span class="n">bar_i</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">,:]</span> <span class="o">+=</span> <span class="n">exp</span><span class="p">(</span><span class="n">polyval</span><span class="p">(</span><span class="n">rad_dist_bar</span><span class="p">,</span><span class="n">coeff_poly</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">bar_i</span><span class="p">[</span><span class="mi">2</span><span class="p">,:]</span> <span class="o">/=</span> <span class="n">exp</span><span class="p">(</span><span class="n">polyval</span><span class="p">(</span><span class="n">rad_dist_bar</span><span class="p">,</span><span class="n">coeff_poly</span><span class="p">))</span>

        <span class="n">struct_i</span> <span class="o">=</span> <span class="n">bar_1d_2d_bis</span><span class="p">(</span><span class="n">bar_i</span><span class="p">,</span><span class="n">shap</span><span class="p">,</span><span class="n">cent</span><span class="p">,</span><span class="n">pol_en</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">log_param</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">tol</span><span class="o">=</span><span class="mf">10.0</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mi">15</span><span class="p">))</span>
        <span class="n">psf</span><span class="o">+=</span> <span class="n">struct_i</span>
        <span class="n">weights</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">weights_i</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">nb_neigh</span><span class="p">,)))</span>
        <span class="n">struct_neigh</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">struct_neigh_i</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">nb_neigh</span><span class="p">,)))</span>

    <span class="k">return</span> <span class="n">psf</span><span class="p">,</span><span class="n">weights</span><span class="p">,</span><span class="n">struct_neigh</span>


<span class="k">def</span> <span class="nf">im_weighting</span><span class="p">(</span><span class="n">im</span><span class="p">,</span><span class="n">cent</span><span class="p">,</span><span class="n">scale_poly</span><span class="p">):</span>
    <span class="kn">from</span> <span class="nn">numpy</span> <span class="k">import</span> <span class="n">sqrt</span><span class="p">,</span><span class="n">exp</span>
    <span class="kn">from</span> <span class="nn">numpy.polynomial.polynomial</span> <span class="k">import</span> <span class="n">polyval</span>
    <span class="n">shap</span> <span class="o">=</span> <span class="n">im</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">im_out</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">im</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
            <span class="n">im_out</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span><span class="o">/=</span><span class="n">exp</span><span class="p">(</span><span class="n">polyval</span><span class="p">(</span><span class="n">sqrt</span><span class="p">((</span><span class="n">i</span><span class="o">-</span><span class="n">cent</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="p">(</span><span class="n">j</span><span class="o">-</span><span class="n">cent</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span><span class="p">),</span><span class="n">scale_poly</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">im_out</span>

<span class="k">def</span> <span class="nf">im_deweighting</span><span class="p">(</span><span class="n">im</span><span class="p">,</span><span class="n">cent</span><span class="p">,</span><span class="n">scale_poly</span><span class="p">):</span>
    <span class="kn">from</span> <span class="nn">numpy</span> <span class="k">import</span> <span class="n">sqrt</span><span class="p">,</span><span class="n">exp</span>
    <span class="kn">from</span> <span class="nn">numpy.polynomial.polynomial</span> <span class="k">import</span> <span class="n">polyval</span>
    <span class="n">shap</span> <span class="o">=</span> <span class="n">im</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">im_out</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">im</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
            <span class="n">im_out</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span><span class="o">*=</span><span class="n">exp</span><span class="p">(</span><span class="n">polyval</span><span class="p">(</span><span class="n">sqrt</span><span class="p">((</span><span class="n">i</span><span class="o">-</span><span class="n">cent</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="p">(</span><span class="n">j</span><span class="o">-</span><span class="n">cent</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span><span class="p">),</span><span class="n">scale_poly</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">im_out</span>


<span class="k">def</span> <span class="nf">im_weighting_stack</span><span class="p">(</span><span class="n">im_stack</span><span class="p">,</span><span class="n">cent</span><span class="p">,</span><span class="n">scale_poly</span><span class="p">):</span>

    <span class="n">im_out</span> <span class="o">=</span> <span class="n">im_stack</span><span class="o">*</span><span class="mi">0</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">im_out</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
        <span class="n">im_out</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">im_weighting</span><span class="p">(</span><span class="n">im_stack</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">],</span><span class="n">cent</span><span class="p">,</span><span class="n">scale_poly</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">im_out</span>

<span class="k">def</span> <span class="nf">im_deweighting_stack</span><span class="p">(</span><span class="n">im_stack</span><span class="p">,</span><span class="n">cent</span><span class="p">,</span><span class="n">scale_poly</span><span class="p">):</span>

    <span class="n">im_out</span> <span class="o">=</span> <span class="n">im_stack</span><span class="o">*</span><span class="mi">0</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">im_out</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
        <span class="n">im_out</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">im_deweighting</span><span class="p">(</span><span class="n">im_stack</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">],</span><span class="n">cent</span><span class="p">,</span><span class="n">scale_poly</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">im_out</span>

<span class="k">def</span> <span class="nf">LLE_interpolation_m</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span><span class="n">shap</span><span class="p">,</span><span class="n">embed_list</span><span class="p">,</span><span class="n">knn_list</span><span class="p">,</span><span class="n">poly_modes</span><span class="p">,</span><span class="n">deg</span><span class="p">,</span><span class="n">list_rings</span><span class="p">,</span><span class="n">nb_neigh</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">nb_struct_max</span><span class="o">=</span><span class="mi">4</span><span class="p">):</span>

    <span class="kn">from</span> <span class="nn">numpy</span> <span class="k">import</span> <span class="n">zeros</span>

    <span class="n">nb_points</span> <span class="o">=</span> <span class="n">pos</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">psf_interp</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">nb_points</span><span class="p">))</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_points</span><span class="p">):</span>
        <span class="n">psf_interp</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">],</span><span class="n">weights</span><span class="p">,</span><span class="n">struct_neigh</span> <span class="o">=</span> <span class="n">LLE_interpolation</span><span class="p">(</span><span class="n">pos</span><span class="p">[</span><span class="n">i</span><span class="p">,:],</span><span class="n">shap</span><span class="p">,</span><span class="n">embed_list</span><span class="p">,</span><span class="n">knn_list</span><span class="p">,</span><span class="n">poly_modes</span><span class="p">,</span><span class="n">deg</span><span class="p">,</span><span class="n">list_rings</span><span class="p">,</span><span class="n">nb_neigh</span><span class="o">=</span><span class="n">nb_neigh</span><span class="p">,</span><span class="n">nb_struct_max</span> <span class="o">=</span> <span class="n">nb_struct_max</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">psf_interp</span>

<span class="k">def</span> <span class="nf">LLE_approx_interface</span><span class="p">(</span><span class="n">data_cube</span><span class="p">,</span><span class="n">dist_mat</span><span class="p">,</span><span class="n">nb_neigh</span><span class="p">,</span><span class="n">nb_comp</span><span class="p">):</span>
    <span class="kn">from</span> <span class="nn">optim_utils</span> <span class="k">import</span> <span class="n">approx_HLLE</span>
    <span class="kn">from</span> <span class="nn">utils</span> <span class="k">import</span> <span class="n">cube_to_mat</span><span class="p">,</span><span class="n">mat_to_cube</span>
    <span class="kn">from</span> <span class="nn">numpy</span> <span class="k">import</span> <span class="n">transpose</span>

    <span class="n">shap</span> <span class="o">=</span> <span class="n">data_cube</span><span class="o">.</span><span class="n">shape</span>

    <span class="n">embedding</span><span class="p">,</span><span class="n">loc_comp</span><span class="p">,</span><span class="n">data_approx</span> <span class="o">=</span> <span class="n">approx_HLLE</span><span class="p">(</span><span class="n">transpose</span><span class="p">(</span><span class="n">cube_to_mat</span><span class="p">(</span><span class="n">data_cube</span><span class="p">)),</span><span class="n">dist_mat</span><span class="p">,</span><span class="n">nb_neigh</span><span class="p">,</span><span class="n">nb_comp</span><span class="p">)</span>



    <span class="k">return</span> <span class="n">embedding</span><span class="p">,</span><span class="n">loc_comp</span><span class="p">,</span><span class="n">mat_to_cube</span><span class="p">(</span><span class="n">transpose</span><span class="p">(</span><span class="n">data_approx</span><span class="p">),</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

<span class="k">def</span> <span class="nf">pair_wise_distance_interface</span><span class="p">(</span><span class="n">data_cube</span><span class="p">,</span><span class="n">dist_mat</span><span class="p">,</span><span class="n">full_output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">details_mat</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">nb_iter</span><span class="o">=</span><span class="mi">100</span><span class="p">):</span>
    <span class="kn">from</span> <span class="nn">optim_utils</span> <span class="k">import</span> <span class="n">pair_wise_distances_constraint</span>
    <span class="kn">from</span> <span class="nn">utils</span> <span class="k">import</span> <span class="n">cube_to_mat</span><span class="p">,</span><span class="n">mat_to_cube</span>
    <span class="kn">from</span> <span class="nn">numpy</span> <span class="k">import</span> <span class="n">transpose</span>


    <span class="n">shap</span> <span class="o">=</span> <span class="n">data_cube</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">data_mat</span> <span class="o">=</span> <span class="n">transpose</span><span class="p">(</span><span class="n">cube_to_mat</span><span class="p">(</span><span class="n">data_cube</span><span class="p">))</span>

    <span class="n">details</span><span class="p">,</span><span class="n">U</span><span class="p">,</span><span class="n">details_mat</span> <span class="o">=</span> <span class="n">pair_wise_distances_constraint</span><span class="p">(</span><span class="n">data_mat</span><span class="p">,</span><span class="n">dist_mat</span><span class="p">,</span><span class="n">details_mat</span><span class="o">=</span><span class="n">details_mat</span><span class="p">,</span><span class="n">nb_iter</span><span class="o">=</span><span class="n">nb_iter</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">full_output</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">mat_to_cube</span><span class="p">(</span><span class="n">transpose</span><span class="p">(</span><span class="n">details</span><span class="p">),</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span><span class="n">U</span><span class="p">,</span><span class="n">details_mat</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">mat_to_cube</span><span class="p">(</span><span class="n">transpose</span><span class="p">(</span><span class="n">details</span><span class="p">),</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

<span class="k">def</span> <span class="nf">pair_wise_distance_lagrangian_interface</span><span class="p">(</span><span class="n">data_cube</span><span class="p">,</span><span class="n">dist_ref</span><span class="p">,</span><span class="n">dist_target</span><span class="p">,</span><span class="n">beta</span><span class="o">=</span><span class="mi">10</span><span class="p">):</span>
    <span class="kn">from</span> <span class="nn">optim_utils</span> <span class="k">import</span> <span class="n">pair_wise_distances_constraint_lagrangian</span>
    <span class="kn">from</span> <span class="nn">utils</span> <span class="k">import</span> <span class="n">cube_to_mat</span><span class="p">,</span><span class="n">mat_to_cube</span>
    <span class="kn">from</span> <span class="nn">numpy</span> <span class="k">import</span> <span class="n">transpose</span>
    <span class="n">shap</span> <span class="o">=</span> <span class="n">data_cube</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">data_mat</span> <span class="o">=</span> <span class="n">transpose</span><span class="p">(</span><span class="n">cube_to_mat</span><span class="p">(</span><span class="n">data_cube</span><span class="p">))</span>


    <span class="n">data_tightened</span><span class="p">,</span><span class="n">const_mat</span> <span class="o">=</span> <span class="n">pair_wise_distances_constraint_lagrangian</span><span class="p">(</span><span class="n">data_mat</span><span class="p">,</span><span class="n">dist_ref</span><span class="p">,</span><span class="n">dist_target</span><span class="p">,</span><span class="n">beta</span><span class="o">=</span><span class="n">beta</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">mat_to_cube</span><span class="p">(</span><span class="n">transpose</span><span class="p">(</span><span class="n">data_tightened</span><span class="p">),</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span><span class="n">const_mat</span>


<span class="k">def</span> <span class="nf">local_reduction_interface</span><span class="p">(</span><span class="n">data_cube</span><span class="p">,</span><span class="n">nb_neigh</span><span class="p">,</span><span class="n">nb_comp</span><span class="p">,</span><span class="n">dist_mat</span><span class="p">):</span>
    <span class="kn">from</span> <span class="nn">optim_utils</span> <span class="k">import</span> <span class="n">local_reduction</span>
    <span class="kn">from</span> <span class="nn">utils</span> <span class="k">import</span> <span class="n">cube_to_mat</span><span class="p">,</span><span class="n">mat_to_cube</span>
    <span class="kn">from</span> <span class="nn">numpy</span> <span class="k">import</span> <span class="n">transpose</span>


    <span class="n">shap</span> <span class="o">=</span> <span class="n">data_cube</span><span class="o">.</span><span class="n">shape</span>

    <span class="k">return</span> <span class="n">mat_to_cube</span><span class="p">(</span><span class="n">transpose</span><span class="p">(</span><span class="n">local_reduction</span><span class="p">(</span><span class="n">transpose</span><span class="p">(</span><span class="n">cube_to_mat</span><span class="p">(</span><span class="n">data_cube</span><span class="p">)),</span><span class="n">nb_neigh</span><span class="p">,</span><span class="n">nb_comp</span><span class="p">,</span><span class="n">dist_mat</span><span class="p">)),</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>


<span class="k">def</span> <span class="nf">WLLE_interpolation_m</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span><span class="n">shap</span><span class="p">,</span><span class="n">embed_list</span><span class="p">,</span><span class="n">knn_list</span><span class="p">,</span><span class="n">poly_modes</span><span class="p">,</span><span class="n">coeff_poly</span><span class="p">,</span><span class="n">cent</span><span class="p">,</span><span class="n">deg</span><span class="p">,</span><span class="n">list_points_clouds</span><span class="p">,</span><span class="n">basis</span><span class="p">,</span><span class="n">nb_neigh</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">nb_iter</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span><span class="n">support</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">nb_struct_max</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>

    <span class="kn">from</span> <span class="nn">numpy</span> <span class="k">import</span> <span class="n">zeros</span>



    <span class="n">nb_points</span> <span class="o">=</span> <span class="n">pos</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">psf_interp</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">nb_points</span><span class="p">))</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_points</span><span class="p">):</span>
        <span class="nb">print</span> <span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="s1">&#39;th PSF/&#39;</span><span class="p">,</span><span class="n">nb_points</span>

        <span class="n">psf_interp</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">],</span><span class="n">weights</span><span class="p">,</span><span class="n">struct_neigh</span> <span class="o">=</span> <span class="n">W_LLE_interpolation</span><span class="p">(</span><span class="n">pos</span><span class="p">[</span><span class="n">i</span><span class="p">,:],</span><span class="n">shap</span><span class="p">,</span><span class="n">embed_list</span><span class="p">,</span><span class="n">knn_list</span><span class="p">,</span><span class="n">poly_modes</span><span class="p">,</span><span class="n">coeff_poly</span><span class="p">,</span><span class="n">cent</span><span class="p">,</span><span class="n">deg</span><span class="p">,</span><span class="n">list_points_clouds</span><span class="p">,</span><span class="n">basis</span><span class="p">,</span><span class="n">nb_neigh</span><span class="o">=</span><span class="n">nb_neigh</span><span class="p">,</span><span class="n">nb_iter</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">,</span><span class="n">support</span><span class="o">=</span><span class="n">support</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">psf_interp</span>


<span class="k">def</span> <span class="nf">LLE_interpolation_m2</span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="n">ref_pos</span><span class="p">,</span><span class="n">target</span><span class="p">,</span><span class="n">pos</span><span class="p">,</span><span class="n">embed_list</span><span class="p">,</span><span class="n">knn_list</span><span class="p">,</span><span class="n">deg_mapping</span><span class="p">,</span><span class="n">list_rings</span><span class="p">,</span><span class="n">center</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">kmad</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span><span class="n">deg</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span><span class="n">win</span><span class="o">=</span><span class="mi">9</span><span class="p">,</span><span class="n">win2</span><span class="o">=</span><span class="mi">7</span><span class="p">,</span><span class="n">offset</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">nb_components</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span><span class="n">nb_neigh_embedding</span><span class="o">=</span><span class="kc">None</span> <span class="p">,</span><span class="n">ring_wise</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">nb_neigh_inverse_mapping</span><span class="o">=</span><span class="mi">5</span><span class="p">):</span> <span class="c1"># Interpolation of different data sets</span>

    <span class="n">shap</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">nb_sets</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="n">psf_interp</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_sets</span><span class="p">):</span>
        <span class="n">embed_list</span><span class="p">,</span><span class="n">knn_list</span><span class="p">,</span><span class="n">list_rings_learning</span> <span class="o">=</span> <span class="n">interpolation_setting_2</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">center</span><span class="o">=</span><span class="n">center</span><span class="p">[</span><span class="n">i</span><span class="p">,:],</span><span class="n">kmad</span><span class="o">=</span><span class="n">kmad</span><span class="p">,</span><span class="n">deg</span><span class="o">=</span><span class="n">deg</span><span class="p">,</span><span class="n">win</span><span class="o">=</span><span class="n">win</span><span class="p">,</span><span class="n">win2</span><span class="o">=</span><span class="n">win2</span><span class="p">,</span><span class="n">offset</span><span class="o">=</span><span class="n">offset</span><span class="p">,</span><span class="n">nb_components</span><span class="o">=</span><span class="n">nb_components</span><span class="p">,</span><span class="n">nb_neigh</span><span class="o">=</span><span class="n">nb_neigh_embedding</span><span class="p">,</span><span class="n">ring_wise</span><span class="o">=</span><span class="n">ring_wise</span><span class="p">)</span>
        <span class="n">poly_modes</span> <span class="o">=</span> <span class="n">field_mapping</span><span class="p">(</span><span class="n">embed_list</span><span class="p">,</span><span class="n">ref_pos</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">deg</span><span class="o">=</span><span class="n">deg_mapping</span><span class="p">)</span>
        <span class="n">psf_interp</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">LLE_interpolation_m</span><span class="p">(</span><span class="n">target_pos</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">shap</span><span class="p">,</span><span class="n">embed_list</span><span class="p">,</span><span class="n">knn_list</span><span class="p">,</span><span class="n">poly_modes</span><span class="p">,</span><span class="n">deg</span><span class="p">,</span><span class="n">list_rings_learning</span><span class="p">,</span><span class="n">nb_neigh</span><span class="o">=</span><span class="n">nb_neigh_inverse_mapping</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">psf_interp</span>




<span class="k">def</span> <span class="nf">rings_barycenter</span><span class="p">(</span><span class="n">list_points_clouds</span><span class="p">,</span><span class="n">w</span><span class="p">,</span><span class="n">scaling_fact</span><span class="p">,</span><span class="n">shap</span><span class="p">,</span><span class="n">cent</span><span class="p">,</span><span class="n">rand_en</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">basis</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="kn">from</span> <span class="nn">numpy</span> <span class="k">import</span> <span class="n">zeros</span>
    <span class="kn">from</span> <span class="nn">utils</span> <span class="k">import</span> <span class="n">knn_bar</span><span class="p">,</span><span class="n">lin_bar</span>
    <span class="kn">from</span> <span class="nn">optim_utils</span> <span class="k">import</span> <span class="n">sliced_transport_bar</span>

    <span class="n">bar_init</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">(</span><span class="n">shap</span><span class="p">)</span>
    <span class="n">barycenters</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="nb">len</span><span class="p">(</span><span class="n">list_points_clouds</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">list_points_clouds</span><span class="p">)):</span>
        <span class="c1">#init_bar = lin_bar(list_points_clouds[i],w)</span>
        <span class="n">init_bar</span> <span class="o">=</span> <span class="n">list_points_clouds</span><span class="p">[</span><span class="n">i</span><span class="p">][:,:,</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">bar</span><span class="p">,</span><span class="n">basis_out</span> <span class="o">=</span> <span class="n">sliced_transport_bar</span><span class="p">(</span><span class="n">list_points_clouds</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">w</span><span class="p">,</span><span class="n">nb_iter</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span><span class="n">tol</span><span class="o">=</span><span class="mf">0.0000001</span><span class="p">,</span><span class="n">alph</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span><span class="n">bar_init</span><span class="o">=</span><span class="n">init_bar</span><span class="p">,</span><span class="n">rand_en</span><span class="o">=</span><span class="n">rand_en</span><span class="p">,</span><span class="n">basis</span><span class="o">=</span><span class="n">basis</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        <span class="n">bar</span><span class="p">[</span><span class="mi">2</span><span class="p">,:]</span> <span class="o">*=</span> <span class="n">scaling_fact</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">init_bar</span><span class="p">[</span><span class="mi">2</span><span class="p">,:]</span> <span class="o">*=</span> <span class="n">scaling_fact</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">barycenters</span><span class="p">[:,:,</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">bar_1d_2d_bis</span><span class="p">(</span><span class="n">bar</span><span class="p">,</span><span class="n">shap</span><span class="p">,</span><span class="n">cent</span><span class="p">,</span><span class="n">pol_en</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">log_param</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">tol</span><span class="o">=</span><span class="mf">0.001</span><span class="p">)</span>
        <span class="n">bar_init</span> <span class="o">+=</span> <span class="n">bar_1d_2d_bis</span><span class="p">(</span><span class="n">init_bar</span><span class="p">,</span><span class="n">shap</span><span class="p">,</span><span class="n">cent</span><span class="p">,</span><span class="n">pol_en</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">log_param</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">tol</span><span class="o">=</span><span class="mf">0.001</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">barycenters</span><span class="p">,</span><span class="n">bar_init</span>


<span class="k">def</span> <span class="nf">weighted_rings_barycenter</span><span class="p">(</span><span class="n">arrays_points_clouds</span><span class="p">,</span><span class="n">w</span><span class="p">,</span><span class="n">coeff_poly</span><span class="p">,</span><span class="n">shap</span><span class="p">,</span><span class="n">cent</span><span class="p">,</span><span class="n">rand_en</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">basis</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="kn">from</span> <span class="nn">numpy</span> <span class="k">import</span> <span class="n">zeros</span><span class="p">,</span><span class="n">ones</span><span class="p">,</span><span class="n">sqrt</span><span class="p">,</span><span class="n">exp</span>
    <span class="kn">from</span> <span class="nn">utils</span> <span class="k">import</span> <span class="n">knn_bar</span><span class="p">,</span><span class="n">lin_bar</span>
    <span class="kn">from</span> <span class="nn">optim_utils</span> <span class="k">import</span> <span class="n">sliced_transport_bar</span>
    <span class="kn">from</span> <span class="nn">numpy.polynomial.polynomial</span> <span class="k">import</span> <span class="n">polyval</span>


    <span class="c1"># Calculate the weighted point cloud</span>
    <span class="n">shap_clouds</span> <span class="o">=</span> <span class="n">arrays_points_clouds</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">w_pt_clouds</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">arrays_points_clouds</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shap_clouds</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
        <span class="n">rad_dist</span> <span class="o">=</span> <span class="n">sqrt</span><span class="p">(</span><span class="nb">sum</span><span class="p">((</span><span class="n">arrays_points_clouds</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">,:,</span><span class="n">i</span><span class="p">]</span><span class="o">-</span><span class="n">array</span><span class="p">(</span><span class="n">cent</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">ones</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span><span class="n">shap_clouds</span><span class="p">[</span><span class="mi">1</span><span class="p">]))))</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
        <span class="n">w_pt_clouds</span><span class="p">[</span><span class="mi">2</span><span class="p">,:,</span><span class="n">i</span><span class="p">]</span><span class="o">*=</span> <span class="n">exp</span><span class="p">(</span><span class="n">polyval</span><span class="p">(</span><span class="n">rad_dist</span><span class="p">,</span><span class="n">coeff_poly</span><span class="p">))</span>


    <span class="n">bar</span><span class="p">,</span><span class="n">basis_out</span> <span class="o">=</span> <span class="n">sliced_transport_bar</span><span class="p">(</span><span class="n">w_pt_clouds</span><span class="p">,</span><span class="n">w</span><span class="p">,</span><span class="n">nb_iter</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span><span class="n">tol</span><span class="o">=</span><span class="mf">1e-20</span><span class="p">,</span><span class="n">alph</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span><span class="n">bar_init</span><span class="o">=</span><span class="n">copy</span><span class="p">(</span><span class="n">w_pt_clouds</span><span class="p">[:,:,</span><span class="mi">0</span><span class="p">]),</span><span class="n">rand_en</span><span class="o">=</span><span class="n">rand_en</span><span class="p">,</span><span class="n">basis</span><span class="o">=</span><span class="n">basis</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

    <span class="n">rad_dist_bar</span> <span class="o">=</span> <span class="n">sqrt</span><span class="p">(</span><span class="nb">sum</span><span class="p">((</span><span class="n">bar</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">,:]</span><span class="o">-</span><span class="n">array</span><span class="p">(</span><span class="n">cent</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">ones</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span><span class="n">shap_clouds</span><span class="p">[</span><span class="mi">1</span><span class="p">]))))</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
    <span class="n">bar</span><span class="p">[</span><span class="mi">2</span><span class="p">,:]</span> <span class="o">/=</span> <span class="n">exp</span><span class="p">(</span><span class="n">polyval</span><span class="p">(</span><span class="n">rad_dist_bar</span><span class="p">,</span><span class="n">coeff_poly</span><span class="p">))</span>

    <span class="n">barycenters</span> <span class="o">=</span> <span class="n">bar_1d_2d_bis</span><span class="p">(</span><span class="n">bar</span><span class="p">,</span><span class="n">shap</span><span class="p">,</span><span class="n">cent</span><span class="p">,</span><span class="n">pol_en</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">log_param</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">tol</span><span class="o">=</span><span class="mf">0.001</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">barycenters</span>

<span class="k">def</span> <span class="nf">weighted_rings_dist_matrix</span><span class="p">(</span><span class="n">list_points_clouds</span><span class="p">,</span><span class="n">coeff_poly</span><span class="p">,</span><span class="n">shap</span><span class="p">,</span><span class="n">cent</span><span class="p">,</span><span class="n">rand_en</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">basis</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">sphere_samp</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span><span class="n">nb_iter</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span><span class="n">tol</span><span class="o">=</span><span class="mf">0.001</span><span class="p">,</span><span class="n">alph</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">):</span>
    <span class="kn">from</span> <span class="nn">optim_utils</span> <span class="k">import</span> <span class="n">sliced_dist_mat</span>
    <span class="kn">from</span> <span class="nn">numpy</span> <span class="k">import</span> <span class="n">copy</span><span class="p">,</span><span class="n">zeros</span><span class="p">,</span><span class="n">ones</span><span class="p">,</span><span class="n">sqrt</span><span class="p">,</span><span class="n">exp</span>
    <span class="kn">from</span> <span class="nn">numpy.polynomial.polynomial</span> <span class="k">import</span> <span class="n">polyval</span>
    <span class="kn">from</span> <span class="nn">utils</span> <span class="k">import</span> <span class="n">sphere_vect</span>

    <span class="k">if</span> <span class="n">rand_en</span> <span class="ow">is</span> <span class="kc">False</span> <span class="ow">and</span> <span class="n">basis</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">basis</span> <span class="o">=</span> <span class="n">sphere_vect</span><span class="p">(</span><span class="n">sphere_samp</span><span class="p">)</span>


    <span class="n">dist_mats</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">list_points_clouds</span><span class="p">)):</span>
        <span class="n">w_pt_clouds</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">list_points_clouds</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        <span class="n">shap_clouds</span> <span class="o">=</span> <span class="n">w_pt_clouds</span><span class="o">.</span><span class="n">shape</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">w_pt_clouds</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
            <span class="n">rad_dist</span> <span class="o">=</span> <span class="n">sqrt</span><span class="p">(</span><span class="nb">sum</span><span class="p">((</span><span class="n">w_pt_clouds</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">,:,</span><span class="n">j</span><span class="p">]</span><span class="o">-</span><span class="n">array</span><span class="p">(</span><span class="n">cent</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">ones</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span><span class="n">shap_clouds</span><span class="p">[</span><span class="mi">1</span><span class="p">]))))</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
            <span class="n">w_pt_clouds</span><span class="p">[</span><span class="mi">2</span><span class="p">,:,</span><span class="n">j</span><span class="p">]</span><span class="o">*=</span> <span class="n">exp</span><span class="p">(</span><span class="n">polyval</span><span class="p">(</span><span class="n">rad_dist</span><span class="p">,</span><span class="n">coeff_poly</span><span class="p">))</span>
        <span class="nb">print</span> <span class="nb">sum</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">w_pt_clouds</span><span class="p">))</span>
        <span class="n">dist_mats</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sliced_dist_mat</span><span class="p">(</span><span class="n">w_pt_clouds</span><span class="p">,</span><span class="n">nb_iter</span><span class="o">=</span><span class="n">nb_iter</span><span class="p">,</span><span class="n">tol</span><span class="o">=</span><span class="n">tol</span><span class="p">,</span><span class="n">alph</span> <span class="o">=</span> <span class="n">alph</span><span class="p">,</span><span class="n">basis</span><span class="o">=</span><span class="n">basis</span><span class="p">,</span><span class="n">rand</span><span class="o">=</span><span class="n">rand_en</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">dist_mats</span>




<span class="k">def</span> <span class="nf">rings_barycenter_interface</span><span class="p">(</span><span class="n">main_lobes</span><span class="p">,</span><span class="n">list_points_clouds</span><span class="p">,</span><span class="n">pos_field</span><span class="p">,</span><span class="n">target_pos</span><span class="p">,</span><span class="n">coeff_scale_poly</span><span class="p">,</span><span class="n">nb_points</span><span class="p">,</span><span class="n">shap</span><span class="p">,</span><span class="n">cent</span><span class="p">,</span><span class="n">rand_en</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">knn</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">nb_neigh</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span><span class="n">p</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span><span class="n">sphere_nb_samp</span><span class="o">=</span><span class="mi">10</span><span class="p">):</span>
    <span class="kn">from</span> <span class="nn">pyflann</span> <span class="k">import</span> <span class="n">FLANN</span>
    <span class="kn">from</span> <span class="nn">utils</span> <span class="k">import</span> <span class="n">sphere_vect_w</span>
    <span class="k">if</span> <span class="n">knn</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">knn</span> <span class="o">=</span> <span class="n">FLANN</span><span class="p">()</span>
        <span class="n">params</span> <span class="o">=</span> <span class="n">knn</span><span class="o">.</span><span class="n">build_index</span><span class="p">(</span><span class="n">array</span><span class="p">(</span><span class="n">pos_field</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">float64</span><span class="p">))</span>


    <span class="c1"># Computing the weights</span>
    <span class="n">result</span><span class="p">,</span> <span class="n">dists</span> <span class="o">=</span> <span class="n">knn</span><span class="o">.</span><span class="n">nn_index</span><span class="p">(</span><span class="n">target_pos</span><span class="p">,</span> <span class="n">nb_neigh</span><span class="p">)</span>

    <span class="n">weights</span> <span class="o">=</span> <span class="n">dists</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="n">p</span><span class="p">)</span><span class="o">/</span><span class="nb">sum</span><span class="p">(</span><span class="n">dists</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="n">p</span><span class="p">))</span>

    <span class="n">list_points_clouds_reduced</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>

    <span class="c1"># Setting the neighbors point clouds and weighed basis for sliced transport</span>
    <span class="n">basis</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;stack = zeros((3,nb_points[i],nb_neigh))</span>
<span class="sd">        for j in range(0,nb_neigh):</span>
<span class="sd">            stack[:,:,j] = copy(list_points_clouds[i][:,result[j]*nb_points[i]:(result[j]+1)*nb_points[i]])&quot;&quot;&quot;</span>
        <span class="n">list_points_clouds_reduced</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">list_points_clouds</span><span class="p">[</span><span class="n">i</span><span class="p">][:,:,</span><span class="n">result</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">nb_neigh</span><span class="p">,))])</span>
        <span class="n">basis</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sphere_vect_w</span><span class="p">(</span><span class="n">sphere_nb_samp</span><span class="p">,</span><span class="n">list_points_clouds</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>

    <span class="n">barycenters</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="mi">2</span><span class="p">))</span>
    <span class="c1"># Point cloud main lobe</span>
    <span class="n">main_lobe_cloud</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span><span class="n">nb_points</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_neigh</span><span class="p">):</span>
        <span class="n">barycenters</span><span class="p">[:,:,</span><span class="mi">0</span><span class="p">]</span><span class="o">+=</span><span class="n">weights</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">i</span><span class="p">]</span><span class="o">*</span><span class="n">main_lobes</span><span class="p">[:,:,</span><span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">i</span><span class="p">]]</span>
        <span class="c1">#main_lobe_cloud += weights[0,i]*list_points_clouds_reduced[0][:,:,i]</span>

    <span class="c1">#main_lobe_cloud[2,:] *= scaling_fact[0]</span>

    <span class="c1">#barycenters[:,:,0] = bar_1d_2d_bis(main_lobe_cloud,shap,cent,pol_en=False,log_param=None,tol=0.00000001)</span>
    <span class="n">barycenters</span><span class="p">[:,:,</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">weighted_rings_barycenter</span><span class="p">(</span><span class="n">list_points_clouds_reduced</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">weights</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">nb_neigh</span><span class="p">,)),</span><span class="n">coeff_scale_poly</span><span class="p">,</span><span class="n">shap</span><span class="p">,</span><span class="n">cent</span><span class="p">,</span><span class="n">rand_en</span><span class="o">=</span><span class="n">rand_en</span><span class="p">,</span><span class="n">basis</span><span class="o">=</span><span class="n">basis</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">barycenters</span><span class="p">,</span><span class="n">knn</span>


<span class="k">def</span> <span class="nf">rings_barycenter_interface_m</span><span class="p">(</span><span class="n">main_lobes</span><span class="p">,</span><span class="n">list_points_clouds</span><span class="p">,</span><span class="n">pos_field</span><span class="p">,</span><span class="n">target_pos</span><span class="p">,</span><span class="n">coeff_scale_poly</span><span class="p">,</span><span class="n">nb_points</span><span class="p">,</span><span class="n">shap</span><span class="p">,</span><span class="n">cent</span><span class="p">,</span><span class="n">rand_en</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">knn</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">nb_neigh</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span><span class="n">p</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span><span class="n">sphere_nb_samp</span><span class="o">=</span><span class="mi">10</span><span class="p">):</span>

    <span class="kn">from</span> <span class="nn">numpy</span> <span class="k">import</span> <span class="n">zeros</span>
    <span class="n">nb_points</span> <span class="o">=</span> <span class="n">target_pos</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">barycenters</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">nb_points</span><span class="p">))</span>


    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_points</span><span class="p">):</span>
        <span class="n">barycenters_i</span><span class="p">,</span><span class="n">knn</span> <span class="o">=</span> <span class="n">rings_barycenter_interface</span><span class="p">(</span><span class="n">main_lobes</span><span class="p">,</span><span class="n">list_points_clouds</span><span class="p">,</span><span class="n">pos_field</span><span class="p">,</span><span class="n">target_pos</span><span class="p">[</span><span class="n">i</span><span class="p">,:],</span><span class="n">coeff_scale_poly</span><span class="p">,</span><span class="n">nb_points</span><span class="p">,</span><span class="n">shap</span><span class="p">,</span><span class="n">cent</span><span class="p">,</span><span class="n">rand_en</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">knn</span><span class="o">=</span><span class="n">knn</span><span class="p">,</span><span class="n">nb_neigh</span><span class="o">=</span><span class="n">nb_neigh</span><span class="p">,</span><span class="n">p</span><span class="o">=</span><span class="n">p</span><span class="p">,</span><span class="n">sphere_nb_samp</span><span class="o">=</span><span class="n">sphere_nb_samp</span><span class="p">)</span>
        <span class="n">barycenters</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">barycenters_i</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>


    <span class="k">return</span> <span class="n">barycenters</span>



<span class="k">def</span> <span class="nf">rings_barycenter_interface_m2</span><span class="p">(</span><span class="n">main_lobes</span><span class="p">,</span><span class="n">list_points_clouds</span><span class="p">,</span><span class="n">pos_field</span><span class="p">,</span><span class="n">target_pos</span><span class="p">,</span><span class="n">coeff_scale_poly</span><span class="p">,</span><span class="n">nb_points</span><span class="p">,</span><span class="n">nb_neigh</span><span class="p">,</span><span class="n">shap</span><span class="p">,</span><span class="n">cent</span><span class="p">,</span><span class="n">rand_en</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">knn</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">p</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span><span class="n">sphere_nb_samp</span><span class="o">=</span><span class="mi">10</span><span class="p">):</span>

    <span class="n">barycenters</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">nb_neigh</span><span class="p">)):</span>
        <span class="n">barycenters</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rings_barycenter_interface_m</span><span class="p">(</span><span class="n">main_lobes</span><span class="p">,</span><span class="n">list_points_clouds</span><span class="p">,</span><span class="n">pos_field</span><span class="p">,</span><span class="n">target_pos</span><span class="p">,</span><span class="n">coeff_scale_poly</span><span class="p">,</span><span class="n">nb_points</span><span class="p">,</span><span class="n">shap</span><span class="p">,</span><span class="n">cent</span><span class="p">,</span><span class="n">rand_en</span><span class="o">=</span><span class="n">rand_en</span><span class="p">,</span><span class="n">knn</span><span class="o">=</span><span class="n">knn</span><span class="p">,</span><span class="n">nb_neigh</span><span class="o">=</span><span class="n">nb_neigh</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">p</span><span class="o">=</span><span class="n">p</span><span class="p">,</span><span class="n">sphere_nb_samp</span><span class="o">=</span><span class="n">sphere_nb_samp</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">barycenters</span>



<span class="k">def</span> <span class="nf">lin_interp_m</span><span class="p">(</span><span class="n">im</span><span class="p">,</span><span class="n">pos_field</span><span class="p">,</span><span class="n">target_pos</span><span class="p">,</span><span class="n">nb_components</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span><span class="n">nb_neigh</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span><span class="n">coeff</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">comp_cube</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">p</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span><span class="n">knn</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="kn">from</span> <span class="nn">utils</span> <span class="k">import</span> <span class="n">cube_svd</span>
    <span class="kn">from</span> <span class="nn">pyflann</span> <span class="k">import</span> <span class="n">FLANN</span>
    <span class="kn">from</span> <span class="nn">numpy</span> <span class="k">import</span> <span class="n">zeros</span><span class="p">,</span><span class="n">transpose</span><span class="p">,</span><span class="n">diag</span>
    <span class="kn">import</span> <span class="nn">time</span>

    <span class="k">if</span> <span class="n">knn</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">knn</span> <span class="o">=</span> <span class="n">FLANN</span><span class="p">()</span>
        <span class="n">params</span> <span class="o">=</span> <span class="n">knn</span><span class="o">.</span><span class="n">build_index</span><span class="p">(</span><span class="n">array</span><span class="p">(</span><span class="n">pos_field</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">float64</span><span class="p">))</span>


    <span class="c1"># Computing the weights</span>
    <span class="n">result</span><span class="p">,</span> <span class="n">dists</span> <span class="o">=</span> <span class="n">knn</span><span class="o">.</span><span class="n">nn_index</span><span class="p">(</span><span class="n">target_pos</span><span class="p">,</span> <span class="n">nb_neigh</span><span class="p">)</span>

    <span class="n">weights</span> <span class="o">=</span> <span class="n">diag</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="n">dists</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="n">p</span><span class="p">),</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">dists</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="n">p</span><span class="p">))</span>


    <span class="k">if</span> <span class="n">coeff</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">comp_cube</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">coeff</span><span class="p">,</span><span class="n">comp_cube</span><span class="p">,</span><span class="n">approx_cube</span> <span class="o">=</span> <span class="n">cube_svd</span><span class="p">(</span><span class="n">im</span><span class="p">,</span><span class="n">nb_comp</span><span class="o">=</span><span class="n">nb_components</span><span class="p">,</span><span class="n">mean_sub</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>


    <span class="n">shap</span> <span class="o">=</span> <span class="n">im</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">nb_targets</span> <span class="o">=</span> <span class="n">target_pos</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">barycenters</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">nb_targets</span><span class="p">))</span>
    <span class="n">tmean</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_targets</span><span class="p">):</span>
        <span class="nb">print</span> <span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;th PSF/&quot;</span><span class="p">,</span><span class="n">nb_targets</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">temp</span> <span class="o">=</span> <span class="n">comp_cube</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="nb">min</span><span class="p">(</span><span class="n">nb_components</span><span class="p">,</span><span class="n">shap</span><span class="p">[</span><span class="mi">2</span><span class="p">])))</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">coeff</span><span class="p">[:,</span><span class="n">result</span><span class="p">[</span><span class="n">i</span><span class="p">,:]]</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">weights</span><span class="p">[</span><span class="n">i</span><span class="p">,:]</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">nb_neigh</span><span class="p">,</span><span class="mi">1</span><span class="p">))))</span>
        <span class="n">tmean</span><span class="o">+=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">t</span>
        <span class="n">barycenters</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">temp</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
    <span class="nb">print</span> <span class="s2">&quot;Elapsed time: &quot;</span><span class="p">,</span><span class="n">tmean</span><span class="o">/</span><span class="n">nb_targets</span>
    <span class="k">return</span> <span class="n">barycenters</span><span class="p">,</span><span class="n">coeff</span><span class="p">,</span><span class="n">comp_cube</span><span class="p">,</span><span class="n">knn</span>



<span class="k">def</span> <span class="nf">lin_interp_m2</span><span class="p">(</span><span class="n">im</span><span class="p">,</span><span class="n">pos_field</span><span class="p">,</span><span class="n">target_pos</span><span class="p">,</span><span class="n">nb_components</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span><span class="n">nb_neigh</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">coeff</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">comp_cube</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>

    <span class="kn">from</span> <span class="nn">numpy</span> <span class="k">import</span> <span class="n">zeros</span>
    <span class="n">shap</span> <span class="o">=</span> <span class="n">im</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">nb_points</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">nb_neigh</span><span class="p">)</span>
    <span class="n">barycenters</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>


    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_points</span><span class="p">):</span>
        <span class="n">bar_i</span><span class="p">,</span><span class="n">coeff</span><span class="p">,</span><span class="n">comp_cube</span><span class="p">,</span><span class="n">knn</span> <span class="o">=</span> <span class="n">lin_interp_m</span><span class="p">(</span><span class="n">im</span><span class="p">,</span><span class="n">pos_field</span><span class="p">,</span><span class="n">target_pos</span><span class="p">,</span><span class="n">nb_components</span><span class="o">=</span><span class="n">nb_components</span><span class="p">,</span><span class="n">nb_neigh</span><span class="o">=</span><span class="n">nb_neigh</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">coeff</span><span class="o">=</span><span class="n">coeff</span><span class="p">,</span><span class="n">comp_cube</span><span class="o">=</span><span class="n">comp_cube</span><span class="p">)</span>
        <span class="n">barycenters</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">bar_i</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">barycenters</span>


<span class="k">def</span> <span class="nf">extract_samp</span><span class="p">(</span><span class="n">pos_ind</span><span class="p">,</span><span class="n">nb_samp</span><span class="p">):</span>
    <span class="kn">from</span> <span class="nn">numpy.random</span> <span class="k">import</span> <span class="n">choice</span>
    <span class="kn">from</span> <span class="nn">numpy</span> <span class="k">import</span> <span class="n">arange</span><span class="p">,</span><span class="n">sort</span>
    <span class="n">total</span> <span class="o">=</span> <span class="n">pos_ind</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">samp</span> <span class="o">=</span> <span class="n">choice</span><span class="p">(</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">total</span><span class="p">),</span><span class="n">size</span><span class="o">=</span><span class="n">nb_samp</span><span class="p">,</span><span class="n">replace</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">density</span> <span class="o">=</span> <span class="n">nb_samp</span><span class="o">/</span><span class="p">((</span><span class="n">pos_ind</span><span class="p">[</span><span class="n">samp</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">-</span><span class="n">pos_ind</span><span class="p">[</span><span class="n">samp</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">())</span><span class="o">*</span><span class="p">(</span><span class="n">pos_ind</span><span class="p">[</span><span class="n">samp</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">-</span><span class="n">pos_ind</span><span class="p">[</span><span class="n">samp</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">()))</span>
    <span class="k">return</span> <span class="n">samp</span><span class="p">,</span><span class="n">density</span>


<span class="k">def</span> <span class="nf">extract_samp_m</span><span class="p">(</span><span class="n">pos_ind</span><span class="p">,</span><span class="n">nb_samp</span><span class="p">,</span><span class="n">nb_real</span><span class="p">):</span>
    <span class="kn">from</span> <span class="nn">numpy</span> <span class="k">import</span> <span class="n">zeros</span>
    <span class="n">samp</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">nb_samp</span><span class="p">,</span><span class="n">nb_real</span><span class="p">))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
    <span class="nb">id</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
    <span class="n">density</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_real</span><span class="p">):</span>
        <span class="n">samp</span><span class="p">[:,</span><span class="n">i</span><span class="p">],</span><span class="n">density_i</span> <span class="o">=</span> <span class="n">extract_samp</span><span class="p">(</span><span class="n">pos_ind</span><span class="p">,</span><span class="n">nb_samp</span><span class="p">)</span>
        <span class="n">density</span> <span class="o">+=</span> <span class="n">density_i</span>
        <span class="nb">id</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">nb_samp</span><span class="p">)</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>
    <span class="n">density</span> <span class="o">/=</span> <span class="n">nb_real</span>

    <span class="k">return</span> <span class="n">samp</span><span class="p">,</span><span class="n">density</span><span class="p">,</span><span class="nb">id</span>

<span class="k">def</span> <span class="nf">extract_samp_m2</span><span class="p">(</span><span class="n">pos_ind</span><span class="p">,</span><span class="n">nb_samp</span><span class="p">,</span><span class="n">nb_real</span><span class="p">):</span>
    <span class="kn">from</span> <span class="nn">numpy</span> <span class="k">import</span> <span class="n">zeros</span>
    <span class="n">density</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">size</span><span class="p">(</span><span class="n">nb_real</span><span class="p">),))</span>
    <span class="n">samp</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
    <span class="nb">id</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">size</span><span class="p">(</span><span class="n">nb_samp</span><span class="p">)):</span>
        <span class="n">samp_i</span><span class="p">,</span><span class="n">density</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">id_i</span> <span class="o">=</span> <span class="n">extract_samp_m</span><span class="p">(</span><span class="n">pos_ind</span><span class="p">,</span><span class="n">nb_samp</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">nb_real</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        <span class="n">samp</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">samp_i</span><span class="p">)</span>
        <span class="nb">id</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">id_i</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">samp</span><span class="p">,</span><span class="n">density</span><span class="p">,</span><span class="nb">id</span>

<span class="k">def</span> <span class="nf">psfex_interf</span><span class="p">(</span><span class="n">samp</span><span class="p">,</span><span class="n">data</span><span class="p">,</span><span class="n">ref_pos</span><span class="p">,</span><span class="n">target_pos</span><span class="p">,</span><span class="n">PSF_SAMPLING</span><span class="p">,</span><span class="n">detect_thresh</span><span class="p">,</span><span class="n">sig</span><span class="p">,</span><span class="n">resol</span><span class="p">,</span><span class="n">var_deg</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span><span class="nb">dir</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="kn">from</span> <span class="nn">psfex_utils</span> <span class="k">import</span> <span class="n">psfextractor_2</span>
    <span class="kn">from</span> <span class="nn">numpy</span> <span class="k">import</span> <span class="n">array</span><span class="p">,</span><span class="n">ndarray</span>
    <span class="n">shap</span> <span class="o">=</span> <span class="n">array</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
    <span class="nb">print</span> <span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">shap</span><span class="o">*=</span><span class="n">PSF_SAMPLING</span>
    <span class="n">output_est</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">nb_samp</span> <span class="o">=</span> <span class="n">target_pos</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">samp</span><span class="p">)</span> <span class="ow">is</span> <span class="n">ndarray</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">size</span><span class="p">(</span><span class="n">shape</span><span class="p">(</span><span class="n">samp</span><span class="p">))</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">src</span><span class="p">,</span><span class="n">output_est</span><span class="p">,</span><span class="n">resi</span><span class="p">,</span><span class="n">hdu</span> <span class="o">=</span> <span class="n">psfextractor_2</span><span class="p">(</span><span class="n">PSF_SAMPLING</span><span class="p">,</span><span class="n">detect_thresh</span><span class="p">,</span><span class="n">data</span><span class="p">[:,:,</span><span class="n">samp</span><span class="p">],</span><span class="n">ref_pos</span><span class="p">[</span><span class="n">samp</span><span class="p">,:],</span><span class="n">sig</span><span class="p">,</span><span class="n">resol</span><span class="p">,</span><span class="n">var_deg</span><span class="o">=</span><span class="n">var_deg</span><span class="p">,</span><span class="nb">dir</span><span class="o">=</span><span class="nb">dir</span><span class="p">,</span><span class="n">target_pos</span><span class="o">=</span><span class="n">target_pos</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">output_est</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">target_pos</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">samp</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">samp</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
                <span class="n">src</span><span class="p">,</span><span class="n">output_est</span><span class="p">[:,:,:,</span><span class="n">i</span><span class="p">],</span><span class="n">resi</span><span class="p">,</span><span class="n">hdu</span> <span class="o">=</span> <span class="n">psfextractor_2</span><span class="p">(</span><span class="n">PSF_SAMPLING</span><span class="p">,</span><span class="n">detect_thresh</span><span class="p">,</span><span class="n">data</span><span class="p">[:,:,</span><span class="n">samp</span><span class="p">[:,</span><span class="n">i</span><span class="p">]],</span><span class="n">ref_pos</span><span class="p">[</span><span class="n">samp</span><span class="p">[:,</span><span class="n">i</span><span class="p">],:],</span><span class="n">sig</span><span class="p">,</span><span class="n">resol</span><span class="p">,</span><span class="n">var_deg</span><span class="o">=</span><span class="n">var_deg</span><span class="p">,</span><span class="nb">dir</span><span class="o">=</span><span class="nb">dir</span><span class="p">,</span><span class="n">target_pos</span><span class="o">=</span><span class="n">target_pos</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span> <span class="c1"># samp has to be a list</span>
        <span class="n">output_est</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">samp</span><span class="p">)):</span>
            <span class="n">output_est</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">psfex_interf</span><span class="p">(</span><span class="n">samp</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">data</span><span class="p">,</span><span class="n">ref_pos</span><span class="p">,</span><span class="n">target_pos</span><span class="p">,</span><span class="n">PSF_SAMPLING</span><span class="p">,</span><span class="n">detect_thresh</span><span class="p">,</span><span class="n">sig</span><span class="p">,</span><span class="n">resol</span><span class="p">,</span><span class="n">var_deg</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span><span class="nb">dir</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">output_est</span>

<span class="k">def</span> <span class="nf">rbf_stack_2mbis</span><span class="p">(</span><span class="n">samp</span><span class="p">,</span><span class="n">data</span><span class="p">,</span><span class="n">pos_data</span><span class="p">,</span><span class="n">target_pos</span><span class="p">,</span><span class="n">nb_neigh</span><span class="p">,</span><span class="n">nb_comp</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span><span class="n">knn</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="kn">from</span> <span class="nn">numpy</span> <span class="k">import</span> <span class="n">array</span><span class="p">,</span><span class="n">ndarray</span>
    <span class="n">shap</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">output_est</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">samp</span><span class="p">)</span> <span class="ow">is</span> <span class="n">ndarray</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">size</span><span class="p">(</span><span class="n">shape</span><span class="p">(</span><span class="n">samp</span><span class="p">))</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">output_est</span> <span class="o">=</span> <span class="n">rbf_stack_2</span><span class="p">(</span><span class="n">data</span><span class="p">[:,:,</span><span class="n">samp</span><span class="p">],</span><span class="n">pos_data</span><span class="p">[</span><span class="n">samp</span><span class="p">,],</span><span class="n">target_pos</span><span class="p">,</span><span class="nb">min</span><span class="p">(</span><span class="n">nb_neigh</span><span class="p">,</span><span class="n">size</span><span class="p">(</span><span class="n">samp</span><span class="p">)),</span><span class="n">nb_comp</span><span class="o">=</span><span class="n">nb_comp</span><span class="p">,</span><span class="n">knn</span><span class="o">=</span><span class="n">knn</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">output_est</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">target_pos</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">samp</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">samp</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
                <span class="n">output_est</span><span class="p">[:,:,:,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">rbf_stack_2</span><span class="p">(</span><span class="n">data</span><span class="p">[:,:,</span><span class="n">samp</span><span class="p">[:,</span><span class="n">i</span><span class="p">]],</span><span class="n">pos_data</span><span class="p">[</span><span class="n">samp</span><span class="p">[:,</span><span class="n">i</span><span class="p">],],</span><span class="n">target_pos</span><span class="p">,</span><span class="nb">min</span><span class="p">(</span><span class="n">nb_neigh</span><span class="p">,</span><span class="n">samp</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span><span class="n">nb_comp</span><span class="o">=</span><span class="n">nb_comp</span><span class="p">,</span><span class="n">knn</span><span class="o">=</span><span class="n">knn</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span> <span class="c1"># samp has to be a list</span>
        <span class="n">output_est</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">samp</span><span class="p">)):</span>
            <span class="nb">print</span> <span class="s2">&quot;Nb samples: &quot;</span><span class="p">,</span><span class="n">samp</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">output_est</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rbf_stack_2mbis</span><span class="p">(</span><span class="n">samp</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">data</span><span class="p">,</span><span class="n">pos_data</span><span class="p">,</span><span class="n">target_pos</span><span class="p">,</span><span class="n">nb_neigh</span><span class="p">,</span><span class="n">nb_comp</span><span class="o">=</span><span class="n">nb_comp</span><span class="p">,</span><span class="n">knn</span><span class="o">=</span><span class="n">knn</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">output_est</span>

<span class="k">def</span> <span class="nf">lin_interp_m2bis</span><span class="p">(</span><span class="n">samp</span><span class="p">,</span><span class="n">im</span><span class="p">,</span><span class="n">pos_field</span><span class="p">,</span><span class="n">target_pos</span><span class="p">,</span><span class="n">nb_components</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span><span class="n">nb_neigh</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span><span class="n">coeff</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">comp_cube</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">p</span><span class="o">=</span><span class="mi">2</span><span class="p">):</span>
    <span class="kn">from</span> <span class="nn">numpy</span> <span class="k">import</span> <span class="n">array</span><span class="p">,</span><span class="n">ndarray</span>
    <span class="n">shap</span> <span class="o">=</span> <span class="n">im</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">output_est</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">samp</span><span class="p">)</span> <span class="ow">is</span> <span class="n">ndarray</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">size</span><span class="p">(</span><span class="n">shape</span><span class="p">(</span><span class="n">samp</span><span class="p">))</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">output_est</span><span class="p">,</span><span class="n">coeff</span><span class="p">,</span><span class="n">comp_cube</span><span class="p">,</span><span class="n">knn</span> <span class="o">=</span> <span class="n">lin_interp_m</span><span class="p">(</span><span class="n">im</span><span class="p">[:,:,</span><span class="n">samp</span><span class="p">],</span><span class="n">pos_field</span><span class="p">[</span><span class="n">samp</span><span class="p">,:],</span><span class="n">target_pos</span><span class="p">,</span><span class="n">nb_components</span><span class="o">=</span><span class="n">nb_components</span><span class="p">,</span><span class="n">nb_neigh</span><span class="o">=</span><span class="nb">min</span><span class="p">(</span><span class="n">nb_neigh</span><span class="p">,</span><span class="n">size</span><span class="p">(</span><span class="n">samp</span><span class="p">)),</span><span class="n">p</span><span class="o">=</span><span class="n">p</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">output_est</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">target_pos</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">samp</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">samp</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
                <span class="n">output_est</span><span class="p">[:,:,:,</span><span class="n">i</span><span class="p">],</span><span class="n">coeff</span><span class="p">,</span><span class="n">comp_cube</span><span class="p">,</span><span class="n">knn</span> <span class="o">=</span> <span class="n">lin_interp_m</span><span class="p">(</span><span class="n">im</span><span class="p">[:,:,</span><span class="n">samp</span><span class="p">[:,</span><span class="n">i</span><span class="p">]],</span><span class="n">pos_field</span><span class="p">[</span><span class="n">samp</span><span class="p">[:,</span><span class="n">i</span><span class="p">],:],</span><span class="n">target_pos</span><span class="p">,</span><span class="n">nb_components</span><span class="o">=</span><span class="n">nb_components</span><span class="p">,</span><span class="n">nb_neigh</span><span class="o">=</span><span class="nb">min</span><span class="p">(</span><span class="n">nb_neigh</span><span class="p">,</span><span class="n">samp</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span><span class="n">p</span><span class="o">=</span><span class="n">p</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span> <span class="c1"># samp has to be a list</span>
        <span class="n">output_est</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">samp</span><span class="p">)):</span>
            <span class="n">output_est</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">lin_interp_m2bis</span><span class="p">(</span><span class="n">samp</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">im</span><span class="p">,</span><span class="n">pos_field</span><span class="p">,</span><span class="n">target_pos</span><span class="p">,</span><span class="n">nb_components</span><span class="o">=</span><span class="n">nb_components</span><span class="p">,</span><span class="n">nb_neigh</span><span class="o">=</span><span class="n">nb_neigh</span><span class="p">,</span><span class="n">p</span><span class="o">=</span><span class="mi">2</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">output_est</span>

<span class="k">def</span> <span class="nf">local_sliced_euc_bar_interface_m</span><span class="p">(</span><span class="n">stack</span><span class="p">,</span><span class="n">samp</span><span class="p">,</span><span class="n">dist_mat</span><span class="p">,</span><span class="n">pos_ref</span><span class="p">,</span><span class="n">target_ref</span><span class="p">,</span><span class="n">local_dim</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span><span class="n">nb_neigh_inv_map</span><span class="o">=</span><span class="mi">11</span><span class="p">):</span>
    <span class="kn">from</span> <span class="nn">numpy</span> <span class="k">import</span> <span class="n">ndarray</span><span class="p">,</span><span class="n">ones</span><span class="p">,</span><span class="n">transpose</span>
    <span class="kn">from</span> <span class="nn">pyflann</span> <span class="k">import</span> <span class="n">FLANN</span>
    <span class="n">output_est</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">shap</span> <span class="o">=</span> <span class="n">stack</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">nb_samp</span> <span class="o">=</span> <span class="n">target_ref</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">samp</span><span class="p">)</span> <span class="ow">is</span> <span class="n">ndarray</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">size</span><span class="p">(</span><span class="n">shape</span><span class="p">(</span><span class="n">samp</span><span class="p">))</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">ind</span> <span class="o">=</span> <span class="n">samp</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">size</span><span class="p">(</span><span class="n">samp</span><span class="p">),</span><span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">ones</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span><span class="n">size</span><span class="p">(</span><span class="n">samp</span><span class="p">))))</span>
            <span class="n">ind</span> <span class="o">=</span> <span class="n">ind</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
            <span class="n">knn</span> <span class="o">=</span> <span class="n">FLANN</span><span class="p">()</span>
            <span class="n">params</span> <span class="o">=</span> <span class="n">knn</span><span class="o">.</span><span class="n">build_index</span><span class="p">(</span><span class="n">array</span><span class="p">(</span><span class="n">pos_ref</span><span class="p">[</span><span class="n">samp</span><span class="p">,:],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">float64</span><span class="p">))</span>
            <span class="n">neighborhood</span><span class="p">,</span> <span class="n">dists</span> <span class="o">=</span> <span class="n">knn</span><span class="o">.</span><span class="n">nn_index</span><span class="p">(</span><span class="n">target_ref</span><span class="p">,</span> <span class="nb">min</span><span class="p">(</span><span class="mi">30</span><span class="p">,</span><span class="n">size</span><span class="p">(</span><span class="n">samp</span><span class="p">)))</span>
            <span class="n">output_est</span> <span class="o">=</span> <span class="n">local_euclidean_bar</span><span class="p">(</span><span class="n">stack</span><span class="p">[:,:,</span><span class="n">samp</span><span class="p">],</span><span class="n">dist_mat</span><span class="p">[</span><span class="n">ind</span><span class="p">,</span><span class="n">transpose</span><span class="p">(</span><span class="n">ind</span><span class="p">)],</span><span class="n">neighborhood</span><span class="p">,</span><span class="n">pos_ref</span><span class="p">[</span><span class="n">samp</span><span class="p">,:],</span><span class="n">target_ref</span><span class="p">,</span><span class="n">local_dim</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span><span class="n">nb_neigh_inv_map</span><span class="o">=</span><span class="n">nb_neigh_inv_map</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">output_est</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">target_ref</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">samp</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">samp</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
                <span class="n">ind</span> <span class="o">=</span> <span class="n">samp</span><span class="p">[:,</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">samp</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">ones</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span><span class="n">samp</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])))</span>
                <span class="n">ind</span> <span class="o">=</span> <span class="n">ind</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
                <span class="n">knn</span> <span class="o">=</span> <span class="n">FLANN</span><span class="p">()</span>
                <span class="n">params</span> <span class="o">=</span> <span class="n">knn</span><span class="o">.</span><span class="n">build_index</span><span class="p">(</span><span class="n">array</span><span class="p">(</span><span class="n">pos_ref</span><span class="p">[</span><span class="n">samp</span><span class="p">[:,</span><span class="n">i</span><span class="p">],:],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">float64</span><span class="p">))</span>
                <span class="n">neighborhood</span><span class="p">,</span> <span class="n">dists</span> <span class="o">=</span> <span class="n">knn</span><span class="o">.</span><span class="n">nn_index</span><span class="p">(</span><span class="n">target_ref</span><span class="p">,</span> <span class="nb">min</span><span class="p">(</span><span class="mi">30</span><span class="p">,</span><span class="n">samp</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
                <span class="n">output_est</span><span class="p">[:,:,:,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span><span class="n">local_euclidean_bar</span><span class="p">(</span><span class="n">stack</span><span class="p">[:,:,</span><span class="n">samp</span><span class="p">[:,</span><span class="n">i</span><span class="p">]],</span><span class="n">dist_mat</span><span class="p">[</span><span class="n">ind</span><span class="p">,</span><span class="n">transpose</span><span class="p">(</span><span class="n">ind</span><span class="p">)],</span><span class="n">neighborhood</span><span class="p">,</span><span class="n">pos_ref</span><span class="p">[</span><span class="n">samp</span><span class="p">[:,</span><span class="n">i</span><span class="p">],:],</span><span class="n">target_ref</span><span class="p">,</span><span class="n">local_dim</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span><span class="n">nb_neigh_inv_map</span><span class="o">=</span><span class="n">nb_neigh_inv_map</span><span class="p">)</span>
                <span class="nb">print</span> <span class="s2">&quot;l1 norm: &quot;</span><span class="p">,</span><span class="nb">sum</span><span class="p">(</span><span class="n">output_est</span><span class="p">[:,:,:,</span><span class="n">i</span><span class="p">])</span>
    <span class="k">else</span><span class="p">:</span> <span class="c1"># samp has to be a list</span>
        <span class="n">output_est</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">samp</span><span class="p">)):</span>
            <span class="n">output_est</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">local_sliced_euc_bar_interface_m</span><span class="p">(</span><span class="n">stack</span><span class="p">,</span><span class="n">samp</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">dist_mat</span><span class="p">,</span><span class="n">pos_ref</span><span class="p">,</span><span class="n">target_ref</span><span class="p">,</span><span class="n">local_dim</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span><span class="n">nb_neigh_inv_map</span><span class="o">=</span><span class="n">nb_neigh_inv_map</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">output_est</span>

<span class="k">def</span> <span class="nf">local_sliced_euc_bar_interface_m_ext</span><span class="p">(</span><span class="n">stack</span><span class="p">,</span><span class="n">samp</span><span class="p">,</span><span class="n">pos_ref</span><span class="p">,</span><span class="n">target_ref</span><span class="p">,</span><span class="n">local_dim</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span><span class="n">nb_neigh_inv_map</span><span class="o">=</span><span class="mi">11</span><span class="p">):</span>
    <span class="kn">from</span> <span class="nn">numpy</span> <span class="k">import</span> <span class="n">zeros</span><span class="p">,</span><span class="n">squeeze</span>
    <span class="kn">from</span> <span class="nn">optim_utils</span> <span class="k">import</span> <span class="n">dist_map</span>

    <span class="n">shap</span> <span class="o">=</span> <span class="n">stack</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">nb_real</span> <span class="o">=</span> <span class="n">stack</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
    <span class="n">output</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">target_ref</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">nb_real</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_real</span><span class="p">):</span>
        <span class="n">dist_mat</span> <span class="o">=</span> <span class="n">dist_map</span><span class="p">(</span><span class="n">stack</span><span class="p">[:,:,:,</span><span class="n">i</span><span class="p">])</span>
        <span class="n">output</span><span class="p">[:,:,:,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">squeeze</span><span class="p">(</span><span class="n">local_sliced_euc_bar_interface_m</span><span class="p">(</span><span class="n">stack</span><span class="p">[:,:,:,</span><span class="n">i</span><span class="p">],</span><span class="n">samp</span><span class="p">,</span><span class="n">dist_mat</span><span class="p">,</span><span class="n">pos_ref</span><span class="p">,</span><span class="n">target_ref</span><span class="p">,</span><span class="n">local_dim</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span><span class="n">nb_neigh_inv_map</span><span class="o">=</span><span class="mi">11</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">output</span>


<span class="k">def</span> <span class="nf">local_sliced_transport_bar_interface_2m</span><span class="p">(</span><span class="n">stack</span><span class="p">,</span><span class="n">samp</span><span class="p">,</span><span class="n">pos_ref</span><span class="p">,</span><span class="n">target_ref</span><span class="p">,</span><span class="n">nb_iter</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span><span class="n">local_dim</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span><span class="n">nb_neigh_inv_map</span><span class="o">=</span><span class="mi">11</span><span class="p">,</span><span class="n">output_path</span><span class="o">=</span><span class="s1">&#39;../../../Data/Result_interp/&#39;</span><span class="p">,</span><span class="nb">id</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">list_dist_mat</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">cent</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">theta_en</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="kn">from</span> <span class="nn">numpy</span> <span class="k">import</span> <span class="n">ndarray</span><span class="p">,</span><span class="n">ones</span><span class="p">,</span><span class="n">transpose</span><span class="p">,</span><span class="n">zeros</span>
    <span class="kn">from</span> <span class="nn">optim_utils</span> <span class="k">import</span> <span class="n">max_gap</span>
    <span class="kn">from</span> <span class="nn">pyflann</span> <span class="k">import</span> <span class="n">FLANN</span>

    <span class="n">output_est</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">shap</span> <span class="o">=</span> <span class="n">stack</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">nb_samp</span> <span class="o">=</span> <span class="n">target_ref</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="c1">#gap,inear,jnear,dist_mat_temp = max_gap(stack,pos_ref,tol=0.001,nb_neigh=10,max_val =2**63,dist_mat=None)</span>
    <span class="n">dist_out</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">samp</span><span class="p">)</span> <span class="ow">is</span> <span class="n">ndarray</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">size</span><span class="p">(</span><span class="n">shape</span><span class="p">(</span><span class="n">samp</span><span class="p">))</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">knn</span> <span class="o">=</span> <span class="n">FLANN</span><span class="p">()</span>
            <span class="n">params</span> <span class="o">=</span> <span class="n">knn</span><span class="o">.</span><span class="n">build_index</span><span class="p">(</span><span class="n">array</span><span class="p">(</span><span class="n">pos_ref</span><span class="p">[</span><span class="n">samp</span><span class="p">,:],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">float64</span><span class="p">))</span>
            <span class="n">neighborhood</span><span class="p">,</span> <span class="n">dists</span> <span class="o">=</span> <span class="n">knn</span><span class="o">.</span><span class="n">nn_index</span><span class="p">(</span><span class="n">target_ref</span><span class="p">,</span> <span class="nb">min</span><span class="p">(</span><span class="mi">30</span><span class="p">,</span><span class="n">size</span><span class="p">(</span><span class="n">samp</span><span class="p">)))</span>
            <span class="c1">#ind = samp.reshape((size(samp),1)).dot(ones((1,size(samp))))</span>
            <span class="c1">#ind = ind.astype(int)</span>
            <span class="n">dist_mat_in</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="n">list_dist_mat</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">dist_out</span> <span class="o">=</span> <span class="n">list_dist_mat</span>
                <span class="n">gap</span><span class="p">,</span><span class="n">inear</span><span class="p">,</span><span class="n">jnear</span><span class="p">,</span><span class="n">dist_mat_temp</span> <span class="o">=</span> <span class="n">max_gap</span><span class="p">(</span><span class="n">stack</span><span class="p">[:,:,</span><span class="n">samp</span><span class="p">],</span><span class="n">pos_ref</span><span class="p">[</span><span class="n">samp</span><span class="p">,:],</span><span class="n">tol</span><span class="o">=</span><span class="mf">0.001</span><span class="p">,</span><span class="n">nb_neigh</span><span class="o">=</span><span class="nb">min</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="n">size</span><span class="p">(</span><span class="n">samp</span><span class="p">)),</span><span class="n">max_val</span> <span class="o">=</span><span class="mi">2</span><span class="o">**</span><span class="mi">63</span><span class="p">,</span><span class="n">dist_mat</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">pol_en</span><span class="o">=</span><span class="n">theta_en</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">dist_out</span><span class="p">,</span><span class="n">neighborhood</span><span class="p">,</span><span class="n">gap</span> <span class="o">=</span> <span class="n">dist_wasserstein_map</span><span class="p">(</span><span class="n">stack</span><span class="p">[:,:,</span><span class="n">samp</span><span class="p">],</span><span class="n">pos_ref</span><span class="p">[</span><span class="n">samp</span><span class="p">,:],</span><span class="n">target_ref</span><span class="p">,</span><span class="n">gap</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">max_val</span><span class="o">=</span><span class="mi">2</span><span class="o">**</span><span class="mi">63</span><span class="p">,</span><span class="n">nb_neigh</span><span class="o">=</span><span class="nb">min</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span><span class="n">size</span><span class="p">(</span><span class="n">samp</span><span class="p">)),</span><span class="n">nb_real</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span><span class="n">tol</span><span class="o">=</span><span class="mf">1.e-20</span><span class="p">,</span><span class="n">nb_iter</span><span class="o">=</span><span class="n">nb_iter</span><span class="p">,</span><span class="n">smart_init_en</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span><span class="n">rad</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span><span class="n">rand</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">cent</span><span class="o">=</span><span class="n">cent</span><span class="p">,</span><span class="n">theta_en</span><span class="o">=</span><span class="n">theta_en</span><span class="p">)</span>
            <span class="n">output_est</span> <span class="o">=</span> <span class="n">local_sliced_transport_bar_interface_2</span><span class="p">(</span><span class="n">stack</span><span class="p">[:,:,</span><span class="n">samp</span><span class="p">],</span><span class="n">gap</span><span class="p">,</span><span class="n">dist_out</span><span class="p">,</span><span class="n">neighborhood</span><span class="p">,</span><span class="n">pos_ref</span><span class="p">[</span><span class="n">samp</span><span class="p">,:],</span><span class="n">target_ref</span><span class="p">,</span><span class="n">nb_iter</span><span class="o">=</span><span class="n">nb_iter</span><span class="p">,</span><span class="n">local_dim</span><span class="o">=</span><span class="n">local_dim</span><span class="p">,</span><span class="n">nb_neigh_inv_map</span><span class="o">=</span><span class="n">nb_neigh_inv_map</span><span class="p">,</span><span class="n">output_path</span><span class="o">=</span><span class="n">output_path</span><span class="p">,</span><span class="nb">id</span><span class="o">=</span><span class="nb">id</span><span class="p">,</span><span class="n">cent</span><span class="o">=</span><span class="n">cent</span><span class="p">,</span><span class="n">theta_en</span><span class="o">=</span><span class="n">theta_en</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">output_est</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">shap</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">shap</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">target_ref</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">samp</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
            <span class="k">if</span> <span class="n">list_dist_mat</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">dist_out</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">samp</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">samp</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">samp</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">samp</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
                <span class="c1">#ind = samp[:,i].reshape((samp.shape[0],1)).dot(ones((1,samp.shape[0])))</span>
                <span class="c1">#ind = ind.astype(int)</span>
                <span class="n">dist_mat_in</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">if</span> <span class="n">list_dist_mat</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">dist_mat_in</span> <span class="o">=</span> <span class="n">list_dist_mat</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">]</span>
                    <span class="n">knn</span> <span class="o">=</span> <span class="n">FLANN</span><span class="p">()</span>
                    <span class="n">params</span> <span class="o">=</span> <span class="n">knn</span><span class="o">.</span><span class="n">build_index</span><span class="p">(</span><span class="n">array</span><span class="p">(</span><span class="n">pos_ref</span><span class="p">[</span><span class="n">samp</span><span class="p">[:,</span><span class="n">i</span><span class="p">],:],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">float64</span><span class="p">))</span>
                    <span class="n">neighborhood</span><span class="p">,</span> <span class="n">dists</span> <span class="o">=</span> <span class="n">knn</span><span class="o">.</span><span class="n">nn_index</span><span class="p">(</span><span class="n">target_ref</span><span class="p">,</span> <span class="nb">min</span><span class="p">(</span><span class="mi">30</span><span class="p">,</span><span class="n">samp</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
                    <span class="n">gap</span><span class="p">,</span><span class="n">inear</span><span class="p">,</span><span class="n">jnear</span><span class="p">,</span><span class="n">dist_mat_temp</span> <span class="o">=</span> <span class="n">max_gap</span><span class="p">(</span><span class="n">stack</span><span class="p">[:,:,</span><span class="n">samp</span><span class="p">[:,</span><span class="n">i</span><span class="p">]],</span><span class="n">pos_ref</span><span class="p">[</span><span class="n">samp</span><span class="p">[:,</span><span class="n">i</span><span class="p">],:],</span><span class="n">tol</span><span class="o">=</span><span class="mf">0.001</span><span class="p">,</span><span class="n">nb_neigh</span><span class="o">=</span><span class="nb">min</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="n">samp</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span><span class="n">max_val</span> <span class="o">=</span><span class="mi">2</span><span class="o">**</span><span class="mi">63</span><span class="p">,</span><span class="n">dist_mat</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">pol_en</span><span class="o">=</span><span class="n">theta_en</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">dist_mat_in</span><span class="p">,</span><span class="n">neighborhood</span><span class="p">,</span><span class="n">gap</span> <span class="o">=</span> <span class="n">dist_wasserstein_map</span><span class="p">(</span><span class="n">stack</span><span class="p">[:,:,</span><span class="n">samp</span><span class="p">[:,</span><span class="n">i</span><span class="p">]],</span><span class="n">pos_ref</span><span class="p">[</span><span class="n">samp</span><span class="p">[:,</span><span class="n">i</span><span class="p">],:],</span><span class="n">target_ref</span><span class="p">,</span><span class="n">gap</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">max_val</span><span class="o">=</span><span class="mi">2</span><span class="o">**</span><span class="mi">63</span><span class="p">,</span><span class="n">nb_neigh</span><span class="o">=</span><span class="nb">min</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span><span class="n">samp</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span><span class="n">nb_real</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span><span class="n">tol</span><span class="o">=</span><span class="mf">1.e-20</span><span class="p">,</span><span class="n">nb_iter</span><span class="o">=</span><span class="n">nb_iter</span><span class="p">,</span><span class="n">smart_init_en</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span><span class="n">rad</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span><span class="n">rand</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">cent</span><span class="o">=</span><span class="n">cent</span><span class="p">,</span><span class="n">theta_en</span><span class="o">=</span><span class="n">theta_en</span><span class="p">)</span>
                    <span class="n">dist_out</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">dist_mat_in</span>

                <span class="n">output_est</span><span class="p">[:,:,:,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">local_sliced_transport_bar_interface_2</span><span class="p">(</span><span class="n">stack</span><span class="p">[:,:,</span><span class="n">samp</span><span class="p">[:,</span><span class="n">i</span><span class="p">]],</span><span class="n">gap</span><span class="p">,</span><span class="n">dist_mat_in</span><span class="p">,</span><span class="n">neighborhood</span><span class="p">,</span><span class="n">pos_ref</span><span class="p">[</span><span class="n">samp</span><span class="p">[:,</span><span class="n">i</span><span class="p">],],</span><span class="n">target_ref</span><span class="p">,</span><span class="n">nb_iter</span><span class="o">=</span><span class="n">nb_iter</span><span class="p">,</span><span class="n">local_dim</span><span class="o">=</span><span class="n">local_dim</span><span class="p">,</span><span class="n">nb_neigh_inv_map</span><span class="o">=</span><span class="n">nb_neigh_inv_map</span><span class="p">,</span><span class="n">output_path</span><span class="o">=</span><span class="n">output_path</span><span class="p">,</span><span class="nb">id</span><span class="o">=</span><span class="nb">id</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">cent</span><span class="o">=</span><span class="n">cent</span><span class="p">,</span><span class="n">theta_en</span><span class="o">=</span><span class="n">theta_en</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span> <span class="c1"># samp has to be a list</span>
        <span class="n">output_est</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="n">dist_out</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">list_dist_mat</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">dist_out</span> <span class="o">=</span> <span class="n">list_dist_mat</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">samp</span><span class="p">)):</span>
                <span class="n">output_est_i</span><span class="p">,</span><span class="n">dist_out_i</span> <span class="o">=</span> <span class="n">local_sliced_transport_bar_interface_2m</span><span class="p">(</span><span class="n">stack</span><span class="p">,</span><span class="n">samp</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">pos_ref</span><span class="p">,</span><span class="n">target_ref</span><span class="p">,</span><span class="n">nb_iter</span><span class="o">=</span><span class="n">nb_iter</span><span class="p">,</span><span class="n">local_dim</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span><span class="n">nb_neigh_inv_map</span><span class="o">=</span><span class="n">nb_neigh_inv_map</span><span class="p">,</span><span class="n">output_path</span><span class="o">=</span><span class="n">output_path</span><span class="p">,</span><span class="nb">id</span><span class="o">=</span><span class="nb">id</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">list_dist_mat</span><span class="o">=</span><span class="n">list_dist_mat</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">cent</span><span class="o">=</span><span class="n">cent</span><span class="p">,</span><span class="n">theta_en</span><span class="o">=</span><span class="n">theta_en</span><span class="p">)</span>
                <span class="n">output_est</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">output_est_i</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">samp</span><span class="p">)):</span>
                <span class="n">output_est_i</span><span class="p">,</span><span class="n">dist_out_i</span> <span class="o">=</span> <span class="n">local_sliced_transport_bar_interface_2m</span><span class="p">(</span><span class="n">stack</span><span class="p">,</span><span class="n">samp</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">pos_ref</span><span class="p">,</span><span class="n">target_ref</span><span class="p">,</span><span class="n">nb_iter</span><span class="o">=</span><span class="n">nb_iter</span><span class="p">,</span><span class="n">local_dim</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span><span class="n">nb_neigh_inv_map</span><span class="o">=</span><span class="n">nb_neigh_inv_map</span><span class="p">,</span><span class="n">output_path</span><span class="o">=</span><span class="n">output_path</span><span class="p">,</span><span class="nb">id</span><span class="o">=</span><span class="nb">id</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">cent</span><span class="o">=</span><span class="n">cent</span><span class="p">,</span><span class="n">theta_en</span><span class="o">=</span><span class="n">theta_en</span><span class="p">)</span>
                <span class="n">output_est</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">output_est_i</span><span class="p">)</span>
                <span class="n">dist_out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dist_out_i</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">output_est</span><span class="p">,</span><span class="n">dist_out</span>


<span class="k">def</span> <span class="nf">dist_wasserstein_map</span><span class="p">(</span><span class="n">im_stack</span><span class="p">,</span><span class="n">ref_pos</span><span class="p">,</span><span class="n">target_pos</span><span class="p">,</span><span class="n">gap</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">max_val</span><span class="o">=</span><span class="mf">1.e30</span><span class="p">,</span><span class="n">nb_neigh</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span><span class="n">nb_real</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span><span class="n">tol</span><span class="o">=</span><span class="mf">1.e-20</span><span class="p">,</span><span class="n">nb_iter</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span><span class="n">smart_init_en</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span><span class="n">rad</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span><span class="n">rand</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">cent</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">theta_en</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="kn">from</span> <span class="nn">numpy</span> <span class="k">import</span> <span class="n">ones</span><span class="p">,</span><span class="n">arange</span>
    <span class="kn">from</span> <span class="nn">optim_utils</span> <span class="k">import</span> <span class="n">sliced_transport</span><span class="p">,</span><span class="n">max_gap</span><span class="p">,</span><span class="n">setting_polar_2</span><span class="p">,</span><span class="n">setting_cart_from_polar_2</span>
    <span class="kn">from</span> <span class="nn">astropy.io</span> <span class="k">import</span> <span class="n">fits</span>
    <span class="kn">from</span> <span class="nn">utils</span> <span class="k">import</span> <span class="n">compute_centroid</span>


    <span class="n">knn</span> <span class="o">=</span> <span class="n">FLANN</span><span class="p">()</span>
    <span class="n">params</span> <span class="o">=</span> <span class="n">knn</span><span class="o">.</span><span class="n">build_index</span><span class="p">(</span><span class="n">ref_pos</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">float64</span><span class="p">)</span>
    <span class="n">neighborhood</span><span class="p">,</span> <span class="n">dists</span> <span class="o">=</span> <span class="n">knn</span><span class="o">.</span><span class="n">nn_index</span><span class="p">(</span><span class="n">target_pos</span><span class="p">,</span> <span class="n">nb_neigh</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">gap</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">gap</span><span class="p">,</span><span class="n">inear</span><span class="p">,</span><span class="n">jnear</span><span class="p">,</span><span class="n">dist_mat_temp</span> <span class="o">=</span> <span class="n">max_gap</span><span class="p">(</span><span class="n">im_stack</span><span class="p">,</span><span class="n">ref_pos</span><span class="p">,</span><span class="n">tol</span><span class="o">=</span><span class="mf">0.001</span><span class="p">,</span><span class="n">nb_neigh</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span><span class="n">max_val</span> <span class="o">=</span><span class="mi">2</span><span class="o">**</span><span class="mi">63</span><span class="p">,</span><span class="n">dist_mat</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">pol_en</span><span class="o">=</span><span class="n">theta_en</span><span class="p">)</span>

    <span class="n">nb_psf</span> <span class="o">=</span> <span class="n">im_stack</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">nb_target</span> <span class="o">=</span> <span class="n">target_pos</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">dist_mat</span> <span class="o">=</span> <span class="n">ones</span><span class="p">((</span><span class="n">nb_psf</span><span class="p">,</span><span class="n">nb_psf</span><span class="p">))</span><span class="o">*</span><span class="n">max_val</span>
    <span class="n">ind</span> <span class="o">=</span> <span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_psf</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
    <span class="n">dist_mat</span><span class="p">[</span><span class="n">ind</span><span class="p">,</span><span class="n">ind</span><span class="p">]</span> <span class="o">*=</span> <span class="mi">0</span>
    <span class="n">pt_clouds</span> <span class="o">=</span> <span class="n">cube_to_point_cloud</span><span class="p">(</span><span class="n">im_stack</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">theta_en</span><span class="p">:</span>
        <span class="nb">print</span> <span class="s2">&quot;--- Polar coordinates are being used ---&quot;</span>
        <span class="k">if</span> <span class="n">cent</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">im_mean</span> <span class="o">=</span> <span class="n">im_stack</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
            <span class="n">cent</span><span class="p">,</span><span class="n">w</span> <span class="o">=</span> <span class="n">compute_centroid</span><span class="p">(</span><span class="n">im_mean</span><span class="p">,</span><span class="n">sigw</span><span class="o">=</span><span class="mi">100000000</span><span class="p">)</span>
            <span class="n">cent</span> <span class="o">=</span> <span class="n">squeeze</span><span class="p">(</span><span class="n">cent</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">pt_clouds</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
            <span class="n">pt_clouds</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">,:,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">setting_polar_2</span><span class="p">(</span><span class="n">pt_clouds</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">,:,</span><span class="n">i</span><span class="p">],</span><span class="n">gap</span><span class="p">,</span><span class="n">cent</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">pt_clouds</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">,:,:]</span><span class="o">*=</span><span class="n">gap</span>
    <span class="n">shap</span> <span class="o">=</span> <span class="n">im_stack</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">]</span>
    <span class="nb">print</span> <span class="s2">&quot;---------- Pairwise distances setting ---------&quot;</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_target</span><span class="p">):</span>
        <span class="nb">print</span> <span class="s2">&quot;Target &quot;</span><span class="p">,</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="s2">&quot;/&quot;</span><span class="p">,</span><span class="n">nb_target</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_neigh</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">nb_neigh</span><span class="p">):</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">dist_mat</span><span class="p">[</span><span class="n">neighborhood</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">k</span><span class="p">],</span><span class="n">neighborhood</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">l</span><span class="p">]]</span> <span class="o">==</span> <span class="n">max_val</span><span class="p">):</span>
                    <span class="n">proj</span><span class="p">,</span><span class="n">dist_mat</span><span class="p">[</span><span class="n">neighborhood</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">k</span><span class="p">],</span><span class="n">neighborhood</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">l</span><span class="p">]],</span><span class="n">assignment</span><span class="p">,</span><span class="n">f_disc</span> <span class="o">=</span> <span class="n">sliced_transport</span><span class="p">(</span><span class="n">pt_clouds</span><span class="p">[:,:,</span><span class="n">neighborhood</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">k</span><span class="p">]],</span><span class="n">pt_clouds</span><span class="p">[:,:,</span><span class="n">neighborhood</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">l</span><span class="p">]],</span><span class="n">nb_iter</span><span class="o">=</span><span class="n">nb_iter</span><span class="p">,</span><span class="n">tol</span><span class="o">=</span><span class="n">tol</span><span class="p">,</span><span class="n">nb_real</span><span class="o">=</span><span class="n">nb_real</span><span class="p">,</span><span class="n">rand</span><span class="o">=</span><span class="n">rand</span><span class="p">,</span><span class="n">smart_init_en</span> <span class="o">=</span> <span class="n">smart_init_en</span><span class="p">,</span><span class="n">rad</span><span class="o">=</span><span class="n">rad</span><span class="p">,</span><span class="n">gap</span><span class="o">=</span><span class="n">gap</span><span class="p">,</span><span class="n">shap</span><span class="o">=</span><span class="n">shap</span><span class="p">)</span>
                    <span class="n">dist_mat</span><span class="p">[</span><span class="n">neighborhood</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">k</span><span class="p">],</span><span class="n">neighborhood</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">l</span><span class="p">]]</span> <span class="o">=</span> <span class="n">dist_mat</span><span class="p">[</span><span class="n">neighborhood</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">l</span><span class="p">],</span><span class="n">neighborhood</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">k</span><span class="p">]]</span>

    <span class="k">return</span> <span class="n">dist_mat</span><span class="p">,</span><span class="n">neighborhood</span><span class="p">,</span><span class="n">gap</span>

<span class="k">def</span> <span class="nf">gap_select</span><span class="p">(</span><span class="n">im_stack</span><span class="p">,</span><span class="n">pos</span><span class="p">,</span><span class="n">gap_fact_arr</span><span class="p">,</span><span class="n">sub_samp</span><span class="p">,</span><span class="n">nb_comp</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span><span class="n">nb_real</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span><span class="n">tol</span><span class="o">=</span><span class="mf">1.e-20</span><span class="p">,</span><span class="n">nb_iter</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span><span class="n">smart_init_en</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span><span class="n">rad</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span><span class="n">rand</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">cent</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">theta_en</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="n">mean_pos</span> <span class="o">=</span> <span class="n">pos</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="kn">from</span> <span class="nn">numpy</span> <span class="k">import</span> <span class="n">arange</span><span class="p">,</span><span class="n">ones</span><span class="p">,</span><span class="n">size</span><span class="p">,</span><span class="n">zeros</span><span class="p">,</span><span class="n">squeeze</span>
    <span class="kn">from</span> <span class="nn">numpy.random</span> <span class="k">import</span> <span class="n">choice</span>
    <span class="kn">from</span> <span class="nn">numpy.linalg</span> <span class="k">import</span> <span class="n">norm</span>
    <span class="kn">from</span> <span class="nn">optim_utils</span> <span class="k">import</span> <span class="n">max_gap</span><span class="p">,</span><span class="n">sliced_transport_proj</span>
    <span class="kn">from</span> <span class="nn">utils</span> <span class="k">import</span> <span class="n">cube_svd</span><span class="p">,</span><span class="n">compute_centroid</span>


    <span class="n">shap</span> <span class="o">=</span> <span class="n">im_stack</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">nb_im</span> <span class="o">=</span> <span class="n">im_stack</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>

    <span class="n">ind</span> <span class="o">=</span> <span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_im</span><span class="p">)</span>
    <span class="n">samp</span> <span class="o">=</span> <span class="n">choice</span><span class="p">(</span><span class="n">ind</span><span class="p">,</span><span class="n">size</span><span class="o">=</span><span class="n">sub_samp</span><span class="p">,</span><span class="n">replace</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="n">ind</span><span class="p">[</span><span class="n">array</span><span class="p">(</span><span class="n">samp</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>

    <span class="n">ind_rmv</span> <span class="o">=</span> <span class="n">where</span><span class="p">(</span><span class="n">ind</span><span class="o">&gt;=</span><span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

    <span class="n">pos_mean</span> <span class="o">=</span> <span class="n">pos</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="n">dist</span> <span class="o">=</span> <span class="n">norm</span><span class="p">(</span><span class="n">pos</span><span class="p">[</span><span class="n">ind_rmv</span><span class="p">,:]</span><span class="o">-</span> <span class="n">ones</span><span class="p">((</span><span class="n">nb_im</span><span class="o">-</span><span class="n">sub_samp</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">pos_mean</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">))))</span>

    <span class="n">i</span> <span class="o">=</span> <span class="n">ind_rmv</span><span class="p">[</span><span class="n">where</span><span class="p">(</span><span class="n">dist</span><span class="o">==</span><span class="n">dist</span><span class="o">.</span><span class="n">min</span><span class="p">())[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]]</span>
    <span class="n">ind_in</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">sub_samp</span><span class="o">+</span><span class="mi">1</span><span class="p">,))</span>
    <span class="n">ind_in</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">samp</span>
    <span class="n">ind_in</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span>
    <span class="n">ind_in</span> <span class="o">=</span> <span class="n">ind_in</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

    <span class="n">gap_guess</span><span class="p">,</span><span class="n">inear</span><span class="p">,</span><span class="n">jnear</span><span class="p">,</span><span class="n">dist_mat_temp</span> <span class="o">=</span> <span class="n">max_gap</span><span class="p">(</span><span class="n">im_stack</span><span class="p">[:,:,</span><span class="n">ind_in</span><span class="p">],</span><span class="n">pos</span><span class="p">[</span><span class="n">ind_in</span><span class="p">,:],</span><span class="n">tol</span><span class="o">=</span><span class="mf">0.001</span><span class="p">,</span><span class="n">pol_en</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="n">nb_test</span> <span class="o">=</span> <span class="n">size</span><span class="p">(</span><span class="n">gap_fact_arr</span><span class="p">)</span>
    <span class="n">capture_measure</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">nb_test</span><span class="p">,))</span>

    <span class="k">if</span> <span class="n">cent</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">im_mean</span> <span class="o">=</span> <span class="n">im_stack</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">cent</span><span class="p">,</span><span class="n">w</span> <span class="o">=</span> <span class="n">compute_centroid</span><span class="p">(</span><span class="n">im_mean</span><span class="p">,</span><span class="n">sigw</span><span class="o">=</span><span class="mi">100000000</span><span class="p">)</span>
        <span class="n">cent</span> <span class="o">=</span> <span class="n">squeeze</span><span class="p">(</span><span class="n">cent</span><span class="p">)</span>
    <span class="n">pt_clouds</span> <span class="o">=</span> <span class="n">cube_to_point_cloud</span><span class="p">(</span><span class="n">im_stack</span><span class="p">[:,:,</span><span class="n">ind_in</span><span class="p">])</span>

    <span class="n">coeff</span><span class="p">,</span><span class="n">comp_cube</span><span class="p">,</span><span class="n">approx_cube</span><span class="p">,</span><span class="n">data_mean</span><span class="p">,</span><span class="n">centered_data</span> <span class="o">=</span> <span class="n">cube_svd</span><span class="p">(</span><span class="n">im_stack</span><span class="p">,</span><span class="n">nb_comp</span><span class="o">=</span><span class="n">nb_comp</span><span class="p">,</span><span class="n">mean_sub</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="nb">print</span> <span class="s2">&quot;Ref capture: &quot;</span><span class="p">,</span><span class="n">norm</span><span class="p">(</span><span class="n">approx_cube</span><span class="o">-</span><span class="n">centered_data</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="n">norm</span><span class="p">(</span><span class="n">centered_data</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span><span class="s2">&quot; nb comp: &quot;</span><span class="p">,</span><span class="n">nb_comp</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nb_test</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">theta_en</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">pt_clouds</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
                <span class="n">pt_clouds</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">,:,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">setting_polar_2</span><span class="p">(</span><span class="n">pt_clouds</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">,:,</span><span class="n">i</span><span class="p">],</span><span class="n">gap_guess</span><span class="o">*</span><span class="n">gap_fact_arr</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">cent</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">pt_clouds</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">,:,:]</span><span class="o">*=</span><span class="n">gap_guess</span><span class="o">*</span><span class="n">gap_fact_arr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

        <span class="n">proj_tg</span> <span class="o">=</span> <span class="n">sliced_transport_proj</span><span class="p">(</span><span class="n">pt_clouds</span><span class="p">[:,:,</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span><span class="n">pt_clouds</span><span class="p">[:,:,</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span><span class="n">gap_guess</span><span class="o">*</span><span class="n">gap_fact_arr</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">nb_iter</span><span class="o">=</span><span class="n">nb_iter</span><span class="p">,</span><span class="n">tol</span><span class="o">=</span><span class="n">tol</span><span class="p">,</span><span class="n">alph</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span><span class="n">basis</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">nb_real</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span><span class="n">rand</span><span class="o">=</span><span class="n">rand</span><span class="p">,</span><span class="n">disc_err</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span><span class="n">smart_init_en</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span><span class="n">output_control</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">shap</span><span class="o">=</span><span class="n">shap</span><span class="p">)</span>
        <span class="n">coeff</span><span class="p">,</span><span class="n">comp_cube</span><span class="p">,</span><span class="n">approx_cube</span><span class="p">,</span><span class="n">data_mean</span><span class="p">,</span><span class="n">centered_data</span> <span class="o">=</span> <span class="n">cube_svd</span><span class="p">(</span><span class="n">proj_tg</span><span class="p">,</span><span class="n">nb_comp</span><span class="o">=</span><span class="n">nb_comp</span><span class="p">,</span><span class="n">mean_sub</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">capture_measure</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">norm</span><span class="p">(</span><span class="n">approx_cube</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="n">norm</span><span class="p">(</span><span class="n">proj_tg</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span>

    <span class="k">return</span> <span class="n">capture_measure</span><span class="p">,</span><span class="n">gap_guess</span>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper"><div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../index.html">Documentation overview</a><ul>
  <li><a href="index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2018, Fred Ngolè, Morgan A Schmitz, Rebeca Araripe, Jean-Luc Starck.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 1.7.5</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.7</a>
      
    </div>

    

    
  </body>
</html>